import{r as g,c as Ny,R as Yn,_ as Gy,a as Ex,g as xx}from"./index-0b3ab4c1.js";import{H as le,A as He,I as xi,V as z,O as ui,P as jt,J as De,K as Cx,L as Jl,Q as nt,M as we,N as or,R as bn,S as Ye,U as Ci,W as wn,X as aa,p as xd,Y as et,Z as Ul,$ as Qe,a0 as _0,a1 as br,a2 as wi,a3 as ii,a4 as Pn,a5 as Xt,a6 as Nt,a7 as Ix,a8 as Cd,a9 as Qy,aa as ki,ab as Ji,ac as on,ad as gi,ae as la,af as ma,ag as pr,ah as _x,ai as zy,aj as Su,ak as Tu,al as S0,am as Sx,an as Wr,ao as mi,ap as Ku,aq as ds,ar as Zo,as as Gn,at as Vi,au as St,av as Lr,aw as nn,ax as Zl,ay as Hy,az as fs,aA as vr,aB as Aa,aC as tr,aD as Yt,aE as Th,aF as Tx,aG as Ti,aH as T0,aI as bx,aJ as Ht,aK as Dr,aL as ea,aM as vn,aN as Vy,aO as Id,aP as Ky,aQ as Zn,aR as wl,aS as nr,aT as wx,aU as Bx,aV as Nl,aW as $y,aX as cu,aY as $u,aZ as Bl,a_ as b0,a$ as Rx,b0 as Dx,b1 as Mx,b2 as Yy,b3 as _d,b4 as Wy,b5 as Lx,b6 as Px,b7 as Fx,b8 as Bn,b9 as kx,ba as Ox,bb as Rl,bc as jr,bd as qi,be as Sd,bf as Ux,bg as Nx,bh as jy,bi as Gx,bj as bh,bk as w0,bl as Xy,bm as Qx,bn as zx,bo as gr,bp as Yu,bq as qy,br as Hx,bs as Vx,bt as Kx,bu as $x,bv as Yx,bw as Wx,bx as jx,by as Xx,bz as qx,bA as Hi,bB as fi,bC as Wo,bD as Ds,bE as jm,bF as Jy,bG as jo,bH as Jx,bI as Zx,bJ as Zy,bK as wh,bL as B0,bM as Td,bN as eC,bO as bd,bP as Ls,bQ as tC,bR as iC,bS as e2,bT as nC,F as oi,bU as sC,bV as t2,bW as i2,bX as rC,bY as Xo,bZ as ar,b_ as oC,b$ as Wu,e as Ii,c0 as mn,c1 as aC,n as Wn,r as so,c2 as lC,c3 as n2,c4 as s2,c5 as bu,c6 as Jr,c7 as R0,c8 as ju,c9 as r2,ca as cC,D as uC,cb as Mr,cc as o2,cd as D0,ce as hC,cf as a2,j as l2,h as M0,cg as c2,ch as L0,ci as u2,cj as fC,ck as uu,cl as wd,cm as h2,cn as f2,co as dC,cp as mC,cq as wu,cr as AC,cs as Bd,ct as pC,cu as Xm,cv as gC,cw as yC,cx as vC,cy as EC,cz as xC,cA as Bh,cB as CC,cC as IC,cD as Rh,cE as _C,cF as SC}from"./events-e3cb66e2.esm-c4583822.js";function Ae(){return Ae=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},Ae.apply(null,arguments)}const Gl=new z,P0=new z,TC=new z,qm=new De;function bC(r,e,t){const i=Gl.setFromMatrixPosition(r.matrixWorld);i.project(e);const n=t.width/2,s=t.height/2;return[i.x*n+n,-(i.y*s)+s]}function wC(r,e){const t=Gl.setFromMatrixPosition(r.matrixWorld),i=P0.setFromMatrixPosition(e.matrixWorld),n=t.sub(i),s=e.getWorldDirection(TC);return n.angleTo(s)>Math.PI/2}function BC(r,e,t,i){const n=Gl.setFromMatrixPosition(r.matrixWorld),s=n.clone();s.project(e),qm.set(s.x,s.y),t.setFromCamera(qm,e);const o=t.intersectObjects(i,!0);if(o.length){const a=o[0].distance;return n.distanceTo(t.ray.origin)<a}return!0}function RC(r,e){if(e instanceof ui)return e.zoom;if(e instanceof jt){const t=Gl.setFromMatrixPosition(r.matrixWorld),i=P0.setFromMatrixPosition(e.matrixWorld),n=e.fov*Math.PI/180,s=t.distanceTo(i);return 1/(2*Math.tan(n/2)*s)}else return 1}function DC(r,e,t){if(e instanceof jt||e instanceof ui){const i=Gl.setFromMatrixPosition(r.matrixWorld),n=P0.setFromMatrixPosition(e.matrixWorld),s=i.distanceTo(n),o=(t[1]-t[0])/(e.far-e.near),a=t[1]-o*e.far;return Math.round(o*s+a)}}const Rd=r=>Math.abs(r)<1e-10?0:r;function d2(r,e,t=""){let i="matrix3d(";for(let n=0;n!==16;n++)i+=Rd(e[n]*r.elements[n])+(n!==15?",":")");return t+i}const MC=(r=>e=>d2(e,r))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),LC=(r=>(e,t)=>d2(e,r(t),"translate(-50%,-50%)"))(r=>[1/r,1/r,1/r,1,-1/r,-1/r,-1/r,-1,1/r,1/r,1/r,1,1,1,1,1]);function PC(r){return r&&typeof r=="object"&&"current"in r}const Xu=g.forwardRef(({children:r,eps:e=.001,style:t,className:i,prepend:n,center:s,fullscreen:o,portal:a,distanceFactor:l,sprite:c=!1,transform:u=!1,occlude:h,onOcclude:f,castShadow:d,receiveShadow:m,material:A,geometry:p,zIndexRange:y=[16777271,0],calculatePosition:E=bC,as:v="div",wrapperClass:x,pointerEvents:C="auto",...I},_)=>{const{gl:S,camera:b,scene:T,size:R,raycaster:w,events:B,viewport:D}=le(),[k]=g.useState(()=>document.createElement(v)),Q=g.useRef(null),Y=g.useRef(null),W=g.useRef(0),P=g.useRef([0,0]),K=g.useRef(null),M=g.useRef(null),V=(a==null?void 0:a.current)||B.connected||S.domElement.parentNode,$=g.useRef(null),G=g.useRef(!1),O=g.useMemo(()=>h&&h!=="blending"||Array.isArray(h)&&h.length&&PC(h[0]),[h]);g.useLayoutEffect(()=>{const ie=S.domElement;h&&h==="blending"?(ie.style.zIndex=`${Math.floor(y[0]/2)}`,ie.style.position="absolute",ie.style.pointerEvents="none"):(ie.style.zIndex=null,ie.style.position=null,ie.style.pointerEvents=null)},[h]),g.useLayoutEffect(()=>{if(Y.current){const ie=Q.current=Ny.createRoot(k);if(T.updateMatrixWorld(),u)k.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const q=E(Y.current,b,R);k.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${q[0]}px,${q[1]}px,0);transform-origin:0 0;`}return V&&(n?V.prepend(k):V.appendChild(k)),()=>{V&&V.removeChild(k),ie.unmount()}}},[V,u]),g.useLayoutEffect(()=>{x&&(k.className=x)},[x]);const F=g.useMemo(()=>u?{position:"absolute",top:0,left:0,width:R.width,height:R.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:s?"translate3d(-50%,-50%,0)":"none",...o&&{top:-R.height/2,left:-R.width/2,width:R.width,height:R.height},...t},[t,s,o,R,u]),U=g.useMemo(()=>({position:"absolute",pointerEvents:C}),[C]);g.useLayoutEffect(()=>{if(G.current=!1,u){var ie;(ie=Q.current)==null||ie.render(g.createElement("div",{ref:K,style:F},g.createElement("div",{ref:M,style:U},g.createElement("div",{ref:_,className:i,style:t,children:r}))))}else{var q;(q=Q.current)==null||q.render(g.createElement("div",{ref:_,style:F,className:i,children:r}))}});const N=g.useRef(!0);He(ie=>{if(Y.current){b.updateMatrixWorld(),Y.current.updateWorldMatrix(!0,!1);const q=u?P.current:E(Y.current,b,R);if(u||Math.abs(W.current-b.zoom)>e||Math.abs(P.current[0]-q[0])>e||Math.abs(P.current[1]-q[1])>e){const ne=wC(Y.current,b);let ye=!1;O&&(Array.isArray(h)?ye=h.map(he=>he.current):h!=="blending"&&(ye=[T]));const ve=N.current;if(ye){const he=BC(Y.current,b,w,ye);N.current=he&&!ne}else N.current=!ne;ve!==N.current&&(f?f(!N.current):k.style.display=N.current?"block":"none");const re=Math.floor(y[0]/2),se=h?O?[y[0],re]:[re-1,0]:y;if(k.style.zIndex=`${DC(Y.current,b,se)}`,u){const[he,ae]=[R.width/2,R.height/2],J=b.projectionMatrix.elements[5]*ae,{isOrthographicCamera:X,top:oe,left:Ce,bottom:_e,right:Be}=b,Se=MC(b.matrixWorldInverse),Ve=X?`scale(${J})translate(${Rd(-(Be+Ce)/2)}px,${Rd((oe+_e)/2)}px)`:`translateZ(${J}px)`;let Me=Y.current.matrixWorld;c&&(Me=b.matrixWorldInverse.clone().transpose().copyPosition(Me).scale(Y.current.scale),Me.elements[3]=Me.elements[7]=Me.elements[11]=0,Me.elements[15]=1),k.style.width=R.width+"px",k.style.height=R.height+"px",k.style.perspective=X?"":`${J}px`,K.current&&M.current&&(K.current.style.transform=`${Ve}${Se}translate(${he}px,${ae}px)`,M.current.style.transform=LC(Me,1/((l||10)/400)))}else{const he=l===void 0?1:RC(Y.current,b)*l;k.style.transform=`translate3d(${q[0]}px,${q[1]}px,0) scale(${he})`}P.current=q,W.current=b.zoom}}if(!O&&$.current&&!G.current)if(u){if(K.current){const q=K.current.children[0];if(q!=null&&q.clientWidth&&q!=null&&q.clientHeight){const{isOrthographicCamera:ne}=b;if(ne||p)I.scale&&(Array.isArray(I.scale)?I.scale instanceof z?$.current.scale.copy(I.scale.clone().divideScalar(1)):$.current.scale.set(1/I.scale[0],1/I.scale[1],1/I.scale[2]):$.current.scale.setScalar(1/I.scale));else{const ye=(l||10)/400,ve=q.clientWidth*ye,re=q.clientHeight*ye;$.current.scale.set(ve,re,1)}G.current=!0}}}else{const q=k.children[0];if(q!=null&&q.clientWidth&&q!=null&&q.clientHeight){const ne=1/D.factor,ye=q.clientWidth*ne,ve=q.clientHeight*ne;$.current.scale.set(ye,ve,1),G.current=!0}$.current.lookAt(ie.camera.position)}});const Z=g.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return g.createElement("group",Ae({},I,{ref:Y}),h&&!O&&g.createElement("mesh",{castShadow:d,receiveShadow:m,ref:$},p||g.createElement("planeGeometry",null),A||g.createElement("shaderMaterial",{side:xi,vertexShader:Z.vertexShader,fragmentShader:Z.fragmentShader})))});function XM({onChanged:r,portal:e,preventDefault:t=!0,scroll:i=!0,keyCode:n=9}){const s=g.useRef(0),o=le(c=>c.setEvents),a=le(c=>c.get),l=le(c=>c.gl);return g.useEffect(()=>{var c;let u=[],h;const f=a().events.filter,d=(c=e==null?void 0:e.current)!==null&&c!==void 0?c:l.domElement.parentNode,m=()=>d&&r&&r(u,Math.round(s.current)%u.length);o({filter:(v,x)=>{let C=[...v];(C.length!==u.length||!u.every(I=>C.map(_=>_.object.uuid).includes(I.object.uuid)))&&(s.current=0,u=C,m()),f&&(C=f(C,x));for(let I=0;I<Math.round(s.current)%C.length;I++){const _=C.shift();C=[...C,_]}return C}});const A=v=>{var x,C;s.current=v(s.current),(x=a().events.handlers)==null||x.onPointerCancel(void 0),(C=a().events.handlers)==null||C.onPointerMove(h),m()},p=v=>{(v.keyCode||v.which)===n&&(t&&v.preventDefault(),u.length>1&&A(x=>x+1))},y=v=>{t&&v.preventDefault();let x=0;v||(v=window.event),v.wheelDelta?x=v.wheelDelta/120:v.detail&&(x=-v.detail/3),u.length>1&&A(C=>Math.abs(C-x))},E=v=>h=v;return document.addEventListener("pointermove",E,{passive:!0}),i&&document.addEventListener("wheel",y),n!==void 0&&document.addEventListener("keydown",p),()=>{o({filter:f}),n!==void 0&&document.removeEventListener("keydown",p),i&&document.removeEventListener("wheel",y),document.removeEventListener("pointermove",E)}},[l,a,o,t,i,n]),null}function qM(r,e="pointer",t="auto",i=document.body){g.useEffect(()=>{if(r)return i.style.cursor=e,()=>void(i.style.cursor=t)},[r])}const FC=r=>r;function kC(r,e=FC){const t=Yn.useSyncExternalStore(r.subscribe,Yn.useCallback(()=>e(r.getState()),[r,e]),Yn.useCallback(()=>e(r.getInitialState()),[r,e]));return Yn.useDebugValue(t),t}const Jm=r=>{const e=Cx(r),t=i=>kC(e,i);return Object.assign(t,e),t},m2=r=>r?Jm(r):Jm;let Ta=0;const A2=m2(r=>(Jl.onStart=(e,t,i)=>{r({active:!0,item:e,loaded:t,total:i,progress:(t-Ta)/(i-Ta)*100})},Jl.onLoad=()=>{r({active:!1})},Jl.onError=e=>r(t=>({errors:[...t.errors,e]})),Jl.onProgress=(e,t,i)=>{t===i&&(Ta=i),r({active:!0,item:e,loaded:t,total:i,progress:(t-Ta)/(i-Ta)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}));function JM({children:r}){const e=A2();return g.createElement(g.Fragment,null,r==null?void 0:r(e))}const OC=r=>`Loading ${r.toFixed(2)}%`;function ZM({containerStyles:r,innerStyles:e,barStyles:t,dataStyles:i,dataInterpolation:n=OC,initialState:s=o=>o}){const{active:o,progress:a}=A2(),l=g.useRef(0),c=g.useRef(0),u=g.useRef(null),[h,f]=g.useState(s(o));g.useEffect(()=>{let m;return o!==h&&(m=setTimeout(()=>f(o),300)),()=>clearTimeout(m)},[h,o]);const d=g.useCallback(()=>{u.current&&(l.current+=(a-l.current)/2,(l.current>.95*a||a===100)&&(l.current=a),u.current.innerText=n(l.current),l.current<a&&(c.current=requestAnimationFrame(d)))},[n,a]);return g.useEffect(()=>(d(),()=>cancelAnimationFrame(c.current)),[d]),h?g.createElement("div",{style:{...ec.container,opacity:o?1:0,...r}},g.createElement("div",null,g.createElement("div",{style:{...ec.inner,...e}},g.createElement("div",{style:{...ec.bar,transform:`scaleX(${a/100})`,...t}}),g.createElement("span",{ref:u,style:{...ec.data,...i}})))):null}const ec={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};function UC(r,e,t){return Math.max(e,Math.min(r,t))}const ei={toVector(r,e){return r===void 0&&(r=e),Array.isArray(r)?r:[r,r]},add(r,e){return[r[0]+e[0],r[1]+e[1]]},sub(r,e){return[r[0]-e[0],r[1]-e[1]]},addTo(r,e){r[0]+=e[0],r[1]+=e[1]},subTo(r,e){r[0]-=e[0],r[1]-=e[1]}};function Zm(r,e,t){return e===0||Math.abs(e)===1/0?Math.pow(r,t*5):r*e*t/(e+t*r)}function eA(r,e,t,i=.15){return i===0?UC(r,e,t):r<e?-Zm(e-r,t-e,i)+e:r>t?+Zm(r-t,t-e,i)+t:r}function NC(r,[e,t],[i,n]){const[[s,o],[a,l]]=r;return[eA(e,s,o,i),eA(t,a,l,n)]}function GC(r,e){if(typeof r!="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function QC(r){var e=GC(r,"string");return typeof e=="symbol"?e:String(e)}function Si(r,e,t){return e=QC(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function tA(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function di(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?tA(Object(t),!0).forEach(function(i){Si(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):tA(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}const p2={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function iA(r){return r?r[0].toUpperCase()+r.slice(1):""}const zC=["enter","leave"];function HC(r=!1,e){return r&&!zC.includes(e)}function VC(r,e="",t=!1){const i=p2[r],n=i&&i[e]||e;return"on"+iA(r)+iA(n)+(HC(t,n)?"Capture":"")}const KC=["gotpointercapture","lostpointercapture"];function $C(r){let e=r.substring(2).toLowerCase();const t=!!~e.indexOf("passive");t&&(e=e.replace("passive",""));const i=KC.includes(e)?"capturecapture":"capture",n=!!~e.indexOf(i);return n&&(e=e.replace("capture","")),{device:e,capture:n,passive:t}}function YC(r,e=""){const t=p2[r],i=t&&t[e]||e;return r+i}function qu(r){return"touches"in r}function g2(r){return qu(r)?"touch":"pointerType"in r?r.pointerType:"mouse"}function WC(r){return Array.from(r.touches).filter(e=>{var t,i;return e.target===r.currentTarget||((t=r.currentTarget)===null||t===void 0||(i=t.contains)===null||i===void 0?void 0:i.call(t,e.target))})}function jC(r){return r.type==="touchend"||r.type==="touchcancel"?r.changedTouches:r.targetTouches}function y2(r){return qu(r)?jC(r)[0]:r}function Dd(r,e){try{const t=e.clientX-r.clientX,i=e.clientY-r.clientY,n=(e.clientX+r.clientX)/2,s=(e.clientY+r.clientY)/2,o=Math.hypot(t,i);return{angle:-(Math.atan2(t,i)*180)/Math.PI,distance:o,origin:[n,s]}}catch{}return null}function XC(r){return WC(r).map(e=>e.identifier)}function nA(r,e){const[t,i]=Array.from(r.touches).filter(n=>e.includes(n.identifier));return Dd(t,i)}function Dh(r){const e=y2(r);return qu(r)?e.identifier:e.pointerId}function ca(r){const e=y2(r);return[e.clientX,e.clientY]}const sA=40,rA=800;function v2(r){let{deltaX:e,deltaY:t,deltaMode:i}=r;return i===1?(e*=sA,t*=sA):i===2&&(e*=rA,t*=rA),[e,t]}function qC(r){var e,t;const{scrollX:i,scrollY:n,scrollLeft:s,scrollTop:o}=r.currentTarget;return[(e=i??s)!==null&&e!==void 0?e:0,(t=n??o)!==null&&t!==void 0?t:0]}function JC(r){const e={};if("buttons"in r&&(e.buttons=r.buttons),"shiftKey"in r){const{shiftKey:t,altKey:i,metaKey:n,ctrlKey:s}=r;Object.assign(e,{shiftKey:t,altKey:i,metaKey:n,ctrlKey:s})}return e}function Bu(r,...e){return typeof r=="function"?r(...e):r}function ZC(){}function eI(...r){return r.length===0?ZC:r.length===1?r[0]:function(){let e;for(const t of r)e=t.apply(this,arguments)||e;return e}}function oA(r,e){return Object.assign({},e,r||{})}const tI=32;class E2{constructor(e,t,i){this.ctrl=e,this.args=t,this.key=i,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(e){this.ctrl.state[this.key]=e}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:e,shared:t,ingKey:i,args:n}=this;t[i]=e._active=e.active=e._blocked=e._force=!1,e._step=[!1,!1],e.intentional=!1,e._movement=[0,0],e._distance=[0,0],e._direction=[0,0],e._delta=[0,0],e._bounds=[[-1/0,1/0],[-1/0,1/0]],e.args=n,e.axis=void 0,e.memo=void 0,e.elapsedTime=e.timeDelta=0,e.direction=[0,0],e.distance=[0,0],e.overflow=[0,0],e._movementBound=[!1,!1],e.velocity=[0,0],e.movement=[0,0],e.delta=[0,0],e.timeStamp=0}start(e){const t=this.state,i=this.config;t._active||(this.reset(),this.computeInitial(),t._active=!0,t.target=e.target,t.currentTarget=e.currentTarget,t.lastOffset=i.from?Bu(i.from,t):t.offset,t.offset=t.lastOffset,t.startTime=t.timeStamp=e.timeStamp)}computeValues(e){const t=this.state;t._values=e,t.values=this.config.transform(e)}computeInitial(){const e=this.state;e._initial=e._values,e.initial=e.values}compute(e){const{state:t,config:i,shared:n}=this;t.args=this.args;let s=0;if(e&&(t.event=e,i.preventDefault&&e.cancelable&&t.event.preventDefault(),t.type=e.type,n.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,n.locked=!!document.pointerLockElement,Object.assign(n,JC(e)),n.down=n.pressed=n.buttons%2===1||n.touches>0,s=e.timeStamp-t.timeStamp,t.timeStamp=e.timeStamp,t.elapsedTime=t.timeStamp-t.startTime),t._active){const I=t._delta.map(Math.abs);ei.addTo(t._distance,I)}this.axisIntent&&this.axisIntent(e);const[o,a]=t._movement,[l,c]=i.threshold,{_step:u,values:h}=t;if(i.hasCustomTransform?(u[0]===!1&&(u[0]=Math.abs(o)>=l&&h[0]),u[1]===!1&&(u[1]=Math.abs(a)>=c&&h[1])):(u[0]===!1&&(u[0]=Math.abs(o)>=l&&Math.sign(o)*l),u[1]===!1&&(u[1]=Math.abs(a)>=c&&Math.sign(a)*c)),t.intentional=u[0]!==!1||u[1]!==!1,!t.intentional)return;const f=[0,0];if(i.hasCustomTransform){const[I,_]=h;f[0]=u[0]!==!1?I-u[0]:0,f[1]=u[1]!==!1?_-u[1]:0}else f[0]=u[0]!==!1?o-u[0]:0,f[1]=u[1]!==!1?a-u[1]:0;this.restrictToAxis&&!t._blocked&&this.restrictToAxis(f);const d=t.offset,m=t._active&&!t._blocked||t.active;m&&(t.first=t._active&&!t.active,t.last=!t._active&&t.active,t.active=n[this.ingKey]=t._active,e&&(t.first&&("bounds"in i&&(t._bounds=Bu(i.bounds,t)),this.setup&&this.setup()),t.movement=f,this.computeOffset()));const[A,p]=t.offset,[[y,E],[v,x]]=t._bounds;t.overflow=[A<y?-1:A>E?1:0,p<v?-1:p>x?1:0],t._movementBound[0]=t.overflow[0]?t._movementBound[0]===!1?t._movement[0]:t._movementBound[0]:!1,t._movementBound[1]=t.overflow[1]?t._movementBound[1]===!1?t._movement[1]:t._movementBound[1]:!1;const C=t._active?i.rubberband||[0,0]:[0,0];if(t.offset=NC(t._bounds,t.offset,C),t.delta=ei.sub(t.offset,d),this.computeMovement(),m&&(!t.last||s>tI)){t.delta=ei.sub(t.offset,d);const I=t.delta.map(Math.abs);ei.addTo(t.distance,I),t.direction=t.delta.map(Math.sign),t._direction=t._delta.map(Math.sign),!t.first&&s>0&&(t.velocity=[I[0]/s,I[1]/s],t.timeDelta=s)}}emit(){const e=this.state,t=this.shared,i=this.config;if(e._active||this.clean(),(e._blocked||!e.intentional)&&!e._force&&!i.triggerAllEvents)return;const n=this.handler(di(di(di({},t),e),{},{[this.aliasKey]:e.values}));n!==void 0&&(e.memo=n)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}function iI([r,e],t){const i=Math.abs(r),n=Math.abs(e);if(i>n&&i>t)return"x";if(n>i&&n>t)return"y"}class Ql extends E2{constructor(...e){super(...e),Si(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=ei.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=ei.sub(this.state.offset,this.state.lastOffset)}axisIntent(e){const t=this.state,i=this.config;if(!t.axis&&e){const n=typeof i.axisThreshold=="object"?i.axisThreshold[g2(e)]:i.axisThreshold;t.axis=iI(t._movement,n)}t._blocked=(i.lockDirection||!!i.axis)&&!t.axis||!!i.axis&&i.axis!==t.axis}restrictToAxis(e){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":e[1]=0;break;case"y":e[0]=0;break}}}const nI=r=>r,aA=.15,x2={enabled(r=!0){return r},eventOptions(r,e,t){return di(di({},t.shared.eventOptions),r)},preventDefault(r=!1){return r},triggerAllEvents(r=!1){return r},rubberband(r=0){switch(r){case!0:return[aA,aA];case!1:return[0,0];default:return ei.toVector(r)}},from(r){if(typeof r=="function")return r;if(r!=null)return ei.toVector(r)},transform(r,e,t){const i=r||t.shared.transform;return this.hasCustomTransform=!!i,i||nI},threshold(r){return ei.toVector(r,0)}},sI=0,ro=di(di({},x2),{},{axis(r,e,{axis:t}){if(this.lockDirection=t==="lock",!this.lockDirection)return t},axisThreshold(r=sI){return r},bounds(r={}){if(typeof r=="function")return s=>ro.bounds(r(s));if("current"in r)return()=>r.current;if(typeof HTMLElement=="function"&&r instanceof HTMLElement)return r;const{left:e=-1/0,right:t=1/0,top:i=-1/0,bottom:n=1/0}=r;return[[e,t],[i,n]]}}),lA={ArrowRight:(r,e=1)=>[r*e,0],ArrowLeft:(r,e=1)=>[-1*r*e,0],ArrowUp:(r,e=1)=>[0,-1*r*e],ArrowDown:(r,e=1)=>[0,r*e]};class rI extends Ql{constructor(...e){super(...e),Si(this,"ingKey","dragging")}reset(){super.reset();const e=this.state;e._pointerId=void 0,e._pointerActive=!1,e._keyboardActive=!1,e._preventScroll=!1,e._delayed=!1,e.swipe=[0,0],e.tap=!1,e.canceled=!1,e.cancel=this.cancel.bind(this)}setup(){const e=this.state;if(e._bounds instanceof HTMLElement){const t=e._bounds.getBoundingClientRect(),i=e.currentTarget.getBoundingClientRect(),n={left:t.left-i.left+e.offset[0],right:t.right-i.right+e.offset[0],top:t.top-i.top+e.offset[1],bottom:t.bottom-i.bottom+e.offset[1]};e._bounds=ro.bounds(n)}}cancel(){const e=this.state;e.canceled||(e.canceled=!0,e._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(e){const t=this.config,i=this.state;if(e.buttons!=null&&(Array.isArray(t.pointerButtons)?!t.pointerButtons.includes(e.buttons):t.pointerButtons!==-1&&t.pointerButtons!==e.buttons))return;const n=this.ctrl.setEventIds(e);t.pointerCapture&&e.target.setPointerCapture(e.pointerId),!(n&&n.size>1&&i._pointerActive)&&(this.start(e),this.setupPointer(e),i._pointerId=Dh(e),i._pointerActive=!0,this.computeValues(ca(e)),this.computeInitial(),t.preventScrollAxis&&g2(e)!=="mouse"?(i._active=!1,this.setupScrollPrevention(e)):t.delay>0?(this.setupDelayTrigger(e),t.triggerAllEvents&&(this.compute(e),this.emit())):this.startPointerDrag(e))}startPointerDrag(e){const t=this.state;t._active=!0,t._preventScroll=!0,t._delayed=!1,this.compute(e),this.emit()}pointerMove(e){const t=this.state,i=this.config;if(!t._pointerActive)return;const n=Dh(e);if(t._pointerId!==void 0&&n!==t._pointerId)return;const s=ca(e);if(document.pointerLockElement===e.target?t._delta=[e.movementX,e.movementY]:(t._delta=ei.sub(s,t._values),this.computeValues(s)),ei.addTo(t._movement,t._delta),this.compute(e),t._delayed&&t.intentional){this.timeoutStore.remove("dragDelay"),t.active=!1,this.startPointerDrag(e);return}if(i.preventScrollAxis&&!t._preventScroll)if(t.axis)if(t.axis===i.preventScrollAxis||i.preventScrollAxis==="xy"){t._active=!1,this.clean();return}else{this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(e);return}else return;this.emit()}pointerUp(e){this.ctrl.setEventIds(e);try{this.config.pointerCapture&&e.target.hasPointerCapture(e.pointerId)&&e.target.releasePointerCapture(e.pointerId)}catch{}const t=this.state,i=this.config;if(!t._active||!t._pointerActive)return;const n=Dh(e);if(t._pointerId!==void 0&&n!==t._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(e);const[s,o]=t._distance;if(t.tap=s<=i.tapsThreshold&&o<=i.tapsThreshold,t.tap&&i.filterTaps)t._force=!0;else{const[a,l]=t._delta,[c,u]=t._movement,[h,f]=i.swipe.velocity,[d,m]=i.swipe.distance,A=i.swipe.duration;if(t.elapsedTime<A){const p=Math.abs(a/t.timeDelta),y=Math.abs(l/t.timeDelta);p>h&&Math.abs(c)>d&&(t.swipe[0]=Math.sign(a)),y>f&&Math.abs(u)>m&&(t.swipe[1]=Math.sign(l))}}this.emit()}pointerClick(e){!this.state.tap&&e.detail>0&&(e.preventDefault(),e.stopPropagation())}setupPointer(e){const t=this.config,i=t.device;t.pointerLock&&e.currentTarget.requestPointerLock(),t.pointerCapture||(this.eventStore.add(this.sharedConfig.window,i,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(e){this.state._preventScroll&&e.cancelable&&e.preventDefault()}setupScrollPrevention(e){this.state._preventScroll=!1,oI(e);const t=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",t),this.eventStore.add(this.sharedConfig.window,"touch","cancel",t),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,e)}setupDelayTrigger(e){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(e)},this.config.delay)}keyDown(e){const t=lA[e.key];if(t){const i=this.state,n=e.shiftKey?10:e.altKey?.1:1;this.start(e),i._delta=t(this.config.keyboardDisplacement,n),i._keyboardActive=!0,ei.addTo(i._movement,i._delta),this.compute(e),this.emit()}}keyUp(e){e.key in lA&&(this.state._keyboardActive=!1,this.setActive(),this.compute(e),this.emit())}bind(e){const t=this.config.device;e(t,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(e(t,"change",this.pointerMove.bind(this)),e(t,"end",this.pointerUp.bind(this)),e(t,"cancel",this.pointerUp.bind(this)),e("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(e("key","down",this.keyDown.bind(this)),e("key","up",this.keyUp.bind(this))),this.config.filterTaps&&e("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}}function oI(r){"persist"in r&&typeof r.persist=="function"&&r.persist()}const zl=typeof window<"u"&&window.document&&window.document.createElement;function C2(){return zl&&"ontouchstart"in window}function aI(){return C2()||zl&&window.navigator.maxTouchPoints>1}function lI(){return zl&&"onpointerdown"in window}function cI(){return zl&&"exitPointerLock"in window.document}function uI(){try{return"constructor"in GestureEvent}catch{return!1}}const Kn={isBrowser:zl,gesture:uI(),touch:C2(),touchscreen:aI(),pointer:lI(),pointerLock:cI()},hI=250,fI=180,dI=.5,mI=50,AI=250,pI=10,cA={mouse:0,touch:0,pen:8},gI=di(di({},ro),{},{device(r,e,{pointer:{touch:t=!1,lock:i=!1,mouse:n=!1}={}}){return this.pointerLock=i&&Kn.pointerLock,Kn.touch&&t?"touch":this.pointerLock?"mouse":Kn.pointer&&!n?"pointer":Kn.touch?"touch":"mouse"},preventScrollAxis(r,e,{preventScroll:t}){if(this.preventScrollDelay=typeof t=="number"?t:t||t===void 0&&r?hI:void 0,!(!Kn.touchscreen||t===!1))return r||(t!==void 0?"y":void 0)},pointerCapture(r,e,{pointer:{capture:t=!0,buttons:i=1,keys:n=!0}={}}){return this.pointerButtons=i,this.keys=n,!this.pointerLock&&this.device==="pointer"&&t},threshold(r,e,{filterTaps:t=!1,tapsThreshold:i=3,axis:n=void 0}){const s=ei.toVector(r,t?i:n?1:0);return this.filterTaps=t,this.tapsThreshold=i,s},swipe({velocity:r=dI,distance:e=mI,duration:t=AI}={}){return{velocity:this.transform(ei.toVector(r)),distance:this.transform(ei.toVector(e)),duration:t}},delay(r=0){switch(r){case!0:return fI;case!1:return 0;default:return r}},axisThreshold(r){return r?di(di({},cA),r):cA},keyboardDisplacement(r=pI){return r}});function I2(r){const[e,t]=r.overflow,[i,n]=r._delta,[s,o]=r._direction;(e<0&&i>0&&s<0||e>0&&i<0&&s>0)&&(r._movement[0]=r._movementBound[0]),(t<0&&n>0&&o<0||t>0&&n<0&&o>0)&&(r._movement[1]=r._movementBound[1])}const yI=30,vI=100;class EI extends E2{constructor(...e){super(...e),Si(this,"ingKey","pinching"),Si(this,"aliasKey","da")}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();const e=this.state;e._touchIds=[],e.canceled=!1,e.cancel=this.cancel.bind(this),e.turns=0}computeOffset(){const{type:e,movement:t,lastOffset:i}=this.state;e==="wheel"?this.state.offset=ei.add(t,i):this.state.offset=[(1+t[0])*i[0],t[1]+i[1]]}computeMovement(){const{offset:e,lastOffset:t}=this.state;this.state.movement=[e[0]/t[0],e[1]-t[1]]}axisIntent(){const e=this.state,[t,i]=e._movement;if(!e.axis){const n=Math.abs(t)*yI-Math.abs(i);n<0?e.axis="angle":n>0&&(e.axis="scale")}}restrictToAxis(e){this.config.lockDirection&&(this.state.axis==="scale"?e[1]=0:this.state.axis==="angle"&&(e[0]=0))}cancel(){const e=this.state;e.canceled||setTimeout(()=>{e.canceled=!0,e._active=!1,this.compute(),this.emit()},0)}touchStart(e){this.ctrl.setEventIds(e);const t=this.state,i=this.ctrl.touchIds;if(t._active&&t._touchIds.every(s=>i.has(s))||i.size<2)return;this.start(e),t._touchIds=Array.from(i).slice(0,2);const n=nA(e,t._touchIds);n&&this.pinchStart(e,n)}pointerStart(e){if(e.buttons!=null&&e.buttons%2!==1)return;this.ctrl.setEventIds(e),e.target.setPointerCapture(e.pointerId);const t=this.state,i=t._pointerEvents,n=this.ctrl.pointerIds;if(t._active&&Array.from(i.keys()).every(o=>n.has(o))||(i.size<2&&i.set(e.pointerId,e),t._pointerEvents.size<2))return;this.start(e);const s=Dd(...Array.from(i.values()));s&&this.pinchStart(e,s)}pinchStart(e,t){const i=this.state;i.origin=t.origin,this.computeValues([t.distance,t.angle]),this.computeInitial(),this.compute(e),this.emit()}touchMove(e){if(!this.state._active)return;const t=nA(e,this.state._touchIds);t&&this.pinchMove(e,t)}pointerMove(e){const t=this.state._pointerEvents;if(t.has(e.pointerId)&&t.set(e.pointerId,e),!this.state._active)return;const i=Dd(...Array.from(t.values()));i&&this.pinchMove(e,i)}pinchMove(e,t){const i=this.state,n=i._values[1],s=t.angle-n;let o=0;Math.abs(s)>270&&(o+=Math.sign(s)),this.computeValues([t.distance,t.angle-360*o]),i.origin=t.origin,i.turns=o,i._movement=[i._values[0]/i._initial[0]-1,i._values[1]-i._initial[1]],this.compute(e),this.emit()}touchEnd(e){this.ctrl.setEventIds(e),this.state._active&&this.state._touchIds.some(t=>!this.ctrl.touchIds.has(t))&&(this.state._active=!1,this.compute(e),this.emit())}pointerEnd(e){const t=this.state;this.ctrl.setEventIds(e);try{e.target.releasePointerCapture(e.pointerId)}catch{}t._pointerEvents.has(e.pointerId)&&t._pointerEvents.delete(e.pointerId),t._active&&t._pointerEvents.size<2&&(t._active=!1,this.compute(e),this.emit())}gestureStart(e){e.cancelable&&e.preventDefault();const t=this.state;t._active||(this.start(e),this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY],this.compute(e),this.emit())}gestureMove(e){if(e.cancelable&&e.preventDefault(),!this.state._active)return;const t=this.state;this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY];const i=t._movement;t._movement=[e.scale-1,e.rotation],t._delta=ei.sub(t._movement,i),this.compute(e),this.emit()}gestureEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}wheel(e){const t=this.config.modifierKey;t&&(Array.isArray(t)?!t.find(i=>e[i]):!e[t])||(this.state._active?this.wheelChange(e):this.wheelStart(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(e){this.start(e),this.wheelChange(e)}wheelChange(e){"uv"in e||e.cancelable&&e.preventDefault();const i=this.state;i._delta=[-v2(e)[1]/vI*i.offset[0],0],ei.addTo(i._movement,i._delta),I2(i),this.state.origin=[e.clientX,e.clientY],this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){const t=this.config.device;t&&(e(t,"start",this[t+"Start"].bind(this)),e(t,"change",this[t+"Move"].bind(this)),e(t,"end",this[t+"End"].bind(this)),e(t,"cancel",this[t+"End"].bind(this)),e("lostPointerCapture","",this[t+"End"].bind(this))),this.config.pinchOnWheel&&e("wheel","",this.wheel.bind(this),{passive:!1})}}const xI=di(di({},x2),{},{device(r,e,{shared:t,pointer:{touch:i=!1}={}}){if(t.target&&!Kn.touch&&Kn.gesture)return"gesture";if(Kn.touch&&i)return"touch";if(Kn.touchscreen){if(Kn.pointer)return"pointer";if(Kn.touch)return"touch"}},bounds(r,e,{scaleBounds:t={},angleBounds:i={}}){const n=o=>{const a=oA(Bu(t,o),{min:-1/0,max:1/0});return[a.min,a.max]},s=o=>{const a=oA(Bu(i,o),{min:-1/0,max:1/0});return[a.min,a.max]};return typeof t!="function"&&typeof i!="function"?[n(),s()]:o=>[n(o),s(o)]},threshold(r,e,t){return this.lockDirection=t.axis==="lock",ei.toVector(r,this.lockDirection?[.1,3]:0)},modifierKey(r){return r===void 0?"ctrlKey":r},pinchOnWheel(r=!0){return r}});class CI extends Ql{constructor(...e){super(...e),Si(this,"ingKey","moving")}move(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.state._active?this.moveChange(e):this.moveStart(e),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(e){this.start(e),this.computeValues(ca(e)),this.compute(e),this.computeInitial(),this.emit()}moveChange(e){if(!this.state._active)return;const t=ca(e),i=this.state;i._delta=ei.sub(t,i._values),ei.addTo(i._movement,i._delta),this.computeValues(t),this.compute(e),this.emit()}moveEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}bind(e){e("pointer","change",this.move.bind(this)),e("pointer","leave",this.moveEnd.bind(this))}}const II=di(di({},ro),{},{mouseOnly:(r=!0)=>r});class _I extends Ql{constructor(...e){super(...e),Si(this,"ingKey","scrolling")}scroll(e){this.state._active||this.start(e),this.scrollChange(e),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(e){e.cancelable&&e.preventDefault();const t=this.state,i=qC(e);t._delta=ei.sub(i,t._values),ei.addTo(t._movement,t._delta),this.computeValues(i),this.compute(e),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("scroll","",this.scroll.bind(this))}}const SI=ro;class TI extends Ql{constructor(...e){super(...e),Si(this,"ingKey","wheeling")}wheel(e){this.state._active||this.start(e),this.wheelChange(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(e){const t=this.state;t._delta=v2(e),ei.addTo(t._movement,t._delta),I2(t),this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("wheel","",this.wheel.bind(this))}}const bI=ro;class wI extends Ql{constructor(...e){super(...e),Si(this,"ingKey","hovering")}enter(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.start(e),this.computeValues(ca(e)),this.compute(e),this.emit())}leave(e){if(this.config.mouseOnly&&e.pointerType!=="mouse")return;const t=this.state;if(!t._active)return;t._active=!1;const i=ca(e);t._movement=t._delta=ei.sub(i,t._values),this.computeValues(i),this.compute(e),t.delta=t.movement,this.emit()}bind(e){e("pointer","enter",this.enter.bind(this)),e("pointer","leave",this.leave.bind(this))}}const BI=di(di({},ro),{},{mouseOnly:(r=!0)=>r}),F0=new Map,Md=new Map;function RI(r){F0.set(r.key,r.engine),Md.set(r.key,r.resolver)}const DI={key:"drag",engine:rI,resolver:gI},MI={key:"hover",engine:wI,resolver:BI},LI={key:"move",engine:CI,resolver:II},PI={key:"pinch",engine:EI,resolver:xI},FI={key:"scroll",engine:_I,resolver:SI},kI={key:"wheel",engine:TI,resolver:bI};function OI(r,e){if(r==null)return{};var t={},i=Object.keys(r),n,s;for(s=0;s<i.length;s++)n=i[s],!(e.indexOf(n)>=0)&&(t[n]=r[n]);return t}function UI(r,e){if(r==null)return{};var t=OI(r,e),i,n;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);for(n=0;n<s.length;n++)i=s[n],!(e.indexOf(i)>=0)&&Object.prototype.propertyIsEnumerable.call(r,i)&&(t[i]=r[i])}return t}const NI={target(r){if(r)return()=>"current"in r?r.current:r},enabled(r=!0){return r},window(r=Kn.isBrowser?window:void 0){return r},eventOptions({passive:r=!0,capture:e=!1}={}){return{passive:r,capture:e}},transform(r){return r}},GI=["target","eventOptions","window","enabled","transform"];function hu(r={},e){const t={};for(const[i,n]of Object.entries(e))switch(typeof n){case"function":t[i]=n.call(t,r[i],i,r);break;case"object":t[i]=hu(r[i],n);break;case"boolean":n&&(t[i]=r[i]);break}return t}function QI(r,e,t={}){const i=r,{target:n,eventOptions:s,window:o,enabled:a,transform:l}=i,c=UI(i,GI);if(t.shared=hu({target:n,eventOptions:s,window:o,enabled:a,transform:l},NI),e){const u=Md.get(e);t[e]=hu(di({shared:t.shared},c),u)}else for(const u in c){const h=Md.get(u);h&&(t[u]=hu(di({shared:t.shared},c[u]),h))}return t}class _2{constructor(e,t){Si(this,"_listeners",new Set),this._ctrl=e,this._gestureKey=t}add(e,t,i,n,s){const o=this._listeners,a=YC(t,i),l=this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},c=di(di({},l),s);e.addEventListener(a,n,c);const u=()=>{e.removeEventListener(a,n,c),o.delete(u)};return o.add(u),u}clean(){this._listeners.forEach(e=>e()),this._listeners.clear()}}class zI{constructor(){Si(this,"_timeouts",new Map)}add(e,t,i=140,...n){this.remove(e),this._timeouts.set(e,window.setTimeout(t,i,...n))}remove(e){const t=this._timeouts.get(e);t&&window.clearTimeout(t)}clean(){this._timeouts.forEach(e=>void window.clearTimeout(e)),this._timeouts.clear()}}class HI{constructor(e){Si(this,"gestures",new Set),Si(this,"_targetEventStore",new _2(this)),Si(this,"gestureEventStores",{}),Si(this,"gestureTimeoutStores",{}),Si(this,"handlers",{}),Si(this,"config",{}),Si(this,"pointerIds",new Set),Si(this,"touchIds",new Set),Si(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),VI(this,e)}setEventIds(e){if(qu(e))return this.touchIds=new Set(XC(e)),this.touchIds;if("pointerId"in e)return e.type==="pointerup"||e.type==="pointercancel"?this.pointerIds.delete(e.pointerId):e.type==="pointerdown"&&this.pointerIds.add(e.pointerId),this.pointerIds}applyHandlers(e,t){this.handlers=e,this.nativeHandlers=t}applyConfig(e,t){this.config=QI(e,t,this.config)}clean(){this._targetEventStore.clean();for(const e of this.gestures)this.gestureEventStores[e].clean(),this.gestureTimeoutStores[e].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...e){const t=this.config.shared,i={};let n;if(!(t.target&&(n=t.target(),!n))){if(t.enabled){for(const o of this.gestures){const a=this.config[o],l=uA(i,a.eventOptions,!!n);if(a.enabled){const c=F0.get(o);new c(this,e,o).bind(l)}}const s=uA(i,t.eventOptions,!!n);for(const o in this.nativeHandlers)s(o,"",a=>this.nativeHandlers[o](di(di({},this.state.shared),{},{event:a,args:e})),void 0,!0)}for(const s in i)i[s]=eI(...i[s]);if(!n)return i;for(const s in i){const{device:o,capture:a,passive:l}=$C(s);this._targetEventStore.add(n,o,"",i[s],{capture:a,passive:l})}}}}function uo(r,e){r.gestures.add(e),r.gestureEventStores[e]=new _2(r,e),r.gestureTimeoutStores[e]=new zI}function VI(r,e){e.drag&&uo(r,"drag"),e.wheel&&uo(r,"wheel"),e.scroll&&uo(r,"scroll"),e.move&&uo(r,"move"),e.pinch&&uo(r,"pinch"),e.hover&&uo(r,"hover")}const uA=(r,e,t)=>(i,n,s,o={},a=!1)=>{var l,c;const u=(l=o.capture)!==null&&l!==void 0?l:e.capture,h=(c=o.passive)!==null&&c!==void 0?c:e.passive;let f=a?i:VC(i,n,u);t&&h&&(f+="Passive"),r[f]=r[f]||[],r[f].push(s)},KI=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function $I(r){const e={},t={},i=new Set;for(let n in r)KI.test(n)?(i.add(RegExp.lastMatch),t[n]=r[n]):e[n]=r[n];return[t,e,i]}function ho(r,e,t,i,n,s){if(!r.has(t)||!F0.has(i))return;const o=t+"Start",a=t+"End",l=c=>{let u;return c.first&&o in e&&e[o](c),t in e&&(u=e[t](c)),c.last&&a in e&&e[a](c),u};n[i]=l,s[i]=s[i]||{}}function YI(r,e){const[t,i,n]=$I(r),s={};return ho(n,t,"onDrag","drag",s,e),ho(n,t,"onWheel","wheel",s,e),ho(n,t,"onScroll","scroll",s,e),ho(n,t,"onPinch","pinch",s,e),ho(n,t,"onMove","move",s,e),ho(n,t,"onHover","hover",s,e),{handlers:s,config:e,nativeHandlers:i}}function WI(r,e={},t,i){const n=Yn.useMemo(()=>new HI(r),[]);if(n.applyHandlers(r,i),n.applyConfig(e,t),Yn.useEffect(n.effect.bind(n)),Yn.useEffect(()=>n.clean.bind(n),[]),e.target===void 0)return n.bind.bind(n)}function jI(r){return r.forEach(RI),function(t,i){const{handlers:n,nativeHandlers:s,config:o}=YI(t,i||{});return WI(n,o,void 0,s)}}function S2(r,e){return jI([DI,PI,FI,kI,LI,MI])(r,e||{})}const Mh=new z,hA=new De,Pr=new z,tc=new z,ba=new z,fA=new or,eL=g.forwardRef(({autoTransform:r=!0,matrix:e,axisLock:t,dragLimits:i,onHover:n,onDragStart:s,onDrag:o,onDragEnd:a,children:l,dragConfig:c,...u},h)=>{const f=le(v=>v.controls),{camera:d,size:m,raycaster:A,invalidate:p}=le(),y=g.useRef(null),E=S2({onHover:({hovering:v})=>n&&n(v??!1),onDragStart:({event:v})=>{f&&(f.enabled=!1);const{point:x}=v;y.current.matrix.decompose(Mh,new nt,new z),Pr.copy(x),tc.copy(Pr).sub(Mh),s&&s(Mh),p()},onDrag:({xy:[v,x],intentional:C})=>{if(!C)return;const I=(v-m.left)/m.width*2-1,_=-((x-m.top)/m.height)*2+1;if(hA.set(I,_),A.setFromCamera(hA,d),!t)d.getWorldDirection(ba).negate();else switch(t){case"x":ba.set(1,0,0);break;case"y":ba.set(0,1,0);break;case"z":ba.set(0,0,1);break}fA.setFromNormalAndCoplanarPoint(ba,Pr),A.ray.intersectPlane(fA,Pr);const S=y.current.matrix.clone(),b=y.current.matrixWorld.clone(),T=new z(Pr.x-tc.x,Pr.y-tc.y,Pr.z-tc.z);if(i&&(T.x=i[0]?Math.max(Math.min(T.x,i[0][1]),i[0][0]):T.x,T.y=i[1]?Math.max(Math.min(T.y,i[1][1]),i[1][0]):T.y,T.z=i[2]?Math.max(Math.min(T.z,i[2][1]),i[2][0]):T.z),r){y.current.matrix.setPosition(T);const R=y.current.matrix.clone().multiply(S.invert()),w=y.current.matrix.clone().multiply(b.invert());o&&o(y.current.matrix,R,y.current.matrixWorld,w)}else{const R=new we().copy(y.current.matrix);R.setPosition(T);const w=R.clone().multiply(S.invert()),B=R.clone().multiply(b.invert());o&&o(R,w,y.current.matrixWorld,B)}p()},onDragEnd:()=>{f&&(f.enabled=!0),a&&a(),p()}},{drag:{filterTaps:!0,threshold:1,...typeof c=="object"?c:{}}});return g.useImperativeHandle(h,()=>y.current,[]),g.useLayoutEffect(()=>{e&&(y.current.matrix=e)},[e]),g.createElement("group",Ae({ref:y},E(),{matrix:e,matrixAutoUpdate:!1},u),l)});function gl(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Ld(r,e){return Ld=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},Ld(r,e)}function XI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function qI(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];var i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8];return i*a*h+n*l*c+s*o*u-s*a*c-n*o*h-i*l*u}function dA(r,e){for(var t=[],i=r.toArray(),n=e.toArray(),s=0;s<i.length;s++)t[s]=i[s]+n[s];return new bn().fromArray(t)}function JI(r){if(Array.isArray(r))return r}function ZI(r,e){var t=r==null?null:typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(t!=null){var i=[],n=!0,s=!1,o,a;try{for(t=t.call(r);!(n=(o=t.next()).done)&&(i.push(o.value),!(e&&i.length===e));n=!0);}catch(l){s=!0,a=l}finally{try{!n&&t.return!=null&&t.return()}finally{if(s)throw a}}return i}}function Pd(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function T2(r,e){if(r){if(typeof r=="string")return Pd(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Pd(r,e)}}function e4(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ps(r,e){return JI(r)||ZI(r,e)||T2(r,e)||e4()}function t4(r){if(Array.isArray(r))return Pd(r)}function i4(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function n4(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ru(r){return t4(r)||i4(r)||T2(r)||n4()}function fu(r,e,t){return XI()?fu=Reflect.construct:fu=function(n,s,o){var a=[null];a.push.apply(a,s);var l=Function.bind.apply(n,a),c=new l;return o&&Ld(c,o.prototype),c},fu.apply(null,arguments)}function s4(r){var e=Ps(r[0],2),t=e[0],i=e[1],n=Ps(r[1],2),s=n[0],o=n[1],a=Ps(r[2],2),l=a[0],c=a[1];return qI(t,i,1,s,o,1,l,c,1)}function r4(r){return s4(r)===0}var o4=new De,a4=new De;function mA(r){var e=r.map(function(c){return Array.isArray(c)?fu(De,Ru(c)):c}),t=Ps(e,3),i=t[0],n=t[1],s=t[2];if(r4(r))return!1;var o=o4.subVectors(n,i),a=a4.subVectors(s,i),l=a.cross(o);return l>0}function b2(r,e,t){return Math.max(e,Math.min(t,r))}function w2(r,e){return b2(r-Math.floor(r/e)*e,0,e)}function B2(r,e){var t=w2(e-r,Math.PI*2);return t>Math.PI&&(t-=Math.PI*2),t}function l4(r){return r/180*Math.PI}function c4(r){return r*180/Math.PI}function u4(r,e){for(var t=e.radius,i=t===void 0?1:t,n=r.length/3,s=2/n,o=Math.PI*(3-2.2360679775),a=0;a<r.length;a+=3){var l=a*s-1+s/2,c=Math.sqrt(1-Math.pow(l,2)),u=a%n*o,h=Math.cos(u)*c,f=Math.sin(u)*c;r[a]=h*i,r[a+1]=l*i,r[a+2]=f*i}}function h4(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Number.EPSILON;return Math.abs(r.x-e.x)<t&&Math.abs(r.y-e.y)<t&&Math.abs(r.z-e.z)<t}function R2(r,e){return r.x===e.x?typeof r.z<"u"&&r.y===e.y?r.z-e.z:r.y-e.y:r.x-e.x}function f4(r){for(var e=r.sort(R2),t=[e[0],e[1]],i=2;i<e.length;i++)for(t.push(e[i]);t.length>2&&mA(Ru(t.slice(-3)));)t.splice(t.length-2,1);for(var n=[e[e.length-1],e[e.length-2]],s=e.length-3;s>=0;s--)for(n.push(e[s]);n.length>2&&mA(Ru(n.slice(-3)));)n.splice(n.length-2,1);n.splice(0,1),n.splice(n.length-1,1);var o=[].concat(t,n);return o}function d4(r,e,t){var i=Ps(e,2),n=i[0],s=i[1],o=Ps(t,2),a=o[0],l=o[1];return a+(r-n)*(l-a)/(s-n)}function m4(r){return r*r*r*(r*(r*6-15)+10)}function A4(r,e,t){return r*(1-t)+e*t}function D2(r,e,t){return(t-r)/(e-r)}function p4(r,e,t){var i=Math.sqrt(r*r+e*e+t*t);return[r/i,e/i,t/i]}function g4(r,e,t){var i=r*r,n=e*e,s=t*t,o=r*Math.sqrt(1-(n+s)/2+n*s/3),a=e*Math.sqrt(1-(s+i)/2+s*i/3),l=t*Math.sqrt(1-(i+n)/2+i*n/3);return[o,a,l]}function M2(r,e){var t=new z().crossVectors(r,e),i=r.dot(e),n=new bn().identity(),s=new bn().set(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0),o=new bn().multiplyMatrices(s,s).multiplyScalar(1/(1+i)),a=dA(dA(n,s),o);return a}function y4(r,e,t){var i=Math.asin(e),n=Math.atan2(r,-t);return[i,n]}function v4(r,e){var t=Math.sin(r),i=Math.cos(r),n=Math.sin(e)*i,s=-Math.cos(e)*i;return[n,t,s]}function E4(r,e){var t=Ps(e,2),i=t[0],n=t[1],s=M2(r.normal,new z(0,1,0)),o=D2(i.clone().applyMatrix3(s).y,n.clone().applyMatrix3(s).y,0);return new z().lerpVectors(i,n,o)}function x4(r,e){var t=e.normal.dot(r);return t}function C4(r,e){var t=Ps(r,3),i=t[0],n=t[1],s=t[2],o=Ps(e,2),a=o[0],l=o[1];return s*a*l+n*a+i}function I4(r,e){var t=Ps(e,2),i=t[0],n=t[1],s=i*n,o=r/s,a=r-s*o,l=a/i,c=a%i;return[c,l,o]}function _4(r,e){return r[0]+e[0]*r[1]}function S4(r,e){var t=r%e,i=Math.floor(r/e);return[t,i]}var ic=Object.freeze({__proto__:null,clamp:b2,repeat:w2,deltaAngle:B2,degToRad:l4,radToDeg:c4,fibonacciOnSphere:u4,vectorEquals:h4,lexicographic:R2,convexHull:f4,remap:d4,fade:m4,lerp:A4,inverseLerp:D2,normalize:p4,pointOnCubeToPointOnSphere:g4,rotateVectorOnVector:M2,pointToCoordinate:y4,coordinateToPoint:v4,planeSegmentIntersection:E4,pointToPlaneDistance:x4,getIndexFrom3D:C4,get3DFromIndex:I4,getIndexFrom2D:_4,get2DFromIndex:S4});function L2(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var kn=function r(e,t,i){var n=this;L2(this,r),gl(this,"dot2",function(s,o){return n.x*s+n.y*o}),gl(this,"dot3",function(s,o,a){return n.x*s+n.y*o+n.z*a}),this.x=e,this.y=t,this.z=i},T4=[new kn(1,1,0),new kn(-1,1,0),new kn(1,-1,0),new kn(-1,-1,0),new kn(1,0,1),new kn(-1,0,1),new kn(1,0,-1),new kn(-1,0,-1),new kn(0,1,1),new kn(0,-1,1),new kn(0,1,-1),new kn(0,-1,-1)],AA=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],pA=new Array(512),gA=new Array(512),b4=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(var t=0;t<256;t++){var i;t&1?i=AA[t]^e&255:i=AA[t]^e>>8&255,pA[t]=pA[t+256]=i,gA[t]=gA[t+256]=T4[i%12]}};b4(0);function w4(r){if(typeof r=="number")r=Math.abs(r);else if(typeof r=="string"){var e=r;r=0;for(var t=0;t<e.length;t++)r=(r+(t+1)*(e.charCodeAt(t)%96))%2147483647}return r===0&&(r=311),r}function yA(r){var e=w4(r);return function(){var t=e*48271%2147483647;return e=t,t/2147483647}}var B4=function r(e){var t=this;L2(this,r),gl(this,"seed",0),gl(this,"init",function(i){t.seed=i,t.value=yA(i)}),gl(this,"value",yA(this.seed)),this.init(e)};new B4(Math.random());var R4=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.01,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1/(2*Math.PI);return i/Math.atan(1/t)*Math.atan(Math.sin(2*Math.PI*e*n)/t)},P2=function(e){return 1/(1+e+.48*e*e+.235*e*e*e)},D4=function(e){return e},M4={in:function(e){return 1-Math.cos(e*Math.PI/2)},out:function(e){return Math.sin(e*Math.PI/2)},inOut:function(e){return-(Math.cos(Math.PI*e)-1)/2}},L4={in:function(e){return e*e*e},out:function(e){return 1-Math.pow(1-e,3)},inOut:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},P4={in:function(e){return e*e*e*e*e},out:function(e){return 1-Math.pow(1-e,5)},inOut:function(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}},F4={in:function(e){return 1-Math.sqrt(1-Math.pow(e,2))},out:function(e){return Math.sqrt(1-Math.pow(e-1,2))},inOut:function(e){return e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2}},k4={in:function(e){return e*e*e*e},out:function(e){return 1- --e*e*e*e},inOut:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}},O4={in:function(e){return e===0?0:Math.pow(2,10*e-10)},out:function(e){return e===1?1:1-Math.pow(2,-10*e)},inOut:function(e){return e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2}};function Oi(r,e,t){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:.25,n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:.01,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1/0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:P2,a=arguments.length>7&&arguments[7]!==void 0?arguments[7]:.001,l="velocity_"+e;if(r.__damp===void 0&&(r.__damp={}),r.__damp[l]===void 0&&(r.__damp[l]=0),Math.abs(r[e]-t)<=a)return r[e]=t,!1;i=Math.max(1e-4,i);var c=2/i,u=o(c*n),h=r[e]-t,f=t,d=s*i;h=Math.min(Math.max(h,-d),d),t=r[e]-h;var m=(r.__damp[l]+c*h)*n;r.__damp[l]=(r.__damp[l]-c*m)*u;var A=t+(h+m)*u;return f-r[e]>0==A>f&&(A=f,r.__damp[l]=(A-f)/n),r[e]=A,!0}var U4=function(e){return e&&e.isCamera},N4=function(e){return e&&e.isLight},wa=new z,vA=new nt,EA=new nt,Ba=new we,Lh=new z;function G4(r,e,t,i,n,s,o){typeof e=="number"?wa.setScalar(e):Array.isArray(e)?wa.set(e[0],e[1],e[2]):wa.copy(e);var a=r.parent;r.updateWorldMatrix(!0,!1),Lh.setFromMatrixPosition(r.matrixWorld),U4(r)||N4(r)?Ba.lookAt(Lh,wa,r.up):Ba.lookAt(wa,Lh,r.up),Du(r.quaternion,EA.setFromRotationMatrix(Ba),t,i,n,s,o),a&&(Ba.extractRotation(a.matrixWorld),vA.setFromRotationMatrix(Ba),Du(r.quaternion,EA.copy(r.quaternion).premultiply(vA.invert()),t,i,n,s,o))}function ta(r,e,t,i,n,s,o,a){return Oi(r,e,r[e]+B2(r[e],t),i,n,s,o,a)}var Ra=new De,xA,CA;function Q4(r,e,t,i,n,s,o){return typeof e=="number"?Ra.setScalar(e):Array.isArray(e)?Ra.set(e[0],e[1]):Ra.copy(e),xA=Oi(r,"x",Ra.x,t,i,n,s,o),CA=Oi(r,"y",Ra.y,t,i,n,s,o),xA||CA}var fo=new z,IA,_A,SA;function Fd(r,e,t,i,n,s,o){return typeof e=="number"?fo.setScalar(e):Array.isArray(e)?fo.set(e[0],e[1],e[2]):fo.copy(e),IA=Oi(r,"x",fo.x,t,i,n,s,o),_A=Oi(r,"y",fo.y,t,i,n,s,o),SA=Oi(r,"z",fo.z,t,i,n,s,o),IA||_A||SA}var Fr=new Ci,TA,bA,wA,BA;function z4(r,e,t,i,n,s,o){return typeof e=="number"?Fr.setScalar(e):Array.isArray(e)?Fr.set(e[0],e[1],e[2],e[3]):Fr.copy(e),TA=Oi(r,"x",Fr.x,t,i,n,s,o),bA=Oi(r,"y",Fr.y,t,i,n,s,o),wA=Oi(r,"z",Fr.z,t,i,n,s,o),BA=Oi(r,"w",Fr.w,t,i,n,s,o),TA||bA||wA||BA}var Da=new wn,RA,DA,MA;function H4(r,e,t,i,n,s,o){return Array.isArray(e)?Da.set(e[0],e[1],e[2],e[3]):Da.copy(e),RA=ta(r,"x",Da.x,t,i,n,s,o),DA=ta(r,"y",Da.y,t,i,n,s,o),MA=ta(r,"z",Da.z,t,i,n,s,o),RA||DA||MA}var mo=new Ye,LA,PA,FA;function V4(r,e,t,i,n,s,o){return e instanceof Ye?mo.copy(e):Array.isArray(e)?mo.setRGB(e[0],e[1],e[2]):mo.set(e),LA=Oi(r,"r",mo.r,t,i,n,s,o),PA=Oi(r,"g",mo.g,t,i,n,s,o),FA=Oi(r,"b",mo.b,t,i,n,s,o),LA||PA||FA}var ss=new nt,Gs=new Ci,kA=new Ci,Ma=new Ci,OA,UA,NA,GA;function Du(r,e,t,i,n,s,o){var a=r;Array.isArray(e)?ss.set(e[0],e[1],e[2],e[3]):ss.copy(e);var l=r.dot(ss)>0?1:-1;return ss.x*=l,ss.y*=l,ss.z*=l,ss.w*=l,OA=Oi(r,"x",ss.x,t,i,n,s,o),UA=Oi(r,"y",ss.y,t,i,n,s,o),NA=Oi(r,"z",ss.z,t,i,n,s,o),GA=Oi(r,"w",ss.w,t,i,n,s,o),Gs.set(r.x,r.y,r.z,r.w).normalize(),kA.set(a.__damp.velocity_x,a.__damp.velocity_y,a.__damp.velocity_z,a.__damp.velocity_w),Ma.copy(Gs).multiplyScalar(kA.dot(Gs)/Gs.dot(Gs)),a.__damp.velocity_x-=Ma.x,a.__damp.velocity_y-=Ma.y,a.__damp.velocity_z-=Ma.z,a.__damp.velocity_w-=Ma.w,r.set(Gs.x,Gs.y,Gs.z,Gs.w),OA||UA||NA||GA}var La=new aa,QA,zA,HA;function K4(r,e,t,i,n,s,o){return Array.isArray(e)?La.set(e[0],e[1],e[2]):La.copy(e),QA=Oi(r,"radius",La.radius,t,i,n,s,o),zA=ta(r,"phi",La.phi,t,i,n,s,o),HA=ta(r,"theta",La.theta,t,i,n,s,o),QA||zA||HA}var nc=new we,VA=new z,KA=new nt,$A=new z,YA,WA,jA;function $4(r,e,t,i,n,s,o){var a=r;return a.__damp===void 0&&(a.__damp={position:new z,rotation:new nt,scale:new z},r.decompose(a.__damp.position,a.__damp.rotation,a.__damp.scale)),Array.isArray(e)?nc.set.apply(nc,Ru(e)):nc.copy(e),nc.decompose(VA,KA,$A),YA=Fd(a.__damp.position,VA,t,i,n,s,o),WA=Du(a.__damp.rotation,KA,t,i,n,s,o),jA=Fd(a.__damp.scale,$A,t,i,n,s,o),r.compose(a.__damp.position,a.__damp.rotation,a.__damp.scale),YA||WA||jA}var wr=Object.freeze({__proto__:null,rsqw:R4,exp:P2,linear:D4,sine:M4,cubic:L4,quint:P4,circ:F4,quart:k4,expo:O4,damp:Oi,dampLookAt:G4,dampAngle:ta,damp2:Q4,damp3:Fd,damp4:z4,dampE:H4,dampC:V4,dampQ:Du,dampS:K4,dampM:$4});const k0=g.createContext(null);function F2(){return g.useContext(k0)}function tL({eps:r=1e-5,enabled:e=!0,infinite:t,horizontal:i,pages:n=1,distance:s=1,damping:o=.25,maxSpeed:a=1/0,prepend:l=!1,style:c={},children:u}){const{get:h,setEvents:f,gl:d,size:m,invalidate:A,events:p}=le(),[y]=g.useState(()=>document.createElement("div")),[E]=g.useState(()=>document.createElement("div")),[v]=g.useState(()=>document.createElement("div")),x=d.domElement.parentNode,C=g.useRef(0),I=g.useMemo(()=>({el:y,eps:r,fill:E,fixed:v,horizontal:i,damping:o,offset:0,delta:0,scroll:C,pages:n,range(b,T,R=0){const w=b-R,B=w+T+R*2;return this.offset<w?0:this.offset>B?1:(this.offset-w)/(B-w)},curve(b,T,R=0){return Math.sin(this.range(b,T,R)*Math.PI)},visible(b,T,R=0){const w=b-R,B=w+T+R*2;return this.offset>=w&&this.offset<=B}}),[r,o,i,n]);g.useEffect(()=>{y.style.position="absolute",y.style.width="100%",y.style.height="100%",y.style[i?"overflowX":"overflowY"]="auto",y.style[i?"overflowY":"overflowX"]="hidden",y.style.top="0px",y.style.left="0px";for(const T in c)y.style[T]=c[T];v.style.position="sticky",v.style.top="0px",v.style.left="0px",v.style.width="100%",v.style.height="100%",v.style.overflow="hidden",y.appendChild(v),E.style.height=i?"100%":`${n*s*100}%`,E.style.width=i?`${n*s*100}%`:"100%",E.style.pointerEvents="none",y.appendChild(E),l?x.prepend(y):x.appendChild(y),y[i?"scrollLeft":"scrollTop"]=1;const S=p.connected||d.domElement;requestAnimationFrame(()=>p.connect==null?void 0:p.connect(y));const b=h().events.compute;return f({compute(T,R){const{left:w,top:B}=x.getBoundingClientRect(),D=T.clientX-w,k=T.clientY-B;R.pointer.set(D/R.size.width*2-1,-(k/R.size.height)*2+1),R.raycaster.setFromCamera(R.pointer,R.camera)}}),()=>{x.removeChild(y),f({compute:b}),p.connect==null||p.connect(S)}},[n,s,i,y,E,v,x]),g.useEffect(()=>{if(p.connected===y){const S=m[i?"width":"height"],b=y[i?"scrollWidth":"scrollHeight"],T=b-S;let R=0,w=!0,B=!0;const D=()=>{if(!(!e||B)&&(A(),R=y[i?"scrollLeft":"scrollTop"],C.current=R/T,t)){if(!w){if(R>=T){const Q=1-I.offset;y[i?"scrollLeft":"scrollTop"]=1,C.current=I.offset=-Q,w=!0}else if(R<=0){const Q=1+I.offset;y[i?"scrollLeft":"scrollTop"]=b,C.current=I.offset=Q,w=!0}}w&&setTimeout(()=>w=!1,40)}};y.addEventListener("scroll",D,{passive:!0}),requestAnimationFrame(()=>B=!1);const k=Q=>y.scrollLeft+=Q.deltaY/2;return i&&y.addEventListener("wheel",k,{passive:!0}),()=>{y.removeEventListener("scroll",D),i&&y.removeEventListener("wheel",k)}}},[y,p,m,t,I,A,i,e]);let _=0;return He((S,b)=>{_=I.offset,wr.damp(I,"offset",C.current,o,b,a,void 0,r),wr.damp(I,"delta",Math.abs(_-I.offset),o,b,a,void 0,r),I.delta>r&&A()}),g.createElement(k0.Provider,{value:I},u)}const Y4=g.forwardRef(({children:r},e)=>{const t=g.useRef(null);g.useImperativeHandle(e,()=>t.current,[]);const i=F2(),{width:n,height:s}=le(o=>o.viewport);return He(()=>{t.current.position.x=i.horizontal?-n*(i.pages-1)*i.offset:0,t.current.position.y=i.horizontal?0:s*(i.pages-1)*i.offset}),g.createElement("group",{ref:t},r)}),W4=g.forwardRef(({children:r,style:e,...t},i)=>{const n=F2(),s=g.useRef(null);g.useImperativeHandle(i,()=>s.current,[]);const{width:o,height:a}=le(u=>u.size),l=g.useContext(xd),c=g.useMemo(()=>Ny.createRoot(n.fixed),[n.fixed]);return He(()=>{n.delta>n.eps&&(s.current.style.transform=`translate3d(${n.horizontal?-o*(n.pages-1)*n.offset:0}px,${n.horizontal?0:a*(n.pages-1)*-n.offset}px,0)`)}),c.render(g.createElement("div",Ae({ref:s,style:{...e,position:"absolute",top:0,left:0,willChange:"transform"}},t),g.createElement(k0.Provider,{value:n},g.createElement(xd.Provider,{value:l},r)))),null}),iL=g.forwardRef(({html:r,...e},t)=>{const i=r?W4:Y4;return g.createElement(i,Ae({ref:t},e))});function nL({enabled:r=!0,snap:e,global:t,domElement:i,cursor:n=!0,children:s,speed:o=1,rotation:a=[0,0,0],zoom:l=1,polar:c=[0,Math.PI/2],azimuth:u=[-1/0,1/0],damping:h=.25}){const f=le(I=>I.events),d=le(I=>I.gl),m=i||f.connected||d.domElement,{size:A}=le(),p=g.useMemo(()=>[a[0]+c[0],a[0]+c[1]],[a[0],c[0],c[1]]),y=g.useMemo(()=>[a[1]+u[0],a[1]+u[1]],[a[1],u[0],u[1]]),E=g.useMemo(()=>[et.clamp(a[0],...p),et.clamp(a[1],...y),a[2]],[a[0],a[1],a[2],p,y]);g.useEffect(()=>{if(t&&n&&r)return m.style.cursor="grab",d.domElement.style.cursor="",()=>{m.style.cursor="default",d.domElement.style.cursor="default"}},[t,n,m,r]);const[v]=g.useState({scale:1,rotation:E,damping:h}),x=g.useRef(null);He((I,_)=>{wr.damp3(x.current.scale,v.scale,v.damping,_),wr.dampE(x.current.rotation,v.rotation,v.damping,_)});const C=S2({onHover:({last:I})=>{n&&!t&&r&&(m.style.cursor=I?"auto":"grab")},onDrag:({down:I,delta:[_,S],memo:[b,T]=v.rotation||E})=>r?(n&&(m.style.cursor=I?"grabbing":"grab"),_=et.clamp(T+_/A.width*Math.PI*o,...y),S=et.clamp(b+S/A.height*Math.PI*o,...p),v.scale=I&&S>p[1]/2?l:1,v.rotation=e&&!I?E:[S,_,0],v.damping=e&&!I&&typeof e!="boolean"?e:h,[S,_]):[S,_]},{target:t?m:void 0});return g.createElement("group",Ae({ref:x},C==null?void 0:C()),s)}const j4=r=>(e,t,i)=>{const n=i.subscribe;return i.subscribe=(o,a,l)=>{let c=o;if(a){const u=(l==null?void 0:l.equalityFn)||Object.is;let h=o(i.getState());c=f=>{const d=o(f);if(!u(h,d)){const m=h;a(h=d,m)}},l!=null&&l.fireImmediately&&a(h,h)}return n(c)},r(e,t,i)},X4=j4,k2=g.createContext(null);function sL({map:r,children:e,onChange:t,domElement:i}){const n=r.map(l=>l.name+l.keys).join("-"),s=g.useMemo(()=>m2(X4(()=>r.reduce((l,c)=>({...l,[c.name]:!1}),{}))),[n]),o=g.useMemo(()=>[s.subscribe,s.getState,s],[n]),a=s.setState;return g.useEffect(()=>{const c=r.map(({name:d,keys:m,up:A})=>({keys:m,up:A,fn:p=>{a({[d]:p}),t&&t(d,p,o[1]())}})).reduce((d,{keys:m,fn:A,up:p=!0})=>(m.forEach(y=>d[y]={fn:A,pressed:!1,up:p}),d),{}),u=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,pressed:y,up:E}=A;A.pressed=!0,(E||!y)&&p(!0)},h=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,up:y}=A;A.pressed=!1,y&&p(!1)},f=i||window;return f.addEventListener("keydown",u,{passive:!0}),f.addEventListener("keyup",h,{passive:!0}),()=>{f.removeEventListener("keydown",u),f.removeEventListener("keyup",h)}},[i,n]),g.createElement(k2.Provider,{value:o,children:e})}function rL(r){const[e,t,i]=g.useContext(k2);return r?i(r):[e,t]}const pa=(()=>parseInt(Ul.replace(/\D+/g,"")))(),O0=pa>=125?"uv1":"uv2";var q4=Object.defineProperty,J4=(r,e,t)=>e in r?q4(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Pa=(r,e,t)=>(J4(r,typeof e!="symbol"?e+"":e,t),t);const Vo=4,ia=1024,Bs=4,Z4=(r=1)=>{const e=new Float32Array(ia*Bs*r*Vo),t=new br(e,ia,Bs*r,wi,ii);return t.wrapS=Pn,t.wrapT=Pn,t.magFilter=Xt,t.needsUpdate=!0,t},e_=(r,e,t=0)=>{const i=Math.floor(ia*(Bs/4));e.arcLengthDivisions=i/2,e.updateArcLengths();const n=e.getSpacedPoints(i),s=e.computeFrenetFrames(i,!0);for(let o=0;o<i;o++){const a=Math.floor(o/ia),l=o%ia;let c=n[o];sc(r,l,c.x,c.y,c.z,0+a+Bs*t),c=s.tangents[o],sc(r,l,c.x,c.y,c.z,1+a+Bs*t),c=s.normals[o],sc(r,l,c.x,c.y,c.z,2+a+Bs*t),c=s.binormals[o],sc(r,l,c.x,c.y,c.z,3+a+Bs*t)}r.needsUpdate=!0},sc=(r,e,t,i,n,s)=>{const o=r.image,{data:a}=o,l=Vo*ia*s;a[e*Vo+l+0]=t,a[e*Vo+l+1]=i,a[e*Vo+l+2]=n,a[e*Vo+l+3]=1},t_=r=>({spineTexture:{value:r},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}});function i_(r,e,t=1){r.__ok||(r.__ok=!0,r.onBeforeCompile=i=>{if(i.__modified)return;i.__modified=!0,Object.assign(i.uniforms,e);const n=`
		uniform sampler2D spineTexture;
		uniform float pathOffset;
		uniform float pathSegment;
		uniform float spineOffset;
		uniform float spineLength;
		uniform int flow;

		float textureLayers = ${Bs*t}.;
		float textureStacks = ${Bs/4}.;

		${i.vertexShader}
		`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,`
        void main() {
        #include <beginnormal_vertex>

        vec4 worldPos = modelMatrix * vec4(position, 1.);

        bool bend = flow > 0;
        float xWeight = bend ? 0. : 1.;

        #ifdef USE_INSTANCING
        float pathOffsetFromInstanceMatrix = instanceMatrix[3][2];
        float spineLengthFromInstanceMatrix = instanceMatrix[3][0];
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;
        float mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;
        #else
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;
        float mt = (spinePortion * pathSegment + pathOffset)*textureStacks;
        #endif

        mt = mod(mt, textureStacks);
        float rowOffset = floor(mt);

        #ifdef USE_INSTANCING
        rowOffset += instanceMatrix[3][1] * ${Bs}.;
        #endif

        vec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;
        mat3 basis = mat3(a, b, c);

        vec3 transformed = basis
          * vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)
          + spinePos;

        vec3 transformedNormal = normalMatrix * (basis * objectNormal);
			`).replace("#include <project_vertex>",`vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );
				gl_Position = projectionMatrix * mvPosition;`);i.vertexShader=n})}class n_{constructor(e,t=1){Pa(this,"curveArray"),Pa(this,"curveLengthArray"),Pa(this,"object3D"),Pa(this,"splineTexure"),Pa(this,"uniforms");const i=e.clone(),n=Z4(t),s=t_(n);i.traverse(o=>{(o instanceof Qe||o instanceof _0)&&(o.material=o.material.clone(),i_(o.material,s,t))}),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=i,this.splineTexure=n,this.uniforms=s}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const i=t.getLength();this.uniforms.spineLength.value=i,this.curveLengthArray[e]=i,this.curveArray[e]=t,e_(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}function s_(r,e=1e-4){e=Math.max(e,Number.EPSILON);const t={},i=r.getIndex(),n=r.getAttribute("position"),s=i?i.count:n.count;let o=0;const a=Object.keys(r.attributes),l={},c={},u=[],h=["getX","getY","getZ","getW"];for(let A=0,p=a.length;A<p;A++){const y=a[A];l[y]=[];const E=r.morphAttributes[y];E&&(c[y]=new Array(E.length).fill(0).map(()=>[]))}const f=Math.log10(1/e),d=Math.pow(10,f);for(let A=0;A<s;A++){const p=i?i.getX(A):A;let y="";for(let E=0,v=a.length;E<v;E++){const x=a[E],C=r.getAttribute(x),I=C.itemSize;for(let _=0;_<I;_++)y+=`${~~(C[h[_]](p)*d)},`}if(y in t)u.push(t[y]);else{for(let E=0,v=a.length;E<v;E++){const x=a[E],C=r.getAttribute(x),I=r.morphAttributes[x],_=C.itemSize,S=l[x],b=c[x];for(let T=0;T<_;T++){const R=h[T];if(S.push(C[R](p)),I)for(let w=0,B=I.length;w<B;w++)b[w].push(I[w][R](p))}}t[y]=o,u.push(o),o++}}const m=r.clone();for(let A=0,p=a.length;A<p;A++){const y=a[A],E=r.getAttribute(y),v=new E.array.constructor(l[y]),x=new Nt(v,E.itemSize,E.normalized);if(m.setAttribute(y,x),y in c)for(let C=0;C<c[y].length;C++){const I=r.morphAttributes[y][C],_=new I.array.constructor(c[y][C]),S=new Nt(_,I.itemSize,I.normalized);m.morphAttributes[y][C]=S}}return m.setIndex(u),m}function XA(r,e){if(e===Ix)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(e===Cd||e===Qy){let t=r.getIndex();if(t===null){const o=[],a=r.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);r.setIndex(o),t=r.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r}const i=t.count-2,n=[];if(t)if(e===Cd)for(let o=1;o<=i;o++)n.push(t.getX(0)),n.push(t.getX(o)),n.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(n.push(t.getX(o)),n.push(t.getX(o+1)),n.push(t.getX(o+2))):(n.push(t.getX(o+2)),n.push(t.getX(o+1)),n.push(t.getX(o)));n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=r.clone();return s.setIndex(n),s.clearGroups(),s}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),r}function O2(r,e=Math.PI/3){const t=Math.cos(e),i=(1+1e-10)*100,n=[new z,new z,new z],s=new z,o=new z,a=new z,l=new z;function c(A){const p=~~(A.x*i),y=~~(A.y*i),E=~~(A.z*i);return`${p},${y},${E}`}const u=r.index?r.toNonIndexed():r,h=u.attributes.position,f={};for(let A=0,p=h.count/3;A<p;A++){const y=3*A,E=n[0].fromBufferAttribute(h,y+0),v=n[1].fromBufferAttribute(h,y+1),x=n[2].fromBufferAttribute(h,y+2);s.subVectors(x,v),o.subVectors(E,v);const C=new z().crossVectors(s,o).normalize();for(let I=0;I<3;I++){const _=n[I],S=c(_);S in f||(f[S]=[]),f[S].push(C)}}const d=new Float32Array(h.count*3),m=new Nt(d,3,!1);for(let A=0,p=h.count/3;A<p;A++){const y=3*A,E=n[0].fromBufferAttribute(h,y+0),v=n[1].fromBufferAttribute(h,y+1),x=n[2].fromBufferAttribute(h,y+2);s.subVectors(x,v),o.subVectors(E,v),a.crossVectors(s,o).normalize();for(let C=0;C<3;C++){const I=n[C],_=c(I),S=f[_];l.set(0,0,0);for(let b=0,T=S.length;b<T;b++){const R=S[b];a.dot(R)>t&&l.add(R)}l.normalize(),m.setXYZ(y+C,l.x,l.y,l.z)}}return u.setAttribute("normal",m),u}var $n=Uint8Array,Ir=Uint16Array,kd=Uint32Array,U2=new $n([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),N2=new $n([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),r_=new $n([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),G2=function(r,e){for(var t=new Ir(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new kd(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return[t,n]},Q2=G2(U2,2),z2=Q2[0],o_=Q2[1];z2[28]=258,o_[258]=28;var a_=G2(N2,0),l_=a_[0],Od=new Ir(32768);for(var Zt=0;Zt<32768;++Zt){var ur=(Zt&43690)>>>1|(Zt&21845)<<1;ur=(ur&52428)>>>2|(ur&13107)<<2,ur=(ur&61680)>>>4|(ur&3855)<<4,Od[Zt]=((ur&65280)>>>8|(ur&255)<<8)>>>1}var yl=function(r,e,t){for(var i=r.length,n=0,s=new Ir(e);n<i;++n)++s[r[n]-1];var o=new Ir(e);for(n=0;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new Ir(1<<e);var l=15-e;for(n=0;n<i;++n)if(r[n])for(var c=n<<4|r[n],u=e-r[n],h=o[r[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[Od[h]>>>l]=c}else for(a=new Ir(i),n=0;n<i;++n)r[n]&&(a[n]=Od[o[r[n]-1]++]>>>15-r[n]);return a},Hl=new $n(288);for(var Zt=0;Zt<144;++Zt)Hl[Zt]=8;for(var Zt=144;Zt<256;++Zt)Hl[Zt]=9;for(var Zt=256;Zt<280;++Zt)Hl[Zt]=7;for(var Zt=280;Zt<288;++Zt)Hl[Zt]=8;var H2=new $n(32);for(var Zt=0;Zt<32;++Zt)H2[Zt]=5;var c_=yl(Hl,9,1),u_=yl(H2,5,1),Ph=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},rs=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},Fh=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},h_=function(r){return(r/8|0)+(r&7&&1)},f_=function(r,e,t){(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length);var i=new(r instanceof Ir?Ir:r instanceof kd?kd:$n)(t-e);return i.set(r.subarray(e,t)),i},d_=function(r,e,t){var i=r.length;if(!i||t&&!t.l&&i<5)return e||new $n(0);var n=!e||t,s=!t||t.i;t||(t={}),e||(e=new $n(i*3));var o=function(F){var U=e.length;if(F>U){var N=new $n(Math.max(U*2,F));N.set(e),e=N}},a=t.f||0,l=t.p||0,c=t.b||0,u=t.l,h=t.d,f=t.m,d=t.n,m=i*8;do{if(!u){t.f=a=rs(r,l,1);var A=rs(r,l+1,3);if(l+=3,A)if(A==1)u=c_,h=u_,f=9,d=5;else if(A==2){var v=rs(r,l,31)+257,x=rs(r,l+10,15)+4,C=v+rs(r,l+5,31)+1;l+=14;for(var I=new $n(C),_=new $n(19),S=0;S<x;++S)_[r_[S]]=rs(r,l+S*3,7);l+=x*3;for(var b=Ph(_),T=(1<<b)-1,R=yl(_,b,1),S=0;S<C;){var w=R[rs(r,l,T)];l+=w&15;var p=w>>>4;if(p<16)I[S++]=p;else{var B=0,D=0;for(p==16?(D=3+rs(r,l,3),l+=2,B=I[S-1]):p==17?(D=3+rs(r,l,7),l+=3):p==18&&(D=11+rs(r,l,127),l+=7);D--;)I[S++]=B}}var k=I.subarray(0,v),Q=I.subarray(v);f=Ph(k),d=Ph(Q),u=yl(k,f,1),h=yl(Q,d,1)}else throw"invalid block type";else{var p=h_(l)+4,y=r[p-4]|r[p-3]<<8,E=p+y;if(E>i){if(s)throw"unexpected EOF";break}n&&o(c+y),e.set(r.subarray(p,E),c),t.b=c+=y,t.p=l=E*8;continue}if(l>m){if(s)throw"unexpected EOF";break}}n&&o(c+131072);for(var Y=(1<<f)-1,W=(1<<d)-1,P=l;;P=l){var B=u[Fh(r,l)&Y],K=B>>>4;if(l+=B&15,l>m){if(s)throw"unexpected EOF";break}if(!B)throw"invalid length/literal";if(K<256)e[c++]=K;else if(K==256){P=l,u=null;break}else{var M=K-254;if(K>264){var S=K-257,V=U2[S];M=rs(r,l,(1<<V)-1)+z2[S],l+=V}var $=h[Fh(r,l)&W],G=$>>>4;if(!$)throw"invalid distance";l+=$&15;var Q=l_[G];if(G>3){var V=N2[G];Q+=Fh(r,l)&(1<<V)-1,l+=V}if(l>m){if(s)throw"unexpected EOF";break}n&&o(c+131072);for(var O=c+M;c<O;c+=4)e[c]=e[c-Q],e[c+1]=e[c+1-Q],e[c+2]=e[c+2-Q],e[c+3]=e[c+3-Q];c=O}}t.l=u,t.p=P,t.b=c,u&&(a=1,t.m=f,t.d=h,t.n=d)}while(!a);return c==e.length?e:f_(e,0,c)},m_=new $n(0),A_=function(r){if((r[0]&15)!=8||r[0]>>>4>7||(r[0]<<8|r[1])%31)throw"invalid zlib data";if(r[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function fl(r,e){return d_((A_(r),r.subarray(2,-4)),e)}var p_=typeof TextDecoder<"u"&&new TextDecoder,g_=0;try{p_.decode(m_,{stream:!0}),g_=1}catch{}let y_=class extends Qe{constructor(e,t,i=!1,n=!1,s=1e4){const o=new ki;super(o,t),this.isMarchingCubes=!0;const a=this,l=new Float32Array(12*3),c=new Float32Array(12*3),u=new Float32Array(12*3);this.enableUvs=i,this.enableColors=n,this.init=function(E){this.resolution=E,this.isolation=80,this.size=E,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(this.size3*3),this.palette=new Float32Array(this.size3*3),this.count=0;const v=s*3;this.positionArray=new Float32Array(v*3);const x=new Nt(this.positionArray,3);x.setUsage(Ji),o.setAttribute("position",x),this.normalArray=new Float32Array(v*3);const C=new Nt(this.normalArray,3);if(C.setUsage(Ji),o.setAttribute("normal",C),this.enableUvs){this.uvArray=new Float32Array(v*2);const I=new Nt(this.uvArray,2);I.setUsage(Ji),o.setAttribute("uv",I)}if(this.enableColors){this.colorArray=new Float32Array(v*3);const I=new Nt(this.colorArray,3);I.setUsage(Ji),o.setAttribute("color",I)}o.boundingSphere=new on(new z,1)};function h(E,v,x){return E+(v-E)*x}function f(E,v,x,C,I,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[v+0]=C+w*a.delta,l[v+1]=I,l[v+2]=_,c[v+0]=h(B[E+0],B[E+3],w),c[v+1]=h(B[E+1],B[E+4],w),c[v+2]=h(B[E+2],B[E+5],w),u[v+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[v+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[v+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function d(E,v,x,C,I,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[v+0]=C,l[v+1]=I+w*a.delta,l[v+2]=_;const D=E+a.yd*3;c[v+0]=h(B[E+0],B[D+0],w),c[v+1]=h(B[E+1],B[D+1],w),c[v+2]=h(B[E+2],B[D+2],w),u[v+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[v+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[v+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function m(E,v,x,C,I,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[v+0]=C,l[v+1]=I,l[v+2]=_+w*a.delta;const D=E+a.zd*3;c[v+0]=h(B[E+0],B[D+0],w),c[v+1]=h(B[E+1],B[D+1],w),c[v+2]=h(B[E+2],B[D+2],w),u[v+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[v+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[v+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function A(E){const v=E*3;a.normal_cache[v]===0&&(a.normal_cache[v+0]=a.field[E-1]-a.field[E+1],a.normal_cache[v+1]=a.field[E-a.yd]-a.field[E+a.yd],a.normal_cache[v+2]=a.field[E-a.zd]-a.field[E+a.zd])}function p(E,v,x,C,I){const _=C+1,S=C+a.yd,b=C+a.zd,T=_+a.yd,R=_+a.zd,w=C+a.yd+a.zd,B=_+a.yd+a.zd;let D=0;const k=a.field[C],Q=a.field[_],Y=a.field[S],W=a.field[T],P=a.field[b],K=a.field[R],M=a.field[w],V=a.field[B];k<I&&(D|=1),Q<I&&(D|=2),Y<I&&(D|=8),W<I&&(D|=4),P<I&&(D|=16),K<I&&(D|=32),M<I&&(D|=128),V<I&&(D|=64);const $=v_[D];if($===0)return 0;const G=a.delta,O=E+G,F=v+G,U=x+G;$&1&&(A(C),A(_),f(C*3,0,I,E,v,x,k,Q,C,_)),$&2&&(A(_),A(T),d(_*3,3,I,O,v,x,Q,W,_,T)),$&4&&(A(S),A(T),f(S*3,6,I,E,F,x,Y,W,S,T)),$&8&&(A(C),A(S),d(C*3,9,I,E,v,x,k,Y,C,S)),$&16&&(A(b),A(R),f(b*3,12,I,E,v,U,P,K,b,R)),$&32&&(A(R),A(B),d(R*3,15,I,O,v,U,K,V,R,B)),$&64&&(A(w),A(B),f(w*3,18,I,E,F,U,M,V,w,B)),$&128&&(A(b),A(w),d(b*3,21,I,E,v,U,P,M,b,w)),$&256&&(A(C),A(b),m(C*3,24,I,E,v,x,k,P,C,b)),$&512&&(A(_),A(R),m(_*3,27,I,O,v,x,Q,K,_,R)),$&1024&&(A(T),A(B),m(T*3,30,I,O,F,x,W,V,T,B)),$&2048&&(A(S),A(w),m(S*3,33,I,E,F,x,Y,M,S,w)),D<<=4;let N,Z,ie,q=0,ne=0;for(;rc[D+ne]!=-1;)N=D+ne,Z=N+1,ie=N+2,y(l,c,u,3*rc[N],3*rc[Z],3*rc[ie]),ne+=3,q++;return q}function y(E,v,x,C,I,_){const S=a.count*3;if(a.positionArray[S+0]=E[C],a.positionArray[S+1]=E[C+1],a.positionArray[S+2]=E[C+2],a.positionArray[S+3]=E[I],a.positionArray[S+4]=E[I+1],a.positionArray[S+5]=E[I+2],a.positionArray[S+6]=E[_],a.positionArray[S+7]=E[_+1],a.positionArray[S+8]=E[_+2],a.material.flatShading===!0){const b=(v[C+0]+v[I+0]+v[_+0])/3,T=(v[C+1]+v[I+1]+v[_+1])/3,R=(v[C+2]+v[I+2]+v[_+2])/3;a.normalArray[S+0]=b,a.normalArray[S+1]=T,a.normalArray[S+2]=R,a.normalArray[S+3]=b,a.normalArray[S+4]=T,a.normalArray[S+5]=R,a.normalArray[S+6]=b,a.normalArray[S+7]=T,a.normalArray[S+8]=R}else a.normalArray[S+0]=v[C+0],a.normalArray[S+1]=v[C+1],a.normalArray[S+2]=v[C+2],a.normalArray[S+3]=v[I+0],a.normalArray[S+4]=v[I+1],a.normalArray[S+5]=v[I+2],a.normalArray[S+6]=v[_+0],a.normalArray[S+7]=v[_+1],a.normalArray[S+8]=v[_+2];if(a.enableUvs){const b=a.count*2;a.uvArray[b+0]=E[C+0],a.uvArray[b+1]=E[C+2],a.uvArray[b+2]=E[I+0],a.uvArray[b+3]=E[I+2],a.uvArray[b+4]=E[_+0],a.uvArray[b+5]=E[_+2]}a.enableColors&&(a.colorArray[S+0]=x[C+0],a.colorArray[S+1]=x[C+1],a.colorArray[S+2]=x[C+2],a.colorArray[S+3]=x[I+0],a.colorArray[S+4]=x[I+1],a.colorArray[S+5]=x[I+2],a.colorArray[S+6]=x[_+0],a.colorArray[S+7]=x[_+1],a.colorArray[S+8]=x[_+2]),a.count+=3}this.addBall=function(E,v,x,C,I,_){const S=Math.sign(C);C=Math.abs(C);const b=_!=null;let T=new Ye(E,v,x);if(b)try{T=_ instanceof Ye?_:Array.isArray(_)?new Ye(Math.min(Math.abs(_[0]),1),Math.min(Math.abs(_[1]),1),Math.min(Math.abs(_[2]),1)):new Ye(_)}catch{T=new Ye(E,v,x)}const R=this.size*Math.sqrt(C/I),w=x*this.size,B=v*this.size,D=E*this.size;let k=Math.floor(w-R);k<1&&(k=1);let Q=Math.floor(w+R);Q>this.size-1&&(Q=this.size-1);let Y=Math.floor(B-R);Y<1&&(Y=1);let W=Math.floor(B+R);W>this.size-1&&(W=this.size-1);let P=Math.floor(D-R);P<1&&(P=1);let K=Math.floor(D+R);K>this.size-1&&(K=this.size-1);let M,V,$,G,O,F,U,N,Z,ie,q;for($=k;$<Q;$++)for(O=this.size2*$,N=$/this.size-x,Z=N*N,V=Y;V<W;V++)for(G=O+this.size*V,U=V/this.size-v,ie=U*U,M=P;M<K;M++)if(F=M/this.size-E,q=C/(1e-6+F*F+ie+Z)-I,q>0){this.field[G+M]+=q*S;const ne=Math.sqrt((M-D)*(M-D)+(V-B)*(V-B)+($-w)*($-w))/R,ye=1-ne*ne*ne*(ne*(ne*6-15)+10);this.palette[(G+M)*3+0]+=T.r*ye,this.palette[(G+M)*3+1]+=T.g*ye,this.palette[(G+M)*3+2]+=T.b*ye}},this.addPlaneX=function(E,v){const x=this.size,C=this.yd,I=this.zd,_=this.field;let S,b,T,R,w,B,D,k=x*Math.sqrt(E/v);for(k>x&&(k=x),S=0;S<k;S++)if(B=S/x,R=B*B,w=E/(1e-4+R)-v,w>0)for(b=0;b<x;b++)for(D=S+b*C,T=0;T<x;T++)_[I*T+D]+=w},this.addPlaneY=function(E,v){const x=this.size,C=this.yd,I=this.zd,_=this.field;let S,b,T,R,w,B,D,k,Q=x*Math.sqrt(E/v);for(Q>x&&(Q=x),b=0;b<Q;b++)if(B=b/x,R=B*B,w=E/(1e-4+R)-v,w>0)for(D=b*C,S=0;S<x;S++)for(k=D+S,T=0;T<x;T++)_[I*T+k]+=w},this.addPlaneZ=function(E,v){const x=this.size,C=this.yd,I=this.zd,_=this.field;let S,b,T,R,w,B,D,k,Q=x*Math.sqrt(E/v);for(Q>x&&(Q=x),T=0;T<Q;T++)if(B=T/x,R=B*B,w=E/(1e-4+R)-v,w>0)for(D=I*T,b=0;b<x;b++)for(k=D+b*C,S=0;S<x;S++)_[k+S]+=w},this.setCell=function(E,v,x,C){const I=this.size2*x+this.size*v+E;this.field[I]=C},this.getCell=function(E,v,x){const C=this.size2*x+this.size*v+E;return this.field[C]},this.blur=function(E=1){const v=this.field,x=v.slice(),C=this.size,I=this.size2;for(let _=0;_<C;_++)for(let S=0;S<C;S++)for(let b=0;b<C;b++){const T=I*b+C*S+_;let R=x[T],w=1;for(let B=-1;B<=1;B+=2){const D=B+_;if(!(D<0||D>=C))for(let k=-1;k<=1;k+=2){const Q=k+S;if(!(Q<0||Q>=C))for(let Y=-1;Y<=1;Y+=2){const W=Y+b;if(W<0||W>=C)continue;const P=I*W+C*Q+D,K=x[P];w++,R+=E*(K-R)/w}}}v[T]=R}},this.reset=function(){for(let E=0;E<this.size3;E++)this.normal_cache[E*3]=0,this.field[E]=0,this.palette[E*3]=this.palette[E*3+1]=this.palette[E*3+2]=0},this.update=function(){this.count=0;const E=this.size-2;for(let v=1;v<E;v++){const x=this.size2*v,C=(v-this.halfsize)/this.halfsize;for(let I=1;I<E;I++){const _=x+this.size*I,S=(I-this.halfsize)/this.halfsize;for(let b=1;b<E;b++){const T=(b-this.halfsize)/this.halfsize,R=_+b;p(T,S,C,R,this.isolation)}}}this.geometry.setDrawRange(0,this.count),o.getAttribute("position").needsUpdate=!0,o.getAttribute("normal").needsUpdate=!0,this.enableUvs&&(o.getAttribute("uv").needsUpdate=!0),this.enableColors&&(o.getAttribute("color").needsUpdate=!0),this.count/3>s&&console.warn("THREE.MarchingCubes: Geometry buffers too small for rendering. Please create an instance with a higher poly count.")},this.init(e)}};const v_=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),rc=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]);var E_=Object.defineProperty,x_=(r,e,t)=>e in r?E_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,os=(r,e,t)=>(x_(r,typeof e!="symbol"?e+"":e,t),t);class kh{constructor(e=Math){os(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),os(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),os(this,"p",[]),os(this,"perm",[]),os(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),os(this,"dot",(t,i,n)=>t[0]*i+t[1]*n),os(this,"dot3",(t,i,n,s)=>t[0]*i+t[1]*n+t[2]*s),os(this,"dot4",(t,i,n,s,o)=>t[0]*i+t[1]*n+t[2]*s+t[3]*o),os(this,"noise",(t,i)=>{let n,s,o;const a=.5*(Math.sqrt(3)-1),l=(t+i)*a,c=Math.floor(t+l),u=Math.floor(i+l),h=(3-Math.sqrt(3))/6,f=(c+u)*h,d=c-f,m=u-f,A=t-d,p=i-m;let y=0,E=1;A>p&&(y=1,E=0);const v=A-y+h,x=p-E+h,C=A-1+2*h,I=p-1+2*h,_=c&255,S=u&255,b=this.perm[_+this.perm[S]]%12,T=this.perm[_+y+this.perm[S+E]]%12,R=this.perm[_+1+this.perm[S+1]]%12;let w=.5-A*A-p*p;w<0?n=0:(w*=w,n=w*w*this.dot(this.grad3[b],A,p));let B=.5-v*v-x*x;B<0?s=0:(B*=B,s=B*B*this.dot(this.grad3[T],v,x));let D=.5-C*C-I*I;return D<0?o=0:(D*=D,o=D*D*this.dot(this.grad3[R],C,I)),70*(n+s+o)}),os(this,"noise3d",(t,i,n)=>{let s,o,a,l;const c=.3333333333333333,u=(t+i+n)*c,h=Math.floor(t+u),f=Math.floor(i+u),d=Math.floor(n+u),m=1/6,A=(h+f+d)*m,p=h-A,y=f-A,E=d-A,v=t-p,x=i-y,C=n-E;let I,_,S,b,T,R;v>=x?x>=C?(I=1,_=0,S=0,b=1,T=1,R=0):v>=C?(I=1,_=0,S=0,b=1,T=0,R=1):(I=0,_=0,S=1,b=1,T=0,R=1):x<C?(I=0,_=0,S=1,b=0,T=1,R=1):v<C?(I=0,_=1,S=0,b=0,T=1,R=1):(I=0,_=1,S=0,b=1,T=1,R=0);const w=v-I+m,B=x-_+m,D=C-S+m,k=v-b+2*m,Q=x-T+2*m,Y=C-R+2*m,W=v-1+3*m,P=x-1+3*m,K=C-1+3*m,M=h&255,V=f&255,$=d&255,G=this.perm[M+this.perm[V+this.perm[$]]]%12,O=this.perm[M+I+this.perm[V+_+this.perm[$+S]]]%12,F=this.perm[M+b+this.perm[V+T+this.perm[$+R]]]%12,U=this.perm[M+1+this.perm[V+1+this.perm[$+1]]]%12;let N=.6-v*v-x*x-C*C;N<0?s=0:(N*=N,s=N*N*this.dot3(this.grad3[G],v,x,C));let Z=.6-w*w-B*B-D*D;Z<0?o=0:(Z*=Z,o=Z*Z*this.dot3(this.grad3[O],w,B,D));let ie=.6-k*k-Q*Q-Y*Y;ie<0?a=0:(ie*=ie,a=ie*ie*this.dot3(this.grad3[F],k,Q,Y));let q=.6-W*W-P*P-K*K;return q<0?l=0:(q*=q,l=q*q*this.dot3(this.grad3[U],W,P,K)),32*(s+o+a+l)}),os(this,"noise4d",(t,i,n,s)=>{const o=this.grad4,a=this.simplex,l=this.perm,c=(Math.sqrt(5)-1)/4,u=(5-Math.sqrt(5))/20;let h,f,d,m,A;const p=(t+i+n+s)*c,y=Math.floor(t+p),E=Math.floor(i+p),v=Math.floor(n+p),x=Math.floor(s+p),C=(y+E+v+x)*u,I=y-C,_=E-C,S=v-C,b=x-C,T=t-I,R=i-_,w=n-S,B=s-b,D=T>R?32:0,k=T>w?16:0,Q=R>w?8:0,Y=T>B?4:0,W=R>B?2:0,P=w>B?1:0,K=D+k+Q+Y+W+P;let M,V,$,G,O,F,U,N,Z,ie,q,ne;M=a[K][0]>=3?1:0,V=a[K][1]>=3?1:0,$=a[K][2]>=3?1:0,G=a[K][3]>=3?1:0,O=a[K][0]>=2?1:0,F=a[K][1]>=2?1:0,U=a[K][2]>=2?1:0,N=a[K][3]>=2?1:0,Z=a[K][0]>=1?1:0,ie=a[K][1]>=1?1:0,q=a[K][2]>=1?1:0,ne=a[K][3]>=1?1:0;const ye=T-M+u,ve=R-V+u,re=w-$+u,se=B-G+u,he=T-O+2*u,ae=R-F+2*u,J=w-U+2*u,X=B-N+2*u,oe=T-Z+3*u,Ce=R-ie+3*u,_e=w-q+3*u,Be=B-ne+3*u,Se=T-1+4*u,Ve=R-1+4*u,Me=w-1+4*u,Ne=B-1+4*u,Ge=y&255,je=E&255,st=v&255,At=x&255,it=l[Ge+l[je+l[st+l[At]]]]%32,Xe=l[Ge+M+l[je+V+l[st+$+l[At+G]]]]%32,We=l[Ge+O+l[je+F+l[st+U+l[At+N]]]]%32,te=l[Ge+Z+l[je+ie+l[st+q+l[At+ne]]]]%32,Te=l[Ge+1+l[je+1+l[st+1+l[At+1]]]]%32;let Le=.6-T*T-R*R-w*w-B*B;Le<0?h=0:(Le*=Le,h=Le*Le*this.dot4(o[it],T,R,w,B));let Ke=.6-ye*ye-ve*ve-re*re-se*se;Ke<0?f=0:(Ke*=Ke,f=Ke*Ke*this.dot4(o[Xe],ye,ve,re,se));let pe=.6-he*he-ae*ae-J*J-X*X;pe<0?d=0:(pe*=pe,d=pe*pe*this.dot4(o[We],he,ae,J,X));let ot=.6-oe*oe-Ce*Ce-_e*_e-Be*Be;ot<0?m=0:(ot*=ot,m=ot*ot*this.dot4(o[te],oe,Ce,_e,Be));let qt=.6-Se*Se-Ve*Ve-Me*Me-Ne*Ne;return qt<0?A=0:(qt*=qt,A=qt*qt*this.dot4(o[Te],Se,Ve,Me,Ne)),27*(h+f+d+m+A)});for(let t=0;t<256;t++)this.p[t]=Math.floor(e.random()*256);for(let t=0;t<512;t++)this.perm[t]=this.p[t&255]}}var C_=Object.defineProperty,I_=(r,e,t)=>e in r?C_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,qA=(r,e,t)=>(I_(r,typeof e!="symbol"?e+"":e,t),t);const __=(()=>{const r={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new z},up:{value:new z(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${pa>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},e=new gi({name:"SkyShader",fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:la.clone(r.uniforms),side:ma,depthWrite:!1});class t extends Qe{constructor(){super(new pr(1,1,1),e)}}return qA(t,"SkyShader",r),qA(t,"material",e),t})(),S_=r=>r&&r.isCubeTexture;class T_ extends Qe{constructor(e,t){var i,n;const s=S_(e),a=((n=s?(i=e.image[0])==null?void 0:i.width:e.image.width)!=null?n:1024)/4,l=Math.floor(Math.log2(a)),c=Math.pow(2,l),u=3*Math.max(c,16*7),h=4*c,f=[s?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/u}`,`#define CUBEUV_TEXEL_HEIGHT ${1/h}`,`#define CUBEUV_MAX_MIP ${l}.0`],d=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,m=f.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${pa>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,A={map:{value:e},height:{value:(t==null?void 0:t.height)||15},radius:{value:(t==null?void 0:t.radius)||100}},p=new _x(1,16),y=new gi({uniforms:A,fragmentShader:m,vertexShader:d,side:xi});super(p,y)}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}function V2(r,e,t={}){const i=new z,n=new nt,s=new z,o=new we,a=new we,l=new we;t.preserveMatrix=t.preserveMatrix!==void 0?t.preserveMatrix:!0,t.preservePosition=t.preservePosition!==void 0?t.preservePosition:!0,t.preserveHipPosition=t.preserveHipPosition!==void 0?t.preserveHipPosition:!1,t.useTargetMatrix=t.useTargetMatrix!==void 0?t.useTargetMatrix:!1,t.hip=t.hip!==void 0?t.hip:"hip",t.names=t.names||{};const c=e.isObject3D?e.skeleton.bones:Mu(e),u=r.isObject3D?r.skeleton.bones:Mu(r);let h,f,d,m,A;if(r.isObject3D?r.skeleton.pose():(t.useTargetMatrix=!0,t.preserveMatrix=!1),t.preservePosition){A=[];for(let p=0;p<u.length;p++)A.push(u[p].position.clone())}if(t.preserveMatrix){r.updateMatrixWorld(),r.matrixWorld.identity();for(let p=0;p<r.children.length;++p)r.children[p].updateMatrixWorld(!0)}if(t.offsets){h=[];for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,t.offsets[d]&&(f.matrix.multiply(t.offsets[d]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),h.push(f.matrixWorld.clone())}for(let p=0;p<u.length;++p){if(f=u[p],d=t.names[f.name]||f.name,m=K2(d,c),l.copy(f.matrixWorld),m){if(m.updateMatrixWorld(),t.useTargetMatrix?a.copy(m.matrixWorld):(a.copy(r.matrixWorld).invert(),a.multiply(m.matrixWorld)),s.setFromMatrixScale(a),a.scale(s.set(1/s.x,1/s.y,1/s.z)),l.makeRotationFromQuaternion(n.setFromRotationMatrix(a)),r.isObject3D){const y=u.indexOf(f),E=h?h[y]:o.copy(r.skeleton.boneInverses[y]).invert();l.multiply(E)}l.copyPosition(a)}f.parent&&f.parent.isBone?(f.matrix.copy(f.parent.matrixWorld).invert(),f.matrix.multiply(l)):f.matrix.copy(l),t.preserveHipPosition&&d===t.hip&&f.matrix.setPosition(i.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(t.preservePosition)for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,d!==t.hip&&f.position.copy(A[p]);t.preserveMatrix&&r.updateMatrixWorld(!0)}function b_(r,e,t,i={}){i.useFirstFramePosition=i.useFirstFramePosition!==void 0?i.useFirstFramePosition:!1,i.fps=i.fps!==void 0?i.fps:30,i.names=i.names||[],e.isObject3D||(e=B_(e));const n=Math.round(t.duration*(i.fps/1e3)*1e3),s=1/i.fps,o=[],a=new zy(e),l=Mu(r.skeleton),c=[];let u,h,f,d,m;a.clipAction(t).play(),a.update(0),e.updateMatrixWorld();for(let A=0;A<n;++A){const p=A*s;V2(r,e,i);for(let y=0;y<l.length;++y)m=i.names[l[y].name]||l[y].name,f=K2(m,e.skeleton),f&&(h=l[y],d=c[y]=c[y]||{bone:h},i.hip===m&&(d.pos||(d.pos={times:new Float32Array(n),values:new Float32Array(n*3)}),i.useFirstFramePosition&&(A===0&&(u=h.position.clone()),h.position.sub(u)),d.pos.times[A]=p,h.position.toArray(d.pos.values,A*3)),d.quat||(d.quat={times:new Float32Array(n),values:new Float32Array(n*4)}),d.quat.times[A]=p,h.quaternion.toArray(d.quat.values,A*4));a.update(s),e.updateMatrixWorld()}for(let A=0;A<c.length;++A)d=c[A],d&&(d.pos&&o.push(new Su(".bones["+d.bone.name+"].position",d.pos.times,d.pos.values)),o.push(new Tu(".bones["+d.bone.name+"].quaternion",d.quat.times,d.quat.values)));return a.uncacheAction(t),new S0(t.name,-1,o)}function w_(r){const e=new Map,t=new Map,i=r.clone();return $2(r,i,function(n,s){e.set(s,n),t.set(n,s)}),i.traverse(function(n){if(!n.isSkinnedMesh)return;const s=n,o=e.get(n),a=o.skeleton.bones;s.skeleton=o.skeleton.clone(),s.bindMatrix.copy(o.bindMatrix),s.skeleton.bones=a.map(function(l){return t.get(l)}),s.bind(s.skeleton,s.bindMatrix)}),i}function K2(r,e){for(let t=0,i=Mu(e);t<i.length;t++)if(r===i[t].name)return i[t]}function Mu(r){return Array.isArray(r)?r:r.bones}function B_(r){const e=new Sx(r.bones[0]);return e.skeleton=r,e}function $2(r,e,t){t(r,e);for(let i=0;i<r.children.length;i++)$2(r.children[i],e.children[i],t)}const R_={retarget:V2,retargetClip:b_,clone:w_},Ki=new Wr,oc=new z;class D_{constructor(e){let t=e.geometry;t.index&&(console.warn("THREE.MeshSurfaceSampler: Converting geometry to non-indexed BufferGeometry."),t=t.toNonIndexed()),this.geometry=t,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.colorAttribute=this.geometry.getAttribute("color"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(e){return this.weightAttribute=e?this.geometry.getAttribute(e):null,this}build(){const e=this.positionAttribute,t=this.weightAttribute,i=new Float32Array(e.count/3);for(let s=0;s<e.count;s+=3){let o=1;t&&(o=t.getX(s)+t.getX(s+1)+t.getX(s+2)),Ki.a.fromBufferAttribute(e,s),Ki.b.fromBufferAttribute(e,s+1),Ki.c.fromBufferAttribute(e,s+2),o*=Ki.getArea(),i[s/3]=o}this.distribution=new Float32Array(e.count/3);let n=0;for(let s=0;s<i.length;s++)n+=i[s],this.distribution[s]=n;return this}setRandomGenerator(e){return this.randomFunction=e,this}sample(e,t,i){const n=this.sampleFaceIndex();return this.sampleFace(n,e,t,i)}sampleFaceIndex(){const e=this.distribution[this.distribution.length-1];return this.binarySearch(this.randomFunction()*e)}binarySearch(e){const t=this.distribution;let i=0,n=t.length-1,s=-1;for(;i<=n;){const o=Math.ceil((i+n)/2);if(o===0||t[o-1]<=e&&t[o]>e){s=o;break}else e<t[o]?n=o-1:i=o+1}return s}sampleFace(e,t,i,n){let s=this.randomFunction(),o=this.randomFunction();return s+o>1&&(s=1-s,o=1-o),Ki.a.fromBufferAttribute(this.positionAttribute,e*3),Ki.b.fromBufferAttribute(this.positionAttribute,e*3+1),Ki.c.fromBufferAttribute(this.positionAttribute,e*3+2),t.set(0,0,0).addScaledVector(Ki.a,s).addScaledVector(Ki.b,o).addScaledVector(Ki.c,1-(s+o)),i!==void 0&&Ki.getNormal(i),n!==void 0&&this.colorAttribute!==void 0&&(Ki.a.fromBufferAttribute(this.colorAttribute,e*3),Ki.b.fromBufferAttribute(this.colorAttribute,e*3+1),Ki.c.fromBufferAttribute(this.colorAttribute,e*3+2),oc.set(0,0,0).addScaledVector(Ki.a,s).addScaledVector(Ki.b,o).addScaledVector(Ki.c,1-(s+o)),n.r=oc.x,n.g=oc.y,n.b=oc.z),this}}var M_=Object.defineProperty,L_=(r,e,t)=>e in r?M_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,P_=(r,e,t)=>(L_(r,typeof e!="symbol"?e+"":e,t),t);let oo=class{constructor(){P_(this,"_listeners")}addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const n=this._listeners[e];if(n!==void 0){const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=i.slice(0);for(let s=0,o=n.length;s<o;s++)n[s].call(this,e);e.target=null}}};var F_=Object.defineProperty,k_=(r,e,t)=>e in r?F_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,dt=(r,e,t)=>(k_(r,typeof e!="symbol"?e+"":e,t),t);const JA=new z;let O_=class extends oo{constructor(e,t){super(),dt(this,"object"),dt(this,"domElement"),dt(this,"enabled",!0),dt(this,"movementSpeed",1),dt(this,"lookSpeed",.005),dt(this,"lookVertical",!0),dt(this,"autoForward",!1),dt(this,"activeLook",!0),dt(this,"heightSpeed",!1),dt(this,"heightCoef",1),dt(this,"heightMin",0),dt(this,"heightMax",1),dt(this,"constrainVertical",!1),dt(this,"verticalMin",0),dt(this,"verticalMax",Math.PI),dt(this,"mouseDragOn",!1),dt(this,"autoSpeedFactor",0),dt(this,"mouseX",0),dt(this,"mouseY",0),dt(this,"moveForward",!1),dt(this,"moveBackward",!1),dt(this,"moveLeft",!1),dt(this,"moveRight",!1),dt(this,"moveUp",!1),dt(this,"moveDown",!1),dt(this,"viewHalfX",0),dt(this,"viewHalfY",0),dt(this,"lat",0),dt(this,"lon",0),dt(this,"lookDirection",new z),dt(this,"spherical",new aa),dt(this,"target",new z),dt(this,"connect",i=>{i.setAttribute("tabindex","-1"),i.style.touchAction="none",i.addEventListener("contextmenu",this.contextmenu),i.addEventListener("mousemove",this.onMouseMove),i.addEventListener("mousedown",this.onMouseDown),i.addEventListener("mouseup",this.onMouseUp),this.domElement=i,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()}),dt(this,"dispose",()=>{var i,n,s,o;(i=this.domElement)==null||i.removeEventListener("contextmenu",this.contextmenu),(n=this.domElement)==null||n.removeEventListener("mousedown",this.onMouseDown),(s=this.domElement)==null||s.removeEventListener("mousemove",this.onMouseMove),(o=this.domElement)==null||o.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}),dt(this,"handleResize",()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}),dt(this,"onMouseDown",i=>{var n;if((n=this.domElement)==null||n.focus(),this.activeLook)switch(i.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0;break}this.mouseDragOn=!0}),dt(this,"onMouseUp",i=>{if(this.activeLook)switch(i.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1;break}this.mouseDragOn=!1}),dt(this,"onMouseMove",i=>{this.domElement&&(this.mouseX=i.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=i.pageY-this.domElement.offsetTop-this.viewHalfY)}),dt(this,"onKeyDown",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0;break}}),dt(this,"onKeyUp",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1;break}}),dt(this,"lookAt",(i,n,s)=>(i instanceof z?this.target.copy(i):n&&s&&this.target.set(i,n,s),this.object.lookAt(this.target),this.setOrientation(),this)),dt(this,"update",i=>{if(!this.enabled)return;if(this.heightSpeed){const h=et.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=i*(h*this.heightCoef)}else this.autoSpeedFactor=0;const n=i*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(n+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(n),this.moveLeft&&this.object.translateX(-n),this.moveRight&&this.object.translateX(n),this.moveUp&&this.object.translateY(n),this.moveDown&&this.object.translateY(-n);let s=i*this.lookSpeed;this.activeLook||(s=0);let o=1;this.constrainVertical&&(o=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*s,this.lookVertical&&(this.lat-=this.mouseY*s*o),this.lat=Math.max(-85,Math.min(85,this.lat));let a=et.degToRad(90-this.lat);const l=et.degToRad(this.lon);this.constrainVertical&&(a=et.mapLinear(a,0,Math.PI,this.verticalMin,this.verticalMax));const c=this.object.position;JA.setFromSphericalCoords(1,a,l).add(c),this.object.lookAt(JA)}),dt(this,"contextmenu",i=>i.preventDefault()),dt(this,"setOrientation",()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-et.radToDeg(this.spherical.phi),this.lon=et.radToDeg(this.spherical.theta)}),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}};var U_=Object.defineProperty,N_=(r,e,t)=>e in r?U_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ie=(r,e,t)=>(N_(r,typeof e!="symbol"?e+"":e,t),t);let G_=class extends mi{constructor(e,t){super(),Ie(this,"isTransformControls",!0),Ie(this,"visible",!1),Ie(this,"domElement"),Ie(this,"raycaster",new Ku),Ie(this,"gizmo"),Ie(this,"plane"),Ie(this,"tempVector",new z),Ie(this,"tempVector2",new z),Ie(this,"tempQuaternion",new nt),Ie(this,"unit",{X:new z(1,0,0),Y:new z(0,1,0),Z:new z(0,0,1)}),Ie(this,"pointStart",new z),Ie(this,"pointEnd",new z),Ie(this,"offset",new z),Ie(this,"rotationAxis",new z),Ie(this,"startNorm",new z),Ie(this,"endNorm",new z),Ie(this,"rotationAngle",0),Ie(this,"cameraPosition",new z),Ie(this,"cameraQuaternion",new nt),Ie(this,"cameraScale",new z),Ie(this,"parentPosition",new z),Ie(this,"parentQuaternion",new nt),Ie(this,"parentQuaternionInv",new nt),Ie(this,"parentScale",new z),Ie(this,"worldPositionStart",new z),Ie(this,"worldQuaternionStart",new nt),Ie(this,"worldScaleStart",new z),Ie(this,"worldPosition",new z),Ie(this,"worldQuaternion",new nt),Ie(this,"worldQuaternionInv",new nt),Ie(this,"worldScale",new z),Ie(this,"eye",new z),Ie(this,"positionStart",new z),Ie(this,"quaternionStart",new nt),Ie(this,"scaleStart",new z),Ie(this,"camera"),Ie(this,"object"),Ie(this,"enabled",!0),Ie(this,"axis",null),Ie(this,"mode","translate"),Ie(this,"translationSnap",null),Ie(this,"rotationSnap",null),Ie(this,"scaleSnap",null),Ie(this,"space","world"),Ie(this,"size",1),Ie(this,"dragging",!1),Ie(this,"showX",!0),Ie(this,"showY",!0),Ie(this,"showZ",!0),Ie(this,"changeEvent",{type:"change"}),Ie(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),Ie(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),Ie(this,"objectChangeEvent",{type:"objectChange"}),Ie(this,"intersectObjectWithRay",(n,s,o)=>{const a=s.intersectObject(n,!0);for(let l=0;l<a.length;l++)if(a[l].object.visible||o)return a[l];return!1}),Ie(this,"attach",n=>(this.object=n,this.visible=!0,this)),Ie(this,"detach",()=>(this.object=void 0,this.visible=!1,this.axis=null,this)),Ie(this,"reset",()=>this.enabled?(this.dragging&&this.object!==void 0&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this),Ie(this,"updateMatrixWorld",()=>{this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()}),Ie(this,"pointerHover",n=>{if(this.object===void 0||this.dragging===!0)return;this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);s?this.axis=s.object.name:this.axis=null}),Ie(this,"pointerDown",n=>{if(!(this.object===void 0||this.dragging===!0||n.button!==0)&&this.axis!==null){this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(s){let o=this.space;if(this.mode==="scale"?o="local":(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ")&&(o="world"),o==="local"&&this.mode==="rotate"){const a=this.rotationSnap;this.axis==="X"&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),this.axis==="Y"&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),this.axis==="Z"&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(s.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}}),Ie(this,"pointerMove",n=>{const s=this.axis,o=this.mode,a=this.object;let l=this.space;if(o==="scale"?l="local":(s==="E"||s==="XYZE"||s==="XYZ")&&(l="world"),a===void 0||s===null||this.dragging===!1||n.button!==-1)return;this.raycaster.setFromCamera(n,this.camera);const c=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(c){if(this.pointEnd.copy(c.point).sub(this.worldPositionStart),o==="translate")this.offset.copy(this.pointEnd).sub(this.pointStart),l==="local"&&s!=="XYZ"&&this.offset.applyQuaternion(this.worldQuaternionInv),s.indexOf("X")===-1&&(this.offset.x=0),s.indexOf("Y")===-1&&(this.offset.y=0),s.indexOf("Z")===-1&&(this.offset.z=0),l==="local"&&s!=="XYZ"?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),a.position.copy(this.offset).add(this.positionStart),this.translationSnap&&(l==="local"&&(a.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this.quaternionStart)),l==="world"&&(a.parent&&a.position.add(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld)),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld))));else if(o==="scale"){if(s.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),this.tempVector2.set(u,u,u)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),s.search("X")===-1&&(this.tempVector2.x=1),s.search("Y")===-1&&(this.tempVector2.y=1),s.search("Z")===-1&&(this.tempVector2.z=1);a.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(s.search("X")!==-1&&(this.object.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(o==="rotate"){this.offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));s==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):s==="XYZE"?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*u):(s==="X"||s==="Y"||s==="Z")&&(this.rotationAxis.copy(this.unit[s]),this.tempVector.copy(this.unit[s]),l==="local"&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*u),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),l==="local"&&s!=="E"&&s!=="XYZE"?(a.quaternion.copy(this.quaternionStart),a.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),a.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}}),Ie(this,"pointerUp",n=>{n.button===0&&(this.dragging&&this.axis!==null&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)}),Ie(this,"getPointer",n=>{var s;if(this.domElement&&((s=this.domElement.ownerDocument)!=null&&s.pointerLockElement))return{x:0,y:0,button:n.button};{const o=n.changedTouches?n.changedTouches[0]:n,a=this.domElement.getBoundingClientRect();return{x:(o.clientX-a.left)/a.width*2-1,y:-(o.clientY-a.top)/a.height*2+1,button:n.button}}}),Ie(this,"onPointerHover",n=>{if(this.enabled)switch(n.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(n));break}}),Ie(this,"onPointerDown",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(n)),this.pointerDown(this.getPointer(n)))}),Ie(this,"onPointerMove",n=>{this.enabled&&this.pointerMove(this.getPointer(n))}),Ie(this,"onPointerUp",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(n)))}),Ie(this,"getMode",()=>this.mode),Ie(this,"setMode",n=>{this.mode=n}),Ie(this,"setTranslationSnap",n=>{this.translationSnap=n}),Ie(this,"setRotationSnap",n=>{this.rotationSnap=n}),Ie(this,"setScaleSnap",n=>{this.scaleSnap=n}),Ie(this,"setSize",n=>{this.size=n}),Ie(this,"setSpace",n=>{this.space=n}),Ie(this,"update",()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}),Ie(this,"connect",n=>{n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)}),Ie(this,"dispose",()=>{var n,s,o,a,l,c;(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointermove",this.onPointerHover),(a=(o=this.domElement)==null?void 0:o.ownerDocument)==null||a.removeEventListener("pointermove",this.onPointerMove),(c=(l=this.domElement)==null?void 0:l.ownerDocument)==null||c.removeEventListener("pointerup",this.onPointerUp),this.traverse(u=>{const h=u;h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()})}),this.domElement=t,this.camera=e,this.gizmo=new Q_,this.add(this.gizmo),this.plane=new z_,this.add(this.plane);const i=(n,s)=>{let o=s;Object.defineProperty(this,n,{get:function(){return o!==void 0?o:s},set:function(a){o!==a&&(o=a,this.plane[n]=a,this.gizmo[n]=a,this.dispatchEvent({type:n+"-changed",value:a}),this.dispatchEvent(this.changeEvent))}}),this[n]=s,this.plane[n]=s,this.gizmo[n]=s};i("camera",this.camera),i("object",this.object),i("enabled",this.enabled),i("axis",this.axis),i("mode",this.mode),i("translationSnap",this.translationSnap),i("rotationSnap",this.rotationSnap),i("scaleSnap",this.scaleSnap),i("space",this.space),i("size",this.size),i("dragging",this.dragging),i("showX",this.showX),i("showY",this.showY),i("showZ",this.showZ),i("worldPosition",this.worldPosition),i("worldPositionStart",this.worldPositionStart),i("worldQuaternion",this.worldQuaternion),i("worldQuaternionStart",this.worldQuaternionStart),i("cameraPosition",this.cameraPosition),i("cameraQuaternion",this.cameraQuaternion),i("pointStart",this.pointStart),i("pointEnd",this.pointEnd),i("rotationAxis",this.rotationAxis),i("rotationAngle",this.rotationAngle),i("eye",this.eye),t!==void 0&&this.connect(t)}};class Q_ extends mi{constructor(){super(),Ie(this,"isTransformControlsGizmo",!0),Ie(this,"type","TransformControlsGizmo"),Ie(this,"tempVector",new z(0,0,0)),Ie(this,"tempEuler",new wn),Ie(this,"alignVector",new z(0,1,0)),Ie(this,"zeroVector",new z(0,0,0)),Ie(this,"lookAtMatrix",new we),Ie(this,"tempQuaternion",new nt),Ie(this,"tempQuaternion2",new nt),Ie(this,"identityQuaternion",new nt),Ie(this,"unitX",new z(1,0,0)),Ie(this,"unitY",new z(0,1,0)),Ie(this,"unitZ",new z(0,0,1)),Ie(this,"gizmo"),Ie(this,"picker"),Ie(this,"helper"),Ie(this,"rotationAxis",new z),Ie(this,"cameraPosition",new z),Ie(this,"worldPositionStart",new z),Ie(this,"worldQuaternionStart",new nt),Ie(this,"worldPosition",new z),Ie(this,"worldQuaternion",new nt),Ie(this,"eye",new z),Ie(this,"camera",null),Ie(this,"enabled",!0),Ie(this,"axis",null),Ie(this,"mode","translate"),Ie(this,"space","world"),Ie(this,"size",1),Ie(this,"dragging",!1),Ie(this,"showX",!0),Ie(this,"showY",!0),Ie(this,"showZ",!0),Ie(this,"updateMatrixWorld",()=>{let K=this.space;this.mode==="scale"&&(K="local");const M=K==="local"?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let V=[];V=V.concat(this.picker[this.mode].children),V=V.concat(this.gizmo[this.mode].children),V=V.concat(this.helper[this.mode].children);for(let $=0;$<V.length;$++){const G=V[$];G.visible=!0,G.rotation.set(0,0,0),G.position.copy(this.worldPosition);let O;if(this.camera.isOrthographicCamera?O=(this.camera.top-this.camera.bottom)/this.camera.zoom:O=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),G.scale.set(1,1,1).multiplyScalar(O*this.size/7),G.tag==="helper"){G.visible=!1,G.name==="AXIS"?(G.position.copy(this.worldPositionStart),G.visible=!!this.axis,this.axis==="X"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),G.quaternion.copy(M).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(M).dot(this.eye))>.9&&(G.visible=!1)),this.axis==="Y"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),G.quaternion.copy(M).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(M).dot(this.eye))>.9&&(G.visible=!1)),this.axis==="Z"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),G.quaternion.copy(M).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(M).dot(this.eye))>.9&&(G.visible=!1)),this.axis==="XYZE"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),G.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),G.quaternion.multiply(this.tempQuaternion),G.visible=this.dragging),this.axis==="E"&&(G.visible=!1)):G.name==="START"?(G.position.copy(this.worldPositionStart),G.visible=this.dragging):G.name==="END"?(G.position.copy(this.worldPosition),G.visible=this.dragging):G.name==="DELTA"?(G.position.copy(this.worldPositionStart),G.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),G.scale.copy(this.tempVector),G.visible=this.dragging):(G.quaternion.copy(M),this.dragging?G.position.copy(this.worldPositionStart):G.position.copy(this.worldPosition),this.axis&&(G.visible=this.axis.search(G.name)!==-1));continue}G.quaternion.copy(M),this.mode==="translate"||this.mode==="scale"?((G.name==="X"||G.name==="XYZX")&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(M).dot(this.eye))>.99&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),(G.name==="Y"||G.name==="XYZY")&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(M).dot(this.eye))>.99&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),(G.name==="Z"||G.name==="XYZZ")&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(M).dot(this.eye))>.99&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),G.name==="XY"&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(M).dot(this.eye))<.2&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),G.name==="YZ"&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(M).dot(this.eye))<.2&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),G.name==="XZ"&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(M).dot(this.eye))<.2&&(G.scale.set(1e-10,1e-10,1e-10),G.visible=!1),G.name.search("X")!==-1&&(this.alignVector.copy(this.unitX).applyQuaternion(M).dot(this.eye)<0?G.tag==="fwd"?G.visible=!1:G.scale.x*=-1:G.tag==="bwd"&&(G.visible=!1)),G.name.search("Y")!==-1&&(this.alignVector.copy(this.unitY).applyQuaternion(M).dot(this.eye)<0?G.tag==="fwd"?G.visible=!1:G.scale.y*=-1:G.tag==="bwd"&&(G.visible=!1)),G.name.search("Z")!==-1&&(this.alignVector.copy(this.unitZ).applyQuaternion(M).dot(this.eye)<0?G.tag==="fwd"?G.visible=!1:G.scale.z*=-1:G.tag==="bwd"&&(G.visible=!1))):this.mode==="rotate"&&(this.tempQuaternion2.copy(M),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(M).invert()),G.name.search("E")!==-1&&G.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),G.name==="X"&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),G.quaternion.copy(this.tempQuaternion)),G.name==="Y"&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),G.quaternion.copy(this.tempQuaternion)),G.name==="Z"&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),G.quaternion.copy(this.tempQuaternion))),G.visible=G.visible&&(G.name.indexOf("X")===-1||this.showX),G.visible=G.visible&&(G.name.indexOf("Y")===-1||this.showY),G.visible=G.visible&&(G.name.indexOf("Z")===-1||this.showZ),G.visible=G.visible&&(G.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),G.material.tempOpacity=G.material.tempOpacity||G.material.opacity,G.material.tempColor=G.material.tempColor||G.material.color.clone(),G.material.color.copy(G.material.tempColor),G.material.opacity=G.material.tempOpacity,this.enabled?this.axis&&(G.name===this.axis?(G.material.opacity=1,G.material.color.lerp(new Ye(1,1,1),.5)):this.axis.split("").some(function(F){return G.name===F})?(G.material.opacity=1,G.material.color.lerp(new Ye(1,1,1),.5)):(G.material.opacity*=.25,G.material.color.lerp(new Ye(1,1,1),.5))):(G.material.opacity*=.5,G.material.color.lerp(new Ye(1,1,1),.5))}super.updateMatrixWorld()});const e=new ds({depthTest:!1,depthWrite:!1,transparent:!0,side:xi,fog:!1,toneMapped:!1}),t=new Zo({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;const n=e.clone();n.opacity=.33;const s=e.clone();s.color.set(16711680);const o=e.clone();o.color.set(65280);const a=e.clone();a.color.set(255);const l=e.clone();l.opacity=.25;const c=l.clone();c.color.set(16776960);const u=l.clone();u.color.set(65535);const h=l.clone();h.color.set(16711935),e.clone().color.set(16776960);const d=t.clone();d.color.set(16711680);const m=t.clone();m.color.set(65280);const A=t.clone();A.color.set(255);const p=t.clone();p.color.set(65535);const y=t.clone();y.color.set(16711935);const E=t.clone();E.color.set(16776960);const v=t.clone();v.color.set(7895160);const x=E.clone();x.opacity=.25;const C=new Gn(0,.05,.2,12,1,!1),I=new pr(.125,.125,.125),_=new ki;_.setAttribute("position",new Vi([0,0,0,1,0,0],3));const S=(K,M)=>{const V=new ki,$=[];for(let G=0;G<=64*M;++G)$.push(0,Math.cos(G/32*Math.PI)*K,Math.sin(G/32*Math.PI)*K);return V.setAttribute("position",new Vi($,3)),V},b=()=>{const K=new ki;return K.setAttribute("position",new Vi([0,0,0,1,1,1],3)),K},T={X:[[new Qe(C,s),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Qe(C,s),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new St(_,d)]],Y:[[new Qe(C,o),[0,1,0],null,null,"fwd"],[new Qe(C,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new St(_,m),null,[0,0,Math.PI/2]]],Z:[[new Qe(C,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Qe(C,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new St(_,A),null,[0,-Math.PI/2,0]]],XYZ:[[new Qe(new Lr(.1,0),l.clone()),[0,0,0],[0,0,0]]],XY:[[new Qe(new nn(.295,.295),c.clone()),[.15,.15,0]],[new St(_,E),[.18,.3,0],null,[.125,1,1]],[new St(_,E),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Qe(new nn(.295,.295),u.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new St(_,p),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new St(_,p),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Qe(new nn(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new St(_,y),[.18,0,.3],null,[.125,1,1]],[new St(_,y),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},R={X:[[new Qe(new Gn(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Qe(new Gn(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new Qe(new Gn(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Qe(new Lr(.2,0),i)]],XY:[[new Qe(new nn(.4,.4),i),[.2,.2,0]]],YZ:[[new Qe(new nn(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Qe(new nn(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},w={START:[[new Qe(new Lr(.01,2),n),null,null,null,"helper"]],END:[[new Qe(new Lr(.01,2),n),null,null,null,"helper"]],DELTA:[[new St(b(),n),null,null,null,"helper"]],X:[[new St(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new St(_,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new St(_,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},B={X:[[new St(S(1,.5),d)],[new Qe(new Lr(.04,0),s),[0,0,.99],null,[1,3,1]]],Y:[[new St(S(1,.5),m),null,[0,0,-Math.PI/2]],[new Qe(new Lr(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new St(S(1,.5),A),null,[0,Math.PI/2,0]],[new Qe(new Lr(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new St(S(1.25,1),x),null,[0,Math.PI/2,0]],[new Qe(new Gn(.03,0,.15,4,1,!1),x),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Qe(new Gn(.03,0,.15,4,1,!1),x),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Qe(new Gn(.03,0,.15,4,1,!1),x),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Qe(new Gn(.03,0,.15,4,1,!1),x),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new St(S(1,1),v),null,[0,Math.PI/2,0]]]},D={AXIS:[[new St(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},k={X:[[new Qe(new Zl(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Qe(new Zl(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Qe(new Zl(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Qe(new Zl(1.25,.1,2,24),i)]],XYZE:[[new Qe(new Hy(.7,10,8),i)]]},Q={X:[[new Qe(I,s),[.8,0,0],[0,0,-Math.PI/2]],[new St(_,d),null,null,[.8,1,1]]],Y:[[new Qe(I,o),[0,.8,0]],[new St(_,m),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Qe(I,a),[0,0,.8],[Math.PI/2,0,0]],[new St(_,A),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Qe(I,c),[.85,.85,0],null,[2,2,.2]],[new St(_,E),[.855,.98,0],null,[.125,1,1]],[new St(_,E),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Qe(I,u),[0,.85,.85],null,[.2,2,2]],[new St(_,p),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new St(_,p),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Qe(I,h),[.85,0,.85],null,[2,.2,2]],[new St(_,y),[.855,0,.98],null,[.125,1,1]],[new St(_,y),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Qe(new pr(.125,.125,.125),l.clone()),[1.1,0,0]]],XYZY:[[new Qe(new pr(.125,.125,.125),l.clone()),[0,1.1,0]]],XYZZ:[[new Qe(new pr(.125,.125,.125),l.clone()),[0,0,1.1]]]},Y={X:[[new Qe(new Gn(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Qe(new Gn(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new Qe(new Gn(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Qe(I,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Qe(I,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Qe(I,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Qe(new pr(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new Qe(new pr(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new Qe(new pr(.2,.2,.2),i),[0,0,1.1]]]},W={X:[[new St(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new St(_,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new St(_,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},P=K=>{const M=new mi;for(let V in K)for(let $=K[V].length;$--;){const G=K[V][$][0].clone(),O=K[V][$][1],F=K[V][$][2],U=K[V][$][3],N=K[V][$][4];G.name=V,G.tag=N,O&&G.position.set(O[0],O[1],O[2]),F&&G.rotation.set(F[0],F[1],F[2]),U&&G.scale.set(U[0],U[1],U[2]),G.updateMatrix();const Z=G.geometry.clone();Z.applyMatrix4(G.matrix),G.geometry=Z,G.renderOrder=1/0,G.position.set(0,0,0),G.rotation.set(0,0,0),G.scale.set(1,1,1),M.add(G)}return M};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=P(T)),this.add(this.gizmo.rotate=P(B)),this.add(this.gizmo.scale=P(Q)),this.add(this.picker.translate=P(R)),this.add(this.picker.rotate=P(k)),this.add(this.picker.scale=P(Y)),this.add(this.helper.translate=P(w)),this.add(this.helper.rotate=P(D)),this.add(this.helper.scale=P(W)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class z_ extends Qe{constructor(){super(new nn(1e5,1e5,2,2),new ds({visible:!1,wireframe:!0,side:xi,transparent:!0,opacity:.1,toneMapped:!1})),Ie(this,"isTransformControlsPlane",!0),Ie(this,"type","TransformControlsPlane"),Ie(this,"unitX",new z(1,0,0)),Ie(this,"unitY",new z(0,1,0)),Ie(this,"unitZ",new z(0,0,1)),Ie(this,"tempVector",new z),Ie(this,"dirVector",new z),Ie(this,"alignVector",new z),Ie(this,"tempMatrix",new we),Ie(this,"identityQuaternion",new nt),Ie(this,"cameraQuaternion",new nt),Ie(this,"worldPosition",new z),Ie(this,"worldQuaternion",new nt),Ie(this,"eye",new z),Ie(this,"axis",null),Ie(this,"mode","translate"),Ie(this,"space","world"),Ie(this,"updateMatrixWorld",()=>{let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),this.unitX.set(1,0,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0);break}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()})}}var H_=Object.defineProperty,V_=(r,e,t)=>e in r?H_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Mi=(r,e,t)=>(V_(r,typeof e!="symbol"?e+"":e,t),t);const Ao=new wn(0,0,0,"YXZ"),po=new z,K_={type:"change"},$_={type:"lock"},Y_={type:"unlock"},ZA=.002,ep=Math.PI/2;let W_=class extends oo{constructor(e,t){super(),Mi(this,"camera"),Mi(this,"domElement"),Mi(this,"isLocked"),Mi(this,"minPolarAngle"),Mi(this,"maxPolarAngle"),Mi(this,"pointerSpeed"),Mi(this,"onMouseMove",i=>{!this.domElement||this.isLocked===!1||(Ao.setFromQuaternion(this.camera.quaternion),Ao.y-=i.movementX*ZA*this.pointerSpeed,Ao.x-=i.movementY*ZA*this.pointerSpeed,Ao.x=Math.max(ep-this.maxPolarAngle,Math.min(ep-this.minPolarAngle,Ao.x)),this.camera.quaternion.setFromEuler(Ao),this.dispatchEvent(K_))}),Mi(this,"onPointerlockChange",()=>{this.domElement&&(this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent($_),this.isLocked=!0):(this.dispatchEvent(Y_),this.isLocked=!1))}),Mi(this,"onPointerlockError",()=>{console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}),Mi(this,"connect",i=>{this.domElement=i||this.domElement,this.domElement&&(this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError))}),Mi(this,"disconnect",()=>{this.domElement&&(this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError))}),Mi(this,"dispose",()=>{this.disconnect()}),Mi(this,"getObject",()=>this.camera),Mi(this,"direction",new z(0,0,-1)),Mi(this,"getDirection",i=>i.copy(this.direction).applyQuaternion(this.camera.quaternion)),Mi(this,"moveForward",i=>{po.setFromMatrixColumn(this.camera.matrix,0),po.crossVectors(this.camera.up,po),this.camera.position.addScaledVector(po,i)}),Mi(this,"moveRight",i=>{po.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(po,i)}),Mi(this,"lock",()=>{this.domElement&&this.domElement.requestPointerLock()}),Mi(this,"unlock",()=>{this.domElement&&this.domElement.ownerDocument.exitPointerLock()}),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,t&&this.connect(t)}};var j_=Object.defineProperty,X_=(r,e,t)=>e in r?j_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Li=(r,e,t)=>(X_(r,typeof e!="symbol"?e+"":e,t),t);let q_=class extends oo{constructor(e){super(),Li(this,"object"),Li(this,"changeEvent",{type:"change"}),Li(this,"EPS",1e-6),Li(this,"enabled",!0),Li(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),Li(this,"screenOrientation",0),Li(this,"alphaOffset",0),Li(this,"onDeviceOrientationChangeEvent",t=>{this.deviceOrientation=t}),Li(this,"onScreenOrientationChangeEvent",()=>{this.screenOrientation=window.orientation||0}),Li(this,"zee",new z(0,0,1)),Li(this,"euler",new wn),Li(this,"q0",new nt),Li(this,"q1",new nt(-Math.sqrt(.5),0,0,Math.sqrt(.5))),Li(this,"setObjectQuaternion",(t,i,n,s,o)=>{this.euler.set(n,i,-s,"YXZ"),t.setFromEuler(this.euler),t.multiply(this.q1),t.multiply(this.q0.setFromAxisAngle(this.zee,-o))}),Li(this,"connect",()=>{this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(t=>{t=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(t=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0}),Li(this,"disconnect",()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1}),Li(this,"lastQuaternion",new nt),Li(this,"update",()=>{if(this.enabled===!1)return;const t=this.deviceOrientation;if(t){const i=t.alpha?et.degToRad(t.alpha)+this.alphaOffset:0,n=t.beta?et.degToRad(t.beta):0,s=t.gamma?et.degToRad(t.gamma):0,o=this.screenOrientation?et.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,i,n,s,o),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}}),Li(this,"dispose",()=>this.disconnect()),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}};var J_=Object.defineProperty,Z_=(r,e,t)=>e in r?J_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ue=(r,e,t)=>(Z_(r,typeof e!="symbol"?e+"":e,t),t);let eS=class extends oo{constructor(e,t){super(),Ue(this,"enabled",!0),Ue(this,"screen",{left:0,top:0,width:0,height:0}),Ue(this,"rotateSpeed",1),Ue(this,"zoomSpeed",1.2),Ue(this,"panSpeed",.3),Ue(this,"noRotate",!1),Ue(this,"noZoom",!1),Ue(this,"noPan",!1),Ue(this,"staticMoving",!1),Ue(this,"dynamicDampingFactor",.2),Ue(this,"minDistance",0),Ue(this,"maxDistance",1/0),Ue(this,"keys",["KeyA","KeyS","KeyD"]),Ue(this,"mouseButtons",{LEFT:fs.ROTATE,MIDDLE:fs.DOLLY,RIGHT:fs.PAN}),Ue(this,"object"),Ue(this,"domElement"),Ue(this,"cursorZoom",!1),Ue(this,"target",new z),Ue(this,"mousePosition",new De),Ue(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),Ue(this,"EPS",1e-6),Ue(this,"lastZoom",1),Ue(this,"lastPosition",new z),Ue(this,"cursorVector",new z),Ue(this,"targetVector",new z),Ue(this,"_state",this.STATE.NONE),Ue(this,"_keyState",this.STATE.NONE),Ue(this,"_eye",new z),Ue(this,"_movePrev",new De),Ue(this,"_moveCurr",new De),Ue(this,"_lastAxis",new z),Ue(this,"_lastAngle",0),Ue(this,"_zoomStart",new De),Ue(this,"_zoomEnd",new De),Ue(this,"_touchZoomDistanceStart",0),Ue(this,"_touchZoomDistanceEnd",0),Ue(this,"_panStart",new De),Ue(this,"_panEnd",new De),Ue(this,"target0"),Ue(this,"position0"),Ue(this,"up0"),Ue(this,"zoom0"),Ue(this,"changeEvent",{type:"change"}),Ue(this,"startEvent",{type:"start"}),Ue(this,"endEvent",{type:"end"}),Ue(this,"onScreenVector",new De),Ue(this,"getMouseOnScreen",(i,n)=>(this.onScreenVector.set((i-this.screen.left)/this.screen.width,(n-this.screen.top)/this.screen.height),this.onScreenVector)),Ue(this,"onCircleVector",new De),Ue(this,"getMouseOnCircle",(i,n)=>(this.onCircleVector.set((i-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-n))/this.screen.width),this.onCircleVector)),Ue(this,"axis",new z),Ue(this,"quaternion",new nt),Ue(this,"eyeDirection",new z),Ue(this,"objectUpDirection",new z),Ue(this,"objectSidewaysDirection",new z),Ue(this,"moveDirection",new z),Ue(this,"angle",0),Ue(this,"rotateCamera",()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)}),Ue(this,"zoomCamera",()=>{let i;if(this._state===this.STATE.TOUCH_ZOOM_PAN)i=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(i):this.object.isOrthographicCamera?(this.object.zoom/=i,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(i=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(i-1)>this.EPS&&i>0&&(this.object.isPerspectiveCamera?(i>1&&this._eye.length()>=this.maxDistance-this.EPS&&(i=1),this._eye.multiplyScalar(i)):this.object.isOrthographicCamera?(i>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(i=1),this.object.zoom/=i):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let n=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(n,this.target,i)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}}),Ue(this,"mouseChange",new De),Ue(this,"objectUp",new z),Ue(this,"pan",new z),Ue(this,"panCamera",()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const i=this.object,n=(i.right-i.left)/this.object.zoom,s=(i.top-i.bottom)/this.object.zoom;this.mouseChange.x*=n,this.mouseChange.y*=s}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}),Ue(this,"checkDistances",()=>{(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}),Ue(this,"handleResize",()=>{if(!this.domElement)return;const i=this.domElement.getBoundingClientRect(),n=this.domElement.ownerDocument.documentElement;this.screen.left=i.left+window.pageXOffset-n.clientLeft,this.screen.top=i.top+window.pageYOffset-n.clientTop,this.screen.width=i.width,this.screen.height=i.height}),Ue(this,"update",()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")}),Ue(this,"reset",()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom}),Ue(this,"keydown",i=>{this.enabled!==!1&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(i.code===this.keys[this.STATE.ROTATE]&&!this.noRotate?this._keyState=this.STATE.ROTATE:i.code===this.keys[this.STATE.ZOOM]&&!this.noZoom?this._keyState=this.STATE.ZOOM:i.code===this.keys[this.STATE.PAN]&&!this.noPan&&(this._keyState=this.STATE.PAN)))}),Ue(this,"onPointerDown",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseDown(i);break}}),Ue(this,"onPointerMove",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseMove(i);break}}),Ue(this,"onPointerUp",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseUp();break}}),Ue(this,"keyup",()=>{this.enabled!==!1&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))}),Ue(this,"onMouseDown",i=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(i.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN;break}const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY)),this._movePrev.copy(this._moveCurr)):n===this.STATE.ZOOM&&!this.noZoom?(this._zoomStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._zoomEnd.copy(this._zoomStart)):n===this.STATE.PAN&&!this.noPan&&(this._panStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._panEnd.copy(this._panStart)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)}),Ue(this,"onMouseMove",i=>{if(this.enabled===!1)return;const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY))):n===this.STATE.ZOOM&&!this.noZoom?this._zoomEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY)):n===this.STATE.PAN&&!this.noPan&&this._panEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY))}),Ue(this,"onMouseUp",()=>{this.domElement&&this.enabled!==!1&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))}),Ue(this,"mousewheel",i=>{if(this.enabled!==!1&&this.noZoom!==!0){switch(i.preventDefault(),i.deltaMode){case 2:this._zoomStart.y-=i.deltaY*.025;break;case 1:this._zoomStart.y-=i.deltaY*.01;break;default:this._zoomStart.y-=i.deltaY*25e-5;break}this.mousePosition.x=i.offsetX/this.screen.width*2-1,this.mousePosition.y=-(i.offsetY/this.screen.height)*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}}),Ue(this,"touchstart",i=>{if(this.enabled!==!1){switch(i.preventDefault(),i.touches.length){case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=this.STATE.TOUCH_ZOOM_PAN;const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(o,a)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(this.startEvent)}}),Ue(this,"touchmove",i=>{if(this.enabled!==!1)switch(i.preventDefault(),i.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY));break;default:const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(o,a));break}}),Ue(this,"touchend",i=>{if(this.enabled!==!1){switch(i.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break}this.dispatchEvent(this.endEvent)}}),Ue(this,"contextmenu",i=>{this.enabled!==!1&&i.preventDefault()}),Ue(this,"connect",i=>{i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=i,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()}),Ue(this,"dispose",()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))}),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,t!==void 0&&this.connect(t),this.update()}};var tS=Object.defineProperty,iS=(r,e,t)=>e in r?tS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,rt=(r,e,t)=>(iS(r,typeof e!="symbol"?e+"":e,t),t);const ac=new Aa,tp=new or,nS=Math.cos(70*(Math.PI/180)),ip=(r,e)=>(r%e+e)%e;let Y2=class extends oo{constructor(e,t){super(),rt(this,"object"),rt(this,"domElement"),rt(this,"enabled",!0),rt(this,"target",new z),rt(this,"minDistance",0),rt(this,"maxDistance",1/0),rt(this,"minZoom",0),rt(this,"maxZoom",1/0),rt(this,"minPolarAngle",0),rt(this,"maxPolarAngle",Math.PI),rt(this,"minAzimuthAngle",-1/0),rt(this,"maxAzimuthAngle",1/0),rt(this,"enableDamping",!1),rt(this,"dampingFactor",.05),rt(this,"enableZoom",!0),rt(this,"zoomSpeed",1),rt(this,"enableRotate",!0),rt(this,"rotateSpeed",1),rt(this,"enablePan",!0),rt(this,"panSpeed",1),rt(this,"screenSpacePanning",!0),rt(this,"keyPanSpeed",7),rt(this,"zoomToCursor",!1),rt(this,"autoRotate",!1),rt(this,"autoRotateSpeed",2),rt(this,"reverseOrbit",!1),rt(this,"reverseHorizontalOrbit",!1),rt(this,"reverseVerticalOrbit",!1),rt(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),rt(this,"mouseButtons",{LEFT:fs.ROTATE,MIDDLE:fs.DOLLY,RIGHT:fs.PAN}),rt(this,"touches",{ONE:vr.ROTATE,TWO:vr.DOLLY_PAN}),rt(this,"target0"),rt(this,"position0"),rt(this,"zoom0"),rt(this,"_domElementKeyEvents",null),rt(this,"getPolarAngle"),rt(this,"getAzimuthalAngle"),rt(this,"setPolarAngle"),rt(this,"setAzimuthalAngle"),rt(this,"getDistance"),rt(this,"getZoomScale"),rt(this,"listenToKeyEvents"),rt(this,"stopListenToKeyEvents"),rt(this,"saveState"),rt(this,"reset"),rt(this,"update"),rt(this,"connect"),rt(this,"dispose"),rt(this,"dollyIn"),rt(this,"dollyOut"),rt(this,"getScale"),rt(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>u.phi,this.getAzimuthalAngle=()=>u.theta,this.setPolarAngle=te=>{let Te=ip(te,2*Math.PI),Le=u.phi;Le<0&&(Le+=2*Math.PI),Te<0&&(Te+=2*Math.PI);let Ke=Math.abs(Te-Le);2*Math.PI-Ke<Ke&&(Te<Le?Te+=2*Math.PI:Le+=2*Math.PI),h.phi=Te-Le,i.update()},this.setAzimuthalAngle=te=>{let Te=ip(te,2*Math.PI),Le=u.theta;Le<0&&(Le+=2*Math.PI),Te<0&&(Te+=2*Math.PI);let Ke=Math.abs(Te-Le);2*Math.PI-Ke<Ke&&(Te<Le?Te+=2*Math.PI:Le+=2*Math.PI),h.theta=Te-Le,i.update()},this.getDistance=()=>i.object.position.distanceTo(i.target),this.listenToKeyEvents=te=>{te.addEventListener("keydown",Ne),this._domElementKeyEvents=te},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Ne),this._domElementKeyEvents=null},this.saveState=()=>{i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=()=>{i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(n),i.update(),l=a.NONE},this.update=(()=>{const te=new z,Te=new z(0,1,0),Le=new nt().setFromUnitVectors(e.up,Te),Ke=Le.clone().invert(),pe=new z,ot=new nt,qt=2*Math.PI;return function(){const pt=i.object.position;Le.setFromUnitVectors(e.up,Te),Ke.copy(Le).invert(),te.copy(pt).sub(i.target),te.applyQuaternion(Le),u.setFromVector3(te),i.autoRotate&&l===a.NONE&&D(w()),i.enableDamping?(u.theta+=h.theta*i.dampingFactor,u.phi+=h.phi*i.dampingFactor):(u.theta+=h.theta,u.phi+=h.phi);let Tt=i.minAzimuthAngle,_t=i.maxAzimuthAngle;isFinite(Tt)&&isFinite(_t)&&(Tt<-Math.PI?Tt+=qt:Tt>Math.PI&&(Tt-=qt),_t<-Math.PI?_t+=qt:_t>Math.PI&&(_t-=qt),Tt<=_t?u.theta=Math.max(Tt,Math.min(_t,u.theta)):u.theta=u.theta>(Tt+_t)/2?Math.max(Tt,u.theta):Math.min(_t,u.theta)),u.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,u.phi)),u.makeSafe(),i.enableDamping===!0?i.target.addScaledVector(d,i.dampingFactor):i.target.add(d),i.zoomToCursor&&b||i.object.isOrthographicCamera?u.radius=$(u.radius):u.radius=$(u.radius*f),te.setFromSpherical(u),te.applyQuaternion(Ke),pt.copy(i.target).add(te),i.object.matrixAutoUpdate||i.object.updateMatrix(),i.object.lookAt(i.target),i.enableDamping===!0?(h.theta*=1-i.dampingFactor,h.phi*=1-i.dampingFactor,d.multiplyScalar(1-i.dampingFactor)):(h.set(0,0,0),d.set(0,0,0));let at=!1;if(i.zoomToCursor&&b){let bt=null;if(i.object instanceof jt&&i.object.isPerspectiveCamera){const ai=te.length();bt=$(ai*f);const li=ai-bt;i.object.position.addScaledVector(_,li),i.object.updateMatrixWorld()}else if(i.object.isOrthographicCamera){const ai=new z(S.x,S.y,0);ai.unproject(i.object),i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix(),at=!0;const li=new z(S.x,S.y,0);li.unproject(i.object),i.object.position.sub(li).add(ai),i.object.updateMatrixWorld(),bt=te.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),i.zoomToCursor=!1;bt!==null&&(i.screenSpacePanning?i.target.set(0,0,-1).transformDirection(i.object.matrix).multiplyScalar(bt).add(i.object.position):(ac.origin.copy(i.object.position),ac.direction.set(0,0,-1).transformDirection(i.object.matrix),Math.abs(i.object.up.dot(ac.direction))<nS?e.lookAt(i.target):(tp.setFromNormalAndCoplanarPoint(i.object.up,i.target),ac.intersectPlane(tp,i.target))))}else i.object instanceof ui&&i.object.isOrthographicCamera&&(at=f!==1,at&&(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix()));return f=1,b=!1,at||pe.distanceToSquared(i.object.position)>c||8*(1-ot.dot(i.object.quaternion))>c?(i.dispatchEvent(n),pe.copy(i.object.position),ot.copy(i.object.quaternion),at=!1,!0):!1}})(),this.connect=te=>{i.domElement=te,i.domElement.style.touchAction="none",i.domElement.addEventListener("contextmenu",st),i.domElement.addEventListener("pointerdown",Ce),i.domElement.addEventListener("pointercancel",Be),i.domElement.addEventListener("wheel",Me)},this.dispose=()=>{var te,Te,Le,Ke,pe,ot;i.domElement&&(i.domElement.style.touchAction="auto"),(te=i.domElement)==null||te.removeEventListener("contextmenu",st),(Te=i.domElement)==null||Te.removeEventListener("pointerdown",Ce),(Le=i.domElement)==null||Le.removeEventListener("pointercancel",Be),(Ke=i.domElement)==null||Ke.removeEventListener("wheel",Me),(pe=i.domElement)==null||pe.ownerDocument.removeEventListener("pointermove",_e),(ot=i.domElement)==null||ot.ownerDocument.removeEventListener("pointerup",Be),i._domElementKeyEvents!==null&&i._domElementKeyEvents.removeEventListener("keydown",Ne)};const i=this,n={type:"change"},s={type:"start"},o={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=a.NONE;const c=1e-6,u=new aa,h=new aa;let f=1;const d=new z,m=new De,A=new De,p=new De,y=new De,E=new De,v=new De,x=new De,C=new De,I=new De,_=new z,S=new De;let b=!1;const T=[],R={};function w(){return 2*Math.PI/60/60*i.autoRotateSpeed}function B(){return Math.pow(.95,i.zoomSpeed)}function D(te){i.reverseOrbit||i.reverseHorizontalOrbit?h.theta+=te:h.theta-=te}function k(te){i.reverseOrbit||i.reverseVerticalOrbit?h.phi+=te:h.phi-=te}const Q=(()=>{const te=new z;return function(Le,Ke){te.setFromMatrixColumn(Ke,0),te.multiplyScalar(-Le),d.add(te)}})(),Y=(()=>{const te=new z;return function(Le,Ke){i.screenSpacePanning===!0?te.setFromMatrixColumn(Ke,1):(te.setFromMatrixColumn(Ke,0),te.crossVectors(i.object.up,te)),te.multiplyScalar(Le),d.add(te)}})(),W=(()=>{const te=new z;return function(Le,Ke){const pe=i.domElement;if(pe&&i.object instanceof jt&&i.object.isPerspectiveCamera){const ot=i.object.position;te.copy(ot).sub(i.target);let qt=te.length();qt*=Math.tan(i.object.fov/2*Math.PI/180),Q(2*Le*qt/pe.clientHeight,i.object.matrix),Y(2*Ke*qt/pe.clientHeight,i.object.matrix)}else pe&&i.object instanceof ui&&i.object.isOrthographicCamera?(Q(Le*(i.object.right-i.object.left)/i.object.zoom/pe.clientWidth,i.object.matrix),Y(Ke*(i.object.top-i.object.bottom)/i.object.zoom/pe.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}})();function P(te){i.object instanceof jt&&i.object.isPerspectiveCamera||i.object instanceof ui&&i.object.isOrthographicCamera?f=te:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function K(te){P(f/te)}function M(te){P(f*te)}function V(te){if(!i.zoomToCursor||!i.domElement)return;b=!0;const Te=i.domElement.getBoundingClientRect(),Le=te.clientX-Te.left,Ke=te.clientY-Te.top,pe=Te.width,ot=Te.height;S.x=Le/pe*2-1,S.y=-(Ke/ot)*2+1,_.set(S.x,S.y,1).unproject(i.object).sub(i.object.position).normalize()}function $(te){return Math.max(i.minDistance,Math.min(i.maxDistance,te))}function G(te){m.set(te.clientX,te.clientY)}function O(te){V(te),x.set(te.clientX,te.clientY)}function F(te){y.set(te.clientX,te.clientY)}function U(te){A.set(te.clientX,te.clientY),p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const Te=i.domElement;Te&&(D(2*Math.PI*p.x/Te.clientHeight),k(2*Math.PI*p.y/Te.clientHeight)),m.copy(A),i.update()}function N(te){C.set(te.clientX,te.clientY),I.subVectors(C,x),I.y>0?K(B()):I.y<0&&M(B()),x.copy(C),i.update()}function Z(te){E.set(te.clientX,te.clientY),v.subVectors(E,y).multiplyScalar(i.panSpeed),W(v.x,v.y),y.copy(E),i.update()}function ie(te){V(te),te.deltaY<0?M(B()):te.deltaY>0&&K(B()),i.update()}function q(te){let Te=!1;switch(te.code){case i.keys.UP:W(0,i.keyPanSpeed),Te=!0;break;case i.keys.BOTTOM:W(0,-i.keyPanSpeed),Te=!0;break;case i.keys.LEFT:W(i.keyPanSpeed,0),Te=!0;break;case i.keys.RIGHT:W(-i.keyPanSpeed,0),Te=!0;break}Te&&(te.preventDefault(),i.update())}function ne(){if(T.length==1)m.set(T[0].pageX,T[0].pageY);else{const te=.5*(T[0].pageX+T[1].pageX),Te=.5*(T[0].pageY+T[1].pageY);m.set(te,Te)}}function ye(){if(T.length==1)y.set(T[0].pageX,T[0].pageY);else{const te=.5*(T[0].pageX+T[1].pageX),Te=.5*(T[0].pageY+T[1].pageY);y.set(te,Te)}}function ve(){const te=T[0].pageX-T[1].pageX,Te=T[0].pageY-T[1].pageY,Le=Math.sqrt(te*te+Te*Te);x.set(0,Le)}function re(){i.enableZoom&&ve(),i.enablePan&&ye()}function se(){i.enableZoom&&ve(),i.enableRotate&&ne()}function he(te){if(T.length==1)A.set(te.pageX,te.pageY);else{const Le=We(te),Ke=.5*(te.pageX+Le.x),pe=.5*(te.pageY+Le.y);A.set(Ke,pe)}p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const Te=i.domElement;Te&&(D(2*Math.PI*p.x/Te.clientHeight),k(2*Math.PI*p.y/Te.clientHeight)),m.copy(A)}function ae(te){if(T.length==1)E.set(te.pageX,te.pageY);else{const Te=We(te),Le=.5*(te.pageX+Te.x),Ke=.5*(te.pageY+Te.y);E.set(Le,Ke)}v.subVectors(E,y).multiplyScalar(i.panSpeed),W(v.x,v.y),y.copy(E)}function J(te){const Te=We(te),Le=te.pageX-Te.x,Ke=te.pageY-Te.y,pe=Math.sqrt(Le*Le+Ke*Ke);C.set(0,pe),I.set(0,Math.pow(C.y/x.y,i.zoomSpeed)),K(I.y),x.copy(C)}function X(te){i.enableZoom&&J(te),i.enablePan&&ae(te)}function oe(te){i.enableZoom&&J(te),i.enableRotate&&he(te)}function Ce(te){var Te,Le;i.enabled!==!1&&(T.length===0&&((Te=i.domElement)==null||Te.ownerDocument.addEventListener("pointermove",_e),(Le=i.domElement)==null||Le.ownerDocument.addEventListener("pointerup",Be)),At(te),te.pointerType==="touch"?Ge(te):Se(te))}function _e(te){i.enabled!==!1&&(te.pointerType==="touch"?je(te):Ve(te))}function Be(te){var Te,Le,Ke;it(te),T.length===0&&((Te=i.domElement)==null||Te.releasePointerCapture(te.pointerId),(Le=i.domElement)==null||Le.ownerDocument.removeEventListener("pointermove",_e),(Ke=i.domElement)==null||Ke.ownerDocument.removeEventListener("pointerup",Be)),i.dispatchEvent(o),l=a.NONE}function Se(te){let Te;switch(te.button){case 0:Te=i.mouseButtons.LEFT;break;case 1:Te=i.mouseButtons.MIDDLE;break;case 2:Te=i.mouseButtons.RIGHT;break;default:Te=-1}switch(Te){case fs.DOLLY:if(i.enableZoom===!1)return;O(te),l=a.DOLLY;break;case fs.ROTATE:if(te.ctrlKey||te.metaKey||te.shiftKey){if(i.enablePan===!1)return;F(te),l=a.PAN}else{if(i.enableRotate===!1)return;G(te),l=a.ROTATE}break;case fs.PAN:if(te.ctrlKey||te.metaKey||te.shiftKey){if(i.enableRotate===!1)return;G(te),l=a.ROTATE}else{if(i.enablePan===!1)return;F(te),l=a.PAN}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function Ve(te){if(i.enabled!==!1)switch(l){case a.ROTATE:if(i.enableRotate===!1)return;U(te);break;case a.DOLLY:if(i.enableZoom===!1)return;N(te);break;case a.PAN:if(i.enablePan===!1)return;Z(te);break}}function Me(te){i.enabled===!1||i.enableZoom===!1||l!==a.NONE&&l!==a.ROTATE||(te.preventDefault(),i.dispatchEvent(s),ie(te),i.dispatchEvent(o))}function Ne(te){i.enabled===!1||i.enablePan===!1||q(te)}function Ge(te){switch(Xe(te),T.length){case 1:switch(i.touches.ONE){case vr.ROTATE:if(i.enableRotate===!1)return;ne(),l=a.TOUCH_ROTATE;break;case vr.PAN:if(i.enablePan===!1)return;ye(),l=a.TOUCH_PAN;break;default:l=a.NONE}break;case 2:switch(i.touches.TWO){case vr.DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;re(),l=a.TOUCH_DOLLY_PAN;break;case vr.DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;se(),l=a.TOUCH_DOLLY_ROTATE;break;default:l=a.NONE}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function je(te){switch(Xe(te),l){case a.TOUCH_ROTATE:if(i.enableRotate===!1)return;he(te),i.update();break;case a.TOUCH_PAN:if(i.enablePan===!1)return;ae(te),i.update();break;case a.TOUCH_DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;X(te),i.update();break;case a.TOUCH_DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;oe(te),i.update();break;default:l=a.NONE}}function st(te){i.enabled!==!1&&te.preventDefault()}function At(te){T.push(te)}function it(te){delete R[te.pointerId];for(let Te=0;Te<T.length;Te++)if(T[Te].pointerId==te.pointerId){T.splice(Te,1);return}}function Xe(te){let Te=R[te.pointerId];Te===void 0&&(Te=new De,R[te.pointerId]=Te),Te.set(te.pageX,te.pageY)}function We(te){const Te=te.pointerId===T[0].pointerId?T[1]:T[0];return R[Te.pointerId]}this.dollyIn=(te=B())=>{M(te),i.update()},this.dollyOut=(te=B())=>{K(te),i.update()},this.getScale=()=>f,this.setScale=te=>{P(te),i.update()},this.getZoomScale=()=>B(),t!==void 0&&this.connect(t),this.update()}},sS=class extends Y2{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=fs.PAN,this.mouseButtons.RIGHT=fs.ROTATE,this.touches.ONE=vr.PAN,this.touches.TWO=vr.DOLLY_ROTATE}};var rS=Object.defineProperty,oS=(r,e,t)=>e in r?rS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,fe=(r,e,t)=>(oS(r,typeof e!="symbol"?e+"":e,t),t);const tt={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),TOUCH_MULTI:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},Ut={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},mt={x:0,y:0},Sn={camera:new we,gizmos:new we},Jt={type:"change"},as={type:"start"},On={type:"end"};let aS=class extends oo{constructor(e,t=null,i=null){super(),fe(this,"camera"),fe(this,"domElement"),fe(this,"scene"),fe(this,"mouseActions"),fe(this,"_mouseOp"),fe(this,"_v2_1"),fe(this,"_v3_1"),fe(this,"_v3_2"),fe(this,"_m4_1"),fe(this,"_m4_2"),fe(this,"_quat"),fe(this,"_translationMatrix"),fe(this,"_rotationMatrix"),fe(this,"_scaleMatrix"),fe(this,"_rotationAxis"),fe(this,"_cameraMatrixState"),fe(this,"_cameraProjectionState"),fe(this,"_fovState"),fe(this,"_upState"),fe(this,"_zoomState"),fe(this,"_nearPos"),fe(this,"_farPos"),fe(this,"_gizmoMatrixState"),fe(this,"_up0"),fe(this,"_zoom0"),fe(this,"_fov0"),fe(this,"_initialNear"),fe(this,"_nearPos0"),fe(this,"_initialFar"),fe(this,"_farPos0"),fe(this,"_cameraMatrixState0"),fe(this,"_gizmoMatrixState0"),fe(this,"_button"),fe(this,"_touchStart"),fe(this,"_touchCurrent"),fe(this,"_input"),fe(this,"_switchSensibility"),fe(this,"_startFingerDistance"),fe(this,"_currentFingerDistance"),fe(this,"_startFingerRotation"),fe(this,"_currentFingerRotation"),fe(this,"_devPxRatio"),fe(this,"_downValid"),fe(this,"_nclicks"),fe(this,"_downEvents"),fe(this,"_clickStart"),fe(this,"_maxDownTime"),fe(this,"_maxInterval"),fe(this,"_posThreshold"),fe(this,"_movementThreshold"),fe(this,"_currentCursorPosition"),fe(this,"_startCursorPosition"),fe(this,"_grid"),fe(this,"_gridPosition"),fe(this,"_gizmos"),fe(this,"_curvePts"),fe(this,"_timeStart"),fe(this,"_animationId"),fe(this,"focusAnimationTime"),fe(this,"_timePrev"),fe(this,"_timeCurrent"),fe(this,"_anglePrev"),fe(this,"_angleCurrent"),fe(this,"_cursorPosPrev"),fe(this,"_cursorPosCurr"),fe(this,"_wPrev"),fe(this,"_wCurr"),fe(this,"adjustNearFar"),fe(this,"scaleFactor"),fe(this,"dampingFactor"),fe(this,"wMax"),fe(this,"enableAnimations"),fe(this,"enableGrid"),fe(this,"cursorZoom"),fe(this,"minFov"),fe(this,"maxFov"),fe(this,"enabled"),fe(this,"enablePan"),fe(this,"enableRotate"),fe(this,"enableZoom"),fe(this,"minDistance"),fe(this,"maxDistance"),fe(this,"minZoom"),fe(this,"maxZoom"),fe(this,"target"),fe(this,"_currentTarget"),fe(this,"_tbRadius"),fe(this,"_state"),fe(this,"onWindowResize",()=>{const n=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const c=this.calculateTbRadius(this.camera);c!==void 0&&(this._tbRadius=c)}const s=this._tbRadius/n,a=new Th(0,0,s,s).getPoints(this._curvePts),l=new ki().setFromPoints(a);for(const c in this._gizmos.children){const u=this._gizmos.children[c];u.geometry=l}this.dispatchEvent(Jt)}),fe(this,"onContextMenu",n=>{if(this.enabled){for(let s=0;s<this.mouseActions.length;s++)if(this.mouseActions[s].mouse==2){n.preventDefault();break}}}),fe(this,"onPointerCancel",()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=Ut.NONE}),fe(this,"onPointerDown",n=>{if(n.button==0&&n.isPrimary?(this._downValid=!0,this._downEvents.push(n)):this._downValid=!1,n.pointerType=="touch"&&this._input!=Ut.CURSOR)switch(this._touchStart.push(n),this._touchCurrent.push(n),this._input){case Ut.NONE:this._input=Ut.ONE_FINGER,this.onSinglePanStart(n,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case Ut.ONE_FINGER:case Ut.ONE_FINGER_SWITCHED:this._input=Ut.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case Ut.TWO_FINGER:this._input=Ut.MULT_FINGER,this.onTriplePanStart();break}else if(n.pointerType!="touch"&&this._input==Ut.NONE){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT"),this._mouseOp=this.getOpFromAction(n.button,s),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=Ut.CURSOR,this._button=n.button,this.onSinglePanStart(n,this._mouseOp))}}),fe(this,"onPointerMove",n=>{if(n.pointerType=="touch"&&this._input!=Ut.CURSOR)switch(this._input){case Ut.ONE_FINGER:this.updateTouchEvent(n),this.onSinglePanMove(n,tt.ROTATE);break;case Ut.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],n)*this._devPxRatio>=this._switchSensibility){this._input=Ut.ONE_FINGER,this.updateTouchEvent(n),this.onSinglePanStart(n,"ROTATE");break}break;case Ut.TWO_FINGER:this.updateTouchEvent(n),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case Ut.MULT_FINGER:this.updateTouchEvent(n),this.onTriplePanMove();break}else if(n.pointerType!="touch"&&this._input==Ut.CURSOR){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT");const o=this.getOpStateFromAction(this._button,s);o&&this.onSinglePanMove(n,o)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],n)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}),fe(this,"onPointerUp",n=>{if(n.pointerType=="touch"&&this._input!=Ut.CURSOR){const s=this._touchCurrent.length;for(let o=0;o<s;o++)if(this._touchCurrent[o].pointerId==n.pointerId){this._touchCurrent.splice(o,1),this._touchStart.splice(o,1);break}switch(this._input){case Ut.ONE_FINGER:case Ut.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ut.NONE,this.onSinglePanEnd();break;case Ut.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=Ut.ONE_FINGER_SWITCHED;break;case Ut.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ut.NONE,this.onTriplePanEnd());break}}else n.pointerType!="touch"&&this._input==Ut.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ut.NONE,this.onSinglePanEnd(),this._button=-1);if(n.isPrimary)if(this._downValid)if(n.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const o=n.timeStamp-this._clickStart,a=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;o<=this._maxInterval&&a<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(n)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}),fe(this,"onWheel",n=>{var s,o;if(this.enabled&&this.enableZoom&&this.domElement){let a=null;n.ctrlKey||n.metaKey?a="CTRL":n.shiftKey&&(a="SHIFT");const l=this.getOpFromAction("WHEEL",a);if(l){n.preventDefault(),this.dispatchEvent(as);const c=125;let u=n.deltaY/c,h=1;switch(u>0?h=1/this.scaleFactor:u<0&&(h=this.scaleFactor),l){case"ZOOM":if(this.updateTbState(tt.SCALE,!0),u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u)),this.cursorZoom&&this.enablePan){let f;this.camera instanceof ui&&(f=(s=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof jt&&(f=(o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:o.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),f!==void 0&&this.applyTransformMatrix(this.applyScale(h,f))}else this.applyTransformMatrix(this.applyScale(h,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(tt.IDLE,!1),this.dispatchEvent(Jt),this.dispatchEvent(On);break;case"FOV":if(this.camera instanceof jt){this.updateTbState(tt.FOV,!0),n.deltaX!=0&&(u=n.deltaX/c,h=1,u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const f=this._v3_1.distanceTo(this._gizmos.position);let d=f/h;d=et.clamp(d,this.minDistance,this.maxDistance);const m=f*Math.tan(et.DEG2RAD*this.camera.fov*.5);let A=et.RAD2DEG*(Math.atan(m/d)*2);A>this.maxFov?A=this.maxFov:A<this.minFov&&(A=this.minFov);const p=m/Math.tan(et.DEG2RAD*(A/2));h=f/p,this.setFov(A),this.applyTransformMatrix(this.applyScale(h,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(tt.IDLE,!1),this.dispatchEvent(Jt),this.dispatchEvent(On);break}}}}),fe(this,"onSinglePanStart",(n,s)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(as),this.setCenter(n.clientX,n.clientY),s){case"PAN":if(!this.enablePan)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Jt)),this.camera){this.updateTbState(tt.PAN,!0);const o=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement);o!==void 0&&this._startCursorPosition.copy(o),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(Jt))}break;case"ROTATE":if(!this.enableRotate)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState(tt.ROTATE,!0);const o=this.unprojectOnTbSurface(this.camera,mt.x,mt.y,this.domElement,this._tbRadius);o!==void 0&&this._startCursorPosition.copy(o),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(Jt);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof jt&&(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Jt)),this.updateTbState(tt.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Jt)),this.updateTbState(tt.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}),fe(this,"onSinglePanMove",(n,s)=>{if(this.enabled&&this.domElement){const o=s!=this._state;switch(this.setCenter(n.clientX,n.clientY),s){case tt.PAN:if(this.enablePan&&this.camera)if(o){this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0);const a=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const a=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement);a!==void 0&&this._currentCursorPosition.copy(a),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case tt.ROTATE:if(this.enableRotate&&this.camera)if(o){this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0);const a=this.unprojectOnTbSurface(this.camera,mt.x,mt.y,this.domElement,this._tbRadius);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const a=this.unprojectOnTbSurface(this.camera,mt.x,mt.y,this.domElement,this._tbRadius);a!==void 0&&this._currentCursorPosition.copy(a);const l=this._startCursorPosition.distanceTo(this._currentCursorPosition),c=this._startCursorPosition.angleTo(this._currentCursorPosition),u=Math.max(l/this._tbRadius,c);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),u)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=u,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case tt.SCALE:if(this.enableZoom)if(o)this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this.applyTransformMatrix(this.applyScale(c,this._gizmos.position))}break;case tt.FOV:if(this.enableZoom&&this.camera instanceof jt)if(o)this.dispatchEvent(On),this.dispatchEvent(as),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=et.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(et.DEG2RAD*this._fovState*.5);let d=et.RAD2DEG*(Math.atan(f/h)*2);d=et.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(et.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z)}break}this.dispatchEvent(Jt)}}),fe(this,"onSinglePanEnd",()=>{if(this._state==tt.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const s=Math.abs((this._wPrev+this._wCurr)/2),o=this;this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(tt.ANIMATION_ROTATE,!0);const l=o.calculateRotationAxis(o._cursorPosPrev,o._cursorPosCurr);o.onRotationAnim(a,l,Math.min(s,o.wMax))})}else this.updateTbState(tt.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Jt);else this.updateTbState(tt.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Jt)}else(this._state==tt.PAN||this._state==tt.IDLE)&&(this.updateTbState(tt.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(Jt));this.dispatchEvent(On)}),fe(this,"onDoubleTap",n=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(as),this.setCenter(n.clientX,n.clientY);const s=this.unprojectOnObj(this.getCursorNDC(mt.x,mt.y,this.domElement),this.camera);if(s&&this.enableAnimations){const o=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(tt.ANIMATION_FOCUS,!0),o.onFocusAnim(a,s,o._cameraMatrixState,o._gizmoMatrixState)})}else s&&!this.enableAnimations&&(this.updateTbState(tt.FOCUS,!0),this.focus(s,this.scaleFactor),this.updateTbState(tt.IDLE,!1),this.dispatchEvent(Jt))}this.dispatchEvent(On)}),fe(this,"onDoublePanStart",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(as),this.updateTbState(tt.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const n=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement,!0);n!==void 0&&this._startCursorPosition.copy(n),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}}),fe(this,"onDoublePanMove",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=tt.PAN&&(this.updateTbState(tt.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const n=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement,!0);n!==void 0&&this._currentCursorPosition.copy(n),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(Jt)}}),fe(this,"onDoublePanEnd",()=>{this.updateTbState(tt.IDLE,!1),this.dispatchEvent(On)}),fe(this,"onRotateStart",()=>{var n;this.enabled&&this.enableRotate&&(this.dispatchEvent(as),this.updateTbState(tt.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,(n=this.camera)==null||n.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}),fe(this,"onRotateMove",()=>{var n;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let s;this._state!=tt.ZROTATE&&(this.updateTbState(tt.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),s=(n=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):s=new z().setFromMatrixPosition(this._gizmoMatrixState);const o=et.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);s!==void 0&&this.applyTransformMatrix(this.zRotate(s,o)),this.dispatchEvent(Jt)}}),fe(this,"onRotateEnd",()=>{this.updateTbState(tt.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(On)}),fe(this,"onPinchStart",()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(as),this.updateTbState(tt.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}),fe(this,"onPinchMove",()=>{var n,s;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const o=12;this._state!=tt.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(tt.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),o*this._devPxRatio);const a=this._currentFingerDistance/this._startFingerDistance;let l;this.enablePan?this.camera instanceof ui?l=(n=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof jt&&(l=(s=this.unprojectOnTbPlane(this.camera,mt.x,mt.y,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):l=this._gizmos.position,l!==void 0&&this.applyTransformMatrix(this.applyScale(a,l)),this.dispatchEvent(Jt)}}),fe(this,"onPinchEnd",()=>{this.updateTbState(tt.IDLE,!1),this.dispatchEvent(On)}),fe(this,"onTriplePanStart",()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(as),this.updateTbState(tt.SCALE,!0);let n=0,s=0;const o=this._touchCurrent.length;for(let a=0;a<o;a++)n+=this._touchCurrent[a].clientX,s+=this._touchCurrent[a].clientY;this.setCenter(n/o,s/o),this._startCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}),fe(this,"onTriplePanMove",()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let n=0,s=0;const o=this._touchCurrent.length;for(let p=0;p<o;p++)n+=this._touchCurrent[p].clientX,s+=this._touchCurrent[p].clientY;this.setCenter(n/o,s/o);const a=8;this._currentCursorPosition.setY(this.getCursorNDC(mt.x,mt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*a):l>0&&(c=Math.pow(this.scaleFactor,l*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=et.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(et.DEG2RAD*this._fovState*.5);let d=et.RAD2DEG*(Math.atan(f/h)*2);d=et.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(et.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z),this.dispatchEvent(Jt)}}),fe(this,"onTriplePanEnd",()=>{this.updateTbState(tt.IDLE,!1),this.dispatchEvent(On)}),fe(this,"setCenter",(n,s)=>{mt.x=n,mt.y=s}),fe(this,"initializeMouseActions",()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}),fe(this,"setMouseAction",(n,s,o=null)=>{const a=["PAN","ROTATE","ZOOM","FOV"],l=[0,1,2,"WHEEL"],c=["CTRL","SHIFT",null];let u;if(!a.includes(n)||!l.includes(s)||!c.includes(o)||s=="WHEEL"&&n!="ZOOM"&&n!="FOV")return!1;switch(n){case"PAN":u=tt.PAN;break;case"ROTATE":u=tt.ROTATE;break;case"ZOOM":u=tt.SCALE;break;case"FOV":u=tt.FOV;break}const h={operation:n,mouse:s,key:o,state:u};for(let f=0;f<this.mouseActions.length;f++)if(this.mouseActions[f].mouse==h.mouse&&this.mouseActions[f].key==h.key)return this.mouseActions.splice(f,1,h),!0;return this.mouseActions.push(h),!0}),fe(this,"getOpFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.operation;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.operation}return null}),fe(this,"getOpStateFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.state;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.state}return null}),fe(this,"getAngle",(n,s)=>Math.atan2(s.clientY-n.clientY,s.clientX-n.clientX)*180/Math.PI),fe(this,"updateTouchEvent",n=>{for(let s=0;s<this._touchCurrent.length;s++)if(this._touchCurrent[s].pointerId==n.pointerId){this._touchCurrent.splice(s,1,n);break}}),fe(this,"calculateAngularSpeed",(n,s,o,a)=>{const l=s-n,c=(a-o)/1e3;return c==0?0:l/c}),fe(this,"calculatePointersDistance",(n,s)=>Math.sqrt(Math.pow(s.clientX-n.clientX,2)+Math.pow(s.clientY-n.clientY,2))),fe(this,"calculateRotationAxis",(n,s)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(n,s).applyQuaternion(this._quat),this._rotationAxis.normalize().clone())),fe(this,"calculateTbRadius",n=>{const o=n.position.distanceTo(this._gizmos.position);if(n instanceof jt){const a=et.DEG2RAD*n.fov*.5,l=Math.atan(n.aspect*Math.tan(a));return Math.tan(Math.min(a,l))*o*.67}else if(n instanceof ui)return Math.min(n.top,n.right)*.67}),fe(this,"focus",(n,s,o=1)=>{if(this.camera){const a=n.clone();a.sub(this._gizmos.position).multiplyScalar(o),this._translationMatrix.makeTranslation(a.x,a.y,a.z);const l=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const c=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(s,this._gizmos.position)),this._gizmoMatrixState.copy(l),this._cameraMatrixState.copy(c)}}),fe(this,"drawGrid",()=>{if(this.scene){let o,a,l,c;if(this.camera instanceof ui){const u=this.camera.right-this.camera.left,h=this.camera.bottom-this.camera.top;l=Math.max(u,h),c=l/20,o=l/this.camera.zoom*3,a=o/c*this.camera.zoom}else if(this.camera instanceof jt){const u=this.camera.position.distanceTo(this._gizmos.position),h=et.DEG2RAD*this.camera.fov*.5,f=Math.atan(this.camera.aspect*Math.tan(h));l=Math.tan(Math.max(h,f))*u*2,c=l/20,o=l*3,a=o/c}this._grid==null&&this.camera&&(this._grid=new Tx(o,a,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}),fe(this,"connect",n=>{n===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)}),fe(this,"dispose",()=>{var n,s,o,a,l;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointercancel",this.onPointerCancel),(o=this.domElement)==null||o.removeEventListener("wheel",this.onWheel),(a=this.domElement)==null||a.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),(l=this.scene)==null||l.remove(this._gizmos),this.disposeGrid()}),fe(this,"disposeGrid",()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)}),fe(this,"easeOutCubic",n=>1-Math.pow(1-n,3)),fe(this,"activateGizmos",n=>{for(const s of this._gizmos.children)s.material.setValues({opacity:n?1:.6})}),fe(this,"getCursorNDC",(n,s,o)=>{const a=o.getBoundingClientRect();return this._v2_1.setX((n-a.left)/a.width*2-1),this._v2_1.setY((a.bottom-s)/a.height*2-1),this._v2_1.clone()}),fe(this,"getCursorPosition",(n,s,o)=>(this._v2_1.copy(this.getCursorNDC(n,s,o)),this.camera instanceof ui&&(this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5),this._v2_1.clone())),fe(this,"setCamera",n=>{if(n){n.lookAt(this.target),n.updateMatrix(),n instanceof jt&&(this._fov0=n.fov,this._fovState=n.fov),this._cameraMatrixState0.copy(n.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(n.projectionMatrix),this._zoom0=n.zoom,this._zoomState=this._zoom0,this._initialNear=n.near,this._nearPos0=n.position.distanceTo(this.target)-n.near,this._nearPos=this._initialNear,this._initialFar=n.far,this._farPos0=n.position.distanceTo(this.target)-n.far,this._farPos=this._initialFar,this._up0.copy(n.up),this._upState.copy(n.up),this.camera=n,this.camera.updateProjectionMatrix();const s=this.calculateTbRadius(n);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius)}}),fe(this,"makeGizmos",(n,s)=>{const a=new Th(0,0,s,s).getPoints(this._curvePts),l=new ki().setFromPoints(a),c=new Zo({color:16744576,fog:!1,transparent:!0,opacity:.6}),u=new Zo({color:8454016,fog:!1,transparent:!0,opacity:.6}),h=new Zo({color:8421631,fog:!1,transparent:!0,opacity:.6}),f=new St(l,c),d=new St(l,u),m=new St(l,h),A=Math.PI*.5;if(f.rotation.x=A,d.rotation.y=A,this._gizmoMatrixState0.identity().setPosition(n),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&this.camera.zoom!=1){const p=1/this.camera.zoom;this._scaleMatrix.makeScale(p,p,p),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(n.x,n.y,n.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(f),this._gizmos.add(d),this._gizmos.add(m)}),fe(this,"onFocusAnim",(n,s,o,a)=>{if(this._timeStart==-1&&(this._timeStart=n),this._state==tt.ANIMATION_FOCUS){const c=(n-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(a),c>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,this.scaleFactor),this._timeStart=-1,this.updateTbState(tt.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Jt);else{const u=this.easeOutCubic(c),h=1-u+this.scaleFactor*u;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,h,u),this.dispatchEvent(Jt);const f=this;this._animationId=window.requestAnimationFrame(function(d){f.onFocusAnim(d,s,o,a.clone())})}}else this._animationId=-1,this._timeStart=-1}),fe(this,"onRotationAnim",(n,s,o)=>{if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=n),this._state==tt.ANIMATION_ROTATE){const a=(n-this._timeStart)/1e3;if(o+-this.dampingFactor*a>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(a,2)+o*a+0,this.applyTransformMatrix(this.rotate(s,this._angleCurrent)),this.dispatchEvent(Jt);const c=this;this._animationId=window.requestAnimationFrame(function(u){c.onRotationAnim(u,s,o)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(tt.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Jt)}else this._animationId=-1,this._timeStart=-1,this._state!=tt.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(Jt))}),fe(this,"pan",(n,s,o=!1)=>{if(this.camera){const a=n.clone().sub(s);if(this.camera instanceof ui&&a.multiplyScalar(1/this.camera.zoom),this.camera instanceof jt&&o){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const l=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);a.multiplyScalar(1/l)}this._v3_1.set(a.x,a.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return Sn}),fe(this,"reset",()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof jt&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const n=this.calculateTbRadius(this.camera);n!==void 0&&(this._tbRadius=n),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(tt.IDLE,!1),this.dispatchEvent(Jt)}}),fe(this,"rotate",(n,s)=>{const o=this._gizmos.position;return this._translationMatrix.makeTranslation(-o.x,-o.y,-o.z),this._rotationMatrix.makeRotationAxis(n,-s),this._m4_1.makeTranslation(o.x,o.y,o.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),Sn}),fe(this,"copyState",()=>{if(this.camera){const n=JSON.stringify(this.camera instanceof ui?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(n)}}),fe(this,"pasteState",()=>{const n=this;navigator.clipboard.readText().then(function(o){n.setStateFromJSON(o)})}),fe(this,"saveState",()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof jt&&(this._fov0=this.camera.fov))}),fe(this,"applyScale",(n,s,o=!0)=>{if(!this.camera)return;const a=s.clone();let l=1/n;if(this.camera instanceof ui){this.camera.zoom=this._zoomState,this.camera.zoom*=n,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,l=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,l=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(l,l,l),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),a.sub(this._v3_1);const c=a.clone().multiplyScalar(l);return a.sub(c),this._m4_1.makeTranslation(a.x,a.y,a.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),Sn}if(this.camera instanceof jt){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let c=this._v3_1.distanceTo(a),u=c-c*l;const h=c-u;h<this.minDistance?(l=this.minDistance/c,u=c-c*l):h>this.maxDistance&&(l=this.maxDistance/c,u=c-c*l);let f=a.clone().sub(this._v3_1).normalize().multiplyScalar(u);if(this._m4_1.makeTranslation(f.x,f.y,f.z),o){const d=this._v3_2;c=d.distanceTo(a),u=c-c*l,f=a.clone().sub(this._v3_2).normalize().multiplyScalar(u),this._translationMatrix.makeTranslation(d.x,d.y,d.z),this._scaleMatrix.makeScale(l,l,l),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-d.x,-d.y,-d.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return Sn}}),fe(this,"setFov",n=>{this.camera instanceof jt&&(this.camera.fov=et.clamp(n,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}),fe(this,"setTarget",(n,s,o)=>{if(this.camera){this.target.set(n,s,o),this._gizmos.position.set(n,s,o);const a=this.calculateTbRadius(this.camera);a!==void 0&&(this._tbRadius=a),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}}),fe(this,"zRotate",(n,s)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,s),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._m4_1.makeTranslation(n.x,n.y,n.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(n),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,s),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),Sn)),fe(this,"unprojectOnObj",(n,s)=>{if(!this.scene)return null;const o=new Ku;o.near=s.near,o.far=s.far,o.setFromCamera(n,s);const a=o.intersectObjects(this.scene.children,!0);for(let l=0;l<a.length;l++)if(a[l].object.uuid!=this._gizmos.uuid&&a[l].face)return a[l].point.clone();return null}),fe(this,"unprojectOnTbSurface",(n,s,o,a,l)=>{if(n instanceof ui){this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const c=Math.pow(this._v2_1.x,2),u=Math.pow(this._v2_1.y,2),h=Math.pow(this._tbRadius,2);return c+u<=h*.5?this._v3_1.setZ(Math.sqrt(h-(c+u))):this._v3_1.setZ(h*.5/Math.sqrt(c+u)),this._v3_1}if(n instanceof jt){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=n.position.distanceTo(this._gizmos.position),h=Math.pow(l,2),f=this._v3_1.z,d=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(d==0)return c.set(this._v3_1.x,this._v3_1.y,l),c;const m=f/d,A=u;let p=Math.pow(m,2)+1,y=2*m*A,E=Math.pow(A,2)-h,v=Math.pow(y,2)-4*p*E;if(v>=0&&(this._v2_1.setX((-y-Math.sqrt(v))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A),et.RAD2DEG*this._v2_1.angle()>=45)){const I=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(I),c.z+=u,c}p=m,y=A,E=-h*.5,v=Math.pow(y,2)-4*p*E,this._v2_1.setX((-y-Math.sqrt(v))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A);const x=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(x),c.z+=u,c}}),fe(this,"unprojectOnTbPlane",(n,s,o,a,l=!1)=>{if(n instanceof ui)return this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(n instanceof jt){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let f;if(l?f=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):f=n.position.distanceTo(this._gizmos.position),h==0)return c.set(0,0,0),c;const d=u/h,m=f,A=-m/d,p=Math.sqrt(Math.pow(m,2)+Math.pow(A,2));return c.multiplyScalar(p),c.z=0,c}}),fe(this,"updateMatrixState",()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof ui&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof jt&&(this._fovState=this.camera.fov))}),fe(this,"updateTbState",(n,s)=>{this._state=n,s&&this.updateMatrixState()}),fe(this,"update",()=>{if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const s=this.calculateTbRadius(this.camera);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof ui&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const s=et.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(s/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof jt){const s=this.camera.position.distanceTo(this._gizmos.position);if(s>this.maxDistance+1e-6||s<this.minDistance-1e-6){const l=et.clamp(s,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(l/s,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=et.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const o=this._tbRadius,a=this.calculateTbRadius(this.camera);if(a!==void 0&&(this._tbRadius=a),o<this._tbRadius-1e-6||o>this._tbRadius+1e-6){const l=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,c=this._tbRadius/l,h=new Th(0,0,c,c).getPoints(this._curvePts),f=new ki().setFromPoints(h);for(const d in this._gizmos.children){const m=this._gizmos.children[d];m.geometry=f}}}this.camera.lookAt(this._gizmos.position)}}),fe(this,"setStateFromJSON",n=>{const s=JSON.parse(n);if(s.arcballState&&this.camera){this._cameraMatrixState.fromArray(s.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(s.arcballState.cameraUp),this.camera.near=s.arcballState.cameraNear,this.camera.far=s.arcballState.cameraFar,this.camera.zoom=s.arcballState.cameraZoom,this.camera instanceof jt&&(this.camera.fov=s.arcballState.cameraFov),this._gizmoMatrixState.fromArray(s.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const o=this.calculateTbRadius(this.camera);o!==void 0&&(this._tbRadius=o);const a=new we().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(a),this.camera.lookAt(this._gizmos.position),this.updateTbState(tt.IDLE,!1),this.dispatchEvent(Jt)}}),this.camera=null,this.domElement=t,this.scene=i,this.mouseActions=[],this._mouseOp=null,this._v2_1=new De,this._v3_1=new z,this._v3_2=new z,this._m4_1=new we,this._m4_2=new we,this._quat=new nt,this._translationMatrix=new we,this._rotationMatrix=new we,this._scaleMatrix=new we,this._rotationAxis=new z,this._cameraMatrixState=new we,this._cameraProjectionState=new we,this._fovState=1,this._upState=new z,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new we,this._up0=new z,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new we,this._gizmoMatrixState0=new we,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=Ut.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new z,this._startCursorPosition=new z,this._grid=null,this._gridPosition=new z,this._gizmos=new tr,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new z,this._cursorPosCurr=new z,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new z(0,0,0),this._currentTarget=new z(0,0,0),this._tbRadius=1,this._state=tt.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if(e!=null&&e.camera&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==tt.ROTATE||this._state==tt.ZROTATE||this._state==tt.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),e!=null&&e.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==tt.SCALE||this._state==tt.FOCUS||this._state==tt.ANIMATION_FOCUS)&&this.camera){const t=this.calculateTbRadius(this.camera);if(t!==void 0&&(this._tbRadius=t),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),n=new Yt;n.setFromObject(this._gizmos);const s=new on;n.getBoundingSphere(s);const o=Math.max(this._nearPos0,s.radius+s.center.length()),a=i-this._initialNear,l=Math.min(o,a);this.camera.near=i-l;const c=Math.min(this._farPos0,-s.radius+s.center.length()),u=i-this._initialFar,h=Math.min(c,u);this.camera.far=i-h,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(Jt)}setTransformationMatrices(e=null,t=null){e?Sn.camera?Sn.camera.copy(e):Sn.camera=e.clone():Sn.camera=null,t?Sn.gizmos?Sn.gizmos.copy(t):Sn.gizmos=t.clone():Sn.gizmos=null}};var lS=Object.defineProperty,cS=(r,e,t)=>e in r?lS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Kt=(r,e,t)=>(cS(r,typeof e!="symbol"?e+"":e,t),t);function np(r){r.preventDefault()}let uS=class extends oo{constructor(e,t){super(),Kt(this,"object"),Kt(this,"domElement",null),Kt(this,"movementSpeed",1),Kt(this,"rollSpeed",.005),Kt(this,"dragToLook",!1),Kt(this,"autoForward",!1),Kt(this,"changeEvent",{type:"change"}),Kt(this,"EPS",1e-6),Kt(this,"tmpQuaternion",new nt),Kt(this,"mouseStatus",0),Kt(this,"movementSpeedMultiplier",1),Kt(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),Kt(this,"moveVector",new z(0,0,0)),Kt(this,"rotationVector",new z(0,0,0)),Kt(this,"keydown",i=>{if(!i.altKey){switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1;break}this.updateMovementVector(),this.updateRotationVector()}}),Kt(this,"keyup",i=>{switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0;break}this.updateMovementVector(),this.updateRotationVector()}),Kt(this,"pointerdown",i=>{if(this.dragToLook)this.mouseStatus++;else{switch(i.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1;break}this.updateMovementVector()}}),Kt(this,"pointermove",i=>{if(!this.dragToLook||this.mouseStatus>0){const n=this.getContainerDimensions(),s=n.size[0]/2,o=n.size[1]/2;this.moveState.yawLeft=-(i.pageX-n.offset[0]-s)/s,this.moveState.pitchDown=(i.pageY-n.offset[1]-o)/o,this.updateRotationVector()}}),Kt(this,"pointerup",i=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(i.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0;break}this.updateMovementVector()}this.updateRotationVector()}),Kt(this,"lastQuaternion",new nt),Kt(this,"lastPosition",new z),Kt(this,"update",i=>{const n=i*this.movementSpeed,s=i*this.rollSpeed;this.object.translateX(this.moveVector.x*n),this.object.translateY(this.moveVector.y*n),this.object.translateZ(this.moveVector.z*n),this.tmpQuaternion.set(this.rotationVector.x*s,this.rotationVector.y*s,this.rotationVector.z*s,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))}),Kt(this,"updateMovementVector",()=>{const i=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-i+this.moveState.back}),Kt(this,"updateRotationVector",()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}),Kt(this,"getContainerDimensions",()=>this.domElement!=document&&!(this.domElement instanceof Document)?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}),Kt(this,"connect",i=>{this.domElement=i,i instanceof Document||i.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",np),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}),Kt(this,"dispose",()=>{this.domElement.removeEventListener("contextmenu",np),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)}),this.object=e,t!==void 0&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}};var hS=Object.defineProperty,fS=(r,e,t)=>e in r?hS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Xr=(r,e,t)=>(fS(r,typeof e!="symbol"?e+"":e,t),t);class Ju{constructor(){Xr(this,"enabled",!0),Xr(this,"needsSwap",!0),Xr(this,"clear",!1),Xr(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,i,n,s){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class Zs{constructor(e){Xr(this,"camera",new ui(-1,1,1,-1,0,1)),Xr(this,"geometry",new nn(2,2)),Xr(this,"mesh"),this.mesh=new Qe(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var dS=Object.defineProperty,mS=(r,e,t)=>e in r?dS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,lc=(r,e,t)=>(mS(r,typeof e!="symbol"?e+"":e,t),t);class Ud extends Ju{constructor(e,t="tDiffuse"){super(),lc(this,"textureID"),lc(this,"uniforms"),lc(this,"material"),lc(this,"fsQuad"),this.textureID=t,e instanceof gi?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=la.clone(e.uniforms),this.material=new gi({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new Zs(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const sp={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform float opacity;

    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );
    	gl_FragColor = opacity * texel;

    }
  `};var AS=Object.defineProperty,pS=(r,e,t)=>e in r?AS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Oh=(r,e,t)=>(pS(r,typeof e!="symbol"?e+"":e,t),t);class rp extends Ju{constructor(e,t){super(),Oh(this,"scene"),Oh(this,"camera"),Oh(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const n=e.getContext(),s=e.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),s.buffers.stencil.setFunc(n.ALWAYS,o,4294967295),s.buffers.stencil.setClear(a),s.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(n.EQUAL,1,4294967295),s.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),s.buffers.stencil.setLocked(!0)}}class gS extends Ju{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var yS=Object.defineProperty,vS=(r,e,t)=>e in r?yS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Un=(r,e,t)=>(vS(r,typeof e!="symbol"?e+"":e,t),t);class ES{constructor(e,t){if(Un(this,"renderer"),Un(this,"_pixelRatio"),Un(this,"_width"),Un(this,"_height"),Un(this,"renderTarget1"),Un(this,"renderTarget2"),Un(this,"writeBuffer"),Un(this,"readBuffer"),Un(this,"renderToScreen"),Un(this,"passes",[]),Un(this,"copyPass"),Un(this,"clock"),this.renderer=e,t===void 0){const i={minFilter:Ht,magFilter:Ht,format:wi},n=e.getSize(new De);this._pixelRatio=e.getPixelRatio(),this._width=n.width,this._height=n.height,t=new Ti(this._width*this._pixelRatio,this._height*this._pixelRatio,i),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,sp===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),Ud===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new Ud(sp),this.copyPass.material.blending=T0,this.clock=new bx}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;const n=this.passes.length;for(let s=0;s<n;s++){const o=this.passes[s];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),o.needsSwap){if(i){const a=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),l.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}rp!==void 0&&(o instanceof rp?i=!0:o instanceof gS&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new De);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(i,n),this.renderTarget2.setSize(i,n);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(i,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var xS=Object.defineProperty,CS=(r,e,t)=>e in r?xS(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,kr=(r,e,t)=>(CS(r,typeof e!="symbol"?e+"":e,t),t);class IS extends Ju{constructor(e,t,i,n,s=0){super(),kr(this,"scene"),kr(this,"camera"),kr(this,"overrideMaterial"),kr(this,"clearColor"),kr(this,"clearAlpha"),kr(this,"clearDepth",!1),kr(this,"_oldClearColor",new Ye),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=s,this.clear=!0,this.needsSwap=!1}render(e,t,i){let n=e.autoClear;e.autoClear=!1;let s,o=null;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,s),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=n}}function ua(r){if(typeof TextDecoder<"u")return new TextDecoder().decode(r);let e="";for(let t=0,i=r.length;t<i;t++)e+=String.fromCharCode(r[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const qr="srgb",ir="srgb-linear",op=3001,_S=3e3;class U0 extends Dr{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new BS(t)}),this.register(function(t){return new RS(t)}),this.register(function(t){return new NS(t)}),this.register(function(t){return new GS(t)}),this.register(function(t){return new QS(t)}),this.register(function(t){return new MS(t)}),this.register(function(t){return new LS(t)}),this.register(function(t){return new PS(t)}),this.register(function(t){return new FS(t)}),this.register(function(t){return new wS(t)}),this.register(function(t){return new kS(t)}),this.register(function(t){return new DS(t)}),this.register(function(t){return new US(t)}),this.register(function(t){return new OS(t)}),this.register(function(t){return new TS(t)}),this.register(function(t){return new zS(t)}),this.register(function(t){return new HS(t)})}load(e,t,i,n){const s=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=ea.extractUrlBase(e);o=ea.resolveURL(c,this.path)}else o=ea.extractUrlBase(e);this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),s.manager.itemError(e),s.manager.itemEnd(e)},l=new vn(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{s.parse(c,o,function(u){t(u),s.manager.itemEnd(e)},a)}catch(u){a(u)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let s;const o={},a={};if(typeof e=="string")s=JSON.parse(e);else if(e instanceof ArrayBuffer)if(ua(new Uint8Array(e.slice(0,4)))===W2){try{o[It.KHR_BINARY_GLTF]=new VS(e)}catch(u){n&&n(u);return}s=JSON.parse(o[It.KHR_BINARY_GLTF].content)}else s=JSON.parse(ua(new Uint8Array(e)));else s=e;if(s.asset===void 0||s.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new nT(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const u=this.pluginCallbacks[c](l);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const u=s.extensionsUsed[c],h=s.extensionsRequired||[];switch(u){case It.KHR_MATERIALS_UNLIT:o[u]=new bS;break;case It.KHR_DRACO_MESH_COMPRESSION:o[u]=new KS(s,this.dracoLoader);break;case It.KHR_TEXTURE_TRANSFORM:o[u]=new $S;break;case It.KHR_MESH_QUANTIZATION:o[u]=new YS;break;default:h.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(o),l.setPlugins(a),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise(function(n,s){i.parse(e,t,n,s)})}}function SS(){let r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}const It={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class TS{constructor(e){this.parser=e,this.name=It.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const s=t[i];s.extensions&&s.extensions[this.name]&&s.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const s=t.json,l=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let c;const u=new Ye(16777215);l.color!==void 0&&u.setRGB(l.color[0],l.color[1],l.color[2],ir);const h=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new Ky(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Id(u),c.distance=h;break;case"spot":c=new Vy(u),c.distance=h,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,js(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),n=Promise.resolve(c),t.cache.add(i,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,s=i.json.nodes[e],a=(s.extensions&&s.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return i._getNodeRef(t.cache,a,l)})}}class bS{constructor(){this.name=It.KHR_MATERIALS_UNLIT}getMaterialType(){return ds}extendParams(e,t,i){const n=[];e.color=new Ye(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const o=s.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],ir),e.opacity=o[3]}s.baseColorTexture!==void 0&&n.push(i.assignTexture(e,"map",s.baseColorTexture,qr))}return Promise.all(n)}}class wS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name].emissiveStrength;return s!==void 0&&(t.emissiveIntensity=s),Promise.resolve()}}class BS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(s.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new De(a,a)}return Promise.all(s)}}class RS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.dispersion=s.dispersion!==void 0?s.dispersion:0,Promise.resolve()}}class DS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class MS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new Ye(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],ir)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&s.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,qr)),o.sheenRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class LS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&s.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class PS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&s.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new Ye().setRGB(a[0],a[1],a[2],ir),Promise.all(s)}}class FS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.ior=s.ior!==void 0?s.ior:1.5,Promise.resolve()}}class kS{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&s.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new Ye().setRGB(a[0],a[1],a[2],ir),o.specularColorTexture!==void 0&&s.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,qr)),Promise.all(s)}}class OS{constructor(e){this.parser=e,this.name=It.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&s.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(s)}}class US{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Zn}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&s.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class NS{constructor(e){this.parser=e,this.name=It.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class GS{constructor(e){this.parser=e,this.name=It.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class QS{constructor(e){this.parser=e,this.name=It.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class zS{constructor(e){this.name=It.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const n=i.extensions[this.name],s=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,u=n.count,h=n.byteStride,f=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(u,h,f,n.mode,n.filter).then(function(d){return d.buffer}):o.ready.then(function(){const d=new ArrayBuffer(u*h);return o.decodeGltfBuffer(new Uint8Array(d),u,h,f,n.mode,n.filter),d})})}else return null}}class HS{constructor(e){this.name=It.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const n=t.meshes[i.mesh];for(const c of n.primitives)if(c.mode!==zn.TRIANGLES&&c.mode!==zn.TRIANGLE_STRIP&&c.mode!==zn.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=i.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(u=>(l[c]=u,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const u=c.pop(),h=u.isGroup?u.children:[u],f=c[0].count,d=[];for(const m of h){const A=new we,p=new z,y=new nt,E=new z(1,1,1),v=new _0(m.geometry,m.material,f);for(let x=0;x<f;x++)l.TRANSLATION&&p.fromBufferAttribute(l.TRANSLATION,x),l.ROTATION&&y.fromBufferAttribute(l.ROTATION,x),l.SCALE&&E.fromBufferAttribute(l.SCALE,x),v.setMatrixAt(x,A.compose(p,y,E));for(const x in l)if(x==="_COLOR_0"){const C=l[x];v.instanceColor=new wl(C.array,C.itemSize,C.normalized)}else x!=="TRANSLATION"&&x!=="ROTATION"&&x!=="SCALE"&&m.geometry.setAttribute(x,l[x]);mi.prototype.copy.call(v,m),this.parser.assignFinalMaterial(v),d.push(v)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const W2="glTF",Fa=12,ap={JSON:1313821514,BIN:5130562};class VS{constructor(e){this.name=It.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Fa);if(this.header={magic:ua(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==W2)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-Fa,n=new DataView(e,Fa);let s=0;for(;s<i;){const o=n.getUint32(s,!0);s+=4;const a=n.getUint32(s,!0);if(s+=4,a===ap.JSON){const l=new Uint8Array(e,Fa+s,o);this.content=ua(l)}else if(a===ap.BIN){const l=Fa+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class KS{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=It.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const u in o){const h=Nd[u]||u.toLowerCase();a[h]=o[u]}for(const u in e.attributes){const h=Nd[u]||u.toLowerCase();if(o[u]!==void 0){const f=i.accessors[e.attributes[u]],d=na[f.componentType];c[h]=d.name,l[h]=f.normalized===!0}}return t.getDependency("bufferView",s).then(function(u){return new Promise(function(h,f){n.decodeDracoFile(u,function(d){for(const m in d.attributes){const A=d.attributes[m],p=l[m];p!==void 0&&(A.normalized=p)}h(d)},a,c,ir,f)})})}}class $S{constructor(){this.name=It.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class YS{constructor(){this.name=It.KHR_MESH_QUANTIZATION}}class j2 extends Ux{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=i[s+o];return t}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,u=n-t,h=(i-t)/u,f=h*h,d=f*h,m=e*c,A=m-c,p=-2*d+3*f,y=d-f,E=1-p,v=y-f+h;for(let x=0;x!==a;x++){const C=o[A+x+a],I=o[A+x+l]*u,_=o[m+x+a],S=o[m+x]*u;s[x]=E*C+v*I+p*_+y*S}return s}}const WS=new nt;class jS extends j2{interpolate_(e,t,i,n){const s=super.interpolate_(e,t,i,n);return WS.fromArray(s).normalize().toArray(s),s}}const zn={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},na={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},lp={9728:Xt,9729:Ht,9984:Lx,9985:Px,9986:Fx,9987:Nl},cp={33071:Bn,33648:kx,10497:Pn},Uh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Nd={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...pa>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},hr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},XS={CUBICSPLINE:void 0,LINEAR:Wy,STEP:Ox},Nh={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function qS(r){return r.DefaultMaterial===void 0&&(r.DefaultMaterial=new $u({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Rl})),r.DefaultMaterial}function Or(r,e,t){for(const i in t.extensions)r[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function js(r,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(r.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function JS(r,e,t){let i=!1,n=!1,s=!1;for(let c=0,u=e.length;c<u;c++){const h=e[c];if(h.POSITION!==void 0&&(i=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(s=!0),i&&n&&s)break}if(!i&&!n&&!s)return Promise.resolve(r);const o=[],a=[],l=[];for(let c=0,u=e.length;c<u;c++){const h=e[c];if(i){const f=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):r.attributes.position;o.push(f)}if(n){const f=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):r.attributes.normal;a.push(f)}if(s){const f=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):r.attributes.color;l.push(f)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const u=c[0],h=c[1],f=c[2];return i&&(r.morphAttributes.position=u),n&&(r.morphAttributes.normal=h),s&&(r.morphAttributes.color=f),r.morphTargetsRelative=!0,r})}function ZS(r,e){if(r.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)r.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(r.morphTargetInfluences.length===t.length){r.morphTargetDictionary={};for(let i=0,n=t.length;i<n;i++)r.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function eT(r){let e;const t=r.extensions&&r.extensions[It.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Gh(t.attributes):e=r.indices+":"+Gh(r.attributes)+":"+r.mode,r.targets!==void 0)for(let i=0,n=r.targets.length;i<n;i++)e+=":"+Gh(r.targets[i]);return e}function Gh(r){let e="";const t=Object.keys(r).sort();for(let i=0,n=t.length;i<n;i++)e+=t[i]+":"+r[t[i]]+";";return e}function Gd(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function tT(r){return r.search(/\.jpe?g($|\?)/i)>0||r.search(/^data\:image\/jpeg/)===0?"image/jpeg":r.search(/\.webp($|\?)/i)>0||r.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const iT=new we;class nT{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new SS,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||i||n&&s<98?this.textureLoader=new nr(this.options.manager):this.textureLoader=new wx(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new vn(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:i,userData:{}};return Or(s,a,n),js(a,n),Promise.all(i._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){for(const l of a.scenes)l.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const o=t[n].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),s=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,u]of o.children.entries())s(u,a.children[c])};return s(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&i.push(s)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(s){return s.loadNode&&s.loadNode(t)});break;case"mesh":n=this._invokeOne(function(s){return s.loadMesh&&s.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(s){return s.loadBufferView&&s.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(s){return s.loadMaterial&&s.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(s){return s.loadTexture&&s.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(s){return s.loadAnimation&&s.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(s,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[It.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(s,o){i.load(ea.resolveURL(t.uri,n.path),s,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const n=t.byteLength||0,s=t.byteOffset||0;return i.slice(s,s+n)})}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Uh[n.type],a=na[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new Nt(c,o,l))}const s=[];return n.bufferView!==void 0?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),n.sparse!==void 0&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then(function(o){const a=o[0],l=Uh[n.type],c=na[n.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=n.byteOffset||0,d=n.bufferView!==void 0?i.bufferViews[n.bufferView].byteStride:void 0,m=n.normalized===!0;let A,p;if(d&&d!==h){const y=Math.floor(f/d),E="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+y+":"+n.count;let v=t.cache.get(E);v||(A=new c(a,y*d,n.count*d/u),v=new Bx(A,d/u),t.cache.add(E,v)),p=new jr(v,l,f%d/u,m)}else a===null?A=new c(n.count*l):A=new c(a,f,n.count*l),p=new Nt(A,l,m);if(n.sparse!==void 0){const y=Uh.SCALAR,E=na[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,x=n.sparse.values.byteOffset||0,C=new E(o[1],v,n.sparse.count*y),I=new c(o[2],x,n.sparse.count*l);a!==null&&(p=new Nt(p.array.slice(),p.itemSize,p.normalized));for(let _=0,S=C.length;_<S;_++){const b=C[_];if(p.setX(b,I[_*l]),l>=2&&p.setY(b,I[_*l+1]),l>=3&&p.setZ(b,I[_*l+2]),l>=4&&p.setW(b,I[_*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(e){const t=this.json,i=this.options,s=t.textures[e].source,o=t.images[s];let a=this.textureLoader;if(o.uri){const l=i.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,s,a)}loadTextureImage(e,t,i){const n=this,s=this.json,o=s.textures[e],a=s.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,i).then(function(u){u.flipY=!1,u.name=o.name||a.name||"",u.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(u.name=a.uri);const f=(s.samplers||{})[o.sampler]||{};return u.magFilter=lp[f.magFilter]||Ht,u.minFilter=lp[f.minFilter]||Nl,u.wrapS=cp[f.wrapS]||Pn,u.wrapT=cp[f.wrapT]||Pn,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){const i=this,n=this.json,s=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=n.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1;if(o.bufferView!==void 0)l=i.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const f=new Blob([h],{type:o.mimeType});return l=a.createObjectURL(f),l});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(l).then(function(h){return new Promise(function(f,d){let m=f;t.isImageBitmapLoader===!0&&(m=function(A){const p=new qi(A);p.needsUpdate=!0,f(p)}),t.load(ea.resolveURL(h,s.path),m,void 0,d)})}).then(function(h){return c===!0&&a.revokeObjectURL(l),js(h,o),h.userData.mimeType=o.mimeType||tT(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),h});return this.sourceCache[e]=u,u}assignTexture(e,t,i,n){const s=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),s.extensions[It.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[It.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=s.associations.get(o);o=s.extensions[It.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),s.associations.set(o,l)}}return n!==void 0&&(typeof n=="number"&&(n=n===op?qr:ir),"colorSpace"in o?o.colorSpace=n:o.encoding=n===qr?op:_S),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=t.attributes.tangent===void 0,s=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new $y,cu.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,l.sizeAttenuation=!1,this.cache.add(a,l)),i=l}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new Zo,cu.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,this.cache.add(a,l)),i=l}if(n||s||o){let a="ClonedMaterial:"+i.uuid+":";n&&(a+="derivative-tangents:"),s&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=i.clone(),s&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(i))),i=l}e.material=i}getMaterialType(){return $u}loadMaterial(e){const t=this,i=this.json,n=this.extensions,s=i.materials[e];let o;const a={},l=s.extensions||{},c=[];if(l[It.KHR_MATERIALS_UNLIT]){const h=n[It.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(a,s,t))}else{const h=s.pbrMetallicRoughness||{};if(a.color=new Ye(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const f=h.baseColorFactor;a.color.setRGB(f[0],f[1],f[2],ir),a.opacity=f[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",h.baseColorTexture,qr)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,a)})))}s.doubleSided===!0&&(a.side=xi);const u=s.alphaMode||Nh.OPAQUE;if(u===Nh.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===Nh.MASK&&(a.alphaTest=s.alphaCutoff!==void 0?s.alphaCutoff:.5)),s.normalTexture!==void 0&&o!==ds&&(c.push(t.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new De(1,1),s.normalTexture.scale!==void 0)){const h=s.normalTexture.scale;a.normalScale.set(h,h)}if(s.occlusionTexture!==void 0&&o!==ds&&(c.push(t.assignTexture(a,"aoMap",s.occlusionTexture)),s.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=s.occlusionTexture.strength)),s.emissiveFactor!==void 0&&o!==ds){const h=s.emissiveFactor;a.emissive=new Ye().setRGB(h[0],h[1],h[2],ir)}return s.emissiveTexture!==void 0&&o!==ds&&c.push(t.assignTexture(a,"emissiveMap",s.emissiveTexture,qr)),Promise.all(c).then(function(){const h=new o(a);return s.name&&(h.name=s.name),js(h,s),t.associations.set(h,{materials:e}),s.extensions&&Or(n,h,s),h})}createUniqueName(e){const t=Bl.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function s(a){return i[It.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return up(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],u=eT(c),h=n[u];if(h)o.push(h.promise);else{let f;c.extensions&&c.extensions[It.KHR_DRACO_MESH_COMPRESSION]?f=s(c):f=up(new ki,c,t),n[u]={primitive:c,promise:f},o.push(f)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,n=this.extensions,s=i.meshes[e],o=s.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const u=o[l].material===void 0?qS(this.cache):this.getDependency("material",o[l].material);a.push(u)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),u=l[l.length-1],h=[];for(let d=0,m=u.length;d<m;d++){const A=u[d],p=o[d];let y;const E=c[d];if(p.mode===zn.TRIANGLES||p.mode===zn.TRIANGLE_STRIP||p.mode===zn.TRIANGLE_FAN||p.mode===void 0)y=s.isSkinnedMesh===!0?new b0(A,E):new Qe(A,E),y.isSkinnedMesh===!0&&y.normalizeSkinWeights(),p.mode===zn.TRIANGLE_STRIP?y.geometry=XA(y.geometry,Qy):p.mode===zn.TRIANGLE_FAN&&(y.geometry=XA(y.geometry,Cd));else if(p.mode===zn.LINES)y=new Rx(A,E);else if(p.mode===zn.LINE_STRIP)y=new St(A,E);else if(p.mode===zn.LINE_LOOP)y=new Dx(A,E);else if(p.mode===zn.POINTS)y=new Mx(A,E);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(y.geometry.morphAttributes).length>0&&ZS(y,s),y.name=t.createUniqueName(s.name||"mesh_"+e),js(y,s),p.extensions&&Or(n,y,p),t.assignFinalMaterial(y),h.push(y)}for(let d=0,m=h.length;d<m;d++)t.associations.set(h[d],{meshes:e,primitives:d});if(h.length===1)return s.extensions&&Or(n,h[0],s),h[0];const f=new tr;s.extensions&&Or(n,f,s),t.associations.set(f,{meshes:e});for(let d=0,m=h.length;d<m;d++)f.add(h[d]);return f})}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new jt(et.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):i.type==="orthographic"&&(t=new ui(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),js(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let n=0,s=t.joints.length;n<s;n++)i.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(n){const s=n.pop(),o=n,a=[],l=[];for(let c=0,u=o.length;c<u;c++){const h=o[c];if(h){a.push(h);const f=new we;s!==null&&f.fromArray(s.array,c*16),l.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new Yy(a,l)})}loadAnimation(e){const t=this.json,i=this,n=t.animations[e],s=n.name?n.name:"animation_"+e,o=[],a=[],l=[],c=[],u=[];for(let h=0,f=n.channels.length;h<f;h++){const d=n.channels[h],m=n.samplers[d.sampler],A=d.target,p=A.node,y=n.parameters!==void 0?n.parameters[m.input]:m.input,E=n.parameters!==void 0?n.parameters[m.output]:m.output;A.node!==void 0&&(o.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",y)),l.push(this.getDependency("accessor",E)),c.push(m),u.push(A))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(h){const f=h[0],d=h[1],m=h[2],A=h[3],p=h[4],y=[];for(let E=0,v=f.length;E<v;E++){const x=f[E],C=d[E],I=m[E],_=A[E],S=p[E];if(x===void 0)continue;x.updateMatrix&&x.updateMatrix();const b=i._createAnimationTracks(x,C,I,_,S);if(b)for(let T=0;T<b.length;T++)y.push(b[T])}return new S0(s,void 0,y)})}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return n.mesh===void 0?null:i.getDependency("mesh",n.mesh).then(function(s){const o=i._getNodeRef(i.meshCache,n.mesh,s);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(e){const t=this.json,i=this,n=t.nodes[e],s=i._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,u=a.length;c<u;c++)o.push(i.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):i.getDependency("skin",n.skin);return Promise.all([s,Promise.all(o),l]).then(function(c){const u=c[0],h=c[1],f=c[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,iT)});for(let d=0,m=h.length;d<m;d++)u.add(h[d]);return u})}_loadNodeShallow(e){const t=this.json,i=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),s.camera!==void 0&&a.push(n.getDependency("camera",s.camera).then(function(c){return n._getNodeRef(n.cameraCache,s.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let u;if(s.isBone===!0?u=new _d:c.length>1?u=new tr:c.length===1?u=c[0]:u=new mi,u!==c[0])for(let h=0,f=c.length;h<f;h++)u.add(c[h]);if(s.name&&(u.userData.name=s.name,u.name=o),js(u,s),s.extensions&&Or(i,u,s),s.matrix!==void 0){const h=new we;h.fromArray(s.matrix),u.applyMatrix4(h)}else s.translation!==void 0&&u.position.fromArray(s.translation),s.rotation!==void 0&&u.quaternion.fromArray(s.rotation),s.scale!==void 0&&u.scale.fromArray(s.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,s=new tr;i.name&&(s.name=n.createUniqueName(i.name)),js(s,i),i.extensions&&Or(t,s,i);const o=i.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let u=0,h=l.length;u<h;u++)s.add(l[u]);const c=u=>{const h=new Map;for(const[f,d]of n.associations)(f instanceof cu||f instanceof qi)&&h.set(f,d);return u.traverse(f=>{const d=n.associations.get(f);d!=null&&h.set(f,d)}),h};return n.associations=c(s),s})}_createAnimationTracks(e,t,i,n,s){const o=[],a=e.name?e.name:e.uuid,l=[];hr[s.path]===hr.weights?e.traverse(function(f){f.morphTargetInfluences&&l.push(f.name?f.name:f.uuid)}):l.push(a);let c;switch(hr[s.path]){case hr.weights:c=Sd;break;case hr.rotation:c=Tu;break;case hr.position:case hr.scale:c=Su;break;default:switch(i.itemSize){case 1:c=Sd;break;case 2:case 3:default:c=Su;break}break}const u=n.interpolation!==void 0?XS[n.interpolation]:Wy,h=this._getArrayFromAccessor(i);for(let f=0,d=l.length;f<d;f++){const m=new c(l[f]+"."+hr[s.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),o.push(m)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=Gd(t.constructor),n=new Float32Array(t.length);for(let s=0,o=t.length;s<o;s++)n[s]=t[s]*i;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const n=this instanceof Tu?jS:j2;return new n(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function sT(r,e,t){const i=e.attributes,n=new Yt;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new z(l[0],l[1],l[2]),new z(c[0],c[1],c[2])),a.normalized){const u=Gd(na[a.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const s=e.targets;if(s!==void 0){const a=new z,l=new z;for(let c=0,u=s.length;c<u;c++){const h=s[c];if(h.POSITION!==void 0){const f=t.json.accessors[h.POSITION],d=f.min,m=f.max;if(d!==void 0&&m!==void 0){if(l.setX(Math.max(Math.abs(d[0]),Math.abs(m[0]))),l.setY(Math.max(Math.abs(d[1]),Math.abs(m[1]))),l.setZ(Math.max(Math.abs(d[2]),Math.abs(m[2]))),f.normalized){const A=Gd(na[f.componentType]);l.multiplyScalar(A)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}r.boundingBox=n;const o=new on;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,r.boundingSphere=o}function up(r,e,t){const i=e.attributes,n=[];function s(o,a){return t.getDependency("accessor",o).then(function(l){r.setAttribute(a,l)})}for(const o in i){const a=Nd[o]||o.toLowerCase();a in r.attributes||n.push(s(i[o],a))}if(e.indices!==void 0&&!r.index){const o=t.getDependency("accessor",e.indices).then(function(a){r.setIndex(a)});n.push(o)}return js(r,e),sT(r,e,t),Promise.all(n).then(function(){return e.targets!==void 0?JS(r,e.targets,t):r})}class rT extends ki{constructor(e,t,i,n){super();const s=[],o=[],a=[],l=new z,c=new we;c.makeRotationFromEuler(i),c.setPosition(t);const u=new we;u.copy(c).invert(),h(),this.setAttribute("position",new Vi(s,3)),this.setAttribute("normal",new Vi(o,3)),this.setAttribute("uv",new Vi(a,2));function h(){let A,p=[];const y=new z,E=new z;if(e.geometry.isGeometry===!0){console.error("THREE.DecalGeometry no longer supports THREE.Geometry. Use BufferGeometry instead.");return}const v=e.geometry,x=v.attributes.position,C=v.attributes.normal;if(v.index!==null){const I=v.index;for(A=0;A<I.count;A++)y.fromBufferAttribute(x,I.getX(A)),E.fromBufferAttribute(C,I.getX(A)),f(p,y,E)}else for(A=0;A<x.count;A++)y.fromBufferAttribute(x,A),E.fromBufferAttribute(C,A),f(p,y,E);for(p=d(p,l.set(1,0,0)),p=d(p,l.set(-1,0,0)),p=d(p,l.set(0,1,0)),p=d(p,l.set(0,-1,0)),p=d(p,l.set(0,0,1)),p=d(p,l.set(0,0,-1)),A=0;A<p.length;A++){const I=p[A];a.push(.5+I.position.x/n.x,.5+I.position.y/n.y),I.position.applyMatrix4(c),s.push(I.position.x,I.position.y,I.position.z),o.push(I.normal.x,I.normal.y,I.normal.z)}}function f(A,p,y){p.applyMatrix4(e.matrixWorld),p.applyMatrix4(u),y.transformDirection(e.matrixWorld),A.push(new hp(p.clone(),y.clone()))}function d(A,p){const y=[],E=.5*Math.abs(n.dot(p));for(let v=0;v<A.length;v+=3){let x,C,I,_=0,S,b,T,R;const w=A[v+0].position.dot(p)-E,B=A[v+1].position.dot(p)-E,D=A[v+2].position.dot(p)-E;switch(x=w>0,C=B>0,I=D>0,_=(x?1:0)+(C?1:0)+(I?1:0),_){case 0:{y.push(A[v]),y.push(A[v+1]),y.push(A[v+2]);break}case 1:{if(x&&(S=A[v+1],b=A[v+2],T=m(A[v],S,p,E),R=m(A[v],b,p,E)),C){S=A[v],b=A[v+2],T=m(A[v+1],S,p,E),R=m(A[v+1],b,p,E),y.push(T),y.push(b.clone()),y.push(S.clone()),y.push(b.clone()),y.push(T.clone()),y.push(R);break}I&&(S=A[v],b=A[v+1],T=m(A[v+2],S,p,E),R=m(A[v+2],b,p,E)),y.push(S.clone()),y.push(b.clone()),y.push(T),y.push(R),y.push(T.clone()),y.push(b.clone());break}case 2:{x||(S=A[v].clone(),b=m(S,A[v+1],p,E),T=m(S,A[v+2],p,E),y.push(S),y.push(b),y.push(T)),C||(S=A[v+1].clone(),b=m(S,A[v+2],p,E),T=m(S,A[v],p,E),y.push(S),y.push(b),y.push(T)),I||(S=A[v+2].clone(),b=m(S,A[v],p,E),T=m(S,A[v+1],p,E),y.push(S),y.push(b),y.push(T));break}}}return y}function m(A,p,y,E){const v=A.position.dot(y)-E,x=p.position.dot(y)-E,C=v/(v-x);return new hp(new z(A.position.x+C*(p.position.x-A.position.x),A.position.y+C*(p.position.y-A.position.y),A.position.z+C*(p.position.z-A.position.z)),new z(A.normal.x+C*(p.normal.x-A.normal.x),A.normal.y+C*(p.normal.y-A.normal.y),A.normal.z+C*(p.normal.z-A.normal.z)))}}}class hp{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}class oT extends Nx{constructor(e,t={}){const{bevelEnabled:i=!1,bevelSize:n=8,bevelThickness:s=10,font:o,height:a=50,size:l=100,lineHeight:c=1,letterSpacing:u=0,...h}=t;if(o===void 0)super();else{const f=o.generateShapes(e,l,{lineHeight:c,letterSpacing:u});super(f,{...h,bevelEnabled:i,bevelSize:n,bevelThickness:s,depth:a})}this.type="TextGeometry"}}const aT={uniforms:{tDiffuse:{value:null}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 tex = texture2D( tDiffuse, vUv );

    	#ifdef LinearTosRGB
    		gl_FragColor = LinearTosRGB( tex );
    	#else
    		gl_FragColor = sRGBTransferOETF( tex );
    	#endif

    }
  `},lT={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},cT={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `},Qh=new jy,zh=new z,go=new z,ls=new z,Qs=new z,ys=new z,zs=new z,Hs=new z,ka=new z,Oa=new z,Ua=new z,cc=new z,Na=new z,Ga=new z,Qa=new z;class uT{constructor(e,t,i){this.camera=e,this.scene=t,this.startPoint=new z,this.endPoint=new z,this.collection=[],this.deep=i||Number.MAX_VALUE}select(e,t){return this.startPoint=e||this.startPoint,this.endPoint=t||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(Qh,this.scene),this.collection}updateFrustum(e,t){if(e=e||this.startPoint,t=t||this.endPoint,e.x===t.x&&(t.x+=Number.EPSILON),e.y===t.y&&(t.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.isPerspectiveCamera){go.copy(e),go.x=Math.min(e.x,t.x),go.y=Math.max(e.y,t.y),t.x=Math.max(e.x,t.x),t.y=Math.min(e.y,t.y),ls.setFromMatrixPosition(this.camera.matrixWorld),Qs.copy(go),ys.set(t.x,go.y,0),zs.copy(t),Hs.set(go.x,t.y,0),Qs.unproject(this.camera),ys.unproject(this.camera),zs.unproject(this.camera),Hs.unproject(this.camera),Na.copy(Qs).sub(ls),Ga.copy(ys).sub(ls),Qa.copy(zs).sub(ls),Na.normalize(),Ga.normalize(),Qa.normalize(),Na.multiplyScalar(this.deep),Ga.multiplyScalar(this.deep),Qa.multiplyScalar(this.deep),Na.add(ls),Ga.add(ls),Qa.add(ls);var i=Qh.planes;i[0].setFromCoplanarPoints(ls,Qs,ys),i[1].setFromCoplanarPoints(ls,ys,zs),i[2].setFromCoplanarPoints(zs,Hs,ls),i[3].setFromCoplanarPoints(Hs,Qs,ls),i[4].setFromCoplanarPoints(ys,zs,Hs),i[5].setFromCoplanarPoints(Qa,Ga,Na),i[5].normal.multiplyScalar(-1)}else if(this.camera.isOrthographicCamera){const n=Math.min(e.x,t.x),s=Math.max(e.y,t.y),o=Math.max(e.x,t.x),a=Math.min(e.y,t.y);Qs.set(n,s,-1),ys.set(o,s,-1),zs.set(o,a,-1),Hs.set(n,a,-1),ka.set(n,s,1),Oa.set(o,s,1),Ua.set(o,a,1),cc.set(n,a,1),Qs.unproject(this.camera),ys.unproject(this.camera),zs.unproject(this.camera),Hs.unproject(this.camera),ka.unproject(this.camera),Oa.unproject(this.camera),Ua.unproject(this.camera),cc.unproject(this.camera);var i=Qh.planes;i[0].setFromCoplanarPoints(Qs,ka,Oa),i[1].setFromCoplanarPoints(ys,Oa,Ua),i[2].setFromCoplanarPoints(Ua,cc,Hs),i[3].setFromCoplanarPoints(cc,ka,Qs),i[4].setFromCoplanarPoints(ys,zs,Hs),i[5].setFromCoplanarPoints(Ua,Oa,ka),i[5].normal.multiplyScalar(-1)}else console.error("THREE.SelectionBox: Unsupported camera type.")}searchChildInFrustum(e,t){if((t.isMesh||t.isLine||t.isPoints)&&t.material!==void 0&&(t.geometry.boundingSphere===null&&t.geometry.computeBoundingSphere(),zh.copy(t.geometry.boundingSphere.center),zh.applyMatrix4(t.matrixWorld),e.containsPoint(zh)&&this.collection.push(t)),t.children.length>0)for(let i=0;i<t.children.length;i++)this.searchChildInFrustum(e,t.children[i])}}class hT{constructor(e,t=" .:-=+*#%@",i={}){const n=i.resolution||.15,s=i.scale||1,o=i.color||!1,a=i.alpha||!1,l=i.block||!1,c=i.invert||!1,u=i.strResolution||"low";let h,f;const d=document.createElement("div");d.style.cursor="default";const m=document.createElement("table");d.appendChild(m);let A,p,y;this.setSize=function(D,k){h=D,f=k,e.setSize(D,k),E()},this.render=function(D,k){e.render(D,k),B(m)},this.domElement=d;function E(){A=Math.floor(h*n),p=Math.floor(f*n),_.width=A,_.height=p,y=e.domElement,y.style.backgroundColor&&(m.rows[0].cells[0].style.backgroundColor=y.style.backgroundColor,m.rows[0].cells[0].style.color=y.style.color),m.cellSpacing=0,m.cellPadding=0;const D=m.style;D.whiteSpace="pre",D.margin="0px",D.padding="0px",D.letterSpacing=w+"px",D.fontFamily=C,D.fontSize=T+"px",D.lineHeight=R+"px",D.textAlign="left",D.textDecoration="none"}const v=" .,:;i1tfLCG08@".split(""),x=" CGO08@".split(""),C="courier new, monospace",I=e.domElement,_=document.createElement("canvas");if(!_.getContext)return;const S=_.getContext("2d");if(!S.getImageData)return;let b=o?x:v;t&&(b=t);const T=2/n*s,R=2/n*s;let w=0;if(u=="low")switch(s){case 1:w=-1;break;case 2:case 3:w=-2.1;break;case 4:w=-3.1;break;case 5:w=-4.15;break}if(u=="medium")switch(s){case 1:w=0;break;case 2:w=-1;break;case 3:w=-1.04;break;case 4:case 5:w=-2.1;break}if(u=="high")switch(s){case 1:case 2:w=0;break;case 3:case 4:case 5:w=-1;break}function B(D){S.clearRect(0,0,A,p),S.drawImage(I,0,0,A,p);const k=S.getImageData(0,0,A,p).data;let Q="";for(let Y=0;Y<p;Y+=2){for(let W=0;W<A;W++){const P=(Y*A+W)*4,K=k[P],M=k[P+1],V=k[P+2],$=k[P+3];let G,O;O=(.3*K+.59*M+.11*V)/255,$==0&&(O=1),G=Math.floor((1-O)*(b.length-1)),c&&(G=b.length-G-1);let F=b[G];(F===void 0||F==" ")&&(F="&nbsp;"),o?Q+="<span style='color:rgb("+K+","+M+","+V+");"+(l?"background-color:rgb("+K+","+M+","+V+");":"")+(a?"opacity:"+$/255+";":"")+"'>"+F+"</span>":Q+=F}Q+="<br/>"}D.innerHTML=`<tr><td style="display:block;width:${h}px;height:${f}px;overflow:hidden">${Q}</td></tr>`}}}function X2(r,e,t){const i=t.length-r-1;if(e>=t[i])return i-1;if(e<=t[r])return r;let n=r,s=i,o=Math.floor((n+s)/2);for(;e<t[o]||e>=t[o+1];)e<t[o]?s=o:n=o,o=Math.floor((n+s)/2);return o}function fT(r,e,t,i){const n=[],s=[],o=[];n[0]=1;for(let a=1;a<=t;++a){s[a]=e-i[r+1-a],o[a]=i[r+a]-e;let l=0;for(let c=0;c<a;++c){const u=o[c+1],h=s[a-c],f=n[c]/(u+h);n[c]=l+u*f,l=h*f}n[a]=l}return n}function dT(r,e,t,i){const n=X2(r,i,e),s=fT(n,i,r,e),o=new Ci(0,0,0,0);for(let a=0;a<=r;++a){const l=t[n-r+a],c=s[a],u=l.w*c;o.x+=l.x*u,o.y+=l.y*u,o.z+=l.z*u,o.w+=l.w*c}return o}function mT(r,e,t,i,n){const s=[];for(let h=0;h<=t;++h)s[h]=0;const o=[];for(let h=0;h<=i;++h)o[h]=s.slice(0);const a=[];for(let h=0;h<=t;++h)a[h]=s.slice(0);a[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let h=1;h<=t;++h){l[h]=e-n[r+1-h],c[h]=n[r+h]-e;let f=0;for(let d=0;d<h;++d){const m=c[d+1],A=l[h-d];a[h][d]=m+A;const p=a[d][h-1]/a[h][d];a[d][h]=f+m*p,f=A*p}a[h][h]=f}for(let h=0;h<=t;++h)o[0][h]=a[h][t];for(let h=0;h<=t;++h){let f=0,d=1;const m=[];for(let A=0;A<=t;++A)m[A]=s.slice(0);m[0][0]=1;for(let A=1;A<=i;++A){let p=0;const y=h-A,E=t-A;h>=A&&(m[d][0]=m[f][0]/a[E+1][y],p=m[d][0]*a[y][E]);const v=y>=-1?1:-y,x=h-1<=E?A-1:t-h;for(let I=v;I<=x;++I)m[d][I]=(m[f][I]-m[f][I-1])/a[E+1][y+I],p+=m[d][I]*a[y+I][E];h<=E&&(m[d][A]=-m[f][A-1]/a[E+1][h],p+=m[d][A]*a[h][E]),o[A][h]=p;const C=f;f=d,d=C}}let u=t;for(let h=1;h<=i;++h){for(let f=0;f<=t;++f)o[h][f]*=u;u*=t-h}return o}function AT(r,e,t,i,n){const s=n<r?n:r,o=[],a=X2(r,i,e),l=mT(a,i,r,s,e),c=[];for(let u=0;u<t.length;++u){const h=t[u].clone(),f=h.w;h.x*=f,h.y*=f,h.z*=f,c[u]=h}for(let u=0;u<=s;++u){const h=c[a-r].clone().multiplyScalar(l[u][0]);for(let f=1;f<=r;++f)h.add(c[a-r+f].clone().multiplyScalar(l[u][f]));o[u]=h}for(let u=s+1;u<=n+1;++u)o[u]=new Ci(0,0,0);return o}function pT(r,e){let t=1;for(let n=2;n<=r;++n)t*=n;let i=1;for(let n=2;n<=e;++n)i*=n;for(let n=2;n<=r-e;++n)i*=n;return t/i}function gT(r){const e=r.length,t=[],i=[];for(let s=0;s<e;++s){const o=r[s];t[s]=new z(o.x,o.y,o.z),i[s]=o.w}const n=[];for(let s=0;s<e;++s){const o=t[s].clone();for(let a=1;a<=s;++a)o.sub(n[s-a].clone().multiplyScalar(pT(s,a)*i[a]));n[s]=o.divideScalar(i[0])}return n}function yT(r,e,t,i,n){const s=AT(r,e,t,i,n);return gT(s)}class fp extends Gx{constructor(e,t,i,n,s){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=s||this.knots.length-1;for(let o=0;o<i.length;++o){const a=i[o];this.controlPoints[o]=new Ci(a.x,a.y,a.z,a.w)}}getPoint(e,t){const i=t||new z,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),s=dT(this.degree,this.knots,this.controlPoints,n);return s.w!=1&&s.divideScalar(s.w),i.set(s.x,s.y,s.z)}getTangent(e,t){const i=t||new z,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),s=yT(this.degree,this.knots,this.controlPoints,n,1);return i.copy(s[1]).normalize(),i}}let Ct,Ei,An;class N0 extends Dr{constructor(e){super(e)}load(e,t,i,n){const s=this,o=s.path===""?ea.extractUrlBase(e):s.path,a=new vn(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(e,function(l){try{t(s.parse(l,o))}catch(c){n?n(c):console.error(c),s.manager.itemError(e)}},i,n)}parse(e,t){if(_T(e))Ct=new IT().parse(e);else{const n=ev(e);if(!ST(n))throw new Error("THREE.FBXLoader: Unknown format.");if(mp(n)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+mp(n));Ct=new CT().parse(n)}const i=new nr(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new vT(i,this.manager).parse(Ct)}}class vT{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Ei=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),i=this.parseMaterials(t),n=this.parseDeformers(),s=new ET().parse(n);return this.parseScene(n,s,i),An}parseConnections(){const e=new Map;return"Connections"in Ct&&Ct.Connections.connections.forEach(function(i){const n=i[0],s=i[1],o=i[2];e.has(n)||e.set(n,{parents:[],children:[]});const a={ID:s,relationship:o};e.get(n).parents.push(a),e.has(s)||e.set(s,{parents:[],children:[]});const l={ID:n,relationship:o};e.get(s).children.push(l)}),e}parseImages(){const e={},t={};if("Video"in Ct.Objects){const i=Ct.Objects.Video;for(const n in i){const s=i[n],o=parseInt(n);if(e[o]=s.RelativeFilename||s.Filename,"Content"in s){const a=s.Content instanceof ArrayBuffer&&s.Content.byteLength>0,l=typeof s.Content=="string"&&s.Content!=="";if(a||l){const c=this.parseImage(i[n]);t[s.RelativeFilename||s.Filename]=c}}}}for(const i in e){const n=e[i];t[n]!==void 0?e[i]=t[n]:e[i]=e[i].split("\\").pop()}return e}parseImage(e){const t=e.Content,i=e.RelativeFilename||e.Filename,n=i.slice(i.lastIndexOf(".")+1).toLowerCase();let s;switch(n){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",i),s="image/tga";break;default:console.warn('FBXLoader: Image type "'+n+'" is not supported.');return}if(typeof t=="string")return"data:"+s+";base64,"+t;{const o=new Uint8Array(t);return window.URL.createObjectURL(new Blob([o],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in Ct.Objects){const i=Ct.Objects.Texture;for(const n in i){const s=this.parseTexture(i[n],e);t.set(parseInt(n),s)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const n=e.WrapModeU,s=e.WrapModeV,o=n!==void 0?n.value:0,a=s!==void 0?s.value:0;if(i.wrapS=o===0?Pn:Bn,i.wrapT=a===0?Pn:Bn,"Scaling"in e){const l=e.Scaling.value;i.repeat.x=l[0],i.repeat.y=l[1]}return i}loadTexture(e,t){let i;const n=this.textureLoader.path,s=Ei.get(e.id).children;s!==void 0&&s.length>0&&t[s[0].ID]!==void 0&&(i=t[s[0].ID],(i.indexOf("blob:")===0||i.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const a=e.FileName.slice(-3).toLowerCase();if(a==="tga"){const l=this.manager.getHandler(".tga");l===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new qi):(l.setPath(this.textureLoader.path),o=l.load(i))}else a==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new qi):o=this.textureLoader.load(i);return this.textureLoader.setPath(n),o}parseMaterials(e){const t=new Map;if("Material"in Ct.Objects){const i=Ct.Objects.Material;for(const n in i){const s=this.parseMaterial(i[n],e);s!==null&&t.set(parseInt(n),s)}}return t}parseMaterial(e,t){const i=e.id,n=e.attrName;let s=e.ShadingModel;if(typeof s=="object"&&(s=s.value),!Ei.has(i))return null;const o=this.parseParameters(e,t,i);let a;switch(s.toLowerCase()){case"phong":a=new bh;break;case"lambert":a=new w0;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),a=new bh;break}return a.setValues(o),a.name=n,a}parseParameters(e,t,i){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=new Ye().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(n.color=new Ye().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=new Ye().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(n.emissive=new Ye().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(n.opacity=parseFloat(e.Opacity.value)),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=new Ye().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(n.specular=new Ye().fromArray(e.SpecularColor.value));const s=this;return Ei.get(i).children.forEach(function(o){const a=o.relationship;switch(a){case"Bump":n.bumpMap=s.getTexture(t,o.ID);break;case"Maya|TEX_ao_map":n.aoMap=s.getTexture(t,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=s.getTexture(t,o.ID),n.map!==void 0&&("colorSpace"in n.map?n.map.colorSpace="srgb":n.map.encoding=3001);break;case"DisplacementColor":n.displacementMap=s.getTexture(t,o.ID);break;case"EmissiveColor":n.emissiveMap=s.getTexture(t,o.ID),n.emissiveMap!==void 0&&("colorSpace"in n.emissiveMap?n.emissiveMap.colorSpace="srgb":n.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=s.getTexture(t,o.ID);break;case"ReflectionColor":n.envMap=s.getTexture(t,o.ID),n.envMap!==void 0&&(n.envMap.mapping=Xy,"colorSpace"in n.envMap?n.envMap.colorSpace="srgb":n.envMap.encoding=3001);break;case"SpecularColor":n.specularMap=s.getTexture(t,o.ID),n.specularMap!==void 0&&("colorSpace"in n.specularMap?n.specularMap.colorSpace="srgb":n.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=s.getTexture(t,o.ID),n.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a);break}}),n}getTexture(e,t){return"LayeredTexture"in Ct.Objects&&t in Ct.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Ei.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Ct.Objects){const i=Ct.Objects.Deformer;for(const n in i){const s=i[n],o=Ei.get(parseInt(n));if(s.attrType==="Skin"){const a=this.parseSkeleton(o,i);a.ID=n,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=o.parents[0].ID,e[n]=a}else if(s.attrType==="BlendShape"){const a={id:n};a.rawTargets=this.parseMorphTargets(o,i),a.id=n,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[n]=a}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach(function(n){const s=t[n.ID];if(s.attrType!=="Cluster")return;const o={ID:n.ID,indices:[],weights:[],transformLink:new we().fromArray(s.TransformLink.a)};"Indexes"in s&&(o.indices=s.Indexes.a,o.weights=s.Weights.a),i.push(o)}),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const i=[];for(let n=0;n<e.children.length;n++){const s=e.children[n],o=t[s.ID],a={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;a.geoID=Ei.get(parseInt(s.ID)).children.filter(function(l){return l.relationship===void 0})[0].ID,i.push(a)}return i}parseScene(e,t,i){An=new tr;const n=this.parseModels(e.skeletons,t,i),s=Ct.Objects.Model,o=this;n.forEach(function(l){const c=s[l.ID];o.setLookAtProperties(l,c),Ei.get(l.ID).parents.forEach(function(h){const f=n.get(h.ID);f!==void 0&&f.add(l)}),l.parent===null&&An.add(l)}),this.bindSkeleton(e.skeletons,t,n),this.createAmbientLight(),An.traverse(function(l){if(l.userData.transformData){l.parent&&(l.userData.transformData.parentMatrix=l.parent.matrix,l.userData.transformData.parentMatrixWorld=l.parent.matrixWorld);const c=J2(l.userData.transformData);l.applyMatrix4(c),l.updateWorldMatrix()}});const a=new xT().parse();An.children.length===1&&An.children[0].isGroup&&(An.children[0].animations=a,An=An.children[0]),An.animations=a}parseModels(e,t,i){const n=new Map,s=Ct.Objects.Model;for(const o in s){const a=parseInt(o),l=s[o],c=Ei.get(a);let u=this.buildSkeleton(c,e,a,l.attrName);if(!u){switch(l.attrType){case"Camera":u=this.createCamera(c);break;case"Light":u=this.createLight(c);break;case"Mesh":u=this.createMesh(c,t,i);break;case"NurbsCurve":u=this.createCurve(c,t);break;case"LimbNode":case"Root":u=new _d;break;case"Null":default:u=new tr;break}u.name=l.attrName?Bl.sanitizeNodeName(l.attrName):"",u.ID=a}this.getTransformData(u,l),n.set(a,u)}return n}buildSkeleton(e,t,i,n){let s=null;return e.parents.forEach(function(o){for(const a in t){const l=t[a];l.rawBones.forEach(function(c,u){if(c.ID===o.ID){const h=s;s=new _d,s.matrixWorld.copy(c.transformLink),s.name=n?Bl.sanitizeNodeName(n):"",s.ID=i,l.bones[u]=s,h!==null&&s.add(h)}})}}),s}createCamera(e){let t,i;if(e.children.forEach(function(n){const s=Ct.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new mi;else{let n=0;i.CameraProjectionType!==void 0&&i.CameraProjectionType.value===1&&(n=1);let s=1;i.NearPlane!==void 0&&(s=i.NearPlane.value/1e3);let o=1e3;i.FarPlane!==void 0&&(o=i.FarPlane.value/1e3);let a=window.innerWidth,l=window.innerHeight;i.AspectWidth!==void 0&&i.AspectHeight!==void 0&&(a=i.AspectWidth.value,l=i.AspectHeight.value);const c=a/l;let u=45;i.FieldOfView!==void 0&&(u=i.FieldOfView.value);const h=i.FocalLength?i.FocalLength.value:null;switch(n){case 0:t=new jt(u,c,s,o),h!==null&&t.setFocalLength(h);break;case 1:t=new ui(-a/2,a/2,l/2,-l/2,s,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+n+"."),t=new mi;break}}return t}createLight(e){let t,i;if(e.children.forEach(function(n){const s=Ct.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new mi;else{let n;i.LightType===void 0?n=0:n=i.LightType.value;let s=16777215;i.Color!==void 0&&(s=new Ye().fromArray(i.Color.value));let o=i.Intensity===void 0?1:i.Intensity.value/100;i.CastLightOnObject!==void 0&&i.CastLightOnObject.value===0&&(o=0);let a=0;i.FarAttenuationEnd!==void 0&&(i.EnableFarAttenuation!==void 0&&i.EnableFarAttenuation.value===0?a=0:a=i.FarAttenuationEnd.value);const l=1;switch(n){case 0:t=new Id(s,o,a,l);break;case 1:t=new Ky(s,o);break;case 2:let c=Math.PI/3;i.InnerAngle!==void 0&&(c=et.degToRad(i.InnerAngle.value));let u=0;i.OuterAngle!==void 0&&(u=et.degToRad(i.OuterAngle.value),u=Math.max(u,1)),t=new Vy(s,o,a,c,u,l);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new Id(s,o);break}i.CastShadows!==void 0&&i.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,i){let n,s=null,o=null;const a=[];return e.children.forEach(function(l){t.has(l.ID)&&(s=t.get(l.ID)),i.has(l.ID)&&a.push(i.get(l.ID))}),a.length>1?o=a:a.length>0?o=a[0]:(o=new bh({color:13421772}),a.push(o)),"color"in s.attributes&&a.forEach(function(l){l.vertexColors=!0}),s.FBX_Deformer?(n=new b0(s,o),n.normalizeSkinWeights()):n=new Qe(s,o),n}createCurve(e,t){const i=e.children.reduce(function(s,o){return t.has(o.ID)&&(s=t.get(o.ID)),s},null),n=new Zo({color:3342591,linewidth:1});return new St(i,n)}getTransformData(e,t){const i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?i.eulerOrder=Z2(t.RotationOrder.value):i.eulerOrder="ZYX","Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i}setLookAtProperties(e,t){"LookAtProperty"in t&&Ei.get(e.ID).children.forEach(function(n){if(n.relationship==="LookAtProperty"){const s=Ct.Objects.Model[n.ID];if("Lcl_Translation"in s){const o=s.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),An.add(e.target)):e.lookAt(new z().fromArray(o))}}})}bindSkeleton(e,t,i){const n=this.parsePoseNodes();for(const s in e){const o=e[s];Ei.get(parseInt(o.ID)).parents.forEach(function(l){if(t.has(l.ID)){const c=l.ID;Ei.get(c).parents.forEach(function(h){i.has(h.ID)&&i.get(h.ID).bind(new Yy(o.bones),n[h.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in Ct.Objects){const t=Ct.Objects.Pose;for(const i in t)if(t[i].attrType==="BindPose"&&t[i].NbPoseNodes>0){const n=t[i].PoseNode;Array.isArray(n)?n.forEach(function(s){e[s.Node]=new we().fromArray(s.Matrix.a)}):e[n.Node]=new we().fromArray(n.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Ct&&"AmbientColor"in Ct.GlobalSettings){const e=Ct.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],n=e[2];if(t!==0||i!==0||n!==0){const s=new Ye(t,i,n);An.add(new Qx(s,1))}}}}class ET{parse(e){const t=new Map;if("Geometry"in Ct.Objects){const i=Ct.Objects.Geometry;for(const n in i){const s=Ei.get(parseInt(n)),o=this.parseGeometry(s,i[n],e);t.set(parseInt(n),o)}}return t}parseGeometry(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,i){const n=i.skeletons,s=[],o=e.parents.map(function(h){return Ct.Objects.Model[h.ID]});if(o.length===0)return;const a=e.children.reduce(function(h,f){return n[f.ID]!==void 0&&(h=n[f.ID]),h},null);e.children.forEach(function(h){i.morphTargets[h.ID]!==void 0&&s.push(i.morphTargets[h.ID])});const l=o[0],c={};"RotationOrder"in l&&(c.eulerOrder=Z2(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);const u=J2(c);return this.genGeometry(t,a,s,u)}genGeometry(e,t,i,n){const s=new ki;e.attrName&&(s.name=e.attrName);const o=this.parseGeoNode(e,t),a=this.genBuffers(o),l=new Vi(a.vertex,3);if(l.applyMatrix4(n),s.setAttribute("position",l),a.colors.length>0&&s.setAttribute("color",new Vi(a.colors,3)),t&&(s.setAttribute("skinIndex",new zx(a.weightsIndices,4)),s.setAttribute("skinWeight",new Vi(a.vertexWeights,4)),s.FBX_Deformer=t),a.normal.length>0){const c=new bn().getNormalMatrix(n),u=new Vi(a.normal,3);u.applyNormalMatrix(c),s.setAttribute("normal",u)}if(a.uvs.forEach(function(c,u){O0==="uv2"&&u++;const h=u===0?"uv":`uv${u}`;s.setAttribute(h,new Vi(a.uvs[u],2))}),o.material&&o.material.mappingType!=="AllSame"){let c=a.materialIndex[0],u=0;if(a.materialIndex.forEach(function(h,f){h!==c&&(s.addGroup(u,f-u,c),c=h,u=f)}),s.groups.length>0){const h=s.groups[s.groups.length-1],f=h.start+h.count;f!==a.materialIndex.length&&s.addGroup(f,a.materialIndex.length-f,c)}s.groups.length===0&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,e,i,n),s}parseGeoNode(e,t){const i={};if(i.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],i.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];let n=0;for(;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return i.weightTable={},t!==null&&(i.skeleton=t,t.rawBones.forEach(function(n,s){n.indices.forEach(function(o,a){i.weightTable[o]===void 0&&(i.weightTable[o]=[]),i.weightTable[o].push({id:s,weight:n.weights[a]})})})),i}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,n=0,s=!1,o=[],a=[],l=[],c=[],u=[],h=[];const f=this;return e.vertexIndices.forEach(function(d,m){let A,p=!1;d<0&&(d=d^-1,p=!0);let y=[],E=[];if(o.push(d*3,d*3+1,d*3+2),e.color){const v=uc(m,i,d,e.color);l.push(v[0],v[1],v[2])}if(e.skeleton){if(e.weightTable[d]!==void 0&&e.weightTable[d].forEach(function(v){E.push(v.weight),y.push(v.id)}),E.length>4){s||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),s=!0);const v=[0,0,0,0],x=[0,0,0,0];E.forEach(function(C,I){let _=C,S=y[I];x.forEach(function(b,T,R){if(_>b){R[T]=_,_=b;const w=v[T];v[T]=S,S=w}})}),y=v,E=x}for(;E.length<4;)E.push(0),y.push(0);for(let v=0;v<4;++v)u.push(E[v]),h.push(y[v])}if(e.normal){const v=uc(m,i,d,e.normal);a.push(v[0],v[1],v[2])}e.material&&e.material.mappingType!=="AllSame"&&(A=uc(m,i,d,e.material)[0]),e.uv&&e.uv.forEach(function(v,x){const C=uc(m,i,d,v);c[x]===void 0&&(c[x]=[]),c[x].push(C[0]),c[x].push(C[1])}),n++,p&&(f.genFace(t,e,o,A,a,l,c,u,h,n),i++,n=0,o=[],a=[],l=[],c=[],u=[],h=[])}),t}genFace(e,t,i,n,s,o,a,l,c,u){for(let h=2;h<u;h++)e.vertex.push(t.vertexPositions[i[0]]),e.vertex.push(t.vertexPositions[i[1]]),e.vertex.push(t.vertexPositions[i[2]]),e.vertex.push(t.vertexPositions[i[(h-1)*3]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+1]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+2]]),e.vertex.push(t.vertexPositions[i[h*3]]),e.vertex.push(t.vertexPositions[i[h*3+1]]),e.vertex.push(t.vertexPositions[i[h*3+2]]),t.skeleton&&(e.vertexWeights.push(l[0]),e.vertexWeights.push(l[1]),e.vertexWeights.push(l[2]),e.vertexWeights.push(l[3]),e.vertexWeights.push(l[(h-1)*4]),e.vertexWeights.push(l[(h-1)*4+1]),e.vertexWeights.push(l[(h-1)*4+2]),e.vertexWeights.push(l[(h-1)*4+3]),e.vertexWeights.push(l[h*4]),e.vertexWeights.push(l[h*4+1]),e.vertexWeights.push(l[h*4+2]),e.vertexWeights.push(l[h*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(h-1)*4]),e.weightsIndices.push(c[(h-1)*4+1]),e.weightsIndices.push(c[(h-1)*4+2]),e.weightsIndices.push(c[(h-1)*4+3]),e.weightsIndices.push(c[h*4]),e.weightsIndices.push(c[h*4+1]),e.weightsIndices.push(c[h*4+2]),e.weightsIndices.push(c[h*4+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(h-1)*3]),e.colors.push(o[(h-1)*3+1]),e.colors.push(o[(h-1)*3+2]),e.colors.push(o[h*3]),e.colors.push(o[h*3+1]),e.colors.push(o[h*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(s[0]),e.normal.push(s[1]),e.normal.push(s[2]),e.normal.push(s[(h-1)*3]),e.normal.push(s[(h-1)*3+1]),e.normal.push(s[(h-1)*3+2]),e.normal.push(s[h*3]),e.normal.push(s[h*3+1]),e.normal.push(s[h*3+2])),t.uv&&t.uv.forEach(function(f,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(a[d][0]),e.uvs[d].push(a[d][1]),e.uvs[d].push(a[d][(h-1)*2]),e.uvs[d].push(a[d][(h-1)*2+1]),e.uvs[d].push(a[d][h*2]),e.uvs[d].push(a[d][h*2+1])})}addMorphTargets(e,t,i,n){if(i.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const s=this;i.forEach(function(o){o.rawTargets.forEach(function(a){const l=Ct.Objects.Geometry[a.geoID];l!==void 0&&s.genMorphGeometry(e,t,l,n,a.name)})})}genMorphGeometry(e,t,i,n,s){const o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],a=i.Vertices!==void 0?i.Vertices.a:[],l=i.Indexes!==void 0?i.Indexes.a:[],c=e.attributes.position.count*3,u=new Float32Array(c);for(let m=0;m<l.length;m++){const A=l[m]*3;u[A]=a[m*3],u[A+1]=a[m*3+1],u[A+2]=a[m*3+2]}const h={vertexIndices:o,vertexPositions:u},f=this.genBuffers(h),d=new Vi(f.vertex,3);d.name=s||i.attrName,d.applyMatrix4(n),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Normals.a;let s=[];return i==="IndexToDirect"&&("NormalIndex"in e?s=e.NormalIndex.a:"NormalsIndex"in e&&(s=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:s,mappingType:t,referenceType:i}}parseUVs(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.UV.a;let s=[];return i==="IndexToDirect"&&(s=e.UVIndex.a),{dataSize:2,buffer:n,indices:s,mappingType:t,referenceType:i}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Colors.a;let s=[];return i==="IndexToDirect"&&(s=e.ColorIndex.a),{dataSize:4,buffer:n,indices:s,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,i=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const n=e.Materials.a,s=[];for(let o=0;o<n.length;++o)s.push(o);return{dataSize:1,buffer:n,indices:s,mappingType:t,referenceType:i}}parseNurbsGeometry(e){if(fp===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new ki;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new ki;const i=t-1,n=e.KnotVector.a,s=[],o=e.Points.a;for(let h=0,f=o.length;h<f;h+=4)s.push(new Ci().fromArray(o,h));let a,l;if(e.Form==="Closed")s.push(s[0]);else if(e.Form==="Periodic"){a=i,l=n.length-1-a;for(let h=0;h<i;++h)s.push(s[h])}const u=new fp(i,n,s,a,l).getPoints(s.length*12);return new ki().setFromPoints(u)}}class xT{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const i in t){const n=t[i],s=this.addClip(n);e.push(s)}return e}parseClips(){if(Ct.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Ct.Objects.AnimationCurveNode,t=new Map;for(const i in e){const n=e[i];if(n.attrName.match(/S|R|T|DeformPercent/)!==null){const s={id:n.id,attr:n.attrName,curves:{}};t.set(s.id,s)}}return t}parseAnimationCurves(e){const t=Ct.Objects.AnimationCurve;for(const i in t){const n={id:t[i].id,times:t[i].KeyTime.a.map(TT),values:t[i].KeyValueFloat.a},s=Ei.get(n.id);if(s!==void 0){const o=s.parents[0].ID,a=s.parents[0].relationship;a.match(/X/)?e.get(o).curves.x=n:a.match(/Y/)?e.get(o).curves.y=n:a.match(/Z/)?e.get(o).curves.z=n:a.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=n)}}}parseAnimationLayers(e){const t=Ct.Objects.AnimationLayer,i=new Map;for(const n in t){const s=[],o=Ei.get(parseInt(n));o!==void 0&&(o.children.forEach(function(l,c){if(e.has(l.ID)){const u=e.get(l.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(s[c]===void 0){const h=Ei.get(l.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(h!==void 0){const f=Ct.Objects.Model[h.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",l);return}const d={modelName:f.attrName?Bl.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};An.traverse(function(m){m.ID===f.id&&(d.transform=m.matrix,m.userData.transformData&&(d.eulerOrder=m.userData.transformData.eulerOrder))}),d.transform||(d.transform=new we),"PreRotation"in f&&(d.preRotation=f.PreRotation.value),"PostRotation"in f&&(d.postRotation=f.PostRotation.value),s[c]=d}}s[c]&&(s[c][u.attr]=u)}else if(u.curves.morph!==void 0){if(s[c]===void 0){const h=Ei.get(l.ID).parents.filter(function(y){return y.relationship!==void 0})[0].ID,f=Ei.get(h).parents[0].ID,d=Ei.get(f).parents[0].ID,m=Ei.get(d).parents[0].ID,A=Ct.Objects.Model[m],p={modelName:A.attrName?Bl.sanitizeNodeName(A.attrName):"",morphName:Ct.Objects.Deformer[h].attrName};s[c]=p}s[c][u.attr]=u}}}),i.set(parseInt(n),s))}return i}parseAnimStacks(e){const t=Ct.Objects.AnimationStack,i={};for(const n in t){const s=Ei.get(parseInt(n)).children;s.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(s[0].ID);i[n]={name:t[n].attrName,layer:o}}return i}addClip(e){let t=[];const i=this;return e.layer.forEach(function(n){t=t.concat(i.generateTracks(n))}),new S0(e.name,-1,t)}generateTracks(e){const t=[];let i=new z,n=new nt,s=new z;if(e.transform&&e.transform.decompose(i,n,s),i=i.toArray(),n=new wn().setFromQuaternion(n,e.eulerOrder).toArray(),s=s.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");o!==void 0&&t.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&t.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&t.push(o)}return t}generateVectorTrack(e,t,i,n){const s=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(s,t,i);return new Su(e+"."+n,s,o)}generateRotationTrack(e,t,i,n,s,o){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(et.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(et.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(et.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,i);n!==void 0&&(n=n.map(et.degToRad),n.push(o),n=new wn().fromArray(n),n=new nt().setFromEuler(n)),s!==void 0&&(s=s.map(et.degToRad),s.push(o),s=new wn().fromArray(s),s=new nt().setFromEuler(s).invert());const c=new nt,u=new wn,h=[];for(let f=0;f<l.length;f+=3)u.set(l[f],l[f+1],l[f+2],o),c.setFromEuler(u),n!==void 0&&c.premultiply(n),s!==void 0&&c.multiply(s),c.toArray(h,f/3*4);return new Tu(e+".quaternion",a,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map(function(s){return s/100}),n=An.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Sd(e.modelName+".morphTargetInfluences["+n+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(i,n){return i-n}),t.length>1){let i=1,n=t[0];for(let s=1;s<t.length;s++){const o=t[s];o!==n&&(t[i]=o,n=o,i++)}t=t.slice(0,i)}return t}getKeyframeTrackValues(e,t,i){const n=i,s=[];let o=-1,a=-1,l=-1;return e.forEach(function(c){if(t.x&&(o=t.x.times.indexOf(c)),t.y&&(a=t.y.times.indexOf(c)),t.z&&(l=t.z.times.indexOf(c)),o!==-1){const u=t.x.values[o];s.push(u),n[0]=u}else s.push(n[0]);if(a!==-1){const u=t.y.values[a];s.push(u),n[1]=u}else s.push(n[1]);if(l!==-1){const u=t.z.values[l];s.push(u),n[2]=u}else s.push(n[2])}),s}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const i=e.values[t-1],n=e.values[t]-i,s=Math.abs(n);if(s>=180){const o=s/180,a=n/o;let l=i+a;const c=e.times[t-1],h=(e.times[t]-c)/o;let f=c+h;const d=[],m=[];for(;f<e.times[t];)d.push(f),f+=h,m.push(l),l+=a;e.times=Ap(e.times,t,d),e.values=Ap(e.values,t,m)}}}}class CT{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new q2,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,i=e.split(/[\r\n]+/);return i.forEach(function(n,s){const o=n.match(/^[\s\t]*;/),a=n.match(/^[\s\t]*$/);if(o||a)return;const l=n.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),c=n.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=n.match("^\\t{"+(t.currentIndent-1)+"}}");l?t.parseNodeBegin(n,l):c?t.parseNodeProperty(n,c,i[++s]):u?t.popStack():n.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(n)}),this.allNodes}parseNodeBegin(e,t){const i=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(l){return l.trim().replace(/^"/,"").replace(/"$/,"")}),s={name:i},o=this.parseNodeAttr(n),a=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(i,s):i in a?(i==="PoseNode"?a.PoseNode.push(s):a[i].id!==void 0&&(a[i]={},a[i][a[i].id]=a[i]),o.id!==""&&(a[i][o.id]=s)):typeof o.id=="number"?(a[i]={},a[i][o.id]=s):i!=="Properties70"&&(i==="PoseNode"?a[i]=[s]:a[i]=s),typeof o.id=="number"&&(s.id=o.id),o.name!==""&&(s.attrName=o.name),o.type!==""&&(s.attrType=o.type),this.pushStack(s)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}}parseNodeProperty(e,t,i){let n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),s=t[2].replace(/^"/,"").replace(/"$/,"").trim();n==="Content"&&s===","&&(s=i.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,n,s);return}if(n==="C"){const l=s.split(",").slice(1),c=parseInt(l[0]),u=parseInt(l[1]);let h=s.split(",").slice(3);h=h.map(function(f){return f.trim().replace(/^"/,"")}),n="connections",s=[c,u],wT(s,h),o[n]===void 0&&(o[n]=[])}n==="Node"&&(o.id=s),n in o&&Array.isArray(o[n])?o[n].push(s):n!=="a"?o[n]=s:o.a=s,this.setCurrentProp(o,n),n==="a"&&s.slice(-1)!==","&&(o.a=Vh(s))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Vh(t.a))}parseNodeSpecialProperty(e,t,i){const n=i.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),s=n[0],o=n[1],a=n[2],l=n[3];let c=n[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=Vh(c);break}this.getPrevNode()[s]={type:o,type2:a,flag:l,value:c},this.setCurrentProp(this.getPrevNode(),s)}}class IT{parse(e){const t=new dp(e);t.skip(23);const i=t.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const n=new q2;for(;!this.endOfContent(t);){const s=this.parseNode(t,i);s!==null&&n.add(s.name,s)}return n}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const i={},n=t>=7500?e.getUint64():e.getUint32(),s=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),a=e.getString(o);if(n===0)return null;const l=[];for(let f=0;f<s;f++)l.push(this.parseProperty(e));const c=l.length>0?l[0]:"",u=l.length>1?l[1]:"",h=l.length>2?l[2]:"";for(i.singleProperty=s===1&&e.getOffset()===n;n>e.getOffset();){const f=this.parseNode(e,t);f!==null&&this.parseSubNode(a,i,f)}return i.propertyList=l,typeof c=="number"&&(i.id=c),u!==""&&(i.attrName=u),h!==""&&(i.attrType=h),a!==""&&(i.name=a),i}parseSubNode(e,t,i){if(i.singleProperty===!0){const n=i.propertyList[0];Array.isArray(n)?(t[i.name]=i,i.a=n):t[i.name]=n}else if(e==="Connections"&&i.name==="C"){const n=[];i.propertyList.forEach(function(s,o){o!==0&&n.push(s)}),t.connections===void 0&&(t.connections=[]),t.connections.push(n)}else if(i.name==="Properties70")Object.keys(i).forEach(function(s){t[s]=i[s]});else if(e==="Properties70"&&i.name==="P"){let n=i.propertyList[0],s=i.propertyList[1];const o=i.propertyList[2],a=i.propertyList[3];let l;n.indexOf("Lcl ")===0&&(n=n.replace("Lcl ","Lcl_")),s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),s==="Color"||s==="ColorRGB"||s==="Vector"||s==="Vector3D"||s.indexOf("Lcl_")===0?l=[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:l=i.propertyList[4],t[n]={type:s,type2:o,flag:a,value:l}}else t[i.name]===void 0?typeof i.id=="number"?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:i.name==="PoseNode"?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):t[i.name][i.id]===void 0&&(t[i.name][i.id]=i)}parseProperty(e){const t=e.getString(1);let i;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return i=e.getUint32(),e.getArrayBuffer(i);case"S":return i=e.getUint32(),e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=e.getUint32(),s=e.getUint32(),o=e.getUint32();if(s===0)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}const a=fl(new Uint8Array(e.getArrayBuffer(o))),l=new dp(a.buffer);switch(t){case"b":case"c":return l.getBooleanArray(n);case"d":return l.getFloat64Array(n);case"f":return l.getFloat32Array(n);case"i":return l.getInt32Array(n);case"l":return l.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class dp{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let i=0;i<e;i++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const i=t.indexOf(0);return i>=0&&(t=t.slice(0,i)),ua(new Uint8Array(t))}}class q2{add(e,t){this[e]=t}}function _T(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===ev(r,0,e.length)}function ST(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function i(n){const s=r[n-1];return r=r.slice(t+n),t++,s}for(let n=0;n<e.length;++n)if(i(1)===e[n])return!1;return!0}function mp(r){const e=/FBXVersion: (\d+)/,t=r.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function TT(r){return r/46186158e3}const bT=[];function uc(r,e,t,i){let n;switch(i.mappingType){case"ByPolygonVertex":n=r;break;case"ByPolygon":n=e;break;case"ByVertice":n=t;break;case"AllSame":n=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}i.referenceType==="IndexToDirect"&&(n=i.indices[n]);const s=n*i.dataSize,o=s+i.dataSize;return BT(bT,i.buffer,s,o)}const Hh=new wn,yo=new z;function J2(r){const e=new we,t=new we,i=new we,n=new we,s=new we,o=new we,a=new we,l=new we,c=new we,u=new we,h=new we,f=new we,d=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(yo.fromArray(r.translation)),r.preRotation){const T=r.preRotation.map(et.degToRad);T.push(r.eulerOrder),t.makeRotationFromEuler(Hh.fromArray(T))}if(r.rotation){const T=r.rotation.map(et.degToRad);T.push(r.eulerOrder),i.makeRotationFromEuler(Hh.fromArray(T))}if(r.postRotation){const T=r.postRotation.map(et.degToRad);T.push(r.eulerOrder),n.makeRotationFromEuler(Hh.fromArray(T)),n.invert()}r.scale&&s.scale(yo.fromArray(r.scale)),r.scalingOffset&&a.setPosition(yo.fromArray(r.scalingOffset)),r.scalingPivot&&o.setPosition(yo.fromArray(r.scalingPivot)),r.rotationOffset&&l.setPosition(yo.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(yo.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(h.copy(r.parentMatrix),u.copy(r.parentMatrixWorld));const m=t.clone().multiply(i).multiply(n),A=new we;A.extractRotation(u);const p=new we;p.copyPosition(u);const y=p.clone().invert().multiply(u),E=A.clone().invert().multiply(y),v=s,x=new we;if(d===0)x.copy(A).multiply(m).multiply(E).multiply(v);else if(d===1)x.copy(A).multiply(E).multiply(m).multiply(v);else{const R=new we().scale(new z().setFromMatrixScale(h)).clone().invert(),w=E.clone().multiply(R);x.copy(A).multiply(m).multiply(w).multiply(v)}const C=c.clone().invert(),I=o.clone().invert();let _=e.clone().multiply(l).multiply(c).multiply(t).multiply(i).multiply(n).multiply(C).multiply(a).multiply(o).multiply(s).multiply(I);const S=new we().copyPosition(_),b=u.clone().multiply(S);return f.copyPosition(b),_=f.clone().multiply(x),_.premultiply(u.invert()),_}function Z2(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function Vh(r){return r.split(",").map(function(t){return parseFloat(t)})}function ev(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=r.byteLength),ua(new Uint8Array(r,e,t))}function wT(r,e){for(let t=0,i=r.length,n=e.length;t<n;t++,i++)r[i]=e[t]}function BT(r,e,t,i){for(let n=t,s=0;n<i;n++,s++)r[s]=e[n];return r}function Ap(r,e,t){return r.slice(0,e).concat(t).concat(r.slice(e))}var RT=Object.defineProperty,DT=(r,e,t)=>e in r?RT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Kh=(r,e,t)=>(DT(r,typeof e!="symbol"?e+"":e,t),t);class MT extends Dr{constructor(e){super(e)}load(e,t,i,n){const s=new vn(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{if(typeof o!="string")throw new Error("unsupported data type");const a=JSON.parse(o),l=this.parse(a);t&&t(l)},i,n)}loadAsync(e,t){return super.loadAsync(e,t)}parse(e){return new LT(e)}}class LT{constructor(e){Kh(this,"data"),Kh(this,"isFont",!0),Kh(this,"type","Font"),this.data=e}generateShapes(e,t=100,i){const n=[],s={letterSpacing:0,lineHeight:1,...i},o=PT(e,t,this.data,s);for(let a=0,l=o.length;a<l;a++)Array.prototype.push.apply(n,o[a].toShapes(!1));return n}}function PT(r,e,t,i){const n=Array.from(r),s=e/t.resolution,o=(t.boundingBox.yMax-t.boundingBox.yMin+t.underlineThickness)*s,a=[];let l=0,c=0;for(let u=0;u<n.length;u++){const h=n[u];if(h===`
`)l=0,c-=o*i.lineHeight;else{const f=FT(h,s,l,c,t);f&&(l+=f.offsetX+i.letterSpacing,a.push(f.path))}}return a}function FT(r,e,t,i,n){const s=n.glyphs[r]||n.glyphs["?"];if(!s){console.error('THREE.Font: character "'+r+'" does not exists in font family '+n.familyName+".");return}const o=new gr;let a,l,c,u,h,f,d,m;if(s.o){const A=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let p=0,y=A.length;p<y;)switch(A[p++]){case"m":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.moveTo(a,l);break;case"l":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.lineTo(a,l);break;case"q":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,o.quadraticCurveTo(h,f,c,u);break;case"b":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,d=parseInt(A[p++])*e+t,m=parseInt(A[p++])*e+i,o.bezierCurveTo(h,f,d,m,c,u);break}}return{offsetX:s.ha*e,path:o}}class kT extends qi{constructor(e=null,t=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=Xt,this.minFilter=Xt,this.wrapR=Bn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class OT{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:n,msg:s,transfer:o}=this.queue.shift();this.workersResolve[e]=n,this.workers[e].postMessage(s,o)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const n=this._getIdleWorker();n!==-1?(this._initWorker(n),this.workerStatus|=1<<n,this.workersResolve[n]=i,this.workers[n].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const tv=0,pp=2,UT=0,NT=0,GT=2,QT=0,zT=0,HT=1,Qd=2,VT=0,iv=1,KT=10,$T=64,nv=0,sv=9,rv=15,ov=16,av=22,lv=37,cv=43,uv=76,hv=83,fv=97,dv=100,mv=103,Av=109,pv=165,gv=166;class YT{constructor(){this.vkFormat=nv,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=tv,this.levels=[],this.dataFormatDescriptor=[{vendorId:NT,descriptorType:UT,descriptorBlockSize:0,versionNumber:GT,colorModel:QT,colorPrimaries:iv,transferFunction:Qd,flags:zT,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class za{constructor(e,t,i,n){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=n,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),i=e+2**32*t;return this._offset+=8,i}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){t===void 0&&(t=0);const i=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==t&&n<e;)n++,this._offset++;return n<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,n)}}const tn=[171,75,84,88,32,50,48,187,13,10,26,10];function gp(r){return typeof TextDecoder<"u"?new TextDecoder().decode(r):Buffer.from(r).toString("utf8")}function WT(r){const e=new Uint8Array(r.buffer,r.byteOffset,tn.length);if(e[0]!==tn[0]||e[1]!==tn[1]||e[2]!==tn[2]||e[3]!==tn[3]||e[4]!==tn[4]||e[5]!==tn[5]||e[6]!==tn[6]||e[7]!==tn[7]||e[8]!==tn[8]||e[9]!==tn[9]||e[10]!==tn[10]||e[11]!==tn[11])throw new Error("Missing KTX 2.0 identifier.");const t=new YT,i=17*Uint32Array.BYTES_PER_ELEMENT,n=new za(r,tn.length,i,!0);t.vkFormat=n._nextUint32(),t.typeSize=n._nextUint32(),t.pixelWidth=n._nextUint32(),t.pixelHeight=n._nextUint32(),t.pixelDepth=n._nextUint32(),t.layerCount=n._nextUint32(),t.faceCount=n._nextUint32();const s=n._nextUint32();t.supercompressionScheme=n._nextUint32();const o=n._nextUint32(),a=n._nextUint32(),l=n._nextUint32(),c=n._nextUint32(),u=n._nextUint64(),h=n._nextUint64(),f=s*3*8,d=new za(r,tn.length+i,f,!0);for(let K=0;K<s;K++)t.levels.push({levelData:new Uint8Array(r.buffer,r.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const m=new za(r,o,a,!0),A={vendorId:m._skip(4)._nextUint16(),descriptorType:m._nextUint16(),versionNumber:m._nextUint16(),descriptorBlockSize:m._nextUint16(),colorModel:m._nextUint8(),colorPrimaries:m._nextUint8(),transferFunction:m._nextUint8(),flags:m._nextUint8(),texelBlockDimension:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],bytesPlane:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],samples:[]},p=6,y=4,E=(A.descriptorBlockSize/4-p)/y;for(let K=0;K<E;K++){const M={bitOffset:m._nextUint16(),bitLength:m._nextUint8(),channelType:m._nextUint8(),samplePosition:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};M.channelType&$T?(M.sampleLower=m._nextInt32(),M.sampleUpper=m._nextInt32()):(M.sampleLower=m._nextUint32(),M.sampleUpper=m._nextUint32()),A.samples[K]=M}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(A);const v=new za(r,l,c,!0);for(;v._offset<c;){const K=v._nextUint32(),M=v._scan(K),V=gp(M);if(t.keyValue[V]=v._nextUint8Array(K-M.byteLength-1),V.match(/^ktx/i)){const G=gp(t.keyValue[V]);t.keyValue[V]=G.substring(0,G.lastIndexOf("\0"))}const $=K%4?4-K%4:0;v._skip($)}if(h<=0)return t;const x=new za(r,u,h,!0),C=x._nextUint16(),I=x._nextUint16(),_=x._nextUint32(),S=x._nextUint32(),b=x._nextUint32(),T=x._nextUint32(),R=[];for(let K=0;K<s;K++)R.push({imageFlags:x._nextUint32(),rgbSliceByteOffset:x._nextUint32(),rgbSliceByteLength:x._nextUint32(),alphaSliceByteOffset:x._nextUint32(),alphaSliceByteLength:x._nextUint32()});const w=u+x._offset,B=w+_,D=B+S,k=D+b,Q=new Uint8Array(r.buffer,r.byteOffset+w,_),Y=new Uint8Array(r.buffer,r.byteOffset+B,S),W=new Uint8Array(r.buffer,r.byteOffset+D,b),P=new Uint8Array(r.buffer,r.byteOffset+k,T);return t.globalData={endpointCount:C,selectorCount:I,imageDescs:R,endpointsData:Q,selectorsData:Y,tablesData:W,extendedData:P},t}let Ha,Ys,zd;const $h={env:{emscripten_notify_memory_growth:function(r){zd=new Uint8Array(Ys.exports.memory.buffer)}}};class jT{init(){return Ha||(typeof fetch<"u"?Ha=fetch("data:application/wasm;base64,"+yp).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,$h)).then(this._init):Ha=WebAssembly.instantiate(Buffer.from(yp,"base64"),$h).then(this._init),Ha)}_init(e){Ys=e.instance,$h.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Ys)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,n=Ys.exports.malloc(i);zd.set(e,n),t=t||Number(Ys.exports.ZSTD_findDecompressedSize(n,i));const s=Ys.exports.malloc(t),o=Ys.exports.ZSTD_decompress(s,t,n,i),a=zd.slice(s,s+o);return Ys.exports.free(n),Ys.exports.free(s),a}}const yp="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ";class XT extends Yu{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,qy),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class qT extends Yu{constructor(e,t,i,n,s,o){super(e,t,i,s,o),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=Bn}}var JT=Object.defineProperty,ZT=(r,e,t)=>e in r?JT(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,hc=(r,e,t)=>(ZT(r,typeof e!="symbol"?e+"":e,t),t);const yv=3e3,vv=3001,vp="",e5="display-p3",t5="display-p3-linear",i5="srgb-linear",G0="srgb",Yh=new WeakMap;let Wh=0,jh;const Q0=(()=>{const r=class extends Dr{constructor(t){super(t),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new OT,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(t){return this.transcoderPath=t,this}setWorkerLimit(t){return this.workerPool.setWorkerLimit(t),this}detectSupport(t){return this.workerConfig={astcSupported:t.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:t.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:t.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:t.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:t.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:t.extensions.has("WEBGL_compressed_texture_pvrtc")||t.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},t.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const t=new vn(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const i=t.loadAsync("basis_transcoder.js"),n=new vn(this.manager);n.setPath(this.transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const s=n.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([i,s]).then(([o,a])=>{const l=r.BasisWorker.toString(),c=["/* constants */","let _EngineFormat = "+JSON.stringify(r.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(r.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(r.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",l.substring(l.indexOf("{")+1,l.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([c])),this.transcoderBinary=a,this.workerPool.setWorkerCreator(()=>{const u=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return u.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),u})}),Wh>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Wh++}return this.transcoderPending}load(t,i,n,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const o=new vn(this.manager);o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials),o.load(t,a=>{if(Yh.has(a))return Yh.get(a).promise.then(i).catch(s);this._createTexture(a).then(l=>i?i(l):null).catch(s)},n,s)}_createTextureFrom(t,i){const{faces:n,width:s,height:o,format:a,type:l,error:c,dfdFlags:u}=t;if(l==="error")return Promise.reject(c);let h;if(i.faceCount===6)h=new XT(n,a,Hi);else{const d=n[0].mipmaps;h=i.layerCount>1?new qT(d,s,o,i.layerCount,a,Hi):new Yu(d,s,o,a,Hi)}h.minFilter=n[0].mipmaps.length===1?Ht:Nl,h.magFilter=Ht,h.generateMipmaps=!1,h.needsUpdate=!0;const f=Ev(i);return"colorSpace"in h?h.colorSpace=f:h.encoding=f===G0?vv:yv,h.premultiplyAlpha=!!(u&HT),h}async _createTexture(t,i={}){const n=WT(new Uint8Array(t));if(n.vkFormat!==nv)return s5(n);const s=i,o=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:t,taskConfig:s},[t])).then(a=>this._createTextureFrom(a.data,n));return Yh.set(t,{promise:o}),o}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Wh--,this}};let e=r;return hc(e,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),hc(e,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),hc(e,"EngineFormat",{RGBAFormat:wi,RGBA_ASTC_4x4_Format:Hx,RGBA_BPTC_Format:Vx,RGBA_ETC2_EAC_Format:Kx,RGBA_PVRTC_4BPPV1_Format:$x,RGBA_S3TC_DXT5_Format:Yx,RGB_ETC1_Format:Wx,RGB_ETC2_Format:jx,RGB_PVRTC_4BPPV1_Format:Xx,RGB_S3TC_DXT1_Format:qx}),hc(e,"BasisWorker",function(){let t,i,n;const s=_EngineFormat,o=_TranscoderFormat,a=_BasisFormat;self.addEventListener("message",function(p){const y=p.data;switch(y.type){case"init":t=y.config,l(y.transcoderBinary);break;case"transcode":i.then(()=>{try{const{faces:E,buffers:v,width:x,height:C,hasAlpha:I,format:_,dfdFlags:S}=c(y.buffer);self.postMessage({type:"transcode",id:y.id,faces:E,width:x,height:C,hasAlpha:I,format:_,dfdFlags:S},v)}catch(E){console.error(E),self.postMessage({type:"error",id:y.id,error:E.message})}});break}});function l(p){i=new Promise(y=>{n={wasmBinary:p,onRuntimeInitialized:y},BASIS(n)}).then(()=>{n.initializeBasis(),n.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function c(p){const y=new n.KTX2File(new Uint8Array(p));function E(){y.close(),y.delete()}if(!y.isValid())throw E(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");const v=y.isUASTC()?a.UASTC_4x4:a.ETC1S,x=y.getWidth(),C=y.getHeight(),I=y.getLayers()||1,_=y.getLevels(),S=y.getFaces(),b=y.getHasAlpha(),T=y.getDFDFlags(),{transcoderFormat:R,engineFormat:w}=d(v,x,C,b);if(!x||!C||!_)throw E(),new Error("THREE.KTX2Loader:	Invalid texture");if(!y.startTranscoding())throw E(),new Error("THREE.KTX2Loader: .startTranscoding failed");const B=[],D=[];for(let k=0;k<S;k++){const Q=[];for(let Y=0;Y<_;Y++){const W=[];let P,K;for(let V=0;V<I;V++){const $=y.getImageLevelInfo(Y,V,k);k===0&&Y===0&&V===0&&($.origWidth%4!==0||$.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),_>1?(P=$.origWidth,K=$.origHeight):(P=$.width,K=$.height);const G=new Uint8Array(y.getImageTranscodedSizeInBytes(Y,V,0,R));if(!y.transcodeImage(G,Y,V,k,R,0,-1,-1))throw E(),new Error("THREE.KTX2Loader: .transcodeImage failed.");W.push(G)}const M=A(W);Q.push({data:M,width:P,height:K}),D.push(M.buffer)}B.push({mipmaps:Q,width:x,height:C,format:w})}return E(),{faces:B,buffers:D,width:x,height:C,hasAlpha:b,format:w,dfdFlags:T}}const u=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],h=u.sort(function(p,y){return p.priorityETC1S-y.priorityETC1S}),f=u.sort(function(p,y){return p.priorityUASTC-y.priorityUASTC});function d(p,y,E,v){let x,C;const I=p===a.ETC1S?h:f;for(let _=0;_<I.length;_++){const S=I[_];if(t[S.if]&&S.basisFormat.includes(p)&&!(v&&S.transcoderFormat.length<2)&&!(S.needsPowerOfTwo&&!(m(y)&&m(E))))return x=S.transcoderFormat[v?1:0],C=S.engineFormat[v?1:0],{transcoderFormat:x,engineFormat:C}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),x=o.RGBA32,C=s.RGBAFormat,{transcoderFormat:x,engineFormat:C}}function m(p){return p<=2?!0:(p&p-1)===0&&p!==0}function A(p){if(p.length===1)return p[0];let y=0;for(let x=0;x<p.length;x++){const C=p[x];y+=C.byteLength}const E=new Uint8Array(y);let v=0;for(let x=0;x<p.length;x++){const C=p[x];E.set(C,v),v+=C.byteLength}return E}}),e})(),n5=new Set([wi,Wo,Ds]),Xh={[Av]:wi,[fv]:wi,[lv]:wi,[cv]:wi,[mv]:Wo,[hv]:Wo,[ov]:Wo,[av]:Wo,[dv]:Ds,[uv]:Ds,[rv]:Ds,[sv]:Ds,[gv]:jm,[pv]:jm},qh={[Av]:ii,[fv]:fi,[lv]:Hi,[cv]:Hi,[mv]:ii,[hv]:fi,[ov]:Hi,[av]:Hi,[dv]:ii,[uv]:fi,[rv]:Hi,[sv]:Hi,[gv]:Hi,[pv]:Hi};async function s5(r){const{vkFormat:e}=r;if(Xh[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let t;r.supercompressionScheme===pp&&(jh||(jh=new Promise(async o=>{const a=new jT;await a.init(),o(a)})),t=await jh);const i=[];for(let o=0;o<r.levels.length;o++){const a=Math.max(1,r.pixelWidth>>o),l=Math.max(1,r.pixelHeight>>o),c=r.pixelDepth?Math.max(1,r.pixelDepth>>o):0,u=r.levels[o];let h;if(r.supercompressionScheme===tv)h=u.levelData;else if(r.supercompressionScheme===pp)h=t.decode(u.levelData,u.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let f;qh[e]===ii?f=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):qh[e]===fi?f=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):f=h,i.push({data:f,width:a,height:l,depth:c})}let n;if(n5.has(Xh[e]))n=r.pixelDepth===0?new br(i[0].data,r.pixelWidth,r.pixelHeight):new kT(i[0].data,r.pixelWidth,r.pixelHeight,r.pixelDepth);else{if(r.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");n=new Yu(i,r.pixelWidth,r.pixelHeight)}n.mipmaps=i,n.type=qh[e],n.format=Xh[e],n.needsUpdate=!0;const s=Ev(r);return"colorSpace"in n?n.colorSpace=s:n.encoding=s===G0?vv:yv,Promise.resolve(n)}function Ev(r){const e=r.dataFormatDescriptor[0];return e.colorPrimaries===iv?e.transferFunction===Qd?G0:i5:e.colorPrimaries===KT?e.transferFunction===Qd?e5:t5:(e.colorPrimaries===VT||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),vp)}class r5 extends Jy{constructor(e){super(e),this.type=fi}parse(e){const o=function(S,b){switch(S){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(b||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(b||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(b||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(b||""))}},u=`
`,h=function(S,b,T){b=b||1024;let w=S.pos,B=-1,D=0,k="",Q=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));for(;0>(B=Q.indexOf(u))&&D<b&&w<S.byteLength;)k+=Q,D+=Q.length,w+=128,Q+=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));return-1<B?(T!==!1&&(S.pos+=D+B+1),k+Q.slice(0,B)):!1},f=function(S){const b=/^#\?(\S+)/,T=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,R=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,w=/^\s*FORMAT=(\S+)\s*$/,B=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,D={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let k,Q;for((S.pos>=S.byteLength||!(k=h(S)))&&o(1,"no header found"),(Q=k.match(b))||o(3,"bad initial token"),D.valid|=1,D.programtype=Q[1],D.string+=k+`
`;k=h(S),k!==!1;){if(D.string+=k+`
`,k.charAt(0)==="#"){D.comments+=k+`
`;continue}if((Q=k.match(T))&&(D.gamma=parseFloat(Q[1])),(Q=k.match(R))&&(D.exposure=parseFloat(Q[1])),(Q=k.match(w))&&(D.valid|=2,D.format=Q[1]),(Q=k.match(B))&&(D.valid|=4,D.height=parseInt(Q[1],10),D.width=parseInt(Q[2],10)),D.valid&2&&D.valid&4)break}return D.valid&2||o(3,"missing format specifier"),D.valid&4||o(3,"missing image size specifier"),D},d=function(S,b,T){const R=b;if(R<8||R>32767||S[0]!==2||S[1]!==2||S[2]&128)return new Uint8Array(S);R!==(S[2]<<8|S[3])&&o(3,"wrong scanline width");const w=new Uint8Array(4*b*T);w.length||o(4,"unable to allocate buffer space");let B=0,D=0;const k=4*R,Q=new Uint8Array(4),Y=new Uint8Array(k);let W=T;for(;W>0&&D<S.byteLength;){D+4>S.byteLength&&o(1),Q[0]=S[D++],Q[1]=S[D++],Q[2]=S[D++],Q[3]=S[D++],(Q[0]!=2||Q[1]!=2||(Q[2]<<8|Q[3])!=R)&&o(3,"bad rgbe scanline format");let P=0,K;for(;P<k&&D<S.byteLength;){K=S[D++];const V=K>128;if(V&&(K-=128),(K===0||P+K>k)&&o(3,"bad scanline data"),V){const $=S[D++];for(let G=0;G<K;G++)Y[P++]=$}else Y.set(S.subarray(D,D+K),P),P+=K,D+=K}const M=R;for(let V=0;V<M;V++){let $=0;w[B]=Y[V+$],$+=R,w[B+1]=Y[V+$],$+=R,w[B+2]=Y[V+$],$+=R,w[B+3]=Y[V+$],B+=4}W--}return w},m=function(S,b,T,R){const w=S[b+3],B=Math.pow(2,w-128)/255;T[R+0]=S[b+0]*B,T[R+1]=S[b+1]*B,T[R+2]=S[b+2]*B,T[R+3]=1},A=function(S,b,T,R){const w=S[b+3],B=Math.pow(2,w-128)/255;T[R+0]=jo.toHalfFloat(Math.min(S[b+0]*B,65504)),T[R+1]=jo.toHalfFloat(Math.min(S[b+1]*B,65504)),T[R+2]=jo.toHalfFloat(Math.min(S[b+2]*B,65504)),T[R+3]=jo.toHalfFloat(1)},p=new Uint8Array(e);p.pos=0;const y=f(p),E=y.width,v=y.height,x=d(p.subarray(p.pos),E,v);let C,I,_;switch(this.type){case ii:_=x.length/4;const S=new Float32Array(_*4);for(let T=0;T<_;T++)m(x,T*4,S,T*4);C=S,I=ii;break;case fi:_=x.length/4;const b=new Uint16Array(_*4);for(let T=0;T<_;T++)A(x,T*4,b,T*4);C=b,I=fi;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:E,height:v,data:C,header:y.string,gamma:y.gamma,exposure:y.exposure,type:I}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){switch(o.type){case ii:case fi:"colorSpace"in o?o.colorSpace="srgb-linear":o.encoding=3e3,o.minFilter=Ht,o.magFilter=Ht,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,s,i,n)}}const Va=pa>=152;class o5 extends Jy{constructor(e){super(e),this.type=fi}parse(e){const b=Math.pow(2.7182818,2.2);function T(H,j){for(var ee=0,me=0;me<65536;++me)(me==0||H[me>>3]&1<<(me&7))&&(j[ee++]=me);for(var Ee=ee-1;ee<65536;)j[ee++]=0;return Ee}function R(H){for(var j=0;j<16384;j++)H[j]={},H[j].len=0,H[j].lit=0,H[j].p=null}const w={l:0,c:0,lc:0};function B(H,j,ee,me,Ee){for(;ee<H;)j=j<<8|We(me,Ee),ee+=8;ee-=H,w.l=j>>ee&(1<<H)-1,w.c=j,w.lc=ee}const D=new Array(59);function k(H){for(var j=0;j<=58;++j)D[j]=0;for(var j=0;j<65537;++j)D[H[j]]+=1;for(var ee=0,j=58;j>0;--j){var me=ee+D[j]>>1;D[j]=ee,ee=me}for(var j=0;j<65537;++j){var Ee=H[j];Ee>0&&(H[j]=Ee|D[Ee]++<<6)}}function Q(H,j,ee,me,Ee,xe,Pe){for(var Re=ee,Fe=0,ke=0;Ee<=xe;Ee++){if(Re.value-ee.value>me)return!1;B(6,Fe,ke,H,Re);var Oe=w.l;if(Fe=w.c,ke=w.lc,Pe[Ee]=Oe,Oe==63){if(Re.value-ee.value>me)throw"Something wrong with hufUnpackEncTable";B(8,Fe,ke,H,Re);var ge=w.l+6;if(Fe=w.c,ke=w.lc,Ee+ge>xe+1)throw"Something wrong with hufUnpackEncTable";for(;ge--;)Pe[Ee++]=0;Ee--}else if(Oe>=59){var ge=Oe-59+2;if(Ee+ge>xe+1)throw"Something wrong with hufUnpackEncTable";for(;ge--;)Pe[Ee++]=0;Ee--}}k(Pe)}function Y(H){return H&63}function W(H){return H>>6}function P(H,j,ee,me){for(;j<=ee;j++){var Ee=W(H[j]),xe=Y(H[j]);if(Ee>>xe)throw"Invalid table entry";if(xe>14){var Pe=me[Ee>>xe-14];if(Pe.len)throw"Invalid table entry";if(Pe.lit++,Pe.p){var Re=Pe.p;Pe.p=new Array(Pe.lit);for(var Fe=0;Fe<Pe.lit-1;++Fe)Pe.p[Fe]=Re[Fe]}else Pe.p=new Array(1);Pe.p[Pe.lit-1]=j}else if(xe)for(var ke=0,Fe=1<<14-xe;Fe>0;Fe--){var Pe=me[(Ee<<14-xe)+ke];if(Pe.len||Pe.p)throw"Invalid table entry";Pe.len=xe,Pe.lit=j,ke++}}return!0}const K={c:0,lc:0};function M(H,j,ee,me){H=H<<8|We(ee,me),j+=8,K.c=H,K.lc=j}const V={c:0,lc:0};function $(H,j,ee,me,Ee,xe,Pe,Re,Fe,ke){if(H==j){me<8&&(M(ee,me,Ee,Pe),ee=K.c,me=K.lc),me-=8;var Oe=ee>>me,Oe=new Uint8Array([Oe])[0];if(Fe.value+Oe>ke)return!1;for(var ge=Re[Fe.value-1];Oe-- >0;)Re[Fe.value++]=ge}else if(Fe.value<ke)Re[Fe.value++]=H;else return!1;V.c=ee,V.lc=me}function G(H){return H&65535}function O(H){var j=G(H);return j>32767?j-65536:j}const F={a:0,b:0};function U(H,j){var ee=O(H),me=O(j),Ee=me,xe=ee+(Ee&1)+(Ee>>1),Pe=xe,Re=xe-Ee;F.a=Pe,F.b=Re}function N(H,j){var ee=G(H),me=G(j),Ee=ee-(me>>1)&65535,xe=me+Ee-32768&65535;F.a=xe,F.b=Ee}function Z(H,j,ee,me,Ee,xe,Pe){for(var Re=Pe<16384,Fe=ee>Ee?Ee:ee,ke=1,Oe;ke<=Fe;)ke<<=1;for(ke>>=1,Oe=ke,ke>>=1;ke>=1;){for(var ge=0,kt=ge+xe*(Ee-Oe),Ze=xe*ke,Je=xe*Oe,lt=me*ke,gt=me*Oe,Rt,Dt,si,Gi;ge<=kt;ge+=Je){for(var Mt=ge,In=ge+me*(ee-Oe);Mt<=In;Mt+=gt){var Ot=Mt+lt,vi=Mt+Ze,en=vi+lt;Re?(U(H[Mt+j],H[vi+j]),Rt=F.a,si=F.b,U(H[Ot+j],H[en+j]),Dt=F.a,Gi=F.b,U(Rt,Dt),H[Mt+j]=F.a,H[Ot+j]=F.b,U(si,Gi),H[vi+j]=F.a,H[en+j]=F.b):(N(H[Mt+j],H[vi+j]),Rt=F.a,si=F.b,N(H[Ot+j],H[en+j]),Dt=F.a,Gi=F.b,N(Rt,Dt),H[Mt+j]=F.a,H[Ot+j]=F.b,N(si,Gi),H[vi+j]=F.a,H[en+j]=F.b)}if(ee&ke){var vi=Mt+Ze;Re?U(H[Mt+j],H[vi+j]):N(H[Mt+j],H[vi+j]),Rt=F.a,H[vi+j]=F.b,H[Mt+j]=Rt}}if(Ee&ke)for(var Mt=ge,In=ge+me*(ee-Oe);Mt<=In;Mt+=gt){var Ot=Mt+lt;Re?U(H[Mt+j],H[Ot+j]):N(H[Mt+j],H[Ot+j]),Rt=F.a,H[Ot+j]=F.b,H[Mt+j]=Rt}Oe=ke,ke>>=1}return ge}function ie(H,j,ee,me,Ee,xe,Pe,Re,Fe,ke){for(var Oe=0,ge=0,kt=Re,Ze=Math.trunc(Ee.value+(xe+7)/8);Ee.value<Ze;)for(M(Oe,ge,ee,Ee),Oe=K.c,ge=K.lc;ge>=14;){var Je=Oe>>ge-14&16383,lt=j[Je];if(lt.len)ge-=lt.len,$(lt.lit,Pe,Oe,ge,ee,me,Ee,Fe,ke,kt),Oe=V.c,ge=V.lc;else{if(!lt.p)throw"hufDecode issues";var gt;for(gt=0;gt<lt.lit;gt++){for(var Rt=Y(H[lt.p[gt]]);ge<Rt&&Ee.value<Ze;)M(Oe,ge,ee,Ee),Oe=K.c,ge=K.lc;if(ge>=Rt&&W(H[lt.p[gt]])==(Oe>>ge-Rt&(1<<Rt)-1)){ge-=Rt,$(lt.p[gt],Pe,Oe,ge,ee,me,Ee,Fe,ke,kt),Oe=V.c,ge=V.lc;break}}if(gt==lt.lit)throw"hufDecode issues"}}var Dt=8-xe&7;for(Oe>>=Dt,ge-=Dt;ge>0;){var lt=j[Oe<<14-ge&16383];if(lt.len)ge-=lt.len,$(lt.lit,Pe,Oe,ge,ee,me,Ee,Fe,ke,kt),Oe=V.c,ge=V.lc;else throw"hufDecode issues"}return!0}function q(H,j,ee,me,Ee,xe){var Pe={value:0},Re=ee.value,Fe=Xe(j,ee),ke=Xe(j,ee);ee.value+=4;var Oe=Xe(j,ee);if(ee.value+=4,Fe<0||Fe>=65537||ke<0||ke>=65537)throw"Something wrong with HUF_ENCSIZE";var ge=new Array(65537),kt=new Array(16384);R(kt);var Ze=me-(ee.value-Re);if(Q(H,j,ee,Ze,Fe,ke,ge),Oe>8*(me-(ee.value-Re)))throw"Something wrong with hufUncompress";P(ge,Fe,ke,kt),ie(ge,kt,H,j,ee,Oe,ke,xe,Ee,Pe)}function ne(H,j,ee){for(var me=0;me<ee;++me)j[me]=H[j[me]]}function ye(H){for(var j=1;j<H.length;j++){var ee=H[j-1]+H[j]-128;H[j]=ee}}function ve(H,j){for(var ee=0,me=Math.floor((H.length+1)/2),Ee=0,xe=H.length-1;!(Ee>xe||(j[Ee++]=H[ee++],Ee>xe));)j[Ee++]=H[me++]}function re(H){for(var j=H.byteLength,ee=new Array,me=0,Ee=new DataView(H);j>0;){var xe=Ee.getInt8(me++);if(xe<0){var Pe=-xe;j-=Pe+1;for(var Re=0;Re<Pe;Re++)ee.push(Ee.getUint8(me++))}else{var Pe=xe;j-=2;for(var Fe=Ee.getUint8(me++),Re=0;Re<Pe+1;Re++)ee.push(Fe)}}return ee}function se(H,j,ee,me,Ee,xe){var Ot=new DataView(xe.buffer),Pe=ee[H.idx[0]].width,Re=ee[H.idx[0]].height,Fe=3,ke=Math.floor(Pe/8),Oe=Math.ceil(Pe/8),ge=Math.ceil(Re/8),kt=Pe-(Oe-1)*8,Ze=Re-(ge-1)*8,Je={value:0},lt=new Array(Fe),gt=new Array(Fe),Rt=new Array(Fe),Dt=new Array(Fe),si=new Array(Fe);for(let Lt=0;Lt<Fe;++Lt)si[Lt]=j[H.idx[Lt]],lt[Lt]=Lt<1?0:lt[Lt-1]+Oe*ge,gt[Lt]=new Float32Array(64),Rt[Lt]=new Uint16Array(64),Dt[Lt]=new Uint16Array(Oe*64);for(let Lt=0;Lt<ge;++Lt){var Gi=8;Lt==ge-1&&(Gi=Ze);var Mt=8;for(let Qt=0;Qt<Oe;++Qt){Qt==Oe-1&&(Mt=kt);for(let vt=0;vt<Fe;++vt)Rt[vt].fill(0),Rt[vt][0]=Ee[lt[vt]++],he(Je,me,Rt[vt]),ae(Rt[vt],gt[vt]),J(gt[vt]);X(gt);for(let vt=0;vt<Fe;++vt)oe(gt[vt],Dt[vt],Qt*64)}let _i=0;for(let Qt=0;Qt<Fe;++Qt){const vt=ee[H.idx[Qt]].type;for(let cn=8*Lt;cn<8*Lt+Gi;++cn){_i=si[Qt][cn];for(let Fn=0;Fn<ke;++Fn){const Di=Fn*64+(cn&7)*8;Ot.setUint16(_i+0*2*vt,Dt[Qt][Di+0],!0),Ot.setUint16(_i+1*2*vt,Dt[Qt][Di+1],!0),Ot.setUint16(_i+2*2*vt,Dt[Qt][Di+2],!0),Ot.setUint16(_i+3*2*vt,Dt[Qt][Di+3],!0),Ot.setUint16(_i+4*2*vt,Dt[Qt][Di+4],!0),Ot.setUint16(_i+5*2*vt,Dt[Qt][Di+5],!0),Ot.setUint16(_i+6*2*vt,Dt[Qt][Di+6],!0),Ot.setUint16(_i+7*2*vt,Dt[Qt][Di+7],!0),_i+=8*2*vt}}if(ke!=Oe)for(let cn=8*Lt;cn<8*Lt+Gi;++cn){const Fn=si[Qt][cn]+8*ke*2*vt,Di=ke*64+(cn&7)*8;for(let ts=0;ts<Mt;++ts)Ot.setUint16(Fn+ts*2*vt,Dt[Qt][Di+ts],!0)}}}for(var In=new Uint16Array(Pe),Ot=new DataView(xe.buffer),vi=0;vi<Fe;++vi){ee[H.idx[vi]].decoded=!0;var en=ee[H.idx[vi]].type;if(ee[vi].type==2)for(var Ns=0;Ns<Re;++Ns){const Lt=si[vi][Ns];for(var Ri=0;Ri<Pe;++Ri)In[Ri]=Ot.getUint16(Lt+Ri*2*en,!0);for(var Ri=0;Ri<Pe;++Ri)Ot.setFloat32(Lt+Ri*2*en,pe(In[Ri]),!0)}}}function he(H,j,ee){for(var me,Ee=1;Ee<64;)me=j[H.value],me==65280?Ee=64:me>>8==255?Ee+=me&255:(ee[Ee]=me,Ee++),H.value++}function ae(H,j){j[0]=pe(H[0]),j[1]=pe(H[1]),j[2]=pe(H[5]),j[3]=pe(H[6]),j[4]=pe(H[14]),j[5]=pe(H[15]),j[6]=pe(H[27]),j[7]=pe(H[28]),j[8]=pe(H[2]),j[9]=pe(H[4]),j[10]=pe(H[7]),j[11]=pe(H[13]),j[12]=pe(H[16]),j[13]=pe(H[26]),j[14]=pe(H[29]),j[15]=pe(H[42]),j[16]=pe(H[3]),j[17]=pe(H[8]),j[18]=pe(H[12]),j[19]=pe(H[17]),j[20]=pe(H[25]),j[21]=pe(H[30]),j[22]=pe(H[41]),j[23]=pe(H[43]),j[24]=pe(H[9]),j[25]=pe(H[11]),j[26]=pe(H[18]),j[27]=pe(H[24]),j[28]=pe(H[31]),j[29]=pe(H[40]),j[30]=pe(H[44]),j[31]=pe(H[53]),j[32]=pe(H[10]),j[33]=pe(H[19]),j[34]=pe(H[23]),j[35]=pe(H[32]),j[36]=pe(H[39]),j[37]=pe(H[45]),j[38]=pe(H[52]),j[39]=pe(H[54]),j[40]=pe(H[20]),j[41]=pe(H[22]),j[42]=pe(H[33]),j[43]=pe(H[38]),j[44]=pe(H[46]),j[45]=pe(H[51]),j[46]=pe(H[55]),j[47]=pe(H[60]),j[48]=pe(H[21]),j[49]=pe(H[34]),j[50]=pe(H[37]),j[51]=pe(H[47]),j[52]=pe(H[50]),j[53]=pe(H[56]),j[54]=pe(H[59]),j[55]=pe(H[61]),j[56]=pe(H[35]),j[57]=pe(H[36]),j[58]=pe(H[48]),j[59]=pe(H[49]),j[60]=pe(H[57]),j[61]=pe(H[58]),j[62]=pe(H[62]),j[63]=pe(H[63])}function J(H){const j=.5*Math.cos(.7853975),ee=.5*Math.cos(3.14159/16),me=.5*Math.cos(3.14159/8),Ee=.5*Math.cos(3*3.14159/16),xe=.5*Math.cos(5*3.14159/16),Pe=.5*Math.cos(3*3.14159/8),Re=.5*Math.cos(7*3.14159/16);for(var Fe=new Array(4),ke=new Array(4),Oe=new Array(4),ge=new Array(4),kt=0;kt<8;++kt){var Ze=kt*8;Fe[0]=me*H[Ze+2],Fe[1]=Pe*H[Ze+2],Fe[2]=me*H[Ze+6],Fe[3]=Pe*H[Ze+6],ke[0]=ee*H[Ze+1]+Ee*H[Ze+3]+xe*H[Ze+5]+Re*H[Ze+7],ke[1]=Ee*H[Ze+1]-Re*H[Ze+3]-ee*H[Ze+5]-xe*H[Ze+7],ke[2]=xe*H[Ze+1]-ee*H[Ze+3]+Re*H[Ze+5]+Ee*H[Ze+7],ke[3]=Re*H[Ze+1]-xe*H[Ze+3]+Ee*H[Ze+5]-ee*H[Ze+7],Oe[0]=j*(H[Ze+0]+H[Ze+4]),Oe[3]=j*(H[Ze+0]-H[Ze+4]),Oe[1]=Fe[0]+Fe[3],Oe[2]=Fe[1]-Fe[2],ge[0]=Oe[0]+Oe[1],ge[1]=Oe[3]+Oe[2],ge[2]=Oe[3]-Oe[2],ge[3]=Oe[0]-Oe[1],H[Ze+0]=ge[0]+ke[0],H[Ze+1]=ge[1]+ke[1],H[Ze+2]=ge[2]+ke[2],H[Ze+3]=ge[3]+ke[3],H[Ze+4]=ge[3]-ke[3],H[Ze+5]=ge[2]-ke[2],H[Ze+6]=ge[1]-ke[1],H[Ze+7]=ge[0]-ke[0]}for(var Je=0;Je<8;++Je)Fe[0]=me*H[16+Je],Fe[1]=Pe*H[16+Je],Fe[2]=me*H[48+Je],Fe[3]=Pe*H[48+Je],ke[0]=ee*H[8+Je]+Ee*H[24+Je]+xe*H[40+Je]+Re*H[56+Je],ke[1]=Ee*H[8+Je]-Re*H[24+Je]-ee*H[40+Je]-xe*H[56+Je],ke[2]=xe*H[8+Je]-ee*H[24+Je]+Re*H[40+Je]+Ee*H[56+Je],ke[3]=Re*H[8+Je]-xe*H[24+Je]+Ee*H[40+Je]-ee*H[56+Je],Oe[0]=j*(H[Je]+H[32+Je]),Oe[3]=j*(H[Je]-H[32+Je]),Oe[1]=Fe[0]+Fe[3],Oe[2]=Fe[1]-Fe[2],ge[0]=Oe[0]+Oe[1],ge[1]=Oe[3]+Oe[2],ge[2]=Oe[3]-Oe[2],ge[3]=Oe[0]-Oe[1],H[0+Je]=ge[0]+ke[0],H[8+Je]=ge[1]+ke[1],H[16+Je]=ge[2]+ke[2],H[24+Je]=ge[3]+ke[3],H[32+Je]=ge[3]-ke[3],H[40+Je]=ge[2]-ke[2],H[48+Je]=ge[1]-ke[1],H[56+Je]=ge[0]-ke[0]}function X(H){for(var j=0;j<64;++j){var ee=H[0][j],me=H[1][j],Ee=H[2][j];H[0][j]=ee+1.5747*Ee,H[1][j]=ee-.1873*me-.4682*Ee,H[2][j]=ee+1.8556*me}}function oe(H,j,ee){for(var me=0;me<64;++me)j[ee+me]=jo.toHalfFloat(Ce(H[me]))}function Ce(H){return H<=1?Math.sign(H)*Math.pow(Math.abs(H),2.2):Math.sign(H)*Math.pow(b,Math.abs(H)-1)}function _e(H){return new DataView(H.array.buffer,H.offset.value,H.size)}function Be(H){var j=H.viewer.buffer.slice(H.offset.value,H.offset.value+H.size),ee=new Uint8Array(re(j)),me=new Uint8Array(ee.length);return ye(ee),ve(ee,me),new DataView(me.buffer)}function Se(H){var j=H.array.slice(H.offset.value,H.offset.value+H.size),ee=fl(j),me=new Uint8Array(ee.length);return ye(ee),ve(ee,me),new DataView(me.buffer)}function Ve(H){for(var j=H.viewer,ee={value:H.offset.value},me=new Uint16Array(H.width*H.scanlineBlockSize*(H.channels*H.type)),Ee=new Uint8Array(8192),xe=0,Pe=new Array(H.channels),Re=0;Re<H.channels;Re++)Pe[Re]={},Pe[Re].start=xe,Pe[Re].end=Pe[Re].start,Pe[Re].nx=H.width,Pe[Re].ny=H.lines,Pe[Re].size=H.type,xe+=Pe[Re].nx*Pe[Re].ny*Pe[Re].size;var Fe=ot(j,ee),ke=ot(j,ee);if(ke>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(Fe<=ke)for(var Re=0;Re<ke-Fe+1;Re++)Ee[Re+Fe]=te(j,ee);var Oe=new Uint16Array(65536),ge=T(Ee,Oe),kt=Xe(j,ee);q(H.array,j,ee,kt,me,xe);for(var Re=0;Re<H.channels;++Re)for(var Ze=Pe[Re],Je=0;Je<Pe[Re].size;++Je)Z(me,Ze.start+Je,Ze.nx,Ze.size,Ze.ny,Ze.nx*Ze.size,ge);ne(Oe,me,xe);for(var lt=0,gt=new Uint8Array(me.buffer.byteLength),Rt=0;Rt<H.lines;Rt++)for(var Dt=0;Dt<H.channels;Dt++){var Ze=Pe[Dt],si=Ze.nx*Ze.size,Gi=new Uint8Array(me.buffer,Ze.end*2,si*2);gt.set(Gi,lt),lt+=si*2,Ze.end+=si}return new DataView(gt.buffer)}function Me(H){var j=H.array.slice(H.offset.value,H.offset.value+H.size),ee=fl(j);const me=H.lines*H.channels*H.width,Ee=H.type==1?new Uint16Array(me):new Uint32Array(me);let xe=0,Pe=0;const Re=new Array(4);for(let Fe=0;Fe<H.lines;Fe++)for(let ke=0;ke<H.channels;ke++){let Oe=0;switch(H.type){case 1:Re[0]=xe,Re[1]=Re[0]+H.width,xe=Re[1]+H.width;for(let ge=0;ge<H.width;++ge){const kt=ee[Re[0]++]<<8|ee[Re[1]++];Oe+=kt,Ee[Pe]=Oe,Pe++}break;case 2:Re[0]=xe,Re[1]=Re[0]+H.width,Re[2]=Re[1]+H.width,xe=Re[2]+H.width;for(let ge=0;ge<H.width;++ge){const kt=ee[Re[0]++]<<24|ee[Re[1]++]<<16|ee[Re[2]++]<<8;Oe+=kt,Ee[Pe]=Oe,Pe++}break}}return new DataView(Ee.buffer)}function Ne(H){var j=H.viewer,ee={value:H.offset.value},me=new Uint8Array(H.width*H.lines*(H.channels*H.type*2)),Ee={version:Te(j,ee),unknownUncompressedSize:Te(j,ee),unknownCompressedSize:Te(j,ee),acCompressedSize:Te(j,ee),dcCompressedSize:Te(j,ee),rleCompressedSize:Te(j,ee),rleUncompressedSize:Te(j,ee),rleRawSize:Te(j,ee),totalAcUncompressedCount:Te(j,ee),totalDcUncompressedCount:Te(j,ee),acCompression:Te(j,ee)};if(Ee.version<2)throw"EXRLoader.parse: "+Cn.compression+" version "+Ee.version+" is unsupported";for(var xe=new Array,Pe=ot(j,ee)-2;Pe>0;){var Re=Ge(j.buffer,ee),Fe=te(j,ee),ke=Fe>>2&3,Oe=(Fe>>4)-1,ge=new Int8Array([Oe])[0],kt=te(j,ee);xe.push({name:Re,index:ge,type:kt,compression:ke}),Pe-=Re.length+3}for(var Ze=Cn.channels,Je=new Array(H.channels),lt=0;lt<H.channels;++lt){var gt=Je[lt]={},Rt=Ze[lt];gt.name=Rt.name,gt.compression=0,gt.decoded=!1,gt.type=Rt.pixelType,gt.pLinear=Rt.pLinear,gt.width=H.width,gt.height=H.lines}for(var Dt={idx:new Array(3)},si=0;si<H.channels;++si)for(var gt=Je[si],lt=0;lt<xe.length;++lt){var Gi=xe[lt];gt.name==Gi.name&&(gt.compression=Gi.compression,Gi.index>=0&&(Dt.idx[Gi.index]=si),gt.offset=si)}if(Ee.acCompressedSize>0)switch(Ee.acCompression){case 0:var Ot=new Uint16Array(Ee.totalAcUncompressedCount);q(H.array,j,ee,Ee.acCompressedSize,Ot,Ee.totalAcUncompressedCount);break;case 1:var Mt=H.array.slice(ee.value,ee.value+Ee.totalAcUncompressedCount),In=fl(Mt),Ot=new Uint16Array(In.buffer);ee.value+=Ee.totalAcUncompressedCount;break}if(Ee.dcCompressedSize>0){var vi={array:H.array,offset:ee,size:Ee.dcCompressedSize},en=new Uint16Array(Se(vi).buffer);ee.value+=Ee.dcCompressedSize}if(Ee.rleRawSize>0){var Mt=H.array.slice(ee.value,ee.value+Ee.rleCompressedSize),In=fl(Mt),Ns=re(In.buffer);ee.value+=Ee.rleCompressedSize}for(var Ri=0,Lt=new Array(Je.length),lt=0;lt<Lt.length;++lt)Lt[lt]=new Array;for(var _i=0;_i<H.lines;++_i)for(var Qt=0;Qt<Je.length;++Qt)Lt[Qt].push(Ri),Ri+=Je[Qt].width*H.type*2;se(Dt,Lt,Je,Ot,en,me);for(var lt=0;lt<Je.length;++lt){var gt=Je[lt];if(!gt.decoded)switch(gt.compression){case 2:for(var vt=0,cn=0,_i=0;_i<H.lines;++_i){for(var Fn=Lt[lt][vt],Di=0;Di<gt.width;++Di){for(var ts=0;ts<2*gt.type;++ts)me[Fn++]=Ns[cn+ts*gt.width*gt.height];cn++}vt++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(me.buffer)}function Ge(H,j){for(var ee=new Uint8Array(H),me=0;ee[j.value+me]!=0;)me+=1;var Ee=new TextDecoder().decode(ee.slice(j.value,j.value+me));return j.value=j.value+me+1,Ee}function je(H,j,ee){var me=new TextDecoder().decode(new Uint8Array(H).slice(j.value,j.value+ee));return j.value=j.value+ee,me}function st(H,j){var ee=it(H,j),me=Xe(H,j);return[ee,me]}function At(H,j){var ee=Xe(H,j),me=Xe(H,j);return[ee,me]}function it(H,j){var ee=H.getInt32(j.value,!0);return j.value=j.value+4,ee}function Xe(H,j){var ee=H.getUint32(j.value,!0);return j.value=j.value+4,ee}function We(H,j){var ee=H[j.value];return j.value=j.value+1,ee}function te(H,j){var ee=H.getUint8(j.value);return j.value=j.value+1,ee}const Te=function(H,j){let ee;return"getBigInt64"in DataView.prototype?ee=Number(H.getBigInt64(j.value,!0)):ee=H.getUint32(j.value+4,!0)+Number(H.getUint32(j.value,!0)<<32),j.value+=8,ee};function Le(H,j){var ee=H.getFloat32(j.value,!0);return j.value+=4,ee}function Ke(H,j){return jo.toHalfFloat(Le(H,j))}function pe(H){var j=(H&31744)>>10,ee=H&1023;return(H>>15?-1:1)*(j?j===31?ee?NaN:1/0:Math.pow(2,j-15)*(1+ee/1024):6103515625e-14*(ee/1024))}function ot(H,j){var ee=H.getUint16(j.value,!0);return j.value+=2,ee}function qt(H,j){return pe(ot(H,j))}function Bt(H,j,ee,me){for(var Ee=ee.value,xe=[];ee.value<Ee+me-1;){var Pe=Ge(j,ee),Re=it(H,ee),Fe=te(H,ee);ee.value+=3;var ke=it(H,ee),Oe=it(H,ee);xe.push({name:Pe,pixelType:Re,pLinear:Fe,xSampling:ke,ySampling:Oe})}return ee.value+=1,xe}function pt(H,j){var ee=Le(H,j),me=Le(H,j),Ee=Le(H,j),xe=Le(H,j),Pe=Le(H,j),Re=Le(H,j),Fe=Le(H,j),ke=Le(H,j);return{redX:ee,redY:me,greenX:Ee,greenY:xe,blueX:Pe,blueY:Re,whiteX:Fe,whiteY:ke}}function Tt(H,j){var ee=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],me=te(H,j);return ee[me]}function _t(H,j){var ee=Xe(H,j),me=Xe(H,j),Ee=Xe(H,j),xe=Xe(H,j);return{xMin:ee,yMin:me,xMax:Ee,yMax:xe}}function at(H,j){var ee=["INCREASING_Y"],me=te(H,j);return ee[me]}function bt(H,j){var ee=Le(H,j),me=Le(H,j);return[ee,me]}function ai(H,j){var ee=Le(H,j),me=Le(H,j),Ee=Le(H,j);return[ee,me,Ee]}function li(H,j,ee,me,Ee){if(me==="string"||me==="stringvector"||me==="iccProfile")return je(j,ee,Ee);if(me==="chlist")return Bt(H,j,ee,Ee);if(me==="chromaticities")return pt(H,ee);if(me==="compression")return Tt(H,ee);if(me==="box2i")return _t(H,ee);if(me==="lineOrder")return at(H,ee);if(me==="float")return Le(H,ee);if(me==="v2f")return bt(H,ee);if(me==="v3f")return ai(H,ee);if(me==="int")return it(H,ee);if(me==="rational")return st(H,ee);if(me==="timecode")return At(H,ee);if(me==="preview")return ee.value+=Ee,"skipped";ee.value+=Ee}function yi(H,j,ee){const me={};if(H.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";me.version=H.getUint8(4);const Ee=H.getUint8(5);me.spec={singleTile:!!(Ee&2),longName:!!(Ee&4),deepFormat:!!(Ee&8),multiPart:!!(Ee&16)},ee.value=8;for(var xe=!0;xe;){var Pe=Ge(j,ee);if(Pe==0)xe=!1;else{var Re=Ge(j,ee),Fe=Xe(H,ee),ke=li(H,j,ee,Re,Fe);ke===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${Re}'.`):me[Pe]=ke}}if(Ee&-5)throw console.error("EXRHeader:",me),"THREE.EXRLoader: provided file is currently unsupported.";return me}function En(H,j,ee,me,Ee){const xe={size:0,viewer:j,array:ee,offset:me,width:H.dataWindow.xMax-H.dataWindow.xMin+1,height:H.dataWindow.yMax-H.dataWindow.yMin+1,channels:H.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:H.channels[0].pixelType,uncompress:null,getter:null,format:null,[Va?"colorSpace":"encoding"]:null};switch(H.compression){case"NO_COMPRESSION":xe.lines=1,xe.uncompress=_e;break;case"RLE_COMPRESSION":xe.lines=1,xe.uncompress=Be;break;case"ZIPS_COMPRESSION":xe.lines=1,xe.uncompress=Se;break;case"ZIP_COMPRESSION":xe.lines=16,xe.uncompress=Se;break;case"PIZ_COMPRESSION":xe.lines=32,xe.uncompress=Ve;break;case"PXR24_COMPRESSION":xe.lines=16,xe.uncompress=Me;break;case"DWAA_COMPRESSION":xe.lines=32,xe.uncompress=Ne;break;case"DWAB_COMPRESSION":xe.lines=256,xe.uncompress=Ne;break;default:throw"EXRLoader.parse: "+H.compression+" is unsupported"}if(xe.scanlineBlockSize=xe.lines,xe.type==1)switch(Ee){case ii:xe.getter=qt,xe.inputSize=2;break;case fi:xe.getter=ot,xe.inputSize=2;break}else if(xe.type==2)switch(Ee){case ii:xe.getter=Le,xe.inputSize=4;break;case fi:xe.getter=Ke,xe.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+xe.type+" for "+H.compression+".";xe.blockCount=(H.dataWindow.yMax+1)/xe.scanlineBlockSize;for(var Pe=0;Pe<xe.blockCount;Pe++)Te(j,me);xe.outputChannels=xe.channels==3?4:xe.channels;const Re=xe.width*xe.height*xe.outputChannels;switch(Ee){case ii:xe.byteArray=new Float32Array(Re),xe.channels<xe.outputChannels&&xe.byteArray.fill(1,0,Re);break;case fi:xe.byteArray=new Uint16Array(Re),xe.channels<xe.outputChannels&&xe.byteArray.fill(15360,0,Re);break;default:console.error("THREE.EXRLoader: unsupported type: ",Ee);break}return xe.bytesPerLine=xe.width*xe.inputSize*xe.channels,xe.outputChannels==4?xe.format=wi:xe.format=Ds,Va?xe.colorSpace="srgb-linear":xe.encoding=3e3,xe}const xn=new DataView(e),es=new Uint8Array(e),ln={value:0},Cn=yi(xn,e,ln),ht=En(Cn,xn,es,ln,this.type),Ni={value:0},Us={R:0,G:1,B:2,A:3,Y:0};for(let H=0;H<ht.height/ht.scanlineBlockSize;H++){const j=Xe(xn,ln);ht.size=Xe(xn,ln),ht.lines=j+ht.scanlineBlockSize>ht.height?ht.height-j:ht.scanlineBlockSize;const me=ht.size<ht.lines*ht.bytesPerLine?ht.uncompress(ht):_e(ht);ln.value+=ht.size;for(let Ee=0;Ee<ht.scanlineBlockSize;Ee++){const xe=Ee+H*ht.scanlineBlockSize;if(xe>=ht.height)break;for(let Pe=0;Pe<ht.channels;Pe++){const Re=Us[Cn.channels[Pe].name];for(let Fe=0;Fe<ht.width;Fe++){Ni.value=(Ee*(ht.channels*ht.width)+Pe*ht.width+Fe)*ht.inputSize;const ke=(ht.height-1-xe)*(ht.width*ht.outputChannels)+Fe*ht.outputChannels+Re;ht.byteArray[ke]=ht.getter(me,Ni)}}}}return{header:Cn,width:ht.width,height:ht.height,data:ht.byteArray,format:ht.format,[Va?"colorSpace":"encoding"]:ht[Va?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){Va?o.colorSpace=a.colorSpace:o.encoding=a.encoding,o.minFilter=Ht,o.magFilter=Ht,o.generateMipmaps=!1,o.flipY=!1,t&&t(o,a)}return super.load(e,s,i,n)}}const a5="srgb",Jh=(()=>{class r extends Dr{constructor(t){super(t),this.defaultDPI=90,this.defaultUnit="px"}load(t,i,n,s){const o=this,a=new vn(o.manager);a.setPath(o.path),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(t,function(l){try{i(o.parse(l))}catch(c){s?s(c):console.error(c),o.manager.itemError(t)}},n,s)}parse(t){const i=this;function n(O,F){if(O.nodeType!==1)return;const U=C(O);let N=!1,Z=null;switch(O.nodeName){case"svg":F=A(O,F);break;case"style":o(O);break;case"g":F=A(O,F);break;case"path":F=A(O,F),O.hasAttribute("d")&&(Z=s(O));break;case"rect":F=A(O,F),Z=c(O);break;case"polygon":F=A(O,F),Z=u(O);break;case"polyline":F=A(O,F),Z=h(O);break;case"circle":F=A(O,F),Z=f(O);break;case"ellipse":F=A(O,F),Z=d(O);break;case"line":F=A(O,F),Z=m(O);break;case"defs":N=!0;break;case"use":F=A(O,F);const ne=(O.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),ye=O.viewportElement.getElementById(ne);ye?n(ye,F):console.warn("SVGLoader: 'use node' references non-existent node id: "+ne);break}Z&&(F.fill!==void 0&&F.fill!=="none"&&Z.color.setStyle(F.fill,a5),_(Z,V),B.push(Z),Z.userData={node:O,style:F});const ie=O.childNodes;for(let q=0;q<ie.length;q++){const ne=ie[q];N&&ne.nodeName!=="style"&&ne.nodeName!=="defs"||n(ne,F)}U&&(k.pop(),k.length>0?V.copy(k[k.length-1]):V.identity())}function s(O){const F=new gr,U=new De,N=new De,Z=new De;let ie=!0,q=!1;const ne=O.getAttribute("d");if(ne===""||ne==="none")return null;const ye=ne.match(/[a-df-z][^a-df-z]*/gi);for(let ve=0,re=ye.length;ve<re;ve++){const se=ye[ve],he=se.charAt(0),ae=se.slice(1).trim();ie===!0&&(q=!0,ie=!1);let J;switch(he){case"M":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2)U.x=J[X+0],U.y=J[X+1],N.x=U.x,N.y=U.y,X===0?F.moveTo(U.x,U.y):F.lineTo(U.x,U.y),X===0&&Z.copy(U);break;case"H":J=y(ae);for(let X=0,oe=J.length;X<oe;X++)U.x=J[X],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"V":J=y(ae);for(let X=0,oe=J.length;X<oe;X++)U.y=J[X],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"L":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2)U.x=J[X+0],U.y=J[X+1],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"C":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=6)F.bezierCurveTo(J[X+0],J[X+1],J[X+2],J[X+3],J[X+4],J[X+5]),N.x=J[X+2],N.y=J[X+3],U.x=J[X+4],U.y=J[X+5],X===0&&q===!0&&Z.copy(U);break;case"S":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=4)F.bezierCurveTo(p(U.x,N.x),p(U.y,N.y),J[X+0],J[X+1],J[X+2],J[X+3]),N.x=J[X+0],N.y=J[X+1],U.x=J[X+2],U.y=J[X+3],X===0&&q===!0&&Z.copy(U);break;case"Q":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=4)F.quadraticCurveTo(J[X+0],J[X+1],J[X+2],J[X+3]),N.x=J[X+0],N.y=J[X+1],U.x=J[X+2],U.y=J[X+3],X===0&&q===!0&&Z.copy(U);break;case"T":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2){const Ce=p(U.x,N.x),_e=p(U.y,N.y);F.quadraticCurveTo(Ce,_e,J[X+0],J[X+1]),N.x=Ce,N.y=_e,U.x=J[X+0],U.y=J[X+1],X===0&&q===!0&&Z.copy(U)}break;case"A":J=y(ae,[3,4],7);for(let X=0,oe=J.length;X<oe;X+=7){if(J[X+5]==U.x&&J[X+6]==U.y)continue;const Ce=U.clone();U.x=J[X+5],U.y=J[X+6],N.x=U.x,N.y=U.y,a(F,J[X],J[X+1],J[X+2],J[X+3],J[X+4],Ce,U),X===0&&q===!0&&Z.copy(U)}break;case"m":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2)U.x+=J[X+0],U.y+=J[X+1],N.x=U.x,N.y=U.y,X===0?F.moveTo(U.x,U.y):F.lineTo(U.x,U.y),X===0&&Z.copy(U);break;case"h":J=y(ae);for(let X=0,oe=J.length;X<oe;X++)U.x+=J[X],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"v":J=y(ae);for(let X=0,oe=J.length;X<oe;X++)U.y+=J[X],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"l":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2)U.x+=J[X+0],U.y+=J[X+1],N.x=U.x,N.y=U.y,F.lineTo(U.x,U.y),X===0&&q===!0&&Z.copy(U);break;case"c":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=6)F.bezierCurveTo(U.x+J[X+0],U.y+J[X+1],U.x+J[X+2],U.y+J[X+3],U.x+J[X+4],U.y+J[X+5]),N.x=U.x+J[X+2],N.y=U.y+J[X+3],U.x+=J[X+4],U.y+=J[X+5],X===0&&q===!0&&Z.copy(U);break;case"s":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=4)F.bezierCurveTo(p(U.x,N.x),p(U.y,N.y),U.x+J[X+0],U.y+J[X+1],U.x+J[X+2],U.y+J[X+3]),N.x=U.x+J[X+0],N.y=U.y+J[X+1],U.x+=J[X+2],U.y+=J[X+3],X===0&&q===!0&&Z.copy(U);break;case"q":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=4)F.quadraticCurveTo(U.x+J[X+0],U.y+J[X+1],U.x+J[X+2],U.y+J[X+3]),N.x=U.x+J[X+0],N.y=U.y+J[X+1],U.x+=J[X+2],U.y+=J[X+3],X===0&&q===!0&&Z.copy(U);break;case"t":J=y(ae);for(let X=0,oe=J.length;X<oe;X+=2){const Ce=p(U.x,N.x),_e=p(U.y,N.y);F.quadraticCurveTo(Ce,_e,U.x+J[X+0],U.y+J[X+1]),N.x=Ce,N.y=_e,U.x=U.x+J[X+0],U.y=U.y+J[X+1],X===0&&q===!0&&Z.copy(U)}break;case"a":J=y(ae,[3,4],7);for(let X=0,oe=J.length;X<oe;X+=7){if(J[X+5]==0&&J[X+6]==0)continue;const Ce=U.clone();U.x+=J[X+5],U.y+=J[X+6],N.x=U.x,N.y=U.y,a(F,J[X],J[X+1],J[X+2],J[X+3],J[X+4],Ce,U),X===0&&q===!0&&Z.copy(U)}break;case"Z":case"z":F.currentPath.autoClose=!0,F.currentPath.curves.length>0&&(U.copy(Z),F.currentPath.currentPoint.copy(U),ie=!0);break;default:console.warn(se)}q=!1}return F}function o(O){if(!(!O.sheet||!O.sheet.cssRules||!O.sheet.cssRules.length))for(let F=0;F<O.sheet.cssRules.length;F++){const U=O.sheet.cssRules[F];if(U.type!==1)continue;const N=U.selectorText.split(/,/gm).filter(Boolean).map(Z=>Z.trim());for(let Z=0;Z<N.length;Z++){const ie=Object.fromEntries(Object.entries(U.style).filter(([,q])=>q!==""));D[N[Z]]=Object.assign(D[N[Z]]||{},ie)}}}function a(O,F,U,N,Z,ie,q,ne){if(F==0||U==0){O.lineTo(ne.x,ne.y);return}N=N*Math.PI/180,F=Math.abs(F),U=Math.abs(U);const ye=(q.x-ne.x)/2,ve=(q.y-ne.y)/2,re=Math.cos(N)*ye+Math.sin(N)*ve,se=-Math.sin(N)*ye+Math.cos(N)*ve;let he=F*F,ae=U*U;const J=re*re,X=se*se,oe=J/he+X/ae;if(oe>1){const st=Math.sqrt(oe);F=st*F,U=st*U,he=F*F,ae=U*U}const Ce=he*X+ae*J,_e=(he*ae-Ce)/Ce;let Be=Math.sqrt(Math.max(0,_e));Z===ie&&(Be=-Be);const Se=Be*F*se/U,Ve=-Be*U*re/F,Me=Math.cos(N)*Se-Math.sin(N)*Ve+(q.x+ne.x)/2,Ne=Math.sin(N)*Se+Math.cos(N)*Ve+(q.y+ne.y)/2,Ge=l(1,0,(re-Se)/F,(se-Ve)/U),je=l((re-Se)/F,(se-Ve)/U,(-re-Se)/F,(-se-Ve)/U)%(Math.PI*2);O.currentPath.absellipse(Me,Ne,F,U,Ge,Ge+je,ie===0,N)}function l(O,F,U,N){const Z=O*U+F*N,ie=Math.sqrt(O*O+F*F)*Math.sqrt(U*U+N*N);let q=Math.acos(Math.max(-1,Math.min(1,Z/ie)));return O*N-F*U<0&&(q=-q),q}function c(O){const F=x(O.getAttribute("x")||0),U=x(O.getAttribute("y")||0),N=x(O.getAttribute("rx")||O.getAttribute("ry")||0),Z=x(O.getAttribute("ry")||O.getAttribute("rx")||0),ie=x(O.getAttribute("width")),q=x(O.getAttribute("height")),ne=1-.551915024494,ye=new gr;return ye.moveTo(F+N,U),ye.lineTo(F+ie-N,U),(N!==0||Z!==0)&&ye.bezierCurveTo(F+ie-N*ne,U,F+ie,U+Z*ne,F+ie,U+Z),ye.lineTo(F+ie,U+q-Z),(N!==0||Z!==0)&&ye.bezierCurveTo(F+ie,U+q-Z*ne,F+ie-N*ne,U+q,F+ie-N,U+q),ye.lineTo(F+N,U+q),(N!==0||Z!==0)&&ye.bezierCurveTo(F+N*ne,U+q,F,U+q-Z*ne,F,U+q-Z),ye.lineTo(F,U+Z),(N!==0||Z!==0)&&ye.bezierCurveTo(F,U+Z*ne,F+N*ne,U,F+N,U),ye}function u(O){function F(ie,q,ne){const ye=x(q),ve=x(ne);Z===0?N.moveTo(ye,ve):N.lineTo(ye,ve),Z++}const U=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,N=new gr;let Z=0;return O.getAttribute("points").replace(U,F),N.currentPath.autoClose=!0,N}function h(O){function F(ie,q,ne){const ye=x(q),ve=x(ne);Z===0?N.moveTo(ye,ve):N.lineTo(ye,ve),Z++}const U=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,N=new gr;let Z=0;return O.getAttribute("points").replace(U,F),N.currentPath.autoClose=!1,N}function f(O){const F=x(O.getAttribute("cx")||0),U=x(O.getAttribute("cy")||0),N=x(O.getAttribute("r")||0),Z=new wh;Z.absarc(F,U,N,0,Math.PI*2);const ie=new gr;return ie.subPaths.push(Z),ie}function d(O){const F=x(O.getAttribute("cx")||0),U=x(O.getAttribute("cy")||0),N=x(O.getAttribute("rx")||0),Z=x(O.getAttribute("ry")||0),ie=new wh;ie.absellipse(F,U,N,Z,0,Math.PI*2);const q=new gr;return q.subPaths.push(ie),q}function m(O){const F=x(O.getAttribute("x1")||0),U=x(O.getAttribute("y1")||0),N=x(O.getAttribute("x2")||0),Z=x(O.getAttribute("y2")||0),ie=new gr;return ie.moveTo(F,U),ie.lineTo(N,Z),ie.currentPath.autoClose=!1,ie}function A(O,F){F=Object.assign({},F);let U={};if(O.hasAttribute("class")){const q=O.getAttribute("class").split(/\s/).filter(Boolean).map(ne=>ne.trim());for(let ne=0;ne<q.length;ne++)U=Object.assign(U,D["."+q[ne]])}O.hasAttribute("id")&&(U=Object.assign(U,D["#"+O.getAttribute("id")]));function N(q,ne,ye){ye===void 0&&(ye=function(re){return re.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),re}),O.hasAttribute(q)&&(F[ne]=ye(O.getAttribute(q))),U[q]&&(F[ne]=ye(U[q])),O.style&&O.style[q]!==""&&(F[ne]=ye(O.style[q]))}function Z(q){return Math.max(0,Math.min(1,x(q)))}function ie(q){return Math.max(0,x(q))}return N("fill","fill"),N("fill-opacity","fillOpacity",Z),N("fill-rule","fillRule"),N("opacity","opacity",Z),N("stroke","stroke"),N("stroke-opacity","strokeOpacity",Z),N("stroke-width","strokeWidth",ie),N("stroke-linejoin","strokeLineJoin"),N("stroke-linecap","strokeLineCap"),N("stroke-miterlimit","strokeMiterLimit",ie),N("visibility","visibility"),F}function p(O,F){return O-(F-O)}function y(O,F,U){if(typeof O!="string")throw new TypeError("Invalid input: "+typeof O);const N={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},Z=0,ie=1,q=2,ne=3;let ye=Z,ve=!0,re="",se="";const he=[];function ae(Ce,_e,Be){const Se=new SyntaxError('Unexpected character "'+Ce+'" at index '+_e+".");throw Se.partial=Be,Se}function J(){re!==""&&(se===""?he.push(Number(re)):he.push(Number(re)*Math.pow(10,Number(se)))),re="",se=""}let X;const oe=O.length;for(let Ce=0;Ce<oe;Ce++){if(X=O[Ce],Array.isArray(F)&&F.includes(he.length%U)&&N.FLAGS.test(X)){ye=ie,re=X,J();continue}if(ye===Z){if(N.WHITESPACE.test(X))continue;if(N.DIGIT.test(X)||N.SIGN.test(X)){ye=ie,re=X;continue}if(N.POINT.test(X)){ye=q,re=X;continue}N.COMMA.test(X)&&(ve&&ae(X,Ce,he),ve=!0)}if(ye===ie){if(N.DIGIT.test(X)){re+=X;continue}if(N.POINT.test(X)){re+=X,ye=q;continue}if(N.EXP.test(X)){ye=ne;continue}N.SIGN.test(X)&&re.length===1&&N.SIGN.test(re[0])&&ae(X,Ce,he)}if(ye===q){if(N.DIGIT.test(X)){re+=X;continue}if(N.EXP.test(X)){ye=ne;continue}N.POINT.test(X)&&re[re.length-1]==="."&&ae(X,Ce,he)}if(ye===ne){if(N.DIGIT.test(X)){se+=X;continue}if(N.SIGN.test(X)){if(se===""){se+=X;continue}se.length===1&&N.SIGN.test(se)&&ae(X,Ce,he)}}N.WHITESPACE.test(X)?(J(),ye=Z,ve=!1):N.COMMA.test(X)?(J(),ye=Z,ve=!0):N.SIGN.test(X)?(J(),ye=ie,re=X):N.POINT.test(X)?(J(),ye=q,re=X):ae(X,Ce,he)}return J(),he}const E=["mm","cm","in","pt","pc","px"],v={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:72/6,pc:1,px:-1},px:{px:1}};function x(O){let F="px";if(typeof O=="string"||O instanceof String)for(let N=0,Z=E.length;N<Z;N++){const ie=E[N];if(O.endsWith(ie)){F=ie,O=O.substring(0,O.length-ie.length);break}}let U;return F==="px"&&i.defaultUnit!=="px"?U=v.in[i.defaultUnit]/i.defaultDPI:(U=v[F][i.defaultUnit],U<0&&(U=v[F].in*i.defaultDPI)),U*parseFloat(O)}function C(O){if(!(O.hasAttribute("transform")||O.nodeName==="use"&&(O.hasAttribute("x")||O.hasAttribute("y"))))return null;const F=I(O);return k.length>0&&F.premultiply(k[k.length-1]),V.copy(F),k.push(F),F}function I(O){const F=new bn,U=Q;if(O.nodeName==="use"&&(O.hasAttribute("x")||O.hasAttribute("y"))){const N=x(O.getAttribute("x")),Z=x(O.getAttribute("y"));F.translate(N,Z)}if(O.hasAttribute("transform")){const N=O.getAttribute("transform").split(")");for(let Z=N.length-1;Z>=0;Z--){const ie=N[Z].trim();if(ie==="")continue;const q=ie.indexOf("("),ne=ie.length;if(q>0&&q<ne){const ye=ie.slice(0,q),ve=y(ie.slice(q+1));switch(U.identity(),ye){case"translate":if(ve.length>=1){const re=ve[0];let se=0;ve.length>=2&&(se=ve[1]),U.translate(re,se)}break;case"rotate":if(ve.length>=1){let re=0,se=0,he=0;re=ve[0]*Math.PI/180,ve.length>=3&&(se=ve[1],he=ve[2]),Y.makeTranslation(-se,-he),W.makeRotation(re),P.multiplyMatrices(W,Y),Y.makeTranslation(se,he),U.multiplyMatrices(Y,P)}break;case"scale":if(ve.length>=1){const re=ve[0];let se=re;ve.length>=2&&(se=ve[1]),U.scale(re,se)}break;case"skewX":ve.length===1&&U.set(1,Math.tan(ve[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":ve.length===1&&U.set(1,0,0,Math.tan(ve[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":ve.length===6&&U.set(ve[0],ve[2],ve[4],ve[1],ve[3],ve[5],0,0,1);break}}F.premultiply(U)}}return F}function _(O,F){function U(q){M.set(q.x,q.y,1).applyMatrix3(F),q.set(M.x,M.y)}function N(q){const ne=q.xRadius,ye=q.yRadius,ve=Math.cos(q.aRotation),re=Math.sin(q.aRotation),se=new z(ne*ve,ne*re,0),he=new z(-ye*re,ye*ve,0),ae=se.applyMatrix3(F),J=he.applyMatrix3(F),X=Q.set(ae.x,J.x,0,ae.y,J.y,0,0,0,1),oe=Y.copy(X).invert(),Be=W.copy(oe).transpose().multiply(oe).elements,Se=w(Be[0],Be[1],Be[4]),Ve=Math.sqrt(Se.rt1),Me=Math.sqrt(Se.rt2);if(q.xRadius=1/Ve,q.yRadius=1/Me,q.aRotation=Math.atan2(Se.sn,Se.cs),!((q.aEndAngle-q.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const Ge=Y.set(Ve,0,0,0,Me,0,0,0,1),je=W.set(Se.cs,Se.sn,0,-Se.sn,Se.cs,0,0,0,1),st=Ge.multiply(je).multiply(X),At=it=>{const{x:Xe,y:We}=new z(Math.cos(it),Math.sin(it),0).applyMatrix3(st);return Math.atan2(We,Xe)};q.aStartAngle=At(q.aStartAngle),q.aEndAngle=At(q.aEndAngle),S(F)&&(q.aClockwise=!q.aClockwise)}}function Z(q){const ne=T(F),ye=R(F);q.xRadius*=ne,q.yRadius*=ye;const ve=ne>Number.EPSILON?Math.atan2(F.elements[1],F.elements[0]):Math.atan2(-F.elements[3],F.elements[4]);q.aRotation+=ve,S(F)&&(q.aStartAngle*=-1,q.aEndAngle*=-1,q.aClockwise=!q.aClockwise)}const ie=O.subPaths;for(let q=0,ne=ie.length;q<ne;q++){const ve=ie[q].curves;for(let re=0;re<ve.length;re++){const se=ve[re];se.isLineCurve?(U(se.v1),U(se.v2)):se.isCubicBezierCurve?(U(se.v0),U(se.v1),U(se.v2),U(se.v3)):se.isQuadraticBezierCurve?(U(se.v0),U(se.v1),U(se.v2)):se.isEllipseCurve&&(K.set(se.aX,se.aY),U(K),se.aX=K.x,se.aY=K.y,b(F)?N(se):Z(se))}}}function S(O){const F=O.elements;return F[0]*F[4]-F[1]*F[3]<0}function b(O){const F=O.elements,U=F[0]*F[3]+F[1]*F[4];if(U===0)return!1;const N=T(O),Z=R(O);return Math.abs(U/(N*Z))>Number.EPSILON}function T(O){const F=O.elements;return Math.sqrt(F[0]*F[0]+F[1]*F[1])}function R(O){const F=O.elements;return Math.sqrt(F[3]*F[3]+F[4]*F[4])}function w(O,F,U){let N,Z,ie,q,ne;const ye=O+U,ve=O-U,re=Math.sqrt(ve*ve+4*F*F);return ye>0?(N=.5*(ye+re),ne=1/N,Z=O*ne*U-F*ne*F):ye<0?Z=.5*(ye-re):(N=.5*re,Z=-.5*re),ve>0?ie=ve+re:ie=ve-re,Math.abs(ie)>2*Math.abs(F)?(ne=-2*F/ie,q=1/Math.sqrt(1+ne*ne),ie=ne*q):Math.abs(F)===0?(ie=1,q=0):(ne=-.5*ie/F,ie=1/Math.sqrt(1+ne*ne),q=ne*ie),ve>0&&(ne=ie,ie=-q,q=ne),{rt1:N,rt2:Z,cs:ie,sn:q}}const B=[],D={},k=[],Q=new bn,Y=new bn,W=new bn,P=new bn,K=new De,M=new z,V=new bn,$=new DOMParser().parseFromString(t,"image/svg+xml");return n($.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:B,xml:$.documentElement}}static createShapes(t){const n={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},s={loc:n.ORIGIN,t:0};function o(p,y,E,v){const x=p.x,C=y.x,I=E.x,_=v.x,S=p.y,b=y.y,T=E.y,R=v.y,w=(_-I)*(S-T)-(R-T)*(x-I),B=(C-x)*(S-T)-(b-S)*(x-I),D=(R-T)*(C-x)-(_-I)*(b-S),k=w/D,Q=B/D;if(D===0&&w!==0||k<=0||k>=1||Q<0||Q>1)return null;if(w===0&&D===0){for(let Y=0;Y<2;Y++)if(a(Y===0?E:v,p,y),s.loc==n.ORIGIN){const W=Y===0?E:v;return{x:W.x,y:W.y,t:s.t}}else if(s.loc==n.BETWEEN){const W=+(x+s.t*(C-x)).toPrecision(10),P=+(S+s.t*(b-S)).toPrecision(10);return{x:W,y:P,t:s.t}}return null}else{for(let P=0;P<2;P++)if(a(P===0?E:v,p,y),s.loc==n.ORIGIN){const K=P===0?E:v;return{x:K.x,y:K.y,t:s.t}}const Y=+(x+k*(C-x)).toPrecision(10),W=+(S+k*(b-S)).toPrecision(10);return{x:Y,y:W,t:k}}}function a(p,y,E){const v=E.x-y.x,x=E.y-y.y,C=p.x-y.x,I=p.y-y.y,_=v*I-C*x;if(p.x===y.x&&p.y===y.y){s.loc=n.ORIGIN,s.t=0;return}if(p.x===E.x&&p.y===E.y){s.loc=n.DESTINATION,s.t=1;return}if(_<-Number.EPSILON){s.loc=n.LEFT;return}if(_>Number.EPSILON){s.loc=n.RIGHT;return}if(v*C<0||x*I<0){s.loc=n.BEHIND;return}if(Math.sqrt(v*v+x*x)<Math.sqrt(C*C+I*I)){s.loc=n.BEYOND;return}let S;v!==0?S=C/v:S=I/x,s.loc=n.BETWEEN,s.t=S}function l(p,y){const E=[],v=[];for(let x=1;x<p.length;x++){const C=p[x-1],I=p[x];for(let _=1;_<y.length;_++){const S=y[_-1],b=y[_],T=o(C,I,S,b);T!==null&&E.find(R=>R.t<=T.t+Number.EPSILON&&R.t>=T.t-Number.EPSILON)===void 0&&(E.push(T),v.push(new De(T.x,T.y)))}}return v}function c(p,y,E){const v=new De;y.getCenter(v);const x=[];return E.forEach(C=>{C.boundingBox.containsPoint(v)&&l(p,C.points).forEach(_=>{x.push({identifier:C.identifier,isCW:C.isCW,point:_})})}),x.sort((C,I)=>C.point.x-I.point.x),x}function u(p,y,E,v,x){(x==null||x==="")&&(x="nonzero");const C=new De;p.boundingBox.getCenter(C);const I=[new De(E,C.y),new De(v,C.y)],_=c(I,p.boundingBox,y);_.sort((B,D)=>B.point.x-D.point.x);const S=[],b=[];_.forEach(B=>{B.identifier===p.identifier?S.push(B):b.push(B)});const T=S[0].point.x,R=[];let w=0;for(;w<b.length&&b[w].point.x<T;)R.length>0&&R[R.length-1]===b[w].identifier?R.pop():R.push(b[w].identifier),w++;if(R.push(p.identifier),x==="evenodd"){const B=R.length%2===0,D=R[R.length-2];return{identifier:p.identifier,isHole:B,for:D}}else if(x==="nonzero"){let B=!0,D=null,k=null;for(let Q=0;Q<R.length;Q++){const Y=R[Q];B?(k=y[Y].isCW,B=!1,D=Y):k!==y[Y].isCW&&(k=y[Y].isCW,B=!0)}return{identifier:p.identifier,isHole:B,for:D}}else console.warn('fill-rule: "'+x+'" is currently not implemented.')}let h=999999999,f=-999999999,d=t.subPaths.map(p=>{const y=p.getPoints();let E=-999999999,v=999999999,x=-999999999,C=999999999;for(let I=0;I<y.length;I++){const _=y[I];_.y>E&&(E=_.y),_.y<v&&(v=_.y),_.x>x&&(x=_.x),_.x<C&&(C=_.x)}return f<=x&&(f=x+1),h>=C&&(h=C-1),{curves:p.curves,points:y,isCW:Jx.isClockWise(y),identifier:-1,boundingBox:new Zx(new De(C,v),new De(x,E))}});d=d.filter(p=>p.points.length>1);for(let p=0;p<d.length;p++)d[p].identifier=p;const m=d.map(p=>u(p,d,h,f,t.userData?t.userData.style.fillRule:void 0)),A=[];return d.forEach(p=>{if(!m[p.identifier].isHole){const E=new Zy;E.curves=p.curves,m.filter(x=>x.isHole&&x.for===p.identifier).forEach(x=>{const C=d[x.identifier],I=new wh;I.curves=C.curves,E.holes.push(I)}),A.push(E)}}),A}static getStrokeStyle(t,i,n,s,o){return t=t!==void 0?t:1,i=i!==void 0?i:"#000",n=n!==void 0?n:"miter",s=s!==void 0?s:"butt",o=o!==void 0?o:4,{strokeColor:i,strokeWidth:t,strokeLineJoin:n,strokeLineCap:s,strokeMiterLimit:o}}static pointsToStroke(t,i,n,s){const o=[],a=[],l=[];if(r.pointsToStrokeWithBuffers(t,i,n,s,o,a,l)===0)return null;const c=new ki;return c.setAttribute("position",new Vi(o,3)),c.setAttribute("normal",new Vi(a,3)),c.setAttribute("uv",new Vi(l,2)),c}static pointsToStrokeWithBuffers(t,i,n,s,o,a,l,c){const u=new De,h=new De,f=new De,d=new De,m=new De,A=new De,p=new De,y=new De,E=new De,v=new De,x=new De,C=new De,I=new De,_=new De,S=new De,b=new De,T=new De;n=n!==void 0?n:12,s=s!==void 0?s:.001,c=c!==void 0?c:0,t=ve(t);const R=t.length;if(R<2)return 0;const w=t[0].equals(t[R-1]);let B,D=t[0],k;const Q=i.strokeWidth/2,Y=1/(R-1);let W=0,P,K,M,V,$=!1,G=0,O=c*3,F=c*2;U(t[0],t[1],u).multiplyScalar(Q),y.copy(t[0]).sub(u),E.copy(t[0]).add(u),v.copy(y),x.copy(E);for(let re=1;re<R;re++){B=t[re],re===R-1?w?k=t[1]:k=void 0:k=t[re+1];const se=u;if(U(D,B,se),f.copy(se).multiplyScalar(Q),C.copy(B).sub(f),I.copy(B).add(f),P=W+Y,K=!1,k!==void 0){U(B,k,h),f.copy(h).multiplyScalar(Q),_.copy(B).sub(f),S.copy(B).add(f),M=!0,f.subVectors(k,D),se.dot(f)<0&&(M=!1),re===1&&($=M),f.subVectors(k,B),f.normalize();const he=Math.abs(se.dot(f));if(he>Number.EPSILON){const ae=Q/he;f.multiplyScalar(-ae),d.subVectors(B,D),m.copy(d).setLength(ae).add(f),b.copy(m).negate();const J=m.length(),X=d.length();d.divideScalar(X),A.subVectors(k,B);const oe=A.length();switch(A.divideScalar(oe),d.dot(b)<X&&A.dot(b)<oe&&(K=!0),T.copy(m).add(B),b.add(B),V=!1,K?M?(S.copy(b),I.copy(b)):(_.copy(b),C.copy(b)):ie(),i.strokeLineJoin){case"bevel":q(M,K,P);break;case"round":ne(M,K),M?Z(B,C,_,P,0):Z(B,S,I,P,1);break;case"miter":case"miter-clip":default:const Ce=Q*i.strokeMiterLimit/J;if(Ce<1)if(i.strokeLineJoin!=="miter-clip"){q(M,K,P);break}else ne(M,K),M?(A.subVectors(T,C).multiplyScalar(Ce).add(C),p.subVectors(T,_).multiplyScalar(Ce).add(_),N(C,P,0),N(A,P,0),N(B,P,.5),N(B,P,.5),N(A,P,0),N(p,P,0),N(B,P,.5),N(p,P,0),N(_,P,0)):(A.subVectors(T,I).multiplyScalar(Ce).add(I),p.subVectors(T,S).multiplyScalar(Ce).add(S),N(I,P,1),N(A,P,1),N(B,P,.5),N(B,P,.5),N(A,P,1),N(p,P,1),N(B,P,.5),N(p,P,1),N(S,P,1));else K?(M?(N(E,W,1),N(y,W,0),N(T,P,0),N(E,W,1),N(T,P,0),N(b,P,1)):(N(E,W,1),N(y,W,0),N(T,P,1),N(y,W,0),N(b,P,0),N(T,P,1)),M?_.copy(T):S.copy(T)):M?(N(C,P,0),N(T,P,0),N(B,P,.5),N(B,P,.5),N(T,P,0),N(_,P,0)):(N(I,P,1),N(T,P,1),N(B,P,.5),N(B,P,.5),N(T,P,1),N(S,P,1)),V=!0;break}}else ie()}else ie();!w&&re===R-1&&ye(t[0],v,x,M,!0,W),W=P,D=B,y.copy(_),E.copy(S)}if(!w)ye(B,C,I,M,!1,P);else if(K&&o){let re=T,se=b;$!==M&&(re=b,se=T),M?(V||$)&&(se.toArray(o,0*3),se.toArray(o,3*3),V&&re.toArray(o,1*3)):(V||!$)&&(se.toArray(o,1*3),se.toArray(o,3*3),V&&re.toArray(o,0*3))}return G;function U(re,se,he){return he.subVectors(se,re),he.set(-he.y,he.x).normalize()}function N(re,se,he){o&&(o[O]=re.x,o[O+1]=re.y,o[O+2]=0,a&&(a[O]=0,a[O+1]=0,a[O+2]=1),O+=3,l&&(l[F]=se,l[F+1]=he,F+=2)),G+=3}function Z(re,se,he,ae,J){u.copy(se).sub(re).normalize(),h.copy(he).sub(re).normalize();let X=Math.PI;const oe=u.dot(h);Math.abs(oe)<1&&(X=Math.abs(Math.acos(oe))),X/=n,f.copy(se);for(let Ce=0,_e=n-1;Ce<_e;Ce++)d.copy(f).rotateAround(re,X),N(f,ae,J),N(d,ae,J),N(re,ae,.5),f.copy(d);N(d,ae,J),N(he,ae,J),N(re,ae,.5)}function ie(){N(E,W,1),N(y,W,0),N(C,P,0),N(E,W,1),N(C,P,0),N(I,P,1)}function q(re,se,he){se?re?(N(E,W,1),N(y,W,0),N(C,P,0),N(E,W,1),N(C,P,0),N(b,P,1),N(C,he,0),N(_,he,0),N(b,he,.5)):(N(E,W,1),N(y,W,0),N(I,P,1),N(y,W,0),N(b,P,0),N(I,P,1),N(I,he,1),N(b,he,0),N(S,he,1)):re?(N(C,he,0),N(_,he,0),N(B,he,.5)):(N(I,he,1),N(S,he,0),N(B,he,.5))}function ne(re,se){se&&(re?(N(E,W,1),N(y,W,0),N(C,P,0),N(E,W,1),N(C,P,0),N(b,P,1),N(C,W,0),N(B,P,.5),N(b,P,1),N(B,P,.5),N(_,W,0),N(b,P,1)):(N(E,W,1),N(y,W,0),N(I,P,1),N(y,W,0),N(b,P,0),N(I,P,1),N(I,W,1),N(b,P,0),N(B,P,.5),N(B,P,.5),N(b,P,0),N(S,W,1)))}function ye(re,se,he,ae,J,X){switch(i.strokeLineCap){case"round":J?Z(re,he,se,X,.5):Z(re,se,he,X,.5);break;case"square":if(J)u.subVectors(se,re),h.set(u.y,-u.x),f.addVectors(u,h).add(re),d.subVectors(h,u).add(re),ae?(f.toArray(o,1*3),d.toArray(o,0*3),d.toArray(o,3*3)):(f.toArray(o,1*3),l[3*2+1]===1?d.toArray(o,3*3):f.toArray(o,3*3),d.toArray(o,0*3));else{u.subVectors(he,re),h.set(u.y,-u.x),f.addVectors(u,h).add(re),d.subVectors(h,u).add(re);const oe=o.length;ae?(f.toArray(o,oe-1*3),d.toArray(o,oe-2*3),d.toArray(o,oe-4*3)):(d.toArray(o,oe-2*3),f.toArray(o,oe-1*3),d.toArray(o,oe-4*3))}break}}function ve(re){let se=!1;for(let ae=1,J=re.length-1;ae<J;ae++)if(re[ae].distanceTo(re[ae+1])<s){se=!0;break}if(!se)return re;const he=[];he.push(re[0]);for(let ae=1,J=re.length-1;ae<J;ae++)re[ae].distanceTo(re[ae+1])>=s&&he.push(re[ae]);return he.push(re[re.length-1]),he}}}return r})(),Zh=new WeakMap;class l5 extends Dr{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,n){const s=new vn(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{const a={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,a).then(t).catch(n)},i,n)}decodeDracoFile(e,t,i,n){const s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,s).then(t)}decodeGeometry(e,t){for(const l in t.attributeTypes){const c=t.attributeTypes[l];c.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[l]=c.name)}const i=JSON.stringify(t);if(Zh.has(e)){const l=Zh.get(e);if(l.key===i)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(s,o).then(l=>(n=l,new Promise((c,u)=>{n._callbacks[s]={resolve:c,reject:u},n.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return a.catch(()=>!0).then(()=>{n&&s&&this._releaseTask(n,s)}),Zh.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new ki;e.index&&t.setIndex(new Nt(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const n=e.attributes[i],s=n.name,o=n.array,a=n.itemSize;t.setAttribute(s,new Nt(o,a))}return t}_loadLibrary(e,t){const i=new vn(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((n,s)=>{i.load(e,n,void 0,s)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const n=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const s=c5.toString(),o=["/* draco decoder */",n,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(s){const o=s.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,s){return n._taskLoad>s._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function c5(){let r,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":r=a.decoderConfig,e=new Promise(function(u){r.onModuleLoaded=function(h){u({draco:h})},DracoDecoderModule(r)});break;case"decode":const l=a.buffer,c=a.taskConfig;e.then(u=>{const h=u.draco,f=new h.Decoder,d=new h.DecoderBuffer;d.Init(new Int8Array(l),l.byteLength);try{const m=t(h,f,d,c),A=m.attributes.map(p=>p.array.buffer);m.index&&A.push(m.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:m},A)}catch(m){console.error(m),self.postMessage({type:"error",id:a.id,error:m.message})}finally{h.destroy(d),h.destroy(f)}});break}};function t(o,a,l,c){const u=c.attributeIDs,h=c.attributeTypes;let f,d;const m=a.GetEncodedGeometryType(l);if(m===o.TRIANGULAR_MESH)f=new o.Mesh,d=a.DecodeBufferToMesh(l,f);else if(m===o.POINT_CLOUD)f=new o.PointCloud,d=a.DecodeBufferToPointCloud(l,f);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!d.ok()||f.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+d.error_msg());const A={index:null,attributes:[]};for(const p in u){const y=self[h[p]];let E,v;if(c.useUniqueIDs)v=u[p],E=a.GetAttributeByUniqueId(f,v);else{if(v=a.GetAttributeId(f,o[u[p]]),v===-1)continue;E=a.GetAttribute(f,v)}A.attributes.push(n(o,a,f,p,y,E))}return m===o.TRIANGULAR_MESH&&(A.index=i(o,a,f)),o.destroy(f),A}function i(o,a,l){const u=l.num_faces()*3,h=u*4,f=o._malloc(h);a.GetTrianglesUInt32Array(l,h,f);const d=new Uint32Array(o.HEAPF32.buffer,f,u).slice();return o._free(f),{array:d,itemSize:1}}function n(o,a,l,c,u,h){const f=h.num_components(),m=l.num_points()*f,A=m*u.BYTES_PER_ELEMENT,p=s(o,u),y=o._malloc(A);a.GetAttributeDataArrayForAllPoints(l,h,p,A,y);const E=new u(o.HEAPF32.buffer,y,m).slice();return o._free(y),{name:c,array:E,itemSize:f}}function s(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const Ep=new Yt,fc=new z;class Zu extends B0{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.setAttribute("position",new Vi(e,3)),this.setAttribute("uv",new Vi(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new Td(t,6,1);return this.setAttribute("instanceStart",new jr(i,3,0)),this.setAttribute("instanceEnd",new jr(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let i;e instanceof Float32Array?i=e:Array.isArray(e)&&(i=new Float32Array(e));const n=new Td(i,t*2,1);return this.setAttribute("instanceColorStart",new jr(n,t,0)),this.setAttribute("instanceColorEnd",new jr(n,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new eC(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Yt);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),Ep.setFromBufferAttribute(t),this.boundingBox.union(Ep))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new on),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let n=0;for(let s=0,o=e.count;s<o;s++)fc.fromBufferAttribute(e,s),n=Math.max(n,i.distanceToSquared(fc)),fc.fromBufferAttribute(t,s),n=Math.max(n,i.distanceToSquared(fc));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class xv extends Zu{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return super.setPositions(i),this}setColors(e,t=3){const i=e.length-t,n=new Float32Array(2*i);if(t===3)for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5];else for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5],n[2*s+6]=e[s+6],n[2*s+7]=e[s+7];return super.setColors(n,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class eh extends gi{constructor(e){super({type:"LineMaterial",uniforms:la.clone(la.merge([bd.common,bd.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new De(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${pa>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const ef=new Ci,xp=new z,Cp=new z,$i=new Ci,Yi=new Ci,vs=new Ci,tf=new z,nf=new we,Xi=new Ls,Ip=new z,dc=new Yt,mc=new on,Es=new Ci;let Rs,Zr;function _p(r,e,t){return Es.set(0,0,-e,1).applyMatrix4(r.projectionMatrix),Es.multiplyScalar(1/Es.w),Es.x=Zr/t.width,Es.y=Zr/t.height,Es.applyMatrix4(r.projectionMatrixInverse),Es.multiplyScalar(1/Es.w),Math.abs(Math.max(Es.x,Es.y))}function u5(r,e){const t=r.matrixWorld,i=r.geometry,n=i.attributes.instanceStart,s=i.attributes.instanceEnd,o=Math.min(i.instanceCount,n.count);for(let a=0,l=o;a<l;a++){Xi.start.fromBufferAttribute(n,a),Xi.end.fromBufferAttribute(s,a),Xi.applyMatrix4(t);const c=new z,u=new z;Rs.distanceSqToSegment(Xi.start,Xi.end,u,c),u.distanceTo(c)<Zr*.5&&e.push({point:u,pointOnLine:c,distance:Rs.origin.distanceTo(u),object:r,face:null,faceIndex:a,uv:null,[O0]:null})}}function h5(r,e,t){const i=e.projectionMatrix,s=r.material.resolution,o=r.matrixWorld,a=r.geometry,l=a.attributes.instanceStart,c=a.attributes.instanceEnd,u=Math.min(a.instanceCount,l.count),h=-e.near;Rs.at(1,vs),vs.w=1,vs.applyMatrix4(e.matrixWorldInverse),vs.applyMatrix4(i),vs.multiplyScalar(1/vs.w),vs.x*=s.x/2,vs.y*=s.y/2,vs.z=0,tf.copy(vs),nf.multiplyMatrices(e.matrixWorldInverse,o);for(let f=0,d=u;f<d;f++){if($i.fromBufferAttribute(l,f),Yi.fromBufferAttribute(c,f),$i.w=1,Yi.w=1,$i.applyMatrix4(nf),Yi.applyMatrix4(nf),$i.z>h&&Yi.z>h)continue;if($i.z>h){const v=$i.z-Yi.z,x=($i.z-h)/v;$i.lerp(Yi,x)}else if(Yi.z>h){const v=Yi.z-$i.z,x=(Yi.z-h)/v;Yi.lerp($i,x)}$i.applyMatrix4(i),Yi.applyMatrix4(i),$i.multiplyScalar(1/$i.w),Yi.multiplyScalar(1/Yi.w),$i.x*=s.x/2,$i.y*=s.y/2,Yi.x*=s.x/2,Yi.y*=s.y/2,Xi.start.copy($i),Xi.start.z=0,Xi.end.copy(Yi),Xi.end.z=0;const A=Xi.closestPointToPointParameter(tf,!0);Xi.at(A,Ip);const p=et.lerp($i.z,Yi.z,A),y=p>=-1&&p<=1,E=tf.distanceTo(Ip)<Zr*.5;if(y&&E){Xi.start.fromBufferAttribute(l,f),Xi.end.fromBufferAttribute(c,f),Xi.start.applyMatrix4(o),Xi.end.applyMatrix4(o);const v=new z,x=new z;Rs.distanceSqToSegment(Xi.start,Xi.end,x,v),t.push({point:x,pointOnLine:v,distance:Rs.origin.distanceTo(x),object:r,face:null,faceIndex:f,uv:null,[O0]:null})}}}class Cv extends Qe{constructor(e=new Zu,t=new eh({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,n=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)xp.fromBufferAttribute(t,o),Cp.fromBufferAttribute(i,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+xp.distanceTo(Cp);const s=new Td(n,2,1);return e.setAttribute("instanceDistanceStart",new jr(s,1,0)),e.setAttribute("instanceDistanceEnd",new jr(s,1,1)),this}raycast(e,t){const i=this.material.worldUnits,n=e.camera;n===null&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const s=e.params.Line2!==void 0&&e.params.Line2.threshold||0;Rs=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;Zr=l.linewidth+s,a.boundingSphere===null&&a.computeBoundingSphere(),mc.copy(a.boundingSphere).applyMatrix4(o);let c;if(i)c=Zr*.5;else{const h=Math.max(n.near,mc.distanceToPoint(Rs.origin));c=_p(n,h,l.resolution)}if(mc.radius+=c,Rs.intersectsSphere(mc)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),dc.copy(a.boundingBox).applyMatrix4(o);let u;if(i)u=Zr*.5;else{const h=Math.max(n.near,dc.distanceToPoint(Rs.origin));u=_p(n,h,l.resolution)}dc.expandByScalar(u),Rs.intersectsBox(dc)!==!1&&(i?u5(this,t):h5(this,n,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(ef),this.material.uniforms.resolution.value.set(ef.z,ef.w))}}class Iv extends Cv{constructor(e=new xv,t=new eh({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}let Ac;const sf=()=>{if(Ac)return Ac;const r="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",e="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if(typeof WebAssembly!="object")return{supported:!1};let n=r;WebAssembly.validate(t)&&(n=e);let s;const o=WebAssembly.instantiate(a(n),{}).then(h=>{s=h.instance,s.exports.__wasm_call_ctors()});function a(h){const f=new Uint8Array(h.length);for(let m=0;m<h.length;++m){const A=h.charCodeAt(m);f[m]=A>96?A-71:A>64?A-65:A>47?A+4:A>46?63:62}let d=0;for(let m=0;m<h.length;++m)f[d++]=f[m]<60?i[f[m]]:(f[m]-60)*64+f[++m];return f.buffer.slice(0,d)}function l(h,f,d,m,A,p){const y=s.exports.sbrk,E=d+3&-4,v=y(E*m),x=y(A.length),C=new Uint8Array(s.exports.memory.buffer);C.set(A,x);const I=h(v,d,m,x,A.length);if(I===0&&p&&p(v,E,m),f.set(C.subarray(v,v+d*m)),y(v-y(0)),I!==0)throw new Error(`Malformed buffer data: ${I}`)}const c={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return Ac={ready:o,supported:!0,decodeVertexBuffer(h,f,d,m,A){l(s.exports.meshopt_decodeVertexBuffer,h,f,d,m,s.exports[c[A]])},decodeIndexBuffer(h,f,d,m){l(s.exports.meshopt_decodeIndexBuffer,h,f,d,m)},decodeIndexSequence(h,f,d,m){l(s.exports.meshopt_decodeIndexSequence,h,f,d,m)},decodeGltfBuffer(h,f,d,m,A,p){l(s.exports[u[A]],h,f,d,m,s.exports[c[p]])}},Ac},Sp=r=>Symbol.iterator in r,Tp=r=>"entries"in r,bp=(r,e)=>{const t=r instanceof Map?r:new Map(r.entries()),i=e instanceof Map?e:new Map(e.entries());if(t.size!==i.size)return!1;for(const[n,s]of t)if(!i.has(n)||!Object.is(s,i.get(n)))return!1;return!0},f5=(r,e)=>{const t=r[Symbol.iterator](),i=e[Symbol.iterator]();let n=t.next(),s=i.next();for(;!n.done&&!s.done;){if(!Object.is(n.value,s.value))return!1;n=t.next(),s=i.next()}return!!n.done&&!!s.done};function d5(r,e){return Object.is(r,e)?!0:typeof r!="object"||r===null||typeof e!="object"||e===null||Object.getPrototypeOf(r)!==Object.getPrototypeOf(e)?!1:Sp(r)&&Sp(e)?Tp(r)&&Tp(e)?bp(r,e):f5(r,e):bp({entries:()=>Object.entries(r)},{entries:()=>Object.entries(e)})}const _v=g.createContext([]);function gL({box:r,multiple:e,children:t,onChange:i,onChangePointerUp:n,border:s="1px solid #55aaff",backgroundColor:o="rgba(75, 160, 255, 0.1)",filter:a=c=>c,...l}){const[c,u]=g.useState(!1),{setEvents:h,camera:f,raycaster:d,gl:m,controls:A,size:p,get:y}=le(),[E,v]=g.useState(!1),[x,C]=g.useReducer((b,{object:T,shift:R})=>T===void 0?[]:Array.isArray(T)?T:R?b.includes(T)?b.filter(w=>w!==T):[T,...b]:b[0]===T?[]:[T],[]);g.useEffect(()=>{c?i==null||i(x):n==null||n(x)},[x,c]);const I=g.useCallback(b=>{b.stopPropagation(),C({object:a([b.object])[0],shift:e&&b.shiftKey})},[]),_=g.useCallback(b=>!E&&C({}),[E]),S=g.useRef(null);return g.useEffect(()=>{if(!r||!e)return;const b=new uT(f,S.current),T=document.createElement("div");T.style.pointerEvents="none",T.style.border=s,T.style.backgroundColor=o,T.style.position="fixed";const R=new De,w=new De,B=new De,D=y().events.enabled,k=A==null?void 0:A.enabled;let Q=!1;function Y(O,F){const{offsetX:U,offsetY:N}=O,{width:Z,height:ie}=p;F.set(U/Z*2-1,-(N/ie)*2+1)}function W(O){var F;A&&(A.enabled=!1),h({enabled:!1}),u(Q=!0),(F=m.domElement.parentElement)==null||F.appendChild(T),T.style.left=`${O.clientX}px`,T.style.top=`${O.clientY}px`,T.style.width="0px",T.style.height="0px",R.x=O.clientX,R.y=O.clientY}function P(O){B.x=Math.max(R.x,O.clientX),B.y=Math.max(R.y,O.clientY),w.x=Math.min(R.x,O.clientX),w.y=Math.min(R.y,O.clientY),T.style.left=`${w.x}px`,T.style.top=`${w.y}px`,T.style.width=`${B.x-w.x}px`,T.style.height=`${B.y-w.y}px`}function K(){if(Q){var O;A&&(A.enabled=k),h({enabled:D}),u(Q=!1),(O=T.parentElement)==null||O.removeChild(T)}}function M(O){O.shiftKey&&(W(O),Y(O,b.startPoint))}let V=[];function $(O){if(Q){P(O),Y(O,b.endPoint);const F=b.select().sort(U=>U.uuid).filter(U=>U.isMesh);d5(F,V)||(V=F,C({object:a(F)}))}}function G(O){Q&&K()}return document.addEventListener("pointerdown",M,{passive:!0}),document.addEventListener("pointermove",$,{passive:!0,capture:!0}),document.addEventListener("pointerup",G,{passive:!0}),()=>{document.removeEventListener("pointerdown",M),document.removeEventListener("pointermove",$,!0),document.removeEventListener("pointerup",G)}},[p.width,p.height,d,f,A,m]),g.createElement("group",Ae({ref:S,onClick:I,onPointerOver:()=>v(!0),onPointerOut:()=>v(!1),onPointerMissed:_},l),g.createElement(_v.Provider,{value:x},t))}function yL(){return g.useContext(_v)}const m5=g.forwardRef(function({children:e,follow:t=!0,lockX:i=!1,lockY:n=!1,lockZ:s=!1,...o},a){const l=g.useRef(null),c=g.useRef(null),u=new nt;return He(({camera:h})=>{if(!t||!c.current)return;const f=l.current.rotation.clone();c.current.updateMatrix(),c.current.updateWorldMatrix(!1,!1),c.current.getWorldQuaternion(u),h.getWorldQuaternion(l.current.quaternion).premultiply(u.invert()),i&&(l.current.rotation.x=f.x),n&&(l.current.rotation.y=f.y),s&&(l.current.rotation.z=f.z)}),g.useImperativeHandle(a,()=>c.current,[]),g.createElement("group",Ae({ref:c},o),g.createElement("group",{ref:l},e))}),vL=g.forwardRef(({children:r,depth:e=-1,...t},i)=>{const n=g.useRef(null);return g.useImperativeHandle(i,()=>n.current,[]),He(({camera:s})=>{n.current.quaternion.copy(s.quaternion),n.current.position.copy(s.position)}),g.createElement("group",Ae({ref:n},t),g.createElement("group",{"position-z":-e},r))}),A5=new z,p5=new z,g5=new z,y5=(r,e,t)=>{const i=t.width/2,n=t.height/2;e.updateMatrixWorld(!1);const s=r.project(e);return s.x=s.x*i+i,s.y=-(s.y*n)+n,s},v5=(r,e,t,i=1)=>{const n=A5.set(r.x/t.width*2-1,-(r.y/t.height)*2+1,i);return n.unproject(e),n},z0=(r,e,t,i)=>{const n=y5(g5.copy(r),t,i);let s=0;for(let o=0;o<2;++o){const a=p5.copy(n).setComponent(o,n.getComponent(o)+e),l=v5(a,t,i,a.z);s=Math.max(s,r.distanceTo(l))}return s},E5=new z,EL=g.forwardRef(({scale:r=1,...e},t)=>{const i=g.useRef(null);return g.useImperativeHandle(t,()=>i.current,[]),He(n=>{const s=i.current;if(!s)return;const o=z0(s.getWorldPosition(E5),r,n.camera,n.size);s.scale.setScalar(o*r)}),g.createElement("object3D",Ae({ref:i},e))}),Fs=g.forwardRef(function({points:e,color:t=16777215,vertexColors:i,linewidth:n,lineWidth:s,segments:o,dashed:a,...l},c){var u,h;const f=le(y=>y.size),d=g.useMemo(()=>o?new Cv:new Iv,[o]),[m]=g.useState(()=>new eh),A=(i==null||(u=i[0])==null?void 0:u.length)===4?4:3,p=g.useMemo(()=>{const y=o?new Zu:new xv,E=e.map(v=>{const x=Array.isArray(v);return v instanceof z||v instanceof Ci?[v.x,v.y,v.z]:v instanceof De?[v.x,v.y,0]:x&&v.length===3?[v[0],v[1],v[2]]:x&&v.length===2?[v[0],v[1],0]:v});if(y.setPositions(E.flat()),i){t=16777215;const v=i.map(x=>x instanceof Ye?x.toArray():x);y.setColors(v.flat(),A)}return y},[e,o,i,A]);return g.useLayoutEffect(()=>{d.computeLineDistances()},[e,d]),g.useLayoutEffect(()=>{a?m.defines.USE_DASH="":delete m.defines.USE_DASH,m.needsUpdate=!0},[a,m]),g.useEffect(()=>()=>{p.dispose(),m.dispose()},[p]),g.createElement("primitive",Ae({object:d,ref:c},l),g.createElement("primitive",{object:p,attach:"geometry"}),g.createElement("primitive",Ae({object:m,attach:"material",color:t,vertexColors:!!i,resolution:[f.width,f.height],linewidth:(h=n??s)!==null&&h!==void 0?h:1,dashed:a,transparent:A===4},l)))}),x5=new z,xL=g.forwardRef(function({start:e=[0,0,0],end:t=[0,0,0],mid:i,segments:n=20,...s},o){const a=g.useRef(null);g.useImperativeHandle(o,()=>a.current);const[l]=g.useState(()=>new tC(void 0,void 0,void 0)),c=g.useCallback((h,f,d,m=20)=>(h instanceof z?l.v0.copy(h):l.v0.set(...h),f instanceof z?l.v2.copy(f):l.v2.set(...f),d instanceof z?l.v1.copy(d):Array.isArray(d)?l.v1.set(...d):l.v1.copy(l.v0.clone().add(l.v2.clone().sub(l.v0)).add(x5.set(0,l.v0.y-l.v2.y,0))),l.getPoints(m)),[]);g.useLayoutEffect(()=>{a.current.setPoints=(h,f,d)=>{const m=c(h,f,d);a.current.geometry&&a.current.geometry.setPositions(m.map(A=>A.toArray()).flat())}},[]);const u=g.useMemo(()=>c(e,t,i,n),[e,t,i,n]);return g.createElement(Fs,Ae({ref:a,points:u},s))}),CL=g.forwardRef(function({start:e,end:t,midA:i,midB:n,segments:s=20,...o},a){const l=g.useMemo(()=>{const c=e instanceof z?e:new z(...e),u=t instanceof z?t:new z(...t),h=i instanceof z?i:new z(...i),f=n instanceof z?n:new z(...n);return new iC(c,h,f,u).getPoints(s)},[e,t,i,n,s]);return g.createElement(Fs,Ae({ref:a,points:l},o))}),IL=g.forwardRef(function({points:e,closed:t=!1,curveType:i="centripetal",tension:n=.5,segments:s=20,vertexColors:o,...a},l){const c=g.useMemo(()=>{const f=e.map(d=>d instanceof z?d:new z(...d));return new e2(f,t,i,n)},[e,t,i,n]),u=g.useMemo(()=>c.getPoints(s),[c,s]),h=g.useMemo(()=>{if(!o||o.length<2)return;if(o.length===s+1)return o;const f=o.map(A=>A instanceof Ye?A:new Ye(...A));t&&f.push(f[0].clone());const d=[f[0]],m=s/(f.length-1);for(let A=1;A<s;A++){const p=A%m/m,y=Math.floor(A/m);d.push(f[y].clone().lerp(f[y+1],p))}return d.push(f[f.length-1]),d},[o,s]);return g.createElement(Fs,Ae({ref:l,points:u,vertexColors:h},a))}),_L=g.forwardRef(({url:r,distance:e=1,loop:t=!0,autoplay:i,...n},s)=>{const o=g.useRef(null);g.useImperativeHandle(s,()=>o.current,[]);const a=le(({camera:u})=>u),[l]=g.useState(()=>new nC),c=oi(sC,r);return g.useEffect(()=>{const u=o.current;u&&(u.setBuffer(c),u.setRefDistance(e),u.setLoop(t),i&&!u.isPlaying&&u.play())},[c,a,e,t]),g.useEffect(()=>{const u=o.current;return a.add(l),()=>{a.remove(l),u&&(u.isPlaying&&u.stop(),u.source&&u.source._connected&&u.disconnect())}},[]),g.createElement("positionalAudio",Ae({ref:o,args:[l]},n))});function C5(){var r=Object.create(null);function e(n,s){var o=n.id,a=n.name,l=n.dependencies;l===void 0&&(l=[]);var c=n.init;c===void 0&&(c=function(){});var u=n.getTransferables;if(u===void 0&&(u=null),!r[o])try{l=l.map(function(f){return f&&f.isWorkerModule&&(e(f,function(d){if(d instanceof Error)throw d}),f=r[f.id].value),f}),c=i("<"+a+">.init",c),u&&(u=i("<"+a+">.getTransferables",u));var h=null;typeof c=="function"?h=c.apply(void 0,l):console.error("worker module init function failed to rehydrate"),r[o]={id:o,value:h,getTransferables:u},s(h)}catch(f){f&&f.noLog||console.error(f),s(f)}}function t(n,s){var o,a=n.id,l=n.args;(!r[a]||typeof r[a].value!="function")&&s(new Error("Worker module "+a+": not found or its 'init' did not return a function"));try{var c=(o=r[a]).value.apply(o,l);c&&typeof c.then=="function"?c.then(u,function(h){return s(h instanceof Error?h:new Error(""+h))}):u(c)}catch(h){s(h)}function u(h){try{var f=r[a].getTransferables&&r[a].getTransferables(h);(!f||!Array.isArray(f)||!f.length)&&(f=void 0),s(h,f)}catch(d){console.error(d),s(d)}}}function i(n,s){var o=void 0;self.troikaDefine=function(l){return o=l};var a=URL.createObjectURL(new Blob(["/** "+n.replace(/\*/g,"")+` **/

troikaDefine(
`+s+`
)`],{type:"application/javascript"}));try{importScripts(a)}catch(l){console.error(l)}return URL.revokeObjectURL(a),delete self.troikaDefine,o}self.addEventListener("message",function(n){var s=n.data,o=s.messageId,a=s.action,l=s.data;try{a==="registerModule"&&e(l,function(c){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:{isCallable:typeof c=="function"}})}),a==="callModule"&&t(l,function(c,u){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:c},u||void 0)})}catch(c){postMessage({messageId:o,success:!1,error:c.stack})}})}function I5(r){var e=function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];return e._getInitResult().then(function(n){if(typeof n=="function")return n.apply(void 0,t);throw new Error("Worker module function was called but `init` did not return a callable function")})};return e._getInitResult=function(){var t=r.dependencies,i=r.init;t=Array.isArray(t)?t.map(function(s){return s&&(s=s.onMainThread||s,s._getInitResult&&(s=s._getInitResult())),s}):[];var n=Promise.all(t).then(function(s){return i.apply(null,s)});return e._getInitResult=function(){return n},n},e}var Sv=function(){var r=!1;if(typeof window<"u"&&typeof window.document<"u")try{var e=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));e.terminate(),r=!0}catch(t){typeof process<"u",console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+t.message+"]")}return Sv=function(){return r},r},_5=0,S5=0,rf=!1,vl=Object.create(null),El=Object.create(null),Hd=Object.create(null);function ga(r){if((!r||typeof r.init!="function")&&!rf)throw new Error("requires `options.init` function");var e=r.dependencies,t=r.init,i=r.getTransferables,n=r.workerId,s=I5(r);n==null&&(n="#default");var o="workerModule"+ ++_5,a=r.name||o,l=null;e=e&&e.map(function(u){return typeof u=="function"&&!u.workerModuleData&&(rf=!0,u=ga({workerId:n,name:"<"+a+"> function dependency: "+u.name,init:`function(){return (
`+du(u)+`
)}`}),rf=!1),u&&u.workerModuleData&&(u=u.workerModuleData),u});function c(){for(var u=[],h=arguments.length;h--;)u[h]=arguments[h];if(!Sv())return s.apply(void 0,u);if(!l){l=wp(n,"registerModule",c.workerModuleData);var f=function(){l=null,El[n].delete(f)};(El[n]||(El[n]=new Set)).add(f)}return l.then(function(d){var m=d.isCallable;if(m)return wp(n,"callModule",{id:o,args:u});throw new Error("Worker module function was called but `init` did not return a callable function")})}return c.workerModuleData={isWorkerModule:!0,id:o,name:a,dependencies:e,init:du(t),getTransferables:i&&du(i)},c.onMainThread=s,c}function T5(r){El[r]&&El[r].forEach(function(e){e()}),vl[r]&&(vl[r].terminate(),delete vl[r])}function du(r){var e=r.toString();return!/^function/.test(e)&&/^\w+\s*\(/.test(e)&&(e="function "+e),e}function b5(r){var e=vl[r];if(!e){var t=du(C5);e=vl[r]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+r.replace(/\*/g,"")+` **/

;(`+t+")()"],{type:"application/javascript"}))),e.onmessage=function(i){var n=i.data,s=n.messageId,o=Hd[s];if(!o)throw new Error("WorkerModule response with empty or unknown messageId");delete Hd[s],o(n)}}return e}function wp(r,e,t){return new Promise(function(i,n){var s=++S5;Hd[s]=function(o){o.success?i(o.result):n(new Error("Error in worker "+e+" call: "+o.error))},b5(r).postMessage({messageId:s,action:e,data:t})})}function Tv(){var r=function(e){function t(P,K,M,V,$,G,O,F){var U=1-O;F.x=U*U*P+2*U*O*M+O*O*$,F.y=U*U*K+2*U*O*V+O*O*G}function i(P,K,M,V,$,G,O,F,U,N){var Z=1-U;N.x=Z*Z*Z*P+3*Z*Z*U*M+3*Z*U*U*$+U*U*U*O,N.y=Z*Z*Z*K+3*Z*Z*U*V+3*Z*U*U*G+U*U*U*F}function n(P,K){for(var M=/([MLQCZ])([^MLQCZ]*)/g,V,$,G,O,F;V=M.exec(P);){var U=V[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map(function(N){return parseFloat(N)});switch(V[1]){case"M":O=$=U[0],F=G=U[1];break;case"L":(U[0]!==O||U[1]!==F)&&K("L",O,F,O=U[0],F=U[1]);break;case"Q":{K("Q",O,F,O=U[2],F=U[3],U[0],U[1]);break}case"C":{K("C",O,F,O=U[4],F=U[5],U[0],U[1],U[2],U[3]);break}case"Z":(O!==$||F!==G)&&K("L",O,F,$,G);break}}}function s(P,K,M){M===void 0&&(M=16);var V={x:0,y:0};n(P,function($,G,O,F,U,N,Z,ie,q){switch($){case"L":K(G,O,F,U);break;case"Q":{for(var ne=G,ye=O,ve=1;ve<M;ve++)t(G,O,N,Z,F,U,ve/(M-1),V),K(ne,ye,V.x,V.y),ne=V.x,ye=V.y;break}case"C":{for(var re=G,se=O,he=1;he<M;he++)i(G,O,N,Z,ie,q,F,U,he/(M-1),V),K(re,se,V.x,V.y),re=V.x,se=V.y;break}}})}var o="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",a="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",l=new WeakMap,c={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function u(P,K){var M=P.getContext?P.getContext("webgl",c):P,V=l.get(M);if(!V){let Z=function(re){var se=G[re];if(!se&&(se=G[re]=M.getExtension(re),!se))throw new Error(re+" not supported");return se},ie=function(re,se){var he=M.createShader(se);return M.shaderSource(he,re),M.compileShader(he),he},q=function(re,se,he,ae){if(!O[re]){var J={},X={},oe=M.createProgram();M.attachShader(oe,ie(se,M.VERTEX_SHADER)),M.attachShader(oe,ie(he,M.FRAGMENT_SHADER)),M.linkProgram(oe),O[re]={program:oe,transaction:function(_e){M.useProgram(oe),_e({setUniform:function(Se,Ve){for(var Me=[],Ne=arguments.length-2;Ne-- >0;)Me[Ne]=arguments[Ne+2];var Ge=X[Ve]||(X[Ve]=M.getUniformLocation(oe,Ve));M["uniform"+Se].apply(M,[Ge].concat(Me))},setAttribute:function(Se,Ve,Me,Ne,Ge){var je=J[Se];je||(je=J[Se]={buf:M.createBuffer(),loc:M.getAttribLocation(oe,Se),data:null}),M.bindBuffer(M.ARRAY_BUFFER,je.buf),M.vertexAttribPointer(je.loc,Ve,M.FLOAT,!1,0,0),M.enableVertexAttribArray(je.loc),$?M.vertexAttribDivisor(je.loc,Ne):Z("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(je.loc,Ne),Ge!==je.data&&(M.bufferData(M.ARRAY_BUFFER,Ge,Me),je.data=Ge)}})}}}O[re].transaction(ae)},ne=function(re,se){U++;try{M.activeTexture(M.TEXTURE0+U);var he=F[re];he||(he=F[re]=M.createTexture(),M.bindTexture(M.TEXTURE_2D,he),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.NEAREST)),M.bindTexture(M.TEXTURE_2D,he),se(he,U)}finally{U--}},ye=function(re,se,he){var ae=M.createFramebuffer();N.push(ae),M.bindFramebuffer(M.FRAMEBUFFER,ae),M.activeTexture(M.TEXTURE0+se),M.bindTexture(M.TEXTURE_2D,re),M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,re,0);try{he(ae)}finally{M.deleteFramebuffer(ae),M.bindFramebuffer(M.FRAMEBUFFER,N[--N.length-1]||null)}},ve=function(){G={},O={},F={},U=-1,N.length=0};var $=typeof WebGL2RenderingContext<"u"&&M instanceof WebGL2RenderingContext,G={},O={},F={},U=-1,N=[];M.canvas.addEventListener("webglcontextlost",function(re){ve(),re.preventDefault()},!1),l.set(M,V={gl:M,isWebGL2:$,getExtension:Z,withProgram:q,withTexture:ne,withTextureFramebuffer:ye,handleContextLoss:ve})}K(V)}function h(P,K,M,V,$,G,O,F){O===void 0&&(O=15),F===void 0&&(F=null),u(P,function(U){var N=U.gl,Z=U.withProgram,ie=U.withTexture;ie("copy",function(q,ne){N.texImage2D(N.TEXTURE_2D,0,N.RGBA,$,G,0,N.RGBA,N.UNSIGNED_BYTE,K),Z("copy",o,a,function(ye){var ve=ye.setUniform,re=ye.setAttribute;re("aUV",2,N.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),ve("1i","image",ne),N.bindFramebuffer(N.FRAMEBUFFER,F||null),N.disable(N.BLEND),N.colorMask(O&8,O&4,O&2,O&1),N.viewport(M,V,$,G),N.scissor(M,V,$,G),N.drawArrays(N.TRIANGLES,0,3)})})})}function f(P,K,M){var V=P.width,$=P.height;u(P,function(G){var O=G.gl,F=new Uint8Array(V*$*4);O.readPixels(0,0,V,$,O.RGBA,O.UNSIGNED_BYTE,F),P.width=K,P.height=M,h(O,F,0,0,V,$)})}var d=Object.freeze({__proto__:null,withWebGLContext:u,renderImageData:h,resizeWebGLCanvasWithoutClearing:f});function m(P,K,M,V,$,G){G===void 0&&(G=1);var O=new Uint8Array(P*K),F=V[2]-V[0],U=V[3]-V[1],N=[];s(M,function(re,se,he,ae){N.push({x1:re,y1:se,x2:he,y2:ae,minX:Math.min(re,he),minY:Math.min(se,ae),maxX:Math.max(re,he),maxY:Math.max(se,ae)})}),N.sort(function(re,se){return re.maxX-se.maxX});for(var Z=0;Z<P;Z++)for(var ie=0;ie<K;ie++){var q=ye(V[0]+F*(Z+.5)/P,V[1]+U*(ie+.5)/K),ne=Math.pow(1-Math.abs(q)/$,G)/2;q<0&&(ne=1-ne),ne=Math.max(0,Math.min(255,Math.round(ne*255))),O[ie*P+Z]=ne}return O;function ye(re,se){for(var he=1/0,ae=1/0,J=N.length;J--;){var X=N[J];if(X.maxX+ae<=re)break;if(re+ae>X.minX&&se-ae<X.maxY&&se+ae>X.minY){var oe=y(re,se,X.x1,X.y1,X.x2,X.y2);oe<he&&(he=oe,ae=Math.sqrt(he))}}return ve(re,se)&&(ae=-ae),ae}function ve(re,se){for(var he=0,ae=N.length;ae--;){var J=N[ae];if(J.maxX<=re)break;var X=J.y1>se!=J.y2>se&&re<(J.x2-J.x1)*(se-J.y1)/(J.y2-J.y1)+J.x1;X&&(he+=J.y1<J.y2?1:-1)}return he!==0}}function A(P,K,M,V,$,G,O,F,U,N){G===void 0&&(G=1),F===void 0&&(F=0),U===void 0&&(U=0),N===void 0&&(N=0),p(P,K,M,V,$,G,O,null,F,U,N)}function p(P,K,M,V,$,G,O,F,U,N,Z){G===void 0&&(G=1),U===void 0&&(U=0),N===void 0&&(N=0),Z===void 0&&(Z=0);for(var ie=m(P,K,M,V,$,G),q=new Uint8Array(ie.length*4),ne=0;ne<ie.length;ne++)q[ne*4+Z]=ie[ne];h(O,q,U,N,P,K,1<<3-Z,F)}function y(P,K,M,V,$,G){var O=$-M,F=G-V,U=O*O+F*F,N=U?Math.max(0,Math.min(1,((P-M)*O+(K-V)*F)/U)):0,Z=P-(M+N*O),ie=K-(V+N*F);return Z*Z+ie*ie}var E=Object.freeze({__proto__:null,generate:m,generateIntoCanvas:A,generateIntoFramebuffer:p}),v="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",x="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",C="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",I=new Float32Array([0,0,2,0,0,2]),_=null,S=!1,b={},T=new WeakMap;function R(P){if(!S&&!k(P))throw new Error("WebGL generation not supported")}function w(P,K,M,V,$,G,O){if(G===void 0&&(G=1),O===void 0&&(O=null),!O&&(O=_,!O)){var F=typeof OffscreenCanvas=="function"?new OffscreenCanvas(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!F)throw new Error("OffscreenCanvas or DOM canvas not supported");O=_=F.getContext("webgl",{depth:!1})}R(O);var U=new Uint8Array(P*K*4);u(O,function(q){var ne=q.gl,ye=q.withTexture,ve=q.withTextureFramebuffer;ye("readable",function(re,se){ne.texImage2D(ne.TEXTURE_2D,0,ne.RGBA,P,K,0,ne.RGBA,ne.UNSIGNED_BYTE,null),ve(re,se,function(he){D(P,K,M,V,$,G,ne,he,0,0,0),ne.readPixels(0,0,P,K,ne.RGBA,ne.UNSIGNED_BYTE,U)})})});for(var N=new Uint8Array(P*K),Z=0,ie=0;Z<U.length;Z+=4)N[ie++]=U[Z];return N}function B(P,K,M,V,$,G,O,F,U,N){G===void 0&&(G=1),F===void 0&&(F=0),U===void 0&&(U=0),N===void 0&&(N=0),D(P,K,M,V,$,G,O,null,F,U,N)}function D(P,K,M,V,$,G,O,F,U,N,Z){G===void 0&&(G=1),U===void 0&&(U=0),N===void 0&&(N=0),Z===void 0&&(Z=0),R(O);var ie=[];s(M,function(q,ne,ye,ve){ie.push(q,ne,ye,ve)}),ie=new Float32Array(ie),u(O,function(q){var ne=q.gl,ye=q.isWebGL2,ve=q.getExtension,re=q.withProgram,se=q.withTexture,he=q.withTextureFramebuffer,ae=q.handleContextLoss;if(se("rawDistances",function(J,X){(P!==J._lastWidth||K!==J._lastHeight)&&ne.texImage2D(ne.TEXTURE_2D,0,ne.RGBA,J._lastWidth=P,J._lastHeight=K,0,ne.RGBA,ne.UNSIGNED_BYTE,null),re("main",v,x,function(oe){var Ce=oe.setAttribute,_e=oe.setUniform,Be=!ye&&ve("ANGLE_instanced_arrays"),Se=!ye&&ve("EXT_blend_minmax");Ce("aUV",2,ne.STATIC_DRAW,0,I),Ce("aLineSegment",4,ne.DYNAMIC_DRAW,1,ie),_e.apply(void 0,["4f","uGlyphBounds"].concat(V)),_e("1f","uMaxDistance",$),_e("1f","uExponent",G),he(J,X,function(Ve){ne.enable(ne.BLEND),ne.colorMask(!0,!0,!0,!0),ne.viewport(0,0,P,K),ne.scissor(0,0,P,K),ne.blendFunc(ne.ONE,ne.ONE),ne.blendEquationSeparate(ne.FUNC_ADD,ye?ne.MAX:Se.MAX_EXT),ne.clear(ne.COLOR_BUFFER_BIT),ye?ne.drawArraysInstanced(ne.TRIANGLES,0,3,ie.length/4):Be.drawArraysInstancedANGLE(ne.TRIANGLES,0,3,ie.length/4)})}),re("post",o,C,function(oe){oe.setAttribute("aUV",2,ne.STATIC_DRAW,0,I),oe.setUniform("1i","tex",X),ne.bindFramebuffer(ne.FRAMEBUFFER,F),ne.disable(ne.BLEND),ne.colorMask(Z===0,Z===1,Z===2,Z===3),ne.viewport(U,N,P,K),ne.scissor(U,N,P,K),ne.drawArrays(ne.TRIANGLES,0,3)})}),ne.isContextLost())throw ae(),new Error("webgl context lost")})}function k(P){var K=!P||P===_?b:P.canvas||P,M=T.get(K);if(M===void 0){S=!0;var V=null;try{var $=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],G=w(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,P);M=G&&$.length===G.length&&G.every(function(O,F){return O===$[F]}),M||(V="bad trial run results",console.info($,G))}catch(O){M=!1,V=O.message}V&&console.warn("WebGL SDF generation not supported:",V),S=!1,T.set(K,M)}return M}var Q=Object.freeze({__proto__:null,generate:w,generateIntoCanvas:B,generateIntoFramebuffer:D,isSupported:k});function Y(P,K,M,V,$,G){$===void 0&&($=Math.max(V[2]-V[0],V[3]-V[1])/2),G===void 0&&(G=1);try{return w.apply(Q,arguments)}catch(O){return console.info("WebGL SDF generation failed, falling back to JS",O),m.apply(E,arguments)}}function W(P,K,M,V,$,G,O,F,U,N){$===void 0&&($=Math.max(V[2]-V[0],V[3]-V[1])/2),G===void 0&&(G=1),F===void 0&&(F=0),U===void 0&&(U=0),N===void 0&&(N=0);try{return B.apply(Q,arguments)}catch(Z){return console.info("WebGL SDF generation failed, falling back to JS",Z),A.apply(E,arguments)}}return e.forEachPathCommand=n,e.generate=Y,e.generateIntoCanvas=W,e.javascript=E,e.pathToLineSegments=s,e.webgl=Q,e.webglUtils=d,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return r}function w5(){var r=function(e){var t={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},i={},n={};i.L=1,n[1]="L",Object.keys(t).forEach(function(ae,J){i[ae]=1<<J+1,n[i[ae]]=ae}),Object.freeze(i);var s=i.LRI|i.RLI|i.FSI,o=i.L|i.R|i.AL,a=i.B|i.S|i.WS|i.ON|i.FSI|i.LRI|i.RLI|i.PDI,l=i.BN|i.RLE|i.LRE|i.RLO|i.LRO|i.PDF,c=i.S|i.WS|i.B|s|i.PDI|l,u=null;function h(){if(!u){u=new Map;var ae=function(X){if(t.hasOwnProperty(X)){var oe=0;t[X].split(",").forEach(function(Ce){var _e=Ce.split("+"),Be=_e[0],Se=_e[1];Be=parseInt(Be,36),Se=Se?parseInt(Se,36):0,u.set(oe+=Be,i[X]);for(var Ve=0;Ve<Se;Ve++)u.set(++oe,i[X])})}};for(var J in t)ae(J)}}function f(ae){return h(),u.get(ae.codePointAt(0))||i.L}function d(ae){return n[f(ae)]}var m={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function A(ae,J){var X=36,oe=0,Ce=new Map,_e=J&&new Map,Be;return ae.split(",").forEach(function Se(Ve){if(Ve.indexOf("+")!==-1)for(var Me=+Ve;Me--;)Se(Be);else{Be=Ve;var Ne=Ve.split(">"),Ge=Ne[0],je=Ne[1];Ge=String.fromCodePoint(oe+=parseInt(Ge,X)),je=String.fromCodePoint(oe+=parseInt(je,X)),Ce.set(Ge,je),J&&_e.set(je,Ge)}}),{map:Ce,reverseMap:_e}}var p,y,E;function v(){if(!p){var ae=A(m.pairs,!0),J=ae.map,X=ae.reverseMap;p=J,y=X,E=A(m.canonical,!1).map}}function x(ae){return v(),p.get(ae)||null}function C(ae){return v(),y.get(ae)||null}function I(ae){return v(),E.get(ae)||null}var _=i.L,S=i.R,b=i.EN,T=i.ES,R=i.ET,w=i.AN,B=i.CS,D=i.B,k=i.S,Q=i.ON,Y=i.BN,W=i.NSM,P=i.AL,K=i.LRO,M=i.RLO,V=i.LRE,$=i.RLE,G=i.PDF,O=i.LRI,F=i.RLI,U=i.FSI,N=i.PDI;function Z(ae,J){for(var X=125,oe=new Uint32Array(ae.length),Ce=0;Ce<ae.length;Ce++)oe[Ce]=f(ae[Ce]);var _e=new Map;function Be(un,ns){var hn=oe[un];oe[un]=ns,_e.set(hn,_e.get(hn)-1),hn&a&&_e.set(a,_e.get(a)-1),_e.set(ns,(_e.get(ns)||0)+1),ns&a&&_e.set(a,(_e.get(a)||0)+1)}for(var Se=new Uint8Array(ae.length),Ve=new Map,Me=[],Ne=null,Ge=0;Ge<ae.length;Ge++)Ne||Me.push(Ne={start:Ge,end:ae.length-1,level:J==="rtl"?1:J==="ltr"?0:Ym(Ge,!1)}),oe[Ge]&D&&(Ne.end=Ge,Ne=null);for(var je=$|V|M|K|s|N|G|D,st=function(un){return un+(un&1?1:2)},At=function(un){return un+(un&1?2:1)},it=0;it<Me.length;it++){Ne=Me[it];var Xe=[{_level:Ne.level,_override:0,_isolate:0}],We=void 0,te=0,Te=0,Le=0;_e.clear();for(var Ke=Ne.start;Ke<=Ne.end;Ke++){var pe=oe[Ke];if(We=Xe[Xe.length-1],_e.set(pe,(_e.get(pe)||0)+1),pe&a&&_e.set(a,(_e.get(a)||0)+1),pe&je)if(pe&($|V)){Se[Ke]=We._level;var ot=(pe===$?At:st)(We._level);ot<=X&&!te&&!Te?Xe.push({_level:ot,_override:0,_isolate:0}):te||Te++}else if(pe&(M|K)){Se[Ke]=We._level;var qt=(pe===M?At:st)(We._level);qt<=X&&!te&&!Te?Xe.push({_level:qt,_override:pe&M?S:_,_isolate:0}):te||Te++}else if(pe&s){pe&U&&(pe=Ym(Ke+1,!0)===1?F:O),Se[Ke]=We._level,We._override&&Be(Ke,We._override);var Bt=(pe===F?At:st)(We._level);Bt<=X&&te===0&&Te===0?(Le++,Xe.push({_level:Bt,_override:0,_isolate:1,_isolInitIndex:Ke})):te++}else if(pe&N){if(te>0)te--;else if(Le>0){for(Te=0;!Xe[Xe.length-1]._isolate;)Xe.pop();var pt=Xe[Xe.length-1]._isolInitIndex;pt!=null&&(Ve.set(pt,Ke),Ve.set(Ke,pt)),Xe.pop(),Le--}We=Xe[Xe.length-1],Se[Ke]=We._level,We._override&&Be(Ke,We._override)}else pe&G?(te===0&&(Te>0?Te--:!We._isolate&&Xe.length>1&&(Xe.pop(),We=Xe[Xe.length-1])),Se[Ke]=We._level):pe&D&&(Se[Ke]=Ne.level);else Se[Ke]=We._level,We._override&&pe!==Y&&Be(Ke,We._override)}for(var Tt=[],_t=null,at=Ne.start;at<=Ne.end;at++){var bt=oe[at];if(!(bt&l)){var ai=Se[at],li=bt&s,yi=bt===N;_t&&ai===_t._level?(_t._end=at,_t._endsWithIsolInit=li):Tt.push(_t={_start:at,_end:at,_level:ai,_startsWithPDI:yi,_endsWithIsolInit:li})}}for(var En=[],xn=0;xn<Tt.length;xn++){var es=Tt[xn];if(!es._startsWithPDI||es._startsWithPDI&&!Ve.has(es._start)){for(var ln=[_t=es],Cn=void 0;_t&&_t._endsWithIsolInit&&(Cn=Ve.get(_t._end))!=null;)for(var ht=xn+1;ht<Tt.length;ht++)if(Tt[ht]._start===Cn){ln.push(_t=Tt[ht]);break}for(var Ni=[],Us=0;Us<ln.length;Us++)for(var H=ln[Us],j=H._start;j<=H._end;j++)Ni.push(j);for(var ee=Se[Ni[0]],me=Ne.level,Ee=Ni[0]-1;Ee>=0;Ee--)if(!(oe[Ee]&l)){me=Se[Ee];break}var xe=Ni[Ni.length-1],Pe=Se[xe],Re=Ne.level;if(!(oe[xe]&s)){for(var Fe=xe+1;Fe<=Ne.end;Fe++)if(!(oe[Fe]&l)){Re=Se[Fe];break}}En.push({_seqIndices:Ni,_sosType:Math.max(me,ee)%2?S:_,_eosType:Math.max(Re,Pe)%2?S:_})}}for(var ke=0;ke<En.length;ke++){var Oe=En[ke],ge=Oe._seqIndices,kt=Oe._sosType,Ze=Oe._eosType,Je=Se[ge[0]]&1?S:_;if(_e.get(W))for(var lt=0;lt<ge.length;lt++){var gt=ge[lt];if(oe[gt]&W){for(var Rt=kt,Dt=lt-1;Dt>=0;Dt--)if(!(oe[ge[Dt]]&l)){Rt=oe[ge[Dt]];break}Be(gt,Rt&(s|N)?Q:Rt)}}if(_e.get(b))for(var si=0;si<ge.length;si++){var Gi=ge[si];if(oe[Gi]&b)for(var Mt=si-1;Mt>=-1;Mt--){var In=Mt===-1?kt:oe[ge[Mt]];if(In&o){In===P&&Be(Gi,w);break}}}if(_e.get(P))for(var Ot=0;Ot<ge.length;Ot++){var vi=ge[Ot];oe[vi]&P&&Be(vi,S)}if(_e.get(T)||_e.get(B))for(var en=1;en<ge.length-1;en++){var Ns=ge[en];if(oe[Ns]&(T|B)){for(var Ri=0,Lt=0,_i=en-1;_i>=0&&(Ri=oe[ge[_i]],!!(Ri&l));_i--);for(var Qt=en+1;Qt<ge.length&&(Lt=oe[ge[Qt]],!!(Lt&l));Qt++);Ri===Lt&&(oe[Ns]===T?Ri===b:Ri&(b|w))&&Be(Ns,Ri)}}if(_e.get(b))for(var vt=0;vt<ge.length;vt++){var cn=ge[vt];if(oe[cn]&b){for(var Fn=vt-1;Fn>=0&&oe[ge[Fn]]&(R|l);Fn--)Be(ge[Fn],b);for(vt++;vt<ge.length&&oe[ge[vt]]&(R|l|b);vt++)oe[ge[vt]]!==b&&Be(ge[vt],b)}}if(_e.get(R)||_e.get(T)||_e.get(B))for(var Di=0;Di<ge.length;Di++){var ts=ge[Di];if(oe[ts]&(R|T|B)){Be(ts,Q);for(var $l=Di-1;$l>=0&&oe[ge[$l]]&l;$l--)Be(ge[$l],Q);for(var Yl=Di+1;Yl<ge.length&&oe[ge[Yl]]&l;Yl++)Be(ge[Yl],Q)}}if(_e.get(b))for(var ph=0,Fm=kt;ph<ge.length;ph++){var km=ge[ph],gh=oe[km];gh&b?Fm===_&&Be(km,_):gh&o&&(Fm=gh)}if(_e.get(a)){var va=S|b|w,Om=va|_,Wl=[];{for(var lo=[],co=0;co<ge.length;co++)if(oe[ge[co]]&a){var Ea=ae[ge[co]],Um=void 0;if(x(Ea)!==null)if(lo.length<63)lo.push({char:Ea,seqIndex:co});else break;else if((Um=C(Ea))!==null)for(var xa=lo.length-1;xa>=0;xa--){var yh=lo[xa].char;if(yh===Um||yh===C(I(Ea))||x(I(yh))===Ea){Wl.push([lo[xa].seqIndex,co]),lo.length=xa;break}}}Wl.sort(function(un,ns){return un[0]-ns[0]})}for(var vh=0;vh<Wl.length;vh++){for(var Nm=Wl[vh],jl=Nm[0],Eh=Nm[1],Gm=!1,is=0,xh=jl+1;xh<Eh;xh++){var Qm=ge[xh];if(oe[Qm]&Om){Gm=!0;var zm=oe[Qm]&va?S:_;if(zm===Je){is=zm;break}}}if(Gm&&!is){is=kt;for(var Ch=jl-1;Ch>=0;Ch--){var Hm=ge[Ch];if(oe[Hm]&Om){var Vm=oe[Hm]&va?S:_;Vm!==Je?is=Vm:is=Je;break}}}if(is){if(oe[ge[jl]]=oe[ge[Eh]]=is,is!==Je){for(var Ca=jl+1;Ca<ge.length;Ca++)if(!(oe[ge[Ca]]&l)){f(ae[ge[Ca]])&W&&(oe[ge[Ca]]=is);break}}if(is!==Je){for(var Ia=Eh+1;Ia<ge.length;Ia++)if(!(oe[ge[Ia]]&l)){f(ae[ge[Ia]])&W&&(oe[ge[Ia]]=is);break}}}}for(var lr=0;lr<ge.length;lr++)if(oe[ge[lr]]&a){for(var Km=lr,Ih=lr,_h=kt,_a=lr-1;_a>=0;_a--)if(oe[ge[_a]]&l)Km=_a;else{_h=oe[ge[_a]]&va?S:_;break}for(var $m=Ze,Sa=lr+1;Sa<ge.length;Sa++)if(oe[ge[Sa]]&(a|l))Ih=Sa;else{$m=oe[ge[Sa]]&va?S:_;break}for(var Sh=Km;Sh<=Ih;Sh++)oe[ge[Sh]]=_h===$m?_h:Je;lr=Ih}}}for(var _n=Ne.start;_n<=Ne.end;_n++){var yx=Se[_n],Xl=oe[_n];if(yx&1?Xl&(_|b|w)&&Se[_n]++:Xl&S?Se[_n]++:Xl&(w|b)&&(Se[_n]+=2),Xl&l&&(Se[_n]=_n===0?Ne.level:Se[_n-1]),_n===Ne.end||f(ae[_n])&(k|D))for(var ql=_n;ql>=0&&f(ae[ql])&c;ql--)Se[ql]=Ne.level}}return{levels:Se,paragraphs:Me};function Ym(un,ns){for(var hn=un;hn<ae.length;hn++){var cr=oe[hn];if(cr&(S|P))return 1;if(cr&(D|_)||ns&&cr===N)return 0;if(cr&s){var Wm=vx(hn);hn=Wm===-1?ae.length:Wm}}return 0}function vx(un){for(var ns=1,hn=un+1;hn<ae.length;hn++){var cr=oe[hn];if(cr&D)break;if(cr&N){if(--ns===0)return hn}else cr&s&&ns++}return-1}}var ie="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",q;function ne(){if(!q){var ae=A(ie,!0),J=ae.map,X=ae.reverseMap;X.forEach(function(oe,Ce){J.set(Ce,oe)}),q=J}}function ye(ae){return ne(),q.get(ae)||null}function ve(ae,J,X,oe){var Ce=ae.length;X=Math.max(0,X==null?0:+X),oe=Math.min(Ce-1,oe==null?Ce-1:+oe);for(var _e=new Map,Be=X;Be<=oe;Be++)if(J[Be]&1){var Se=ye(ae[Be]);Se!==null&&_e.set(Be,Se)}return _e}function re(ae,J,X,oe){var Ce=ae.length;X=Math.max(0,X==null?0:+X),oe=Math.min(Ce-1,oe==null?Ce-1:+oe);var _e=[];return J.paragraphs.forEach(function(Be){var Se=Math.max(X,Be.start),Ve=Math.min(oe,Be.end);if(Se<Ve){for(var Me=J.levels.slice(Se,Ve+1),Ne=Ve;Ne>=Se&&f(ae[Ne])&c;Ne--)Me[Ne]=Be.level;for(var Ge=Be.level,je=1/0,st=0;st<Me.length;st++){var At=Me[st];At>Ge&&(Ge=At),At<je&&(je=At|1)}for(var it=Ge;it>=je;it--)for(var Xe=0;Xe<Me.length;Xe++)if(Me[Xe]>=it){for(var We=Xe;Xe+1<Me.length&&Me[Xe+1]>=it;)Xe++;Xe>We&&_e.push([We+Se,Xe+Se])}}}),_e}function se(ae,J,X,oe){var Ce=he(ae,J,X,oe),_e=[].concat(ae);return Ce.forEach(function(Be,Se){_e[Se]=(J.levels[Be]&1?ye(ae[Be]):null)||ae[Be]}),_e.join("")}function he(ae,J,X,oe){for(var Ce=re(ae,J,X,oe),_e=[],Be=0;Be<ae.length;Be++)_e[Be]=Be;return Ce.forEach(function(Se){for(var Ve=Se[0],Me=Se[1],Ne=_e.slice(Ve,Me+1),Ge=Ne.length;Ge--;)_e[Me-Ge]=Ne[Ge]}),_e}return e.closingToOpeningBracket=C,e.getBidiCharType=f,e.getBidiCharTypeName=d,e.getCanonicalBracket=I,e.getEmbeddingLevels=Z,e.getMirroredCharacter=ye,e.getMirroredCharactersMap=ve,e.getReorderSegments=re,e.getReorderedIndices=he,e.getReorderedString=se,e.openingToClosingBracket=x,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return r}const bv=/\bvoid\s+main\s*\(\s*\)\s*{/g;function Vd(r){const e=/^[ \t]*#include +<([\w\d./]+)>/gm;function t(i,n){let s=Xo[n];return s?Vd(s):i}return r.replace(e,t)}const ji=[];for(let r=0;r<256;r++)ji[r]=(r<16?"0":"")+r.toString(16);function B5(){const r=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(ji[r&255]+ji[r>>8&255]+ji[r>>16&255]+ji[r>>24&255]+"-"+ji[e&255]+ji[e>>8&255]+"-"+ji[e>>16&15|64]+ji[e>>24&255]+"-"+ji[t&63|128]+ji[t>>8&255]+"-"+ji[t>>16&255]+ji[t>>24&255]+ji[i&255]+ji[i>>8&255]+ji[i>>16&255]+ji[i>>24&255]).toUpperCase()}const Ur=Object.assign||function(){let r=arguments[0];for(let e=1,t=arguments.length;e<t;e++){let i=arguments[e];if(i)for(let n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])}return r},R5=Date.now(),Bp=new WeakMap,Rp=new Map;let D5=1e10;function Kd(r,e){const t=F5(e);let i=Bp.get(r);if(i||Bp.set(r,i=Object.create(null)),i[t])return new i[t];const n=`_onBeforeCompile${t}`,s=function(c,u){r.onBeforeCompile.call(this,c,u);const h=this.customProgramCacheKey()+"|"+c.vertexShader+"|"+c.fragmentShader;let f=Rp[h];if(!f){const d=M5(this,c,e,t);f=Rp[h]=d}c.vertexShader=f.vertexShader,c.fragmentShader=f.fragmentShader,Ur(c.uniforms,this.uniforms),e.timeUniform&&(c.uniforms[e.timeUniform]={get value(){return Date.now()-R5}}),this[n]&&this[n](c)},o=function(){return a(e.chained?r:r.clone())},a=function(c){const u=Object.create(c,l);return Object.defineProperty(u,"baseMaterial",{value:r}),Object.defineProperty(u,"id",{value:D5++}),u.uuid=B5(),u.uniforms=Ur({},c.uniforms,e.uniforms),u.defines=Ur({},c.defines,e.defines),u.defines[`TROIKA_DERIVED_MATERIAL_${t}`]="",u.extensions=Ur({},c.extensions,e.extensions),u._listeners=void 0,u},l={constructor:{value:o},isDerivedMaterial:{value:!0},type:{get:()=>r.type,set:c=>{r.type=c}},isDerivedFrom:{writable:!0,configurable:!0,value:function(c){const u=this.baseMaterial;return c===u||u.isDerivedMaterial&&u.isDerivedFrom(c)||!1}},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r.customProgramCacheKey()+"|"+t}},onBeforeCompile:{get(){return s},set(c){this[n]=c}},copy:{writable:!0,configurable:!0,value:function(c){return r.copy.call(this,c),!r.isShaderMaterial&&!r.isDerivedMaterial&&(Ur(this.extensions,c.extensions),Ur(this.defines,c.defines),Ur(this.uniforms,la.clone(c.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const c=new r.constructor;return a(c).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let c=this._depthMaterial;return c||(c=this._depthMaterial=Kd(r.isDerivedMaterial?r.getDepthMaterial():new t2({depthPacking:i2}),e),c.defines.IS_DEPTH_MATERIAL="",c.uniforms=this.uniforms),c}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let c=this._distanceMaterial;return c||(c=this._distanceMaterial=Kd(r.isDerivedMaterial?r.getDistanceMaterial():new rC,e),c.defines.IS_DISTANCE_MATERIAL="",c.uniforms=this.uniforms),c}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:c,_distanceMaterial:u}=this;c&&c.dispose(),u&&u.dispose(),r.dispose.call(this)}}};return i[t]=o,new o}function M5(r,{vertexShader:e,fragmentShader:t},i,n){let{vertexDefs:s,vertexMainIntro:o,vertexMainOutro:a,vertexTransform:l,fragmentDefs:c,fragmentMainIntro:u,fragmentMainOutro:h,fragmentColorTransform:f,customRewriter:d,timeUniform:m}=i;if(s=s||"",o=o||"",a=a||"",c=c||"",u=u||"",h=h||"",(l||d)&&(e=Vd(e)),(f||d)&&(t=t.replace(/^[ \t]*#include <((?:tonemapping|encodings|colorspace|fog|premultiplied_alpha|dithering)_fragment)>/gm,`
//!BEGIN_POST_CHUNK $1
$&
//!END_POST_CHUNK
`),t=Vd(t)),d){let A=d({vertexShader:e,fragmentShader:t});e=A.vertexShader,t=A.fragmentShader}if(f){let A=[];t=t.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,p=>(A.push(p),"")),h=`${f}
${A.join(`
`)}
${h}`}if(m){const A=`
uniform float ${m};
`;s=A+s,c=A+c}return l&&(e=`vec3 troika_position_${n};
vec3 troika_normal_${n};
vec2 troika_uv_${n};
${e}
`,s=`${s}
void troikaVertexTransform${n}(inout vec3 position, inout vec3 normal, inout vec2 uv) {
  ${l}
}
`,o=`
troika_position_${n} = vec3(position);
troika_normal_${n} = vec3(normal);
troika_uv_${n} = vec2(uv);
troikaVertexTransform${n}(troika_position_${n}, troika_normal_${n}, troika_uv_${n});
${o}
`,e=e.replace(/\b(position|normal|uv)\b/g,(A,p,y,E)=>/\battribute\s+vec[23]\s+$/.test(E.substr(0,y))?p:`troika_${p}_${n}`),r.map&&r.map.channel>0||(e=e.replace(/\bMAP_UV\b/g,`troika_uv_${n}`))),e=Dp(e,n,s,o,a),t=Dp(t,n,c,u,h),{vertexShader:e,fragmentShader:t}}function Dp(r,e,t,i,n){return(i||n||t)&&(r=r.replace(bv,`
${t}
void troikaOrigMain${e}() {`),r+=`
void main() {
  ${i}
  troikaOrigMain${e}();
  ${n}
}`),r}function L5(r,e){return r==="uniforms"?void 0:typeof e=="function"?e.toString():e}let P5=0;const Mp=new Map;function F5(r){const e=JSON.stringify(r,L5);let t=Mp.get(e);return t==null&&Mp.set(e,t=++P5),t}/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/function k5(){return typeof window>"u"&&(self.window=self),function(r){var e={parse:function(n){var s=e._bin,o=new Uint8Array(n);if(s.readASCII(o,0,4)=="ttcf"){var a=4;s.readUshort(o,a),a+=2,s.readUshort(o,a),a+=2;var l=s.readUint(o,a);a+=4;for(var c=[],u=0;u<l;u++){var h=s.readUint(o,a);a+=4,c.push(e._readFont(o,h))}return c}return[e._readFont(o,0)]},_readFont:function(n,s){var o=e._bin,a=s;o.readFixed(n,s),s+=4;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2;for(var c=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],u={_data:n,_offset:a},h={},f=0;f<l;f++){var d=o.readASCII(n,s,4);s+=4,o.readUint(n,s),s+=4;var m=o.readUint(n,s);s+=4;var A=o.readUint(n,s);s+=4,h[d]={offset:m,length:A}}for(f=0;f<c.length;f++){var p=c[f];h[p]&&(u[p.trim()]=e[p.trim()].parse(n,h[p].offset,h[p].length,u))}return u},_tabOffset:function(n,s,o){for(var a=e._bin,l=a.readUshort(n,o+4),c=o+12,u=0;u<l;u++){var h=a.readASCII(n,c,4);c+=4,a.readUint(n,c),c+=4;var f=a.readUint(n,c);if(c+=4,a.readUint(n,c),c+=4,h==s)return f}return 0}};e._bin={readFixed:function(n,s){return(n[s]<<8|n[s+1])+(n[s+2]<<8|n[s+3])/65540},readF2dot14:function(n,s){return e._bin.readShort(n,s)/16384},readInt:function(n,s){return e._bin._view(n).getInt32(s)},readInt8:function(n,s){return e._bin._view(n).getInt8(s)},readShort:function(n,s){return e._bin._view(n).getInt16(s)},readUshort:function(n,s){return e._bin._view(n).getUint16(s)},readUshorts:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(e._bin.readUshort(n,s+2*l));return a},readUint:function(n,s){return e._bin._view(n).getUint32(s)},readUint64:function(n,s){return 4294967296*e._bin.readUint(n,s)+e._bin.readUint(n,s+4)},readASCII:function(n,s,o){for(var a="",l=0;l<o;l++)a+=String.fromCharCode(n[s+l]);return a},readUnicode:function(n,s,o){for(var a="",l=0;l<o;l++){var c=n[s++]<<8|n[s++];a+=String.fromCharCode(c)}return a},_tdec:typeof window<"u"&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(n,s,o){var a=e._bin._tdec;return a&&s==0&&o==n.length?a.decode(n):e._bin.readASCII(n,s,o)},readBytes:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(n[s+l]);return a},readASCIIArray:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(String.fromCharCode(n[s+l]));return a},_view:function(n){return n._dataView||(n._dataView=n.buffer?new DataView(n.buffer,n.byteOffset,n.byteLength):new DataView(new Uint8Array(n).buffer))}},e._lctf={},e._lctf.parse=function(n,s,o,a,l){var c=e._bin,u={},h=s;c.readFixed(n,s),s+=4;var f=c.readUshort(n,s);s+=2;var d=c.readUshort(n,s);s+=2;var m=c.readUshort(n,s);return s+=2,u.scriptList=e._lctf.readScriptList(n,h+f),u.featureList=e._lctf.readFeatureList(n,h+d),u.lookupList=e._lctf.readLookupList(n,h+m,l),u},e._lctf.readLookupList=function(n,s,o){var a=e._bin,l=s,c=[],u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=a.readUshort(n,s);s+=2;var d=e._lctf.readLookupTable(n,l+f,o);c.push(d)}return c},e._lctf.readLookupTable=function(n,s,o){var a=e._bin,l=s,c={tabs:[]};c.ltype=a.readUshort(n,s),s+=2,c.flag=a.readUshort(n,s),s+=2;var u=a.readUshort(n,s);s+=2;for(var h=c.ltype,f=0;f<u;f++){var d=a.readUshort(n,s);s+=2;var m=o(n,h,l+d,c);c.tabs.push(m)}return c},e._lctf.numOfOnes=function(n){for(var s=0,o=0;o<32;o++)n>>>o&1&&s++;return s},e._lctf.readClassDef=function(n,s){var o=e._bin,a=[],l=o.readUshort(n,s);if(s+=2,l==1){var c=o.readUshort(n,s);s+=2;var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++)a.push(c+h),a.push(c+h),a.push(o.readUshort(n,s)),s+=2}if(l==2){var f=o.readUshort(n,s);for(s+=2,h=0;h<f;h++)a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2}return a},e._lctf.getInterval=function(n,s){for(var o=0;o<n.length;o+=3){var a=n[o],l=n[o+1];if(n[o+2],a<=s&&s<=l)return o}return-1},e._lctf.readCoverage=function(n,s){var o=e._bin,a={};a.fmt=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.fmt==1&&(a.tab=o.readUshorts(n,s,l)),a.fmt==2&&(a.tab=o.readUshorts(n,s,3*l)),a},e._lctf.coverageIndex=function(n,s){var o=n.tab;if(n.fmt==1)return o.indexOf(s);if(n.fmt==2){var a=e._lctf.getInterval(o,s);if(a!=-1)return o[a+2]+(s-o[a])}return-1},e._lctf.readFeatureList=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2;var d=e._lctf.readFeatureTable(n,a+f);d.tag=h.trim(),l.push(d)}return l},e._lctf.readFeatureTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.featureParams=a+c);var u=o.readUshort(n,s);s+=2,l.tab=[];for(var h=0;h<u;h++)l.tab.push(o.readUshort(n,s+2*h));return l},e._lctf.readScriptList=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2,l[h.trim()]=e._lctf.readScriptTable(n,a+f)}return l},e._lctf.readScriptTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.default=e._lctf.readLangSysTable(n,a+c));var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=o.readASCII(n,s,4);s+=4;var d=o.readUshort(n,s);s+=2,l[f.trim()]=e._lctf.readLangSysTable(n,a+d)}return l},e._lctf.readLangSysTable=function(n,s){var o=e._bin,a={};o.readUshort(n,s),s+=2,a.reqFeature=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.features=o.readUshorts(n,s,l),a},e.CFF={},e.CFF.parse=function(n,s,o){var a=e._bin;(n=new Uint8Array(n.buffer,s,o))[s=0],n[++s],n[++s],n[++s],s++;var l=[];s=e.CFF.readIndex(n,s,l);for(var c=[],u=0;u<l.length-1;u++)c.push(a.readASCII(n,s+l[u],l[u+1]-l[u]));s+=l[l.length-1];var h=[];s=e.CFF.readIndex(n,s,h);var f=[];for(u=0;u<h.length-1;u++)f.push(e.CFF.readDict(n,s+h[u],s+h[u+1]));s+=h[h.length-1];var d=f[0],m=[];s=e.CFF.readIndex(n,s,m);var A=[];for(u=0;u<m.length-1;u++)A.push(a.readASCII(n,s+m[u],m[u+1]-m[u]));if(s+=m[m.length-1],e.CFF.readSubrs(n,s,d),d.CharStrings){s=d.CharStrings,m=[],s=e.CFF.readIndex(n,s,m);var p=[];for(u=0;u<m.length-1;u++)p.push(a.readBytes(n,s+m[u],m[u+1]-m[u]));d.CharStrings=p}if(d.ROS){s=d.FDArray;var y=[];for(s=e.CFF.readIndex(n,s,y),d.FDArray=[],u=0;u<y.length-1;u++){var E=e.CFF.readDict(n,s+y[u],s+y[u+1]);e.CFF._readFDict(n,E,A),d.FDArray.push(E)}s+=y[y.length-1],s=d.FDSelect,d.FDSelect=[];var v=n[s];if(s++,v!=3)throw v;var x=a.readUshort(n,s);for(s+=2,u=0;u<x+1;u++)d.FDSelect.push(a.readUshort(n,s),n[s+2]),s+=3}return d.Encoding&&(d.Encoding=e.CFF.readEncoding(n,d.Encoding,d.CharStrings.length)),d.charset&&(d.charset=e.CFF.readCharset(n,d.charset,d.CharStrings.length)),e.CFF._readFDict(n,d,A),d},e.CFF._readFDict=function(n,s,o){var a;for(var l in s.Private&&(a=s.Private[1],s.Private=e.CFF.readDict(n,a,a+s.Private[0]),s.Private.Subrs&&e.CFF.readSubrs(n,a+s.Private.Subrs,s.Private)),s)["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(l)!=-1&&(s[l]=o[s[l]-426+35])},e.CFF.readSubrs=function(n,s,o){var a=e._bin,l=[];s=e.CFF.readIndex(n,s,l);var c,u=l.length;c=u<1240?107:u<33900?1131:32768,o.Bias=c,o.Subrs=[];for(var h=0;h<l.length-1;h++)o.Subrs.push(a.readBytes(n,s+l[h],l[h+1]-l[h]))},e.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],e.CFF.glyphByUnicode=function(n,s){for(var o=0;o<n.charset.length;o++)if(n.charset[o]==s)return o;return-1},e.CFF.glyphBySE=function(n,s){return s<0||s>255?-1:e.CFF.glyphByUnicode(n,e.CFF.tableSE[s])},e.CFF.readEncoding=function(n,s,o){e._bin;var a=[".notdef"],l=n[s];if(s++,l!=0)throw"error: unknown encoding format: "+l;var c=n[s];s++;for(var u=0;u<c;u++)a.push(n[s+u]);return a},e.CFF.readCharset=function(n,s,o){var a=e._bin,l=[".notdef"],c=n[s];if(s++,c==0)for(var u=0;u<o;u++){var h=a.readUshort(n,s);s+=2,l.push(h)}else{if(c!=1&&c!=2)throw"error: format: "+c;for(;l.length<o;){h=a.readUshort(n,s),s+=2;var f=0;for(c==1?(f=n[s],s++):(f=a.readUshort(n,s),s+=2),u=0;u<=f;u++)l.push(h),h++}}return l},e.CFF.readIndex=function(n,s,o){var a=e._bin,l=a.readUshort(n,s)+1,c=n[s+=2];if(s++,c==1)for(var u=0;u<l;u++)o.push(n[s+u]);else if(c==2)for(u=0;u<l;u++)o.push(a.readUshort(n,s+2*u));else if(c==3)for(u=0;u<l;u++)o.push(16777215&a.readUint(n,s+3*u-1));else if(l!=1)throw"unsupported offset size: "+c+", count: "+l;return(s+=l*c)-1},e.CFF.getCharString=function(n,s,o){var a=e._bin,l=n[s],c=n[s+1];n[s+2],n[s+3],n[s+4];var u=1,h=null,f=null;l<=20&&(h=l,u=1),l==12&&(h=100*l+c,u=2),21<=l&&l<=27&&(h=l,u=1),l==28&&(f=a.readShort(n,s+1),u=3),29<=l&&l<=31&&(h=l,u=1),32<=l&&l<=246&&(f=l-139,u=1),247<=l&&l<=250&&(f=256*(l-247)+c+108,u=2),251<=l&&l<=254&&(f=256*-(l-251)-c-108,u=2),l==255&&(f=a.readInt(n,s+1)/65535,u=5),o.val=f??"o"+h,o.size=u},e.CFF.readCharString=function(n,s,o){for(var a=s+o,l=e._bin,c=[];s<a;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;u<=20&&(d=u,f=1),u==12&&(d=100*u+h,f=2),u!=19&&u!=20||(d=u,f=2),21<=u&&u<=27&&(d=u,f=1),u==28&&(m=l.readShort(n,s+1),f=3),29<=u&&u<=31&&(d=u,f=1),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255&&(m=l.readInt(n,s+1)/65535,f=5),c.push(m??"o"+d),s+=f}return c},e.CFF.readDict=function(n,s,o){for(var a=e._bin,l={},c=[];s<o;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;if(u==28&&(m=a.readShort(n,s+1),f=3),u==29&&(m=a.readInt(n,s+1),f=5),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255)throw m=a.readInt(n,s+1)/65535,f=5,"unknown number";if(u==30){var A=[];for(f=1;;){var p=n[s+f];f++;var y=p>>4,E=15&p;if(y!=15&&A.push(y),E!=15&&A.push(E),E==15)break}for(var v="",x=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],C=0;C<A.length;C++)v+=x[A[C]];m=parseFloat(v)}u<=21&&(d=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][u],f=1,u==12&&(d=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][h],f=2)),d!=null?(l[d]=c.length==1?c[0]:c,c=[]):c.push(m),s+=f}return l},e.cmap={},e.cmap.parse=function(n,s,o){n=new Uint8Array(n.buffer,s,o),s=0;var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2;var u=[];l.tables=[];for(var h=0;h<c;h++){var f=a.readUshort(n,s);s+=2;var d=a.readUshort(n,s);s+=2;var m=a.readUint(n,s);s+=4;var A="p"+f+"e"+d,p=u.indexOf(m);if(p==-1){var y;p=l.tables.length,u.push(m);var E=a.readUshort(n,m);E==0?y=e.cmap.parse0(n,m):E==4?y=e.cmap.parse4(n,m):E==6?y=e.cmap.parse6(n,m):E==12?y=e.cmap.parse12(n,m):console.debug("unknown format: "+E,f,d,m),l.tables.push(y)}if(l[A]!=null)throw"multiple tables for one platform+encoding";l[A]=p}return l},e.cmap.parse0=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,a.map=[];for(var c=0;c<l-6;c++)a.map.push(n[s+c]);return a},e.cmap.parse4=function(n,s){var o=e._bin,a=s,l={};l.format=o.readUshort(n,s),s+=2;var c=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2;var u=o.readUshort(n,s);s+=2;var h=u/2;l.searchRange=o.readUshort(n,s),s+=2,l.entrySelector=o.readUshort(n,s),s+=2,l.rangeShift=o.readUshort(n,s),s+=2,l.endCount=o.readUshorts(n,s,h),s+=2*h,s+=2,l.startCount=o.readUshorts(n,s,h),s+=2*h,l.idDelta=[];for(var f=0;f<h;f++)l.idDelta.push(o.readShort(n,s)),s+=2;for(l.idRangeOffset=o.readUshorts(n,s,h),s+=2*h,l.glyphIdArray=[];s<a+c;)l.glyphIdArray.push(o.readUshort(n,s)),s+=2;return l},e.cmap.parse6=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,a.firstCode=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,a.glyphIdArray=[];for(var c=0;c<l;c++)a.glyphIdArray.push(o.readUshort(n,s)),s+=2;return a},e.cmap.parse12=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,s+=2,o.readUint(n,s),s+=4,o.readUint(n,s),s+=4;var l=o.readUint(n,s);s+=4,a.groups=[];for(var c=0;c<l;c++){var u=s+12*c,h=o.readUint(n,u+0),f=o.readUint(n,u+4),d=o.readUint(n,u+8);a.groups.push([h,f,d])}return a},e.glyf={},e.glyf.parse=function(n,s,o,a){for(var l=[],c=0;c<a.maxp.numGlyphs;c++)l.push(null);return l},e.glyf._parseGlyf=function(n,s){var o=e._bin,a=n._data,l=e._tabOffset(a,"glyf",n._offset)+n.loca[s];if(n.loca[s]==n.loca[s+1])return null;var c={};if(c.noc=o.readShort(a,l),l+=2,c.xMin=o.readShort(a,l),l+=2,c.yMin=o.readShort(a,l),l+=2,c.xMax=o.readShort(a,l),l+=2,c.yMax=o.readShort(a,l),l+=2,c.xMin>=c.xMax||c.yMin>=c.yMax)return null;if(c.noc>0){c.endPts=[];for(var u=0;u<c.noc;u++)c.endPts.push(o.readUshort(a,l)),l+=2;var h=o.readUshort(a,l);if(l+=2,a.length-l<h)return null;c.instructions=o.readBytes(a,l,h),l+=h;var f=c.endPts[c.noc-1]+1;for(c.flags=[],u=0;u<f;u++){var d=a[l];if(l++,c.flags.push(d),(8&d)!=0){var m=a[l];l++;for(var A=0;A<m;A++)c.flags.push(d),u++}}for(c.xs=[],u=0;u<f;u++){var p=(2&c.flags[u])!=0,y=(16&c.flags[u])!=0;p?(c.xs.push(y?a[l]:-a[l]),l++):y?c.xs.push(0):(c.xs.push(o.readShort(a,l)),l+=2)}for(c.ys=[],u=0;u<f;u++)p=(4&c.flags[u])!=0,y=(32&c.flags[u])!=0,p?(c.ys.push(y?a[l]:-a[l]),l++):y?c.ys.push(0):(c.ys.push(o.readShort(a,l)),l+=2);var E=0,v=0;for(u=0;u<f;u++)E+=c.xs[u],v+=c.ys[u],c.xs[u]=E,c.ys[u]=v}else{var x;c.parts=[];do{x=o.readUshort(a,l),l+=2;var C={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(c.parts.push(C),C.glyphIndex=o.readUshort(a,l),l+=2,1&x){var I=o.readShort(a,l);l+=2;var _=o.readShort(a,l);l+=2}else I=o.readInt8(a,l),l++,_=o.readInt8(a,l),l++;2&x?(C.m.tx=I,C.m.ty=_):(C.p1=I,C.p2=_),8&x?(C.m.a=C.m.d=o.readF2dot14(a,l),l+=2):64&x?(C.m.a=o.readF2dot14(a,l),l+=2,C.m.d=o.readF2dot14(a,l),l+=2):128&x&&(C.m.a=o.readF2dot14(a,l),l+=2,C.m.b=o.readF2dot14(a,l),l+=2,C.m.c=o.readF2dot14(a,l),l+=2,C.m.d=o.readF2dot14(a,l),l+=2)}while(32&x);if(256&x){var S=o.readUshort(a,l);for(l+=2,c.instr=[],u=0;u<S;u++)c.instr.push(a[l]),l++}}return c},e.GDEF={},e.GDEF.parse=function(n,s,o,a){var l=s;s+=4;var c=e._bin.readUshort(n,s);return{glyphClassDef:c===0?null:e._lctf.readClassDef(n,l+c)}},e.GPOS={},e.GPOS.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GPOS.subt)},e.GPOS.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s==1||s==2||s==3||s==7||s==8&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,h+c)}if(s==1&&u.fmt==1){var f=l.readUshort(n,o);o+=2,f!=0&&(u.pos=e.GPOS.readValueRecord(n,o,f))}else if(s==2&&u.fmt>=1&&u.fmt<=2){f=l.readUshort(n,o),o+=2;var d=l.readUshort(n,o);o+=2;var m=e._lctf.numOfOnes(f),A=e._lctf.numOfOnes(d);if(u.fmt==1){u.pairsets=[];var p=l.readUshort(n,o);o+=2;for(var y=0;y<p;y++){var E=c+l.readUshort(n,o);o+=2;var v=l.readUshort(n,E);E+=2;for(var x=[],C=0;C<v;C++){var I=l.readUshort(n,E);E+=2,f!=0&&(w=e.GPOS.readValueRecord(n,E,f),E+=2*m),d!=0&&(B=e.GPOS.readValueRecord(n,E,d),E+=2*A),x.push({gid2:I,val1:w,val2:B})}u.pairsets.push(x)}}if(u.fmt==2){var _=l.readUshort(n,o);o+=2;var S=l.readUshort(n,o);o+=2;var b=l.readUshort(n,o);o+=2;var T=l.readUshort(n,o);for(o+=2,u.classDef1=e._lctf.readClassDef(n,c+_),u.classDef2=e._lctf.readClassDef(n,c+S),u.matrix=[],y=0;y<b;y++){var R=[];for(C=0;C<T;C++){var w=null,B=null;f!=0&&(w=e.GPOS.readValueRecord(n,o,f),o+=2*m),d!=0&&(B=e.GPOS.readValueRecord(n,o,d),o+=2*A),R.push({val1:w,val2:B})}u.matrix.push(R)}}}else if(s==4&&u.fmt==1)u.markCoverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.baseCoverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.markArray=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.baseArray=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else if(s==6&&u.fmt==1)u.mark1Coverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.mark2Coverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.mark1Array=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.mark2Array=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else{if(s==9&&u.fmt==1){var D=l.readUshort(n,o);o+=2;var k=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=D;else if(a.ltype!=D)throw"invalid extension substitution";return e.GPOS.subt(n,a.ltype,c+k)}console.debug("unsupported GPOS table LookupType",s,"format",u.fmt)}return u},e.GPOS.readValueRecord=function(n,s,o){var a=e._bin,l=[];return l.push(1&o?a.readShort(n,s):0),s+=1&o?2:0,l.push(2&o?a.readShort(n,s):0),s+=2&o?2:0,l.push(4&o?a.readShort(n,s):0),s+=4&o?2:0,l.push(8&o?a.readShort(n,s):0),s+=8&o?2:0,l},e.GPOS.readBaseArray=function(n,s,o){var a=e._bin,l=[],c=s,u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){for(var f=[],d=0;d<o;d++)f.push(e.GPOS.readAnchorRecord(n,c+a.readUshort(n,s))),s+=2;l.push(f)}return l},e.GPOS.readMarkArray=function(n,s){var o=e._bin,a=[],l=s,c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=e.GPOS.readAnchorRecord(n,o.readUshort(n,s+2)+l);h.markClass=o.readUshort(n,s),a.push(h),s+=4}return a},e.GPOS.readAnchorRecord=function(n,s){var o=e._bin,a={};return a.fmt=o.readUshort(n,s),a.x=o.readShort(n,s+2),a.y=o.readShort(n,s+4),a},e.GSUB={},e.GSUB.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GSUB.subt)},e.GSUB.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s!=1&&s!=2&&s!=4&&s!=5&&s!=6)return null;if(s==1||s==2||s==4||s==5&&u.fmt<=2||s==6&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,c+h)}if(s==1&&u.fmt>=1&&u.fmt<=2){if(u.fmt==1)u.delta=l.readShort(n,o),o+=2;else if(u.fmt==2){var f=l.readUshort(n,o);o+=2,u.newg=l.readUshorts(n,o,f),o+=2*u.newg.length}}else if(s==2&&u.fmt==1){f=l.readUshort(n,o),o+=2,u.seqs=[];for(var d=0;d<f;d++){var m=l.readUshort(n,o)+c;o+=2;var A=l.readUshort(n,m);u.seqs.push(l.readUshorts(n,m+2,A))}}else if(s==4)for(u.vals=[],f=l.readUshort(n,o),o+=2,d=0;d<f;d++){var p=l.readUshort(n,o);o+=2,u.vals.push(e.GSUB.readLigatureSet(n,c+p))}else if(s==5&&u.fmt==2){if(u.fmt==2){var y=l.readUshort(n,o);o+=2,u.cDef=e._lctf.readClassDef(n,c+y),u.scset=[];var E=l.readUshort(n,o);for(o+=2,d=0;d<E;d++){var v=l.readUshort(n,o);o+=2,u.scset.push(v==0?null:e.GSUB.readSubClassSet(n,c+v))}}}else if(s==6&&u.fmt==3){if(u.fmt==3){for(d=0;d<3;d++){f=l.readUshort(n,o),o+=2;for(var x=[],C=0;C<f;C++)x.push(e._lctf.readCoverage(n,c+l.readUshort(n,o+2*C)));o+=2*f,d==0&&(u.backCvg=x),d==1&&(u.inptCvg=x),d==2&&(u.ahedCvg=x)}f=l.readUshort(n,o),o+=2,u.lookupRec=e.GSUB.readSubstLookupRecords(n,o,f)}}else{if(s==7&&u.fmt==1){var I=l.readUshort(n,o);o+=2;var _=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=I;else if(a.ltype!=I)throw"invalid extension substitution";return e.GSUB.subt(n,a.ltype,c+_)}console.debug("unsupported GSUB table LookupType",s,"format",u.fmt)}return u},e.GSUB.readSubClassSet=function(n,s){var o=e._bin.readUshort,a=s,l=[],c=o(n,s);s+=2;for(var u=0;u<c;u++){var h=o(n,s);s+=2,l.push(e.GSUB.readSubClassRule(n,a+h))}return l},e.GSUB.readSubClassRule=function(n,s){var o=e._bin.readUshort,a={},l=o(n,s),c=o(n,s+=2);s+=2,a.input=[];for(var u=0;u<l-1;u++)a.input.push(o(n,s)),s+=2;return a.substLookupRecords=e.GSUB.readSubstLookupRecords(n,s,c),a},e.GSUB.readSubstLookupRecords=function(n,s,o){for(var a=e._bin.readUshort,l=[],c=0;c<o;c++)l.push(a(n,s),a(n,s+2)),s+=4;return l},e.GSUB.readChainSubClassSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readChainSubClassRule(n,a+h))}return l},e.GSUB.readChainSubClassRule=function(n,s){for(var o=e._bin,a={},l=["backtrack","input","lookahead"],c=0;c<l.length;c++){var u=o.readUshort(n,s);s+=2,c==1&&u--,a[l[c]]=o.readUshorts(n,s,u),s+=2*a[l[c]].length}return u=o.readUshort(n,s),s+=2,a.subst=o.readUshorts(n,s,2*u),s+=2*a.subst.length,a},e.GSUB.readLigatureSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readLigature(n,a+h))}return l},e.GSUB.readLigature=function(n,s){var o=e._bin,a={chain:[]};a.nglyph=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2;for(var c=0;c<l-1;c++)a.chain.push(o.readUshort(n,s)),s+=2;return a},e.head={},e.head.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.fontRevision=a.readFixed(n,s),s+=4,a.readUint(n,s),s+=4,a.readUint(n,s),s+=4,l.flags=a.readUshort(n,s),s+=2,l.unitsPerEm=a.readUshort(n,s),s+=2,l.created=a.readUint64(n,s),s+=8,l.modified=a.readUint64(n,s),s+=8,l.xMin=a.readShort(n,s),s+=2,l.yMin=a.readShort(n,s),s+=2,l.xMax=a.readShort(n,s),s+=2,l.yMax=a.readShort(n,s),s+=2,l.macStyle=a.readUshort(n,s),s+=2,l.lowestRecPPEM=a.readUshort(n,s),s+=2,l.fontDirectionHint=a.readShort(n,s),s+=2,l.indexToLocFormat=a.readShort(n,s),s+=2,l.glyphDataFormat=a.readShort(n,s),s+=2,l},e.hhea={},e.hhea.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.ascender=a.readShort(n,s),s+=2,l.descender=a.readShort(n,s),s+=2,l.lineGap=a.readShort(n,s),s+=2,l.advanceWidthMax=a.readUshort(n,s),s+=2,l.minLeftSideBearing=a.readShort(n,s),s+=2,l.minRightSideBearing=a.readShort(n,s),s+=2,l.xMaxExtent=a.readShort(n,s),s+=2,l.caretSlopeRise=a.readShort(n,s),s+=2,l.caretSlopeRun=a.readShort(n,s),s+=2,l.caretOffset=a.readShort(n,s),s+=2,s+=8,l.metricDataFormat=a.readShort(n,s),s+=2,l.numberOfHMetrics=a.readUshort(n,s),s+=2,l},e.hmtx={},e.hmtx.parse=function(n,s,o,a){for(var l=e._bin,c={aWidth:[],lsBearing:[]},u=0,h=0,f=0;f<a.maxp.numGlyphs;f++)f<a.hhea.numberOfHMetrics&&(u=l.readUshort(n,s),s+=2,h=l.readShort(n,s),s+=2),c.aWidth.push(u),c.lsBearing.push(h);return c},e.kern={},e.kern.parse=function(n,s,o,a){var l=e._bin,c=l.readUshort(n,s);if(s+=2,c==1)return e.kern.parseV1(n,s-2,o,a);var u=l.readUshort(n,s);s+=2;for(var h={glyph1:[],rval:[]},f=0;f<u;f++){s+=2,o=l.readUshort(n,s),s+=2;var d=l.readUshort(n,s);s+=2;var m=d>>>8;if((m&=15)!=0)throw"unknown kern table format: "+m;s=e.kern.readFormat0(n,s,h)}return h},e.kern.parseV1=function(n,s,o,a){var l=e._bin;l.readFixed(n,s),s+=4;var c=l.readUint(n,s);s+=4;for(var u={glyph1:[],rval:[]},h=0;h<c;h++){l.readUint(n,s),s+=4;var f=l.readUshort(n,s);s+=2,l.readUshort(n,s),s+=2;var d=f>>>8;if((d&=15)!=0)throw"unknown kern table format: "+d;s=e.kern.readFormat0(n,s,u)}return u},e.kern.readFormat0=function(n,s,o){var a=e._bin,l=-1,c=a.readUshort(n,s);s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2;for(var u=0;u<c;u++){var h=a.readUshort(n,s);s+=2;var f=a.readUshort(n,s);s+=2;var d=a.readShort(n,s);s+=2,h!=l&&(o.glyph1.push(h),o.rval.push({glyph2:[],vals:[]}));var m=o.rval[o.rval.length-1];m.glyph2.push(f),m.vals.push(d),l=h}return s},e.loca={},e.loca.parse=function(n,s,o,a){var l=e._bin,c=[],u=a.head.indexToLocFormat,h=a.maxp.numGlyphs+1;if(u==0)for(var f=0;f<h;f++)c.push(l.readUshort(n,s+(f<<1))<<1);if(u==1)for(f=0;f<h;f++)c.push(l.readUint(n,s+(f<<2)));return c},e.maxp={},e.maxp.parse=function(n,s,o){var a=e._bin,l={},c=a.readUint(n,s);return s+=4,l.numGlyphs=a.readUshort(n,s),s+=2,c==65536&&(l.maxPoints=a.readUshort(n,s),s+=2,l.maxContours=a.readUshort(n,s),s+=2,l.maxCompositePoints=a.readUshort(n,s),s+=2,l.maxCompositeContours=a.readUshort(n,s),s+=2,l.maxZones=a.readUshort(n,s),s+=2,l.maxTwilightPoints=a.readUshort(n,s),s+=2,l.maxStorage=a.readUshort(n,s),s+=2,l.maxFunctionDefs=a.readUshort(n,s),s+=2,l.maxInstructionDefs=a.readUshort(n,s),s+=2,l.maxStackElements=a.readUshort(n,s),s+=2,l.maxSizeOfInstructions=a.readUshort(n,s),s+=2,l.maxComponentElements=a.readUshort(n,s),s+=2,l.maxComponentDepth=a.readUshort(n,s),s+=2),l},e.name={},e.name.parse=function(n,s,o){var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2,a.readUshort(n,s);for(var u,h=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],f=s+=2,d=0;d<c;d++){var m=a.readUshort(n,s);s+=2;var A=a.readUshort(n,s);s+=2;var p=a.readUshort(n,s);s+=2;var y=a.readUshort(n,s);s+=2;var E=a.readUshort(n,s);s+=2;var v=a.readUshort(n,s);s+=2;var x,C=h[y],I=f+12*c+v;if(m==0)x=a.readUnicode(n,I,E/2);else if(m==3&&A==0)x=a.readUnicode(n,I,E/2);else if(A==0)x=a.readASCII(n,I,E);else if(A==1)x=a.readUnicode(n,I,E/2);else if(A==3)x=a.readUnicode(n,I,E/2);else{if(m!=1)throw"unknown encoding "+A+", platformID: "+m;x=a.readASCII(n,I,E),console.debug("reading unknown MAC encoding "+A+" as ASCII")}var _="p"+m+","+p.toString(16);l[_]==null&&(l[_]={}),l[_][C!==void 0?C:y]=x,l[_]._lang=p}for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==1033)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==0)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==3084)return l[S];for(var S in l)if(l[S].postScriptName!=null)return l[S];for(var S in l){u=S;break}return console.debug("returning name table with languageID "+l[u]._lang),l[u]},e["OS/2"]={},e["OS/2"].parse=function(n,s,o){var a=e._bin.readUshort(n,s);s+=2;var l={};if(a==0)e["OS/2"].version0(n,s,l);else if(a==1)e["OS/2"].version1(n,s,l);else if(a==2||a==3||a==4)e["OS/2"].version2(n,s,l);else{if(a!=5)throw"unknown OS/2 table version: "+a;e["OS/2"].version5(n,s,l)}return l},e["OS/2"].version0=function(n,s,o){var a=e._bin;return o.xAvgCharWidth=a.readShort(n,s),s+=2,o.usWeightClass=a.readUshort(n,s),s+=2,o.usWidthClass=a.readUshort(n,s),s+=2,o.fsType=a.readUshort(n,s),s+=2,o.ySubscriptXSize=a.readShort(n,s),s+=2,o.ySubscriptYSize=a.readShort(n,s),s+=2,o.ySubscriptXOffset=a.readShort(n,s),s+=2,o.ySubscriptYOffset=a.readShort(n,s),s+=2,o.ySuperscriptXSize=a.readShort(n,s),s+=2,o.ySuperscriptYSize=a.readShort(n,s),s+=2,o.ySuperscriptXOffset=a.readShort(n,s),s+=2,o.ySuperscriptYOffset=a.readShort(n,s),s+=2,o.yStrikeoutSize=a.readShort(n,s),s+=2,o.yStrikeoutPosition=a.readShort(n,s),s+=2,o.sFamilyClass=a.readShort(n,s),s+=2,o.panose=a.readBytes(n,s,10),s+=10,o.ulUnicodeRange1=a.readUint(n,s),s+=4,o.ulUnicodeRange2=a.readUint(n,s),s+=4,o.ulUnicodeRange3=a.readUint(n,s),s+=4,o.ulUnicodeRange4=a.readUint(n,s),s+=4,o.achVendID=[a.readInt8(n,s),a.readInt8(n,s+1),a.readInt8(n,s+2),a.readInt8(n,s+3)],s+=4,o.fsSelection=a.readUshort(n,s),s+=2,o.usFirstCharIndex=a.readUshort(n,s),s+=2,o.usLastCharIndex=a.readUshort(n,s),s+=2,o.sTypoAscender=a.readShort(n,s),s+=2,o.sTypoDescender=a.readShort(n,s),s+=2,o.sTypoLineGap=a.readShort(n,s),s+=2,o.usWinAscent=a.readUshort(n,s),s+=2,o.usWinDescent=a.readUshort(n,s),s+=2},e["OS/2"].version1=function(n,s,o){var a=e._bin;return s=e["OS/2"].version0(n,s,o),o.ulCodePageRange1=a.readUint(n,s),s+=4,o.ulCodePageRange2=a.readUint(n,s),s+=4},e["OS/2"].version2=function(n,s,o){var a=e._bin;return s=e["OS/2"].version1(n,s,o),o.sxHeight=a.readShort(n,s),s+=2,o.sCapHeight=a.readShort(n,s),s+=2,o.usDefault=a.readUshort(n,s),s+=2,o.usBreak=a.readUshort(n,s),s+=2,o.usMaxContext=a.readUshort(n,s),s+=2},e["OS/2"].version5=function(n,s,o){var a=e._bin;return s=e["OS/2"].version2(n,s,o),o.usLowerOpticalPointSize=a.readUshort(n,s),s+=2,o.usUpperOpticalPointSize=a.readUshort(n,s),s+=2},e.post={},e.post.parse=function(n,s,o){var a=e._bin,l={};return l.version=a.readFixed(n,s),s+=4,l.italicAngle=a.readFixed(n,s),s+=4,l.underlinePosition=a.readShort(n,s),s+=2,l.underlineThickness=a.readShort(n,s),s+=2,l},e==null&&(e={}),e.U==null&&(e.U={}),e.U.codeToGlyph=function(n,s){var o=n.cmap,a=-1;if(o.p0e4!=null?a=o.p0e4:o.p3e1!=null?a=o.p3e1:o.p1e0!=null?a=o.p1e0:o.p0e3!=null&&(a=o.p0e3),a==-1)throw"no familiar platform and encoding!";var l=o.tables[a];if(l.format==0)return s>=l.map.length?0:l.map[s];if(l.format==4){for(var c=-1,u=0;u<l.endCount.length;u++)if(s<=l.endCount[u]){c=u;break}return c==-1||l.startCount[c]>s?0:65535&(l.idRangeOffset[c]!=0?l.glyphIdArray[s-l.startCount[c]+(l.idRangeOffset[c]>>1)-(l.idRangeOffset.length-c)]:s+l.idDelta[c])}if(l.format==12){if(s>l.groups[l.groups.length-1][1])return 0;for(u=0;u<l.groups.length;u++){var h=l.groups[u];if(h[0]<=s&&s<=h[1])return h[2]+(s-h[0])}return 0}throw"unknown cmap table format "+l.format},e.U.glyphToPath=function(n,s){var o={cmds:[],crds:[]};if(n.SVG&&n.SVG.entries[s]){var a=n.SVG.entries[s];return a==null?o:(typeof a=="string"&&(a=e.SVG.toPath(a),n.SVG.entries[s]=a),a)}if(n.CFF){var l={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:n.CFF.Private?n.CFF.Private.defaultWidthX:0,open:!1},c=n.CFF,u=n.CFF.Private;if(c.ROS){for(var h=0;c.FDSelect[h+2]<=s;)h+=2;u=c.FDArray[c.FDSelect[h+1]].Private}e.U._drawCFF(n.CFF.CharStrings[s],l,c,u,o)}else n.glyf&&e.U._drawGlyf(s,n,o);return o},e.U._drawGlyf=function(n,s,o){var a=s.glyf[n];a==null&&(a=s.glyf[n]=e.glyf._parseGlyf(s,n)),a!=null&&(a.noc>-1?e.U._simpleGlyph(a,o):e.U._compoGlyph(a,s,o))},e.U._simpleGlyph=function(n,s){for(var o=0;o<n.noc;o++){for(var a=o==0?0:n.endPts[o-1]+1,l=n.endPts[o],c=a;c<=l;c++){var u=c==a?l:c-1,h=c==l?a:c+1,f=1&n.flags[c],d=1&n.flags[u],m=1&n.flags[h],A=n.xs[c],p=n.ys[c];if(c==a)if(f){if(!d){e.U.P.moveTo(s,A,p);continue}e.U.P.moveTo(s,n.xs[u],n.ys[u])}else d?e.U.P.moveTo(s,n.xs[u],n.ys[u]):e.U.P.moveTo(s,(n.xs[u]+A)/2,(n.ys[u]+p)/2);f?d&&e.U.P.lineTo(s,A,p):m?e.U.P.qcurveTo(s,A,p,n.xs[h],n.ys[h]):e.U.P.qcurveTo(s,A,p,(A+n.xs[h])/2,(p+n.ys[h])/2)}e.U.P.closePath(s)}},e.U._compoGlyph=function(n,s,o){for(var a=0;a<n.parts.length;a++){var l={cmds:[],crds:[]},c=n.parts[a];e.U._drawGlyf(c.glyphIndex,s,l);for(var u=c.m,h=0;h<l.crds.length;h+=2){var f=l.crds[h],d=l.crds[h+1];o.crds.push(f*u.a+d*u.b+u.tx),o.crds.push(f*u.c+d*u.d+u.ty)}for(h=0;h<l.cmds.length;h++)o.cmds.push(l.cmds[h])}},e.U._getGlyphClass=function(n,s){var o=e._lctf.getInterval(s,n);return o==-1?0:s[o+2]},e.U._applySubs=function(n,s,o,a){for(var l=n.length-s-1,c=0;c<o.tabs.length;c++)if(o.tabs[c]!=null){var u,h=o.tabs[c];if(!h.coverage||(u=e._lctf.coverageIndex(h.coverage,n[s]))!=-1){if(o.ltype==1)n[s],h.fmt==1?n[s]=n[s]+h.delta:n[s]=h.newg[u];else if(o.ltype==4)for(var f=h.vals[u],d=0;d<f.length;d++){var m=f[d],A=m.chain.length;if(!(A>l)){for(var p=!0,y=0,E=0;E<A;E++){for(;n[s+y+(1+E)]==-1;)y++;m.chain[E]!=n[s+y+(1+E)]&&(p=!1)}if(p){for(n[s]=m.nglyph,E=0;E<A+y;E++)n[s+E+1]=-1;break}}}else if(o.ltype==5&&h.fmt==2)for(var v=e._lctf.getInterval(h.cDef,n[s]),x=h.cDef[v+2],C=h.scset[x],I=0;I<C.length;I++){var _=C[I],S=_.input;if(!(S.length>l)){for(p=!0,E=0;E<S.length;E++){var b=e._lctf.getInterval(h.cDef,n[s+1+E]);if(v==-1&&h.cDef[b+2]!=S[E]){p=!1;break}}if(p){var T=_.substLookupRecords;for(d=0;d<T.length;d+=2)T[d],T[d+1]}}}else if(o.ltype==6&&h.fmt==3){if(!e.U._glsCovered(n,h.backCvg,s-h.backCvg.length)||!e.U._glsCovered(n,h.inptCvg,s)||!e.U._glsCovered(n,h.ahedCvg,s+h.inptCvg.length))continue;var R=h.lookupRec;for(I=0;I<R.length;I+=2){v=R[I];var w=a[R[I+1]];e.U._applySubs(n,s+v,w,a)}}}}},e.U._glsCovered=function(n,s,o){for(var a=0;a<s.length;a++)if(e._lctf.coverageIndex(s[a],n[o+a])==-1)return!1;return!0},e.U.glyphsToPath=function(n,s,o){for(var a={cmds:[],crds:[]},l=0,c=0;c<s.length;c++){var u=s[c];if(u!=-1){for(var h=c<s.length-1&&s[c+1]!=-1?s[c+1]:0,f=e.U.glyphToPath(n,u),d=0;d<f.crds.length;d+=2)a.crds.push(f.crds[d]+l),a.crds.push(f.crds[d+1]);for(o&&a.cmds.push(o),d=0;d<f.cmds.length;d++)a.cmds.push(f.cmds[d]);o&&a.cmds.push("X"),l+=n.hmtx.aWidth[u],c<s.length-1&&(l+=e.U.getPairAdjustment(n,u,h))}}return a},e.U.P={},e.U.P.moveTo=function(n,s,o){n.cmds.push("M"),n.crds.push(s,o)},e.U.P.lineTo=function(n,s,o){n.cmds.push("L"),n.crds.push(s,o)},e.U.P.curveTo=function(n,s,o,a,l,c,u){n.cmds.push("C"),n.crds.push(s,o,a,l,c,u)},e.U.P.qcurveTo=function(n,s,o,a,l){n.cmds.push("Q"),n.crds.push(s,o,a,l)},e.U.P.closePath=function(n){n.cmds.push("Z")},e.U._drawCFF=function(n,s,o,a,l){for(var c=s.stack,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open,m=0,A=s.x,p=s.y,y=0,E=0,v=0,x=0,C=0,I=0,_=0,S=0,b=0,T=0,R={val:0,size:0};m<n.length;){e.CFF.getCharString(n,m,R);var w=R.val;if(m+=R.size,w=="o1"||w=="o18")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o3"||w=="o23")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o4")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),d&&e.U.P.closePath(l),p+=c.pop(),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o5")for(;c.length>0;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);else if(w=="o6"||w=="o7")for(var B=c.length,D=w=="o6",k=0;k<B;k++){var Q=c.shift();D?A+=Q:p+=Q,D=!D,e.U.P.lineTo(l,A,p)}else if(w=="o8"||w=="o24"){B=c.length;for(var Y=0;Y+6<=B;)y=A+c.shift(),E=p+c.shift(),v=y+c.shift(),x=E+c.shift(),A=v+c.shift(),p=x+c.shift(),e.U.P.curveTo(l,y,E,v,x,A,p),Y+=6;w=="o24"&&(A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p))}else{if(w=="o11")break;if(w=="o1234"||w=="o1235"||w=="o1236"||w=="o1237")w=="o1234"&&(E=p,v=(y=A+c.shift())+c.shift(),T=x=E+c.shift(),I=x,S=p,A=(_=(C=(b=v+c.shift())+c.shift())+c.shift())+c.shift(),e.U.P.curveTo(l,y,E,v,x,b,T),e.U.P.curveTo(l,C,I,_,S,A,p)),w=="o1235"&&(y=A+c.shift(),E=p+c.shift(),v=y+c.shift(),x=E+c.shift(),b=v+c.shift(),T=x+c.shift(),C=b+c.shift(),I=T+c.shift(),_=C+c.shift(),S=I+c.shift(),A=_+c.shift(),p=S+c.shift(),c.shift(),e.U.P.curveTo(l,y,E,v,x,b,T),e.U.P.curveTo(l,C,I,_,S,A,p)),w=="o1236"&&(y=A+c.shift(),E=p+c.shift(),v=y+c.shift(),T=x=E+c.shift(),I=x,_=(C=(b=v+c.shift())+c.shift())+c.shift(),S=I+c.shift(),A=_+c.shift(),e.U.P.curveTo(l,y,E,v,x,b,T),e.U.P.curveTo(l,C,I,_,S,A,p)),w=="o1237"&&(y=A+c.shift(),E=p+c.shift(),v=y+c.shift(),x=E+c.shift(),b=v+c.shift(),T=x+c.shift(),C=b+c.shift(),I=T+c.shift(),_=C+c.shift(),S=I+c.shift(),Math.abs(_-A)>Math.abs(S-p)?A=_+c.shift():p=S+c.shift(),e.U.P.curveTo(l,y,E,v,x,b,T),e.U.P.curveTo(l,C,I,_,S,A,p));else if(w=="o14"){if(c.length>0&&!h&&(f=c.shift()+o.nominalWidthX,h=!0),c.length==4){var W=c.shift(),P=c.shift(),K=c.shift(),M=c.shift(),V=e.CFF.glyphBySE(o,K),$=e.CFF.glyphBySE(o,M);e.U._drawCFF(o.CharStrings[V],s,o,a,l),s.x=W,s.y=P,e.U._drawCFF(o.CharStrings[$],s,o,a,l)}d&&(e.U.P.closePath(l),d=!1)}else if(w=="o19"||w=="o20")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0,m+=u+7>>3;else if(w=="o21")c.length>2&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),p+=c.pop(),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o22")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o25"){for(;c.length>6;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);y=A+c.shift(),E=p+c.shift(),v=y+c.shift(),x=E+c.shift(),A=v+c.shift(),p=x+c.shift(),e.U.P.curveTo(l,y,E,v,x,A,p)}else if(w=="o26")for(c.length%2&&(A+=c.shift());c.length>0;)y=A,E=p+c.shift(),A=v=y+c.shift(),p=(x=E+c.shift())+c.shift(),e.U.P.curveTo(l,y,E,v,x,A,p);else if(w=="o27")for(c.length%2&&(p+=c.shift());c.length>0;)E=p,v=(y=A+c.shift())+c.shift(),x=E+c.shift(),A=v+c.shift(),p=x,e.U.P.curveTo(l,y,E,v,x,A,p);else if(w=="o10"||w=="o29"){var G=w=="o10"?a:o;if(c.length==0)console.debug("error: empty stack");else{var O=c.pop(),F=G.Subrs[O+G.Bias];s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d,e.U._drawCFF(F,s,o,a,l),A=s.x,p=s.y,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open}}else if(w=="o30"||w=="o31"){var U=c.length,N=(Y=0,w=="o31");for(Y+=U-(B=-3&U);Y<B;)N?(E=p,v=(y=A+c.shift())+c.shift(),p=(x=E+c.shift())+c.shift(),B-Y==5?(A=v+c.shift(),Y++):A=v,N=!1):(y=A,E=p+c.shift(),v=y+c.shift(),x=E+c.shift(),A=v+c.shift(),B-Y==5?(p=x+c.shift(),Y++):p=x,N=!0),e.U.P.curveTo(l,y,E,v,x,A,p),Y+=4}else{if((w+"").charAt(0)=="o")throw console.debug("Unknown operation: "+w,n),w;c.push(w)}}}s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d};var t=e,i={Typr:t};return r.Typr=t,r.default=i,Object.defineProperty(r,"__esModule",{value:!0}),r}({}).Typr}/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/function O5(){return function(r){var e=Uint8Array,t=Uint16Array,i=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),s=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(w,B){for(var D=new t(31),k=0;k<31;++k)D[k]=B+=1<<w[k-1];var Q=new i(D[30]);for(k=1;k<30;++k)for(var Y=D[k];Y<D[k+1];++Y)Q[Y]=Y-D[k]<<5|k;return[D,Q]},l=a(n,2),c=l[0],u=l[1];c[28]=258,u[258]=28;for(var h=a(s,0)[0],f=new t(32768),d=0;d<32768;++d){var m=(43690&d)>>>1|(21845&d)<<1;m=(61680&(m=(52428&m)>>>2|(13107&m)<<2))>>>4|(3855&m)<<4,f[d]=((65280&m)>>>8|(255&m)<<8)>>>1}var A=function(w,B,D){for(var k=w.length,Q=0,Y=new t(B);Q<k;++Q)++Y[w[Q]-1];var W,P=new t(B);for(Q=0;Q<B;++Q)P[Q]=P[Q-1]+Y[Q-1]<<1;if(D){W=new t(1<<B);var K=15-B;for(Q=0;Q<k;++Q)if(w[Q])for(var M=Q<<4|w[Q],V=B-w[Q],$=P[w[Q]-1]++<<V,G=$|(1<<V)-1;$<=G;++$)W[f[$]>>>K]=M}else for(W=new t(k),Q=0;Q<k;++Q)w[Q]&&(W[Q]=f[P[w[Q]-1]++]>>>15-w[Q]);return W},p=new e(288);for(d=0;d<144;++d)p[d]=8;for(d=144;d<256;++d)p[d]=9;for(d=256;d<280;++d)p[d]=7;for(d=280;d<288;++d)p[d]=8;var y=new e(32);for(d=0;d<32;++d)y[d]=5;var E=A(p,9,1),v=A(y,5,1),x=function(w){for(var B=w[0],D=1;D<w.length;++D)w[D]>B&&(B=w[D]);return B},C=function(w,B,D){var k=B/8|0;return(w[k]|w[k+1]<<8)>>(7&B)&D},I=function(w,B){var D=B/8|0;return(w[D]|w[D+1]<<8|w[D+2]<<16)>>(7&B)},_=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],S=function(w,B,D){var k=new Error(B||_[w]);if(k.code=w,Error.captureStackTrace&&Error.captureStackTrace(k,S),!D)throw k;return k},b=function(w,B,D){var k=w.length;if(!k||D&&!D.l&&k<5)return B||new e(0);var Q=!B||D,Y=!D||D.i;D||(D={}),B||(B=new e(3*k));var W,P=function(We){var te=B.length;if(We>te){var Te=new e(Math.max(2*te,We));Te.set(B),B=Te}},K=D.f||0,M=D.p||0,V=D.b||0,$=D.l,G=D.d,O=D.m,F=D.n,U=8*k;do{if(!$){D.f=K=C(w,M,1);var N=C(w,M+1,3);if(M+=3,!N){var Z=w[(X=((W=M)/8|0)+(7&W&&1)+4)-4]|w[X-3]<<8,ie=X+Z;if(ie>k){Y&&S(0);break}Q&&P(V+Z),B.set(w.subarray(X,ie),V),D.b=V+=Z,D.p=M=8*ie;continue}if(N==1)$=E,G=v,O=9,F=5;else if(N==2){var q=C(w,M,31)+257,ne=C(w,M+10,15)+4,ye=q+C(w,M+5,31)+1;M+=14;for(var ve=new e(ye),re=new e(19),se=0;se<ne;++se)re[o[se]]=C(w,M+3*se,7);M+=3*ne;var he=x(re),ae=(1<<he)-1,J=A(re,he,1);for(se=0;se<ye;){var X,oe=J[C(w,M,ae)];if(M+=15&oe,(X=oe>>>4)<16)ve[se++]=X;else{var Ce=0,_e=0;for(X==16?(_e=3+C(w,M,3),M+=2,Ce=ve[se-1]):X==17?(_e=3+C(w,M,7),M+=3):X==18&&(_e=11+C(w,M,127),M+=7);_e--;)ve[se++]=Ce}}var Be=ve.subarray(0,q),Se=ve.subarray(q);O=x(Be),F=x(Se),$=A(Be,O,1),G=A(Se,F,1)}else S(1);if(M>U){Y&&S(0);break}}Q&&P(V+131072);for(var Ve=(1<<O)-1,Me=(1<<F)-1,Ne=M;;Ne=M){var Ge=(Ce=$[I(w,M)&Ve])>>>4;if((M+=15&Ce)>U){Y&&S(0);break}if(Ce||S(2),Ge<256)B[V++]=Ge;else{if(Ge==256){Ne=M,$=null;break}var je=Ge-254;if(Ge>264){var st=n[se=Ge-257];je=C(w,M,(1<<st)-1)+c[se],M+=st}var At=G[I(w,M)&Me],it=At>>>4;if(At||S(3),M+=15&At,Se=h[it],it>3&&(st=s[it],Se+=I(w,M)&(1<<st)-1,M+=st),M>U){Y&&S(0);break}Q&&P(V+131072);for(var Xe=V+je;V<Xe;V+=4)B[V]=B[V-Se],B[V+1]=B[V+1-Se],B[V+2]=B[V+2-Se],B[V+3]=B[V+3-Se];V=Xe}}D.l=$,D.p=Ne,D.b=V,$&&(K=1,D.m=O,D.d=G,D.n=F)}while(!K);return V==B.length?B:function(We,te,Te){(te==null||te<0)&&(te=0),(Te==null||Te>We.length)&&(Te=We.length);var Le=new(We instanceof t?t:We instanceof i?i:e)(Te-te);return Le.set(We.subarray(te,Te)),Le}(B,0,V)},T=new e(0),R=typeof TextDecoder<"u"&&new TextDecoder;try{R.decode(T,{stream:!0})}catch{}return r.convert_streams=function(w){var B=new DataView(w),D=0;function k(){var q=B.getUint16(D);return D+=2,q}function Q(){var q=B.getUint32(D);return D+=4,q}function Y(q){Z.setUint16(ie,q),ie+=2}function W(q){Z.setUint32(ie,q),ie+=4}for(var P={signature:Q(),flavor:Q(),length:Q(),numTables:k(),reserved:k(),totalSfntSize:Q(),majorVersion:k(),minorVersion:k(),metaOffset:Q(),metaLength:Q(),metaOrigLength:Q(),privOffset:Q(),privLength:Q()},K=0;Math.pow(2,K)<=P.numTables;)K++;K--;for(var M=16*Math.pow(2,K),V=16*P.numTables-M,$=12,G=[],O=0;O<P.numTables;O++)G.push({tag:Q(),offset:Q(),compLength:Q(),origLength:Q(),origChecksum:Q()}),$+=16;var F,U=new Uint8Array(12+16*G.length+G.reduce(function(q,ne){return q+ne.origLength+4},0)),N=U.buffer,Z=new DataView(N),ie=0;return W(P.flavor),Y(P.numTables),Y(M),Y(K),Y(V),G.forEach(function(q){W(q.tag),W(q.origChecksum),W($),W(q.origLength),q.outOffset=$,($+=q.origLength)%4!=0&&($+=4-$%4)}),G.forEach(function(q){var ne,ye=w.slice(q.offset,q.offset+q.compLength);if(q.compLength!=q.origLength){var ve=new Uint8Array(q.origLength);ne=new Uint8Array(ye,2),b(ne,ve)}else ve=new Uint8Array(ye);U.set(ve,q.outOffset);var re=0;($=q.outOffset+q.origLength)%4!=0&&(re=4-$%4),U.set(new Uint8Array(re).buffer,q.outOffset+q.origLength),F=$+re}),N.slice(0,F)},Object.defineProperty(r,"__esModule",{value:!0}),r}({}).convert_streams}function U5(r,e){const t={M:2,L:2,Q:4,C:6,Z:0},i={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},n=1,s=2,o=4,a=8,l=16,c=32;let u;function h(_){if(!u){const S={R:s,L:n,D:o,C:l,U:c,T:a};u=new Map;for(let b in i){let T=0;i[b].split(",").forEach(R=>{let[w,B]=R.split("+");w=parseInt(w,36),B=B?parseInt(B,36):0,u.set(T+=w,S[b]);for(let D=B;D--;)u.set(++T,S[b])})}}return u.get(_)||c}const f=1,d=2,m=3,A=4,p=[null,"isol","init","fina","medi"];function y(_){const S=new Uint8Array(_.length);let b=c,T=f,R=-1;for(let w=0;w<_.length;w++){const B=_.codePointAt(w);let D=h(B)|0,k=f;D&a||(b&(n|o|l)?D&(s|o|l)?(k=m,(T===f||T===m)&&S[R]++):D&(n|c)&&(T===d||T===A)&&S[R]--:b&(s|c)&&(T===d||T===A)&&S[R]--,T=S[w]=k,b=D,R=w,B>65535&&w++)}return S}function E(_,S){const b=[];for(let R=0;R<S.length;R++){const w=S.codePointAt(R);w>65535&&R++,b.push(r.U.codeToGlyph(_,w))}const T=_.GSUB;if(T){const{lookupList:R,featureList:w}=T;let B;const D=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,k=[];w.forEach(Q=>{if(D.test(Q.tag))for(let Y=0;Y<Q.tab.length;Y++){if(k[Q.tab[Y]])continue;k[Q.tab[Y]]=!0;const W=R[Q.tab[Y]],P=/^(isol|init|fina|medi)$/.test(Q.tag);P&&!B&&(B=y(S));for(let K=0;K<b.length;K++)(!B||!P||p[B[K]]===Q.tag)&&r.U._applySubs(b,K,W,R)}})}return b}function v(_,S){const b=new Int16Array(S.length*3);let T=0;for(;T<S.length;T++){const D=S[T];if(D===-1)continue;b[T*3+2]=_.hmtx.aWidth[D];const k=_.GPOS;if(k){const Q=k.lookupList;for(let Y=0;Y<Q.length;Y++){const W=Q[Y];for(let P=0;P<W.tabs.length;P++){const K=W.tabs[P];if(W.ltype===1){if(r._lctf.coverageIndex(K.coverage,D)!==-1&&K.pos){B(K.pos,T);break}}else if(W.ltype===2){let M=null,V=R();if(V!==-1){const $=r._lctf.coverageIndex(K.coverage,S[V]);if($!==-1){if(K.fmt===1){const G=K.pairsets[$];for(let O=0;O<G.length;O++)G[O].gid2===D&&(M=G[O])}else if(K.fmt===2){const G=r.U._getGlyphClass(S[V],K.classDef1),O=r.U._getGlyphClass(D,K.classDef2);M=K.matrix[G][O]}if(M){M.val1&&B(M.val1,V),M.val2&&B(M.val2,T);break}}}}else if(W.ltype===4){const M=r._lctf.coverageIndex(K.markCoverage,D);if(M!==-1){const V=R(w),$=V===-1?-1:r._lctf.coverageIndex(K.baseCoverage,S[V]);if($!==-1){const G=K.markArray[M],O=K.baseArray[$][G.markClass];b[T*3]=O.x-G.x+b[V*3]-b[V*3+2],b[T*3+1]=O.y-G.y+b[V*3+1];break}}}else if(W.ltype===6){const M=r._lctf.coverageIndex(K.mark1Coverage,D);if(M!==-1){const V=R();if(V!==-1){const $=S[V];if(x(_,$)===3){const G=r._lctf.coverageIndex(K.mark2Coverage,$);if(G!==-1){const O=K.mark1Array[M],F=K.mark2Array[G][O.markClass];b[T*3]=F.x-O.x+b[V*3]-b[V*3+2],b[T*3+1]=F.y-O.y+b[V*3+1];break}}}}}}}}else if(_.kern&&!_.cff){const Q=R();if(Q!==-1){const Y=_.kern.glyph1.indexOf(S[Q]);if(Y!==-1){const W=_.kern.rval[Y].glyph2.indexOf(D);W!==-1&&(b[Q*3+2]+=_.kern.rval[Y].vals[W])}}}}return b;function R(D){for(let k=T-1;k>=0;k--)if(S[k]!==-1&&(!D||D(S[k])))return k;return-1}function w(D){return x(_,D)===1}function B(D,k){for(let Q=0;Q<3;Q++)b[k*3+Q]+=D[Q]||0}}function x(_,S){const b=_.GDEF&&_.GDEF.glyphClassDef;return b?r.U._getGlyphClass(S,b):0}function C(..._){for(let S=0;S<_.length;S++)if(typeof _[S]=="number")return _[S]}function I(_){const S=Object.create(null),b=_["OS/2"],T=_.hhea,R=_.head.unitsPerEm,w=C(b&&b.sTypoAscender,T&&T.ascender,R),B={unitsPerEm:R,ascender:w,descender:C(b&&b.sTypoDescender,T&&T.descender,0),capHeight:C(b&&b.sCapHeight,w),xHeight:C(b&&b.sxHeight,w),lineGap:C(b&&b.sTypoLineGap,T&&T.lineGap),supportsCodePoint(D){return r.U.codeToGlyph(_,D)>0},forEachGlyph(D,k,Q,Y){let W=0;const P=1/B.unitsPerEm*k,K=E(_,D);let M=0;const V=v(_,K);return K.forEach(($,G)=>{if($!==-1){let O=S[$];if(!O){const{cmds:F,crds:U}=r.U.glyphToPath(_,$);let N="",Z=0;for(let ve=0,re=F.length;ve<re;ve++){const se=t[F[ve]];N+=F[ve];for(let he=1;he<=se;he++)N+=(he>1?",":"")+U[Z++]}let ie,q,ne,ye;if(U.length){ie=q=1/0,ne=ye=-1/0;for(let ve=0,re=U.length;ve<re;ve+=2){let se=U[ve],he=U[ve+1];se<ie&&(ie=se),he<q&&(q=he),se>ne&&(ne=se),he>ye&&(ye=he)}}else ie=ne=q=ye=0;O=S[$]={index:$,advanceWidth:_.hmtx.aWidth[$],xMin:ie,yMin:q,xMax:ne,yMax:ye,path:N}}Y.call(null,O,W+V[G*3]*P,V[G*3+1]*P,M),W+=V[G*3+2]*P,Q&&(W+=Q*k)}M+=D.codePointAt(M)>65535?2:1}),W}};return B}return function(S){const b=new Uint8Array(S,0,4),T=r._bin.readASCII(b,0,4);if(T==="wOFF")S=e(S);else if(T==="wOF2")throw new Error("woff2 fonts not supported");return I(r.parse(S)[0])}}const N5=ga({name:"Typr Font Parser",dependencies:[k5,O5,U5],init(r,e,t){const i=r(),n=e();return t(i,n)}});/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/function G5(){return function(r){var e=function(){this.buckets=new Map};e.prototype.add=function(v){var x=v>>5;this.buckets.set(x,(this.buckets.get(x)||0)|1<<(31&v))},e.prototype.has=function(v){var x=this.buckets.get(v>>5);return x!==void 0&&(x&1<<(31&v))!=0},e.prototype.serialize=function(){var v=[];return this.buckets.forEach(function(x,C){v.push((+C).toString(36)+":"+x.toString(36))}),v.join(",")},e.prototype.deserialize=function(v){var x=this;this.buckets.clear(),v.split(",").forEach(function(C){var I=C.split(":");x.buckets.set(parseInt(I[0],36),parseInt(I[1],36))})};var t=Math.pow(2,8),i=t-1,n=~i;function s(v){var x=function(I){return I&n}(v).toString(16),C=function(I){return(I&n)+t-1}(v).toString(16);return"codepoint-index/plane"+(v>>16)+"/"+x+"-"+C+".json"}function o(v,x){var C=v&i,I=x.codePointAt(C/6|0);return((I=(I||48)-48)&1<<C%6)!=0}function a(v,x){var C;(C=v,C.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map(function(I){return I.split("-").map(function(_){return parseInt(_.trim(),16)})})).forEach(function(I){var _=I[0],S=I[1];S===void 0&&(S=_),x(_,S)})}function l(v,x){a(v,function(C,I){for(var _=C;_<=I;_++)x(_)})}var c={},u={},h=new WeakMap,f="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(v){var x=h.get(v);return x||(x=new e,l(v.ranges,function(C){return x.add(C)}),h.set(v,x)),x}var m,A=new Map;function p(v,x,C){return v[x]?x:v[C]?C:function(I){for(var _ in I)return _}(v)}function y(v,x){var C=x;if(!v.includes(C)){C=1/0;for(var I=0;I<v.length;I++)Math.abs(v[I]-x)<Math.abs(C-x)&&(C=v[I])}return C}function E(v){return m||(m=new Set,l("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",function(x){m.add(x)})),m.has(v)}return r.CodePointSet=e,r.clearCache=function(){c={},u={}},r.getFontsForString=function(v,x){x===void 0&&(x={});var C,I=x.lang;I===void 0&&(I=/\p{Script=Hangul}/u.test(C=v)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(C)?"ja":"en");var _=x.category;_===void 0&&(_="sans-serif");var S=x.style;S===void 0&&(S="normal");var b=x.weight;b===void 0&&(b=400);var T=(x.dataUrl||f).replace(/\/$/g,""),R=new Map,w=new Uint8Array(v.length),B={},D={},k=new Array(v.length),Q=new Map,Y=!1;function W(M){var V=A.get(M);return V||(V=fetch(T+"/"+M).then(function($){if(!$.ok)throw new Error($.statusText);return $.json().then(function(G){if(!Array.isArray(G)||G[0]!==1)throw new Error("Incorrect schema version; need 1, got "+G[0]);return G[1]})}).catch(function($){if(T!==f)return Y||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+T+'", trying default CDN. '+$.message),Y=!0),T=f,A.delete(M),W(M);throw $}),A.set(M,V)),V}for(var P=function(M){var V=v.codePointAt(M),$=s(V);k[M]=$,c[$]||Q.has($)||Q.set($,W($).then(function(G){c[$]=G})),V>65535&&(M++,K=M)},K=0;K<v.length;K++)P(K);return Promise.all(Q.values()).then(function(){Q.clear();for(var M=function($){var G=v.codePointAt($),O=null,F=c[k[$]],U=void 0;for(var N in F){var Z=D[N];if(Z===void 0&&(Z=D[N]=new RegExp(N).test(I||"en")),Z){for(var ie in U=N,F[N])if(o(G,F[N][ie])){O=ie;break}break}}if(!O){e:for(var q in F)if(q!==U){for(var ne in F[q])if(o(G,F[q][ne])){O=ne;break e}}}O||(console.debug("No font coverage for U+"+G.toString(16)),O="latin"),k[$]=O,u[O]||Q.has(O)||Q.set(O,W("font-meta/"+O+".json").then(function(ye){u[O]=ye})),G>65535&&($++,V=$)},V=0;V<v.length;V++)M(V);return Promise.all(Q.values())}).then(function(){for(var M,V=null,$=0;$<v.length;$++){var G=v.codePointAt($);if(V&&(E(G)||d(V).has(G)))w[$]=w[$-1];else{V=u[k[$]];var O=B[V.id];if(!O){var F=V.typeforms,U=p(F,_,"sans-serif"),N=p(F[U],S,"normal"),Z=y((M=F[U])===null||M===void 0?void 0:M[N],b);O=B[V.id]=T+"/font-files/"+V.id+"/"+U+"."+N+"."+Z+".woff"}var ie=R.get(O);ie==null&&(ie=R.size,R.set(O,ie)),w[$]=ie}G>65535&&($++,w[$]=w[$-1])}return{fontUrls:Array.from(R.keys()),chars:w}})},Object.defineProperty(r,"__esModule",{value:!0}),r}({})}function Q5(r,e){const t=Object.create(null),i=Object.create(null);function n(o,a){const l=c=>{console.error(`Failure loading font ${o}`,c)};try{const c=new XMLHttpRequest;c.open("get",o,!0),c.responseType="arraybuffer",c.onload=function(){if(c.status>=400)l(new Error(c.statusText));else if(c.status>0)try{const u=r(c.response);u.src=o,a(u)}catch(u){l(u)}},c.onerror=l,c.send()}catch(c){l(c)}}function s(o,a){let l=t[o];l?a(l):i[o]?i[o].push(a):(i[o]=[a],n(o,c=>{c.src=o,t[o]=c,i[o].forEach(u=>u(c)),delete i[o]}))}return function(o,a,{lang:l,fonts:c=[],style:u="normal",weight:h="normal",unicodeFontsURL:f}={}){const d=new Uint8Array(o.length),m=[];o.length||E();const A=new Map,p=[];if(u!=="italic"&&(u="normal"),typeof h!="number"&&(h=h==="bold"?700:400),c&&!Array.isArray(c)&&(c=[c]),c=c.slice().filter(x=>!x.lang||x.lang.test(l)).reverse(),c.length){let _=0;(function S(b=0){for(let T=b,R=o.length;T<R;T++){const w=o.codePointAt(T);if(_===1&&m[d[T-1]].supportsCodePoint(w)||T>0&&/\s/.test(o[T]))d[T]=d[T-1],_===2&&(p[p.length-1][1]=T);else for(let B=d[T],D=c.length;B<=D;B++)if(B===D){const k=_===2?p[p.length-1]:p[p.length]=[T,T];k[1]=T,_=2}else{d[T]=B;const{src:k,unicodeRange:Q}=c[B];if(!Q||v(w,Q)){const Y=t[k];if(!Y){s(k,()=>{S(T)});return}if(Y.supportsCodePoint(w)){let W=A.get(Y);typeof W!="number"&&(W=m.length,m.push(Y),A.set(Y,W)),d[T]=W,_=1;break}}}w>65535&&T+1<R&&(d[T+1]=d[T],T++,_===2&&(p[p.length-1][1]=T))}y()})()}else p.push([0,o.length-1]),y();function y(){if(p.length){const x=p.map(C=>o.substring(C[0],C[1]+1)).join(`
`);e.getFontsForString(x,{lang:l||void 0,style:u,weight:h,dataUrl:f}).then(({fontUrls:C,chars:I})=>{const _=m.length;let S=0;p.forEach(T=>{for(let R=0,w=T[1]-T[0];R<=w;R++)d[T[0]+R]=I[S++]+_;S++});let b=0;C.forEach((T,R)=>{s(T,w=>{m[R+_]=w,++b===C.length&&E()})})})}else E()}function E(){a({chars:d,fonts:m})}function v(x,C){for(let I=0;I<C.length;I++){const[_,S=_]=C[I];if(_<=x&&x<=S)return!0}return!1}}}const z5=ga({name:"FontResolver",dependencies:[Q5,N5,G5],init(r,e,t){return r(e,t())}});function H5(r,e){const i=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,n="[^\\S\\u00A0]",s=new RegExp(`${n}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function o({text:m,lang:A,fonts:p,style:y,weight:E,preResolvedFonts:v,unicodeFontsURL:x},C){const I=({chars:_,fonts:S})=>{let b,T;const R=[];for(let w=0;w<_.length;w++)_[w]!==T?(T=_[w],R.push(b={start:w,end:w,fontObj:S[_[w]]})):b.end=w;C(R)};v?I(v):r(m,I,{lang:A,fonts:p,style:y,weight:E,unicodeFontsURL:x})}function a({text:m="",font:A,lang:p,sdfGlyphSize:y=64,fontSize:E=400,fontWeight:v=1,fontStyle:x="normal",letterSpacing:C=0,lineHeight:I="normal",maxWidth:_=1/0,direction:S,textAlign:b="left",textIndent:T=0,whiteSpace:R="normal",overflowWrap:w="normal",anchorX:B=0,anchorY:D=0,metricsOnly:k=!1,unicodeFontsURL:Q,preResolvedFonts:Y=null,includeCaretPositions:W=!1,chunkedBoundsSize:P=8192,colorRanges:K=null},M){const V=h(),$={fontLoad:0,typesetting:0};m.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),m=m.replace(/\r\n/g,`
`).replace(/\r/g,`
`)),E=+E,C=+C,_=+_,I=I||"normal",T=+T,o({text:m,lang:p,style:x,weight:v,fonts:typeof A=="string"?[{src:A}]:A,unicodeFontsURL:Q,preResolvedFonts:Y},G=>{$.fontLoad=h()-V;const O=isFinite(_);let F=null,U=null,N=null,Z=null,ie=null,q=null,ne=null,ye=null,ve=0,re=0,se=R!=="nowrap";const he=new Map,ae=h();let J=T,X=0,oe=new f;const Ce=[oe];G.forEach(Me=>{const{fontObj:Ne}=Me,{ascender:Ge,descender:je,unitsPerEm:st,lineGap:At,capHeight:it,xHeight:Xe}=Ne;let We=he.get(Ne);if(!We){const pe=E/st,ot=I==="normal"?(Ge-je+At)*pe:I*E,qt=(ot-(Ge-je)*pe)/2,Bt=Math.min(ot,(Ge-je)*pe),pt=(Ge+je)/2*pe+Bt/2;We={index:he.size,src:Ne.src,fontObj:Ne,fontSizeMult:pe,unitsPerEm:st,ascender:Ge*pe,descender:je*pe,capHeight:it*pe,xHeight:Xe*pe,lineHeight:ot,baseline:-qt-Ge*pe,caretTop:pt,caretBottom:pt-Bt},he.set(Ne,We)}const{fontSizeMult:te}=We,Te=m.slice(Me.start,Me.end+1);let Le,Ke;Ne.forEachGlyph(Te,E,C,(pe,ot,qt,Bt)=>{ot+=X,Bt+=Me.start,Le=ot,Ke=pe;const pt=m.charAt(Bt),Tt=pe.advanceWidth*te,_t=oe.count;let at;if("isEmpty"in pe||(pe.isWhitespace=!!pt&&new RegExp(n).test(pt),pe.canBreakAfter=!!pt&&s.test(pt),pe.isEmpty=pe.xMin===pe.xMax||pe.yMin===pe.yMax||i.test(pt)),!pe.isWhitespace&&!pe.isEmpty&&re++,se&&O&&!pe.isWhitespace&&ot+Tt+J>_&&_t){if(oe.glyphAt(_t-1).glyphObj.canBreakAfter)at=new f,J=-ot;else for(let ai=_t;ai--;)if(ai===0&&w==="break-word"){at=new f,J=-ot;break}else if(oe.glyphAt(ai).glyphObj.canBreakAfter){at=oe.splitAt(ai+1);const li=at.glyphAt(0).x;J-=li;for(let yi=at.count;yi--;)at.glyphAt(yi).x-=li;break}at&&(oe.isSoftWrapped=!0,oe=at,Ce.push(oe),ve=_)}let bt=oe.glyphAt(oe.count);bt.glyphObj=pe,bt.x=ot+J,bt.y=qt,bt.width=Tt,bt.charIndex=Bt,bt.fontData=We,pt===`
`&&(oe=new f,Ce.push(oe),J=-(ot+Tt+C*E)+T)}),X=Le+Ke.advanceWidth*te+C*E});let _e=0;Ce.forEach(Me=>{let Ne=!0;for(let Ge=Me.count;Ge--;){const je=Me.glyphAt(Ge);Ne&&!je.glyphObj.isWhitespace&&(Me.width=je.x+je.width,Me.width>ve&&(ve=Me.width),Ne=!1);let{lineHeight:st,capHeight:At,xHeight:it,baseline:Xe}=je.fontData;st>Me.lineHeight&&(Me.lineHeight=st);const We=Xe-Me.baseline;We<0&&(Me.baseline+=We,Me.cap+=We,Me.ex+=We),Me.cap=Math.max(Me.cap,Me.baseline+At),Me.ex=Math.max(Me.ex,Me.baseline+it)}Me.baseline-=_e,Me.cap-=_e,Me.ex-=_e,_e+=Me.lineHeight});let Be=0,Se=0;if(B&&(typeof B=="number"?Be=-B:typeof B=="string"&&(Be=-ve*(B==="left"?0:B==="center"?.5:B==="right"?1:c(B)))),D&&(typeof D=="number"?Se=-D:typeof D=="string"&&(Se=D==="top"?0:D==="top-baseline"?-Ce[0].baseline:D==="top-cap"?-Ce[0].cap:D==="top-ex"?-Ce[0].ex:D==="middle"?_e/2:D==="bottom"?_e:D==="bottom-baseline"?-Ce[Ce.length-1].baseline:c(D)*_e)),!k){const Me=e.getEmbeddingLevels(m,S);F=new Uint16Array(re),U=new Uint8Array(re),N=new Float32Array(re*2),Z={},ne=[1/0,1/0,-1/0,-1/0],ye=[],W&&(q=new Float32Array(m.length*4)),K&&(ie=new Uint8Array(re*3));let Ne=0,Ge=-1,je=-1,st,At;if(Ce.forEach((it,Xe)=>{let{count:We,width:te}=it;if(We>0){let Te=0;for(let Bt=We;Bt--&&it.glyphAt(Bt).glyphObj.isWhitespace;)Te++;let Le=0,Ke=0;if(b==="center")Le=(ve-te)/2;else if(b==="right")Le=ve-te;else if(b==="justify"&&it.isSoftWrapped){let Bt=0;for(let pt=We-Te;pt--;)it.glyphAt(pt).glyphObj.isWhitespace&&Bt++;Ke=(ve-te)/Bt}if(Ke||Le){let Bt=0;for(let pt=0;pt<We;pt++){let Tt=it.glyphAt(pt);const _t=Tt.glyphObj;Tt.x+=Le+Bt,Ke!==0&&_t.isWhitespace&&pt<We-Te&&(Bt+=Ke,Tt.width+=Ke)}}const pe=e.getReorderSegments(m,Me,it.glyphAt(0).charIndex,it.glyphAt(it.count-1).charIndex);for(let Bt=0;Bt<pe.length;Bt++){const[pt,Tt]=pe[Bt];let _t=1/0,at=-1/0;for(let bt=0;bt<We;bt++)if(it.glyphAt(bt).charIndex>=pt){let ai=bt,li=bt;for(;li<We;li++){let yi=it.glyphAt(li);if(yi.charIndex>Tt)break;li<We-Te&&(_t=Math.min(_t,yi.x),at=Math.max(at,yi.x+yi.width))}for(let yi=ai;yi<li;yi++){const En=it.glyphAt(yi);En.x=at-(En.x+En.width-_t)}break}}let ot;const qt=Bt=>ot=Bt;for(let Bt=0;Bt<We;Bt++){const pt=it.glyphAt(Bt);ot=pt.glyphObj;const Tt=ot.index,_t=Me.levels[pt.charIndex]&1;if(_t){const at=e.getMirroredCharacter(m[pt.charIndex]);at&&pt.fontData.fontObj.forEachGlyph(at,0,0,qt)}if(W){const{charIndex:at,fontData:bt}=pt,ai=pt.x+Be,li=pt.x+pt.width+Be;q[at*4]=_t?li:ai,q[at*4+1]=_t?ai:li,q[at*4+2]=it.baseline+bt.caretBottom+Se,q[at*4+3]=it.baseline+bt.caretTop+Se;const yi=at-Ge;yi>1&&u(q,Ge,yi),Ge=at}if(K){const{charIndex:at}=pt;for(;at>je;)je++,K.hasOwnProperty(je)&&(At=K[je])}if(!ot.isWhitespace&&!ot.isEmpty){const at=Ne++,{fontSizeMult:bt,src:ai,index:li}=pt.fontData,yi=Z[ai]||(Z[ai]={});yi[Tt]||(yi[Tt]={path:ot.path,pathBounds:[ot.xMin,ot.yMin,ot.xMax,ot.yMax]});const En=pt.x+Be,xn=pt.y+it.baseline+Se;N[at*2]=En,N[at*2+1]=xn;const es=En+ot.xMin*bt,ln=xn+ot.yMin*bt,Cn=En+ot.xMax*bt,ht=xn+ot.yMax*bt;es<ne[0]&&(ne[0]=es),ln<ne[1]&&(ne[1]=ln),Cn>ne[2]&&(ne[2]=Cn),ht>ne[3]&&(ne[3]=ht),at%P===0&&(st={start:at,end:at,rect:[1/0,1/0,-1/0,-1/0]},ye.push(st)),st.end++;const Ni=st.rect;if(es<Ni[0]&&(Ni[0]=es),ln<Ni[1]&&(Ni[1]=ln),Cn>Ni[2]&&(Ni[2]=Cn),ht>Ni[3]&&(Ni[3]=ht),F[at]=Tt,U[at]=li,K){const Us=at*3;ie[Us]=At>>16&255,ie[Us+1]=At>>8&255,ie[Us+2]=At&255}}}}}),q){const it=m.length-Ge;it>1&&u(q,Ge,it)}}const Ve=[];he.forEach(({index:Me,src:Ne,unitsPerEm:Ge,ascender:je,descender:st,lineHeight:At,capHeight:it,xHeight:Xe})=>{Ve[Me]={src:Ne,unitsPerEm:Ge,ascender:je,descender:st,lineHeight:At,capHeight:it,xHeight:Xe}}),$.typesetting=h()-ae,M({glyphIds:F,glyphFontIndices:U,glyphPositions:N,glyphData:Z,fontData:Ve,caretPositions:q,glyphColors:ie,chunkedBounds:ye,fontSize:E,topBaseline:Se+Ce[0].baseline,blockBounds:[Be,Se-_e,Be+ve,Se],visibleBounds:ne,timings:$})})}function l(m,A){a({...m,metricsOnly:!0},p=>{const[y,E,v,x]=p.blockBounds;A({width:v-y,height:x-E})})}function c(m){let A=m.match(/^([\d.]+)%$/),p=A?parseFloat(A[1]):NaN;return isNaN(p)?0:p/100}function u(m,A,p){const y=m[A*4],E=m[A*4+1],v=m[A*4+2],x=m[A*4+3],C=(E-y)/p;for(let I=0;I<p;I++){const _=(A+I)*4;m[_]=y+C*I,m[_+1]=y+C*(I+1),m[_+2]=v,m[_+3]=x}}function h(){return(self.performance||Date).now()}function f(){this.data=[]}const d=["glyphObj","x","y","width","charIndex","fontData"];return f.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/d.length)},glyphAt(m){let A=f.flyweight;return A.data=this.data,A.index=m,A},splitAt(m){let A=new f;return A.data=this.data.splice(m*d.length),A}},f.flyweight=d.reduce((m,A,p,y)=>(Object.defineProperty(m,A,{get(){return this.data[this.index*d.length+p]},set(E){this.data[this.index*d.length+p]=E}}),m),{data:null,index:0}),{typeset:a,measure:l}}const eo=()=>(self.performance||Date).now(),th=Tv();let Lp;function V5(r,e,t,i,n,s,o,a,l,c,u=!0){return u?$5(r,e,t,i,n,s,o,a,l,c).then(null,h=>(Lp||(console.warn("WebGL SDF generation failed, falling back to JS",h),Lp=!0),Fp(r,e,t,i,n,s,o,a,l,c))):Fp(r,e,t,i,n,s,o,a,l,c)}const mu=[],K5=5;let $d=0;function wv(){const r=eo();for(;mu.length&&eo()-r<K5;)mu.shift()();$d=mu.length?setTimeout(wv,0):0}const $5=(...r)=>new Promise((e,t)=>{mu.push(()=>{const i=eo();try{th.webgl.generateIntoCanvas(...r),e({timing:eo()-i})}catch(n){t(n)}}),$d||($d=setTimeout(wv,0))}),Y5=4,W5=2e3,Pp={};let j5=0;function Fp(r,e,t,i,n,s,o,a,l,c){const u="TroikaTextSDFGenerator_JS_"+j5++%Y5;let h=Pp[u];return h||(h=Pp[u]={workerModule:ga({name:u,workerId:u,dependencies:[Tv,eo],init(f,d){const m=f().javascript.generate;return function(...A){const p=d();return{textureData:m(...A),timing:d()-p}}},getTransferables(f){return[f.textureData.buffer]}}),requests:0,idleTimer:null}),h.requests++,clearTimeout(h.idleTimer),h.workerModule(r,e,t,i,n,s).then(({textureData:f,timing:d})=>{const m=eo(),A=new Uint8Array(f.length*4);for(let p=0;p<f.length;p++)A[p*4+c]=f[p];return th.webglUtils.renderImageData(o,A,a,l,r,e,1<<3-c),d+=eo()-m,--h.requests===0&&(h.idleTimer=setTimeout(()=>{T5(u)},W5)),{timing:d}})}function X5(r){r._warm||(th.webgl.isSupported(r),r._warm=!0)}const q5=th.webglUtils.resizeWebGLCanvasWithoutClearing,Ko={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048,useWorker:!0},J5=new Ye;function vo(){return(self.performance||Date).now()}const kp=Object.create(null);function Bv(r,e){r=t6({},r);const t=vo(),{defaultFontURL:i}=Ko,n=[];if(i&&n.push({label:"default",src:Op(i)}),r.font&&n.push({label:"user",src:Op(r.font)}),r.font=n,r.text=""+r.text,r.sdfGlyphSize=r.sdfGlyphSize||Ko.sdfGlyphSize,r.unicodeFontsURL=r.unicodeFontsURL||Ko.unicodeFontsURL,r.colorRanges!=null){let d={};for(let m in r.colorRanges)if(r.colorRanges.hasOwnProperty(m)){let A=r.colorRanges[m];typeof A!="number"&&(A=J5.set(A).getHex()),d[m]=A}r.colorRanges=d}Object.freeze(r);const{textureWidth:s,sdfExponent:o}=Ko,{sdfGlyphSize:a}=r,l=s/a*4;let c=kp[a];if(!c){const d=document.createElement("canvas");d.width=s,d.height=a*256/l,c=kp[a]={glyphCount:0,sdfGlyphSize:a,sdfCanvas:d,sdfTexture:new qi(d,void 0,void 0,void 0,Ht,Ht),contextLost:!1,glyphsByFont:new Map},c.sdfTexture.generateMipmaps=!1,Z5(c)}const{sdfTexture:u,sdfCanvas:h}=c;Mv(r).then(d=>{const{glyphIds:m,glyphFontIndices:A,fontData:p,glyphPositions:y,fontSize:E,timings:v}=d,x=[],C=new Float32Array(m.length*4);let I=0,_=0;const S=vo(),b=p.map(D=>{let k=c.glyphsByFont.get(D.src);return k||c.glyphsByFont.set(D.src,k=new Map),k});m.forEach((D,k)=>{const Q=A[k],{src:Y,unitsPerEm:W}=p[Q];let P=b[Q].get(D);if(!P){const{path:G,pathBounds:O}=d.glyphData[Y][D],F=Math.max(O[2]-O[0],O[3]-O[1])/a*(Ko.sdfMargin*a+.5),U=c.glyphCount++,N=[O[0]-F,O[1]-F,O[2]+F,O[3]+F];b[Q].set(D,P={path:G,atlasIndex:U,sdfViewBox:N}),x.push(P)}const{sdfViewBox:K}=P,M=y[_++],V=y[_++],$=E/W;C[I++]=M+K[0]*$,C[I++]=V+K[1]*$,C[I++]=M+K[2]*$,C[I++]=V+K[3]*$,m[k]=P.atlasIndex}),v.quads=(v.quads||0)+(vo()-S);const T=vo();v.sdf={};const R=h.height,w=Math.ceil(c.glyphCount/l),B=Math.pow(2,Math.ceil(Math.log2(w*a)));B>R&&(console.info(`Increasing SDF texture size ${R}->${B}`),q5(h,s,B),u.dispose()),Promise.all(x.map(D=>Rv(D,c,r.gpuAccelerateSDF).then(({timing:k})=>{v.sdf[D.atlasIndex]=k}))).then(()=>{x.length&&!c.contextLost&&(Dv(c),u.needsUpdate=!0),v.sdfTotal=vo()-T,v.total=vo()-t,e(Object.freeze({parameters:r,sdfTexture:u,sdfGlyphSize:a,sdfExponent:o,glyphBounds:C,glyphAtlasIndices:m,glyphColors:d.glyphColors,caretPositions:d.caretPositions,chunkedBounds:d.chunkedBounds,ascender:d.ascender,descender:d.descender,lineHeight:d.lineHeight,capHeight:d.capHeight,xHeight:d.xHeight,topBaseline:d.topBaseline,blockBounds:d.blockBounds,visibleBounds:d.visibleBounds,timings:d.timings}))})}),Promise.resolve().then(()=>{c.contextLost||X5(h)})}function Rv({path:r,atlasIndex:e,sdfViewBox:t},{sdfGlyphSize:i,sdfCanvas:n,contextLost:s},o){if(s)return Promise.resolve({timing:-1});const{textureWidth:a,sdfExponent:l}=Ko,c=Math.max(t[2]-t[0],t[3]-t[1]),u=Math.floor(e/4),h=u%(a/i)*i,f=Math.floor(u/(a/i))*i,d=e%4;return V5(i,i,r,t,c,l,n,h,f,d,o)}function Z5(r){const e=r.sdfCanvas;e.addEventListener("webglcontextlost",t=>{console.log("Context Lost",t),t.preventDefault(),r.contextLost=!0}),e.addEventListener("webglcontextrestored",t=>{console.log("Context Restored",t),r.contextLost=!1;const i=[];r.glyphsByFont.forEach(n=>{n.forEach(s=>{i.push(Rv(s,r,!0))})}),Promise.all(i).then(()=>{Dv(r),r.sdfTexture.needsUpdate=!0})})}function e6({font:r,characters:e,sdfGlyphSize:t},i){let n=Array.isArray(e)?e.join(`
`):""+e;Bv({font:r,sdfGlyphSize:t,text:n},i)}function t6(r,e){for(let t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}let pc;function Op(r){return pc||(pc=typeof document>"u"?{}:document.createElement("a")),pc.href=r,pc.href}function Dv(r){if(typeof createImageBitmap!="function"){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:e,sdfTexture:t}=r,{width:i,height:n}=e,s=r.sdfCanvas.getContext("webgl");let o=t.image.data;(!o||o.length!==i*n*4)&&(o=new Uint8Array(i*n*4),t.image={width:i,height:n,data:o},t.flipY=!1,t.isDataTexture=!0),s.readPixels(0,0,i,n,s.RGBA,s.UNSIGNED_BYTE,o)}}const i6=ga({name:"Typesetter",dependencies:[H5,z5,w5],init(r,e,t){return r(e,t())}}),Mv=ga({name:"Typesetter",dependencies:[i6],init(r){return function(e){return new Promise(t=>{r.typeset(e,t)})}},getTransferables(r){const e=[];for(let t in r)r[t]&&r[t].buffer&&e.push(r[t].buffer);return e}});Mv.onMainThread;const Up={};function n6(r){let e=Up[r];return e||(e=Up[r]=new nn(1,1,r,r).translate(.5,.5,0)),e}const s6="aTroikaGlyphBounds",Np="aTroikaGlyphIndex",r6="aTroikaGlyphColor";class o6 extends B0{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new on,this.boundingBox=new Yt}computeBoundingSphere(){}computeBoundingBox(){}set detail(e){if(e!==this._detail){this._detail=e,(typeof e!="number"||e<1)&&(e=1);let t=n6(e);["position","normal","uv"].forEach(i=>{this.attributes[i]=t.attributes[i].clone()}),this.setIndex(t.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,t,i,n,s){this.updateAttributeData(s6,e,4),this.updateAttributeData(Np,t,1),this.updateAttributeData(r6,s,3),this._blockBounds=i,this._chunkedBounds=n,this.instanceCount=t.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:t,boundingBox:i}=this;if(t){const{PI:n,floor:s,min:o,max:a,sin:l,cos:c}=Math,u=n/2,h=n*2,f=Math.abs(t),d=e[0]/f,m=e[2]/f,A=s((d+u)/h)!==s((m+u)/h)?-f:o(l(d)*f,l(m)*f),p=s((d-u)/h)!==s((m-u)/h)?f:a(l(d)*f,l(m)*f),y=s((d+n)/h)!==s((m+n)/h)?f*2:a(f-c(d)*f,f-c(m)*f);i.min.set(A,e[1],t<0?-y:0),i.max.set(p,e[3],t<0?0:y)}else i.min.set(e[0],e[1],0),i.max.set(e[2],e[3],0);i.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let t=this.getAttribute(Np).count,i=this._chunkedBounds;if(i)for(let n=i.length;n--;){t=i[n].end;let s=i[n].rect;if(s[1]<e.w&&s[3]>e.y&&s[0]<e.z&&s[2]>e.x)break}this.instanceCount=t}updateAttributeData(e,t,i){const n=this.getAttribute(e);t?n&&n.array.length===t.length?(n.array.set(t),n.needsUpdate=!0):(this.setAttribute(e,new wl(t,i)),delete this._maxInstanceCount,this.dispose()):n&&this.deleteAttribute(e)}}const a6=`
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform vec4 uTroikaTotalBounds;
uniform vec4 uTroikaClipRect;
uniform mat3 uTroikaOrient;
uniform bool uTroikaUseGlyphColors;
uniform float uTroikaEdgeOffset;
uniform float uTroikaBlurRadius;
uniform vec2 uTroikaPositionOffset;
uniform float uTroikaCurveRadius;
attribute vec4 aTroikaGlyphBounds;
attribute float aTroikaGlyphIndex;
attribute vec3 aTroikaGlyphColor;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec3 vTroikaGlyphColor;
varying vec2 vTroikaGlyphDimensions;
`,l6=`
vec4 bounds = aTroikaGlyphBounds;
bounds.xz += uTroikaPositionOffset.x;
bounds.yw -= uTroikaPositionOffset.y;

vec4 outlineBounds = vec4(
  bounds.xy - uTroikaEdgeOffset - uTroikaBlurRadius,
  bounds.zw + uTroikaEdgeOffset + uTroikaBlurRadius
);
vec4 clippedBounds = vec4(
  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),
  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)
);

vec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);

position.xy = mix(bounds.xy, bounds.zw, clippedXY);

uv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);

float rad = uTroikaCurveRadius;
if (rad != 0.0) {
  float angle = position.x / rad;
  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);
  normal.xz = vec2(sin(angle), cos(angle));
}
  
position = uTroikaOrient * position;
normal = uTroikaOrient * normal;

vTroikaGlyphUV = clippedXY.xy;
vTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);


float txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;
vec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;
vec2 txStartUV = txUvPerSquare * vec2(
  mod(floor(aTroikaGlyphIndex / 4.0), txCols),
  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)
);
vTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);
vTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);
`,c6=`
uniform sampler2D uTroikaSDFTexture;
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform float uTroikaSDFExponent;
uniform float uTroikaEdgeOffset;
uniform float uTroikaFillOpacity;
uniform float uTroikaBlurRadius;
uniform vec3 uTroikaStrokeColor;
uniform float uTroikaStrokeWidth;
uniform float uTroikaStrokeOpacity;
uniform bool uTroikaSDFDebug;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec2 vTroikaGlyphDimensions;

float troikaSdfValueToSignedDistance(float alpha) {
  // Inverse of exponential encoding in webgl-sdf-generator
  
  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);
  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;
  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);
  return signedDist;
}

float troikaGlyphUvToSdfValue(vec2 glyphUV) {
  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);
  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);
  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1
  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;
}

float troikaGlyphUvToDistance(vec2 uv) {
  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));
}

float troikaGetAADist() {
  
  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300
  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;
  #else
  return vTroikaGlyphDimensions.x / 64.0;
  #endif
}

float troikaGetFragDistValue() {
  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);
  float distance = troikaGlyphUvToDistance(clampedGlyphUV);
 
  // Extrapolate distance when outside bounds:
  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : 
    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);

  

  return distance;
}

float troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {
  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)
  float alpha = step(-distanceOffset, -distance);
  #else

  float alpha = smoothstep(
    distanceOffset + aaDist,
    distanceOffset - aaDist,
    distance
  );
  #endif

  return alpha;
}
`,u6=`
float aaDist = troikaGetAADist();
float fragDistance = troikaGetFragDistValue();
float edgeAlpha = uTroikaSDFDebug ?
  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :
  troikaGetEdgeAlpha(fragDistance, uTroikaEdgeOffset, max(aaDist, uTroikaBlurRadius));

#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)
vec4 fillRGBA = gl_FragColor;
fillRGBA.a *= uTroikaFillOpacity;
vec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);
if (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;
gl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(
  -uTroikaStrokeWidth - aaDist,
  -uTroikaStrokeWidth + aaDist,
  fragDistance
));
gl_FragColor.a *= edgeAlpha;
#endif

if (edgeAlpha == 0.0) {
  discard;
}
`;function h6(r){const e=Kd(r,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new De},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new Ci(0,0,0,0)},uTroikaClipRect:{value:new Ci(0,0,0,0)},uTroikaEdgeOffset:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new De},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new Ye},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new bn},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:a6,vertexTransform:l6,fragmentDefs:c6,fragmentColorTransform:u6,customRewriter({vertexShader:t,fragmentShader:i}){let n=/\buniform\s+vec3\s+diffuse\b/;return n.test(i)&&(i=i.replace(n,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),n.test(t)||(t=t.replace(bv,`uniform vec3 diffuse;
$&
vTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;
`))),{vertexShader:t,fragmentShader:i}}});return e.transparent=!0,e.forceSinglePass=!0,Object.defineProperties(e,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),e}const H0=new ds({color:16777215,side:xi,transparent:!0}),Gp=8421504,Qp=new we,gc=new z,of=new z,Ka=[],f6=new z,af="+x+y";function zp(r){return Array.isArray(r)?r[0]:r}let Lv=()=>{const r=new Qe(new nn(1,1),H0);return Lv=()=>r,r},Pv=()=>{const r=new Qe(new nn(1,1,32,1),H0);return Pv=()=>r,r};const d6={type:"syncstart"},m6={type:"synccomplete"},Fv=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],A6=Fv.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");let kv=class extends Qe{constructor(){const e=new o6;super(e,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=Gp,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=af,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(d6),Bv({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},t=>{this._isSyncing=!1,this._textRenderInfo=t,this.geometry.updateGlyphs(t.glyphBounds,t.glyphAtlasIndices,t.blockBounds,t.chunkedBounds,t.glyphColors);const i=this._queuedSyncs;i&&(this._queuedSyncs=null,this._needsSync=!0,this.sync(()=>{i.forEach(n=>n&&n())})),this.dispatchEvent(m6),e&&e()})))}onBeforeRender(e,t,i,n,s,o){this.sync(),s.isTroikaTextMaterial&&this._prepareForRender(s)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}createDerivedMaterial(e){return h6(e)}get material(){let e=this._derivedMaterial;const t=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=H0.clone());if((!e||!e.isDerivedFrom(t))&&(e=this._derivedMaterial=this.createDerivedMaterial(t),t.addEventListener("dispose",function i(){t.removeEventListener("dispose",i),e.dispose()})),this.hasOutline()){let i=e._outlineMtl;return i||(i=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),i.isTextOutlineMaterial=!0,i.depthWrite=!1,i.map=null,e.addEventListener("dispose",function n(){e.removeEventListener("dispose",n),i.dispose()})),[i,e]}else return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}hasOutline(){return!!(this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY)}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return zp(this.material).getDepthMaterial()}set customDepthMaterial(e){}get customDistanceMaterial(){return zp(this.material).getDistanceMaterial()}set customDistanceMaterial(e){}_prepareForRender(e){const t=e.isTextOutlineMaterial,i=e.uniforms,n=this.textRenderInfo;if(n){const{sdfTexture:a,blockBounds:l}=n;i.uTroikaSDFTexture.value=a,i.uTroikaSDFTextureSize.value.set(a.image.width,a.image.height),i.uTroikaSDFGlyphSize.value=n.sdfGlyphSize,i.uTroikaSDFExponent.value=n.sdfExponent,i.uTroikaTotalBounds.value.fromArray(l),i.uTroikaUseGlyphColors.value=!t&&!!n.glyphColors;let c=0,u=0,h=0,f,d,m,A=0,p=0;if(t){let{outlineWidth:E,outlineOffsetX:v,outlineOffsetY:x,outlineBlur:C,outlineOpacity:I}=this;c=this._parsePercent(E)||0,u=Math.max(0,this._parsePercent(C)||0),f=I,A=this._parsePercent(v)||0,p=this._parsePercent(x)||0}else h=Math.max(0,this._parsePercent(this.strokeWidth)||0),h&&(m=this.strokeColor,i.uTroikaStrokeColor.value.set(m??Gp),d=this.strokeOpacity,d==null&&(d=1)),f=this.fillOpacity;i.uTroikaEdgeOffset.value=c,i.uTroikaPositionOffset.value.set(A,p),i.uTroikaBlurRadius.value=u,i.uTroikaStrokeWidth.value=h,i.uTroikaStrokeOpacity.value=d,i.uTroikaFillOpacity.value=f??1,i.uTroikaCurveRadius.value=this.curveRadius||0;let y=this.clipRect;if(y&&Array.isArray(y)&&y.length===4)i.uTroikaClipRect.value.fromArray(y);else{const E=(this.fontSize||.1)*100;i.uTroikaClipRect.value.set(l[0]-E,l[1]-E,l[2]+E,l[3]+E)}this.geometry.applyClipRect(i.uTroikaClipRect.value)}i.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const s=t?this.outlineColor||0:this.color;if(s==null)delete e.color;else{const a=e.hasOwnProperty("color")?e.color:e.color=new Ye;(s!==a._input||typeof s=="object")&&a.set(a._input=s)}let o=this.orientation||af;if(o!==e._orientation){let a=i.uTroikaOrient.value;o=o.replace(/[^-+xyz]/g,"");let l=o!==af&&o.match(/^([-+])([xyz])([-+])([xyz])$/);if(l){let[,c,u,h,f]=l;gc.set(0,0,0)[u]=c==="-"?1:-1,of.set(0,0,0)[f]=h==="-"?-1:1,Qp.lookAt(f6,gc.cross(of),of),a.setFromMatrix4(Qp)}else a.identity();e._orientation=o}}_parsePercent(e){if(typeof e=="string"){let t=e.match(/^(-?[\d.]+)%$/),i=t?parseFloat(t[1]):NaN;e=(isNaN(i)?0:i/100)*this.fontSize}return e}localPositionToTextCoords(e,t=new De){t.copy(e);const i=this.curveRadius;return i&&(t.x=Math.atan2(e.x,Math.abs(i)-Math.abs(e.z))*Math.abs(i)),t}worldPositionToTextCoords(e,t=new De){return gc.copy(e),this.localPositionToTextCoords(this.worldToLocal(gc),t)}raycast(e,t){const{textRenderInfo:i,curveRadius:n}=this;if(i){const s=i.blockBounds,o=n?Pv():Lv(),a=o.geometry,{position:l,uv:c}=a.attributes;for(let u=0;u<c.count;u++){let h=s[0]+c.getX(u)*(s[2]-s[0]);const f=s[1]+c.getY(u)*(s[3]-s[1]);let d=0;n&&(d=n-Math.cos(h/n)*n,h=Math.sin(h/n)*n),l.setXYZ(u,h,f,d)}a.boundingSphere=this.geometry.boundingSphere,a.boundingBox=this.geometry.boundingBox,o.matrixWorld=this.matrixWorld,o.material.side=this.material.side,Ka.length=0,o.raycast(e,Ka);for(let u=0;u<Ka.length;u++)Ka[u].object=this,t.push(Ka[u])}}copy(e){const t=this.geometry;return super.copy(e),this.geometry=t,A6.forEach(i=>{this[i]=e[i]}),this}clone(){return new this.constructor().copy(this)}};Fv.forEach(r=>{const e="_private_"+r;Object.defineProperty(kv.prototype,r,{get(){return this[e]},set(t){t!==this[e]&&(this[e]=t,this._needsSync=!0)}})});new Yt;new Ye;const TL=g.forwardRef(({sdfGlyphSize:r=64,anchorX:e="center",anchorY:t="middle",font:i,fontSize:n=1,children:s,characters:o,onSync:a,...l},c)=>{const u=le(({invalidate:m})=>m),[h]=g.useState(()=>new kv),[f,d]=g.useMemo(()=>{const m=[];let A="";return g.Children.forEach(s,p=>{typeof p=="string"||typeof p=="number"?A+=p:m.push(p)}),[m,A]},[s]);return ar(()=>new Promise(m=>e6({font:i,characters:o},m)),["troika-text",i,o]),g.useLayoutEffect(()=>void h.sync(()=>{u(),a&&a(h)})),g.useEffect(()=>()=>h.dispose(),[h]),g.createElement("primitive",Ae({object:h,ref:c,font:i,text:d,anchorX:e,anchorY:t,fontSize:n,sdfGlyphSize:r},l),f)});let lf=null;async function p6(r){return typeof r=="string"?await(await fetch(r)).json():r}function g6(r){return lf||(lf=new MT),lf.parse(r)}async function Ov(r){const e=await p6(r);return g6(e)}function V0(r){return ar(Ov,[r])}V0.preload=r=>oC(Ov,[r]);V0.clear=r=>Wu([r]);const y6=["string","number"],v6=r=>{let e="";const t=[];return g.Children.forEach(r,i=>{y6.includes(typeof i)?e+=i+"":t.push(i)}),[e,...t]},E6=g.forwardRef(({font:r,letterSpacing:e=0,lineHeight:t=1,size:i=1,height:n=.2,bevelThickness:s=.1,bevelSize:o=.01,bevelEnabled:a=!1,bevelOffset:l=0,bevelSegments:c=4,curveSegments:u=8,smooth:h,children:f,...d},m)=>{g.useMemo(()=>Ii({RenamedTextGeometry:oT}),[]);const A=g.useRef(null),p=V0(r),y=g.useMemo(()=>({font:p,size:i,height:n,bevelThickness:s,bevelSize:o,bevelEnabled:a,bevelSegments:c,bevelOffset:l,curveSegments:u,letterSpacing:e,lineHeight:t}),[p,i,n,s,o,a,c,l,u,e,t]),[E,...v]=g.useMemo(()=>v6(f),[f]),x=g.useMemo(()=>[E,y],[E,y]);return g.useLayoutEffect(()=>{h&&(A.current.geometry=s_(A.current.geometry,h),A.current.geometry.computeVertexNormals())},[x,h]),g.useImperativeHandle(m,()=>A.current,[]),g.createElement("mesh",Ae({},d,{ref:A}),g.createElement("renamedTextGeometry",{args:x}),v)}),bL=()=>{try{var r=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&r.getContext("webgl2"))}catch{return!1}},wL=g.forwardRef(({children:r,multisamping:e=8,renderIndex:t=1,disableRender:i,disableGamma:n,disableRenderPass:s,depthBuffer:o=!0,stencilBuffer:a=!1,anisotropy:l=1,colorSpace:c,type:u,...h},f)=>{g.useMemo(()=>Ii({EffectComposer:ES,RenderPass:IS,ShaderPass:Ud}),[]);const d=g.useRef(null);g.useImperativeHandle(f,()=>d.current,[]);const{scene:m,camera:A,gl:p,size:y,viewport:E}=le(),[v]=g.useState(()=>{const C=new Ti(y.width,y.height,{type:u||fi,format:wi,depthBuffer:o,stencilBuffer:a,anisotropy:l});return u===Hi&&c!=null&&(C.texture.colorSpace=c),C.samples=e,C});g.useEffect(()=>{var C,I;(C=d.current)==null||C.setSize(y.width,y.height),(I=d.current)==null||I.setPixelRatio(E.dpr)},[p,y,E.dpr]),He(()=>{var C;i||(C=d.current)==null||C.render()},t);const x=[];return s||x.push(g.createElement("renderPass",{key:"renderpass",attach:`passes-${x.length}`,args:[m,A]})),n||x.push(g.createElement("shaderPass",{attach:`passes-${x.length}`,key:"gammapass",args:[aT]})),g.Children.forEach(r,C=>{C&&x.push(g.cloneElement(C,{key:x.length,attach:`passes-${x.length}`}))}),g.createElement("effectComposer",Ae({ref:d,args:[p,v]},h),x)});let Hp=function(r){return r.Linear="linear",r.Radial="radial",r}({});function BL({stops:r,colors:e,size:t=1024,width:i=16,type:n=Hp.Linear,innerCircleRadius:s=0,outerCircleRadius:o="auto",...a}){const l=le(u=>u.gl),c=g.useMemo(()=>{const u=document.createElement("canvas"),h=u.getContext("2d");u.width=i,u.height=t;let f;if(n===Hp.Linear)f=h.createLinearGradient(0,0,0,t);else{const A=u.width/2,p=u.height/2,y=o!=="auto"?Math.abs(Number(o)):Math.sqrt(A**2+p**2);f=h.createRadialGradient(A,p,Math.abs(s),A,p,y)}const d=new Ye;let m=r.length;for(;m--;)f.addColorStop(r[m],d.set(e[m]).getStyle());return h.save(),h.fillStyle=f,h.fillRect(0,0,i,t),h.restore(),u},[r]);return g.createElement("canvasTexture",Ae({colorSpace:l.outputColorSpace,args:[c],attach:"map"},a))}function ps(r,e,t,i){var n;return n=class extends gi{constructor(s){super({vertexShader:e,fragmentShader:t,...s});for(const o in r)this.uniforms[o]=new mn(r[o]),Object.defineProperty(this,o,{get(){return this.uniforms[o].value},set(a){this.uniforms[o].value=a}});this.uniforms=la.clone(this.uniforms),i==null||i(this)}},n.key=et.generateUUID(),n}const xl=r=>r===Object(r)&&!Array.isArray(r)&&typeof r!="function";function ao(r,e){const t=le(s=>s.gl),i=oi(nr,xl(r)?Object.values(r):r);return g.useLayoutEffect(()=>{e==null||e(i)},[e]),g.useEffect(()=>{if("initTexture"in t){let s=[];Array.isArray(i)?s=i:i instanceof qi?s=[i]:xl(i)&&(s=Object.values(i)),s.forEach(o=>{o instanceof qi&&t.initTexture(o)})}},[t,i]),g.useMemo(()=>{if(xl(r)){const s={};let o=0;for(const a in r)s[a]=i[o++];return s}else return i},[r,i])}ao.preload=r=>oi.preload(nr,r);ao.clear=r=>oi.clear(nr,r);const RL=({children:r,input:e,onLoad:t})=>{const i=ao(e,t);return g.createElement(g.Fragment,null,r==null?void 0:r(i))},x6=()=>parseInt(Ul.replace(/\D+/g,"")),Zi=x6(),Vp=ps({color:new Ye("white"),scale:new De(1,1),imageBounds:new De(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},`
  varying vec2 vUv;
  varying vec2 vPos;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
    vPos = position.xy;
  }
`,`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  varying vec2 vPos;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform float resolution;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float radius;
  uniform float zoom;
  uniform float grayscale;
  uniform float opacity;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  
  const float PI = 3.14159265;
    
  // from https://iquilezles.org/articles/distfunctions
  float udRoundBox( vec2 p, vec2 b, float r ) {
    return length(max(abs(p)-b+r,0.0))-r;
  }

  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);

    vec2 res = vec2(scale * resolution);
    vec2 halfRes = 0.5 * res;
    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    
	  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);
    
    #include <tonemapping_fragment>
    #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
  }
`),Uv=g.forwardRef(({children:r,color:e,segments:t=1,scale:i=1,zoom:n=1,grayscale:s=0,opacity:o=1,radius:a=0,texture:l,toneMapped:c,transparent:u,side:h,...f},d)=>{Ii({ImageMaterial:Vp});const m=g.useRef(null),A=le(v=>v.size),p=Array.isArray(i)?[i[0],i[1]]:[i,i],y=[l.image.width,l.image.height],E=Math.max(A.width,A.height);return g.useImperativeHandle(d,()=>m.current,[]),g.useLayoutEffect(()=>{m.current.geometry.parameters&&m.current.material.scale.set(p[0]*m.current.geometry.parameters.width,p[1]*m.current.geometry.parameters.height)},[p[0],p[1]]),g.createElement("mesh",Ae({ref:m,scale:Array.isArray(i)?[...i,1]:i},f),g.createElement("planeGeometry",{args:[1,1,t,t]}),g.createElement("imageMaterial",{color:e,map:l,zoom:n,grayscale:s,opacity:o,scale:p,imageBounds:y,resolution:E,radius:a,toneMapped:c,transparent:u,side:h,key:Vp.key}),r)}),C6=g.forwardRef(({url:r,...e},t)=>{const i=ao(r);return g.createElement(Uv,Ae({},e,{texture:i,ref:t}))}),I6=g.forwardRef(({url:r,...e},t)=>g.createElement(Uv,Ae({},e,{ref:t}))),DL=g.forwardRef((r,e)=>{if(r.url)return g.createElement(C6,Ae({},r,{ref:e}));if(r.texture)return g.createElement(I6,Ae({},r,{ref:e}));throw new Error("<Image /> requires a url or texture")}),_6=g.forwardRef(({threshold:r=15,geometry:e,...t},i)=>{const n=g.useRef(null);g.useImperativeHandle(i,()=>n.current,[]);const s=g.useMemo(()=>[0,0,0,1,0,0],[]),o=g.useRef(null),a=g.useRef(null);return g.useLayoutEffect(()=>{const l=n.current.parent,c=e??(l==null?void 0:l.geometry);if(!c||o.current===c&&a.current===r)return;o.current=c,a.current=r;const h=new aC(c,r).attributes.position.array;n.current.geometry.setPositions(h),n.current.geometry.attributes.instanceStart.needsUpdate=!0,n.current.geometry.attributes.instanceEnd.needsUpdate=!0,n.current.computeLineDistances()}),g.createElement(Fs,Ae({segments:!0,points:s,ref:n,raycast:()=>null},t))}),Kp=ps({screenspace:!1,color:new Ye("black"),opacity:1,thickness:.05,size:new De},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   #include <clipping_planes_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     #include <clipping_planes_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   #include <clipping_planes_pars_fragment>
   void main(){
     #include <clipping_planes_fragment>
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function ML({color:r="black",opacity:e=1,transparent:t=!1,screenspace:i=!1,toneMapped:n=!0,polygonOffset:s=!1,polygonOffsetFactor:o=0,renderOrder:a=0,thickness:l=.05,angle:c=Math.PI,clippingPlanes:u,...h}){const f=g.useRef(null),[d]=g.useState(()=>new Kp({side:ma})),{gl:m}=le(),A=m.getDrawingBufferSize(new De);g.useMemo(()=>Ii({OutlinesMaterial:Kp}),[]);const p=g.useRef(0),y=g.useRef(null);return g.useLayoutEffect(()=>{const E=f.current;if(!E)return;const v=E.parent;if(v&&v.geometry&&(p.current!==c||y.current!==v.geometry)){var x;p.current=c,y.current=v.geometry;let C=(x=E.children)==null?void 0:x[0];C&&(c&&C.geometry.dispose(),E.remove(C)),v.skeleton?(C=new b0,C.material=d,C.bind(v.skeleton,v.bindMatrix),E.add(C)):v.isInstancedMesh?(C=new _0(v.geometry,d,v.count),C.instanceMatrix=v.instanceMatrix,E.add(C)):(C=new Qe,C.material=d,E.add(C)),C.geometry=c?O2(v.geometry,c):v.geometry,C.morphTargetInfluences=v.morphTargetInfluences,C.morphTargetDictionary=v.morphTargetDictionary}}),g.useLayoutEffect(()=>{const E=f.current;if(!E)return;const v=E.children[0];if(v){v.renderOrder=a;const x=E.parent;Wn(v,{morphTargetInfluences:x.morphTargetInfluences,morphTargetDictionary:x.morphTargetDictionary}),Wn(v.material,{transparent:t,thickness:l,color:r,opacity:e,size:A,screenspace:i,toneMapped:n,polygonOffset:s,polygonOffsetFactor:o,clippingPlanes:u,clipping:u&&u.length>0})}}),g.useEffect(()=>()=>{const E=f.current;if(!E)return;const v=E.children[0];v&&(c&&v.geometry.dispose(),E.remove(v))},[]),g.createElement("group",Ae({ref:f},h))}var S6=Object.defineProperty,T6=(r,e,t)=>e in r?S6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Pt=(r,e,t)=>(T6(r,typeof e!="symbol"?e+"":e,t),t);function cf(r,e,t,i,n){let s;if(r=r.subarray||r.slice?r:r.buffer,t=t.subarray||t.slice?t:t.buffer,r=e?r.subarray?r.subarray(e,n&&e+n):r.slice(e,n&&e+n):r,t.set)t.set(r,i);else for(s=0;s<r.length;s++)t[s+i]=r[s];return t}function b6(r){return r instanceof Float32Array?r:r instanceof ki?r.getAttribute("position").array:r.map(e=>{const t=Array.isArray(e);return e instanceof z?[e.x,e.y,e.z]:e instanceof De?[e.x,e.y,0]:t&&e.length===3?[e[0],e[1],e[2]]:t&&e.length===2?[e[0],e[1],0]:e}).flat()}class w6 extends ki{constructor(){super(),Pt(this,"type","MeshLine"),Pt(this,"isMeshLine",!0),Pt(this,"positions",[]),Pt(this,"previous",[]),Pt(this,"next",[]),Pt(this,"side",[]),Pt(this,"width",[]),Pt(this,"indices_array",[]),Pt(this,"uvs",[]),Pt(this,"counters",[]),Pt(this,"widthCallback",null),Pt(this,"_attributes"),Pt(this,"_points",[]),Pt(this,"points"),Pt(this,"matrixWorld",new we),Object.defineProperties(this,{points:{enumerable:!0,get(){return this._points},set(e){this.setPoints(e,this.widthCallback)}}})}setMatrixWorld(e){this.matrixWorld=e}setPoints(e,t){if(e=b6(e),this._points=e,this.widthCallback=t??null,this.positions=[],this.counters=[],e.length&&e[0]instanceof z)for(let i=0;i<e.length;i++){const n=e[i],s=i/(e.length-1);this.positions.push(n.x,n.y,n.z),this.positions.push(n.x,n.y,n.z),this.counters.push(s),this.counters.push(s)}else for(let i=0;i<e.length;i+=3){const n=i/(e.length-1);this.positions.push(e[i],e[i+1],e[i+2]),this.positions.push(e[i],e[i+1],e[i+2]),this.counters.push(n),this.counters.push(n)}this.process()}compareV3(e,t){const i=e*6,n=t*6;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]}copyV3(e){const t=e*6;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}process(){const e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];let t,i;this.compareV3(0,e-1)?i=this.copyV3(e-2):i=this.copyV3(0),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);for(let n=0;n<e;n++){if(this.side.push(1),this.side.push(-1),this.widthCallback?t=this.widthCallback(n/(e-1)):t=1,this.width.push(t),this.width.push(t),this.uvs.push(n/(e-1),0),this.uvs.push(n/(e-1),1),n<e-1){i=this.copyV3(n),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);const s=n*2;this.indices_array.push(s,s+1,s+2),this.indices_array.push(s+2,s+1,s+3)}n>0&&(i=this.copyV3(n),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]))}this.compareV3(e-1,0)?i=this.copyV3(1):i=this.copyV3(e-1),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]),!this._attributes||this._attributes.position.count!==this.counters.length?this._attributes={position:new Nt(new Float32Array(this.positions),3),previous:new Nt(new Float32Array(this.previous),3),next:new Nt(new Float32Array(this.next),3),side:new Nt(new Float32Array(this.side),1),width:new Nt(new Float32Array(this.width),1),uv:new Nt(new Float32Array(this.uvs),2),index:new Nt(new Uint16Array(this.indices_array),1),counters:new Nt(new Float32Array(this.counters),1)}:(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}advance({x:e,y:t,z:i}){const n=this._attributes.position.array,s=this._attributes.previous.array,o=this._attributes.next.array,a=n.length;cf(n,0,s,0,a),cf(n,6,n,0,a-6),n[a-6]=e,n[a-5]=t,n[a-4]=i,n[a-3]=e,n[a-2]=t,n[a-1]=i,cf(n,6,o,0,a-6),o[a-6]=e,o[a-5]=t,o[a-4]=i,o[a-3]=e,o[a-2]=t,o[a-1]=i,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}const B6=`
  #include <common>
  #include <logdepthbuf_pars_vertex>
  #include <fog_pars_vertex>
  #include <clipping_planes_pars_vertex>

  attribute vec3 previous;
  attribute vec3 next;
  attribute float side;
  attribute float width;
  attribute float counters;
  
  uniform vec2 resolution;
  uniform float lineWidth;
  uniform vec3 color;
  uniform float opacity;
  uniform float sizeAttenuation;
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  vec2 fix(vec4 i, float aspect) {
    vec2 res = i.xy / i.w;
    res.x *= aspect;
    return res;
  }
  
  void main() {
    float aspect = resolution.x / resolution.y;
    vColor = vec4(color, opacity);
    vUV = uv;
    vCounters = counters;
  
    mat4 m = projectionMatrix * modelViewMatrix;
    vec4 finalPosition = m * vec4(position, 1.0) * aspect;
    vec4 prevPos = m * vec4(previous, 1.0);
    vec4 nextPos = m * vec4(next, 1.0);
  
    vec2 currentP = fix(finalPosition, aspect);
    vec2 prevP = fix(prevPos, aspect);
    vec2 nextP = fix(nextPos, aspect);
  
    float w = lineWidth * width;
  
    vec2 dir;
    if (nextP == currentP) dir = normalize(currentP - prevP);
    else if (prevP == currentP) dir = normalize(nextP - currentP);
    else {
      vec2 dir1 = normalize(currentP - prevP);
      vec2 dir2 = normalize(nextP - currentP);
      dir = normalize(dir1 + dir2);
  
      vec2 perp = vec2(-dir1.y, dir1.x);
      vec2 miter = vec2(-dir.y, dir.x);
      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);
    }
  
    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;
    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);
    normal.xy *= .5 * w;
    //normal *= projectionMatrix;
    if (sizeAttenuation == 0.) {
      normal.xy *= finalPosition.w;
      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy * aspect;
    }
  
    finalPosition.xy += normal.xy * side;
    gl_Position = finalPosition;
    #include <logdepthbuf_vertex>
    #include <fog_vertex>
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    #include <clipping_planes_vertex>
    #include <fog_vertex>
  }
`,R6=(()=>parseInt(Ul.replace(/\D+/g,"")))(),D6=R6>=154?"colorspace_fragment":"encodings_fragment",M6=`
  #include <fog_pars_fragment>
  #include <logdepthbuf_pars_fragment>
  #include <clipping_planes_pars_fragment>
  
  uniform sampler2D map;
  uniform sampler2D alphaMap;
  uniform float useGradient;
  uniform float useMap;
  uniform float useAlphaMap;
  uniform float useDash;
  uniform float dashArray;
  uniform float dashOffset;
  uniform float dashRatio;
  uniform float visibility;
  uniform float alphaTest;
  uniform vec2 repeat;
  uniform vec3 gradient[2];
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  void main() {
    #include <logdepthbuf_fragment>
    vec4 diffuseColor = vColor;
    if (useGradient == 1.) diffuseColor = vec4(mix(gradient[0], gradient[1], vCounters), 1.0);
    if (useMap == 1.) diffuseColor *= texture2D(map, vUV * repeat);
    if (useAlphaMap == 1.) diffuseColor.a *= texture2D(alphaMap, vUV * repeat).a;
    if (diffuseColor.a < alphaTest) discard;
    if (useDash == 1.) diffuseColor.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));
    diffuseColor.a *= step(vCounters, visibility);
    #include <clipping_planes_fragment>
    gl_FragColor = diffuseColor;     
    #include <fog_fragment>
    #include <tonemapping_fragment>
    #include <${D6}>
  }
`;class L6 extends gi{constructor(e){super({uniforms:{...bd.fog,lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new Ye(16777215)},gradient:{value:[new Ye(16711680),new Ye(65280)]},opacity:{value:1},resolution:{value:new De(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},useGradient:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new De(1,1)}},vertexShader:B6,fragmentShader:M6}),Pt(this,"lineWidth"),Pt(this,"map"),Pt(this,"useMap"),Pt(this,"alphaMap"),Pt(this,"useAlphaMap"),Pt(this,"color"),Pt(this,"gradient"),Pt(this,"resolution"),Pt(this,"sizeAttenuation"),Pt(this,"dashArray"),Pt(this,"dashOffset"),Pt(this,"dashRatio"),Pt(this,"useDash"),Pt(this,"useGradient"),Pt(this,"visibility"),Pt(this,"repeat"),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get(){return this.uniforms.lineWidth.value},set(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get(){return this.uniforms.map.value},set(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get(){return this.uniforms.useMap.value},set(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get(){return this.uniforms.alphaMap.value},set(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get(){return this.uniforms.useAlphaMap.value},set(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get(){return this.uniforms.color.value},set(t){this.uniforms.color.value=t}},gradient:{enumerable:!0,get(){return this.uniforms.gradient.value},set(t){this.uniforms.gradient.value=t}},opacity:{enumerable:!0,get(){return this.uniforms.opacity.value},set(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get(){return this.uniforms.resolution.value},set(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get(){return this.uniforms.sizeAttenuation.value},set(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get(){return this.uniforms.dashArray.value},set(t){this.uniforms.dashArray.value=t,this.useDash=t!==0?1:0}},dashOffset:{enumerable:!0,get(){return this.uniforms.dashOffset.value},set(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get(){return this.uniforms.dashRatio.value},set(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get(){return this.uniforms.useDash.value},set(t){this.uniforms.useDash.value=t}},useGradient:{enumerable:!0,get(){return this.uniforms.useGradient.value},set(t){this.uniforms.useGradient.value=t}},visibility:{enumerable:!0,get(){return this.uniforms.visibility.value},set(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get(){return this.uniforms.alphaTest.value},set(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get(){return this.uniforms.repeat.value},set(t){this.uniforms.repeat.value.copy(t)}}}),this.setValues(e)}copy(e){return super.copy(e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.gradient=e.gradient,this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.useGradient=e.useGradient,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}const Nv={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},P6=(r,e=1)=>(r.set(r.subarray(e)),r.fill(-1/0,-e),r);function F6(r,e){const{length:t,local:i,decay:n,interval:s,stride:o}={...Nv,...e},a=g.useRef(null),[l]=g.useState(()=>new z);g.useLayoutEffect(()=>{r&&(a.current=Float32Array.from({length:t*10*3},(h,f)=>r.position.getComponent(f%3)))},[t,r]);const c=g.useRef(new z),u=g.useRef(0);return He(()=>{if(r&&a.current){if(u.current===0){let h;i?h=r.position:(r.getWorldPosition(l),h=l);const f=1*n;for(let d=0;d<f;d++)h.distanceTo(c.current)<o||(P6(a.current,3),a.current.set(h.toArray(),a.current.length-3));c.current.copy(h)}u.current++,u.current=u.current%s}}),a}const LL=g.forwardRef((r,e)=>{const{children:t}=r,{width:i,length:n,decay:s,local:o,stride:a,interval:l}={...Nv,...r},{color:c="hotpink",attenuation:u,target:h}=r,f=le(x=>x.size),d=le(x=>x.scene),m=g.useRef(null),[A,p]=g.useState(null),y=F6(A,{length:n,decay:s,local:o,stride:a,interval:l});g.useEffect(()=>{const x=(h==null?void 0:h.current)||m.current.children.find(C=>C instanceof mi);x&&p(x)},[y,h]);const E=g.useMemo(()=>new w6,[]),v=g.useMemo(()=>{var x,C;const I=new L6({lineWidth:.1*i,color:c,sizeAttenuation:1,resolution:new De(f.width,f.height)});let _;if(t)if(Array.isArray(t))_=t.find(S=>{const b=S;return typeof b.type=="string"&&b.type==="meshLineMaterial"});else{const S=t;typeof S.type=="string"&&S.type==="meshLineMaterial"&&(_=S)}return typeof((x=_)==null?void 0:x.props)=="object"&&((C=_)==null?void 0:C.props)!==null&&I.setValues(_.props),I},[i,c,f,t]);return g.useEffect(()=>{v.uniforms.resolution.value.set(f.width,f.height)},[f]),He(()=>{y.current&&E.setPoints(y.current,u)}),g.createElement("group",null,so(g.createElement("mesh",{ref:e,geometry:E,material:v}),d),g.createElement("group",{ref:m},t))});function k6(r,e=16,t,i,n){const[s,o]=g.useState(()=>{const a=Array.from({length:e},()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]).flat();return new wl(Float32Array.from(a),16)});return g.useLayoutEffect(()=>{if(typeof r.current>"u")return;const a=new D_(r.current);i&&a.setWeightAttribute(i),a.build();const l=new z,c=new z,u=new Ye,h=new mi;r.current.updateMatrixWorld(!0);for(let f=0;f<e;f++)a.sample(l,c,u),typeof t=="function"?t({dummy:h,sampledMesh:r.current,position:l,normal:c,color:u},f):h.position.copy(l),h.updateMatrix(),n!=null&&n.current&&n.current.setMatrixAt(f,h.matrix),h.matrix.toArray(s.array,f*16);n!=null&&n.current&&(n.current.instanceMatrix.needsUpdate=!0),s.needsUpdate=!0,o(new wl(s.array,s.itemSize).copy(s))},[r,n,i,e,t]),s}function PL({children:r,weight:e,transform:t,instances:i,mesh:n,count:s=16,...o}){const a=g.useRef(null),l=g.useRef(null),c=g.useRef(null);return g.useLayoutEffect(()=>{var u,h;l.current=(u=i==null?void 0:i.current)!==null&&u!==void 0?u:a.current.children.find(f=>f.hasOwnProperty("instanceMatrix")),c.current=(h=n==null?void 0:n.current)!==null&&h!==void 0?h:a.current.children.find(f=>f.type==="Mesh")},[r,n==null?void 0:n.current,i==null?void 0:i.current]),k6(c,s,t,e,l),g.createElement("group",Ae({ref:a},o),r)}const FL=({compute:r,name:e,...t})=>{const[i]=g.useState(()=>new Nt(new Float32Array(0),1)),n=g.useRef(null);return g.useLayoutEffect(()=>{if(n.current){var s;const o=(s=n.current.parent)!==null&&s!==void 0?s:n.current.__r3f.parent.object,a=r(o);n.current.copy(a)}},[r]),g.createElement("primitive",Ae({ref:n,object:i,attach:`attributes-${e}`},t))};function O6(r,{keys:e=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:t,inject:i,castShadow:n,receiveShadow:s}){let o={};for(const a of e)o[a]=r[a];return t&&(o.geometry&&t!=="materialsOnly"&&(o.geometry=o.geometry.clone()),o.material&&t!=="geometriesOnly"&&(o.material=o.material.clone())),i&&(typeof i=="function"?o={...o,children:i(r)}:g.isValidElement(i)?o={...o,children:i}:o={...o,...i}),r instanceof Qe&&(n&&(o.castShadow=!0),s&&(o.receiveShadow=!0)),o}const Lu=g.forwardRef(({isChild:r=!1,object:e,children:t,deep:i,castShadow:n,receiveShadow:s,inject:o,keys:a,...l},c)=>{const u={keys:a,deep:i,inject:o,castShadow:n,receiveShadow:s};if(e=g.useMemo(()=>{if(r===!1&&!Array.isArray(e)){let m=!1;if(e.traverse(A=>{A.isSkinnedMesh&&(m=!0)}),m)return R_.clone(e)}return e},[e,r]),Array.isArray(e))return g.createElement("group",Ae({},l,{ref:c}),e.map(m=>g.createElement(Lu,Ae({key:m.uuid,object:m},u))),t);const{children:h,...f}=O6(e,u),d=e.type[0].toLowerCase()+e.type.slice(1);return g.createElement(d,Ae({},f,l,{ref:c}),e.children.map(m=>m.type==="Bone"?g.createElement("primitive",Ae({key:m.uuid,object:m},u)):g.createElement(Lu,Ae({key:m.uuid,object:m},u,{isChild:!0}))),t,h)}),K0=g.createContext(null),kL=g.forwardRef(({resolution:r=28,maxPolyCount:e=1e4,enableUvs:t=!1,enableColors:i=!1,children:n,...s},o)=>{const a=g.useRef(null);g.useImperativeHandle(o,()=>a.current,[]);const l=g.useMemo(()=>new y_(r,null,t,i,e),[r,e,t,i]),c=g.useMemo(()=>({getParent:()=>a}),[]);return He(()=>{l.update(),l.reset()},-1),g.createElement(g.Fragment,null,g.createElement("primitive",Ae({object:l,ref:a},s),g.createElement(K0.Provider,{value:c},n)))}),OL=g.forwardRef(({strength:r=.5,subtract:e=12,color:t,...i},n)=>{const{getParent:s}=g.useContext(K0),o=g.useMemo(()=>s(),[s]),a=g.useRef(null);g.useImperativeHandle(n,()=>a.current,[]);const l=new z;return He(c=>{!o.current||!a.current||(a.current.getWorldPosition(l),o.current.addBall(.5+l.x*.5,.5+l.y*.5,.5+l.z*.5,r,e,t))}),g.createElement("group",Ae({ref:a},i))}),UL=g.forwardRef(({planeType:r="x",strength:e=.5,subtract:t=12,...i},n)=>{const{getParent:s}=g.useContext(K0),o=g.useMemo(()=>s(),[s]),a=g.useRef(null);g.useImperativeHandle(n,()=>a.current,[]);const l=g.useMemo(()=>r==="x"?"addPlaneX":r==="y"?"addPlaneY":"addPlaneZ",[r]);return He(()=>{!o.current||!a.current||o.current[l](e,t)}),g.createElement("group",Ae({ref:a},i))});function U6(r){return Array.isArray(r)}function uf(r=[0,0,0]){return U6(r)?r:r instanceof z||r instanceof wn?[r.x,r.y,r.z]:[r,r,r]}const NL=g.forwardRef(function({debug:e,depthTest:t=!1,polygonOffsetFactor:i=-10,map:n,mesh:s,children:o,position:a,rotation:l,scale:c,...u},h){const f=g.useRef(null);g.useImperativeHandle(h,()=>f.current);const d=g.useRef(null),m=g.useRef({position:new z,rotation:new wn,scale:new z(1,1,1)});return g.useLayoutEffect(()=>{const A=(s==null?void 0:s.current)||f.current.parent,p=f.current;if(!(A instanceof Qe))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(A){Wn(m.current,{position:a,scale:c});const y=A.matrixWorld.clone();if(A.matrixWorld.identity(),!l||typeof l=="number"){const E=new mi;E.position.copy(m.current.position);const v=A.geometry.attributes.position.array;A.geometry.attributes.normal===void 0&&A.geometry.computeVertexNormals();const x=A.geometry.attributes.normal.array;let C=1/0,I=new z;const _=E.position.x,S=E.position.y,b=E.position.z,T=v.length;let R=-1;for(let w=0;w<T;w+=3){const B=v[w],D=v[w+1],k=v[w+2],Q=B-_,Y=D-S,W=k-b,P=Q*Q+Y*Y+W*W;P<C&&(C=P,R=w)}I.fromArray(x,R),E.lookAt(E.position.clone().add(I)),E.rotateZ(Math.PI),E.rotateY(Math.PI),typeof l=="number"&&E.rotateZ(l),Wn(m.current,{rotation:E.rotation})}else Wn(m.current,{rotation:l});return d.current&&Wn(d.current,m.current),p.geometry=new rT(A,m.current.position,m.current.rotation,m.current.scale),A.matrixWorld=y,()=>{p.geometry.dispose()}}},[s,...uf(a),...uf(c),...uf(l)]),g.useLayoutEffect(()=>{d.current&&d.current.traverse(A=>A.raycast=()=>null)},[e]),g.createElement("mesh",Ae({ref:f,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":i,"material-depthTest":t,"material-map":n},u),o,e&&g.createElement("mesh",{ref:d},g.createElement("boxGeometry",null),g.createElement("meshNormalMaterial",{wireframe:!0}),g.createElement("axesHelper",null)))}),GL=g.forwardRef(function({src:e,skipFill:t,skipStrokes:i,fillMaterial:n,strokeMaterial:s,fillMeshProps:o,strokeMeshProps:a,...l},c){const u=oi(Jh,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),h=g.useMemo(()=>i?[]:u.paths.map(d=>{var m;return((m=d.userData)==null?void 0:m.style.stroke)===void 0||d.userData.style.stroke==="none"?null:d.subPaths.map(A=>Jh.pointsToStroke(A.getPoints(),d.userData.style))}),[u,i]);g.useEffect(()=>()=>h.forEach(d=>d&&d.map(m=>m.dispose())),[h]);let f=0;return g.createElement("object3D",Ae({ref:c},l),g.createElement("object3D",{scale:[1,-1,1]},u.paths.map((d,m)=>{var A,p;return g.createElement(g.Fragment,{key:m},!t&&((A=d.userData)==null?void 0:A.style.fill)!==void 0&&d.userData.style.fill!=="none"&&Jh.createShapes(d).map((y,E)=>g.createElement("mesh",Ae({key:E},o,{renderOrder:f++}),g.createElement("shapeGeometry",{args:[y]}),g.createElement("meshBasicMaterial",Ae({color:d.userData.style.fill,opacity:d.userData.style.fillOpacity,transparent:!0,side:xi,depthWrite:!1},n)))),!i&&((p=d.userData)==null?void 0:p.style.stroke)!==void 0&&d.userData.style.stroke!=="none"&&d.subPaths.map((y,E)=>g.createElement("mesh",Ae({key:E,geometry:h[m][E]},a,{renderOrder:f++}),g.createElement("meshBasicMaterial",Ae({color:d.userData.style.stroke,opacity:d.userData.style.strokeOpacity,transparent:!0,side:xi,depthWrite:!1},s)))))})))});let yc=null,Gv="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function Qv(r=!0,e=!0,t){return i=>{t&&t(i),r&&(yc||(yc=new l5),yc.setDecoderPath(typeof r=="string"?r:Gv),i.setDRACOLoader(yc)),e&&i.setMeshoptDecoder(typeof sf=="function"?sf():sf)}}const ih=(r,e,t,i)=>oi(U0,r,Qv(e,t,i));ih.preload=(r,e,t,i)=>oi.preload(U0,r,Qv(e,t,i));ih.clear=r=>oi.clear(U0,r);ih.setDecoderPath=r=>{Gv=r};const QL=g.forwardRef(({src:r,useDraco:e,useMeshOpt:t,extendLoader:i,...n},s)=>{const{scene:o}=ih(r,e,t,i);return g.createElement(Lu,Ae({ref:s},n,{object:o}))});function zL({renderIndex:r=1,bgColor:e="black",fgColor:t="white",characters:i=" .:-+*=%@#",invert:n=!0,color:s=!1,resolution:o=.15}){const{size:a,gl:l,scene:c,camera:u}=le(),h=g.useMemo(()=>{const f=new hT(l,i,{invert:n,color:s,resolution:o});return f.domElement.style.position="absolute",f.domElement.style.top="0px",f.domElement.style.left="0px",f.domElement.style.pointerEvents="none",f},[i,n,s,o]);return g.useLayoutEffect(()=>{h.domElement.style.color=t,h.domElement.style.backgroundColor=e},[t,e]),g.useEffect(()=>(l.domElement.style.opacity="0",l.domElement.parentNode.appendChild(h.domElement),()=>{l.domElement.style.opacity="1",l.domElement.parentNode.removeChild(h.domElement)}),[h]),g.useEffect(()=>{h.setSize(a.width,a.height)},[h,a]),He(f=>{h.render(c,u)},r),g.createElement(g.Fragment,null)}const $p=ps({alphaTest:0,viewport:new De(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},`
    precision highp sampler2D;
    precision highp usampler2D;
    out vec4 vColor;
    out vec3 vPosition;
    uniform vec2 resolution;
    uniform vec2 viewport;
    uniform float focal;
    attribute uint splatIndex;
    uniform sampler2D centerAndScaleTexture;
    uniform usampler2D covAndColorTexture;    

    vec2 unpackInt16(in uint value) {
      int v = int(value);
      int v0 = v >> 16;
      int v1 = (v & 0xFFFF);
      if((v & 0x8000) != 0)
        v1 |= 0xFFFF0000;
      return vec2(float(v1), float(v0));
    }

    void main () {
      ivec2 texSize = textureSize(centerAndScaleTexture, 0);
      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));
      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);
      vec4 center = vec4(centerAndScaleData.xyz, 1);
      vec4 camspace = modelViewMatrix * center;
      vec4 pos2d = projectionMatrix * camspace;

      float bounds = 1.2 * pos2d.w;
      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds
        || pos2d.y < -bounds || pos2d.y > bounds) {
        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);
        return;
      }

      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);
      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;
      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;
      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;
      mat3 Vrk = mat3(
        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,
        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,
        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y
      );

      mat3 J = mat3(
        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),
        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),
        0., 0., 0.
      );

      mat3 W = transpose(mat3(modelViewMatrix));
      mat3 T = W * J;
      mat3 cov = transpose(T) * Vrk * T;
      vec2 vCenter = vec2(pos2d) / pos2d.w;
      float diagonal1 = cov[0][0] + 0.3;
      float offDiagonal = cov[0][1];
      float diagonal2 = cov[1][1] + 0.3;
      float mid = 0.5 * (diagonal1 + diagonal2);
      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
      float lambda1 = mid + radius;
      float lambda2 = max(mid - radius, 0.1);
      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);
      uint colorUint = covAndColorData.w;
      vColor = vec4(
        float(colorUint & uint(0xFF)) / 255.0,
        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,
        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,
        float(colorUint >> uint(24)) / 255.0
      );
      vPosition = position;

      gl_Position = vec4(
        vCenter 
          + position.x * v2 / viewport * 2.0 
          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);
    }
    `,`
    #include <alphatest_pars_fragment>
    #include <alphahash_pars_fragment>
    in vec4 vColor;
    in vec3 vPosition;
    void main () {
      float A = -dot(vPosition.xy, vPosition.xy);
      if (A < -4.0) discard;
      float B = exp(A) * vColor.a;
      vec4 diffuseColor = vec4(vColor.rgb, B);
      #include <alphatest_fragment>
      #include <alphahash_fragment>
      gl_FragColor = diffuseColor;
      #include <tonemapping_fragment>
      #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `);function N6(r){let e=null,t=0;function i(n,s=!1){const o=e.length/16,a=-1e-4;let l=-1/0,c=1/0;const u=new Float32Array(o),h=new Int32Array(u.buffer),f=new Int32Array(o);let d=0;for(let E=0;E<o;E++){const v=n[0]*e[E*16+12]+n[1]*e[E*16+13]+n[2]*e[E*16+14]+n[3];(s||v<0&&e[E*16+15]>a*v)&&(u[d]=v,f[d]=E,d++,v>l&&(l=v),v<c&&(c=v))}const m=(256*256-1)/(l-c),A=new Uint32Array(256*256);for(let E=0;E<d;E++)h[E]=(u[E]-c)*m|0,A[h[E]]++;const p=new Uint32Array(256*256);for(let E=1;E<256*256;E++)p[E]=p[E-1]+A[E-1];const y=new Uint32Array(d);for(let E=0;E<d;E++)y[p[h[E]]++]=f[E];return y}r.onmessage=n=>{if(n.data.method=="push"){t===0&&(e=new Float32Array(n.data.length));const s=new Float32Array(n.data.matrices);e.set(s,t),t+=s.length}else if(n.data.method=="sort"&&e!==null){const s=i(new Float32Array(n.data.view),n.data.hashed);r.postMessage({indices:s,key:n.data.key},[s.buffer])}}}class G6 extends Dr{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,i,n){const s={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",N6.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(o,a,l)=>H6(a,s,o,l),connect:o=>V6(s,o),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:i};Q6(s).then(t).catch(o=>{n==null||n(o),s.manager.itemError(s.url)})}}async function Q6(r){r.manager.itemStart(r.url);const e=await fetch(r.url);if(e.body===null)throw"Failed to fetch file";let t=e.headers.get("Content-Length");const i=t?parseInt(t):void 0;if(i==null)throw"Failed to get content length";r.stream=e.body.getReader(),r.totalDownloadBytes=i,r.numVertices=Math.floor(r.totalDownloadBytes/r.rowLength);const n=r.gl.getContext();let s=n.getParameter(n.MAX_TEXTURE_SIZE);return r.maxVertexes=s*s,r.numVertices>r.maxVertexes&&(r.numVertices=r.maxVertexes),r.bufferTextureWidth=s,r.bufferTextureHeight=Math.floor((r.numVertices-1)/s)+1,r.centerAndScaleData=new Float32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.covAndColorData=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.centerAndScaleTexture=new br(r.centerAndScaleData,r.bufferTextureWidth,r.bufferTextureHeight,wi,ii),r.centerAndScaleTexture.needsUpdate=!0,r.covAndColorTexture=new br(r.covAndColorData,r.bufferTextureWidth,r.bufferTextureHeight,bu,Jr),r.covAndColorTexture.internalFormat="RGBA32UI",r.covAndColorTexture.needsUpdate=!0,r}async function z6(r){r.loading=!0;let e=0,t=0;const i=[];let n=0;const s=r.totalDownloadBytes!==0;for(;;)try{const{value:o,done:a}=await r.stream.read();if(a)break;if(e+=o.length,r.totalDownloadBytes!=null){const c=e/r.totalDownloadBytes*100;if(r.onProgress&&c-n>1){const u=new ProgressEvent("progress",{lengthComputable:s,loaded:e,total:r.totalDownloadBytes});r.onProgress(u),n=c}}i.push(o);const l=e-t;if(r.totalDownloadBytes!=null&&l>r.rowLength*r.chunkSize){let c=Math.floor(l/r.rowLength);const u=new Uint8Array(l);let h=0;for(const m of i)u.set(m,h),h+=m.length;if(i.length=0,l>c*r.rowLength){const m=new Uint8Array(l-c*r.rowLength);m.set(u.subarray(l-m.length,l),0),i.push(m)}const f=new Uint8Array(c*r.rowLength);f.set(u.subarray(0,f.byteLength),0);const d=Yp(r,f.buffer,c);if(r.worker.postMessage({method:"push",src:r.url,length:r.numVertices*16,matrices:d.buffer},[d.buffer]),t+=c*r.rowLength,r.onProgress){const m=new ProgressEvent("progress",{lengthComputable:s,loaded:r.totalDownloadBytes,total:r.totalDownloadBytes});r.onProgress(m)}}}catch(o){console.error(o);break}if(e-t>0){let o=new Uint8Array(i.reduce((u,h)=>u+h.length,0)),a=0;for(const u of i)o.set(u,a),a+=u.length;let l=Math.floor(o.byteLength/r.rowLength);const c=Yp(r,o.buffer,l);r.worker.postMessage({method:"push",src:r.url,length:l*16,matrices:c.buffer},[c.buffer])}r.loaded=!0,r.manager.itemEnd(r.url)}function H6(r,e,t,i){if(r.updateMatrixWorld(),e.gl.getCurrentViewport(t.viewport),t.material.viewport.x=t.viewport.z,t.material.viewport.y=t.viewport.w,t.material.focal=t.viewport.w/2*Math.abs(r.projectionMatrix.elements[5]),t.ready){if(i&&t.sorted)return;t.ready=!1;const n=new Float32Array([t.modelViewMatrix.elements[2],-t.modelViewMatrix.elements[6],t.modelViewMatrix.elements[10],t.modelViewMatrix.elements[14]]);e.worker.postMessage({method:"sort",src:e.url,key:t.uuid,view:n.buffer,hashed:i},[n.buffer]),i&&e.loaded&&(t.sorted=!0)}}function V6(r,e){r.loading||z6(r),e.ready=!1,e.pm=new we,e.vm1=new we,e.vm2=new we,e.viewport=new Ci;let t=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight);const i=new wl(t,1,!1);i.setUsage(Ji);const n=e.geometry=new B0,s=new Float32Array(6*3),o=new Nt(s,3);n.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,n.setAttribute("splatIndex",i),n.instanceCount=1;function a(c){if(e&&c.data.key===e.uuid){let u=new Uint32Array(c.data.indices);n.attributes.splatIndex.set(u),n.attributes.splatIndex.needsUpdate=!0,n.instanceCount=u.length,e.ready=!0}}r.worker.addEventListener("message",a);async function l(){for(;;){const c=r.gl.properties.get(r.centerAndScaleTexture),u=r.gl.properties.get(r.covAndColorTexture);if(c!=null&&c.__webglTexture&&u!=null&&u.__webglTexture&&r.loadedVertexCount>0)break;await new Promise(h=>setTimeout(h,10))}e.ready=!0}return l(),()=>r.worker.removeEventListener("message",a)}function Yp(r,e,t){const i=r.gl.getContext();if(r.loadedVertexCount+t>r.maxVertexes&&(t=r.maxVertexes-r.loadedVertexCount),t<=0)throw"Failed to parse file";const n=new Uint8Array(e),s=new Float32Array(e),o=new Float32Array(t*16),a=new Uint8Array(r.covAndColorData.buffer),l=new Int16Array(r.covAndColorData.buffer);for(let c=0;c<t;c++){const u=new nt(-(n[32*c+28+1]-128)/128,(n[32*c+28+2]-128)/128,(n[32*c+28+3]-128)/128,-(n[32*c+28+0]-128)/128);u.invert();const h=new z(s[8*c+0],s[8*c+1],-s[8*c+2]),f=new z(s[8*c+3+0],s[8*c+3+1],s[8*c+3+2]),d=new we;d.makeRotationFromQuaternion(u),d.transpose(),d.scale(f);const m=d.clone();d.transpose(),d.premultiply(m),d.setPosition(h);const A=[0,1,2,5,6,10];let p=0;for(let v=0;v<A.length;v++)Math.abs(d.elements[A[v]])>p&&(p=Math.abs(d.elements[A[v]]));let y=r.loadedVertexCount*4+c*4;r.centerAndScaleData[y+0]=h.x,r.centerAndScaleData[y+1]=-h.y,r.centerAndScaleData[y+2]=h.z,r.centerAndScaleData[y+3]=p/32767,y=r.loadedVertexCount*8+c*4*2;for(let v=0;v<A.length;v++)l[y+v]=d.elements[A[v]]*32767/p;y=r.loadedVertexCount*16+(c*4+3)*4;const E=new Ye(n[32*c+24+0]/255,n[32*c+24+1]/255,n[32*c+24+2]/255);E.convertSRGBToLinear(),a[y+0]=E.r*255,a[y+1]=E.g*255,a[y+2]=E.b*255,a[y+3]=n[32*c+24+3],d.elements[15]=Math.max(f.x,f.y,f.z)*n[32*c+24+3]/255;for(let v=0;v<16;v++)o[c*16+v]=d.elements[v]}for(;t>0;){let c=0,u=0;const h=r.loadedVertexCount%r.bufferTextureWidth,f=Math.floor(r.loadedVertexCount/r.bufferTextureWidth);r.loadedVertexCount%r.bufferTextureWidth!=0?(c=Math.min(r.bufferTextureWidth,h+t)-h,u=1):Math.floor(t/r.bufferTextureWidth)>0?(c=r.bufferTextureWidth,u=Math.floor(t/r.bufferTextureWidth)):(c=t%r.bufferTextureWidth,u=1);const d=r.gl.properties.get(r.centerAndScaleTexture);i.bindTexture(i.TEXTURE_2D,d.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA,i.FLOAT,r.centerAndScaleData,r.loadedVertexCount*4);const m=r.gl.properties.get(r.covAndColorTexture);i.bindTexture(i.TEXTURE_2D,m.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA_INTEGER,i.UNSIGNED_INT,r.covAndColorData,r.loadedVertexCount*4),r.gl.resetState(),r.loadedVertexCount+=c*u,t-=c*u}return o}function HL({src:r,toneMapped:e=!1,alphaTest:t=0,alphaHash:i=!1,chunkSize:n=25e3,...s}){Ii({SplatMaterial:$p});const o=g.useRef(null),a=le(u=>u.gl),l=le(u=>u.camera),c=oi(G6,r,u=>{u.gl=a,u.chunkSize=n});return g.useLayoutEffect(()=>c.connect(o.current),[r]),He(()=>c.update(o.current,l,i)),g.createElement("mesh",Ae({ref:o,frustumCulled:!1},s),g.createElement("splatMaterial",{key:`${r}/${t}/${i}${$p.key}`,transparent:!i,depthTest:!0,alphaTest:i?0:t,centerAndScaleTexture:c.centerAndScaleTexture,covAndColorTexture:c.covAndColorTexture,depthWrite:i?!0:t>0,blending:i?lC:n2,blendSrcAlpha:s2,alphaHash:!!i,toneMapped:e}))}function gn(r,e,t){const i=le(d=>d.size),n=le(d=>d.viewport),s=typeof r=="number"?r:i.width*n.dpr,o=typeof e=="number"?e:i.height*n.dpr,a=(typeof r=="number"?t:r)||{},{samples:l=0,depth:c,...u}=a,h=c??a.depthBuffer,f=g.useMemo(()=>{const d=new Ti(s,o,{minFilter:Ht,magFilter:Ht,type:fi,...u});return h&&(d.depthTexture=new R0(s,o,ii)),d.samples=l,d},[]);return g.useLayoutEffect(()=>{f.setSize(s,o),l&&(f.samples=l)},[l,f,s,o]),g.useEffect(()=>()=>f.dispose(),[]),f}const VL=g.forwardRef(({children:r,width:e,height:t,...i},n)=>{const s=gn(e,t,i);return g.useImperativeHandle(n,()=>s,[s]),g.createElement(g.Fragment,null,r==null?void 0:r(s))}),K6=r=>typeof r=="function",$6=g.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,children:i,makeDefault:n,...s},o)=>{const a=le(({set:p})=>p),l=le(({camera:p})=>p),c=le(({size:p})=>p),u=g.useRef(null);g.useImperativeHandle(o,()=>u.current,[]);const h=g.useRef(null),f=gn(e);g.useLayoutEffect(()=>{s.manual||u.current.updateProjectionMatrix()},[c,s]),g.useLayoutEffect(()=>{u.current.updateProjectionMatrix()}),g.useLayoutEffect(()=>{if(n){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,n,a]);let d=0,m=null;const A=K6(i);return He(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),g.createElement(g.Fragment,null,g.createElement("orthographicCamera",Ae({left:c.width/-2,right:c.width/2,top:c.height/2,bottom:c.height/-2,ref:u},s),!A&&i),g.createElement("group",{ref:h},A&&i(f.texture)))}),Y6=r=>typeof r=="function",KL=g.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,makeDefault:i,children:n,...s},o)=>{const a=le(({set:p})=>p),l=le(({camera:p})=>p),c=le(({size:p})=>p),u=g.useRef(null);g.useImperativeHandle(o,()=>u.current,[]);const h=g.useRef(null),f=gn(e);g.useLayoutEffect(()=>{s.manual||(u.current.aspect=c.width/c.height)},[c,s]),g.useLayoutEffect(()=>{u.current.updateProjectionMatrix()});let d=0,m=null;const A=Y6(n);return He(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),g.useLayoutEffect(()=>{if(i){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,i,a]),g.createElement(g.Fragment,null,g.createElement("perspectiveCamera",Ae({ref:u},s),!A&&n),g.createElement("group",{ref:h},A&&n(f.texture)))});function W6({resolution:r=256,near:e=.1,far:t=1e3,envMap:i,fog:n}={}){const s=le(({gl:f})=>f),o=le(({scene:f})=>f),a=g.useMemo(()=>{const f=new ju(r);return f.texture.type=fi,f},[r]);g.useEffect(()=>()=>{a.dispose()},[a]);const l=g.useMemo(()=>new r2(e,t,a),[e,t,a]);let c,u;const h=g.useCallback(()=>{c=o.fog,u=o.background,o.background=i||u,o.fog=n||c,l.update(s,o),o.fog=c,o.background=u},[s,o,l]);return{fbo:a,camera:l,update:h}}function $L({children:r,frames:e=1/0,resolution:t,near:i,far:n,envMap:s,fog:o,...a}){const l=g.useRef(null),{fbo:c,camera:u,update:h}=W6({resolution:t,near:i,far:n,envMap:s,fog:o});let f=0;return He(()=>{l.current&&(e===1/0||f<e)&&(l.current.visible=!1,h(),l.current.visible=!0,f++)}),g.createElement("group",a,g.createElement("primitive",{object:u}),g.createElement("group",{ref:l},r==null?void 0:r(c.texture)))}const YL=g.forwardRef((r,e)=>{const{camera:t,onChange:i,makeDefault:n,...s}=r,o=le(f=>f.camera),a=le(f=>f.invalidate),l=le(f=>f.get),c=le(f=>f.set),u=t||o,h=g.useMemo(()=>new q_(u),[u]);return g.useEffect(()=>{const f=d=>{a(),i&&i(d)};return h==null||h.addEventListener==null||h.addEventListener("change",f),()=>h==null||h.removeEventListener==null?void 0:h.removeEventListener("change",f)},[i,h,a]),He(()=>h==null?void 0:h.update(),-1),g.useEffect(()=>{const f=h;return f==null||f.connect(),()=>f==null?void 0:f.dispose()},[h]),g.useEffect(()=>{if(n){const f=l().controls;return c({controls:h}),()=>c({controls:f})}},[n,h]),h?g.createElement("primitive",Ae({ref:e,object:h},s)):null}),WL=g.forwardRef(({domElement:r,...e},t)=>{const{onChange:i,makeDefault:n,...s}=e,o=le(m=>m.invalidate),a=le(m=>m.camera),l=le(m=>m.gl),c=le(m=>m.events),u=le(m=>m.get),h=le(m=>m.set),f=r||c.connected||l.domElement,d=g.useMemo(()=>new uS(a),[a]);return g.useEffect(()=>(d.connect(f),()=>void d.dispose()),[f,d,o]),g.useEffect(()=>{const m=A=>{o(),i&&i(A)};return d.addEventListener==null||d.addEventListener("change",m),()=>d.removeEventListener==null?void 0:d.removeEventListener("change",m)},[i,o]),g.useEffect(()=>{if(n){const m=u().controls;return h({controls:d}),()=>h({controls:m})}},[n,d]),He((m,A)=>d.update(A)),g.createElement("primitive",Ae({ref:t,object:d,args:[a,f]},s))}),jL=g.forwardRef((r={enableDamping:!0},e)=>{const{domElement:t,camera:i,makeDefault:n,onChange:s,onStart:o,onEnd:a,...l}=r,c=le(E=>E.invalidate),u=le(E=>E.camera),h=le(E=>E.gl),f=le(E=>E.events),d=le(E=>E.set),m=le(E=>E.get),A=t||f.connected||h.domElement,p=i||u,y=g.useMemo(()=>new sS(p),[p]);return g.useEffect(()=>{y.connect(A);const E=v=>{c(),s&&s(v)};return y.addEventListener("change",E),o&&y.addEventListener("start",o),a&&y.addEventListener("end",a),()=>{y.dispose(),y.removeEventListener("change",E),o&&y.removeEventListener("start",o),a&&y.removeEventListener("end",a)}},[s,o,a,y,c,A]),g.useEffect(()=>{if(n){const E=m().controls;return d({controls:y}),()=>d({controls:E})}},[n,y]),He(()=>y.update(),-1),g.createElement("primitive",Ae({ref:e,object:y,enableDamping:!0},l))}),XL=g.forwardRef(({makeDefault:r,camera:e,regress:t,domElement:i,enableDamping:n=!0,keyEvents:s=!1,onChange:o,onStart:a,onEnd:l,...c},u)=>{const h=le(I=>I.invalidate),f=le(I=>I.camera),d=le(I=>I.gl),m=le(I=>I.events),A=le(I=>I.setEvents),p=le(I=>I.set),y=le(I=>I.get),E=le(I=>I.performance),v=e||f,x=i||m.connected||d.domElement,C=g.useMemo(()=>new Y2(v),[v]);return He(()=>{C.enabled&&C.update()},-1),g.useEffect(()=>(s&&C.connect(s===!0?x:s),C.connect(x),()=>void C.dispose()),[s,x,t,C,h]),g.useEffect(()=>{const I=b=>{h(),t&&E.regress(),o&&o(b)},_=b=>{a&&a(b)},S=b=>{l&&l(b)};return C.addEventListener("change",I),C.addEventListener("start",_),C.addEventListener("end",S),()=>{C.removeEventListener("start",_),C.removeEventListener("end",S),C.removeEventListener("change",I)}},[o,a,l,C,h,A]),g.useEffect(()=>{if(r){const I=y().controls;return p({controls:C}),()=>p({controls:I})}},[r,C]),g.createElement("primitive",Ae({ref:u,object:C,enableDamping:n},c))}),qL=g.forwardRef(({makeDefault:r,camera:e,domElement:t,regress:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const{invalidate:c,camera:u,gl:h,events:f,set:d,get:m,performance:A,viewport:p}=le(),y=e||u,E=t||f.connected||h.domElement,v=g.useMemo(()=>new eS(y),[y]);return He(()=>{v.enabled&&v.update()},-1),g.useEffect(()=>(v.connect(E),()=>void v.dispose()),[E,i,v,c]),g.useEffect(()=>{const x=C=>{c(),i&&A.regress(),n&&n(C)};return v.addEventListener("change",x),s&&v.addEventListener("start",s),o&&v.addEventListener("end",o),()=>{s&&v.removeEventListener("start",s),o&&v.removeEventListener("end",o),v.removeEventListener("change",x)}},[n,s,o,v,c]),g.useEffect(()=>{v.handleResize()},[p]),g.useEffect(()=>{if(r){const x=m().controls;return d({controls:v}),()=>d({controls:x})}},[r,v]),g.createElement("primitive",Ae({ref:l,object:v},a))}),JL=g.forwardRef(({camera:r,makeDefault:e,regress:t,domElement:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const c=le(v=>v.invalidate),u=le(v=>v.camera),h=le(v=>v.gl),f=le(v=>v.events),d=le(v=>v.set),m=le(v=>v.get),A=le(v=>v.performance),p=r||u,y=i||f.connected||h.domElement,E=g.useMemo(()=>new aS(p),[p]);return He(()=>{E.enabled&&E.update()},-1),g.useEffect(()=>(E.connect(y),()=>void E.dispose()),[y,t,E,c]),g.useEffect(()=>{const v=x=>{c(),t&&A.regress(),n&&n(x)};return E.addEventListener("change",v),s&&E.addEventListener("start",s),o&&E.addEventListener("end",o),()=>{E.removeEventListener("change",v),s&&E.removeEventListener("start",s),o&&E.removeEventListener("end",o)}},[n,s,o]),g.useEffect(()=>{if(e){const v=m().controls;return d({controls:E}),()=>d({controls:v})}},[e,E]),g.createElement("primitive",Ae({ref:l,object:E},a))}),ZL=g.forwardRef(({children:r,domElement:e,onChange:t,onMouseDown:i,onMouseUp:n,onObjectChange:s,object:o,makeDefault:a,camera:l,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:y,showY:E,showZ:v,...x},C)=>{const I=le(M=>M.controls),_=le(M=>M.gl),S=le(M=>M.events),b=le(M=>M.camera),T=le(M=>M.invalidate),R=le(M=>M.get),w=le(M=>M.set),B=l||b,D=e||S.connected||_.domElement,k=g.useMemo(()=>new G_(B,D),[B,D]),Q=g.useRef(null);g.useLayoutEffect(()=>(o?k.attach(o instanceof mi?o:o.current):Q.current instanceof mi&&k.attach(Q.current),()=>void k.detach()),[o,r,k]),g.useEffect(()=>{if(I){const M=V=>I.enabled=!V.value;return k.addEventListener("dragging-changed",M),()=>k.removeEventListener("dragging-changed",M)}},[k,I]);const Y=g.useRef(void 0),W=g.useRef(void 0),P=g.useRef(void 0),K=g.useRef(void 0);return g.useLayoutEffect(()=>void(Y.current=t),[t]),g.useLayoutEffect(()=>void(W.current=i),[i]),g.useLayoutEffect(()=>void(P.current=n),[n]),g.useLayoutEffect(()=>void(K.current=s),[s]),g.useEffect(()=>{const M=O=>{T(),Y.current==null||Y.current(O)},V=O=>W.current==null?void 0:W.current(O),$=O=>P.current==null?void 0:P.current(O),G=O=>K.current==null?void 0:K.current(O);return k.addEventListener("change",M),k.addEventListener("mouseDown",V),k.addEventListener("mouseUp",$),k.addEventListener("objectChange",G),()=>{k.removeEventListener("change",M),k.removeEventListener("mouseDown",V),k.removeEventListener("mouseUp",$),k.removeEventListener("objectChange",G)}},[T,k]),g.useEffect(()=>{if(a){const M=R().controls;return w({controls:k}),()=>w({controls:M})}},[a,k]),g.createElement(g.Fragment,null,g.createElement("primitive",{ref:C,object:k,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:y,showY:E,showZ:v}),g.createElement("group",Ae({ref:Q},x),r))}),eP=g.forwardRef(({domElement:r,selector:e,onChange:t,onLock:i,onUnlock:n,enabled:s=!0,makeDefault:o,...a},l)=>{const{camera:c,...u}=a,h=le(C=>C.setEvents),f=le(C=>C.gl),d=le(C=>C.camera),m=le(C=>C.invalidate),A=le(C=>C.events),p=le(C=>C.get),y=le(C=>C.set),E=c||d,v=r||A.connected||f.domElement,x=g.useMemo(()=>new W_(E),[E]);return g.useEffect(()=>{if(s){x.connect(v);const C=p().events.compute;return h({compute(I,_){const S=_.size.width/2,b=_.size.height/2;_.pointer.set(S/_.size.width*2-1,-(b/_.size.height)*2+1),_.raycaster.setFromCamera(_.pointer,_.camera)}}),()=>{x.disconnect(),h({compute:C})}}},[s,x]),g.useEffect(()=>{const C=S=>{m(),t&&t(S)};x.addEventListener("change",C),i&&x.addEventListener("lock",i),n&&x.addEventListener("unlock",n);const I=()=>x.lock(),_=e?Array.from(document.querySelectorAll(e)):[document];return _.forEach(S=>S&&S.addEventListener("click",I)),()=>{x.removeEventListener("change",C),i&&x.removeEventListener("lock",i),n&&x.removeEventListener("unlock",n),_.forEach(S=>S?S.removeEventListener("click",I):void 0)}},[t,i,n,e,x,m]),g.useEffect(()=>{if(o){const C=p().controls;return y({controls:x}),()=>y({controls:C})}},[o,x]),g.createElement("primitive",Ae({ref:l,object:x},u))}),tP=g.forwardRef(({domElement:r,makeDefault:e,...t},i)=>{const n=le(h=>h.camera),s=le(h=>h.gl),o=le(h=>h.events),a=le(h=>h.get),l=le(h=>h.set),c=r||o.connected||s.domElement,[u]=g.useState(()=>new O_(n,c));return g.useEffect(()=>{if(e){const h=a().controls;return l({controls:u}),()=>l({controls:h})}},[e,u]),He((h,f)=>{u.update(f)},-1),u?g.createElement("primitive",Ae({ref:i,object:u},t)):null});/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const ci={LEFT:1,RIGHT:2,MIDDLE:4},de=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),Eo={NONE:0,IN:1,OUT:-1};function Nr(r){return r.isPerspectiveCamera}function yr(r){return r.isOrthographicCamera}const fr=Math.PI*2,Wp=Math.PI/2,zv=1e-5,$a=Math.PI/180;function cs(r,e,t){return Math.max(e,Math.min(t,r))}function Wt(r,e=zv){return Math.abs(r)<e}function Ft(r,e,t=zv){return Wt(r-e,t)}function jp(r,e){return Math.round(r/e)*e}function Ya(r){return isFinite(r)?r:r<0?-Number.MAX_VALUE:Number.MAX_VALUE}function Wa(r){return Math.abs(r)<Number.MAX_VALUE?r:r*(1/0)}function vc(r,e,t,i,n=1/0,s){i=Math.max(1e-4,i);const o=2/i,a=o*s,l=1/(1+a+.48*a*a+.235*a*a*a);let c=r-e;const u=e,h=n*i;c=cs(c,-h,h),e=r-c;const f=(t.value+o*c)*s;t.value=(t.value-o*f)*l;let d=e+(c+f)*l;return u-r>0==d>u&&(d=u,t.value=(d-u)/s),d}function Xp(r,e,t,i,n=1/0,s,o){i=Math.max(1e-4,i);const a=2/i,l=a*s,c=1/(1+l+.48*l*l+.235*l*l*l);let u=e.x,h=e.y,f=e.z,d=r.x-u,m=r.y-h,A=r.z-f;const p=u,y=h,E=f,v=n*i,x=v*v,C=d*d+m*m+A*A;if(C>x){const k=Math.sqrt(C);d=d/k*v,m=m/k*v,A=A/k*v}u=r.x-d,h=r.y-m,f=r.z-A;const I=(t.x+a*d)*s,_=(t.y+a*m)*s,S=(t.z+a*A)*s;t.x=(t.x-a*I)*c,t.y=(t.y-a*_)*c,t.z=(t.z-a*S)*c,o.x=u+(d+I)*c,o.y=h+(m+_)*c,o.z=f+(A+S)*c;const b=p-r.x,T=y-r.y,R=E-r.z,w=o.x-p,B=o.y-y,D=o.z-E;return b*w+T*B+R*D>0&&(o.x=p,o.y=y,o.z=E,t.x=(o.x-p)/s,t.y=(o.y-y)/s,t.z=(o.z-E)/s),o}function hf(r,e){e.set(0,0),r.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=r.length,e.y/=r.length}function ff(r,e){return yr(r)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class j6{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=i.slice(0);for(let s=0,o=n.length;s<o;s++)n[s].call(this,e)}}}var df;const X6="3.1.0",Ec=1/8,q6=/Mac/.test((df=globalThis==null?void 0:globalThis.navigator)===null||df===void 0?void 0:df.platform);let ct,qp,xc,mf,fn,yt,wt,xo,ja,xs,Cs,Gr,Jp,Zp,Tn,Co,Io,eg,Af,tg,pf,gf,Cc,J6=class Yd extends j6{static install(e){ct=e.THREE,qp=Object.freeze(new ct.Vector3(0,0,0)),xc=Object.freeze(new ct.Vector3(0,1,0)),mf=Object.freeze(new ct.Vector3(0,0,1)),fn=new ct.Vector2,yt=new ct.Vector3,wt=new ct.Vector3,xo=new ct.Vector3,ja=new ct.Vector3,xs=new ct.Vector3,Cs=new ct.Vector3,Gr=new ct.Vector3,Jp=new ct.Vector3,Zp=new ct.Vector3,Tn=new ct.Spherical,Co=new ct.Spherical,Io=new ct.Box3,eg=new ct.Box3,Af=new ct.Sphere,tg=new ct.Quaternion,pf=new ct.Quaternion,gf=new ct.Matrix4,Cc=new ct.Raycaster}static get ACTION(){return de}set verticalDragToForward(e){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=de.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Eo.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new ct.Vector3,this._focalOffsetVelocity=new ct.Vector3,this._zoomVelocity={value:0},this._truckInternal=(y,E,v,x)=>{let C,I;if(Nr(this._camera)){const _=yt.copy(this._camera.position).sub(this._target),S=this._camera.getEffectiveFOV()*$a,b=_.length()*Math.tan(S*.5);C=this.truckSpeed*y*b/this._elementRect.height,I=this.truckSpeed*E*b/this._elementRect.height}else if(yr(this._camera)){const _=this._camera;C=this.truckSpeed*y*(_.right-_.left)/_.zoom/this._elementRect.width,I=this.truckSpeed*E*(_.top-_.bottom)/_.zoom/this._elementRect.height}else return;x?(v?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(C,0,!0),this.forward(-I,!0)):v?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y+I,this._focalOffsetEnd.z,!0):this.truck(C,I,!0)},this._rotateInternal=(y,E)=>{const v=fr*this.azimuthRotateSpeed*y/this._elementRect.height,x=fr*this.polarRotateSpeed*E/this._elementRect.height;this.rotate(v,x,!0)},this._dollyInternal=(y,E,v)=>{const x=Math.pow(.95,-y*this.dollySpeed),C=this._sphericalEnd.radius,I=this._sphericalEnd.radius*x,_=cs(I,this.minDistance,this.maxDistance),S=_-I;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(I,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(S,!0),this._dollyToNoClamp(_,!0)):this._dollyToNoClamp(_,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?I:_)-C,this._dollyControlCoord.set(E,v)),this._lastDollyDirection=Math.sign(-y)},this._zoomInternal=(y,E,v)=>{const x=Math.pow(.95,y*this.dollySpeed),C=this._zoom,I=this._zoom*x;this.zoomTo(I,!0),this.dollyToCursor&&(this._changedZoom+=I-C,this._dollyControlCoord.set(E,v))},typeof ct>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new ct.Quaternion().setFromUnitVectors(this._camera.up,xc),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=de.NONE,this._target=new ct.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new ct.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new ct.Spherical().setFromVector3(yt.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new ct.Vector3,new ct.Vector3,new ct.Vector3,new ct.Vector3],this._updateNearPlaneCorners(),this._boundary=new ct.Box3(new ct.Vector3(-1/0,-1/0,-1/0),new ct.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new ct.Vector2,this.mouseButtons={left:de.ROTATE,middle:de.DOLLY,right:de.TRUCK,wheel:Nr(this._camera)?de.DOLLY:yr(this._camera)?de.ZOOM:de.NONE},this.touches={one:de.TOUCH_ROTATE,two:Nr(this._camera)?de.TOUCH_DOLLY_TRUCK:yr(this._camera)?de.TOUCH_ZOOM_TRUCK:de.NONE,three:de.TOUCH_TRUCK};const i=new ct.Vector2,n=new ct.Vector2,s=new ct.Vector2,o=y=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const x=this._domElement.getBoundingClientRect(),C=y.clientX/x.width,I=y.clientY/x.height;if(C<this._interactiveArea.left||C>this._interactiveArea.right||I<this._interactiveArea.top||I>this._interactiveArea.bottom)return}const E=y.pointerType!=="mouse"?null:(y.buttons&ci.LEFT)===ci.LEFT?ci.LEFT:(y.buttons&ci.MIDDLE)===ci.MIDDLE?ci.MIDDLE:(y.buttons&ci.RIGHT)===ci.RIGHT?ci.RIGHT:null;if(E!==null){const x=this._findPointerByMouseButton(E);x&&this._disposePointer(x)}if((y.buttons&ci.LEFT)===ci.LEFT&&this._lockedPointer)return;const v={pointerId:y.pointerId,clientX:y.clientX,clientY:y.clientY,deltaX:0,deltaY:0,mouseButton:E};this._activePointers.push(v),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,f(y)},a=y=>{y.cancelable&&y.preventDefault();const E=y.pointerId,v=this._lockedPointer||this._findPointerById(E);if(v){if(v.clientX=y.clientX,v.clientY=y.clientY,v.deltaX=y.movementX,v.deltaY=y.movementY,this._state=0,y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(y.buttons&ci.LEFT)===ci.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(y.buttons&ci.MIDDLE)===ci.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(y.buttons&ci.RIGHT)===ci.RIGHT&&(this._state=this._state|this.mouseButtons.right);d()}},l=y=>{const E=this._findPointerById(y.pointerId);if(!(E&&E===this._lockedPointer)){if(E&&this._disposePointer(E),y.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=de.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=de.NONE;m()}};let c=-1;const u=y=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===de.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const I=this._domElement.getBoundingClientRect(),_=y.clientX/I.width,S=y.clientY/I.height;if(_<this._interactiveArea.left||_>this._interactiveArea.right||S<this._interactiveArea.top||S>this._interactiveArea.bottom)return}if(y.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===de.ROTATE||this.mouseButtons.wheel===de.TRUCK){const I=performance.now();c-I<1e3&&this._getClientRect(this._elementRect),c=I}const E=q6?-1:-3,v=y.deltaMode===1||y.ctrlKey?y.deltaY/E:y.deltaY/(E*10),x=this.dollyToCursor?(y.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,C=this.dollyToCursor?(y.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case de.ROTATE:{this._rotateInternal(y.deltaX,y.deltaY),this._isUserControllingRotate=!0;break}case de.TRUCK:{this._truckInternal(y.deltaX,y.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case de.SCREEN_PAN:{this._truckInternal(y.deltaX,y.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case de.OFFSET:{this._truckInternal(y.deltaX,y.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case de.DOLLY:{this._dollyInternal(-v,x,C),this._isUserControllingDolly=!0;break}case de.ZOOM:{this._zoomInternal(-v,x,C),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},h=y=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Yd.ACTION.NONE){const E=y instanceof PointerEvent?y.pointerId:0,v=this._findPointerById(E);v&&this._disposePointer(v),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}y.preventDefault()}},f=y=>{if(!this._enabled)return;if(hf(this._activePointers,fn),this._getClientRect(this._elementRect),i.copy(fn),n.copy(fn),this._activePointers.length>=2){const v=fn.x-this._activePointers[1].clientX,x=fn.y-this._activePointers[1].clientY,C=Math.sqrt(v*v+x*x);s.set(0,C);const I=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,_=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;n.set(I,_)}if(this._state=0,!y)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in y&&y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(y.buttons&ci.LEFT)===ci.LEFT&&(this._state=this._state|this.mouseButtons.left),(y.buttons&ci.MIDDLE)===ci.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(y.buttons&ci.RIGHT)===ci.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&de.ROTATE)===de.ROTATE||(this._state&de.TOUCH_ROTATE)===de.TOUCH_ROTATE||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&de.TRUCK)===de.TRUCK||(this._state&de.SCREEN_PAN)===de.SCREEN_PAN||(this._state&de.TOUCH_TRUCK)===de.TOUCH_TRUCK||(this._state&de.TOUCH_SCREEN_PAN)===de.TOUCH_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&de.DOLLY)===de.DOLLY||(this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&de.ZOOM)===de.ZOOM||(this._state&de.TOUCH_ZOOM)===de.TOUCH_ZOOM||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&de.OFFSET)===de.OFFSET||(this._state&de.TOUCH_OFFSET)===de.TOUCH_OFFSET||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,hf(this._activePointers,fn);const E=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,v=E?-E.deltaX:n.x-fn.x,x=E?-E.deltaY:n.y-fn.y;if(n.copy(fn),((this._state&de.ROTATE)===de.ROTATE||(this._state&de.TOUCH_ROTATE)===de.TOUCH_ROTATE||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(v,x),this._isUserControllingRotate=!0),(this._state&de.DOLLY)===de.DOLLY||(this._state&de.ZOOM)===de.ZOOM){const C=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,I=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,_=this.dollyDragInverted?-1:1;(this._state&de.DOLLY)===de.DOLLY?(this._dollyInternal(_*x*Ec,C,I),this._isUserControllingDolly=!0):(this._zoomInternal(_*x*Ec,C,I),this._isUserControllingZoom=!0)}if((this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_ZOOM)===de.TOUCH_ZOOM||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE){const C=fn.x-this._activePointers[1].clientX,I=fn.y-this._activePointers[1].clientY,_=Math.sqrt(C*C+I*I),S=s.y-_;s.set(0,_);const b=this.dollyToCursor?(n.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(n.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET?(this._dollyInternal(S*Ec,b,T),this._isUserControllingDolly=!0):(this._zoomInternal(S*Ec,b,T),this._isUserControllingZoom=!0)}((this._state&de.TRUCK)===de.TRUCK||(this._state&de.TOUCH_TRUCK)===de.TOUCH_TRUCK||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(v,x,!1,!1),this._isUserControllingTruck=!0),((this._state&de.SCREEN_PAN)===de.SCREEN_PAN||(this._state&de.TOUCH_SCREEN_PAN)===de.TOUCH_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(v,x,!1,!0),this._isUserControllingTruck=!0),((this._state&de.OFFSET)===de.OFFSET||(this._state&de.TOUCH_OFFSET)===de.TOUCH_OFFSET||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(v,x,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},m=()=>{hf(this._activePointers,fn),n.copy(fn),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",A),this._domElement.ownerDocument.addEventListener("pointerlockerror",p),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),f())},this.unlockPointer=()=>{var y,E,v;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(y=this._domElement)===null||y===void 0||y.ownerDocument.exitPointerLock(),(E=this._domElement)===null||E===void 0||E.ownerDocument.removeEventListener("pointerlockchange",A),(v=this._domElement)===null||v===void 0||v.ownerDocument.removeEventListener("pointerlockerror",p),this.cancel()};const A=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},p=()=>{this.unlockPointer()};this._addAllEventListeners=y=>{this._domElement=y,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",o),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",u,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",o),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",u,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",p))},this.cancel=()=>{this._state!==de.NONE&&(this._state=de.NONE,this._activePointers.length=0,m())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=cs(e.width,0,1),this._interactiveArea.height=cs(e.height,0,1),this._interactiveArea.x=cs(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=cs(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,i=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,i)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,i=!1){this._isUserControllingRotate=!1;const n=cs(e,this.minAzimuthAngle,this.maxAzimuthAngle),s=cs(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=n,this._sphericalEnd.phi=s,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const o=!i||Ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(o)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Eo.NONE,this._changedDolly=0,this._dollyToNoClamp(cs(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const o=this._collisionTest(),a=Ft(o,this._spherical.radius);if(!(i>e)&&a)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,o)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const s=!t||Ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(ja).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const i=!t||Ft(this._target.x,this._targetEnd.x,this.restThreshold)&&Ft(this._target.y,this._targetEnd.y,this.restThreshold)&&Ft(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=cs(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const i=!t||Ft(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(e,t,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,i)}truck(e,t,i=!1){this._camera.updateMatrix(),xs.setFromMatrixColumn(this._camera.matrix,0),Cs.setFromMatrixColumn(this._camera.matrix,1),xs.multiplyScalar(e),Cs.multiplyScalar(-t);const n=yt.copy(xs).add(Cs),s=wt.copy(this._targetEnd).add(n);return this.moveTo(s.x,s.y,s.z,i)}forward(e,t=!1){yt.setFromMatrixColumn(this._camera.matrix,0),yt.crossVectors(this._camera.up,yt),yt.multiplyScalar(e);const i=wt.copy(this._targetEnd).add(yt);return this.moveTo(i.x,i.y,i.z,t)}elevate(e,t=!1){return yt.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+yt.x,this._targetEnd.y+yt.y,this._targetEnd.z+yt.z,t)}moveTo(e,t,i,n=!1){this._isUserControllingTruck=!1;const s=yt.set(e,t,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,s,this.boundaryFriction),this._needsUpdate=!0,n||this._target.copy(this._targetEnd);const o=!n||Ft(this._target.x,this._targetEnd.x,this.restThreshold)&&Ft(this._target.y,this._targetEnd.y,this.restThreshold)&&Ft(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(o)}lookInDirectionOf(e,t,i,n=!1){const a=yt.set(e,t,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(a.x,a.y,a.z,n)}fitToBox(e,t,{cover:i=!1,paddingLeft:n=0,paddingRight:s=0,paddingBottom:o=0,paddingTop:a=0}={}){const l=[],c=e.isBox3?Io.copy(e):Io.setFromObject(e);c.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const u=jp(this._sphericalEnd.theta,Wp),h=jp(this._sphericalEnd.phi,Wp);l.push(this.rotateTo(u,h,t));const f=yt.setFromSpherical(this._sphericalEnd).normalize(),d=tg.setFromUnitVectors(f,mf),m=Ft(Math.abs(f.y),1);m&&d.multiply(pf.setFromAxisAngle(xc,u)),d.multiply(this._yAxisUpSpaceInverse);const A=eg.makeEmpty();wt.copy(c.min).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.min).setX(c.max.x).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.min).setY(c.max.y).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.max).setZ(c.min.z).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.min).setZ(c.max.z).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.max).setY(c.min.y).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.max).setX(c.min.x).applyQuaternion(d),A.expandByPoint(wt),wt.copy(c.max).applyQuaternion(d),A.expandByPoint(wt),A.min.x-=n,A.min.y-=o,A.max.x+=s,A.max.y+=a,d.setFromUnitVectors(mf,f),m&&d.premultiply(pf.invert()),d.premultiply(this._yAxisUpSpace);const p=A.getSize(yt),y=A.getCenter(wt).applyQuaternion(d);if(Nr(this._camera)){const E=this.getDistanceToFitBox(p.x,p.y,p.z,i);l.push(this.moveTo(y.x,y.y,y.z,t)),l.push(this.dollyTo(E,t)),l.push(this.setFocalOffset(0,0,0,t))}else if(yr(this._camera)){const E=this._camera,v=E.right-E.left,x=E.top-E.bottom,C=i?Math.max(v/p.x,x/p.y):Math.min(v/p.x,x/p.y);l.push(this.moveTo(y.x,y.y,y.z,t)),l.push(this.zoomTo(C,t)),l.push(this.setFocalOffset(0,0,0,t))}return Promise.all(l)}fitToSphere(e,t){const i=[],s="isObject3D"in e?Yd.createBoundingSphere(e,Af):Af.copy(e);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,t)),Nr(this._camera)){const o=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(o,t))}else if(yr(this._camera)){const o=this._camera.right-this._camera.left,a=this._camera.top-this._camera.bottom,l=2*s.radius,c=Math.min(o/l,a/l);i.push(this.zoomTo(c,t))}return i.push(this.setFocalOffset(0,0,0,t)),Promise.all(i)}setLookAt(e,t,i,n,s,o,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Eo.NONE,this._changedDolly=0;const l=wt.set(n,s,o),c=yt.set(e,t,i);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(c.sub(l).applyQuaternion(this._yAxisUpSpace)),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!a||Ft(this._target.x,this._targetEnd.x,this.restThreshold)&&Ft(this._target.y,this._targetEnd.y,this.restThreshold)&&Ft(this._target.z,this._targetEnd.z,this.restThreshold)&&Ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerp(e,t,i,n=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Eo.NONE,this._changedDolly=0;const s=yt.set(...e.target);if("spherical"in e)Tn.set(...e.spherical);else{const h=wt.set(...e.position);Tn.setFromVector3(h.sub(s).applyQuaternion(this._yAxisUpSpace))}const o=xo.set(...t.target);if("spherical"in t)Co.set(...t.spherical);else{const h=wt.set(...t.position);Co.setFromVector3(h.sub(o).applyQuaternion(this._yAxisUpSpace))}this._targetEnd.copy(s.lerp(o,i));const a=Co.theta-Tn.theta,l=Co.phi-Tn.phi,c=Co.radius-Tn.radius;this._sphericalEnd.set(Tn.radius+c*i,Tn.phi+l*i,Tn.theta+a*i),this._needsUpdate=!0,n||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!n||Ft(this._target.x,this._targetEnd.x,this.restThreshold)&&Ft(this._target.y,this._targetEnd.y,this.restThreshold)&&Ft(this._target.z,this._targetEnd.z,this.restThreshold)&&Ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerpLookAt(e,t,i,n,s,o,a,l,c,u,h,f,d,m=!1){return this.lerp({position:[e,t,i],target:[n,s,o]},{position:[a,l,c],target:[u,h,f]},d,m)}setPosition(e,t,i,n=!1){return this.setLookAt(e,t,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,n)}setTarget(e,t,i,n=!1){const s=this.getPosition(yt),o=this.setLookAt(s.x,s.y,s.z,e,t,i,n);return this._sphericalEnd.phi=cs(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),o}setFocalOffset(e,t,i,n=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,i),this._needsUpdate=!0,n||this._focalOffset.copy(this._focalOffsetEnd);const s=!n||Ft(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Ft(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Ft(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}setOrbitPoint(e,t,i){this._camera.updateMatrixWorld(),xs.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Cs.setFromMatrixColumn(this._camera.matrixWorldInverse,1),Gr.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const n=yt.set(e,t,i),s=n.distanceTo(this._camera.position),o=n.sub(this._camera.position);xs.multiplyScalar(o.x),Cs.multiplyScalar(o.y),Gr.multiplyScalar(o.z),yt.copy(xs).add(Cs).add(Gr),yt.z=yt.z+s,this.dollyTo(s,!1),this.setFocalOffset(-yt.x,yt.y,-yt.z,!1),this.moveTo(e,t,i,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,i,n){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new ct.Vector4,typeof e=="number"?this._viewport.set(e,t,i,n):this._viewport.copy(e)}getDistanceToFitBox(e,t,i,n=!1){if(ff(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const s=e/t,o=this._camera.getEffectiveFOV()*$a,a=this._camera.aspect;return((n?s>a:s<a)?t:e/a)*.5/Math.tan(o*.5)+i*.5}getDistanceToFitSphere(e){if(ff(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*$a,i=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,n=1<this._camera.aspect?t:i;return e/Math.sin(n*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new ct.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new ct.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new ct.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new ct.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){return this._sphericalEnd.theta=(this._sphericalEnd.theta%fr+fr)%fr,this._sphericalEnd.theta>Math.PI&&(this._sphericalEnd.theta-=fr),this._spherical.theta+=fr*Math.round((this._sphericalEnd.theta-this._spherical.theta)/fr),this}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!Ft(this._camera.up.x,this._cameraUp0.x)||!Ft(this._camera.up.y,this._cameraUp0.y)||!Ft(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const i=this.getPosition(yt);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,xc),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=yt.subVectors(this._target,this._camera.position).normalize(),t=wt.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(yt);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,n=this._sphericalEnd.radius-this._spherical.radius,s=Jp.subVectors(this._targetEnd,this._target),o=Zp.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(Wt(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=vc(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,h,1/0,e),this._needsUpdate=!0}if(Wt(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=vc(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,h,1/0,e),this._needsUpdate=!0}if(Wt(n))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const h=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=vc(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,h,this.maxSpeed,e),this._needsUpdate=!0}if(Wt(s.x)&&Wt(s.y)&&Wt(s.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const h=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;Xp(this._target,this._targetEnd,this._targetVelocity,h,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(Wt(o.x)&&Wt(o.y)&&Wt(o.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const h=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;Xp(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,h,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(Wt(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const h=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=vc(this._zoom,this._zoomEnd,this._zoomVelocity,h,1/0,e)}if(this.dollyToCursor){if(Nr(this._camera)&&this._changedDolly!==0){const h=this._spherical.radius-this._lastDistance,f=this._camera,d=this._getCameraDirection(ja),m=yt.copy(d).cross(f.up).normalize();m.lengthSq()===0&&(m.x=1);const A=wt.crossVectors(m,d),p=this._sphericalEnd.radius*Math.tan(f.getEffectiveFOV()*$a*.5),E=(this._sphericalEnd.radius-h-this._sphericalEnd.radius)/this._sphericalEnd.radius,v=xo.copy(this._targetEnd).add(m.multiplyScalar(this._dollyControlCoord.x*p*f.aspect)).add(A.multiplyScalar(this._dollyControlCoord.y*p)),x=yt.copy(this._targetEnd).lerp(v,E),C=this._lastDollyDirection===Eo.IN&&this._spherical.radius<=this.minDistance,I=this._lastDollyDirection===Eo.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(C||I)){this._sphericalEnd.radius-=h,this._spherical.radius-=h;const S=wt.copy(d).multiplyScalar(-h);x.add(S)}this._boundary.clampPoint(x,x);const _=wt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(_),this._changedDolly-=h,Wt(this._changedDolly)&&(this._changedDolly=0)}else if(yr(this._camera)&&this._changedZoom!==0){const h=this._zoom-this._lastZoom,f=this._camera,d=yt.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(f.near+f.far)/(f.near-f.far)).unproject(f),m=wt.set(0,0,-1).applyQuaternion(f.quaternion),A=xo.copy(d).add(m.multiplyScalar(-d.dot(f.up))),y=-(this._zoom-h-this._zoom)/this._zoom,E=this._getCameraDirection(ja),v=this._targetEnd.dot(E),x=yt.copy(this._targetEnd).lerp(A,y),C=x.dot(E),I=E.multiplyScalar(C-v);x.sub(I),this._boundary.clampPoint(x,x);const _=wt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(_),this._changedZoom-=h,Wt(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!Wt(this._focalOffset.x)||!Wt(this._focalOffset.y)||!Wt(this._focalOffset.z))&&(xs.setFromMatrixColumn(this._camera.matrix,0),Cs.setFromMatrixColumn(this._camera.matrix,1),Gr.setFromMatrixColumn(this._camera.matrix,2),xs.multiplyScalar(this._focalOffset.x),Cs.multiplyScalar(-this._focalOffset.y),Gr.multiplyScalar(this._focalOffset.z),yt.copy(xs).add(Cs).add(Gr),this._camera.position.add(yt),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),yt.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const u=this._needsUpdate;return u&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):u?(this.dispatchEvent({type:"update"}),Wt(t,this.restThreshold)&&Wt(i,this.restThreshold)&&Wt(n,this.restThreshold)&&Wt(s.x,this.restThreshold)&&Wt(s.y,this.restThreshold)&&Wt(s.z,this.restThreshold)&&Wt(o.x,this.restThreshold)&&Wt(o.y,this.restThreshold)&&Wt(o.z,this.restThreshold)&&Wt(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!u&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=u,this._needsUpdate=!1,u}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:Ya(this.maxDistance),minZoom:this.minZoom,maxZoom:Ya(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:Ya(this.maxPolarAngle),minAzimuthAngle:Ya(this.minAzimuthAngle),maxAzimuthAngle:Ya(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:yt.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const i=JSON.parse(e);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=Wa(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=Wa(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=Wa(i.maxPolarAngle),this.minAzimuthAngle=Wa(i.minAzimuthAngle),this.maxAzimuthAngle=Wa(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],t),Tn.setFromVector3(yt.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Tn.theta,Tn.phi,t),this.dollyTo(Tn.radius,t),this.zoomTo(i.zoom,t),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",X6),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,i){const n=t.lengthSq();if(n===0)return e;const s=wt.copy(t).add(e),a=this._boundary.clampPoint(s,xo).sub(s),l=a.lengthSq();if(l===0)return e.add(t);if(l===n)return e;if(i===0)return e.add(t).add(a);{const c=1+i*l/t.dot(a);return e.add(wt.copy(t).multiplyScalar(c)).add(a.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(Nr(this._camera)){const e=this._camera,t=e.near,i=e.getEffectiveFOV()*$a,n=Math.tan(i*.5)*t,s=n*e.aspect;this._nearPlaneCorners[0].set(-s,-n,0),this._nearPlaneCorners[1].set(s,-n,0),this._nearPlaneCorners[2].set(s,n,0),this._nearPlaneCorners[3].set(-s,n,0)}else if(yr(this._camera)){const e=this._camera,t=1/e.zoom,i=e.left*t,n=e.right*t,s=e.top*t,o=e.bottom*t;this._nearPlaneCorners[0].set(i,s,0),this._nearPlaneCorners[1].set(n,s,0),this._nearPlaneCorners[2].set(n,o,0),this._nearPlaneCorners[3].set(i,o,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||ff(this._camera,"_collisionTest"))return e;const i=this._getTargetDirection(ja);gf.lookAt(qp,i,this._camera.up);for(let n=0;n<4;n++){const s=wt.copy(this._nearPlaneCorners[n]);s.applyMatrix4(gf);const o=xo.addVectors(this._target,s);Cc.set(o,i),Cc.far=this._spherical.radius+1;const a=Cc.intersectObjects(this.colliderMeshes);a.length!==0&&a[0].distance<e&&(e=a[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const i=()=>{this.removeEventListener("rest",i),t()};this.addEventListener("rest",i)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new ct.Sphere){const i=t,n=i.center;Io.makeEmpty(),e.traverseVisible(o=>{o.isMesh&&Io.expandByObject(o)}),Io.getCenter(n);let s=0;return e.traverseVisible(o=>{if(!o.isMesh)return;const a=o;if(!a.geometry)return;const l=a.geometry.clone();l.applyMatrix4(a.matrixWorld);const u=l.attributes.position;for(let h=0,f=u.count;h<f;h++)yt.fromBufferAttribute(u,h),s=Math.max(s,n.distanceToSquared(yt))}),i.radius=Math.sqrt(s),i}};const iP=g.forwardRef((r,e)=>{const{impl:t,camera:i,domElement:n,makeDefault:s,onControlStart:o,onControl:a,onControlEnd:l,onTransitionStart:c,onUpdate:u,onWake:h,onRest:f,onSleep:d,onStart:m,onEnd:A,onChange:p,regress:y,...E}=r,v=t??J6;g.useMemo(()=>{const k={Box3:Yt,MathUtils:{clamp:et.clamp},Matrix4:we,Quaternion:nt,Raycaster:Ku,Sphere:on,Spherical:aa,Vector2:De,Vector3:z,Vector4:Ci};v.install({THREE:k}),Ii({CameraControlsImpl:v})},[v]);const x=le(k=>k.camera),C=le(k=>k.gl),I=le(k=>k.invalidate),_=le(k=>k.events),S=le(k=>k.setEvents),b=le(k=>k.set),T=le(k=>k.get),R=le(k=>k.performance),w=i||x,B=n||_.connected||C.domElement,D=g.useMemo(()=>new v(w),[v,w]);return He((k,Q)=>{D.update(Q)},-1),g.useEffect(()=>(D.connect(B),()=>void D.disconnect()),[B,D]),g.useEffect(()=>{function k(){I(),y&&R.regress()}const Q=G=>{k(),o==null||o(G),m==null||m(G)},Y=G=>{k(),a==null||a(G),p==null||p(G)},W=G=>{l==null||l(G),A==null||A(G)},P=G=>{k(),c==null||c(G),p==null||p(G)},K=G=>{k(),u==null||u(G),p==null||p(G)},M=G=>{k(),h==null||h(G),p==null||p(G)},V=G=>{f==null||f(G)},$=G=>{d==null||d(G)};return D.addEventListener("controlstart",Q),D.addEventListener("control",Y),D.addEventListener("controlend",W),D.addEventListener("transitionstart",P),D.addEventListener("update",K),D.addEventListener("wake",M),D.addEventListener("rest",V),D.addEventListener("sleep",$),()=>{D.removeEventListener("controlstart",Q),D.removeEventListener("control",Y),D.removeEventListener("controlend",W),D.removeEventListener("transitionstart",P),D.removeEventListener("update",K),D.removeEventListener("wake",M),D.removeEventListener("rest",V),D.removeEventListener("sleep",$)}},[D,I,S,y,R,o,a,l,c,u,h,f,d,p,m,A]),g.useEffect(()=>{if(s){const k=T().controls;return b({controls:D}),()=>b({controls:k})}},[s,D]),g.createElement("primitive",Ae({ref:e,object:D},E))}),Z6=r=>(r==null?void 0:r.current)instanceof mi,Hv=g.createContext(null);function eb(){const r=g.useContext(Hv);if(!r)throw new Error("useMotion hook must be used in a MotionPathControls component.");return r}function tb({points:r=50,color:e="black"}){const{path:t}=eb(),[i,n]=g.useState([]),s=g.useMemo(()=>new ds({color:e}),[e]),o=g.useMemo(()=>new Hy(.025,16,16),[]),a=g.useRef([]);return g.useEffect(()=>{t.curves!==a.current&&(n(t.getPoints(r)),a.current=t.curves)}),i.map((l,c)=>g.createElement("mesh",{key:c,material:s,geometry:o,position:[l.x,l.y,l.z]}))}const nP=g.forwardRef(({children:r,curves:e=[],debug:t=!1,debugColor:i="black",object:n,focus:s,loop:o=!0,offset:a=void 0,smooth:l=!1,eps:c=1e-5,damping:u=.1,focusDamping:h=.1,maxSpeed:f=1/0,...d},m)=>{const{camera:A}=le(),p=g.useRef(null),y=g.useRef(a??0),E=g.useMemo(()=>new cC,[]),v=g.useMemo(()=>({focus:s,object:(n==null?void 0:n.current)instanceof mi?n:{current:A},path:E,current:y.current,offset:y.current,point:new z,tangent:new z,next:new z}),[s,n]),x=uC(p);g.useLayoutEffect(()=>{const I=x.current;E.curves=[];const _=e.length>0?e:I.children.map(S=>S.object);for(let S=0;S<_.length;S++)E.add(_[S]);if(l){const S=E.getPoints(typeof l=="number"?l:1),b=new e2(S);E.curves=[b]}E.updateArcLengths()}),g.useImperativeHandle(m,()=>Object.assign(p.current,{motion:v}),[v]),g.useLayoutEffect(()=>{y.current=ic.repeat(y.current,1)},[a]);const C=g.useMemo(()=>new z,[]);return He((I,_)=>{const S=v.offset;if(wr.damp(y,"current",a!==void 0?a:v.current,u,_,f,void 0,c),v.offset=o?ic.repeat(y.current,1):ic.clamp(y.current,0,1),E.getCurveLengths().length>0){E.getPointAt(v.offset,v.point),E.getTangentAt(v.offset,v.tangent).normalize(),E.getPointAt(ic.repeat(y.current-(S-v.offset),1),v.next);const b=(n==null?void 0:n.current)instanceof mi?n.current:A;b.position.copy(v.point),s&&wr.dampLookAt(b,Z6(s)?s.current.getWorldPosition(C):s,h,_,f,void 0,c)}}),g.createElement("group",Ae({ref:p},d),g.createElement(Hv.Provider,{value:v},r,t&&g.createElement(tb,{color:i})))});function ib({defaultScene:r,defaultCamera:e,renderPriority:t=1}){const{gl:i,scene:n,camera:s}=le();let o;return He(()=>{o=i.autoClear,t===1&&(i.autoClear=!0,i.render(r,e)),i.autoClear=!1,i.clearDepth(),i.render(n,s),i.autoClear=o},t),g.createElement("group",{onPointerOver:()=>null})}function nb({children:r,renderPriority:e=1}){const{scene:t,camera:i}=le(),[n]=g.useState(()=>new Mr);return g.createElement(g.Fragment,null,so(g.createElement(g.Fragment,null,r,g.createElement(ib,{defaultScene:t,defaultCamera:i,renderPriority:e})),n,{events:{priority:e+1}}))}const Vv=g.createContext({}),$0=()=>g.useContext(Vv),sb=2*Math.PI,yf=new mi,ig=new we,[_o,vf]=[new nt,new nt],ng=new z,sg=new z,rb=r=>"minPolarAngle"in r,rg=r=>"getTarget"in r,sP=({alignment:r="bottom-right",margin:e=[80,80],renderPriority:t=1,onUpdate:i,onTarget:n,children:s})=>{const o=le(I=>I.size),a=le(I=>I.camera),l=le(I=>I.controls),c=le(I=>I.invalidate),u=g.useRef(null),h=g.useRef(null),f=g.useRef(!1),d=g.useRef(0),m=g.useRef(new z(0,0,0)),A=g.useRef(new z(0,0,0));g.useEffect(()=>{A.current.copy(a.up),yf.up.copy(a.up)},[a]);const p=g.useCallback(I=>{f.current=!0,(l||n)&&(m.current=(n==null?void 0:n())||(rg(l)?l.getTarget(m.current):l==null?void 0:l.target)),d.current=a.position.distanceTo(ng),_o.copy(a.quaternion),sg.copy(I).multiplyScalar(d.current).add(ng),yf.lookAt(sg),vf.copy(yf.quaternion),c()},[l,a,n,c]);He((I,_)=>{if(h.current&&u.current){var S;if(f.current)if(_o.angleTo(vf)<.01)f.current=!1,rb(l)&&a.up.copy(A.current);else{const b=_*sb;_o.rotateTowards(vf,b),a.position.set(0,0,1).applyQuaternion(_o).multiplyScalar(d.current).add(m.current),a.up.set(0,1,0).applyQuaternion(_o).normalize(),a.quaternion.copy(_o),rg(l)&&l.setPosition(a.position.x,a.position.y,a.position.z),i?i():l&&l.update(_),c()}ig.copy(a.matrix).invert(),(S=u.current)==null||S.quaternion.setFromRotationMatrix(ig)}});const y=g.useMemo(()=>({tweenCamera:p}),[p]),[E,v]=e,x=r.endsWith("-center")?0:r.endsWith("-left")?-o.width/2+E:o.width/2-E,C=r.startsWith("center-")?0:r.startsWith("top-")?o.height/2-v:-o.height/2+v;return g.createElement(nb,{renderPriority:t},g.createElement(Vv.Provider,{value:y},g.createElement($6,{makeDefault:!0,ref:h,position:[0,0,200]}),g.createElement("group",{ref:u,position:[x,C,0]},s)))},dl={bg:"#f0f0f0",hover:"#999",text:"black",stroke:"black"},ob=["Right","Left","Top","Bottom","Front","Back"],Kv=r=>new z(...r).multiplyScalar(.38),ab=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(Kv),lb=[.25,.25,.25],$v=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(Kv),cb=$v.map(r=>r.toArray().map(e=>e==0?.5:.25)),ub=({hover:r,index:e,font:t="20px Inter var, Arial, sans-serif",faces:i=ob,color:n=dl.bg,hoverColor:s=dl.hover,textColor:o=dl.text,strokeColor:a=dl.stroke,opacity:l=1})=>{const c=le(h=>h.gl),u=g.useMemo(()=>{const h=document.createElement("canvas");h.width=128,h.height=128;const f=h.getContext("2d");return f.fillStyle=n,f.fillRect(0,0,h.width,h.height),f.strokeStyle=a,f.strokeRect(0,0,h.width,h.height),f.font=t,f.textAlign="center",f.fillStyle=o,f.fillText(i[e].toUpperCase(),64,76),new o2(h)},[e,i,t,n,o,a]);return g.createElement("meshBasicMaterial",{map:u,"map-anisotropy":c.capabilities.getMaxAnisotropy()||1,attach:`material-${e}`,color:r?s:"white",transparent:!0,opacity:l})},hb=r=>{const{tweenCamera:e}=$0(),[t,i]=g.useState(null),n=a=>{a.stopPropagation(),i(null)},s=a=>{a.stopPropagation(),e(a.face.normal)},o=a=>{a.stopPropagation(),i(Math.floor(a.faceIndex/2))};return g.createElement("mesh",{onPointerOut:n,onPointerMove:o,onClick:r.onClick||s},[...Array(6)].map((a,l)=>g.createElement(ub,Ae({key:l,index:l,hover:t===l},r))),g.createElement("boxGeometry",null))},og=({onClick:r,dimensions:e,position:t,hoverColor:i=dl.hover})=>{const{tweenCamera:n}=$0(),[s,o]=g.useState(!1),a=u=>{u.stopPropagation(),o(!1)},l=u=>{u.stopPropagation(),o(!0)},c=u=>{u.stopPropagation(),n(t)};return g.createElement("mesh",{scale:1.01,position:t,onPointerOver:l,onPointerOut:a,onClick:r||c},g.createElement("meshBasicMaterial",{color:s?i:"white",transparent:!0,opacity:.6,visible:s}),g.createElement("boxGeometry",{args:e}))},rP=r=>g.createElement("group",{scale:[60,60,60]},g.createElement(hb,r),$v.map((e,t)=>g.createElement(og,Ae({key:t,position:e,dimensions:cb[t]},r))),ab.map((e,t)=>g.createElement(og,Ae({key:t,position:e,dimensions:lb},r))));function Ef({scale:r=[.8,.05,.05],color:e,rotation:t}){return g.createElement("group",{rotation:t},g.createElement("mesh",{position:[.4,0,0]},g.createElement("boxGeometry",{args:r}),g.createElement("meshBasicMaterial",{color:e,toneMapped:!1})))}function So({onClick:r,font:e,disabled:t,arcStyle:i,label:n,labelColor:s,axisHeadScale:o=1,...a}){const l=le(A=>A.gl),c=g.useMemo(()=>{const A=document.createElement("canvas");A.width=64,A.height=64;const p=A.getContext("2d");return p.beginPath(),p.arc(32,32,16,0,2*Math.PI),p.closePath(),p.fillStyle=i,p.fill(),n&&(p.font=e,p.textAlign="center",p.fillStyle=s,p.fillText(n,32,41)),new o2(A)},[i,n,s,e]),[u,h]=g.useState(!1),f=(n?1:.75)*(u?1.2:1)*o,d=A=>{A.stopPropagation(),h(!0)},m=A=>{A.stopPropagation(),h(!1)};return g.createElement("sprite",Ae({scale:f,onPointerOver:t?void 0:d,onPointerOut:t?void 0:r||m},a),g.createElement("spriteMaterial",{map:c,"map-anisotropy":l.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:n?1:.75,toneMapped:!1}))}const oP=({hideNegativeAxes:r,hideAxisHeads:e,disabled:t,font:i="18px Inter var, Arial, sans-serif",axisColors:n=["#ff2060","#20df80","#2080ff"],axisHeadScale:s=1,axisScale:o,labels:a=["X","Y","Z"],labelColor:l="#000",onClick:c,...u})=>{const[h,f,d]=n,{tweenCamera:m}=$0(),A={font:i,disabled:t,labelColor:l,onClick:c,axisHeadScale:s,onPointerDown:t?void 0:p=>{m(p.object.position),p.stopPropagation()}};return g.createElement("group",Ae({scale:40},u),g.createElement(Ef,{color:h,rotation:[0,0,0],scale:o}),g.createElement(Ef,{color:f,rotation:[0,0,Math.PI/2],scale:o}),g.createElement(Ef,{color:d,rotation:[0,-Math.PI/2,0],scale:o}),!e&&g.createElement(g.Fragment,null,g.createElement(So,Ae({arcStyle:h,position:[1,0,0],label:a[0]},A)),g.createElement(So,Ae({arcStyle:f,position:[0,1,0],label:a[1]},A)),g.createElement(So,Ae({arcStyle:d,position:[0,0,1],label:a[2]},A)),!r&&g.createElement(g.Fragment,null,g.createElement(So,Ae({arcStyle:h,position:[-1,0,0]},A)),g.createElement(So,Ae({arcStyle:f,position:[0,-1,0]},A)),g.createElement(So,Ae({arcStyle:d,position:[0,0,-1]},A)))))},fb=ps({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new Ye,sectionColor:new Ye,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new z,worldPlanePosition:new z},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),aP=g.forwardRef(({args:r,cellColor:e="#000000",sectionColor:t="#2080ff",cellSize:i=.5,sectionSize:n=1,followCamera:s=!1,infiniteGrid:o=!1,fadeDistance:a=100,fadeStrength:l=1,fadeFrom:c=1,cellThickness:u=.5,sectionThickness:h=1,side:f=ma,...d},m)=>{Ii({GridMaterial:fb});const A=g.useRef(null);g.useImperativeHandle(m,()=>A.current,[]);const p=new or,y=new z(0,1,0),E=new z(0,0,0);He(C=>{p.setFromNormalAndCoplanarPoint(y,E).applyMatrix4(A.current.matrixWorld);const I=A.current.material,_=I.uniforms.worldCamProjPosition,S=I.uniforms.worldPlanePosition;p.projectPoint(C.camera.position,_.value),S.value.set(0,0,0).applyMatrix4(A.current.matrixWorld)});const v={cellSize:i,sectionSize:n,cellColor:e,sectionColor:t,cellThickness:u,sectionThickness:h},x={fadeDistance:a,fadeStrength:l,fadeFrom:c,infiniteGrid:o,followCamera:s};return g.createElement("mesh",Ae({ref:A,frustumCulled:!1},d),g.createElement("gridMaterial",Ae({transparent:!0,"extensions-derivatives":!0,side:f},v,x)),g.createElement("planeGeometry",{args:r}))});function Yv(r,{path:e}){const[t]=oi(D0,[r],i=>i.setPath(e));return t}Yv.preload=(r,{path:e})=>oi.preload(D0,[r],t=>t.setPath(e));function lP({children:r,files:e,...t}){const i=Yv(e,{...t});return g.createElement(g.Fragment,null,r==null?void 0:r(i))}function Y0(r){return oi(N0,r)}Y0.preload=r=>oi.preload(N0,r);Y0.clear=r=>oi.clear(N0,r);function cP({path:r,...e}){const i=Y0(r).children[0];return g.createElement(Lu,Ae({},e,{object:i}))}const Wv="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function W0(r,e=`${Wv}/basis/`){const t=le(n=>n.gl),i=oi(Q0,xl(r)?Object.values(r):r,n=>{n.detectSupport(t),n.setTranscoderPath(e)});if(g.useEffect(()=>{(Array.isArray(i)?i:[i]).forEach(t.initTexture)},[t,i]),xl(r)){const n=Object.keys(r),s={};return n.forEach(o=>Object.assign(s,{[o]:i[n.indexOf(o)]})),s}else return i}W0.preload=(r,e=`${Wv}/basis/`)=>oi.preload(Q0,r,t=>{t.setTranscoderPath(e)});W0.clear=r=>oi.clear(Q0,r);const uP=({children:r,input:e,basisPath:t})=>{const i=W0(e,t);return g.createElement(g.Fragment,null,r==null?void 0:r(i))},ze=Number.isFinite||function(r){return typeof r=="number"&&isFinite(r)},db=Number.isSafeInteger||function(r){return typeof r=="number"&&Math.abs(r)<=mb},mb=Number.MAX_SAFE_INTEGER||9007199254740991;let qe=function(r){return r.NETWORK_ERROR="networkError",r.MEDIA_ERROR="mediaError",r.KEY_SYSTEM_ERROR="keySystemError",r.MUX_ERROR="muxError",r.OTHER_ERROR="otherError",r}({}),ue=function(r){return r.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",r.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",r.KEY_SYSTEM_NO_SESSION="keySystemNoSession",r.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",r.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",r.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",r.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",r.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",r.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",r.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",r.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",r.MANIFEST_LOAD_ERROR="manifestLoadError",r.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",r.MANIFEST_PARSING_ERROR="manifestParsingError",r.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",r.LEVEL_EMPTY_ERROR="levelEmptyError",r.LEVEL_LOAD_ERROR="levelLoadError",r.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",r.LEVEL_PARSING_ERROR="levelParsingError",r.LEVEL_SWITCH_ERROR="levelSwitchError",r.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",r.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",r.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",r.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",r.FRAG_LOAD_ERROR="fragLoadError",r.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",r.FRAG_DECRYPT_ERROR="fragDecryptError",r.FRAG_PARSING_ERROR="fragParsingError",r.FRAG_GAP="fragGap",r.REMUX_ALLOC_ERROR="remuxAllocError",r.KEY_LOAD_ERROR="keyLoadError",r.KEY_LOAD_TIMEOUT="keyLoadTimeOut",r.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",r.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",r.BUFFER_APPEND_ERROR="bufferAppendError",r.BUFFER_APPENDING_ERROR="bufferAppendingError",r.BUFFER_STALLED_ERROR="bufferStalledError",r.BUFFER_FULL_ERROR="bufferFullError",r.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",r.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",r.ASSET_LIST_LOAD_ERROR="assetListLoadError",r.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",r.ASSET_LIST_PARSING_ERROR="assetListParsingError",r.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",r.INTERNAL_EXCEPTION="internalException",r.INTERNAL_ABORTED="aborted",r.ATTACH_MEDIA_ERROR="attachMediaError",r.UNKNOWN="unknown",r}({}),L=function(r){return r.MEDIA_ATTACHING="hlsMediaAttaching",r.MEDIA_ATTACHED="hlsMediaAttached",r.MEDIA_DETACHING="hlsMediaDetaching",r.MEDIA_DETACHED="hlsMediaDetached",r.MEDIA_ENDED="hlsMediaEnded",r.STALL_RESOLVED="hlsStallResolved",r.BUFFER_RESET="hlsBufferReset",r.BUFFER_CODECS="hlsBufferCodecs",r.BUFFER_CREATED="hlsBufferCreated",r.BUFFER_APPENDING="hlsBufferAppending",r.BUFFER_APPENDED="hlsBufferAppended",r.BUFFER_EOS="hlsBufferEos",r.BUFFERED_TO_END="hlsBufferedToEnd",r.BUFFER_FLUSHING="hlsBufferFlushing",r.BUFFER_FLUSHED="hlsBufferFlushed",r.MANIFEST_LOADING="hlsManifestLoading",r.MANIFEST_LOADED="hlsManifestLoaded",r.MANIFEST_PARSED="hlsManifestParsed",r.LEVEL_SWITCHING="hlsLevelSwitching",r.LEVEL_SWITCHED="hlsLevelSwitched",r.LEVEL_LOADING="hlsLevelLoading",r.LEVEL_LOADED="hlsLevelLoaded",r.LEVEL_UPDATED="hlsLevelUpdated",r.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",r.LEVELS_UPDATED="hlsLevelsUpdated",r.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",r.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",r.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",r.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",r.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",r.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",r.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",r.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",r.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",r.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",r.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",r.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",r.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",r.CUES_PARSED="hlsCuesParsed",r.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",r.INIT_PTS_FOUND="hlsInitPtsFound",r.FRAG_LOADING="hlsFragLoading",r.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",r.FRAG_LOADED="hlsFragLoaded",r.FRAG_DECRYPTED="hlsFragDecrypted",r.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",r.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",r.FRAG_PARSING_METADATA="hlsFragParsingMetadata",r.FRAG_PARSED="hlsFragParsed",r.FRAG_BUFFERED="hlsFragBuffered",r.FRAG_CHANGED="hlsFragChanged",r.FPS_DROP="hlsFpsDrop",r.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",r.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",r.ERROR="hlsError",r.DESTROYING="hlsDestroying",r.KEY_LOADING="hlsKeyLoading",r.KEY_LOADED="hlsKeyLoaded",r.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",r.BACK_BUFFER_REACHED="hlsBackBufferReached",r.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",r.ASSET_LIST_LOADING="hlsAssetListLoading",r.ASSET_LIST_LOADED="hlsAssetListLoaded",r.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",r.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",r.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",r.INTERSTITIAL_STARTED="hlsInterstitialStarted",r.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",r.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",r.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",r.INTERSTITIAL_ENDED="hlsInterstitialEnded",r.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",r.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",r.EVENT_CUE_ENTER="hlsEventCueEnter",r}({});var xt={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},$e={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class To{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Ab{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new To(e),this.fast_=new To(t),this.defaultTTFB_=n,this.ttfb_=new To(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:s}=this;i.halfLife!==e&&(this.slow_=new To(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new To(t,n.getEstimate(),n.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new To(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,s=i/n;this.fast_.sample(n,s),this.slow_.sample(n,s)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function pb(r,e,t){return(e=yb(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Vt(){return Vt=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},Vt.apply(null,arguments)}function ag(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function zt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ag(Object(t),!0).forEach(function(i){pb(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ag(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function gb(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function yb(r){var e=gb(r,"string");return typeof e=="symbol"?e:e+""}class gs{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Er,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Er=function(){},vb={trace:Er,debug:Er,log:Er,warn:Er,info:Er,error:Er};function Wd(){return Vt({},vb)}function Eb(r,e){const t=self.console[r];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${r}] >`):Er}function lg(r,e,t){return e[r]?e[r].bind(e):Eb(r,t)}const jd=Wd();function xb(r,e,t){const i=Wd();if(typeof console=="object"&&r===!0||typeof r=="object"){const n=["debug","log","info","warn","error"];n.forEach(s=>{i[s]=lg(s,r,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.10`)}catch{return Wd()}n.forEach(s=>{jd[s]=lg(s,r)})}else Vt(jd,i);return i}const Gt=jd;function sr(r=!0){return typeof self>"u"?void 0:(r||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function Cb(r){return typeof self<"u"&&r===self.ManagedMediaSource}function jv(r,e){const t=Object.keys(r),i=Object.keys(e),n=t.length,s=i.length;return!n||!s||n===s&&!t.some(o=>i.indexOf(o)===-1)}function Ln(r,e=!1){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(r);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const t=r.length;let i,n,s,o="",a=0;for(;a<t;){if(i=r[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:n=r[a++],o+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=r[a++],s=r[a++],o+=String.fromCharCode((i&15)<<12|(n&63)<<6|(s&63)<<0);break}}return o}const Xs={hexDump:function(r){let e="";for(let t=0;t<r.length;t++){let i=r[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function Xv(r){return Uint8Array.from(r.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function Ib(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var xf={exports:{}},cg;function _b(){return cg||(cg=1,function(r,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var h=a.parseURL(l);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var f=a.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=a.normalizePath(f.path),a.buildURLFromParts(f)):c;var d=a.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var m=n.exec(d.path);d.netLoc=m[1],d.path=m[2]}d.netLoc&&!d.path&&(d.path="/");var A={scheme:d.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(A.netLoc=d.netLoc,f.path[0]!=="/"))if(!f.path)A.path=d.path,f.params||(A.params=d.params,f.query||(A.query=d.query));else{var p=d.path,y=p.substring(0,p.lastIndexOf("/")+1)+f.path;A.path=a.normalizePath(y)}return A.path===null&&(A.path=u.alwaysNormalize?a.normalizePath(f.path):f.path),a.buildURLFromParts(A)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(s,"");l.length!==(l=l.replace(o,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};r.exports=a})()}(xf)),xf.exports}var j0=_b();class nh{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var $t={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class X0{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,Sb(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let n;i.length===1?n=(t==null?void 0:t.byteRangeEndOffset)||0:n=parseInt(i[1]),this._byteRange=[n,parseInt(i[0])+n]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[$t.AUDIO]:null,[$t.VIDEO]:null,[$t.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new nh),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=j0.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[$t.AUDIO]=null,e[$t.VIDEO]=null,e[$t.AUDIOVIDEO]=null}}function bi(r){return r.sn!=="initSegment"}class Au extends X0{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange.length){const e=this.byteRange[0],t=this.byteRange[1];if(ze(e)&&ze(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1){const n=this._decryptdata=this.levelkeys[i[0]]||null;if(n)return n.getDecryptData(this.sn)}}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=ze(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;const i=Object.keys(this.levelkeys),n=i.length;if(n>1||n===1&&(t=this.levelkeys[i[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!ze(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return bi(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,n,s,o=!1){const{elementaryStreams:a}=this,l=a[e];if(!l){a[e]={startPTS:t,endPTS:i,startDTS:n,endDTS:s,partial:o};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,n),l.endDTS=Math.max(l.endDTS,s)}}class qv extends X0{constructor(e,t,i,n,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=n;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function Jv(r,e){const t=Object.getPrototypeOf(r);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||Jv(t,e)}}function Sb(r,e){const t=Jv(r,e);t&&(t.enumerable=!0,Object.defineProperty(r,e,t))}const ug=Math.pow(2,32)-1,Tb=[].push,Zv={video:1,audio:2,id3:3,text:4};function Pi(r){return String.fromCharCode.apply(null,r)}function eE(r,e){const t=r[e]<<8|r[e+1];return t<0?65536+t:t}function ut(r,e){const t=tE(r,e);return t<0?4294967296+t:t}function hg(r,e){let t=ut(r,e);return t*=Math.pow(2,32),t+=ut(r,e+4),t}function tE(r,e){return r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3]}function bb(r){const e=r.byteLength;for(let t=0;t<e;){const i=ut(r,t);if(i>8&&r[t+4]===109&&r[t+5]===111&&r[t+6]===111&&r[t+7]===102)return!0;t=i>1?t+i:e}return!1}function Et(r,e){const t=[];if(!e.length)return t;const i=r.byteLength;for(let n=0;n<i;){const s=ut(r,n),o=Pi(r.subarray(n+4,n+8)),a=s>1?n+s:i;if(o===e[0])if(e.length===1)t.push(r.subarray(n+8,a));else{const l=Et(r.subarray(n+8,a),e.slice(1));l.length&&Tb.apply(t,l)}n=a}return t}function wb(r){const e=[],t=r[0];let i=8;const n=ut(r,i);i+=4;let s=0,o=0;t===0?(s=ut(r,i),o=ut(r,i+4),i+=8):(s=hg(r,i),o=hg(r,i+8),i+=16),i+=2;let a=r.length+o;const l=eE(r,i);i+=2;for(let c=0;c<l;c++){let u=i;const h=ut(r,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return Gt.warn("SIDX has hierarchical references (not supported)"),null;const m=ut(r,u);u+=4,e.push({referenceSize:f,subsegmentDuration:m,info:{duration:m/n,start:a,end:a+f-1}}),a+=f,u+=4,i=u}return{earliestPresentationTime:s,timescale:n,version:t,referencesCount:l,references:e}}function iE(r){const e=[],t=Et(r,["moov","trak"]);for(let n=0;n<t.length;n++){const s=t[n],o=Et(s,["tkhd"])[0];if(o){let a=o[0];const l=ut(o,a===0?12:20),c=Et(s,["mdia","mdhd"])[0];if(c){a=c[0];const u=ut(c,a===0?12:20),h=Et(s,["mdia","hdlr"])[0];if(h){const f=Pi(h.subarray(8,12)),d={soun:$t.AUDIO,vide:$t.VIDEO}[f],m=Et(s,["mdia","minf","stbl","stsd"])[0],A=Bb(m);d?(e[l]={timescale:u,type:d,stsd:A},e[d]=zt({timescale:u,id:l},A)):e[l]={timescale:u,type:f,stsd:A}}}}}return Et(r,["moov","mvex","trex"]).forEach(n=>{const s=ut(n,4),o=e[s];o&&(o.default={duration:ut(n,12),flags:ut(n,20)})}),e}function Bb(r){const e=r.subarray(8),t=e.subarray(8+78),i=Pi(e.subarray(4,8));let n=i,s;const o=i==="enca"||i==="encv";if(o){const c=Et(e,[i])[0].subarray(i==="enca"?28:78);Et(c,["sinf"]).forEach(h=>{const f=Et(h,["schm"])[0];if(f){const d=Pi(f.subarray(4,8));if(d==="cbcs"||d==="cenc"){const m=Et(h,["frma"])[0];m&&(n=Pi(m))}}})}const a=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const l=Et(t,["avcC"])[0];l&&l.length>3&&(n+="."+_c(l[1])+_c(l[2])+_c(l[3]),s=Ic(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=Et(e,[i])[0],c=Et(l.subarray(28),["esds"])[0];if(c&&c.length>7){let u=4;if(c[u++]!==3)break;u=Cf(c,u),u+=2;const h=c[u++];if(h&128&&(u+=2),h&64&&(u+=c[u++]),c[u++]!==4)break;u=Cf(c,u);const f=c[u++];if(f===64)n+="."+_c(f);else break;if(u+=12,c[u++]!==5)break;u=Cf(c,u);const d=c[u++];let m=(d&248)>>3;m===31&&(m+=1+((d&7)<<3)+((c[u]&224)>>5)),n+="."+m}break}case"hvc1":case"hev1":{const l=Et(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],u=["","A","B","C"][c>>6],h=c&31,f=ut(l,2),d=(c&32)>>5?"H":"L",m=l[12],A=l.subarray(6,12);n+="."+u+h,n+="."+Rb(f).toString(16).toUpperCase(),n+="."+d+m;let p="";for(let y=A.length;y--;){const E=A[y];(E||p)&&(p="."+E.toString(16).toUpperCase()+p)}n+=p}s=Ic(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=Ic(n,t)||n;break}case"vp09":{const l=Et(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],u=l[5],h=l[6]>>4&15;n+="."+Ts(c)+"."+Ts(u)+"."+Ts(h)}break}case"av01":{const l=Et(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,u=l[1]&31,h=l[2]>>>7?"H":"M",f=(l[2]&64)>>6,d=(l[2]&32)>>5,m=c===2&&f?d?12:10:f?10:8,A=(l[2]&16)>>4,p=(l[2]&8)>>3,y=(l[2]&4)>>2,E=l[2]&3,v=1,x=1,C=1,I=0;n+="."+c+"."+Ts(u)+h+"."+Ts(m)+"."+A+"."+p+y+E+"."+Ts(v)+"."+Ts(x)+"."+Ts(C)+"."+I,s=Ic("dav1",t)}break}}return{codec:n,encrypted:o,supplemental:s}}function Ic(r,e){const t=Et(e,["dvvC"]),i=t.length?t[0]:Et(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,s=i[2]<<5&32|i[3]>>3&31;return r+"."+Ts(n)+"."+Ts(s)}}function Rb(r){let e=0;for(let t=0;t<32;t++)e|=(r>>t&1)<<32-1-t;return e>>>0}function Cf(r,e){const t=e+5;for(;r[e++]&128&&e<t;);return e}function _c(r){return("0"+r.toString(16).toUpperCase()).slice(-2)}function Ts(r){return(r<10?"0":"")+r}function Db(r,e){if(!r||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&Et(r,["moov","trak"]).forEach(n=>{const o=Et(n,["mdia","minf","stbl","stsd"])[0].subarray(8);let a=Et(o,["enca"]);const l=a.length>0;l||(a=Et(o,["encv"])),a.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);Et(u,["sinf"]).forEach(f=>{const d=nE(f);if(d){const m=d.subarray(8,24);m.some(A=>A!==0)||(Gt.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${Xs.hexDump(m)} -> ${Xs.hexDump(t)}`),d.set(t,8))}})})})}function nE(r){const e=Et(r,["schm"])[0];if(e){const t=Pi(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return Et(r,["schi","tenc"])[0]}return null}function Mb(r,e,t){const i={},n=Et(r,["moof","traf"]);for(let s=0;s<n.length;s++){const o=n[s],a=Et(o,["tfhd"])[0],l=ut(a,4),c=e[l];if(!c)continue;i[l]||(i[l]={start:NaN,duration:0,sampleCount:0,timescale:c.timescale,type:c.type});const u=i[l],h=Et(o,["tfdt"])[0];if(h){const v=h[0];let x=ut(h,4);v===1&&(x===ug?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(x*=ug+1,x+=ut(h,8))),ze(x)&&(!ze(u.start)||x<u.start)&&(u.start=x)}const f=c.default,d=ut(a,0)|(f==null?void 0:f.flags);let m=(f==null?void 0:f.duration)||0;d&8&&(d&2?m=ut(a,12):m=ut(a,8));const A=Et(o,["trun"]);let p=u.start||0,y=0,E=m;for(let v=0;v<A.length;v++){const x=A[v],C=ut(x,4),I=u.sampleCount;u.sampleCount+=C;const _=x[3]&1,S=x[3]&4,b=x[2]&1,T=x[2]&2,R=x[2]&4,w=x[2]&8;let B=8,D=C;for(_&&(B+=4),S&&C&&(!(x[B+1]&1)&&u.keyFrameIndex===void 0&&(u.keyFrameIndex=I),B+=4,b?(E=ut(x,B),B+=4):E=m,T&&(B+=4),w&&(B+=4),p+=E,y+=E,D--);D--;)b?(E=ut(x,B),B+=4):E=m,T&&(B+=4),R&&(x[B+1]&1||u.keyFrameIndex===void 0&&(u.keyFrameIndex=u.sampleCount-(D+1),u.keyFrameStart=p),B+=4),w&&(B+=4),p+=E,y+=E;!y&&m&&(y+=m*C)}u.duration+=y}if(!Object.keys(i).some(s=>i[s].duration)){let s=1/0,o=0;const a=Et(r,["sidx"]);for(let l=0;l<a.length;l++){const c=wb(a[l]);if(c!=null&&c.references){s=Math.min(s,c.earliestPresentationTime/c.timescale);const u=c.references.reduce((h,f)=>h+f.info.duration||0,0);o=Math.max(o,u+c.earliestPresentationTime/c.timescale)}}o&&ze(o)&&Object.keys(i).forEach(l=>{i[l].duration||(i[l].duration=o*i[l].timescale-i[l].start)})}return i}function Lb(r){const e={valid:null,remainder:null},t=Et(r,["moof"]);if(t.length<2)return e.remainder=r,e;const i=t[t.length-1];return e.valid=r.slice(0,i.byteOffset-8),e.remainder=r.slice(i.byteOffset-8),e}function Jn(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function fg(r,e){const t=[],i=e.samples,n=e.timescale,s=e.id;let o=!1;return Et(i,["moof"]).map(l=>{const c=l.byteOffset-8;Et(l,["traf"]).map(h=>{const f=Et(h,["tfdt"]).map(d=>{const m=d[0];let A=ut(d,4);return m===1&&(A*=Math.pow(2,32),A+=ut(d,8)),A/n})[0];return f!==void 0&&(r=f),Et(h,["tfhd"]).map(d=>{const m=ut(d,4),A=ut(d,0)&16777215,p=(A&1)!==0,y=(A&2)!==0,E=(A&8)!==0;let v=0;const x=(A&16)!==0;let C=0;const I=(A&32)!==0;let _=8;m===s&&(p&&(_+=8),y&&(_+=4),E&&(v=ut(d,_),_+=4),x&&(C=ut(d,_),_+=4),I&&(_+=4),e.type==="video"&&(o=sh(e.codec)),Et(h,["trun"]).map(S=>{const b=S[0],T=ut(S,0)&16777215,R=(T&1)!==0;let w=0;const B=(T&4)!==0,D=(T&256)!==0;let k=0;const Q=(T&512)!==0;let Y=0;const W=(T&1024)!==0,P=(T&2048)!==0;let K=0;const M=ut(S,4);let V=8;R&&(w=ut(S,V),V+=4),B&&(V+=4);let $=w+c;for(let G=0;G<M;G++){if(D?(k=ut(S,V),V+=4):k=v,Q?(Y=ut(S,V),V+=4):Y=C,W&&(V+=4),P&&(b===0?K=ut(S,V):K=tE(S,V),V+=4),e.type===$t.VIDEO){let O=0;for(;O<Y;){const F=ut(i,$);if($+=4,Pb(o,i[$])){const U=i.subarray($,$+F);q0(U,o?2:1,r+K/n,t)}$+=F,O+=F+4}}r+=k/n}}))})})}),t}function sh(r){if(!r)return!1;const e=r.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Pb(r,e){if(r){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function q0(r,e,t,i){const n=sE(r);let s=0;s+=e;let o=0,a=0,l=0;for(;s<n.length;){o=0;do{if(s>=n.length)break;l=n[s++],o+=l}while(l===255);a=0;do{if(s>=n.length)break;l=n[s++],a+=l}while(l===255);const c=n.length-s;let u=s;if(a<c)s+=a;else if(a>c){Gt.error(`Malformed SEI payload. ${a} is too small, only ${c} bytes left to parse.`);break}if(o===4){if(n[u++]===181){const f=eE(n,u);if(u+=2,f===49){const d=ut(n,u);if(u+=4,d===1195456820){const m=n[u++];if(m===3){const A=n[u++],p=31&A,y=64&A,E=y?2+p*3:0,v=new Uint8Array(E);if(y){v[0]=A;for(let x=1;x<E;x++)v[x]=n[u++]}i.push({type:m,payloadType:o,pts:t,bytes:v})}}}}}else if(o===5&&a>16){const h=[];for(let m=0;m<16;m++){const A=n[u++].toString(16);h.push(A.length==1?"0"+A:A),(m===3||m===5||m===7||m===9)&&h.push("-")}const f=a-16,d=new Uint8Array(f);for(let m=0;m<f;m++)d[m]=n[u++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:Ln(d),userDataBytes:d})}}}function sE(r){const e=r.byteLength,t=[];let i=1;for(;i<e-2;)r[i]===0&&r[i+1]===0&&r[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return r;const n=e-t.length,s=new Uint8Array(n);let o=0;for(i=0;i<n;o++,i++)o===t[0]&&(o++,t.shift()),s[i]=r[o];return s}function Fb(r){const e=r[0];let t="",i="",n=0,s=0,o=0,a=0,l=0,c=0;if(e===0){for(;Pi(r.subarray(c,c+1))!=="\0";)t+=Pi(r.subarray(c,c+1)),c+=1;for(t+=Pi(r.subarray(c,c+1)),c+=1;Pi(r.subarray(c,c+1))!=="\0";)i+=Pi(r.subarray(c,c+1)),c+=1;i+=Pi(r.subarray(c,c+1)),c+=1,n=ut(r,12),s=ut(r,16),a=ut(r,20),l=ut(r,24),c=28}else if(e===1){c+=4,n=ut(r,c),c+=4;const h=ut(r,c);c+=4;const f=ut(r,c);for(c+=4,o=2**32*h+f,db(o)||(o=Number.MAX_SAFE_INTEGER,Gt.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=ut(r,c),c+=4,l=ut(r,c),c+=4;Pi(r.subarray(c,c+1))!=="\0";)t+=Pi(r.subarray(c,c+1)),c+=1;for(t+=Pi(r.subarray(c,c+1)),c+=1;Pi(r.subarray(c,c+1))!=="\0";)i+=Pi(r.subarray(c,c+1)),c+=1;i+=Pi(r.subarray(c,c+1)),c+=1}const u=r.subarray(c,r.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:o,presentationTimeDelta:s,eventDuration:a,id:l,payload:u}}function kb(r,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=i&255,s.set(r,4),n=0,i=8;n<t;n++)s.set(e[n],i),i+=e[n].byteLength;return s}function Ob(r,e,t){if(r.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let s;i>0?(s=new Uint8Array(4),e.length>0&&new DataView(s.buffer).setUint32(0,e.length,!1)):s=new Uint8Array;const o=new Uint8Array(4);return t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),kb([112,115,115,104],new Uint8Array([i,0,0,0]),r,s,n,o,t)}const rE=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),ha={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function J0(r,e){const t=ha[e];return!!t&&!!t[r.slice(0,4)]}function Xd(r,e,t=!0){return!r.split(",").some(i=>!Z0(i,e,t))}function Z0(r,e,t=!0){var i;const n=sr(t);return(i=n==null?void 0:n.isTypeSupported(Dl(r,e)))!=null?i:!1}function Dl(r,e){return`${e}/mp4;codecs=${r}`}function dg(r){if(r){const e=r.substring(0,4);return ha.video[e]}return 2}function Pu(r){const e=rE();return r.split(",").reduce((t,i)=>{const s=e&&sh(i)?9:ha.video[i];return s?(s*2+t)/(t?3:2):(ha.audio[i]+t)/(t?2:1)},0)}const If={};function Ub(r,e=!0){if(If[r])return If[r];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[r];for(let n=0;n<t.length;n++){var i;if(Z0(t[n],"audio",e))return If[r]=t[n],t[n];if(t[n]==="mp3"&&(i=sr(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return r}const Nb=/flac|opus|mp4a\.40\.34/i;function Fu(r,e=!0){return r.replace(Nb,t=>Ub(t.toLowerCase(),e))}function Gb(r,e){const t=[];if(r){const i=r.split(",");for(let n=0;n<i.length;n++)J0(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function pu(r,e){if(r&&(r.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(r)!==-1)&&(mg(r,"audio")||mg(r,"video")))return r;if(e){const t=e.split(",");if(t.length>1){if(r){for(let i=t.length;i--;)if(t[i].substring(0,4)===r.substring(0,4))return t[i]}return t[0]}}return e||r}function mg(r,e){return J0(r,e)&&Z0(r,e)}function Qb(r){const e=r.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function zb(r){if(r.startsWith("av01.")){const e=r.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return r}function Ag(r){const e=sr(r)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function qd(r){return r.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const oE={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function aE(r,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:r}}function Hb(r,e,t,i,n,s){const o=r.videoCodec,a=r.audioCodec?r.audioGroups:null,l=s==null?void 0:s.audioCodec,c=s==null?void 0:s.channels,u=c?parseInt(c):l?1/0:2;let h=null;if(a!=null&&a.length)try{a.length===1&&a[0]?h=e.groups[a[0]].channels:h=a.reduce((f,d)=>{if(d){const m=e.groups[d];if(!m)throw new Error(`Audio track group ${d} not found`);Object.keys(m.channels).forEach(A=>{f[A]=(f[A]||0)+m.channels[A]})}return f},{2:0})}catch{return!0}return o!==void 0&&(o.split(",").some(f=>sh(f))||r.width>1920&&r.height>1088||r.height>1920&&r.width>1088||r.frameRate>Math.max(i,30)||r.videoRange!=="SDR"&&r.videoRange!==t||r.bitrate>Math.max(n,8e6))||!!h&&ze(u)&&Object.keys(h).some(f=>parseInt(f)>u)}function lE(r,e,t,i={}){const n=r.videoCodec;if(!n&&!r.audioCodec||!t)return Promise.resolve(oE);const s=[],o=Vb(r),a=o.length,l=Kb(r,e,a>0),c=l.length;for(let u=a||1*c||1;u--;){const h={type:"media-source"};if(a&&(h.video=o[u%a]),c){h.audio=l[u%c];const f=h.audio.bitrate;h.video&&f&&(h.video.bitrate-=f)}s.push(h)}if(n){const u=navigator.userAgent;if(n.split(",").some(h=>sh(h))&&rE())return Promise.resolve(aE(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${u})`),s))}return Promise.all(s.map(u=>{const h=Yb(u);return i[h]||(i[h]=t.decodingInfo(u))})).then(u=>({supported:!u.some(h=>!h.supported),configurations:s,decodingInfoResults:u})).catch(u=>({supported:!1,configurations:s,decodingInfoResults:[],error:u}))}function Vb(r){var e;const t=(e=r.videoCodec)==null?void 0:e.split(","),i=cE(r),n=r.width||640,s=r.height||480,o=r.frameRate||30,a=r.videoRange.toLowerCase();return t?t.map(l=>{const c={contentType:Dl(zb(l),"video"),width:n,height:s,bitrate:i,framerate:o};return a!=="sdr"&&(c.transferFunction=a),c}):[]}function Kb(r,e,t){var i;const n=(i=r.audioCodec)==null?void 0:i.split(","),s=cE(r);return n&&r.audioGroups?r.audioGroups.reduce((o,a)=>{var l;const c=a?(l=e.groups[a])==null?void 0:l.tracks:null;return c?c.reduce((u,h)=>{if(h.groupId===a){const f=parseFloat(h.channels||"");n.forEach(d=>{const m={contentType:Dl(d,"audio"),bitrate:t?$b(d,s):s};f&&(m.channels=""+f),u.push(m)})}return u},o):o},[]):[]}function $b(r,e){if(e<=1)return 1;let t=128e3;return r==="ec-3"?t=768e3:r==="ac-3"&&(t=64e4),Math.min(e/2,t)}function cE(r){return Math.ceil(Math.max(r.bitrate*.9,r.averageBitrate)/1e3)*1e3||1}function Yb(r){let e="";const{audio:t,video:i}=r;if(i){const n=qd(i.contentType);e+=`${n}_r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${Math.ceil(i.bitrate/1e5)}`}if(t){const n=qd(t.contentType);e+=`${i?"_":""}${n}_c${t.channels}`}return e}const Jd=["NONE","TYPE-0","TYPE-1",null];function Wb(r){return Jd.indexOf(r)>-1}const ku=["SDR","PQ","HLG"];function jb(r){return!!r&&ku.indexOf(r)>-1}var Cl={No:"",Yes:"YES",v2:"v2"};function pg(r){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=r,n=i<e/2;return e&&n?t?Cl.v2:Cl.Yes:Cl.No}class Zd{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class fa{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return gg(this._audioGroups,e)}hasSubtitleGroup(e){return gg(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function gg(r,e){return!e||!r?!1:r.indexOf(e)!==-1}function Xb(){if(typeof matchMedia=="function"){const r=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(r.media!==e.media)return r.matches===!0}return!1}function qb(r,e){let t=!1,i=[];if(r&&(t=r!=="SDR",i=[r]),e){i=e.allowedVideoRanges||ku.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&Xb(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const Jb=r=>{const e=new WeakSet;return(t,i)=>{if(r&&(i=r(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},ti=(r,e)=>JSON.stringify(r,Jb(e));function Zb(r,e,t,i,n){const s=Object.keys(r),o=i==null?void 0:i.channels,a=i==null?void 0:i.audioCodec,l=n==null?void 0:n.videoCodec,c=o&&parseInt(o)===2;let u=!1,h=!1,f=1/0,d=1/0,m=1/0,A=1/0,p=0,y=[];const{preferHDR:E,allowedVideoRanges:v}=qb(e,n);for(let S=s.length;S--;){const b=r[s[S]];u||(u=b.channels[2]>0),f=Math.min(f,b.minHeight),d=Math.min(d,b.minFramerate),m=Math.min(m,b.minBitrate),v.filter(R=>b.videoRanges[R]>0).length>0&&(h=!0)}f=ze(f)?f:0,d=ze(d)?d:0;const x=Math.max(1080,f),C=Math.max(30,d);m=ze(m)?m:t,t=Math.max(m,t),h||(e=void 0);const I=s.length>1;return{codecSet:s.reduce((S,b)=>{const T=r[b];if(b===S)return S;if(y=h?v.filter(R=>T.videoRanges[R]>0):[],I){if(T.minBitrate>t)return Is(b,`min bitrate of ${T.minBitrate} > current estimate of ${t}`),S;if(!T.hasDefaultAudio)return Is(b,"no renditions with default or auto-select sound found"),S;if(a&&b.indexOf(a.substring(0,4))%5!==0)return Is(b,`audio codec preference "${a}" not found`),S;if(o&&!c){if(!T.channels[o])return Is(b,`no renditions with ${o} channel sound found (channels options: ${Object.keys(T.channels)})`),S}else if((!a||c)&&u&&T.channels[2]===0)return Is(b,"no renditions with stereo sound found"),S;if(T.minHeight>x)return Is(b,`min resolution of ${T.minHeight} > maximum of ${x}`),S;if(T.minFramerate>C)return Is(b,`min framerate of ${T.minFramerate} > maximum of ${C}`),S;if(!y.some(R=>T.videoRanges[R]>0))return Is(b,`no variants with VIDEO-RANGE of ${ti(y)} found`),S;if(l&&b.indexOf(l.substring(0,4))%5!==0)return Is(b,`video codec preference "${l}" not found`),S;if(T.maxScore<p)return Is(b,`max score of ${T.maxScore} < selected max of ${p}`),S}return S&&(Pu(b)>=Pu(S)||T.fragmentError>r[S].fragmentError)?S:(A=T.minIndex,p=T.maxScore,b)},void 0),videoRanges:y,preferHDR:E,minFramerate:d,minBitrate:m,minIndex:A}}function Is(r,e){Gt.log(`[abr] start candidates with "${r}" ignored because ${e}`)}function uE(r){return r.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function ew(r,e,t,i){return r.slice(t,i+1).reduce((n,s,o)=>{if(!s.codecSet)return n;const a=s.audioGroups;let l=n[s.codecSet];l||(n[s.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,s.bitrate);const c=Math.min(s.height,s.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,s.frameRate),l.minIndex=Math.min(l.minIndex,o),l.maxScore=Math.max(l.maxScore,s.score),l.fragmentError+=s.fragmentError,l.videoRanges[s.videoRange]=(l.videoRanges[s.videoRange]||0)+1,a&&a.forEach(u=>{if(!u)return;const h=e.groups[u];h&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(f=>{l.channels[f]=(l.channels[f]||0)+h.channels[f]}))}),n},{})}function yg(r){if(!r)return r;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}=r;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}}function Ms(r,e,t){if("attrs"in r){const i=e.indexOf(r);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(to(r,n,t))return i}return-1}function to(r,e,t){const{groupId:i,name:n,lang:s,assocLang:o,default:a}=r,l=r.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(s===void 0||tw(s,e.lang))&&(s===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(l===void 0||e.forced===l)&&(!("characteristics"in r)||iw(r.characteristics||"",e.characteristics))&&(t===void 0||t(r,e))}function tw(r,e="--"){return r.length===e.length?r===e:r.startsWith(e)||e.startsWith(r)}function iw(r,e=""){const t=r.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function Yr(r,e){const{audioCodec:t,channels:i}=r;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function nw(r,e,t,i,n){const s=e[i],a=e.reduce((f,d,m)=>{const A=d.uri;return(f[A]||(f[A]=[])).push(m),f},{})[s.uri];a.length>1&&(i=Math.max.apply(Math,a));const l=s.videoRange,c=s.frameRate,u=s.codecSet.substring(0,4),h=vg(e,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return Ms(r,m,n)>-1});return h>-1?h:vg(e,i,f=>{const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return Ms(r,m,n)>-1})}function vg(r,e,t){for(let i=e;i>-1;i--)if(t(r[i]))return i;for(let i=e+1;i<r.length;i++)if(t(r[i]))return i;return-1}function Ou(r,e){var t;return!!r&&r!==((t=e.loadLevelObj)==null?void 0:t.uri)}class hE extends gs{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:s,hls:o}=this,{autoLevelEnabled:a,media:l}=o;if(!n||!l)return;const c=performance.now(),u=s?s.stats:n.stats,h=s?s.duration:n.duration,f=c-u.loading.start,d=o.minAutoLevel,m=n.level,A=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||m<=d){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const p=A>-1&&A!==m,y=!!t||p;if(!y&&(l.paused||!l.playbackRate||!l.readyState))return;const E=o.mainForwardBufferInfo;if(!y&&E===null)return;const v=this.bwEstimator.getEstimateTTFB(),x=Math.abs(l.playbackRate);if(f<=Math.max(v,1e3*(h/(x*2))))return;const C=E?E.len/x:0,I=u.loading.first?u.loading.first-u.loading.start:-1,_=u.loaded&&I>-1,S=this.getBwEstimate(),b=o.levels,T=b[m],R=Math.max(u.loaded,Math.round(h*(n.bitrate||T.averageBitrate)/8));let w=_?f-I:f;w<1&&_&&(w=Math.min(f,u.loaded*8/S));const B=_?u.loaded*1e3/w:0,D=v/1e3,k=B?(R-u.loaded)/B:R*8/S+D;if(k<=C)return;const Q=B?B*8:S,Y=((i=(t==null?void 0:t.details)||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,W=this.hls.config.abrBandWidthUpFactor;let P=Number.POSITIVE_INFINITY,K;for(K=m-1;K>d;K--){const G=b[K].maxBitrate,O=!b[K].details||Y;if(P=this.getTimeToLoadFrag(D,Q,h*G,O),P<Math.min(C,h+D))break}if(P>=k||P>h*10)return;_?this.bwEstimator.sample(f-Math.min(v,I),u.loaded):this.bwEstimator.sampleTTFB(f);const M=b[K].maxBitrate;this.getBwEstimate()*W>M&&this.resetEstimator(M);const V=this.findBestLevel(M,d,K,0,C,1,1);V>-1&&(K=V),this.warn(`Fragment ${n.sn}${s?" part "+s.index:""} of level ${m} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${C.toFixed(3)} s
      Estimated load time for current fragment: ${k.toFixed(3)} s
      Estimated load time for down switch fragment: ${P.toFixed(3)} s
      TTFB estimate: ${I|0} ms
      Current BW estimate: ${ze(S)?S|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${K} @ ${M|0} bps`),o.nextLoadLevel=o.nextAutoLevel=K,this.clearTimer();const $=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===K&&K>0){const G=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${K>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${G.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,K>d){let O=this.findBestLevel(this.hls.levels[d].bitrate,d,K,0,G,1,1);O===-1&&(O=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=O,this.resetEstimator(this.hls.levels[O].bitrate)}}};p||k>P*2?$():this.timer=self.setInterval($,P*1e3),o.trigger(L.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:s,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new Ab(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(L.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case ue.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:s}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const o=performance.now(),a=s?s.stats:i.stats,l=o-a.loading.start,c=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&c>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(h,c),a.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,n){const s=e+i/t,o=n?e+this.lastLevelLoadSec:0;return s+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,s=n.end-n.first;ze(s)&&(this.lastLevelLoadSec=s/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===$e.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const s=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+n.loaded,l=(o.loaded?o.loaded.duration:0)+s;o.loaded={bytes:a,duration:l},o.realBitrate=Math.round(8*a/l)}if(t.bitrateTest){const s={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(L.FRAG_BUFFERED,s),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,s=n!=null&&n.stats.loaded?n.stats:i.stats;if(s.aborted||this.ignoreFragment(i))return;const o=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==$e.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,t,e,0,n,1,1);if(s>-1)return s;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const s=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,s)&&o[e].loadError<=o[s].loadError)return e}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:s,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=s.abrBandWidthFactor,h=s.abrBandWidthUpFactor;if(c){const p=this.findBestLevel(l,o,n,c,0,u,h);if(p>=0)return this.rebufferNotice=-1,p}let f=a?Math.min(a,s.maxStarvationDelay):s.maxStarvationDelay;if(!c){const p=this.bitrateTestDelay;p&&(f=(a?Math.min(a,s.maxLoadingDelay):s.maxLoadingDelay)-p,this.info(`bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const d=this.findBestLevel(l,o,n,c,f,u,h);if(this.rebufferNotice!==d&&(this.rebufferNotice=d,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`)),d>-1)return d;const m=i.levels[o],A=i.loadLevelObj;return A&&(m==null?void 0:m.bitrate)<A.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,s,o,a){var l;const c=n+s,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:d}=this,{levels:m,allAudioTracks:A,loadLevel:p,config:y}=this.hls;if(m.length===1)return 0;const E=m[h],v=!!((l=this.hls.latestLevelDetails)!=null&&l.live),x=p===-1||u===-1;let C,I="SDR",_=(E==null?void 0:E.frameRate)||0;const{audioPreference:S,videoPreference:b}=y,T=this.audioTracksByGroup||(this.audioTracksByGroup=uE(A));let R=-1;if(x){if(this.firstSelection!==-1)return this.firstSelection;const Q=this.codecTiers||(this.codecTiers=ew(m,T,t,i)),Y=Zb(Q,I,e,S,b),{codecSet:W,videoRanges:P,minFramerate:K,minBitrate:M,minIndex:V,preferHDR:$}=Y;R=V,C=W,I=$?P[P.length-1]:P[0],_=K,e=Math.max(e,M),this.log(`picked start tier ${ti(Y)}`)}else C=E==null?void 0:E.codecSet,I=E==null?void 0:E.videoRange;const w=d?d.duration:f?f.duration:0,B=this.bwEstimator.getEstimateTTFB()/1e3,D=[];for(let Q=i;Q>=t;Q--){var k;const Y=m[Q],W=Q>h;if(!Y)continue;if(y.useMediaCapabilities&&!Y.supportedResult&&!Y.supportedPromise){const O=navigator.mediaCapabilities;typeof(O==null?void 0:O.decodingInfo)=="function"&&Hb(Y,T,I,_,e,S)?(Y.supportedPromise=lE(Y,T,O,this.supportedCache),Y.supportedPromise.then(F=>{if(!this.hls)return;Y.supportedResult=F;const U=this.hls.levels,N=U.indexOf(Y);F.error?this.warn(`MediaCapabilities decodingInfo error: "${F.error}" for level ${N} ${ti(F)}`):F.supported?F.decodingInfoResults.some(Z=>Z.smooth===!1||Z.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${N} not smooth or powerEfficient: ${ti(F)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${N} ${ti(F)}`),N>-1&&U.length>1&&(this.log(`Removing unsupported level ${N}`),this.hls.removeLevel(N),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):Y.supportedResult=oE}if((C&&Y.codecSet!==C||I&&Y.videoRange!==I||W&&_>Y.frameRate||!W&&_>0&&_<Y.frameRate||(k=Y.supportedResult)!=null&&(k=k.decodingInfoResults)!=null&&k.some(O=>O.smooth===!1))&&(!x||Q!==R)){D.push(Q);continue}const P=Y.details,K=(d?P==null?void 0:P.partTarget:P==null?void 0:P.averagetargetduration)||w;let M;W?M=a*e:M=o*e;const V=w&&n>=w*2&&s===0?Y.averageBitrate:Y.maxBitrate,$=this.getTimeToLoadFrag(B,M,V*K,P===void 0);if(M>=V&&(Q===u||Y.loadError===0&&Y.fragmentError===0)&&($<=B||!ze($)||v&&!this.bitrateTestDelay||$<c)){const O=this.forcedAutoLevel;return Q!==p&&(O===-1||O!==p)&&(D.length&&this.trace(`Skipped level(s) ${D.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[D[0]].codecs}" ${m[D[0]].videoRange}; not compatible with "${C}" ${I}`),this.info(`switch candidate:${h}->${Q} adjustedbw(${Math.round(M)})-bitrate=${Math.round(M-V)} ttfb:${B.toFixed(1)} avgDuration:${K.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${$.toFixed(1)} firstSelection:${x} codecSet:${Y.codecSet} videoRange:${Y.videoRange} hls.loadLevel:${p}`)),x&&(this.firstSelection=Q),Q}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const fE={search:function(r,e){let t=0,i=r.length-1,n=null,s=null;for(;t<=i;){n=(t+i)/2|0,s=r[n];const o=e(s);if(o>0)t=n+1;else if(o<0)i=n-1;else return s}return null}};function sw(r,e,t){if(e===null||!Array.isArray(r)||!r.length||!ze(e))return null;const i=r[0].programDateTime;if(e<(i||0))return null;const n=r[r.length-1].endProgramDateTime;if(e>=(n||0))return null;for(let s=0;s<r.length;++s){const o=r[s];if(ow(e,t,o))return o}return null}function no(r,e,t=0,i=0,n=.005){let s=null;if(r){s=e[1+r.sn-e[0].sn]||null;const a=r.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),s&&r.level!==s.level&&s.end<=r.end&&(s=e[2+r.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(s=e[0]);if(s&&((!r||r.level===s.level)&&Eg(t,i,s)===0||rw(s,r,Math.min(n,i))))return s;const o=fE.search(e,Eg.bind(null,t,i));return o&&(o!==r||!s)?o:s}function rw(r,e,t){if(e&&e.start===0&&e.level<r.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,s)=>(s[0]==="INF"&&(n+=parseFloat(s[1])),n),t);return r.start<=i}return!1}function Eg(r=0,e=0,t){if(t.start<=r&&t.start+t.duration>r)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=r?1:t.start-i>r&&t.start?-1:0}function ow(r,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>r}function dE(r,e,t){if(r&&r.startCC<=e&&r.endCC>=e){let i=r.fragments;const{fragmentHint:n}=r;n&&(i=i.concat(n));let s;return fE.search(i,o=>o.cc<e?1:o.cc>e?-1:(s=o,o.end<=t?1:o.start>t?-1:0)),s||null}return null}function Uu(r){switch(r.details){case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_TIMEOUT:case ue.LEVEL_LOAD_TIMEOUT:case ue.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function xg(r,e){const t=Uu(e);return r.default[`${t?"timeout":"error"}Retry`]}function em(r,e){const t=r.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*r.retryDelayMs,r.maxRetryDelayMs)}function Cg(r){return zt(zt({},r),{errorRetry:null,timeoutRetry:null})}function Nu(r,e,t,i){if(!r)return!1;const n=i==null?void 0:i.code,s=e<r.maxNumRetry&&(aw(n)||!!t);return r.shouldRetry?r.shouldRetry(r,e,t,i,s):s}function aw(r){return r===0&&navigator.onLine===!1||!!r&&(r<400||r>499)}var zi={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Hn={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class mE extends gs{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(L.ERROR,this.onError,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(L.ERROR,this.onError,this),e.off(L.ERROR,this.onErrorOut,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===$e.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,s=t.context;switch(t.details){case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case ue.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Ml();return}case ue.FRAG_GAP:case ue.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=zi.SendAlternateToPenaltyBox;return}case ue.LEVEL_EMPTY_ERROR:case ue.LEVEL_PARSING_ERROR:{var o;const l=t.parent===$e.MAIN?t.level:n.loadLevel;t.details===ue.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(o=o.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l))}return;case ue.LEVEL_LOAD_ERROR:case ue.LEVEL_LOAD_TIMEOUT:typeof(s==null?void 0:s.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.level));return;case ue.AUDIO_TRACK_LOAD_ERROR:case ue.AUDIO_TRACK_LOAD_TIMEOUT:case ue.SUBTITLE_LOAD_ERROR:case ue.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const l=n.loadLevelObj;if(l&&(s.type===xt.AUDIO_TRACK&&l.hasAudioGroup(s.groupId)||s.type===xt.SUBTITLE_TRACK&&l.hasSubtitleGroup(s.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=zi.SendAlternateToPenaltyBox,t.errorAction.flags=Hn.MoveAllAlternatesMatchingHost;return}}return;case ue.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const l=n.loadLevelObj,c=l==null?void 0:l.attrs["HDCP-LEVEL"];c?t.errorAction={action:zi.SendAlternateToPenaltyBox,flags:Hn.MoveAllAlternatesMatchingHDCP,hdcpLevel:c}:this.keySystemError(t)}return;case ue.BUFFER_ADD_CODEC_ERROR:case ue.REMUX_ALLOC_ERROR:case ue.BUFFER_APPEND_ERROR:if(!t.errorAction){var a;t.errorAction=this.getLevelSwitchAction(t,(a=t.level)!=null?a:n.loadLevel)}return;case ue.INTERNAL_EXCEPTION:case ue.BUFFER_APPENDING_ERROR:case ue.BUFFER_FULL_ERROR:case ue.LEVEL_SWITCH_ERROR:case ue.BUFFER_STALLED_ERROR:case ue.BUFFER_SEEK_OVER_HOLE:case ue.BUFFER_NUDGE_ON_STALL:t.errorAction=Ml();return}t.type===qe.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=xg(i.config.playlistLoadPolicy,e),s=this.playlistError++;if(Nu(n,s,Uu(e),e.response))return{action:zi.RetryRequest,flags:Hn.None,retryConfig:n,retryCount:s};const a=this.getLevelSwitchAction(e,t);return n&&(a.retryConfig=n,a.retryCount=s),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:s,keyLoadPolicy:o}=t.config,a=xg(e.details.startsWith("key")?o:s,e),l=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(n&&(e.details!==ue.FRAG_GAP&&n.fragmentError++,Nu(a,l,Uu(e),e.response)))return{action:zi.RetryRequest,flags:Hn.None,retryConfig:a,retryCount:l};const c=this.getLevelSwitchAction(e,i);return a&&(c.retryConfig=a,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var s,o;const c=e.details;n.loadError++,c===ue.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:d,maxAutoLevel:m}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const A=(s=e.frag)==null?void 0:s.type,y=(A===$e.AUDIO&&c===ue.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===ue.BUFFER_ADD_CODEC_ERROR||c===ue.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:I})=>n.audioCodec!==I),v=e.sourceBufferName==="video"&&(c===ue.BUFFER_ADD_CODEC_ERROR||c===ue.BUFFER_APPEND_ERROR)&&h.some(({codecSet:I,audioCodec:_})=>n.codecSet!==I&&n.audioCodec===_),{type:x,groupId:C}=(o=e.context)!=null?o:{};for(let I=h.length;I--;){const _=(I+f)%h.length;if(_!==f&&_>=d&&_<=m&&h[_].loadError===0){var a,l;const S=h[_];if(c===ue.FRAG_GAP&&A===$e.MAIN&&e.frag){const b=h[_].details;if(b){const T=no(e.frag,b.fragments,e.frag.start);if(T!=null&&T.gap)continue}}else{if(x===xt.AUDIO_TRACK&&S.hasAudioGroup(C)||x===xt.SUBTITLE_TRACK&&S.hasSubtitleGroup(C))continue;if(A===$e.AUDIO&&(a=n.audioGroups)!=null&&a.some(b=>S.hasAudioGroup(b))||A===$e.SUBTITLE&&(l=n.subtitleGroups)!=null&&l.some(b=>S.hasSubtitleGroup(b))||y&&n.audioCodec===S.audioCodec||v&&n.codecSet===S.codecSet||!y&&n.codecSet!==S.codecSet)continue}u=_;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:zi.SendAlternateToPenaltyBox,flags:Hn.None,nextAutoLevel:u}}return{action:zi.SendAlternateToPenaltyBox,flags:Hn.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case zi.DoNothing:break;case zi.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==ue.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case zi.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n,hdcpLevel:s,nextAutoLevel:o}=i;switch(n){case Hn.None:this.switchLevel(e,o);break;case Hn.MoveAllAlternatesMatchingHDCP:s&&(t.maxHdcpLevel=Jd[Jd.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,o)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===ue.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=qd(e.mimeType),n=this.hls.levels;for(let s=n.length;s--;)n[s][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(s)}}}function Ml(r){const e={action:zi.DoNothing,flags:Hn.None};return r&&(e.resolved=!0),e}var Fi={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class lw{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e&&(e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let n=i.length;n--;){const s=i[n];if(!s)break;if(s.start<=e&&e<=s.end&&s.loaded)return s}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:n}=this,s=Object.keys(n);for(let o=s.length;o--;){const a=n[s[o]];if((a==null?void 0:a.body.type)===t&&(!i||a.buffered)){const l=a.body;if(l.start<=e&&e<=l.end)return l}}return null}detectEvictedFragments(e,t,i,n,s){this.timeRanges&&(this.timeRanges[e]=t);const o=(n==null?void 0:n.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const l=this.fragments[a];if(!l||o>=l.body.sn)return;if(!l.buffered&&(!l.loaded||s)){l.body.type===i&&this.removeFragment(l.body);return}const c=l.range[e];if(c){if(c.time.length===0){this.removeFragment(l.body);return}c.time.some(u=>{const h=!this.isTimeBuffered(u.startPTS,u.endPTS,t);return h&&this.removeFragment(l.body),h})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,n=bo(i),s=this.fragments[n];if(!s||s.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const l=i.elementaryStreams[a];if(!l)return;const c=t[a],u=o||l.partial===!0;s.range[a]=this.getBufferedTimes(i,e.part,u,c)}),s.loaded=null,Object.keys(s.range).length?(s.buffered=!0,(s.body.endList=i.endList||s.body.endList)&&(this.endListFragments[s.body.type]=s),Sc(s)||this.removeParts(i.sn-1,i.type)):this.removeFragment(s.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=Ig(i,n=>n.fragment.sn>=e))}fragBuffered(e,t){const i=bo(e);let n=this.fragments[i];!n&&t&&(n=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)}getBufferedTimes(e,t,i,n){const s={time:[],partial:i},o=e.start,a=e.end,l=e.minEndPTS||a,c=e.maxStartPTS||o;for(let u=0;u<n.length;u++){const h=n.start(u)-this.bufferPadding,f=n.end(u)+this.bufferPadding;if(c>=h&&l<=f){s.time.push({startPTS:Math.max(o,n.start(u)),endPTS:Math.min(a,n.end(u))});break}else if(o<f&&a>h){const d=Math.max(o,n.start(u)),m=Math.min(a,n.end(u));m>d&&(s.partial=!0,s.time.push({startPTS:d,endPTS:m}))}else if(a<=h)break}return s}getPartialFragment(e){let t=null,i,n,s,o=0;const{bufferPadding:a,fragments:l}=this;return Object.keys(l).forEach(c=>{const u=l[c];u&&Sc(u)&&(n=u.body.start-a,s=u.body.end+a,e>=n&&e<=s&&(i=Math.min(e-n,s-e),o<=i&&(t=u.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Sc(t))}getState(e){const t=bo(e),i=this.fragments[t];return i?i.buffered?Sc(i)?Fi.PARTIAL:Fi.OK:Fi.APPENDING:Fi.NOT_LOADED}isTimeBuffered(e,t,i){let n,s;for(let o=0;o<i.length;o++){if(n=i.start(o)-this.bufferPadding,s=i.end(o)+this.bufferPadding,e>=n&&t<=s)return!0;if(t<=n)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,n=t.part?null:t,s=bo(i);this.fragments[s]={body:i,appendedPTS:null,loaded:n,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:n,timeRanges:s,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(n){let c=this.activePartLists[a];c||(this.activePartLists[a]=c=[]),c.push(n)}this.timeRanges=s;const l=s[o];this.detectEvictedFragments(o,l,a,n)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=bo(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let n=i.length;n--;){const s=t[i[n]];if((s==null?void 0:s.body.type)===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,n,s){n&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const l=a.body;l.type!==i||n&&!l.gap||l.start<t&&l.end>e&&(a.buffered||s)&&this.removeFragment(l)})}removeFragment(e){const t=bo(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const n=e.sn;this.activePartLists[e.type]=Ig(i,s=>s.fragment.sn!==n)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(i=>i.clearElementaryStreamInfo())}}function Sc(r){var e,t,i;return r.buffered&&!!(r.body.gap||(e=r.range.video)!=null&&e.partial||(t=r.range.audio)!=null&&t.partial||(i=r.range.audiovideo)!=null&&i.partial)}function bo(r){return`${r.type}_${r.level}_${r.sn}`}function Ig(r,e){return r.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var Br={cbc:0,ctr:1};class cw{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Br.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Br.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function uw(r){const e=r.byteLength,t=e&&new DataView(r.buffer).getUint8(e-1);return t?r.slice(0,e-t):r}class hw{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],s=i[1],o=i[2],a=i[3],l=this.invSubMix,c=l[0],u=l[1],h=l[2],f=l[3],d=new Uint32Array(256);let m=0,A=0,p=0;for(p=0;p<256;p++)p<128?d[p]=p<<1:d[p]=p<<1^283;for(p=0;p<256;p++){let y=A^A<<1^A<<2^A<<3^A<<4;y=y>>>8^y&255^99,e[m]=y,t[y]=m;const E=d[m],v=d[E],x=d[v];let C=d[y]*257^y*16843008;n[m]=C<<24|C>>>8,s[m]=C<<16|C>>>16,o[m]=C<<8|C>>>24,a[m]=C,C=x*16843009^v*65537^E*257^m*16843008,c[y]=C<<24|C>>>8,u[y]=C<<16|C>>>16,h[y]=C<<8|C>>>24,f[y]=C,m?(m=E^d[d[d[x^E]]],A^=d[d[A]]):m=A=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const s=this.keySize=t.length;if(s!==4&&s!==6&&s!==8)throw new Error("Invalid aes key size="+s);const o=this.ksRows=(s+6+1)*4;let a,l;const c=this.keySchedule=new Uint32Array(o),u=this.invKeySchedule=new Uint32Array(o),h=this.sBox,f=this.rcon,d=this.invSubMix,m=d[0],A=d[1],p=d[2],y=d[3];let E,v;for(a=0;a<o;a++){if(a<s){E=c[a]=t[a];continue}v=E,a%s===0?(v=v<<8|v>>>24,v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[v&255],v^=f[a/s|0]<<24):s>6&&a%s===4&&(v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[v&255]),c[a]=E=(c[a-s]^v)>>>0}for(l=0;l<o;l++)a=o-l,l&3?v=c[a]:v=c[a-4],l<4||a<=4?u[l]=v:u[l]=m[h[v>>>24]]^A[h[v>>>16&255]]^p[h[v>>>8&255]]^y[h[v&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,s=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,l=a[0],c=a[1],u=a[2],h=a[3],f=this.uint8ArrayToUint32Array_(i);let d=f[0],m=f[1],A=f[2],p=f[3];const y=new Int32Array(e),E=new Int32Array(y.length);let v,x,C,I,_,S,b,T,R,w,B,D,k,Q;const Y=this.networkToHostOrderSwap;for(;t<y.length;){for(R=Y(y[t]),w=Y(y[t+1]),B=Y(y[t+2]),D=Y(y[t+3]),_=R^s[0],S=D^s[1],b=B^s[2],T=w^s[3],k=4,Q=1;Q<n;Q++)v=l[_>>>24]^c[S>>16&255]^u[b>>8&255]^h[T&255]^s[k],x=l[S>>>24]^c[b>>16&255]^u[T>>8&255]^h[_&255]^s[k+1],C=l[b>>>24]^c[T>>16&255]^u[_>>8&255]^h[S&255]^s[k+2],I=l[T>>>24]^c[_>>16&255]^u[S>>8&255]^h[b&255]^s[k+3],_=v,S=x,b=C,T=I,k=k+4;v=o[_>>>24]<<24^o[S>>16&255]<<16^o[b>>8&255]<<8^o[T&255]^s[k],x=o[S>>>24]<<24^o[b>>16&255]<<16^o[T>>8&255]<<8^o[_&255]^s[k+1],C=o[b>>>24]<<24^o[T>>16&255]<<16^o[_>>8&255]<<8^o[S&255]^s[k+2],I=o[T>>>24]<<24^o[_>>16&255]<<16^o[S>>8&255]<<8^o[b&255]^s[k+3],E[t]=Y(v^d),E[t+1]=Y(I^m),E[t+2]=Y(C^A),E[t+3]=Y(x^p),d=R,m=w,A=B,p=D,t=t+4}return E.buffer}}class fw{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=dw(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function dw(r){switch(r){case Br.cbc:return"AES-CBC";case Br.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${r}`)}}const mw=16;class tm{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?uw(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((s,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,n);const l=this.flush();l?s(l.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:s,currentResult:o,remainderData:a}=this;if(n!==Br.cbc||t.byteLength!==16)return Gt.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=Jn(a,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;s&&(i=s);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new hw),c.expandKey(t);const u=o;return this.currentResult=c.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new fw(this.subtle,t,n)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new cw(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(Gt.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const s=this.enableSoftwareAES;if(s){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(s?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%mw;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(Gt.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const _g=Math.pow(2,17);class Aw{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new qs({type:qe.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(m=>m[0]==="GAP")){l(Tg(e));return}else e.gap=!1;const c=this.loader=s?new s(n):new o(n),u=Sg(e);e.loader=c;const h=Cg(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:_g};e.stats=c.stats;const d={onSuccess:(m,A,p,y)=>{this.resetLoader(e,c);let E=m.data;p.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(E.slice(0,16)),E=E.slice(16)),a({frag:e,part:null,payload:E,networkDetails:y})},onError:(m,A,p,y)=>{this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:zt({url:i,data:void 0},m),error:new Error(`HTTP Error ${m.code} ${m.text}`),networkDetails:p,stats:y}))},onAbort:(m,A,p)=>{this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:p,stats:m}))},onTimeout:(m,A,p)=>{this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:p,stats:m}))}};t&&(d.onProgress=(m,A,p,y)=>t({frag:e,part:null,payload:p,networkDetails:y})),c.load(u,f,d)})}loadPart(e,t,i){this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(Tg(e,t));return}const c=this.loader=s?new s(n):new o(n),u=Sg(e,t);e.loader=c;const h=Cg(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:_g};t.stats=c.stats,c.load(u,f,{onSuccess:(d,m,A,p)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const y={frag:e,part:t,payload:d.data,networkDetails:p};i(y),a(y)},onError:(d,m,A,p)=>{this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:zt({url:u.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:A,stats:p}))},onAbort:(d,m,A)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:A,stats:d}))},onTimeout:(d,m,A)=>{this.resetLoader(e,c),l(new qs({type:qe.NETWORK_ERROR,details:ue.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:A,stats:d}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,s=n.total;if(i.loaded+=n.loaded,s){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/s),l),h=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=n.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Sg(r,e=null){const t=e||r,i={frag:r,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,s=t.byteRangeEndOffset;if(ze(n)&&ze(s)){var o;let a=n,l=s;if(r.sn==="initSegment"&&pw((o=r.decryptdata)==null?void 0:o.method)){const c=s-n;c%16&&(l=s+(16-c%16)),n!==0&&(i.resetIV=!0,a=n-16)}i.rangeStart=a,i.rangeEnd=l}return i}function Tg(r,e){const t=new Error(`GAP ${r.gap?"tag":"attribute"} found`),i={type:qe.MEDIA_ERROR,details:ue.FRAG_GAP,fatal:!1,frag:r,error:t,networkDetails:null};return e&&(i.part=e),(e||r).stats.aborted=!0,new qs(i)}function pw(r){return r==="AES-128"||r==="AES-256"}class qs extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class AE extends gs{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class rh{constructor(e,t,i,n=0,s=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Tc(),this.buffering={audio:Tc(),video:Tc(),audiovideo:Tc()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=s,this.partial=o}}function Tc(){return{start:0,executeStart:0,executeEnd:0,end:0}}const bg={length:0,start:()=>0,end:()=>0};class ft{static isBuffered(e,t){if(e){const i=ft.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=ft.getBuffered(e);return ft.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=ft.bufferedRanges(e);if(n.length)return ft.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,h)=>u.start-h.start||h.end-u.end);let n=-1,s=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const h=s.length;if(h){const f=s[h-1].end;e[u].start-f<i?e[u].end>f&&(s[h-1].end=e[u].end):s.push(e[u])}else s.push(e[u])}else s=e;let o=0,a,l=t,c=t;for(let u=0;u<s.length;u++){const h=s[u].start,f=s[u].end;if(n===-1&&t>=h&&t<=f&&(n=u),t+i>=h&&t<f)l=h,c=f,o=c-t;else if(t+i<h){a=h;break}}return{len:o,start:l||0,end:c||0,nextStart:a,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||bg}catch(t){return Gt.log("failed to get media.buffered",t),bg}}}const pE=/\{\$([a-zA-Z0-9-_]+)\}/g;function wg(r){return pE.test(r)}function e0(r,e){if(r.variableList!==null||r.hasVariableRefs){const t=r.variableList;return e.replace(pE,i=>{const n=i.substring(2,i.length-1),s=t==null?void 0:t[n];return s===void 0?(r.playlistParsingError||(r.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):s})}return e}function Bg(r,e,t){let i=r.variableList;i||(r.variableList=i={});let n,s;if("QUERYPARAM"in e){n=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(n))s=o.get(n);else throw new Error(`"${n}" does not match any query parameter in URI: "${t}"`)}catch(o){r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else n=e.NAME,s=e.VALUE;n in i?r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${n}"`)):i[n]=s||""}function gw(r,e,t){const i=e.IMPORT;if(t&&i in t){let n=r.variableList;n||(r.variableList=n={}),n[i]=t[i]}else r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const yw=/^(\d+)x(\d+)$/,Rg=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ri{constructor(e,t){typeof e=="string"&&(e=ri.parseAttrList(e,t)),Vt(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,s)=>(n[s.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=yw.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={},s='"';for(Rg.lastIndex=0;(i=Rg.exec(e))!==null;){const o=i[1].trim();let a=i[2];const l=a.indexOf(s)===0&&a.lastIndexOf(s)===a.length-1;let c=!1;if(l)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":c=!0}if(t&&(l||c))a=e0(t,a);else if(!c&&!l)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Gt.warn(`${e}: attribute ${o} is missing quotes`)}n[o]=a}return n}}const vw="com.apple.hls.interstitial";function Ew(r){return r!=="ID"&&r!=="CLASS"&&r!=="CUE"&&r!=="START-DATE"&&r!=="DURATION"&&r!=="END-DATE"&&r!=="END-ON-NEXT"}function xw(r){return r==="SCTE35-OUT"||r==="SCTE35-IN"||r==="SCTE35-CMD"}class im{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(t==null?void 0:t.tagAnchor)||null,this.tagOrder=(n=t==null?void 0:t.tagOrder)!=null?n:i,t){const s=t.attr;for(const o in s)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==s[o]){Gt.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=Vt(new ri({}),s,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const s=(t==null?void 0:t.endDate)||new Date(this.attr["END-DATE"]);ze(s.getTime())&&(this._endDate=s)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(Gt.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(ze(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===vw}get isValid(){return!!this.id&&!this._badValueForSameId&&ze(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const Cw=10;class gE{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}get hasProgramDateTime(){return this.fragments.length?ze(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Cw}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function sa(r){return r==="AES-128"||r==="AES-256"||r==="AES-256-CTR"}function nm(r){switch(r){case"AES-128":case"AES-256":return Br.cbc;case"AES-256-CTR":return Br.ctr;default:throw new Error(`invalid full segment method ${r}`)}}function sm(r){return Uint8Array.from(atob(r),e=>e.charCodeAt(0))}function t0(r){return Uint8Array.from(unescape(encodeURIComponent(r)),e=>e.charCodeAt(0))}function Iw(r){const e=t0(r).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function _w(r){const e=function(i,n,s){const o=i[n];i[n]=i[s],i[s]=o};e(r,0,3),e(r,1,2),e(r,4,5),e(r,6,7)}function Sw(r){const e=r.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const s=n[0]==="base64",o=n[1];s?(i.splice(-1,1),t=sm(o)):t=Iw(o)}}return t}const Gu=typeof self<"u"?self:void 0;var hi={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},sn={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function gu(r){switch(r){case sn.FAIRPLAY:return hi.FAIRPLAY;case sn.PLAYREADY:return hi.PLAYREADY;case sn.WIDEVINE:return hi.WIDEVINE;case sn.CLEARKEY:return hi.CLEARKEY}}function _f(r){switch(r){case hi.FAIRPLAY:return sn.FAIRPLAY;case hi.PLAYREADY:return sn.PLAYREADY;case hi.WIDEVINE:return sn.WIDEVINE;case hi.CLEARKEY:return sn.CLEARKEY}}function ml(r){const{drmSystems:e,widevineLicenseUrl:t}=r,i=e?[hi.FAIRPLAY,hi.WIDEVINE,hi.PLAYREADY,hi.CLEARKEY].filter(n=>!!e[n]):[];return!i[hi.WIDEVINE]&&t&&i.push(hi.WIDEVINE),i}const rm=function(r){return Gu!=null&&(r=Gu.navigator)!=null&&r.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Tw(r,e,t,i){let n;switch(r){case hi.FAIRPLAY:n=["cenc","sinf"];break;case hi.WIDEVINE:case hi.PLAYREADY:n=["cenc"];break;case hi.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${r}`)}return bw(n,e,t,i)}function bw(r,e,t,i){return[{initDataTypes:r,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(s=>({contentType:`audio/mp4; codecs=${s}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(s=>({contentType:`video/mp4; codecs=${s}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function ww(r){var e;return r.sessionType==="persistent-license"||!!((e=r.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function Bw(r){const e=new Uint16Array(r.buffer,r.byteOffset,r.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const l=sm(a).subarray(0,16);return _w(l),l}}return null}let bc={};class Vl{static clearKeyUriToKeyIdMap(){bc={}}constructor(e,t,i,n=[1],s=null,o){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=s,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!sa(e),o!=null&&o.startsWith("0x")&&(this.keyId=new Uint8Array(Xv(o)))}matches(e){var t,i;return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&e.keyFormatVersions.join(",")===this.keyFormatVersions.join(",")&&((t=e.iv)==null?void 0:t.join(","))===((i=this.iv)==null?void 0:i.join(","))}isSupported(){if(this.method){if(sa(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case sn.FAIRPLAY:case sn.WIDEVINE:case sn.PLAYREADY:case sn.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(sa(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(Gt.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=Rw(e);return new Vl(this.method,this.uri,"identity",this.keyFormatVersions,i)}if(this.pssh&&this.keyId)return this;const t=Sw(this.uri);if(t)switch(this.keyFormat){case sn.WIDEVINE:if(this.pssh=t,!this.keyId&&t.length>=22){const i=t.length-22;this.keyId=t.subarray(i,i+16)}break;case sn.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Ob(i,null,t),this.keyId=Bw(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){const n=new Uint8Array(16);n.set(i,16-i.length),i=n}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=bc[this.uri];if(!i){const n=Object.keys(bc).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,n),bc[this.uri]=i}this.keyId=i}return this}}function Rw(r){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=r>>8*(15-t)&255;return e}const Dg=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Mg=/#EXT-X-MEDIA:(.*)/g,Dw=/^#EXT(?:INF|-X-TARGETDURATION):/m,Sf=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),Mw=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ms{static findGroup(e,t){for(let i=0;i<e.length;i++){const n=e[i];if(n.id===t)return n}}static resolve(e,t){return j0.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return Dw.test(e)}static parseMasterPlaylist(e,t){const i=wg(e),n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},s=[];Dg.lastIndex=0;let o;for(;(o=Dg.exec(e))!=null;)if(o[1]){var a;const c=new ri(o[1],n),u=e0(n,o[2]),h={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:ms.resolve(u,t)},f=c.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),Fg(c.CODECS,h);const d=c["SUPPLEMENTAL-CODECS"];d&&(h.supplemental={},Fg(d,h.supplemental)),(a=h.unknownCodecs)!=null&&a.length||s.push(h),n.levels.push(h)}else if(o[3]){const c=o[3],u=o[4];switch(c){case"SESSION-DATA":{const h=new ri(u,n),f=h["DATA-ID"];f&&(n.sessionData===null&&(n.sessionData={}),n.sessionData[f]=h);break}case"SESSION-KEY":{const h=Lg(u,t,n);h.encrypted&&h.isSupported()?(n.sessionKeys===null&&(n.sessionKeys=[]),n.sessionKeys.push(h)):Gt.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new ri(u,n);Bg(n,h,t)}break}case"CONTENT-STEERING":{const h=new ri(u,n);n.contentSteering={uri:ms.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{n.startTimeOffset=Pg(u);break}}}const l=s.length>0&&s.length<n.levels.length;return n.levels=l?s:n.levels,n.levels.length===0&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,i){let n;const s={},o=i.levels,a={AUDIO:o.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:o.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(Mg.lastIndex=0;(n=Mg.exec(e))!==null;){const c=new ri(n[1],i),u=c.TYPE;if(u){const h=a[u],f=s[u]||[];s[u]=f;const d=c.LANGUAGE,m=c["ASSOC-LANGUAGE"],A=c.CHANNELS,p=c.CHARACTERISTICS,y=c["INSTREAM-ID"],E={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||d||"",type:u,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:d,url:c.URI?ms.resolve(c.URI,t):""};if(m&&(E.assocLang=m),A&&(E.channels=A),p&&(E.characteristics=p),y&&(E.instreamId=y),h!=null&&h.length){const v=ms.findGroup(h,E.groupId)||h[0];kg(E,v,"audioCodec"),kg(E,v,"textCodec")}f.push(E)}}return s}static parseLevelPlaylist(e,t,i,n,s,o){var a;const l={url:t},c=new gE(t),u=c.fragments,h=[];let f=null,d=0,m=0,A=0,p=0,y=0,E=null,v=new Au(n,l),x,C,I,_=-1,S=!1,b=null,T;if(Sf.lastIndex=0,c.m3u8=e,c.hasVariableRefs=wg(e),((a=Sf.exec(e))==null?void 0:a[0])!=="#EXTM3U")return c.playlistParsingError=new Error("Missing format identifier #EXTM3U"),c;for(;(x=Sf.exec(e))!==null;){S&&(S=!1,v=new Au(n,l),v.playlistOffset=A,v.setStart(A),v.sn=d,v.cc=p,y&&(v.bitrate=y),v.level=i,f&&(v.initSegment=f,f.rawProgramDateTime&&(v.rawProgramDateTime=f.rawProgramDateTime,f.rawProgramDateTime=null),b&&(v.setByteRange(b),b=null)));const D=x[1];if(D){v.duration=parseFloat(D);const k=(" "+x[2]).slice(1);v.title=k||null,v.tagList.push(k?["INF",D,k]:["INF",D])}else if(x[3]){if(ze(v.duration)){v.playlistOffset=A,v.setStart(A),I&&Ug(v,I,c),v.sn=d,v.level=i,v.cc=p,u.push(v);const k=(" "+x[3]).slice(1);v.relurl=e0(c,k),i0(v,E,h),E=v,A+=v.duration,d++,m=0,S=!0}}else{if(x=x[0].match(Mw),!x){Gt.warn("No matches on slow regex match for level playlist!");continue}for(C=1;C<x.length&&x[C]===void 0;C++);const k=(" "+x[C]).slice(1),Q=(" "+x[C+1]).slice(1),Y=x[C+2]?(" "+x[C+2]).slice(1):null;switch(k){case"BYTERANGE":E?v.setByteRange(Q,E):v.setByteRange(Q);break;case"PROGRAM-DATE-TIME":v.rawProgramDateTime=Q,v.tagList.push(["PROGRAM-DATE-TIME",Q]),_===-1&&(_=u.length);break;case"PLAYLIST-TYPE":c.type&&Vs(c,k,x),c.type=Q.toUpperCase();break;case"MEDIA-SEQUENCE":c.startSN!==0?Vs(c,k,x):u.length>0&&Ng(c,k,x),d=c.startSN=parseInt(Q);break;case"SKIP":{c.skippedSegments&&Vs(c,k,x);const W=new ri(Q,c),P=W.decimalInteger("SKIPPED-SEGMENTS");if(ze(P)){c.skippedSegments+=P;for(let M=P;M--;)u.push(null);d+=P}const K=W.enumeratedString("RECENTLY-REMOVED-DATERANGES");K&&(c.recentlyRemovedDateranges=(c.recentlyRemovedDateranges||[]).concat(K.split("	")));break}case"TARGETDURATION":c.targetduration!==0&&Vs(c,k,x),c.targetduration=Math.max(parseInt(Q),1);break;case"VERSION":c.version!==null&&Vs(c,k,x),c.version=parseInt(Q);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":c.live||Vs(c,k,x),c.live=!1;break;case"#":(Q||Y)&&v.tagList.push(Y?[Q,Y]:[Q]);break;case"DISCONTINUITY":p++,v.tagList.push(["DIS"]);break;case"GAP":v.gap=!0,v.tagList.push([k]);break;case"BITRATE":v.tagList.push([k,Q]),y=parseInt(Q)*1e3,ze(y)?v.bitrate=y:y=0;break;case"DATERANGE":{const W=new ri(Q,c),P=new im(W,c.dateRanges[W.ID],c.dateRangeTagCount);c.dateRangeTagCount++,P.isValid||c.skippedSegments?c.dateRanges[P.id]=P:Gt.warn(`Ignoring invalid DATERANGE tag: "${Q}"`),v.tagList.push(["EXT-X-DATERANGE",Q]);break}case"DEFINE":{{const W=new ri(Q,c);"IMPORT"in W?gw(c,W,o):Bg(c,W,t)}break}case"DISCONTINUITY-SEQUENCE":c.startCC!==0?Vs(c,k,x):u.length>0&&Ng(c,k,x),c.startCC=p=parseInt(Q);break;case"KEY":{const W=Lg(Q,t,c);if(W.isSupported()){if(W.method==="NONE"){I=void 0;break}I||(I={});const P=I[W.keyFormat];P!=null&&P.matches(W)||(P&&(I=Vt({},I)),I[W.keyFormat]=W)}else Gt.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${Q}"`);break}case"START":c.startTimeOffset=Pg(Q);break;case"MAP":{const W=new ri(Q,c);if(v.duration){const P=new Au(n,l);Og(P,W,i,I),f=P,v.initSegment=f,f.rawProgramDateTime&&!v.rawProgramDateTime&&(v.rawProgramDateTime=f.rawProgramDateTime)}else{const P=v.byteRangeEndOffset;if(P){const K=v.byteRangeStartOffset;b=`${P-K}@${K}`}else b=null;Og(v,W,i,I),f=v,S=!0}f.cc=p;break}case"SERVER-CONTROL":{T&&Vs(c,k,x),T=new ri(Q),c.canBlockReload=T.bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=T.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&T.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=T.optionalFloat("PART-HOLD-BACK",0),c.holdBack=T.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{c.partTarget&&Vs(c,k,x);const W=new ri(Q);c.partTarget=W.decimalFloatingPoint("PART-TARGET");break}case"PART":{let W=c.partList;W||(W=c.partList=[]);const P=m>0?W[W.length-1]:void 0,K=m++,M=new ri(Q,c),V=new qv(M,v,l,K,P);W.push(V),v.duration+=V.duration;break}case"PRELOAD-HINT":{const W=new ri(Q,c);c.preloadHint=W;break}case"RENDITION-REPORT":{const W=new ri(Q,c);c.renditionReports=c.renditionReports||[],c.renditionReports.push(W);break}default:Gt.warn(`line parsed but not handled: ${x}`);break}}}E&&!E.relurl?(u.pop(),A-=E.duration,c.partList&&(c.fragmentHint=E)):c.partList&&(i0(v,E,h),v.cc=p,c.fragmentHint=v,I&&Ug(v,I,c)),c.targetduration||(c.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const R=u.length,w=u[0],B=u[R-1];if(A+=c.skippedSegments*c.targetduration,A>0&&R&&B){c.averagetargetduration=A/R;const D=B.sn;c.endSN=D!=="initSegment"?D:0,c.live||(B.endList=!0),_>0&&(Pw(u,_),w&&h.unshift(w))}return c.fragmentHint&&(A+=c.fragmentHint.duration),c.totalduration=A,h.length&&c.dateRangeTagCount&&w&&yE(h,c),c.endCC=p,c}}function yE(r,e){let t=r.length;if(!t)if(e.hasProgramDateTime){const a=e.fragments[e.fragments.length-1];r.push(a),t++}else return;const i=r[t-1],n=e.live?1/0:e.totalduration,s=Object.keys(e.dateRanges);for(let a=s.length;a--;){const l=e.dateRanges[s[a]],c=l.startDate.getTime();l.tagAnchor=i.ref;for(let u=t;u--;){var o;if(((o=r[u])==null?void 0:o.sn)<e.startSN)break;const h=Lw(e,c,r,u,n);if(h!==-1){l.tagAnchor=e.fragments[h].ref;break}}}}function Lw(r,e,t,i,n){const s=t[i];if(s){const a=s.programDateTime;if(e>=a||i===0){var o;const l=(((o=t[i+1])==null?void 0:o.start)||n)-s.start;if(e<=a+l*1e3){const c=t[i].sn-r.startSN;if(c<0)return-1;const u=r.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-r.startSN;for(let d=f;d>c;d--){const m=u[d].programDateTime;if(e>=m&&e<m+u[d].duration*1e3)return d}}return c}}}return-1}function Lg(r,e,t){var i,n;const s=new ri(r,t),o=(i=s.METHOD)!=null?i:"",a=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,u=(n=s.KEYFORMAT)!=null?n:"identity";a&&s.IV&&!l&&Gt.error(`Invalid IV: ${s.IV}`);const h=a?ms.resolve(a,e):"",f=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Vl(o,h,u,f,l,s.KEYID)}function Pg(r){const t=new ri(r).decimalFloatingPoint("TIME-OFFSET");return ze(t)?t:null}function Fg(r,e){let t=(r||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const n=t.filter(s=>J0(s,i));n.length&&(e[`${i}Codec`]=n.map(s=>s.split("/")[0]).join(","),t=t.filter(s=>n.indexOf(s)===-1))}),e.unknownCodecs=t}function kg(r,e,t){const i=e[t];i&&(r[t]=i)}function Pw(r,e){let t=r[e];for(let i=e;i--;){const n=r[i];if(!n)return;n.programDateTime=t.programDateTime-n.duration*1e3,t=n}}function i0(r,e,t){r.rawProgramDateTime?t.push(r):e!=null&&e.programDateTime&&(r.programDateTime=e.endProgramDateTime)}function Og(r,e,t,i){r.relurl=e.URI,e.BYTERANGE&&r.setByteRange(e.BYTERANGE),r.level=t,r.sn="initSegment",i&&(r.levelkeys=i),r.initSegment=null}function Ug(r,e,t){r.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(n=>e[n].isCommonEncryption)&&i.push(r)}function Vs(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function Ng(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function Tf(r,e){const t=e.startPTS;if(ze(t)){let i=0,n;e.sn>r.sn?(i=t-r.start,n=r):(i=r.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>r.sn?r.cc===e.cc&&r.minEndPTS?e.setStart(r.start+(r.minEndPTS-r.start)):e.setStart(r.start+r.duration):e.setStart(Math.max(r.start-e.duration,0))}function vE(r,e,t,i,n,s,o){i-t<=0&&(o.warn("Fragment should have a positive duration",e),i=t+e.duration,s=n+e.duration);let l=t,c=i;const u=e.startPTS,h=e.endPTS;if(ze(u)){const y=Math.abs(u-t);r&&y>r.totalduration?o.warn(`media timestamps and playlist times differ by ${y}s for level ${e.level} ${r.url}`):ze(e.deltaPTS)?e.deltaPTS=Math.max(y,e.deltaPTS):e.deltaPTS=y,l=Math.max(t,u),t=Math.min(t,u),n=e.startDTS!==void 0?Math.min(n,e.startDTS):n,c=Math.min(i,h),i=Math.max(i,h),s=e.endDTS!==void 0?Math.max(s,e.endDTS):s}const f=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=l,e.startDTS=n,e.endPTS=i,e.minEndPTS=c,e.endDTS=s;const d=e.sn;if(!r||d<r.startSN||d>r.endSN)return 0;let m;const A=d-r.startSN,p=r.fragments;for(p[A]=e,m=A;m>0;m--)Tf(p[m],p[m-1]);for(m=A;m<p.length-1;m++)Tf(p[m],p[m+1]);return r.fragmentHint&&Tf(p[p.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=!0,f}function Fw(r,e,t){if(r===e)return;let i=null;const n=r.fragments;for(let u=n.length-1;u>=0;u--){const h=n[u].initSegment;if(h){i=h;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;let s;Uw(r,e,(u,h,f,d)=>{if((!e.startCC||e.skippedSegments)&&h.cc!==u.cc){const m=u.cc-h.cc;for(let A=f;A<d.length;A++)d[A].cc+=m;e.endCC=d[d.length-1].cc}ze(u.startPTS)&&ze(u.endPTS)&&(h.setStart(h.startPTS=u.startPTS),h.startDTS=u.startDTS,h.maxStartPTS=u.maxStartPTS,h.endPTS=u.endPTS,h.endDTS=u.endDTS,h.minEndPTS=u.minEndPTS,h.setDuration(u.endPTS-u.startPTS),h.duration&&(s=h),e.PTSKnown=e.alignedSliding=!0),u.hasStreams&&(h.elementaryStreams=u.elementaryStreams),h.loader=u.loader,u.hasStats&&(h.stats=u.stats),u.initSegment&&(h.initSegment=u.initSegment,i=u.initSegment)});const o=e.fragments,a=e.fragmentHint?o.concat(e.fragmentHint):o;if(i&&a.forEach(u=>{var h;u&&(!u.initSegment||u.initSegment.relurl===((h=i)==null?void 0:h.relurl))&&(u.initSegment=i)}),e.skippedSegments){if(e.deltaUpdateFailed=o.some(u=>!u),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let u=e.skippedSegments;u--;)o.shift();e.startSN=o[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=kw(r.dateRanges,e,t));const u=r.fragments.filter(h=>h.rawProgramDateTime);if(r.hasProgramDateTime&&!e.hasProgramDateTime)for(let h=1;h<a.length;h++)a[h].programDateTime===null&&i0(a[h],a[h-1],u);yE(u,e)}e.endCC=o[o.length-1].cc}if(!e.startCC){var l;const u=CE(r,e.startSN-1);e.startCC=(l=u==null?void 0:u.cc)!=null?l:o[0].cc}Ow(r.partList,e.partList,(u,h)=>{h.elementaryStreams=u.elementaryStreams,h.stats=u.stats}),s?vE(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS,t):EE(r,e),o.length&&(e.totalduration=e.edge-o[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;const c=e.advancedDateTime;if(e.advanced&&c){const u=e.edge;e.driftStart||(e.driftStartTime=c,e.driftStart=u),e.driftEndTime=c,e.driftEnd=u}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=r.requestScheduled)}function kw(r,e,t){const{dateRanges:i,recentlyRemovedDateranges:n}=e,s=Vt({},r);n&&n.forEach(l=>{delete s[l]});const a=Object.keys(s).length;return a?(Object.keys(i).forEach(l=>{const c=s[l],u=new im(i[l].attr,c);u.isValid?(s[l]=u,c||(u.tagOrder+=a)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${ti(i[l].attr)}"`)}),s):i}function Ow(r,e,t){if(r&&e){let i=0;for(let n=0,s=r.length;n<=s;n++){const o=r[n],a=e[n+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function Uw(r,e,t){const i=e.skippedSegments,n=Math.max(r.startSN,e.startSN)-e.startSN,s=(r.fragmentHint?1:0)+(i?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,o=e.startSN-r.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments;for(let c=n;c<=s;c++){const u=l[o+c];let h=a[c];if(i&&!h&&u&&(h=e.fragments[c]=u),u&&h){t(u,h,c,a);const f=u.relurl,d=h.relurl;if(f&&Nw(f,d)){e.playlistParsingError=Gg(`media sequence mismatch ${h.sn}:`,r,e,u,h);return}else if(u.cc!==h.cc){e.playlistParsingError=Gg(`discontinuity sequence mismatch (${u.cc}!=${h.cc})`,r,e,u,h);return}}}}function Gg(r,e,t,i,n){return new Error(`${r} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function EE(r,e,t=!0){const i=e.startSN+e.skippedSegments-r.startSN,n=r.fragments,s=i>=0;let o=0;if(s&&i<n.length)o=n[i].start;else if(s&&e.startSN===r.endSN+1)o=r.fragmentEnd;else if(s&&t)o=r.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=r.fragmentStart;else return;n0(e,o)}function n0(r,e){if(e){const t=r.fragments;for(let i=r.skippedSegments;i<t.length;i++)t[i].addStart(e);r.fragmentHint&&r.fragmentHint.addStart(e)}}function xE(r,e=1/0){let t=1e3*r.targetduration;if(r.updated){const i=r.fragments,n=4;if(i.length&&t*n>e){const s=i[i.length-1].duration*1e3;s<t&&(t=s)}}else t/=2;return Math.round(t)}function CE(r,e,t){if(!r)return null;let i=r.fragments[e-r.startSN];return i||(i=r.fragmentHint,i&&i.sn===e)?i:e<r.startSN&&t&&t.sn===e?t:null}function Qg(r,e,t){return r?IE(r.partList,e,t):null}function IE(r,e,t){if(r)for(let i=r.length;i--;){const n=r[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function _E(r){r.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function Nw(r,e){return r!==e&&e?zg(r)!==zg(e):!1}function zg(r){return r.replace(/\?[^?]*$/,"")}function Il(r,e){for(let i=0,n=r.length;i<n;i++){var t;if(((t=r[i])==null?void 0:t.cc)===e)return r[i]}return null}function Gw(r,e){return!!(r&&e.startCC<r.endCC&&e.endCC>r.startCC)}function Hg(r,e){const t=r.start+e;r.startPTS=t,r.setStart(t),r.endPTS=t+r.duration}function SE(r,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)Hg(t[i],r);e.fragmentHint&&Hg(e.fragmentHint,r),e.alignedSliding=!0}function Qw(r,e){r&&(TE(e,r),e.alignedSliding||Qu(e,r),!e.alignedSliding&&!e.skippedSegments&&EE(r,e,!1))}function TE(r,e){if(!Gw(e,r))return;const t=Math.min(e.endCC,r.endCC),i=Il(e.fragments,t),n=Il(r.fragments,t);if(!i||!n)return;Gt.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const s=i.start-n.start;SE(s,r)}function Qu(r,e){if(!r.hasProgramDateTime||!e.hasProgramDateTime)return;const t=r.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,s;const o=Math.min(e.endCC,r.endCC);e.startCC<o&&r.startCC<o&&(n=Il(i,o),s=Il(t,o)),(!n||!s)&&(n=i[Math.floor(i.length/2)],s=Il(t,n.cc)||t[Math.floor(t.length/2)]);const a=n.programDateTime,l=s.programDateTime;if(!a||!l)return;const c=(l-a)/1e3-(s.start-n.start);SE(c,r)}const zw={toString:function(r){let e="";const t=r.length;for(let i=0;i<t;i++)e+=`[${r.start(i).toFixed(3)}-${r.end(i).toFixed(3)}]`;return e}},be={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class oh extends AE{constructor(e,t,i,n,s){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=be.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:l,mediaBuffer:c,state:u}=this,h=l?l.currentTime:0,f=ft.bufferInfo(c||l,h,o.maxBufferHole),d=!f.len;if(this.log(`Media seeking to ${ze(h)?h.toFixed(3):h}, state: ${u}, ${d?"out of":"in"} buffer`),this.state===be.ENDED)this.resetLoadingState();else if(a){const m=o.maxFragLookUpTolerance,A=a.start-m,p=a.start+a.duration+m;if(d||p<f.start||A>f.end){const y=h>p;(h<A||y)&&(y&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(h,1/0,this.playlistType,!0);const m=this.lastCurrentTime;if(h>m&&(this.lastCurrentTime=h),!this.loadingParts){const A=Math.max(f.end,h),p=this.shouldLoadParts(this.getLevelDetails(),A);p&&(this.log(`LL-Part loading ON after seeking to ${h.toFixed(2)} with buffer @${A.toFixed(2)}`),this.loadingParts=p)}}this.hls.hasEnoughToStart||(this.log(`Setting ${d?"startPosition":"nextLoadPosition"} to ${h} for seek without enough to start`),this.nextLoadPosition=h,d&&(this.startPosition=h)),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=s,this.hls=e,this.fragmentLoader=new Aw(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new tm(e.config)}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===be.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=be.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const s=e.buffered;this.config.maxBufferHole&&s&&s.length>1&&(e=ft.bufferedInfo(s,e.start,0));const o=e.nextStart;if(o&&o>n&&o<t.edge||this.media.currentTime<e.start)return!1;const l=t.partList;if(l!=null&&l.length){const u=l[l.length-1];return ft.isBuffered(this.media,u.start+u.duration/2)}const c=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(c)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===be.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=be.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=s=>{const o=s.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${s.part?" part: "+s.part.index:""} of ${this.fragInfo(o,!1,s.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(s)};this._doFragLoad(e,t,i,n).then(s=>{if(!s)return;const o=this.state,a=s.frag;if(this.fragContextChanged(a)){(o===be.FRAG_LOADING||!this.fragCurrent&&o===be.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=be.IDLE);return}"payload"in s&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(L.FRAG_LOADED,s)),this._handleFragmentLoadComplete(s)}).catch(s=>{this.state===be.STOPPED||this.state===be.ERROR||(this.warn(`Frag error: ${(s==null?void 0:s.message)||s}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===Fi.APPENDING){const s=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,s),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Fi.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(L.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i==null?void 0:i.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:s,payload:o}=i,a=s.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&sa(a.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,nm(a.method)).catch(c=>{throw n.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:s}),c}).then(c=>{const u=self.performance.now();return n.trigger(L.FRAG_DECRYPTED,{frag:s,payload:c,stats:{tstart:l,tdecrypt:u}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===be.STOPPED||this.state===be.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==be.STOPPED&&(this.state=be.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var i,n;const s=e.tracks;if(s&&!t.encrypted&&((i=s.audio)!=null&&i.encrypted||(n=s.video)!=null&&n.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const o=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${o?"attached mediaKeys: "+o.mediaKeys:"detached"})`);return this.warn(a.message),!o||o.mediaKeys?!1:(this.hls.trigger(L.ERROR,{type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?zw.toString(ft.getBuffered(i)):"(detached)"})`),bi(e)){var n;if(e.type!==$e.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=be.IDLE;return}}const s=(n=this.levels)==null?void 0:n[e.level];s!=null&&s.fragmentError&&(this.log(`Resetting level fragment error count of ${s.fragmentError} on frag buffered`),s.fragmentError=0)}this.state=be.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:s}=e,o=!s||s.length===0||s.some(l=>!l),a=new rh(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var s;this.fragCurrent=e;const o=t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;e.encrypted&&!((s=e.decryptdata)!=null&&s.key)?(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=be.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(f=>{if(!this.fragContextChanged(f.frag))return this.hls.trigger(L.KEY_LOADED,f),this.state===be.KEY_LOADING&&(this.state=be.IDLE),f}),this.hls.trigger(L.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const l=this.fragPrevious;if(bi(e)&&(!l||e.sn!==l.sn)){const f=this.shouldLoadParts(t.details,e.end);f!==this.loadingParts&&(this.log(`LL-Part loading ${f?"ON":"OFF"} loading sn ${l==null?void 0:l.sn}->${e.sn}`),this.loadingParts=f)}if(i=Math.max(e.start,i||0),this.loadingParts&&bi(e)){const f=o.partList;if(f&&n){i>o.fragmentEnd&&o.fragmentHint&&(e=o.fragmentHint);const d=this.getNextPart(f,e,i);if(d>-1){const m=f[d];e=this.fragCurrent=m.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${m.index} (${d}/${f.length-1}) of ${this.fragInfo(e,!1,m)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=m.start+m.duration,this.state=be.FRAG_LOADING;let A;return a?A=a.then(p=>!p||this.fragContextChanged(p.frag)?null:this.doFragPartsLoad(e,m,t,n)).catch(p=>this.handleFragLoadError(p)):A=this.doFragPartsLoad(e,m,t,n).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(L.FRAG_LOADING,{frag:e,part:m,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):A}else if(!e.url||this.loadedEndOfParts(f,i))return Promise.resolve(null)}}if(bi(e)&&this.loadingParts){var c;this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(c=o.partList)==null?void 0:c.filter(f=>f.loaded).map(f=>`[${f.start}-${f.end}]`)}`),this.loadingParts=!1}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${"["+o.startSN+"-"+o.endSN+"]"}, target: ${parseFloat(i.toFixed(3))}`),ze(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=be.FRAG_LOADING;const u=this.config.progressive;let h;return u&&a?h=a.then(f=>!f||this.fragContextChanged(f.frag)?null:this.fragmentLoader.load(e,n)).catch(f=>this.handleFragLoadError(f)):h=Promise.all([this.fragmentLoader.load(e,u?n:void 0),a]).then(([f])=>(!u&&n&&n(f),f)).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(L.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(e,t,i,n){return new Promise((s,o)=>{var a;const l=[],c=(a=i.details)==null?void 0:a.partList,u=h=>{this.fragmentLoader.loadPart(e,h,n).then(f=>{l[h.index]=f;const d=f.part;this.hls.trigger(L.FRAG_LOADED,f);const m=Qg(i.details,e.sn,h.index+1)||IE(c,e.sn,h.index+1);if(m)u(m);else return s({frag:e,part:d,partsLoaded:l})}).catch(o)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;t&&t.details===ue.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(L.ERROR,t)}else this.hls.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==be.PARSING){!this.fragCurrent&&this.state!==be.STOPPED&&this.state!==be.ERROR&&(this.state=be.IDLE);return}const{frag:i,part:n,level:s}=t,o=self.performance.now();i.stats.parsing.end=o,n&&(n.stats.parsing.end=o);const a=this.getLevelDetails(),c=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(i,n,s,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var i;const s=e.partList[0];if(s.fragment.type===$e.SUBTITLE)return!1;const o=s.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>s.start-s.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:s,part:o}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${s} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const a=t[n],l=a.details,c=o>-1?Qg(l,s,o):null,u=c?c.fragment:CE(l,s,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:c,level:a}):null}bufferFragmentData(e,t,i,n,s){if(this.state!==be.PARSING)return;const{data1:o,data2:a}=e;let l=o;if(a&&(l=Jn(o,a)),!l.length)return;const c=this.initPTS[t.cc],u=c?-c.baseTime/c.timescale:void 0,h={type:e.type,frag:t,part:i,chunkMeta:n,offset:u,parent:t.type,data:l};if(this.hls.trigger(L.BUFFER_APPENDING,h),e.dropped&&e.independent&&!i){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!ft.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=ft.bufferInfo(t,i,0),s=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,s*.25),a=Math.max(Math.min(e.start-o,n.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!ze(n))return null;const o=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,o)}getFwdBufferInfoAtPos(e,t,i,n){const s=ft.bufferInfo(e,t,n);if(s.len===0&&s.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(s.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(s.nextStart,o.end)-t,n);return ft.bufferInfo(e,t,a)}}return s}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),s=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return s>=n?(i.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0):!1}getAppendedFrag(e,t=$e.MAIN){const i=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:s}=this,o=i[0].start,a=s.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const h=s.initialLiveManifestSize;if(n<h)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${h})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var c;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t);const f=this.hls.startPosition,d=this.hls.liveSyncPosition,m=l?(f!==-1&&f>=o?f:d)||l.start:e;this.log(`Setting startPosition to ${m} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${d} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=m}}else e<=o&&(l=i[0]);if(!l){const h=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,h,t)}let u=this.filterReplacedPrimary(l,t);if(!u&&l){const h=l.sn-t.startSN;u=this.filterReplacedPrimary(i[h+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Fi.OK||i===Fi.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,s){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(a!==null&&i.len+a.len>=s){const l=o.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(Vg(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(Vg(this.config)&&e.type!==$e.SUBTITLE){const i=this.hls.interstitialsManager,n=i==null?void 0:i.bufferingItem;if(n){const o=n.event;if(o){if(o.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&(t==null?void 0:t.live)===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const s=i==null?void 0:i.playerQueue;if(s)for(let o=s.length;o--;){const a=s[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,s=!1,o=!0;for(let a=0,l=e.length;a<l;a++){const c=e[a];if(o=o&&!c.independent,n>-1&&i<c.start)break;const u=c.loaded;u?n=-1:(s||(c.independent||o)&&c.fragment===t)&&(c.fragment!==t&&this.warn(`Need buffer at ${i} but next unloaded part starts at ${c.start}`),n=a),s=u}return n}loadedEndOfParts(e,t){let i;for(let n=e.length;n--;){if(i=e[n],!i.loaded)return!1;if(t>i.start)return!0}return!1}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=sw(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const s=i.sn+1;if(s>=e.startSN&&s<=e.endSN){const o=t[s-e.startSN];i.cc===o.cc&&(n=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=dE(e,i.cc,i.end),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const s=this.hls.liveSyncPosition;s!==null&&(n=this.getFragmentAtPosition(s,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:s}=this,{fragments:o,endSN:a}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=n,u=i.partList,h=!!(this.loadingParts&&u!=null&&u.length&&l);h&&!this.bitrateTest&&u[u.length-1].fragment.sn===l.sn&&(o=o.concat(l),a=l.sn);let f;if(e<t){var d;const A=e<this.lastCurrentTime||e>t-c||(d=this.media)!=null&&d.paused||!this.startFragRequested?0:c;f=no(s,o,e,A)}else f=o[o.length-1];if(f){const m=f.sn-i.startSN,A=this.fragmentTracker.getState(f);if((A===Fi.OK||A===Fi.PARTIAL&&f.gap)&&(s=f),s&&f.sn===s.sn&&(!h||u[0].fragment.sn>f.sn||!i.live)&&f.level===s.level){const y=o[m+1];f.sn<a&&this.fragmentTracker.getState(y)!==Fi.OK?f=y:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const s=e.fragmentStart,o=!t,a=e.alignedSliding&&ze(s);if(o||!a&&!s){Qw(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),l}return s}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const s=this.startTimeOffset!==null,o=s?this.startTimeOffset:e.startTimeOffset;o!==null&&ze(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${s?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&bi(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==be.FRAG_LOADING_WAITING_RETRY)&&(this.state=be.IDLE)}onFragmentOrKeyLoadError(e,t){var i;if(t.chunkMeta&&!t.frag){const p=this.getCurrentContext(t.chunkMeta);p&&(t.frag=p.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;if(this.fragContextChanged(n)){var s;this.warn(`Frag load error must match current frag to retry ${n.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const o=t.details===ue.FRAG_GAP;o&&this.fragmentTracker.fragBuffered(n,!0);const a=t.errorAction,{action:l,flags:c,retryCount:u=0,retryConfig:h}=a||{},f=!!a&&!!h,d=f&&l===zi.RetryRequest,m=f&&!a.resolved&&c===Hn.MoveAllAlternatesMatchingHost,A=((i=t.response)==null?void 0:i.code)||0;if(!d&&m&&bi(n)&&!n.endList&&A!==0)this.resetFragmentErrors(e),this.treatAsGap(n),a.resolved=!0;else if((d||m)&&u<h.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const p=em(h,u);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${u+1}/${h.maxNumRetry} in ${p}ms`),a.resolved=!0,this.retryDate=self.performance.now()+p,this.state=be.FRAG_LOADING_WAITING_RETRY}else if(h&&a)if(this.resetFragmentErrors(e),u<h.maxNumRetry)!o&&l!==zi.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${u})`);return}else l===zi.SendAlternateToPenaltyBox?this.state=be.WAITING_LEVEL:this.state=be.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===be.PARSING||this.state===be.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),s=n&&n.len>.5;s&&this.reduceMaxBufferLength(n.len,(t==null?void 0:t.duration)||10);const o=!s;return o&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===$e.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==be.STOPPED&&(this.state=be.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=ft.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===be.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==be.STOPPED&&(this.state=be.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const s=i.details;if(!s){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${h})`),l||!1;const f=n?0:vE(s,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS,this);return this.hls.trigger(L.LEVEL_PTS_UPDATED,{details:s,level:i,drift:f,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)){var a;if(i.fragmentError===0&&this.treatAsGap(e,i),((a=this.transmuxer)==null?void 0:a.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=be.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(L.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===$e.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,s;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((s=t&&!i?e.endPTS:(i||e).end)!=null?s:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function Vg(r){return!!r.interstitialsController&&r.enableInterstitialPlayback!==!1}class bE{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=Hw(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function Hw(r,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}var bf={exports:{}},Kg;function Vw(){return Kg||(Kg=1,function(r){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new n(u,h||l,f),m=t?t+c:c;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],d]:l._events[m].push(d):(l._events[m]=d,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)e.call(u,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},a.prototype.listeners=function(c){var u=t?t+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,m=new Array(d);f<d;f++)m[f]=h[f].fn;return m},a.prototype.listenerCount=function(c){var u=t?t+c:c,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(c,u,h,f,d,m){var A=t?t+c:c;if(!this._events[A])return!1;var p=this._events[A],y=arguments.length,E,v;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),y){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,u),!0;case 3:return p.fn.call(p.context,u,h),!0;case 4:return p.fn.call(p.context,u,h,f),!0;case 5:return p.fn.call(p.context,u,h,f,d),!0;case 6:return p.fn.call(p.context,u,h,f,d,m),!0}for(v=1,E=new Array(y-1);v<y;v++)E[v-1]=arguments[v];p.fn.apply(p.context,E)}else{var x=p.length,C;for(v=0;v<x;v++)switch(p[v].once&&this.removeListener(c,p[v].fn,void 0,!0),y){case 1:p[v].fn.call(p[v].context);break;case 2:p[v].fn.call(p[v].context,u);break;case 3:p[v].fn.call(p[v].context,u,h);break;case 4:p[v].fn.call(p[v].context,u,h,f);break;default:if(!E)for(C=1,E=new Array(y-1);C<y;C++)E[C-1]=arguments[C];p[v].fn.apply(p[v].context,E)}}return!0},a.prototype.on=function(c,u,h){return s(this,c,u,h,!1)},a.prototype.once=function(c,u,h){return s(this,c,u,h,!0)},a.prototype.removeListener=function(c,u,h,f){var d=t?t+c:c;if(!this._events[d])return this;if(!u)return o(this,d),this;var m=this._events[d];if(m.fn)m.fn===u&&(!f||m.once)&&(!h||m.context===h)&&o(this,d);else{for(var A=0,p=[],y=m.length;A<y;A++)(m[A].fn!==u||f&&!m[A].once||h&&m[A].context!==h)&&p.push(m[A]);p.length?this._events[d]=p.length===1?p[0]:p:o(this,d)}return this},a.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&o(this,u)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a}(bf)),bf.exports}var Kw=Vw(),om=Ib(Kw);const Ll="1.6.10",da={};function $w(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Yw(){const r=da[Ll];if(r)return r.clientCount++,r;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return da[Ll]=n,n}function Ww(r){const e=da[r];if(e)return e.clientCount++,e;const t=new self.URL(r,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return da[r]=n,n}function jw(r){const e=da[r||Ll];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete da[r||Ll],n&&self.URL.revokeObjectURL(n),i.terminate()}}function wE(r,e){return e+10<=r.length&&r[e]===51&&r[e+1]===68&&r[e+2]===73&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function am(r,e){return e+10<=r.length&&r[e]===73&&r[e+1]===68&&r[e+2]===51&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function ah(r,e){let t=0;return t=(r[e]&127)<<21,t|=(r[e+1]&127)<<14,t|=(r[e+2]&127)<<7,t|=r[e+3]&127,t}function Pl(r,e){const t=e;let i=0;for(;am(r,e);){i+=10;const n=ah(r,e+6);i+=n,wE(r,e+10)&&(i+=10),e+=i}if(i>0)return r.subarray(t,t+i)}function Xw(r,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],s=e[t+2],o=s>>2&15;if(o>12){const d=new Error(`invalid ADTS sampling index:${o}`);r.emit(L.ERROR,L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}const a=(s>>6&3)+1,l=e[t+3]>>6&3|(s&1)<<2,c="mp4a.40."+a,u=n[o];let h=o;(a===5||a===29)&&(h-=3);const f=[a<<3|(h&14)>>1,(h&1)<<7|l<<3];return Gt.log(`manifest codec:${i}, parsed codec:${c}, channels:${l}, rate:${u} (ADTS object type:${a} sampling index:${o})`),{config:f,samplerate:u,channelCount:l,codec:c,parsedCodec:c,manifestCodec:i}}function BE(r,e){return r[e]===255&&(r[e+1]&246)===240}function RE(r,e){return r[e+1]&1?7:9}function lm(r,e){return(r[e+3]&3)<<11|r[e+4]<<3|(r[e+5]&224)>>>5}function qw(r,e){return e+5<r.length}function zu(r,e){return e+1<r.length&&BE(r,e)}function Jw(r,e){return qw(r,e)&&BE(r,e)&&lm(r,e)<=r.length-e}function Zw(r,e){if(zu(r,e)){const t=RE(r,e);if(e+t>=r.length)return!1;const i=lm(r,e);if(i<=t)return!1;const n=e+i;return n===r.length||zu(r,n)}return!1}function DE(r,e,t,i,n){if(!r.samplerate){const s=Xw(e,t,i,n);if(!s)return;Vt(r,s)}}function ME(r){return 1024*9e4/r}function e8(r,e){const t=RE(r,e);if(e+t<=r.length){const i=lm(r,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function LE(r,e,t,i,n){const s=ME(r.samplerate),o=i+n*s,a=e8(e,t);let l;if(a){const{frameLength:h,headerLength:f}=a,d=f+h,m=Math.max(0,t+d-e.length);m?(l=new Uint8Array(d-f),l.set(e.subarray(t+f,e.length),0)):l=e.subarray(t+f,t+d);const A={unit:l,pts:o};return m||r.samples.push(A),{sample:A,length:d,missing:m}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:o},length:c,missing:-1}}function t8(r,e){return am(r,e)&&ah(r,e+6)+10<=r.length-e}function i8(r){return r instanceof ArrayBuffer?r:r.byteOffset==0&&r.byteLength==r.buffer.byteLength?r.buffer:new Uint8Array(r).buffer}function wf(r,e=0,t=1/0){return n8(r,e,t,Uint8Array)}function n8(r,e,t,i){const n=s8(r);let s=1;"BYTES_PER_ELEMENT"in i&&(s=i.BYTES_PER_ELEMENT);const o=r8(r)?r.byteOffset:0,a=(o+r.byteLength)/s,l=(o+e)/s,c=Math.floor(Math.max(0,Math.min(l,a))),u=Math.floor(Math.min(c+Math.max(t,0),a));return new i(n,c,u-c)}function s8(r){return r instanceof ArrayBuffer?r:r.buffer}function r8(r){return r&&r.buffer instanceof ArrayBuffer&&r.byteLength!==void 0&&r.byteOffset!==void 0}function o8(r){const e={key:r.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(r.size<2)return;if(r.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=r.data.subarray(1).indexOf(0);if(i===-1)return;const n=Ln(wf(r.data,1,i)),s=r.data[2+i],o=r.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=Ln(wf(r.data,3+i,o));let l;return n==="-->"?l=Ln(wf(r.data,4+i+o)):l=i8(r.data.subarray(4+i+o)),e.mimeType=n,e.pictureType=s,e.description=a,e.data=l,e}function a8(r){if(r.size<2)return;const e=Ln(r.data,!0),t=new Uint8Array(r.data.subarray(e.length+1));return{key:r.type,info:e,data:t.buffer}}function l8(r){if(r.size<2)return;if(r.type==="TXXX"){let t=1;const i=Ln(r.data.subarray(t),!0);t+=i.length+1;const n=Ln(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Ln(r.data.subarray(1));return{key:r.type,info:"",data:e}}function c8(r){if(r.type==="WXXX"){if(r.size<2)return;let t=1;const i=Ln(r.data.subarray(t),!0);t+=i.length+1;const n=Ln(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Ln(r.data);return{key:r.type,info:"",data:e}}function u8(r){return r.type==="PRIV"?a8(r):r.type[0]==="W"?c8(r):r.type==="APIC"?o8(r):l8(r)}function h8(r){const e=String.fromCharCode(r[0],r[1],r[2],r[3]),t=ah(r,4),i=10;return{type:e,size:t,data:r.subarray(i,i+t)}}const wc=10,f8=10;function PE(r){let e=0;const t=[];for(;am(r,e);){const i=ah(r,e+6);r[e+5]>>6&1&&(e+=wc),e+=wc;const n=e+i;for(;e+f8<n;){const s=h8(r.subarray(e)),o=u8(s);o&&t.push(o),e+=s.size+wc}wE(r,e)&&(e+=wc)}return t}function FE(r){return r&&r.key==="PRIV"&&r.info==="com.apple.streaming.transportStreamTimestamp"}function d8(r){if(r.data.byteLength===8){const e=new Uint8Array(r.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function cm(r){const e=PE(r);for(let t=0;t<e.length;t++){const i=e[t];if(FE(i))return d8(i)}}let pn=function(r){return r.audioId3="org.id3",r.dateRange="com.apple.quicktime.HLS",r.emsg="https://aomedia.org/emsg/ID3",r.misbklv="urn:misb:KLV:bin:1910.1",r}({});function ws(r="",e=9e4){return{type:r,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class um{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Jn(this.cachedData,e),this.cachedData=null);let i=Pl(e,0),n=i?i.length:0,s;const o=this._audioTrack,a=this._id3Track,l=i?cm(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&ze(l))&&(this.basePTS=m8(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:pn.audioId3,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(e,n)){const u=this.appendFrame(o,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,s=n):n=c}else t8(e,n)?(i=Pl(e,n),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:pn.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,s=n):n++;if(n===c&&s!==c){const u=e.slice(s);this.cachedData?this.cachedData=Jn(this.cachedData,u):this.cachedData=u}}return{audioTrack:o,videoTrack:ws(),id3Track:a,textTrack:ws()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:ws(),id3Track:this._id3Track,textTrack:ws()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const m8=(r,e,t)=>{if(ze(r))return r*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let Bc=null;const A8=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],p8=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],g8=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],y8=[0,1,1,4];function kE(r,e,t,i,n){if(t+24>e.length)return;const s=OE(e,t);if(s&&t+s.frameLength<=e.length){const o=s.samplesPerFrame*9e4/s.sampleRate,a=i+n*o,l={unit:e.subarray(t,t+s.frameLength),pts:a,dts:a};return r.config=[],r.channelCount=s.channelCount,r.samplerate=s.sampleRate,r.samples.push(l),{sample:l,length:s.frameLength,missing:0}}}function OE(r,e){const t=r[e+1]>>3&3,i=r[e+1]>>1&3,n=r[e+2]>>4&15,s=r[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&s!==3){const o=r[e+2]>>1&1,a=r[e+3]>>6,l=t===3?3-i:i===3?3:4,c=A8[l*14+n-1]*1e3,h=p8[(t===3?0:t===2?1:2)*3+s],f=a===3?1:2,d=g8[t][i],m=y8[i],A=d*8*m,p=Math.floor(d*c/h+o)*m;if(Bc===null){const v=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Bc=v?parseInt(v[1]):0}return!!Bc&&Bc<=87&&i===2&&c>=224e3&&a===0&&(r[e+3]=r[e+3]|128),{sampleRate:h,channelCount:f,frameLength:p,samplesPerFrame:A}}}function hm(r,e){return r[e]===255&&(r[e+1]&224)===224&&(r[e+1]&6)!==0}function UE(r,e){return e+1<r.length&&hm(r,e)}function v8(r,e){return hm(r,e)&&4<=r.length-e}function NE(r,e){if(e+1<r.length&&hm(r,e)){const i=OE(r,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const s=e+n;return s===r.length||UE(r,s)}return!1}class E8 extends um{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=Pl(e,0);let n=(i==null?void 0:i.length)||0;if(NE(e,n))return!1;for(let s=e.length;n<s;n++)if(Zw(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Jw(e,t)}appendFrame(e,t,i){DE(e,this.observer,t,i,e.manifestCodec);const n=LE(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const GE=(r,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),s=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=r[e];const a=Math.min(i,8),l=8-a;s[0]=4278190080>>>24+l<<l,n[0]=(o[0]&s[0])>>l,t=t?t<<a|n[0]:n[0],e+=1,i-=a}return t};class x8 extends um{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=QE(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=Pl(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&cm(t)!==void 0&&GE(e,i)<16}}function QE(r,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const s=e[t+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+s]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const d=(e[t+6]<<8|e[t+7])>>12-f&1,A=[2,1,2,3,3,4,4,5][h]+d,p=e[t+5]>>3,y=e[t+5]&7,E=new Uint8Array([s<<6|p<<1|y>>2,(y&3)<<6|h<<3|d<<2|l>>4,l<<4&224]),v=1536/a*9e4,x=i+n*v,C=e.subarray(t,t+u);return r.config=E,r.channelCount=A,r.samplerate=a,r.samples.push({unit:C,pts:x}),u}class C8 extends um{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Pl(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&cm(t)!==void 0&&GE(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(NE(e,i))return Gt.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return v8(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return kE(e,t,i,this.basePTS,this.frameIndex)}}const I8=/\/emsg[-/]ID3/i;class _8{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const s=this.videoTrack=ws("video",1),o=this.audioTrack=ws("audio",1),a=this.txtTrack=ws("text",1);if(this.id3Track=ws("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=iE(e);if(l.video){const{id:c,timescale:u,codec:h,supplemental:f}=l.video;s.id=c,s.timescale=a.timescale=u,s.codec=h,s.supplemental=f}if(l.audio){const{id:c,timescale:u,codec:h}=l.audio;o.id=c,o.timescale=u,o.codec=h}a.id=Zv.text,s.sampleDuration=0,s.duration=o.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return bb(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Jn(this.remainderData,e));const a=Lb(i);this.remainderData=a.remainder,n.samples=a.valid||new Uint8Array}else n.samples=i;const o=this.extractID3Track(n,t);return s.samples=fg(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=fg(e,t),{videoTrack:t,audioTrack:ws(),id3Track:n,textTrack:ws()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=Et(e.samples,["emsg"]);n&&n.forEach(s=>{const o=Fb(s);if(I8.test(o.schemeIdUri)){const a=$g(o,t);let l=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=o.payload;i.samples.push({data:c,len:c.byteLength,dts:a,pts:a,type:pn.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=$g(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:pn.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function $g(r,e){return ze(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale}class S8{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new tm(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Br.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const s=n.subarray(16,n.length-n.length%16),o=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(o).then(a=>{const l=new Uint8Array(a);n.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)i.set(e.subarray(s,s+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)e.set(i.subarray(n,n+16),s);return e}decryptAvcSample(e,t,i,n,s){const o=sE(s.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(l=>{s.data=this.getAvcDecryptedUnit(o,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)})}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const s=e[t].units;for(;!(i>=s.length);i++){const o=s[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,n,o),!this.decrypter.isSync()))return}}}}class zE{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const s=i.units;n=s[s.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const s=i[n-1];e.pts=s.pts,e.dts=s.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let s=e.naluState||0;const o=s,a=[];let l=0,c,u,h,f=-1,d=0;for(s===-1&&(f=0,d=this.getNALuType(t,0),s=0,l=1);l<n;){if(c=t[l++],!s){s=c?0:1;continue}if(s===1){s=c?0:2;continue}if(!c)s=3;else if(c===1){if(u=l-s-1,f>=0){const m={data:t.subarray(f,u),type:d};a.push(m)}else{const m=this.getLastNalUnit(e.samples);m&&(o&&l<=4-o&&m.state&&(m.data=m.data.subarray(0,m.data.byteLength-o)),u>0&&(m.data=Jn(m.data,t.subarray(0,u)),m.state=0))}l<n?(h=this.getNALuType(t,l),f=l,d=h,s=0):s=-1}else s=0}if(f>=0&&s>=0){const m={data:t.subarray(f,n),type:d,state:s};a.push(m)}if(a.length===0){const m=this.getLastNalUnit(e.samples);m&&(m.data=Jn(m.data,t))}return e.naluState=s,a}}class _l{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),s=Math.min(4,t);if(s===0)throw new Error("no bytes available");n.set(e.subarray(i,i+s)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&Gt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class T8 extends zE{parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 1:{let A=!1;a=!0;const p=c.data;if(l&&p.length>4){const y=this.readSliceType(p);(y===2||y===4||y===7||y===9)&&(A=!0)}if(A){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=A;break}case 5:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,q0(c.data,1,i.pts,t.samples);break}case 7:{var d,m;a=!0,l=!0;const A=c.data,p=this.readSPS(A);if(!e.sps||e.width!==p.width||e.height!==p.height||((d=e.pixelRatio)==null?void 0:d[0])!==p.pixelRatio[0]||((m=e.pixelRatio)==null?void 0:m[1])!==p.pixelRatio[1]){e.width=p.width,e.height=p.height,e.pixelRatio=p.pixelRatio,e.sps=[A];const y=A.subarray(1,4);let E="avc1.";for(let v=0;v<3;v++){let x=y[v].toString(16);x.length<2&&(x="0"+x),E+=x}e.codec=E}break}case 8:a=!0,e.pps=[c.data];break;case 9:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new _l(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,s;for(let o=0;o<e;o++)n!==0&&(s=t.readEG(),n=(i+s+256)%256),i=n===0?i:n}readSPS(e){const t=new _l(e);let i=0,n=0,s=0,o=0,a,l,c;const u=t.readUByte.bind(t),h=t.readBits.bind(t),f=t.readUEG.bind(t),d=t.readBoolean.bind(t),m=t.skipBits.bind(t),A=t.skipEG.bind(t),p=t.skipUEG.bind(t),y=this.skipScalingList.bind(this);u();const E=u();if(h(5),m(3),u(),p(),E===100||E===110||E===122||E===244||E===44||E===83||E===86||E===118||E===128){const S=f();if(S===3&&m(1),p(),p(),m(1),d())for(l=S!==3?8:12,c=0;c<l;c++)d()&&(c<6?y(16,t):y(64,t))}p();const v=f();if(v===0)f();else if(v===1)for(m(1),A(),A(),a=f(),c=0;c<a;c++)A();p(),m(1);const x=f(),C=f(),I=h(1);I===0&&m(1),m(1),d()&&(i=f(),n=f(),s=f(),o=f());let _=[1,1];if(d()&&d())switch(u()){case 1:_=[1,1];break;case 2:_=[12,11];break;case 3:_=[10,11];break;case 4:_=[16,11];break;case 5:_=[40,33];break;case 6:_=[24,11];break;case 7:_=[20,11];break;case 8:_=[32,11];break;case 9:_=[80,33];break;case 10:_=[18,11];break;case 11:_=[15,11];break;case 12:_=[64,33];break;case 13:_=[160,99];break;case 14:_=[4,3];break;case 15:_=[3,2];break;case 16:_=[2,1];break;case 255:{_=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((x+1)*16-i*2-n*2),height:(2-I)*(C+1)*16-(I?2:4)*(s+o),pixelRatio:_}}}class b8 extends zE{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,l){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,q0(c.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=Vt(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(a=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const d=this.readSPS(c.data);e.width=d.width,e.height=d.height,e.pixelRatio=d.pixelRatio,e.codec=d.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const m in d.params)e.params[m]=d.params[m]}this.pushParameterSet(e.sps,c.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const d=this.readPPS(c.data);for(const m in d)e.params[m]=d[m]}this.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new _l(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new _l(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),s=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),l=t.readUByte(),c=t.readUByte(),u=t.readUByte(),h=t.readUByte(),f=t.readUByte(),d=t.readUByte(),m=t.readUByte(),A=t.readUByte(),p=t.readUByte(),y=t.readUByte(),E=[],v=[];for(let se=0;se<i;se++)E.push(t.readBoolean()),v.push(t.readBoolean());if(i>0)for(let se=i;se<8;se++)t.readBits(2);for(let se=0;se<i;se++)E[se]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),v[se]&&t.readUByte();t.readUEG();const x=t.readUEG();x==3&&t.skipBits(1);const C=t.readUEG(),I=t.readUEG(),_=t.readBoolean();let S=0,b=0,T=0,R=0;_&&(S+=t.readUEG(),b+=t.readUEG(),T+=t.readUEG(),R+=t.readUEG());const w=t.readUEG(),B=t.readUEG(),D=t.readUEG(),k=t.readBoolean();for(let se=k?0:i;se<=i;se++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let he=0;he<4;he++)for(let ae=0;ae<(he===3?2:6);ae++)if(!t.readBoolean())t.readUEG();else{const X=Math.min(64,1<<4+(he<<1));he>1&&t.readEG();for(let oe=0;oe<X;oe++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const W=t.readUEG();let P=0;for(let se=0;se<W;se++){let he=!1;if(se!==0&&(he=t.readBoolean()),he){se===W&&t.readUEG(),t.readBoolean(),t.readUEG();let ae=0;for(let J=0;J<=P;J++){const X=t.readBoolean();let oe=!1;X||(oe=t.readBoolean()),(X||oe)&&ae++}P=ae}else{const ae=t.readUEG(),J=t.readUEG();P=ae+J;for(let X=0;X<ae;X++)t.readUEG(),t.readBoolean();for(let X=0;X<J;X++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const se=t.readUEG();for(let he=0;he<se;he++){for(let ae=0;ae<D+4;ae++)t.readBits(1);t.readBits(1)}}let M=0,V=1,$=1,G=!0,O=1,F=0;t.readBoolean(),t.readBoolean();let U=!1;if(t.readBoolean()){if(t.readBoolean()){const Ce=t.readUByte(),_e=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Be=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Ce>0&&Ce<16?(V=_e[Ce-1],$=Be[Ce-1]):Ce===255&&(V=t.readBits(16),$=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),U=t.readBoolean(),U&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(O=t.readBits(32),F=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const Be=t.readBoolean(),Se=t.readBoolean();let Ve=!1;(Be||Se)&&(Ve=t.readBoolean(),Ve&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),Ve&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Me=0;Me<=i;Me++){G=t.readBoolean();const Ne=G||t.readBoolean();let Ge=!1;Ne?t.readEG():Ge=t.readBoolean();const je=Ge?1:t.readUEG()+1;if(Be)for(let st=0;st<je;st++)t.readUEG(),t.readUEG(),Ve&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(Se)for(let st=0;st<je;st++)t.readUEG(),t.readUEG(),Ve&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),M=t.readUEG())}let Z=C,ie=I;if(_){let se=1,he=1;x===1?se=he=2:x==2&&(se=2),Z=C-se*b-se*S,ie=I-he*R-he*T}const q=n?["A","B","C"][n]:"",ne=a<<24|l<<16|c<<8|u;let ye=0;for(let se=0;se<32;se++)ye=(ye|(ne>>se&1)<<31-se)>>>0;let ve=ye.toString(16);return o===1&&ve==="2"&&(ve="6"),{codecString:`hvc1.${q}${o}.${ve}.${s?"H":"L"}${y}.B0`,params:{general_tier_flag:s,general_profile_idc:o,general_profile_space:n,general_profile_compatibility_flags:[a,l,c,u],general_constraint_indicator_flags:[h,f,d,m,A,p],general_level_idc:y,bit_depth:w+8,bit_depth_luma_minus8:w,bit_depth_chroma_minus8:B,min_spatial_segmentation_idc:M,chroma_format_idc:x,frame_rate:{fixed:G,fps:F/O}},width:Z,height:ie,pixelRatio:[V,$]}}readPPS(e){const t=new _l(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),s=t.readBoolean();let o=1;return s&&n?o=0:s?o=3:n&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Qi=188;class xr{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=xr.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Qi*5,t-Qi)+1,n=0;for(;n<i;){let s=!1,o=-1,a=0;for(let l=n;l<t;l+=Qi)if(e[l]===71&&(t-l===Qi||e[l+Qi]===71)){if(a++,o===-1&&(o=l,o!==0&&(i=Math.min(o+Qi*99,e.length-Qi)+1)),s||(s=s0(e,l)===0),s&&a>1&&(o===0&&a>2||l+Qi>i))return o}else{if(a)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Zv[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=xr.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=xr.createTrack("audio",n),this._id3Track=xr.createTrack("id3"),this._txtTrack=xr.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let s;const o=this._videoTrack,a=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=o.pid,h=o.pesData,f=a.pid,d=l.pid,m=a.pesData,A=l.pesData,p=null,y=this.pmtParsed,E=this._pmtId,v=e.length;if(this.remainderData&&(e=Jn(this.remainderData,e),v=e.length,this.remainderData=null),v<Qi&&!n)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};const x=Math.max(0,xr.syncOffset(e));v-=(v-x)%Qi,v<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,v,e.buffer.byteLength-v));let C=0;for(let _=x;_<v;_+=Qi)if(e[_]===71){const S=!!(e[_+1]&64),b=s0(e,_),T=(e[_+3]&48)>>4;let R;if(T>1){if(R=_+5+e[_+4],R===_+Qi)continue}else R=_+4;switch(b){case u:S&&(h&&(s=wo(h,this.logger))&&(this.readyVideoParser(o.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(o,c,s,!1)),h={data:[],size:0}),h&&(h.data.push(e.subarray(R,_+Qi)),h.size+=_+Qi-R);break;case f:if(S){if(m&&(s=wo(m,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s);break;case"ac3":this.parseAC3PES(a,s);break}m={data:[],size:0}}m&&(m.data.push(e.subarray(R,_+Qi)),m.size+=_+Qi-R);break;case d:S&&(A&&(s=wo(A,this.logger))&&this.parseID3PES(l,s),A={data:[],size:0}),A&&(A.data.push(e.subarray(R,_+Qi)),A.size+=_+Qi-R);break;case 0:S&&(R+=e[R]+1),E=this._pmtId=w8(e,R);break;case E:{S&&(R+=e[R]+1);const w=B8(e,R,this.typeSupported,i,this.observer,this.logger);u=w.videoPid,u>0&&(o.pid=u,o.segmentCodec=w.segmentVideoCodec),f=w.audioPid,f>0&&(a.pid=f,a.segmentCodec=w.segmentAudioCodec),d=w.id3Pid,d>0&&(l.pid=d),p!==null&&!y&&(this.logger.warn(`MPEG-TS PMT found at ${_} after unknown PID '${p}'. Backtracking to sync byte @${x} to parse all TS packets.`),p=null,_=x-188),y=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=b;break}}else C++;C>0&&r0(this.observer,new Error(`Found ${C} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=h,a.pesData=m,l.pesData=A;const I={audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};return n&&this.extractRemainingSamples(I),I}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:s}=e,o=i.pesData,a=t.pesData,l=n.pesData;let c;if(o&&(c=wo(o,this.logger))?(this.readyVideoParser(i.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(i,s,c,!0),i.pesData=null)):i.pesData=o,a&&(c=wo(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;l&&(c=wo(l,this.logger))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=l}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),s=this.sampleAes=new S8(this.observer,this.config,t);return this.decrypt(n,s)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new T8:e==="hevc"&&(this.videoParser=new b8))}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:s}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,()=>{i(e)}):i(e)}):s.samples&&t.decryptAvcSamples(s.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let s=t.data;if(n){this.aacOverFlow=null;const h=n.missing,f=n.sample.unit.byteLength;if(h===-1)s=Jn(n.sample.unit,s);else{const d=f-h;n.sample.unit.set(s.subarray(0,h),d),e.samples.push(n.sample),i=n.missing}}let o,a;for(o=i,a=s.length;o<a-1&&!zu(s,o);o++);if(o!==i){let h;const f=o<a-1;if(f?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",r0(this.observer,new Error(h),f,this.logger),!f)return}DE(e,this.observer,s,o,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(n){const h=ME(e.samplerate);l=n.sample.pts+h}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;o<a;)if(u=LE(e,s,o,l,c),o+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;o<a-1&&!zu(s,o);o++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let s=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<n;)if(UE(i,o)){const l=kE(e,i,o,a,s);if(l)o+=l.length,s++;else break}else o++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const s=i.length;let o=0,a=0,l;for(;a<s&&(l=QE(e,i,a,n,o++))>0;)a+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=Vt({},t,{type:this._videoTrack?pn.emsg:pn.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function s0(r,e){return((r[e+1]&31)<<8)+r[e+2]}function w8(r,e){return(r[e+10]&31)<<8|r[e+11]}function B8(r,e,t,i,n,s){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(r[e+1]&15)<<8|r[e+2],l=e+3+a-4,c=(r[e+10]&15)<<8|r[e+11];for(e+=12+c;e<l;){const u=s0(r,e),h=(r[e+3]&15)<<8|r[e+4];switch(r[e]){case 207:if(!i){Bf("ADTS AAC",s);break}case 15:o.audioPid===-1&&(o.audioPid=u);break;case 21:o.id3Pid===-1&&(o.id3Pid=u);break;case 219:if(!i){Bf("H.264",s);break}case 27:o.videoPid===-1&&(o.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?s.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="mp3");break;case 193:if(!i){Bf("AC-3",s);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="ac3"):s.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&h>0){let f=e+5,d=h;for(;d>2;){switch(r[f]){case 106:t.ac3!==!0?s.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=u,o.segmentAudioCodec="ac3");break}const A=r[f+1]+2;f+=A,d-=A}}break;case 194:case 135:return r0(n,new Error("Unsupported EC-3 in M2TS found"),void 0,s),o;case 36:o.videoPid===-1&&(o.videoPid=u,o.segmentVideoCodec="hevc",s.log("HEVC in M2TS found"));break}e+=h+5}return o}function r0(r,e,t,i){i.warn(`parsing error: ${e.message}`),r.emit(L.ERROR,L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Bf(r,e){e.log(`${r} with AES-128-CBC encryption found in unencrypted stream`)}function wo(r,e){let t=0,i,n,s,o,a;const l=r.data;if(!r||r.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=Jn(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>r.size-6)return null;const u=i[7];u&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),s=i[8];let h=s+9;if(r.size<=h)return null;r.size-=h;const f=new Uint8Array(r.size);for(let d=0,m=l.length;d<m;d++){i=l[d];let A=i.byteLength;if(h)if(h>A){h-=A;continue}else i=i.subarray(h),A-=h,h=0;f.set(i,t),t+=A}return n&&(n-=s+3),{data:f,pts:o,dts:a,len:n}}return null}class R8{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const dr=Math.pow(2,32)-1;class ce{static init(){ce.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in ce.types)ce.types.hasOwnProperty(e)&&(ce.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);ce.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);ce.STTS=ce.STSC=ce.STCO=s,ce.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),ce.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),ce.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),ce.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);ce.FTYP=ce.box(ce.types.ftyp,o,l,o,a),ce.DINF=ce.box(ce.types.dinf,ce.box(ce.types.dref,n))}static box(e,...t){let i=8,n=t.length;const s=n;for(;n--;)i+=t[n].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),n=0,i=8;n<s;n++)o.set(t[n],i),i+=t[n].byteLength;return o}static hdlr(e){return ce.box(ce.types.hdlr,ce.HDLR_TYPES[e])}static mdat(e){return ce.box(ce.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(dr+1)),n=Math.floor(t%(dr+1));return ce.box(ce.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return ce.box(ce.types.mdia,ce.mdhd(e.timescale||0,e.duration||0),ce.hdlr(e.type),ce.minf(e))}static mfhd(e){return ce.box(ce.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?ce.box(ce.types.minf,ce.box(ce.types.smhd,ce.SMHD),ce.DINF,ce.stbl(e)):ce.box(ce.types.minf,ce.box(ce.types.vmhd,ce.VMHD),ce.DINF,ce.stbl(e))}static moof(e,t,i){return ce.box(ce.types.moof,ce.mfhd(e),ce.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=ce.trak(e[t]);return ce.box.apply(null,[ce.types.moov,ce.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(ce.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=ce.trex(e[t]);return ce.box.apply(null,[ce.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(dr+1)),n=Math.floor(t%(dr+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return ce.box(ce.types.mvhd,s)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,s;for(n=0;n<t.length;n++)s=t[n].flags,i[n+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return ce.box(ce.types.sdtp,i)}static stbl(e){return ce.box(ce.types.stbl,ce.stsd(e),ce.box(ce.types.stts,ce.STTS),ce.box(ce.types.stsc,ce.STSC),ce.box(ce.types.stsz,ce.STSZ),ce.box(ce.types.stco,ce.STCO))}static avc1(e){let t=[],i=[],n,s,o;for(n=0;n<e.sps.length;n++)s=e.sps[n],o=s.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(s));for(n=0;n<e.pps.length;n++)s=e.pps[n],o=s.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(s));const a=ce.box(ce.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return ce.box(ce.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,ce.box(ce.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ce.box(ce.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return ce.box(ce.types.mp4a,ce.audioStsd(e),ce.box(ce.types.esds,ce.esds(e)))}static mp3(e){return ce.box(ce.types[".mp3"],ce.audioStsd(e))}static ac3(e){return ce.box(ce.types["ac-3"],ce.audioStsd(e),ce.box(ce.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return ce.box(ce.types.stsd,ce.STSD,ce.mp4a(e));if(t==="ac3"&&e.config)return ce.box(ce.types.stsd,ce.STSD,ce.ac3(e));if(t==="mp3"&&e.codec==="mp3")return ce.box(ce.types.stsd,ce.STSD,ce.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return ce.box(ce.types.stsd,ce.STSD,ce.avc1(e));if(t==="hevc"&&e.vps)return ce.box(ce.types.stsd,ce.STSD,ce.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,s=e.height||0,o=Math.floor(i/(dr+1)),a=Math.floor(i%(dr+1));return ce.box(ce.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,s>>8&255,s&255,0,0]))}static traf(e,t){const i=ce.sdtp(e),n=e.id,s=Math.floor(t/(dr+1)),o=Math.floor(t%(dr+1));return ce.box(ce.types.traf,ce.box(ce.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),ce.box(ce.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,o>>24,o>>16&255,o>>8&255,o&255])),ce.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,ce.box(ce.types.trak,ce.tkhd(e),ce.mdia(e))}static trex(e){const t=e.id;return ce.box(ce.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,s=12+16*n,o=new Uint8Array(s);let a,l,c,u,h,f;for(t+=8+s,o.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<n;a++)l=i[a],c=l.duration,u=l.size,h=l.flags,f=l.cts,o.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*a);return ce.box(ce.types.trun,o)}static initSegment(e){ce.types||ce.init();const t=ce.moov(e);return Jn(ce.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,s=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=s.length;for(let m=0;m<i.length;m+=1){o+=3;for(let A=0;A<i[m].length;A+=1)o+=2+i[m][A].length}const a=new Uint8Array(o);a.set(s,0),o=s.length;const l=i.length-1;for(let m=0;m<i.length;m+=1){a.set(new Uint8Array([32+m|(m===l?128:0),0,i[m].length]),o),o+=3;for(let A=0;A<i[m].length;A+=1)a.set(new Uint8Array([i[m][A].length>>8,i[m][A].length&255]),o),o+=2,a.set(i[m][A],o),o+=i[m][A].length}const c=ce.box(ce.types.hvcC,a),u=e.width,h=e.height,f=e.pixelRatio[0],d=e.pixelRatio[1];return ce.box(ce.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,ce.box(ce.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ce.box(ce.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,d>>24,d>>16&255,d>>8&255,d&255])))}}ce.types=void 0;ce.HDLR_TYPES=void 0;ce.STTS=void 0;ce.STSC=void 0;ce.STCO=void 0;ce.STSZ=void 0;ce.VMHD=void 0;ce.SMHD=void 0;ce.STSD=void 0;ce.FTYP=void 0;ce.DINF=void 0;const HE=9e4;function fm(r,e,t=1,i=!1){const n=r*e*t;return i?Math.round(n):n}function D8(r,e,t=1,i=!1){return fm(r,e,1/t,i)}function Xa(r,e=!1){return fm(r,1e3,1/HE,e)}function M8(r,e=1){return fm(r,HE,1/e)}const L8=10*1e3,P8=1024,F8=1152,k8=1536;let Bo=null,Rf=null;function Yg(r,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:r?2:1,isNonSync:r?0:1}}}class yu extends gs{constructor(e,t,i,n){if(super("mp4-remuxer",n),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,Bo===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Bo=o?parseInt(o[1]):0}if(Rf===null){const s=navigator.userAgent.match(/Safari\/(\d+)/i);Rf=s?parseInt(s[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.log("initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((s,o)=>{let a=o.pts,l=a-s;return l<-4294967296&&(t=!0,a=Vn(a,i),l=a-s),l>0?s:a},i);return t&&this.debug("PTS rollover detected"),n}remux(e,t,i,n,s,o,a,l){let c,u,h,f,d,m,A=s,p=s;const y=e.pid>-1,E=t.pid>-1,v=t.samples.length,x=e.samples.length>0,C=a&&v>0||v>1;if((!y||x)&&(!E||C)||this.ISGenerated||a){if(this.ISGenerated){var _,S,b,T;const D=this.videoTrackConfig;(D&&(t.width!==D.width||t.height!==D.height||((_=t.pixelRatio)==null?void 0:_[0])!==((S=D.pixelRatio)==null?void 0:S[0])||((b=t.pixelRatio)==null?void 0:b[1])!==((T=D.pixelRatio)==null?void 0:T[1]))||!D&&C||this.nextAudioTs===null&&x)&&this.resetInitSegment()}this.ISGenerated||(h=this.generateIS(e,t,s,o));const R=this.isVideoContiguous;let w=-1,B;if(C&&(w=O8(t.samples),!R&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,w>0){this.warn(`Dropped ${w} out of ${v} video samples due to a missing keyframe`);const D=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(w),t.dropped+=w,p+=(t.samples[0].pts-D)/t.inputTimeScale,B=p}else w===-1&&(this.warn(`No keyframe found out of ${v} video samples`),m=!1);if(this.ISGenerated){if(x&&C){const D=this.getVideoStartPts(t.samples),Q=(Vn(e.samples[0].pts,D)-D)/t.inputTimeScale;A+=Math.max(0,Q),p+=Math.max(0,-Q)}if(x){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),h=this.generateIS(e,t,s,o)),u=this.remuxAudio(e,A,this.isAudioContiguous,o,E||C||l===$e.AUDIO?p:void 0),C){const D=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),h=this.generateIS(e,t,s,o)),c=this.remuxVideo(t,p,R,D)}}else C&&(c=this.remuxVideo(t,p,R,0));c&&(c.firstKeyFrame=w,c.independent=w!==-1,c.firstKeyFramePTS=B)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(d=VE(i,s,this._initPTS,this._initDTS)),n.samples.length&&(f=KE(n,s,this._initPTS))),{audio:u,video:c,initSegment:h,independent:m,text:f,id3:d}}generateIS(e,t,i,n){const s=e.samples,o=t.samples,a=this.typeSupported,l={},c=this._initPTS;let u=!c||n,h="audio/mp4",f,d,m,A=-1;if(u&&(f=d=1/0),e.config&&s.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):ce.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(A=e.id,m=e.inputTimeScale,!c||m!==c.timescale?f=d=s[0].pts-Math.round(m*i):u=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:ce.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(A=t.id,m=t.inputTimeScale,!c||m!==c.timescale){const p=this.getVideoStartPts(o),y=Math.round(m*i);d=Math.min(d,Vn(o[0].dts,p)-y),f=Math.min(f,p-y)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(c&&this.warn(`Timestamps at playlist time: ${n?"":"~"}${i} ${f/m} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${i} offset: ${f/m} (${f}/${m}) trackId: ${A}`),this._initPTS={baseTime:f,timescale:m,trackId:A},this._initDTS={baseTime:d,timescale:m,trackId:A}):f=m=void 0,{tracks:l,initPTS:f,timescale:m,trackId:A}}remuxVideo(e,t,i,n){const s=e.inputTimeScale,o=e.samples,a=[],l=o.length,c=this._initPTS,u=c.baseTime*s/c.timescale;let h=this.nextVideoTs,f=8,d=this.videoSampleDuration,m,A,p=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,E=!1;if(!i||h===null){const M=u+t*s,V=o[0].pts-Vn(o[0].dts,o[0].pts);Bo&&h!==null&&Math.abs(M-V-(h+u))<15e3?i=!0:h=M-V-u}const v=h+u;for(let M=0;M<l;M++){const V=o[M];V.pts=Vn(V.pts,v),V.dts=Vn(V.dts,v),V.dts<o[M>0?M-1:M].dts&&(E=!0)}E&&o.sort(function(M,V){const $=M.dts-V.dts,G=M.pts-V.pts;return $||G}),m=o[0].dts,A=o[o.length-1].dts;const x=A-m,C=x?Math.round(x/(l-1)):d||e.inputTimeScale/30;if(i){const M=m-v,V=M>C,$=M<-1;if((V||$)&&(V?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Xa(M,!0)} ms (${M}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Xa(-M,!0)} ms (${M}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!$||v>=o[0].pts||Bo)){m=v;const G=o[0].pts-M;if(V)o[0].dts=m,o[0].pts=G;else{let O=!0;for(let F=0;F<o.length&&!(o[F].dts>G&&O);F++){const U=o[F].pts;if(o[F].dts-=M,o[F].pts-=M,F<o.length-1){const N=o[F+1].pts,Z=o[F].pts,ie=N<=Z,q=N<=U;O=ie==q}}}this.log(`Video: Initial PTS/DTS adjusted: ${Xa(G,!0)}/${Xa(m,!0)}, delta: ${Xa(M,!0)} ms`)}}m=Math.max(0,m);let I=0,_=0,S=m;for(let M=0;M<l;M++){const V=o[M],$=V.units,G=$.length;let O=0;for(let F=0;F<G;F++)O+=$[F].data.length;_+=O,I+=G,V.length=O,V.dts<S?(V.dts=S,S+=C/4|0||1):S=V.dts,p=Math.min(V.pts,p),y=Math.max(V.pts,y)}A=o[l-1].dts;const b=_+4*I+8;let T;try{T=new Uint8Array(b)}catch(M){this.observer.emit(L.ERROR,L.ERROR,{type:qe.MUX_ERROR,details:ue.REMUX_ALLOC_ERROR,fatal:!1,error:M,bytes:b,reason:`fail allocating video mdat ${b}`});return}const R=new DataView(T.buffer);R.setUint32(0,b),T.set(ce.types.mdat,4);let w=!1,B=Number.POSITIVE_INFINITY,D=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY,Q=Number.NEGATIVE_INFINITY;for(let M=0;M<l;M++){const V=o[M],$=V.units;let G=0;for(let U=0,N=$.length;U<N;U++){const Z=$[U],ie=Z.data,q=Z.data.byteLength;R.setUint32(f,q),f+=4,T.set(ie,f),f+=q,G+=4+q}let O;if(M<l-1)d=o[M+1].dts-V.dts,O=o[M+1].pts-V.pts;else{const U=this.config,N=M>0?V.dts-o[M-1].dts:C;if(O=M>0?V.pts-o[M-1].pts:C,U.stretchShortVideoTrack&&this.nextAudioTs!==null){const Z=Math.floor(U.maxBufferHole*s),ie=(n?p+n*s:this.nextAudioTs+u)-V.pts;ie>Z?(d=ie-N,d<0?d=N:w=!0,this.log(`It is approximately ${ie/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=N}else d=N}const F=Math.round(V.pts-V.dts);B=Math.min(B,d),k=Math.max(k,d),D=Math.min(D,O),Q=Math.max(Q,O),a.push(Yg(V.key,d,G,F))}if(a.length){if(Bo){if(Bo<70){const M=a[0].flags;M.dependsOn=2,M.isNonSync=0}}else if(Rf&&Q-D<k-B&&C/k<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let M=m;for(let V=0,$=a.length;V<$;V++){const G=M+a[V].duration,O=M+a[V].cts;if(V<$-1){const F=G+a[V+1].cts;a[V].duration=F-O}else a[V].duration=V?a[V-1].duration:C;a[V].cts=0,M=G}}}d=w||!d?C:d;const Y=A+d;this.nextVideoTs=h=Y-u,this.videoSampleDuration=d,this.isVideoContiguous=!0;const W=ce.moof(e.sequenceNumber++,m,Vt(e,{samples:a})),P="video",K={data1:W,data2:T,startPTS:(p-u)/s,endPTS:(y+d-u)/s,startDTS:(m-u)/s,endDTS:h/s,type:P,hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,K}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return F8;case"ac3":return k8;default:return P8}}remuxAudio(e,t,i,n,s){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,l=o/a,c=this.getSamplesPerFrame(e),u=c*l,h=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],m=s!==void 0;let A=e.samples,p=f?0:8,y=this.nextAudioTs||-1;const E=h.baseTime*o/h.timescale,v=E+t*o;if(this.isAudioContiguous=i=i||A.length&&y>0&&(n&&Math.abs(v-(y+E))<9e3||Math.abs(Vn(A[0].pts,v)-(y+E))<20*u),A.forEach(function(Q){Q.pts=Vn(Q.pts,v)}),!i||y<0){if(A=A.filter(Q=>Q.pts>=0),!A.length)return;s===0?y=0:n&&!m?y=Math.max(0,v-E):y=A[0].pts-E}if(e.segmentCodec==="aac"){const Q=this.config.maxAudioFramesDrift;for(let Y=0,W=y+E;Y<A.length;Y++){const P=A[Y],K=P.pts,M=K-W,V=Math.abs(1e3*M/o);if(M<=-Q*u&&m)Y===0&&(this.warn(`Audio frame @ ${(K/o).toFixed(3)}s overlaps marker by ${Math.round(1e3*M/o)} ms.`),this.nextAudioTs=y=K-E,W=K);else if(M>=Q*u&&V<L8&&m){let $=Math.round(M/u);for(W=K-$*u;W<0&&$&&u;)$--,W+=u;Y===0&&(this.nextAudioTs=y=W-E),this.warn(`Injecting ${$} audio frames @ ${((W-E)/o).toFixed(3)}s due to ${Math.round(1e3*M/o)} ms gap.`);for(let G=0;G<$;G++){let O=R8.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);O||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),O=P.unit.subarray()),A.splice(Y,0,{unit:O,pts:W}),W+=u,Y++}}P.pts=W,W+=u}}let x=null,C=null,I,_=0,S=A.length;for(;S--;)_+=A[S].unit.byteLength;for(let Q=0,Y=A.length;Q<Y;Q++){const W=A[Q],P=W.unit;let K=W.pts;if(C!==null){const V=d[Q-1];V.duration=Math.round((K-C)/l)}else if(i&&e.segmentCodec==="aac"&&(K=y+E),x=K,_>0){_+=p;try{I=new Uint8Array(_)}catch(V){this.observer.emit(L.ERROR,L.ERROR,{type:qe.MUX_ERROR,details:ue.REMUX_ALLOC_ERROR,fatal:!1,error:V,bytes:_,reason:`fail allocating audio mdat ${_}`});return}f||(new DataView(I.buffer).setUint32(0,_),I.set(ce.types.mdat,4))}else return;I.set(P,p);const M=P.byteLength;p+=M,d.push(Yg(!0,c,M,0)),C=K}const b=d.length;if(!b)return;const T=d[d.length-1];y=C-E,this.nextAudioTs=y+l*T.duration;const R=f?new Uint8Array(0):ce.moof(e.sequenceNumber++,x/l,Vt({},e,{samples:d}));e.samples=[];const w=(x-E)/o,B=y/o,k={data1:R,data2:I,startPTS:w,endPTS:B,startDTS:w,endDTS:B,type:"audio",hasAudio:!0,hasVideo:!1,nb:b};return this.isAudioContiguous=!0,k}}function Vn(r,e){let t;if(e===null)return r;for(e<r?t=-8589934592:t=8589934592;Math.abs(r-e)>4294967296;)r+=t;return r}function O8(r){for(let e=0;e<r.length;e++)if(r[e].key)return e;return-1}function VE(r,e,t,i){const n=r.samples.length;if(!n)return;const s=r.inputTimeScale;for(let a=0;a<n;a++){const l=r.samples[a];l.pts=Vn(l.pts-t.baseTime*s/t.timescale,e*s)/s,l.dts=Vn(l.dts-i.baseTime*s/i.timescale,e*s)/s}const o=r.samples;return r.samples=[],{samples:o}}function KE(r,e,t){const i=r.samples.length;if(!i)return;const n=r.inputTimeScale;for(let o=0;o<i;o++){const a=r.samples[o];a.pts=Vn(a.pts-t.baseTime*n/t.timescale,e*n)/n}r.samples.sort((o,a)=>o.pts-a.pts);const s=r.samples;return r.samples=[],{samples:s}}class U8 extends gs{constructor(e,t,i,n){super("passthrough-remuxer",n),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(e,n),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:i,videoCodec:n}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:s,video:o}=this.initData=iE(e);if(t)Db(e,t);else{const l=s||o;l!=null&&l.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${l.codec}")!`)}s&&(i=Wg(s,$t.AUDIO,this)),o&&(n=Wg(o,$t.VIDEO,this));const a={};s&&o?a.audiovideo={container:"video/mp4",codec:i+","+n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:s?a.audio={container:"audio/mp4",codec:i,encrypted:s.encrypted,initSegment:e,id:"audio"}:o?a.video={container:"video/mp4",codec:n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,i,n,s,o){var a,l;let{initPTS:c,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};ze(u)||(u=this.lastEndTime=s||0);const f=t.samples;if(!f.length)return h;const d={initPTS:void 0,timescale:void 0,trackId:void 0};let m=this.initData;if((a=m)!=null&&a.length||(this.generateInitSegment(f),m=this.initData),!((l=m)!=null&&l.length))return this.warn("Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const A=Mb(f,m,this),p=m.audio?A[m.audio.id]:null,y=m.video?A[m.video.id]:null,E=Rc(y,1/0),v=Rc(p,1/0),x=Rc(y,0,!0),C=Rc(p,0,!0);let I=s,_=0;const S=p&&(!y||!c&&v<E||c&&c.trackId===m.audio.id),b=S?p:y;if(b){const W=b.timescale,P=b.start-s*W,K=S?m.audio.id:m.video.id;I=b.start/W,_=S?C-v:x-E,(o||!c)&&(N8(c,I,s,_)||W!==c.timescale)&&(c&&this.warn(`Timestamps at playlist time: ${o?"":"~"}${s} ${P/W} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${s} offset: ${I-s} (${P}/${W}) trackId: ${K}`),c=null,d.initPTS=P,d.timescale=W,d.trackId=K)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${s}`);c?(d.initPTS=c.baseTime,d.timescale=c.timescale,d.trackId=c.trackId):((!d.timescale||d.trackId===void 0||d.initPTS===void 0)&&(this.warn("Could not set initPTS"),d.initPTS=I,d.timescale=1,d.trackId=-1),this.initPTS=c={baseTime:d.initPTS,timescale:d.timescale,trackId:d.trackId});const T=I-c.baseTime/c.timescale,R=T+_;_>0?this.lastEndTime=R:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const w=!!m.audio,B=!!m.video;let D="";w&&(D+="audio"),B&&(D+="video");const k=(m.audio?m.audio.encrypted:!1)||(m.video?m.video.encrypted:!1),Q={data1:f,startPTS:T,startDTS:T,endPTS:R,endDTS:R,type:D,hasAudio:w,hasVideo:B,nb:1,dropped:0,encrypted:k};h.audio=w&&!B?Q:void 0,h.video=B?Q:void 0;const Y=y==null?void 0:y.sampleCount;if(Y){const W=y.keyFrameIndex,P=W!==-1;Q.nb=Y,Q.dropped=W===0||this.isVideoContiguous?0:P?W:Y,Q.independent=P,Q.firstKeyFrame=W,P&&y.keyFrameStart&&(Q.firstKeyFramePTS=(y.keyFrameStart-c.baseTime)/c.timescale),this.isVideoContiguous||(h.independent=P),this.isVideoContiguous||(this.isVideoContiguous=P),Q.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${W}/${Y} dropped: ${Q.dropped} start: ${Q.firstKeyFramePTS||"NA"}`)}return h.initSegment=d,h.id3=VE(i,s,c,c),n.samples.length&&(h.text=KE(n,s,c)),h}}function Rc(r,e,t=!1){return(r==null?void 0:r.start)!==void 0?(r.start+(t?r.duration:0))/r.timescale:e}function N8(r,e,t,i){if(r===null)return!0;const n=Math.max(i,1),s=e-r.baseTime/r.timescale;return Math.abs(s-t)>n}function Wg(r,e,t){const i=r.codec;return i&&i.length>4?i:e===$t.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?Fu(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let Js;try{Js=self.performance.now.bind(self.performance)}catch{Js=Date.now}const vu=[{demux:_8,remux:U8},{demux:xr,remux:yu},{demux:E8,remux:yu},{demux:C8,remux:yu}];vu.splice(2,0,{demux:x8,remux:yu});class jg{constructor(e,t,i,n,s,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=s,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const s=i.transmuxing;s.executeStart=Js();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:l}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:d,initSegmentChange:m}=n||a,{audioCodec:A,videoCodec:p,defaultInitPts:y,duration:E,initSegmentData:v}=l,x=G8(o,t);if(x&&sa(x.method)){const S=this.getDecrypter(),b=nm(x.method);if(S.isSync()){let T=S.softwareDecrypt(o,x.key.buffer,x.iv.buffer,b);if(i.part>-1){const w=S.flush();T=w&&w.buffer}if(!T)return s.executeEnd=Js(),Df(i);o=new Uint8Array(T)}else return this.asyncResult=!0,this.decryptionPromise=S.webCryptoDecrypt(o,x.key.buffer,x.iv.buffer,b).then(T=>{const R=this.push(T,null,i);return this.decryptionPromise=null,R}),this.decryptionPromise}const C=this.needsProbing(u,h);if(C){const S=this.configureTransmuxer(o);if(S)return this.logger.warn(`[transmuxer] ${S.message}`),this.observer.emit(L.ERROR,L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,error:S,reason:S.message}),s.executeEnd=Js(),Df(i)}(u||h||m||C)&&this.resetInitSegment(v,A,p,E,t),(u||m||C)&&this.resetInitialTimestamp(y),c||this.resetContiguity();const I=this.transmux(o,x,d,f,i);this.asyncResult=Fl(I);const _=this.currentTransmuxState;return _.contiguous=!0,_.discontinuity=!1,_.trackSwitch=!1,s.executeEnd=Js(),I}flush(e){const t=e.transmuxing;t.executeStart=Js();const{decrypter:i,currentTransmuxState:n,decryptionPromise:s}=this;if(s)return this.asyncResult=!0,s.then(()=>this.flush(e));const o=[],{timeOffset:a}=n;if(i){const h=i.flush();h&&o.push(this.push(h.buffer,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=Js();const h=[Df(e)];return this.asyncResult?Promise.resolve(h):h}const u=l.flush(a);return Fl(u)?(this.asyncResult=!0,u.then(h=>(this.flushRemux(o,h,e),o))):(this.flushRemux(o,u,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:s,id3Track:o,textTrack:a}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===$e.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,s,o,a,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=Js()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,s){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,n),a.resetInitSegment(e,t,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,s){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,n,s):o=this.transmuxUnencrypted(e,i,n,s),o}transmuxUnencrypted(e,t,i,n){const{audioTrack:s,videoTrack:o,id3Track:a,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,o,a,l,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,s){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,n,!1,this.id),chunkMeta:s}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let s;for(let h=0,f=vu.length;h<f;h++){var o;if((o=vu[h].demux)!=null&&o.probe(e,this.logger)){s=vu[h];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,l=this.remuxer,c=s.remux,u=s.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(i,t,n,this.logger)),(!a||!(a instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new tm(this.config)),e}}function G8(r,e){let t=null;return r.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Df=r=>({remuxResult:{},chunkMeta:r});function Fl(r){return"then"in r&&r.then instanceof Function}class Q8{constructor(e,t,i,n,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=s||null}}class z8{constructor(e,t,i,n,s,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=s,this.initSegmentChange=o}}let Xg=0;class $E{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Xg++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,u=this.hls;if(!(!u||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case"init":{var h;const f=(h=this.workerContext)==null?void 0:h.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(c.data);break}case"flush":{this.onFlush(c.data);break}case"workerLog":{u.logger[c.data.logType]&&u.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,u.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})};const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const o=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===L.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c)};this.observer=new om,this.observer.on(L.FRAG_DECRYPTED,o),this.observer.on(L.ERROR,o);const a=Ag(s.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(s.workerPath||$w()){try{s.workerPath?(l.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=Ww(s.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=Yw());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:ti(s)})}catch(u){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new jg(this.observer,a,s,"",t,e.logger)}return}}this.transmuxer=new jg(this.observer,a,s,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Xg++;const t=this.hls.config,i=Ag(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:ti(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),jw(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,s,o,a,l,c,u){var h,f;c.transmuxing.start=self.performance.now();const{instanceNo:d,transmuxer:m}=this,A=o?o.start:s.start,p=s.decryptdata,y=this.frag,E=!(y&&s.cc===y.cc),v=!(y&&c.level===y.level),x=y?c.sn-y.sn:-1,C=this.part?c.part-this.part.index:-1,I=x===0&&c.id>1&&c.id===(y==null?void 0:y.stats.chunkCount),_=!v&&(x===1||x===0&&(C===1||I&&C<=0)),S=self.performance.now();(v||x||s.stats.parsing.start===0)&&(s.stats.parsing.start=S),o&&(C||!_)&&(o.stats.parsing.start=S);const b=!(y&&((h=s.initSegment)==null?void 0:h.url)===((f=y.initSegment)==null?void 0:f.url)),T=new z8(E,_,l,v,A,b);if(!_||E||b){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${s.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===$e.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${E}
        trackSwitch: ${v}
        contiguous: ${_}
        accurateTimeOffset: ${l}
        timeOffset: ${A}
        initSegmentChange: ${b}`);const R=new Q8(i,n,t,a,u);this.configureTransmuxer(R)}if(this.frag=s,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:d,cmd:"demux",data:e,decryptdata:p,chunkMeta:c,state:T},e instanceof ArrayBuffer?[e]:[]);else if(m){const R=m.push(e,p,c,T);Fl(R)?R.then(w=>{this.handleTransmuxComplete(w)}).catch(w=>{this.transmuxerError(w,c,"transmuxer-interface push error")}):this.handleTransmuxComplete(R)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);Fl(n)?n.then(s=>{this.handleFlushResult(s,e)}).catch(s=>{this.transmuxerError(s,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const qg=100;class YE extends oh{constructor(e,t,i){super(e,t,i,"audio-stream-controller",$e.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(L.BUFFER_RESET,this.onBufferReset,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(L.BUFFER_RESET,this.onBufferReset,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s,trackId:o}){if(i===$e.MAIN){const a=t.cc,l=this.fragCurrent;if(this.initPTS[a]={baseTime:n,timescale:s,trackId:o},this.log(`InitPTS for cc: ${a} found from main: ${n/s} (${n}/${s}) trackId: ${o}`),this.mainAnchor=t,this.state===be.WAITING_INIT_PTS){const c=this.waitingData;(!c&&!this.loadingParts||c&&c.frag.cc!==a)&&this.syncWithAnchor(t,c==null?void 0:c.frag)}else!this.hls.hasEnoughToStart&&l&&l.cc!==a?(l.abortRequests(),this.syncWithAnchor(t,l)):this.state===be.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const n=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&(n==null?void 0:n.cc)===t.cc)return;const s=(n||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),l=dE(o,s,a);l&&(this.log(`Syncing with main frag at ${l.start} cc ${l.cc}`),this.startFragRequested=!1,this.nextLoadPosition=l.start,this.resetLoadingState(),this.state===be.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=be.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(qg),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=be.IDLE):this.state=be.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case be.IDLE:this.doTickIdle();break;case be.WAITING_TRACK:{const{levels:t,trackId:i}=this,n=t==null?void 0:t[i],s=n==null?void 0:n.details;if(s&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(s))break;this.state=be.WAITING_INIT_PTS}break}case be.FRAG_LOADING_WAITING_RETRY:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,trackId:s}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((n==null?void 0:n[s])||null),this.state=be.IDLE}break}case be.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:i,part:n,cache:s,complete:o}=t,a=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=be.FRAG_LOADING;const l=s.flush().buffer,c={frag:i,part:n,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),o&&super._handleFragmentLoadComplete(c)}else a&&a.cc!==t.frag.cc&&this.syncWithAnchor(a,t.frag)}else this.state=be.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:s}=this,o=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[s]))return;const a=i[s],l=a.details;if(!l||this.waitForLive(a)||this.waitForCdnTuneIn(l)){this.state=be.WAITING_TRACK,this.startFragRequested=!1;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,$t.AUDIO,$e.AUDIO));const u=this.getFwdBufferInfo(c,$e.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,l)){t.trigger(L.BUFFER_EOS,{type:"audio"}),this.state=be.ENDED;return}const h=u.len,f=t.maxBufferLength,d=l.fragments,m=d[0].start,A=this.getLoadPosition(),p=this.flushing?A:u.end;if(this.switchingTrack&&n){const v=A;l.PTSKnown&&v<m&&(u.end>m||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=m+.05)}if(h>=f&&!this.switchingTrack&&p<d[d.length-1].start)return;let y=this.getNextFragment(p,l);if(y&&this.isLoopLoading(y,p)&&(y=this.getNextFragmentLoopLoading(y,l,u,$e.MAIN,f)),!y){this.bufferFlushed=!0;return}let E=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&E&&bi(y)&&!y.endList&&(!l.live||!this.loadingParts&&p<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(E)===Fi.OK&&(this.mainFragLoading=E=null),E&&bi(E))){if(y.start>E.end){const x=this.fragmentTracker.getFragAtPos(p,$e.MAIN);x&&x.end>E.end&&(E=x,this.mainFragLoading={frag:x,targetBufferTime:null})}if(y.start>E.end)return}this.loadFragment(y,a,p)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new fa(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==be.STOPPED&&(this.setInterval(qg),this.state=be.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(L.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:s,id:o,groupId:a,track:l}=t;if(!n){this.warn(`Audio tracks reset while loading track ${o} "${l.name}" of "${a}"`);return}const c=this.mainDetails;if(!c||s.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==be.STOPPED&&(this.state=be.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${l.name}" of "${a}" loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const u=n[o];let h=0;if(s.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(s),s.deltaUpdateFailed)return;if(u.details){var f;h=this.alignPlaylists(s,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}s.alignedSliding||(TE(s,c),s.alignedSliding||Qu(s,c),h=s.fragmentStart)}u.details=s,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,h),this.hls.trigger(L.AUDIO_TRACK_UPDATED,{details:s,id:o,groupId:t.groupId}),this.state===be.WAITING_TRACK&&!this.waitForCdnTuneIn(s)&&(this.state=be.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{config:o,trackId:a,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[a];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=o.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new $E(this.hls,$e.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[i.cc],m=(t=i.initSegment)==null?void 0:t.data;if(d!==void 0){const p=n?n.index:-1,y=p!==-1,E=new rh(i.level,i.sn,i.stats.chunkCount,s.byteLength,p,y);f.push(s,m,h,"",i,n,u.totalduration,!1,E,d)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:A}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new bE,complete:!1};A.push(new Uint8Array(s)),this.state!==be.STOPPED&&(this.state=be.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===$e.MAIN&&bi(t.frag)&&(this.mainFragLoading=t,this.state===be.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==$e.AUDIO){!this.audioOnly&&i.type===$e.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(bi(i)){this.fragPrevious=i;const s=this.switchingTrack;s&&(this.bufferedTrack=s,this.switchingTrack=null,this.hls.trigger(L.AUDIO_TRACK_SWITCHED,zt({},s)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=be.ERROR;return}switch(t.details){case ue.FRAG_GAP:case ue.FRAG_PARSING_ERROR:case ue.FRAG_DECRYPT_ERROR:case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError($e.AUDIO,t);break;case ue.AUDIO_TRACK_LOAD_ERROR:case ue.AUDIO_TRACK_LOAD_TIMEOUT:case ue.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===be.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===xt.AUDIO_TRACK&&(this.state=be.IDLE);break;case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case ue.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case ue.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==$t.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==$t.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===be.ENDED&&(this.state=be.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,$e.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:s,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:c,level:u}=a,{details:h}=u,{audio:f,text:d,id3:m,initSegment:A}=s;if(this.fragContextChanged(l)||!h){this.fragmentTracker.removeFragment(l);return}if(this.state=be.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),A!=null&&A.tracks){const p=l.initSegment||l;if(this.unhandledEncryptionError(A,l))return;this._bufferInitSegment(u,A.tracks,p,o),n.trigger(L.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:i,tracks:A.tracks})}if(f){const{startPTS:p,endPTS:y,startDTS:E,endDTS:v}=f;c&&(c.elementaryStreams[$t.AUDIO]={startPTS:p,endPTS:y,startDTS:E,endDTS:v}),l.setElementaryStreamInfo($t.AUDIO,p,y,E,v),this.bufferFragmentData(f,l,c,o)}if(m!=null&&(t=m.samples)!=null&&t.length){const p=Vt({id:i,frag:l,details:h},m);n.trigger(L.FRAG_PARSING_METADATA,p)}if(d){const p=Vt({id:i,frag:l,details:h},d);n.trigger(L.FRAG_PARSING_USERDATA,p)}}_bufferInitSegment(e,t,i,n){if(this.state!==be.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const s=t.audio;s.id=$e.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${o}/${s.codec}]`),o&&o.split(",").length===1&&(s.levelCodec=o),this.hls.trigger(L.BUFFER_CODECS,t);const a=s.initSegment;if(a!=null&&a.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:a};this.hls.trigger(L.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===Fi.NOT_LOADED||n===Fi.PARTIAL){var s;if(!bi(e))this._loadInitSegment(e,t);else if((s=t.details)!=null&&s.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=be.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&Qu(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a}=this.bufferedTrack;to({name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a},e,Yr)||(Ou(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(L.AUDIO_TRACK_SWITCHED,zt({},e))}}class lh extends gs{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t==null?void 0:t.renditionReports;if(n){let s=-1;for(let o=0;o<n.length;o++){const a=n[o];let l;try{l=new self.URL(a.URI,t.url).href}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=a.URI||""}if(l===e){s=o;break}else l===e.substring(0,l.length)&&(s=o)}if(s!==-1){const o=n[s],a=parseInt(o["LAST-MSN"])||t.lastPartSn;let l=parseInt(o["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&u>t.partTarget&&(l+=1)}const c=i&&pg(i);return new Zd(a,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:s}=t,o=self.performance.now(),a=s.loading.first?Math.max(0,o-s.loading.first):0;n.advancedDateTime=Date.now()-a;const l=this.hls.config.timelineOffset;if(l!==n.appliedTimelineOffset){const u=Math.max(l||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(h=>{h.setStart(h.playlistOffset+u)})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){Fw(i,n,this);const E=n.playlistParsingError;if(E){this.warn(E);const v=this.hls;if(!v.config.ignorePlaylistParsingErrors){var c;const{networkDetails:x}=t;v.trigger(L.ERROR,{type:qe.NETWORK_ERROR,details:ue.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:E,reason:E.message,level:t.level||void 0,parent:(c=n.fragments[0])==null?void 0:c.type,networkDetails:x,stats:s});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=s.loading.start);const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,d=(n.edge-f)*1e3,m=xE(n,d);if(n.requestScheduled+m<o?n.requestScheduled=o:n.requestScheduled+=m,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let A,p,y;if(n.canBlockReload&&n.endSN&&n.advanced){const E=this.hls.config.lowLatencyMode,v=n.lastPartSn,x=n.endSN,C=n.lastPartIndex,I=C!==-1,_=v===x;I?_?(p=x+1,y=E?0:C):(p=v,y=E?C+1:n.maxPartIndex):p=x+1;const S=n.age,b=S+n.ageHeader;let T=Math.min(b-n.partTarget,n.targetduration*1.5);if(T>0){if(b>n.targetduration*3)this.log(`Playlist last advanced ${S.toFixed(2)}s ago. Omitting segment and part directives.`),p=void 0,y=void 0;else if(i!=null&&i.tuneInGoal&&b-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${T} with playlist age: ${n.age}`),T=0;else{const R=Math.floor(T/n.targetduration);if(p+=R,y!==void 0){const w=Math.round(T%n.targetduration/n.partTarget);y+=w}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${S.toFixed(2)}s goal: ${T} skip sn ${R} to part ${y}`)}n.tuneInGoal=T}if(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,y),E||!_){n.requestScheduled=o,this.loadingPlaylist(u,A);return}}else(n.canBlockReload||n.canSkipUntil)&&(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,y));A&&p!==void 0&&n.canBlockReload&&(n.requestScheduled=s.loading.first+Math.max(m-a*2,m/2)),this.scheduleLoading(u,A,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const s=self.performance.now(),o=n.requestScheduled;if(s>=o){this.loadingPlaylist(e,t);return}const a=o-s;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,n){let s=pg(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,s=Cl.No),new Zd(i,n,s)}checkRetry(e){const t=e.details,i=Uu(e),n=e.errorAction,{action:s,retryCount:o=0,retryConfig:a}=n||{},l=!!n&&!!a&&(s===zi.RetryRequest||!n.resolved&&s===zi.SendAlternateToPenaltyBox);if(l){var c;if(o>=a.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=em(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return l}}function WE(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(!kl(r[t].attrs,e[t].attrs))return!1;return!0}function kl(r,e,t){const i=r["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>r[n]!==e[n])}function o0(r,e){return e.label.toLowerCase()===r.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(r.lang||"").toLowerCase())}class jE extends lh{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(L.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(n==null?void 0:n.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(f=>f.default)&&(this.selectDefaultTrack=!1),a.forEach((f,d)=>{f.id=d});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const l=this.hls.config.audioPreference;if(!s&&l){const f=Ms(l,a,Yr);if(f>-1)s=a[f];else{const d=Ms(l,this.tracks);s=this.tracks[d]}}let c=this.findTrackId(s);c===-1&&s&&(c=this.findTrackId(null));const u={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(L.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(c!==-1&&h===-1)this.setAudioTrack(c);else if(a.length&&h===-1){var o;const f=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(f.message),this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===xt.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&to(e,n,Yr))return n;const s=Ms(e,this.tracksInGroup,Yr);if(s>-1){const o=this.tracksInGroup[s];return this.setAudioTrack(s),o}else if(n){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=nw(e,t.levels,i,o,Yr);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=Ms(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],s=n.details&&!n.details.live;if(e===this.trackId&&n===i&&s||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(L.AUDIO_TRACK_SWITCHING,zt({},n)),s))return;const o=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||to(e,n,Yr)))return i}if(e){const{name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(to({name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l},u,Yr))return c}for(let c=0;c<t.length;c++){const u=t[c];if(kl(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(kl(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&Ou(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(L.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class H8{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(s){var i;if(n.onError(s),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i==null?void 0:i.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const Jg=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,XE="HlsJsTrackRemovedError";class V8 extends Error{constructor(e){super(e),this.name=XE}}class qE extends gs{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:s}=this;i&&this.log("Media source opened"),!(!n||!s)&&(s.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(L.MEDIA_ATTACHED,{media:n,mediaSource:s}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=Cb(sr(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.BUFFER_RESET,this.onBufferReset,this),e.on(L.BUFFER_APPENDING,this.onBufferAppending,this),e.on(L.BUFFER_CODECS,this.onBufferCodecs,this),e.on(L.BUFFER_EOS,this.onBufferEos,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.FRAG_PARSED,this.onFragParsed,this),e.on(L.FRAG_CHANGED,this.onFragChanged,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.BUFFER_RESET,this.onBufferReset,this),e.off(L.BUFFER_APPENDING,this.onBufferAppending,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.BUFFER_EOS,this.onBufferEos,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.FRAG_PARSED,this.onFragParsed,this),e.off(L.FRAG_CHANGED,this.onFragChanged,this),e.off(L.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const s=this.isUpdating();s||this.operationQueue.removeBlockers();const o=this.isQueued();(s||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${s?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?Vt(i,n.tracks):this.sourceBuffers.forEach(s=>{const[o]=s;o&&(i[o]=Vt({},this.tracks[o]),this.removeBuffer(o)),s[0]=s[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media;this.transferData=this.overrides=void 0;const n=sr(this.appendSource);if(n){const s=!!t.mediaSource;(s||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(o),s)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&o instanceof l,Zg(i),K8(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,s=n?Object.keys(n):null,o=s?s.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(n&&s&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${ti(i,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${ti(n,(l,c)=>l==="initSegment"?void 0:c)}}`),!jv(n,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,u=Math.max(l,(c==null?void 0:c.fragments[0].start)||0);if(u-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${l}`),this.onMediaDetaching(L.MEDIA_DETACHING,{}),this.onMediaAttaching(L.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,s.forEach(l=>{const c=l,u=n[c];if(u){const h=u.buffer;if(h){const f=this.fragmentTracker,d=u.id;if(f.hasFragments(d)||f.hasParts(d)){const p=ft.getBuffered(h);f.detectEvictedFragments(c,p,d,null,!0)}const m=Mf(c),A=[c,h];this.sourceBuffers[m]=A,h.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,u)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:s,_objectUrl:o}=this;if(s){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=s.readyState==="open";try{const l=s.sourceBuffers;for(let c=l.length;c--;)a&&l[c].abort(),s.removeSourceBuffer(l[c]);a&&s.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}s.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("sourceended",this._onMediaSourceEnded),s.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(s.removeEventListener("startstreaming",this._onStartStreaming),s.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(n.removeAttribute("src"),this.appendSource&&Zg(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(L.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(s){this.warn(`onBufferReset ${e}`,s)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Mf(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new H8(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const s="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),o=!s&&this.sourceBufferCount&&this.media&&n.some(a=>!i[a]);if(s||o){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(a=>{var l,c;const u=t[a],{id:h,codec:f,levelCodec:d,container:m,metadata:A,supplemental:p}=u;let y=i[a];const E=(l=this.transferData)==null||(l=l.tracks)==null?void 0:l[a],v=E!=null&&E.buffer?E:y,x=(v==null?void 0:v.pendingCodec)||(v==null?void 0:v.codec),C=v==null?void 0:v.levelCodec;y||(y=i[a]={buffer:void 0,listeners:[],codec:f,supplemental:p,container:m,levelCodec:d,metadata:A,id:h});const I=pu(x,C),_=I==null?void 0:I.replace(Jg,"$1");let S=pu(f,d);const b=(c=S)==null?void 0:c.replace(Jg,"$1");S&&I&&_!==b&&(a.slice(0,5)==="audio"&&(S=Fu(S,this.appendSource)),this.log(`switching codec ${x} to ${S}`),S!==(y.pendingCodec||y.codec)&&(y.pendingCodec=S),y.container=m,this.appendChangeType(a,m,S))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,s={label:`change-type=${n}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),a.changeType(n),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(s,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,$e.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const l=this.tracks.video;(this.lastVideoAppendEnd>n||l!=null&&l.buffer&&ft.isBuffered(l.buffer,n)||((a=this.fragmentTracker.getAppendedFrag(n,$e.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:s,parent:o,frag:a,part:l,chunkMeta:c,offset:u}=t,h=c.buffering[s],{sn:f,cc:d}=a,m=self.performance.now();h.start=m;const A=a.stats.buffering,p=l?l.stats.buffering:null;A.start===0&&(A.start=m),p&&p.start===0&&(p.start=m);const y=i.audio;let E=!1;s==="audio"&&(y==null?void 0:y.container)==="audio/mpeg"&&(E=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const v=i.video,x=v==null?void 0:v.buffer;if(x&&f!=="initSegment"){const _=l||a,S=this.blockedAudioAppend;if(s==="audio"&&o!=="main"&&!this.blockedAudioAppend&&!(v.ending||v.ended)){const T=_.start+_.duration*.05,R=x.buffered,w=this.currentOp("video");!R.length&&!w?this.blockAudio(_):!w&&!ft.isBuffered(x,T)&&this.lastVideoAppendEnd<T&&this.blockAudio(_)}else if(s==="video"){const b=_.end;if(S){const T=S.frag.start;(b>T||b<this.lastVideoAppendEnd||ft.isBuffered(x,T))&&this.unblockAudio()}this.lastVideoAppendEnd=b}}const C=(l||a).start,I={label:`append-${s}`,execute:()=>{var _;h.executeStart=self.performance.now();const S=(_=this.tracks[s])==null?void 0:_.buffer;S&&(E?this.updateTimestampOffset(S,C,.1,s,f,d):u!==void 0&&ze(u)&&this.updateTimestampOffset(S,u,1e-6,s,f,d)),this.appendExecutor(n,s)},onStart:()=>{},onComplete:()=>{const _=self.performance.now();h.executeEnd=h.end=_,A.first===0&&(A.first=_),p&&p.first===0&&(p.first=_);const S={};this.sourceBuffers.forEach(([b,T])=>{b&&(S[b]=ft.getBuffered(T))}),this.appendErrors[s]=0,s==="audio"||s==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(L.BUFFER_APPENDED,{type:s,frag:a,part:l,chunkMeta:c,parent:a.type,timeRanges:S})},onError:_=>{var S;const b={type:qe.MEDIA_ERROR,parent:a.type,details:ue.BUFFER_APPEND_ERROR,sourceBufferName:s,frag:a,part:l,chunkMeta:c,error:_,err:_,fatal:!1},T=(S=this.media)==null?void 0:S.error;if(_.code===DOMException.QUOTA_EXCEEDED_ERR||_.name=="QuotaExceededError"||"quota"in _)b.details=ue.BUFFER_FULL_ERROR;else if(_.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!T)b.errorAction=Ml(!0);else if(_.name===XE&&this.sourceBufferCount===0)b.errorAction=Ml(!0);else{const R=++this.appendErrors[s];this.warn(`Failed ${R}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${s}" sourceBuffer (${T||"no media error"})`),(R>=this.hls.config.appendErrorMaxRetry||T)&&(b.fatal=!0)}this.hls.trigger(L.ERROR,b)}};this.append(I,s,this.isPending(this.tracks[s]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(L.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:s}=t;i?this.append(this.getFlushOp(i,n,s),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,n,s),o)})}onFragParsed(e,t){const{frag:i,part:n}=t,s=[],o=n?n.elementaryStreams:i.elementaryStreams;o[$t.AUDIOVIDEO]?s.push("audiovideo"):(o[$t.AUDIO]&&s.push("audio"),o[$t.VIDEO]&&s.push("video"));const a=()=>{const l=self.performance.now();i.stats.buffering.end=l,n&&(n.stats.buffering.end=l);const c=n?n.stats:i.stats;this.hls.trigger(L.FRAG_BUFFERED,{frag:i,part:n,stats:c,id:i.type})};s.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,s).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})?n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(L.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(L.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===ue.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;ze(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,s=i.currentTime,o=t.levelTargetDuration,a=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(ze(a)&&a>=0){const c=Math.max(a,o),u=Math.floor(s/o)*o-c;this.flushBackBuffer(s,o,u)}const l=n.frontBufferFlushThreshold;if(ze(l)&&l>0){const c=Math.max(n.maxBufferLength,l),u=Math.max(c,o),h=Math.floor(s/o)*o+u;this.flushFrontBuffer(s,o,h)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const a=ft.getBuffered(s);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(L.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[n];if((o=this.details)!=null&&o.live)this.hls.trigger(L.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const o=ft.getBuffered(s),a=o.length;if(a<2)return;const l=o.start(a-1),c=o.end(a-1);if(i>l||e>=l&&e<=c)return;this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&i.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),u=Math.max(c,n);return{duration:1/0,start:c,end:u}}return{duration:1/0}}const s=(e=this.overrides)==null?void 0:e.duration;if(s)return ze(s)?{duration:s}:null;const o=this.media.duration,a=ze(i.duration)?i.duration:0;return n>a&&n>o||!ze(o)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(ze(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${ti(i)}`),this.tracksReady){var n;const s=(n=this.transferData)==null?void 0:n.tracks;s&&Object.keys(s).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(L.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const s in e){const o=s,a=e[o];if(this.isPending(a)){const l=this.getTrackCodec(a,o),c=`${a.container};codecs=${l}`;a.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(o)?" Queued":""} ${ti(a)}`);try{const u=i.addSourceBuffer(c),h=Mf(o),f=[o,u];t[h]=f,a.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(o),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[o],this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:o,mimeType:c,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&Xd(i,"video")&&(n=Gb(n,i));const s=pu(n,e.levelCodec);return s?t.slice(0,5)==="audio"?Fu(s,this.appendSource):s:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(s,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(L.BUFFER_FLUSHED,{type:s})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const s=this.currentOp(e);s&&s.onError(n)}updateTimestampOffset(e,t,i,n,s,o){const a=t-e.timestampOffset;Math.abs(a)>=i&&(this.log(`Updating ${n} SourceBuffer timestampOffset to ${t} (sn: ${s} cc: ${o})`),e.timestampOffset=t)}removeExecutor(e,t,i){const{media:n,mediaSource:s}=this,o=this.tracks[e],a=o==null?void 0:o.buffer;if(!n||!s||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=ze(n.duration)?n.duration:1/0,c=ze(s.duration)?s.duration:1/0,u=Math.max(0,t),h=Math.min(i,l,c);h>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${h}] from the ${e} SourceBuffer`),a.remove(u,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i==null?void 0:i.buffer;if(!n)throw new V8(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const s=n.buffer;if(!s)return;const o=i.bind(this,e);n.listeners.push({event:t,listener:o}),s.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function Zg(r){const e=r.querySelectorAll("source");[].slice.call(e).forEach(t=>{r.removeChild(t)})}function K8(r,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,r.appendChild(t)}function Mf(r){return r==="audio"?1:0}class ch{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(L.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.BUFFER_CODECS,this.onBufferCodecs,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(L.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&ze(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,s)=>this.isLevelAllowed(n)&&s<=e);return this.clientRect=null,ch.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(a,l)=>l?a.width!==l.width||a.height!==l.height:!0;let s=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const l=e[a];if((l.width>=o||l.height>=o)&&n(l,e[a+1])){s=a;break}}return s}}const $8={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},dn=$8,Y8={HLS:"h"},W8=Y8;class ks{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof ks?i:new ks(i))),this.value=e,this.params=t}}const j8="Dict";function X8(r){return Array.isArray(r)?JSON.stringify(r):r instanceof Map?"Map{}":r instanceof Set?"Set{}":typeof r=="object"?JSON.stringify(r):String(r)}function q8(r,e,t,i){return new Error(`failed to ${r} "${X8(e)}" as ${t}`,{cause:i})}function Os(r,e,t){return q8("serialize",r,e,t)}class JE{constructor(e){this.description=e}}const e1="Bare Item",J8="Boolean";function Z8(r){if(typeof r!="boolean")throw Os(r,J8);return r?"?1":"?0"}function eB(r){return btoa(String.fromCharCode(...r))}const tB="Byte Sequence";function iB(r){if(ArrayBuffer.isView(r)===!1)throw Os(r,tB);return`:${eB(r)}:`}const nB="Integer";function sB(r){return r<-999999999999999||999999999999999<r}function ZE(r){if(sB(r))throw Os(r,nB);return r.toString()}function rB(r){return`@${ZE(r.getTime()/1e3)}`}function e3(r,e){if(r<0)return-e3(-r,e);const t=Math.pow(10,e);if(Math.abs(r*t%1-.5)<Number.EPSILON){const n=Math.floor(r*t);return(n%2===0?n:n+1)/t}else return Math.round(r*t)/t}const oB="Decimal";function aB(r){const e=e3(r,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Os(r,oB);const t=e.toString();return t.includes(".")?t:`${t}.0`}const lB="String",cB=/[\x00-\x1f\x7f]+/;function uB(r){if(cB.test(r))throw Os(r,lB);return`"${r.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function hB(r){return r.description||r.toString().slice(7,-1)}const fB="Token";function t1(r){const e=hB(r);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Os(e,fB);return e}function a0(r){switch(typeof r){case"number":if(!ze(r))throw Os(r,e1);return Number.isInteger(r)?ZE(r):aB(r);case"string":return uB(r);case"symbol":return t1(r);case"boolean":return Z8(r);case"object":if(r instanceof Date)return rB(r);if(r instanceof Uint8Array)return iB(r);if(r instanceof JE)return t1(r);default:throw Os(r,e1)}}const dB="Key";function l0(r){if(/^[a-z*][a-z0-9\-_.*]*$/.test(r)===!1)throw Os(r,dB);return r}function dm(r){return r==null?"":Object.entries(r).map(([e,t])=>t===!0?`;${l0(e)}`:`;${l0(e)}=${a0(t)}`).join("")}function t3(r){return r instanceof ks?`${a0(r.value)}${dm(r.params)}`:a0(r)}function mB(r){return`(${r.value.map(t3).join(" ")})${dm(r.params)}`}function AB(r,e={whitespace:!0}){if(typeof r!="object"||r==null)throw Os(r,j8);const t=r instanceof Map?r.entries():Object.entries(r),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([n,s])=>{s instanceof ks||(s=new ks(s));let o=l0(n);return s.value===!0?o+=dm(s.params):(o+="=",Array.isArray(s.value)?o+=mB(s):o+=t3(s)),o}).join(`,${i}`)}function i3(r,e){return AB(r,e)}const _s="CMCD-Object",Ai="CMCD-Request",Qr="CMCD-Session",mr="CMCD-Status",pB={br:_s,ab:_s,d:_s,ot:_s,tb:_s,tpb:_s,lb:_s,tab:_s,lab:_s,url:_s,pb:Ai,bl:Ai,tbl:Ai,dl:Ai,ltc:Ai,mtp:Ai,nor:Ai,nrr:Ai,rc:Ai,sn:Ai,sta:Ai,su:Ai,ttfb:Ai,ttfbb:Ai,ttlb:Ai,cmsdd:Ai,cmsds:Ai,smrt:Ai,df:Ai,cs:Ai,ts:Ai,cid:Qr,pr:Qr,sf:Qr,sid:Qr,st:Qr,v:Qr,msd:Qr,bs:mr,bsd:mr,cdn:mr,rtp:mr,bg:mr,pt:mr,ec:mr,e:mr},gB={REQUEST:Ai};function yB(r){return Object.keys(r).reduce((e,t)=>{var i;return(i=r[t])===null||i===void 0||i.forEach(n=>e[n]=t),e},{})}function vB(r,e){const t={};if(!r)return t;const i=Object.keys(r),n=e?yB(e):{};return i.reduce((s,o)=>{var a;const l=pB[o]||n[o]||gB.REQUEST,c=(a=s[l])!==null&&a!==void 0?a:s[l]={};return c[o]=r[o],s},t)}function EB(r){return["ot","sf","st","e","sta"].includes(r)}function xB(r){return typeof r=="number"?ze(r):r!=null&&r!==""&&r!==!1}const n3="event";function CB(r,e){const t=new URL(r),i=new URL(e);if(t.origin!==i.origin)return r;const n=t.pathname.split("/").slice(1),s=i.pathname.split("/").slice(1,-1);for(;n[0]===s[0];)n.shift(),s.shift();for(;s.length;)s.shift(),n.unshift("..");return n.join("/")+t.search+t.hash}const Eu=r=>Math.round(r),c0=(r,e)=>Array.isArray(r)?r.map(t=>c0(t,e)):r instanceof ks&&typeof r.value=="string"?new ks(c0(r.value,e),r.params):(e.baseUrl&&(r=CB(r,e.baseUrl)),e.version===1?encodeURIComponent(r):r),Dc=r=>Eu(r/100)*100,IB=(r,e)=>{let t=r;return e.version>=2&&(r instanceof ks&&typeof r.value=="string"?t=new ks([r]):typeof r=="string"&&(t=[r])),c0(t,e)},_B={br:Eu,d:Eu,bl:Dc,dl:Dc,mtp:Dc,nor:IB,rtp:Dc,tb:Eu},s3="request",r3="response",mm=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],SB=["e"],TB=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function uh(r){return TB.test(r)}function bB(r){return mm.includes(r)||SB.includes(r)||uh(r)}const o3=["d","dl","nor","ot","rtp","su"];function wB(r){return mm.includes(r)||o3.includes(r)||uh(r)}const BB=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function RB(r){return mm.includes(r)||o3.includes(r)||BB.includes(r)||uh(r)}const DB=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function MB(r){return DB.includes(r)||uh(r)}const LB={[r3]:RB,[n3]:bB,[s3]:wB};function a3(r,e={}){const t={};if(r==null||typeof r!="object")return t;const i=e.version||r.v||1,n=e.reportingMode||s3,s=i===1?MB:LB[n];let o=Object.keys(r).filter(s);const a=e.filter;typeof a=="function"&&(o=o.filter(a));const l=n===r3||n===n3;l&&!o.includes("ts")&&o.push("ts"),i>1&&!o.includes("v")&&o.push("v");const c=Vt({},_B,e.formatters),u={version:i,reportingMode:n,baseUrl:e.baseUrl};return o.sort().forEach(h=>{let f=r[h];const d=c[h];if(typeof d=="function"&&(f=d(f,u)),h==="v"){if(i===1)return;f=i}h=="pr"&&f===1||(l&&h==="ts"&&!ze(f)&&(f=Date.now()),xB(f)&&(EB(h)&&typeof f=="string"&&(f=new JE(f)),t[h]=f))}),t}function PB(r,e={}){const t={};if(!r)return t;const i=a3(r,e),n=vB(i,e==null?void 0:e.customHeaderMap);return Object.entries(n).reduce((s,[o,a])=>{const l=i3(a,{whitespace:!1});return l&&(s[o]=l),s},t)}function FB(r,e,t){return Vt(r,PB(e,t))}const kB="CMCD";function OB(r,e={}){return r?i3(a3(r,e),{whitespace:!1}):""}function UB(r,e={}){if(!r)return"";const t=OB(r,e);return encodeURIComponent(t)}function NB(r,e={}){if(!r)return"";const t=UB(r,e);return`${kB}=${t}`}const i1=/CMCD=[^&#]+/;function GB(r,e,t){const i=NB(e,t);if(!i)return r;if(i1.test(r))return r.replace(i1,i);const n=r.includes("?")?"&":"?";return`${r}${n}${i}`}class l3{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:dn.MANIFEST,su:!this.initialized})}catch(s){this.hls.logger.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=n=>{try{const{frag:s,part:o}=n,a=this.hls.levels[s.level],l=this.getObjectType(s),c={d:(o||s).duration*1e3,ot:l};(l===dn.VIDEO||l===dn.AUDIO||l==dn.MUXED)&&(c.br=a.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const u=o?this.getNextPart(o):this.getNextFrag(s);u!=null&&u.url&&u.url!==s.url&&(c.nor=u.url),this.apply(n,c)}catch(s){this.hls.logger.warn("Could not generate segment CMCD data.",s)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHED,this.onMediaDetached,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHED,this.onMediaDetached,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:W8.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Vt(t,this.createData());const i=t.ot===dn.INIT||t.ot===dn.VIDEO||t.ot===dn.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((o,a)=>(n.includes(a)&&(o[a]=t[a]),o),{}));const s={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),FB(e.headers,t,s)):e.url=GB(e.url,t,s)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t;const{index:i,fragment:n}=e,s=(t=this.hls.levels[n.level])==null||(t=t.details)==null?void 0:t.partList;if(s){const{sn:o}=n;for(let a=s.length-1;a>=0;a--){const l=s[a];if(l.index===i&&l.fragment.sn===o)return s[a+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return dn.TIMED_TEXT;if(e.sn==="initSegment")return dn.INIT;if(t==="audio")return dn.AUDIO;if(t==="main")return this.hls.audioTracks.length?dn.VIDEO:dn.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===dn.AUDIO)i=n.audioTracks;else{const s=n.maxAutoLevel,o=s>-1?s+1:n.levels.length;i=n.levels.slice(0,o)}return i.forEach(s=>{s.bitrate>t&&(t=s.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===dn.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:ft.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}}const QB=3e5;class c3 extends gs{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===zi.SendAlternateToPenaltyBox&&i.flags===Hn.MoveAllAlternatesMatchingHost){const n=this.levels;let s=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:l,type:c}=t.context;a&&n?o=this.getPathwayForGroupId(a,c,o):l&&(o=l)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!s&&n&&(s=this.pathways()),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==o),t.details===ue.BUFFER_APPEND_ERROR&&!t.fatal?i.resolved=!0:i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${n&&n.length} priorities: ${ti(s)} penalized: ${ti(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(s=>{n-i[s]>QB&&delete i[s]});for(let s=0;s<e.length;s++){const o=e[s];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,l=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,_E(t),this.hls.trigger(L.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[a];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let s=0;s<n.length;s++)if(t===xt.AUDIO_TRACK&&n[s].hasAudioGroup(e)||t===xt.SUBTITLE_TRACK&&n[s].hasSubtitleGroup(e))return n[s].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(s=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":l}=s;if(t.some(u=>u.pathwayId===o))return;const c=this.getLevelsForPathway(a).map(u=>{const h=new ri(u.attrs);h["PATHWAY-ID"]=o;const f=h.AUDIO&&`${h.AUDIO}_clone_${o}`,d=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),d&&(n[h.SUBTITLES]=d,h.SUBTITLES=d);const m=u3(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),A=new fa({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:m,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let p=1;p<u.audioGroups.length;p++)A.addGroupId("audio",`${u.audioGroups[p]}_clone_${o}`);if(u.subtitleGroups)for(let p=1;p<u.subtitleGroups.length;p++)A.addGroupId("text",`${u.subtitleGroups[p]}_clone_${o}`);return A});t.push(...c),n1(this.audioTracks,i,l,o),n1(this.subtitleTracks,n,l,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const s={responseType:"json",url:n.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},c={onSuccess:(u,h,f,d)=>{this.log(`Loaded steering manifest: "${n}"`);const m=u.data;if((m==null?void 0:m.VERSION)!==1){this.log(`Steering VERSION ${m.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=m.TTL;const{"RELOAD-URI":A,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":y}=m;if(A)try{this.uri=new self.URL(A,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${A}`);return}this.scheduleRefresh(this.uri||f.url),p&&this.clonePathways(p);const E={steeringManifest:m,url:n.toString()};this.hls.trigger(L.STEERING_MANIFEST_LOADED,E),y&&this.updatePathwayPriority(y)},onError:(u,h,f,d)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let m=this.timeToLoad*1e3;if(u.code===429){const A=this.loader;if(typeof(A==null?void 0:A.getResponseHeader)=="function"){const p=A.getResponseHeader("Retry-After");p&&(m=parseFloat(p)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,m)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(s,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function n1(r,e,t,i){r&&Object.keys(e).forEach(n=>{const s=r.filter(o=>o.groupId===n).map(o=>{const a=Vt({},o);return a.details=void 0,a.attrs=new ri(a.attrs),a.url=a.attrs.URI=u3(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[n],a.attrs["PATHWAY-ID"]=i,a});r.push(...s)})}function u3(r,e,t,i){const{HOST:n,PARAMS:s,[t]:o}=i;let a;e&&(a=o==null?void 0:o[e],a&&(r=a));const l=new self.URL(r);return n&&!a&&(l.host=n),s&&Object.keys(s).sort().forEach(c=>{c&&l.searchParams.set(c,s[c])}),l.href}function Rn(r,e,t){jn(r,e,t),r.addEventListener(e,t)}function jn(r,e,t){r.removeEventListener(e,t)}class io extends gs{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=io.CDMCleanupPromise?[io.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,s=`"${t.type}" event: init data type: "${i}"`;if(this.debug(s),n!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=ml(this.config));const a=o.map(_f).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=gu(o);if(i!=="sinf"||a!==hi.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}let l;try{const d=Pi(new Uint8Array(n)),m=sm(JSON.parse(d).sinf),A=nE(m);if(!A)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(A.subarray(8,24))}catch(d){this.warn(`${s} Failed to parse sinf: ${d}`);return}const c=Xs.hexDump(l),{keyIdToKeySessionPromise:u,mediaKeySessions:h}=this;let f=u[c];for(let d=0;d<h.length;d++){const m=h[d],A=m.decryptdata;if(!A.keyId)continue;const p=Xs.hexDump(A.keyId);if(c===p||A.uri.replace(/-/g,"").indexOf(c)!==-1){if(f=u[p],!f)continue;if(A.pssh)break;delete u[p],A.pssh=new Uint8Array(n),A.keyId=l,f=u[c]=f.then(()=>this.generateRequestWithPreferredKeySession(m,i,n,"encrypted-event-key-match")),f.catch(y=>this.handleError(y));break}}f||this.handleError(new Error(`Key ID ${c} not encountered in playlist. Key-system sessions ${h.length}.`))}).catch(o=>this.handleError(o))}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onWaitingForKey=null}registerListeners(){this.hls.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(L.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(L.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(L.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(L.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(L.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(L.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t[e];if(n)return n.licenseUrl;if(e===hi.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,l)=>!!o&&l.indexOf(o)===a,n=t.map(o=>o.audioCodec).filter(i),s=t.map(o=>o.videoCodec).filter(i);return n.length+s.length===0&&s.push("avc1.42e01e"),new Promise((o,a)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,n,s).then(h=>o({keySystem:u,mediaKeys:h})).catch(h=>{c.length?l(c):h instanceof Nn?a(h):a(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return rm===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){const n=Tw(e,t,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[e];let o=s==null?void 0:s.keySystemAccess;if(!o){this.log(`Requesting encrypted media "${e}" key-system access with config: ${ti(n)}`),o=this.requestMediaKeySystemAccess(e,n);const a=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),o.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),a.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),a.hasMediaKeys=!0,c.then(h=>h?this.setMediaKeysServerCertificate(u,e,h):u))),a.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),a.mediaKeys})}return o.then(()=>s.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Xs.hexDump(e.keyId||[])}`);const n=i.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t),s="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,s,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return Xs.hexDump(e.keyId)}updateKeySession(e,t){var i;const n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyID ${Xs.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),n.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>_f(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>this.getKeySystemSelectionPromise(e).then(({keySystem:n})=>{const s=_f(n);s?t(s):i(new Error(`Unable to find format for key-system "${n}"`))}).catch(i))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=ml(this.config),i=e.map(gu).filter(n=>!!n&&t.indexOf(n)!==-1);return this.selectKeySystem(i)}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),n=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.getKeySystemForKeyPromise(t).then(({keySystem:a,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(a,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:a,mediaKeys:l,decryptdata:t}))))),(this.keyIdToKeySessionPromise[i]=s.then(a=>{const l="cenc",c=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(a,l,c,"playlist-key")})).catch(a=>this.handleError(a))),s}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Nn?this.hls.trigger(L.ERROR,e.data):this.hls.trigger(L.ERROR,{type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=gu(e.keyFormat),s=n?[n]:ml(this.config);return this.attemptKeySystemAccess(s)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=ml(this.config)),e.length===0)throw new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${ti({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(s=>i.indexOf(s)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var s;const o=(s=this.config.drmSystems)==null||(s=s[e.keySystem])==null?void 0:s.generateRequest;if(o)try{const d=o.call(this.hls,t,i,e);if(!d)throw new Error("Invalid response from configured generateRequest filter");t=d.initDataType,i=d.initData?d.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(d){var a;if(this.warn(d.message),(a=this.hls)!=null&&a.config.debug)throw d}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${n}": ${l} (init data type: ${t} length: ${i?i.byteLength:null})`);const c=new om,u=e._onmessage=d=>{const m=e.mediaKeysSession;if(!m){c.emit("error",new Error("invalid state"));return}const{messageType:A,message:p}=d;this.log(`"${A}" message event for session "${m.sessionId}" message size: ${p.byteLength}`),A==="license-request"||A==="license-renewal"?this.renewLicense(e,p).catch(y=>{c.eventNames().length?c.emit("error",y):this.handleError(y)}):A==="license-release"?e.keySystem===hi.FAIRPLAY&&(this.updateKeySession(e,t0("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${A}"`)},h=e._onkeystatuseschange=d=>{if(!e.mediaKeysSession){c.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const A=e.keyStatus;c.emit("keyStatus",A),A==="expired"&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};Rn(e.mediaKeysSession,"message",u),Rn(e.mediaKeysSession,"keystatuseschange",h);const f=new Promise((d,m)=>{c.on("error",m),c.on("keyStatus",A=>{A.startsWith("usable")?d():A==="output-restricted"?m(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):A==="internal-error"?m(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${A}"`)):A==="expired"?m(new Error("key expired while generating request")):this.warn(`unhandled key status change "${A}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var d;this.log(`Request generated for key-session "${(d=e.mediaKeysSession)==null?void 0:d.sessionId}" keyId: ${l}`)}).catch(d=>{throw new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_SESSION,error:d,fatal:!1},`Error generating key-session request: ${d}`)}).then(()=>f).catch(d=>{throw c.removeAllListeners(),this.removeSession(e),d}).then(()=>(c.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if(typeof i=="string"&&typeof t=="object"){const n=i;i=t,t=n}this.log(`key status change "${t}" for keyStatuses keyId: ${Xs.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Xs.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),s=this.getServerCertificateUrl(e);return s?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const l={responseType:"arraybuffer",url:s},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{o(f.data)},onError:(f,d,m,A)=>{a(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:zt({url:l.url,data:void 0},f)},`"${e}" certificate request failed (${s}). Status: ${f.code} (${f.text})`))},onTimeout:(f,d,m)=>{a(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${s})`))},onAbort:(f,d,m)=>{a(new Error("aborted"))}};n.load(l,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,s)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),n(e)}).catch(o=>{s(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:n,fatal:!0},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),s=n.querySelectorAll("HttpHeader");if(s.length>0){let u;for(let h=0,f=s.length;h<f;h++){var o,a;u=s[h];const d=(o=u.querySelector("name"))==null?void 0:o.textContent,m=(a=u.querySelector("value"))==null?void 0:a.textContent;d&&m&&e.setRequestHeader(d,m)}}const l=n.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return t0(atob(c))}setupLicenseXHR(e,t,i,n){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,i,n)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),s.call(this.hls,e,t,i,n)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,s)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let l=a.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,a,o,e)}catch(u){this.error(u)}n(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||a.status>=400&&a.status<500)s(new Nn({type:qe.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==hi.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,Rn(i,"encrypted",this.onMediaEncrypted),Rn(i,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(jn(e,"encrypted",this.onMediaEncrypted),jn(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,Vl.clearKeyUriToKeyIdMap();const n=i.length;io.CDMCleanupPromise=Promise.all(i.map(s=>this.removeSession(s)).concat(t==null||(e=t.setMediaKeys(null))==null?void 0:e.catch(s=>{var o;this.log(`Could not clear media keys: ${s}`),(o=this.hls)==null||o.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${s}`)})}))).catch(s=>{var o;this.log(`Could not close sessions and clear media keys: ${s}`),(o=this.hls)==null||o.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${s}`)})}).then(()=>{n&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,s)=>(n.indexOf(s.keyFormat)===-1&&n.push(s.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{drmSystemOptions:s}=this.config;return(ww(s)?new Promise((a,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(a)}):Promise.resolve()).catch(a=>{var l;this.log(`Could not remove session: ${a}`),(l=this.hls)==null||l.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${a}`)})}).then(()=>t.close()).catch(a=>{var l;this.log(`Could not close session: ${a}`),(l=this.hls)==null||l.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${a}`)})})}}}io.CDMCleanupPromise=void 0;class Nn extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class h3{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(L.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(L.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const s=n-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,l=1e3*o/s,c=this.hls;if(c.trigger(L.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),l>0&&o>c.config.fpsDroppedMonitoringThreshold*a){let u=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(L.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function f3(r,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=r,e.dispatchEvent(t)}function d3(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues&&!r.cues.getCueById(e.id))try{if(r.addCue(e),!r.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Gt.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,r.addCue(n)}catch(n){Gt.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(r.mode=t)}function qo(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues)for(let i=r.cues.length;i--;)e&&r.cues[i].removeEventListener("enter",e),r.removeCue(r.cues[i]);t==="disabled"&&(r.mode=t)}function u0(r,e,t,i){const n=r.mode;if(n==="disabled"&&(r.mode="hidden"),r.cues&&r.cues.length>0){const s=HB(r.cues,e,t);for(let o=0;o<s.length;o++)(!i||i(s[o]))&&r.removeCue(s[o])}n==="disabled"&&(r.mode=n)}function zB(r,e){if(e<=r[0].startTime)return 0;const t=r.length-1;if(e>r[t].endTime)return-1;let i=0,n=t,s;for(;i<=n;)if(s=Math.floor((n+i)/2),e<r[s].startTime)n=s-1;else if(e>r[s].startTime&&i<t)i=s+1;else return s;return r[i].startTime-e<e-r[n].startTime?i:n}function HB(r,e,t){const i=[],n=zB(r,e);if(n>-1)for(let s=n,o=r.length;s<o;s++){const a=r[s];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function xu(r){const e=[];for(let t=0;t<r.length;t++){const i=r[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(r[t])}return e}class m3 extends lh{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=xu(this.media.textTracks);for(let s=0;s<i.length;s++)if(i[s].mode==="hidden")t=i[s];else if(i[s].mode==="showing"){t=i[s];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(L.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;xu(i.textTracks).forEach(o=>{qo(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(n==null?void 0:n.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(u=>u.default)&&(this.selectDefaultTrack=!1),o.forEach((u,h)=>{u.id=h});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!s&&a){this.selectDefaultTrack=!1;const u=Ms(a,o);if(u>-1)s=o[u];else{const h=Ms(a,this.tracks);s=this.tracks[h]}}let l=this.findTrackId(s);l===-1&&s&&(l=this.findTrackId(null));const c={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(L.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const s=t[n];if(!(i&&!s.default||!i&&!e)&&(!e||to(s,e)))return n}if(e){for(let n=0;n<t.length;n++){const s=t[n];if(kl(e.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const s=t[n];if(kl(e.attrs,s.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(o0(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===xt.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&to(e,i))return i;const n=Ms(e,this.tracksInGroup);if(n>-1){const s=this.tracksInGroup[n];return this.setSubtitleTrack(n),s}else{if(i)return null;{const s=Ms(e,t);if(s>-1)return t[s]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(L.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=xu(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(s=>o0(i,s))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(s=>{s.mode!=="disabled"&&s!==n&&(s.mode="disabled")}),n){const s=this.subtitleDisplay?"showing":"hidden";n.mode!==s&&(n.mode=s)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!ze(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(L.SUBTITLE_TRACK_SWITCH,{id:e});return}const s=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&s)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:o,groupId:a="",name:l,type:c,url:u}=n;this.hls.trigger(L.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:l,type:c,url:u});const h=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(h)}}function VB(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const s=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(n=="x"?s:s&3|8).toString(16)})}}}function Sl(r){let e=5381,t=r.length;for(;t;)e=e*33^r.charCodeAt(--t);return(e>>>0).toString()}const ra=.025;let Hu=function(r){return r[r.Point=0]="Point",r[r.Range=1]="Range",r}({});function KB(r,e,t){return`${r.identifier}-${t+1}-${Sl(e)}`}class $B{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return Lf(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=Lf(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=ze(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return Lf(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<ra))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Hu.Range:Hu.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return YB(this)}}function Lf(r,e){return r-e.start<e.duration/2&&!(Math.abs(r-(e.start+e.duration))<ra)?e.start:e.start+e.duration}function A3(r,e,t){const i=new self.URL(r,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function Pf(r,e){for(;(t=r.assetList[++e])!=null&&t.error;)var t;return e}function YB(r){return`["${r.identifier}" ${r.cue.pre?"<pre>":r.cue.post?"<post>":""}${r.timelineStart.toFixed(2)}-${r.resumeTime.toFixed(2)}]`}function $o(r){const e=r.timelineStart,t=r.duration||0;return`["${r.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class WB{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(L.PLAYOUT_LIMIT_REACHED,{})};const s=this.hls=new e(t);this.interstitial=i,this.assetItem=n;const o=()=>{this.hasDetails=!0};s.once(L.LEVEL_LOADED,o),s.once(L.AUDIO_TRACK_LOADED,o),s.once(L.SUBTITLE_TRACK_LOADED,o),s.on(L.MEDIA_ATTACHING,(a,{media:l})=>{this.removeMediaListeners(),this.mediaAttached=l,this.interstitial.playoutLimit&&(l.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&s.on(L.BUFFER_APPENDED,()=>{const u=this.bufferedEnd;this.reachedPlayout(u)&&(this._bufferedEosTime=u,s.trigger(L.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=A3(t,e.config.primarySessionId||"").href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;const i=Math.min(this._bufferedEosTime||1/0,this.duration),n=this.timelineOffset,s=ft.bufferInfo(e,n,0);return this.getAssetTime(s.end)>=i-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=ft.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const i=t-this.startOffset;if(i>0&&i<e)return i}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){var n;(n=this.hls)==null||n.on(e,t)}once(e,t,i){var n;(n=this.hls)==null||n.once(e,t)}off(e,t,i){var n;(n=this.hls)==null||n.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${$o(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const s1=.033;class jB extends gs{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(s=n[i])!=null&&s.event;){var s;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let s=i[n];if(t&&t!=="primary"&&(s=s[t]),e===s.start||e>s.start&&e<s.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const s=i[n].event;if(s!=null&&s.restrictions.jump&&!s.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let s=0;s<n;s++){const o=i[s];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&(t<a+(o.duration||0)||s===n-1))return s}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const i=t.assetList,n=i[i.length-1];if(n)return n.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,s=this.events,o=this.parseDateRanges(n,{url:i.url},t),a=Object.keys(n),l=s?s.filter(c=>!a.includes(c.identifier)):[];o.length&&o.sort((c,u)=>{const h=c.cue.pre,f=c.cue.post,d=u.cue.pre,m=u.cue.post;if(h&&!d)return-1;if(d&&!h||f&&!m)return 1;if(m&&!f)return-1;if(!h&&!d&&!f&&!m){const A=c.startTime,p=u.startTime;if(A!==p)return A-p}return c.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=o,l.forEach(c=>{this.removeEvent(c)}),this.updateSchedule(e,l)}updateSchedule(e,t=[],i=!1){const n=this.events||[];if(n.length||t.length||this.length<2){const s=this.items,o=this.parseSchedule(n,e);(i||t.length||(s==null?void 0:s.length)!==o.length||o.some((l,c)=>Math.abs(l.playout.start-s[c].playout.start)>.005||Math.abs(l.playout.end-s[c].playout.end)>.005))&&(this.items=o,this.onScheduleUpdate(t,s))}}parseDateRanges(e,t,i){const n=[],s=Object.keys(e);for(let o=0;o<s.length;o++){const a=s[o],l=e[a];if(l.isInterstitial){let c=this.eventMap[a];c?c.setDateRange(l):(c=new $B(l,t),this.eventMap[a]=c,i===!1&&(c.appendInPlace=i)),n.push(c)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,s=n.live?1/0:n.edge;let o=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((u,h)=>{const f=u.cue.pre,d=u.cue.post,m=e[h-1]||null,A=u.appendInPlace,p=d?s:u.startOffset,y=u.duration,E=u.timelineOccupancy===Hu.Range?y:0,v=u.resumptionOffset,x=(m==null?void 0:m.startTime)===p,C=p+u.cumulativeDuration;let I=A?C+y:p+v;if(f||!d&&p<=0){const S=c;c+=E,u.timelineStart=C;const b=o;o+=y,i.push({event:u,start:C,end:I,playout:{start:b,end:o},integrated:{start:S,end:c}})}else if(p<=s){if(!x){const T=p-l;if(T>s1){const R=l,w=c;c+=T;const B=o;o+=T;const D={previousEvent:e[h-1]||null,nextEvent:u,start:R,end:R+T,playout:{start:B,end:o},integrated:{start:w,end:c}};i.push(D)}else T>0&&m&&(m.cumulativeDuration+=T,i[i.length-1].end=p)}d&&(I=C),u.timelineStart=C;const S=c;c+=E;const b=o;o+=y,i.push({event:u,start:C,end:I,playout:{start:b,end:o},integrated:{start:S,end:c}})}else return;const _=u.resumeTime;d||_>s?l=s:l=_}),l<s){var a;const u=l,h=c,f=s-l;c+=f;const d=o;o+=f,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:l,end:u+f,playout:{start:d,end:o},integrated:{start:h,end:c}})}this.setDurations(s,o,c)}else i.push({previousEvent:null,nextEvent:null,start:0,end:s,playout:{start:0,end:s},integrated:{start:0,end:s}}),this.setDurations(s,s,s);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let s=0,o=-1;e.forEach((a,l)=>{const c=a.cue.pre,u=a.cue.post,h=c?0:u?n:a.startTime;this.updateAssetDurations(a),o===h?a.cumulativeDuration=s:(s=0,o=h),!u&&a.snapOptions.in&&(a.resumeAnchor=no(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<s1&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const d=ze(a.resumeOffset)?a.resumeOffset:a.duration;s+=d})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>ra?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):!Object.keys(t).some(o=>{const a=t[o].details,l=a.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${l}`),!1;const c=no(null,a.fragments,i);if(!c)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const u=o==="audio"?.175:0;return Math.abs(c.start-i)<ra+u||Math.abs(c.end-i)<ra+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,s=!1;for(let o=0;o<e.assetList.length;o++){const a=e.assetList[o],l=t+i;a.startOffset=i,a.timelineStart=l,n||(n=a.duration===null),s||(s=!!a.error);const c=a.error?0:a.duration||0;i+=c}n&&!s?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Ks(r){return`[${r.event?'"'+r.event.identifier+'"':"primary"}: ${r.start.toFixed(2)}-${r.end.toFixed(2)}]`}class XB{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=A3(i,this.hls.sessionId,e.baseUrl)}catch(f){const d=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(L.ERROR,d);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const s=this.hls.config,o=s.loader,a=new o(s),l={responseType:"json",url:n.href},c=s.interstitialAssetListLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const p=f.data,y=p==null?void 0:p.ASSETS;if(!Array.isArray(y)){const E=this.assignAssetListError(e,ue.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),m.url,d,A);this.hls.trigger(L.ERROR,E);return}e.assetListResponse=p,this.hls.trigger(L.ASSET_LIST_LOADED,{event:e,assetListResponse:p,networkDetails:A})},onError:(f,d,m,A)=>{const p=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${d.url})`),d.url,A,m);this.hls.trigger(L.ERROR,p)},onTimeout:(f,d,m)=>{const A=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${d.url})`),d.url,f,m);this.hls.trigger(L.ERROR,A)}};return a.load(l,u,h),this.hls.trigger(L.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,n,s,o){return e.error=i,{type:qe.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:o,stats:s}}}function r1(r){r==null||r.play().catch(()=>{})}class qB extends gs{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled||!this.schedule)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const o=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(!0),this.checkBuffer(),o&&i<a.start||i>=a.end){var l;const d=this.findItemIndex(a);let m=this.schedule.findItemIndexAtTime(i);if(m===-1&&(m=d+(o?-1:1),this.log(`seeked ${o?"back ":""}to position not covered by schedule ${i} (resolving from ${d} to ${m})`)),!this.isInterstitial(a)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!o&&m>d){const A=this.schedule.findJumpRestrictedIndex(d+1,m);if(A>d){this.setSchedulePosition(A);return}}this.setSchedulePosition(m);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(a)){const d=a.event.assetList[0];d&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,d))}return}const u=c.timelineStart,h=c.duration||0;if(o&&i<u||i>=u+h){var f;(f=a.event)!=null&&f.appendInPlace&&(this.clearInterstitial(a.event,a),this.flushFrontBuffer(i)),this.setScheduleToAssetAtTime(i,c)}},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const a=this.findItemIndex(n);this.setSchedulePosition(a+1)}const s=this.playingAsset;if(!s)return;const o=s.timelineStart+(s.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,s)},this.onScheduleUpdate=(i,n)=>{const s=this.schedule;if(!s)return;const o=this.playingItem,a=s.events||[],l=s.items||[],c=s.durations,u=i.map(A=>A.identifier),h=!!(a.length||u.length);(h||n)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${l.map(A=>Ks(A))} pos: ${this.timelinePos}`),u.length&&this.log(`Removed events ${u}`);let f=null,d=null;o&&(f=this.updateItem(o,this.timelinePos),this.itemsMatch(o,f)?this.playingItem=f:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const m=this.bufferingItem;if(m&&(d=this.updateItem(m,this.bufferedPos),this.itemsMatch(m,d)?this.bufferingItem=d:m.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(m.event,null))),i.forEach(A=>{A.assetList.forEach(p=>{this.clearAssetPlayer(p.identifier,null)})}),this.playerQueue.forEach(A=>{if(A.interstitial.appendInPlace){const p=A.assetItem.timelineStart,y=A.timelineOffset-p;if(y)try{A.timelineOffset=p}catch(E){Math.abs(y)>ra&&this.warn(`${E} ("${A.assetId}" ${A.timelineOffset}->${p})`)}}}),h||n){if(this.hls.trigger(L.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:l.slice(0),durations:c,removedIds:u}),this.isInterstitial(o)&&u.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}o&&this.trimInPlace(f,o),m&&this.trimInPlace(d,m),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new XB(e),this.schedule=new jB(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e&&(e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(L.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(L.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(L.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(L.MEDIA_ENDED,this.onMediaEnded,this),e.on(L.ERROR,this.onError,this),e.on(L.DESTROYING,this.onDestroying,this))}unregisterListeners(){const e=this.hls;e&&(e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(L.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(L.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(L.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(L.MEDIA_ENDED,this.onMediaEnded,this),e.off(L.ERROR,this.onError,this),e.off(L.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){jn(e,"play",this.onPlay),jn(e,"pause",this.onPause),jn(e,"seeking",this.onSeeking),jn(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;Rn(i,"seeking",this.onSeeking),Rn(i,"timeupdate",this.onTimeupdate),Rn(i,"play",this.onPlay),Rn(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const s=this.findItemIndex(i);this.setSchedulePosition(s)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const s=this.getBufferingPlayer();s&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,s.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=h=>h&&e.getAssetPlayer(h.identifier),n=(h,f,d,m,A)=>{if(h){let p=h[f].start;const y=h.event;if(y){if(f==="playout"||y.timelineOccupancy!==Hu.Point){const E=i(d);(E==null?void 0:E.interstitial)===y&&(p+=E.assetItem.startOffset+E[A])}}else{const E=m==="bufferedPos"?o():e[m];p+=E-h.start}return p}return 0},s=(h,f)=>{var d;if(h!==0&&f!=="primary"&&(d=e.schedule)!=null&&d.length){var m;const A=e.schedule.findItemIndexAtTime(h),p=(m=e.schedule.items)==null?void 0:m[A];if(p){const y=p[f].start-p.start;return h+y}}return h},o=()=>{const h=e.bufferedPos;return h===Number.MAX_VALUE?a("primary"):Math.max(h,0)},a=h=>{var f,d;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:((d=e.schedule)==null?void 0:d.durations[h])||0},l=(h,f)=>{var d,m;const A=e.effectivePlayingItem;if(A!=null&&(d=A.event)!=null&&d.restrictions.skip||!e.schedule)return;e.log(`seek to ${h} "${f}"`);const p=e.effectivePlayingItem,y=e.schedule.findItemIndexAtTime(h,f),E=(m=e.schedule.items)==null?void 0:m[y],v=e.getBufferingPlayer(),x=v==null?void 0:v.interstitial,C=x==null?void 0:x.appendInPlace,I=p&&e.itemsMatch(p,E);if(p&&(C||I)){const _=i(e.playingAsset),S=(_==null?void 0:_.media)||e.primaryMedia;if(S){const b=f==="primary"?S.currentTime:n(p,f,e.playingAsset,"timelinePos","currentTime"),T=h-b,R=(C?b:S.currentTime)+T;if(R>=0&&(!_||C||R<=_.duration)){S.currentTime=R;return}}}if(E){let _=h;if(f!=="primary"){const b=E[f].start,T=h-b;_=E.start+T}const S=!e.isInterstitial(E);if((!e.isInterstitial(p)||p.event.appendInPlace)&&(S||E.event.appendInPlace)){const b=e.media||(C?v==null?void 0:v.media:null);b&&(b.currentTime=_)}else if(p){const b=e.findItemIndex(p);if(y>b){const R=e.schedule.findJumpRestrictedIndex(b+1,y);if(R>b){e.setSchedulePosition(R);return}}let T=0;if(S)e.timelinePos=_,e.checkBuffer();else{const R=E.event.assetList,w=h-(E[f]||E).start;for(let B=R.length;B--;){const D=R[B];if(D.duration&&w>=D.startOffset&&w<D.startOffset+D.duration){T=B;break}}}e.setSchedulePosition(y,T)}}},c=()=>{const h=e.effectivePlayingItem;if(e.isInterstitial(h))return h;const f=t();return e.isInterstitial(f)?f:null},u={get bufferedEnd(){const h=t(),f=e.bufferingItem;if(f&&f===h){var d;return n(f,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-f.playout.start||((d=e.bufferingAsset)==null?void 0:d.startOffset)||0}return 0},get currentTime(){const h=c(),f=e.effectivePlayingItem;return f&&f===h?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(h){const f=c(),d=e.effectivePlayingItem;d&&d===f&&l(h+d.playout.start,"playout")},get duration(){const h=c();return h?h.playout.end-h.playout.start:0},get assetPlayers(){var h;const f=(h=c())==null?void 0:h.event.assetList;return f?f.map(d=>e.getAssetPlayer(d.identifier)):[]},get playingIndex(){var h;const f=(h=c())==null?void 0:h.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};return this.manager={get events(){var h;return((h=e.schedule)==null||(h=h.events)==null?void 0:h.slice(0))||[]},get schedule(){var h;return((h=e.schedule)==null||(h=h.items)==null?void 0:h.slice(0))||[]},get interstitialPlayer(){return c()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const h=t();return e.findItemIndex(h)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const h=e.effectivePlayingItem;return e.findItemIndex(h)},primary:{get bufferedEnd(){return o()},get currentTime(){const h=e.timelinePos;return h>0?h:0},set currentTime(h){l(h,"primary")},get duration(){return a("primary")},get seekableStart(){var h;return((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(h){l(h,"integrated")},get duration(){return a("integrated")},get seekableStart(){var h;return s(((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0,"integrated")}},skip:()=>{const h=e.effectivePlayingItem,f=h==null?void 0:h.event;if(f&&!f.restrictions.skip){const d=e.findItemIndex(h);if(f.appendInPlace){const m=h.playout.start+h.event.duration;l(m+.001,"playout")}else e.advanceAfterAssetEnded(f,d,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const i=this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&!i.event.appendInPlace)return;let n=this.media;!n&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(n=this.primaryMedia);const s=(t=n)==null?void 0:t.currentTime;if(!(s===void 0||!ze(s)))return s}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const s=e.transferMedia();this.log(`transfer MediaSource from ${e} ${ti(s)}`),this.detachedData=s}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let s=null;const o=this.hls,a=e!==o,l=a&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(o.media)l&&(s=o.transferMedia(),this.detachedData=s),u="Primary";else if(c){const m=this.getBufferingPlayer();m?(s=m.transferMedia(),u=`${m}`):u="detached MediaSource"}else u="detached media";if(!s){if(c)s=this.detachedData,this.log(`using detachedData: MediaSource ${ti(s)}`);else if(!this.detachedData||o.media===t){const m=this.playerQueue;m.length>1&&m.forEach(A=>{if(a&&A.interstitial.appendInPlace!==l){const p=A.interstitial;this.clearInterstitial(A.interstitial,null),p.appendInPlace=!1,p.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${p}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const h=s&&"mediaSource"in s&&((n=s.mediaSource)==null?void 0:n.readyState)!=="closed",f=h&&s?s:t;this.log(`${h?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${u} (media.currentTime: ${t.currentTime})`);const d=this.schedule;if(f===s&&d){const m=a&&e.assetId===d.assetIdAtEnd;f.overrides={duration:d.duration,endOfStream:!a||m,cueRemoval:!a}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e==null?void 0:e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const s=this.hls.startPosition;if(this.timelinePos=s,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(s>=0||!this.primaryLive){const o=this.timelinePos=s>0?s:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(n&&!this.playingItem){const s=e.findItemIndex(n);this.setSchedulePosition(s)}}advanceAssetBuffering(e,t){const i=e.event,n=i.findAssetIndex(t),s=Pf(i,n);if(!i.isAssetPastPlayoutLimit(s))this.bufferedToEvent(e,s);else if(this.schedule){var o;const a=(o=this.schedule.items)==null?void 0:o[this.findItemIndex(e)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(e,t,i){const n=Pf(e,i);if(e.isAssetPastPlayoutLimit(n)){if(this.schedule){const s=this.schedule.items;if(s){const o=t+1,a=s.length;if(o>=a){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.timelinePos=l,e.appendInPlace&&this.advanceInPlace(l),this.checkBuffer(this.bufferedPos<l)),this.setSchedulePosition(o)}}}else{if(e.appendInPlace){const s=e.assetList[n];s&&this.advanceInPlace(s.timelineStart)}this.setSchedulePosition(t,n)}}setScheduleToAssetAtTime(e,t){const i=this.schedule;if(!i)return;const n=t.parentIdentifier,s=i.getEvent(n);if(s){const o=i.findEventIndex(n),a=i.findAssetIndex(s,e);this.advanceAfterAssetEnded(s,o,a-1)}}setSchedulePosition(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(!n||this.playbackDisabled)return;const s=e>=0?n[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${s&&Ks(s)})`);const o=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(o)){const u=o.event,h=this.playingAsset,f=h==null?void 0:h.identifier,d=f?this.getAssetPlayer(f):null;if(d&&f&&(!this.eventItemsMatch(o,s)||t!==void 0&&f!==u.assetList[t].identifier)){var l;const m=u.findAssetIndex(h);if(this.log(`INTERSTITIAL_ASSET_ENDED ${m+1}/${u.assetList.length} ${$o(h)}`),this.endedAsset=h,this.playingAsset=null,this.hls.trigger(L.INTERSTITIAL_ASSET_ENDED,{asset:h,assetListIndex:m,event:u,schedule:n.slice(0),scheduleIndex:e,player:d}),o!==this.playingItem){this.itemsMatch(o,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(u,this.findItemIndex(this.playingItem),m);return}this.retreiveMediaSource(f,s),d.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&d.detachMedia()}if(!this.eventItemsMatch(o,s)&&(this.endedItem=o,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${u} ${Ks(o)}`),u.hasPlayed=!0,this.hls.trigger(L.INTERSTITIAL_ENDED,{event:u,schedule:n.slice(0),scheduleIndex:e}),u.cue.once)){var c;this.updateSchedule();const m=(c=this.schedule)==null?void 0:c.items;if(s&&m){const A=this.findItemIndex(s);this.advanceSchedule(A,m,t,o,a)}return}}this.advanceSchedule(e,n,t,o,a)}advanceSchedule(e,t,i,n,s){const o=this.schedule;if(!o)return;const a=e>=0?t[e]:null,l=this.primaryMedia,c=this.playerQueue;if(c.length&&c.forEach(u=>{const h=u.interstitial,f=o.findEventIndex(h.identifier);(f<e||f>e+1)&&this.clearInterstitial(h,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const u=a.event;if(i===void 0){i=o.findAssetIndex(u,this.timelinePos);const m=Pf(u,i-1);if(u.isAssetPastPlayoutLimit(m)||u.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(u,e,i);return}i=m}const h=this.waitingItem;this.assetsBuffered(a,l)||this.setBufferingItem(a);let f=this.preloadAssets(u,i);if(this.eventItemsMatch(a,h||n)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${Ks(a)} ${u.appendInPlace?"append in place":""}`),this.hls.trigger(L.INTERSTITIAL_STARTED,{event:u,schedule:t.slice(0),scheduleIndex:e})),!u.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${u}`);return}if(u.assetListLoader&&(u.assetListLoader.destroy(),u.assetListLoader=void 0),!l){this.log(`Waiting for attachMedia to start Interstitial ${u}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const d=u.assetList[i];if(!d){this.advanceAfterAssetEnded(u,e,i||0);return}if(f||(f=this.getAssetPlayer(d.identifier)),f===null||f.destroyed){const m=u.assetList.length;this.warn(`asset ${i+1}/${m} player destroyed ${u}`),f=this.createAssetPlayer(u,d,i),f.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&u.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(f,i,t,e,l),this.shouldPlay&&r1(f.media)}else a!==null?(this.resumePrimary(a,e,n),this.shouldPlay&&r1(this.hls.media)):s&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(o.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e;return(e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n,s;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Ks(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const o=(s=this.schedule)==null?void 0:s.items;o&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Ks(e)}`),this.hls.trigger(L.INTERSTITIALS_PRIMARY_RESUMED,{schedule:o.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:ft.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const s=this.hls;s.media?this.checkBuffer():(this.transferMediaTo(s,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(L.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(L.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const i=this.hls.levels[t.level],n=zt(zt({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=zt(zt({},this.altSelection),{},{audio:i});return}const s=zt(zt({},n),{},{audio:i});this.mediaSelection=s}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=zt(zt({},this.altSelection),{},{subtitles:i});return}const s=zt(zt({},n),{},{subtitles:i});this.mediaSelection=s}onAudioTrackSwitching(e,t){const i=yg(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setAudioOption(t)||n.setAudioOption(i)))}onSubtitleTrackSwitch(e,t){const i=yg(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setSubtitleOption(t)||t.id!==-1&&n.setSubtitleOption(i)))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const s=t[n];if(s.cue.post){var i;const o=this.schedule.findEventIndex(s.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(e&&n){const s=this.findItemIndex(e,t);return n[s]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((s,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(s.identifier,null)});const i=e.end+.25,n=ft.bufferInfo(this.primaryMedia,i,0);(n.end>i||(n.nextStart||0)>i)&&(this.attachPrimary(i,null),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;const i=this.mediaSelection;i&&((t=this.schedule)==null||t.updateSchedule(i,[],e))}checkBuffer(e){var t;const i=(t=this.schedule)==null?void 0:t.items;if(!i)return;const n=ft.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=n.len<1),this.updateBufferedPos(n.end,i,e)}updateBufferedPos(e,t,i){const n=this.schedule,s=this.bufferingItem;if(this.bufferedPos>e||!n)return;if(t.length===1&&this.itemsMatch(t[0],s)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let l=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var c;const u=this.findItemIndex(s),h=Math.min(u+1,t.length-1),f=t[h];if((l===-1&&s&&e>=s.end||(c=f.event)!=null&&c.appendInPlace&&e+.01>=f.start)&&(l=h),this.isInterstitial(s)){const d=s.event;if(h-a>1&&d.appendInPlace===!1||d.assetList.length===0&&d.assetListLoader)return}if(this.bufferedPos=e,l>u&&l>a)this.bufferedToItem(f);else{const d=this.primaryDetails;this.primaryLive&&d&&e>d.edge-d.targetduration&&f.start<d.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(f)&&this.preloadAssets(f.event,0)}}else i&&o&&!this.itemsMatch(o,s)&&(l===a?this.bufferedToItem(o):l===a+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const s=this.getAssetPlayer(n.identifier);return!(s!=null&&s.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(!this.itemsMatch(e,t)&&i){const{items:n,events:s}=i;if(!n||!s)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const l=a?a.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Ks(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(o){const c=i.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((u,h)=>{const f=this.getAssetPlayer(u.identifier);f&&(h===c&&f.loadSource(),f.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering());this.hls.trigger(L.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:s.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,s=i.cue.once;if(n||!s){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(o,a)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,s=n===0&&!e.assetListLoader,o=e.cue.once;if(s){const l=e.timelineStart;if(e.appendInPlace){var a;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(a=f.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let c,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-l;f>0&&(c=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${c?` live-start: ${u} start-offset: ${c}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const h=this.assetListLoader.loadAssetList(e,c);h&&(e.assetListLoader=h)}else if(!o&&n){for(let c=t;c<n;c++){const u=e.assetList[c],h=this.getAssetPlayerQueueIndex(u.identifier);(h===-1||this.playerQueue[h].destroyed)&&!u.error&&this.createAssetPlayer(e,u,c)}const l=e.assetList[t];if(l){const c=this.getAssetPlayer(l.identifier);return c&&c.loadSource(),c}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,s,o){const a={parentIdentifier:e.identifier,identifier:KB(e,o,t),duration:s,startOffset:i,timelineStart:n,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const n=this.hls,s=n.userConfig;let o=s.videoPreference;const a=n.loadLevelObj||n.levels[n.currentLevel];(o||a)&&(o=Vt({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const l=n.audioTracks[n.audioTrack],c=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const x=this.timelinePos-t.timelineStart;if(x>1){const C=t.duration;C&&x<C&&(u=x)}}const h=t.identifier,f=zt(zt({},s),{},{maxMaxBufferLength:Math.min(180,n.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:h,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:l||s.audioPreference,subtitlePreference:c||s.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const d=f.cmcd;d!=null&&d.sessionId&&d.contentId&&(f.cmcd=Vt({},d,{contentId:Sl(t.uri)})),this.getAssetPlayer(h)&&this.warn(`Duplicate date range identifier ${e} and asset ${h}`);const m=new WB(this.HlsPlayerClass,f,e,t);this.playerQueue.push(m),e.assetList[i]=t;let A=!0;const p=x=>{if(x.live){var C;const S=new Error(`Interstitials MUST be VOD assets ${e}`),b={fatal:!0,type:qe.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:S},T=((C=this.schedule)==null?void 0:C.findEventIndex(e.identifier))||-1;this.handleAssetItemError(b,e,T,i,S.message);return}const I=x.edge-x.fragmentStart,_=t.duration;(A||_===null||I>_)&&(A=!1,this.log(`Interstitial asset "${h}" duration change ${_} > ${I}`),t.duration=I,this.updateSchedule())};m.on(L.LEVEL_UPDATED,(x,{details:C})=>p(C)),m.on(L.LEVEL_PTS_UPDATED,(x,{details:C})=>p(C)),m.on(L.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const y=(x,C)=>{const I=this.getAssetPlayer(h);if(I&&C.tracks){I.off(L.BUFFER_CODECS,y),I.tracks=C.tracks;const _=this.primaryMedia;this.bufferingAsset===I.assetItem&&_&&!I.media&&this.bufferAssetPlayer(I,_)}};m.on(L.BUFFER_CODECS,y);const E=()=>{var x;const C=this.getAssetPlayer(h);if(this.log(`buffered to end of asset ${C}`),!C||!this.schedule)return;const I=this.schedule.findEventIndex(e.identifier),_=(x=this.schedule.items)==null?void 0:x[I];this.isInterstitial(_)&&this.advanceAssetBuffering(_,t)};m.on(L.BUFFERED_TO_END,E);const v=x=>()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;this.shouldPlay=!0;const I=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,I,x)};return m.once(L.MEDIA_ENDED,v(i)),m.once(L.PLAYOUT_LIMIT_REACHED,v(1/0)),m.on(L.ERROR,(x,C)=>{if(!this.schedule)return;const I=this.getAssetPlayer(h);if(C.details===ue.BUFFER_STALLED_ERROR){if(I!=null&&I.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(C,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${C.error} ${e}`)}),m.on(L.DESTROYING,()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;const C=new Error(`Asset player destroyed unexpectedly ${h}`),I={fatal:!0,type:qe.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:C};this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),i,C.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${$o(t)}`),this.hls.trigger(L.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:m}),m}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clear asset player "${e}" toSegment: ${t&&Ks(t)}`);const n=this.playerQueue[i];this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,s){const{interstitial:o,assetItem:a,assetId:l}=e,c=o.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!u||u.identifier!==l)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${$o(a)}`),this.hls.trigger(L.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,s)}bufferAssetPlayer(e,t){var i,n;if(!this.schedule)return;const{interstitial:s,assetItem:o}=e,a=this.schedule.findEventIndex(s.identifier),l=(i=this.schedule.items)==null?void 0:i[a];if(!l)return;e.loadSource(),this.setBufferingItem(l),this.bufferingAsset=o;const c=this.getBufferingPlayer();if(c===e)return;const u=s.appendInPlace;if(u&&(c==null?void 0:c.interstitial.appendInPlace)===!1)return;const h=(c==null?void 0:c.tracks)||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(u&&o!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(h&&!jv(h,e.tracks)){const f=new Error(`Asset ${$o(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(h)}')`),d={fatal:!0,type:qe.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:f},m=s.findAssetIndex(o);this.handleAssetItemError(d,s,a,m,f.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){const t=this.schedule,i=this.primaryMedia;if(!t||!i)return;const n=i.currentTime,s=t.findAssetIndex(e,n),o=e.assetList[s];if(o){const a=this.getAssetPlayer(o.identifier);if(a){const l=a.currentTime||n-o.timelineStart,c=a.duration-l;if(this.warn(`Stalled at ${l} of ${l+c} in ${a} ${e} (media.currentTime: ${n})`),l&&(c/i.playbackRate<.5||a.bufferedInPlaceToEnd(i))&&a.hls){const u=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,u,s)}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,i,n,s){if(e.details===ue.BUFFER_STALLED_ERROR)return;const o=t.assetList[n]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&$o(o)} ${e.error}`),!this.schedule)return;const a=(o==null?void 0:o.identifier)||"",l=this.getAssetPlayerQueueIndex(a),c=this.playerQueue[l]||null,u=this.schedule.items,h=Vt({},e,{fatal:!1,errorAction:Ml(!0),asset:o,assetListIndex:n,event:t,schedule:u,scheduleIndex:i,player:c});if(this.hls.trigger(L.INTERSTITIAL_ASSET_ERROR,h),!e.fatal)return;const f=this.playingAsset,d=this.bufferingAsset,m=new Error(s);if(o&&(this.clearAssetPlayer(a,null),o.error=m),!t.assetList.some(A=>!A.error))t.error=m;else for(let A=n;A<t.assetList.length;A++)this.resetAssetPlayer(t.assetList[A].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):f&&f.identifier===a?this.advanceAfterAssetEnded(t,i,n):d&&d.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,d)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${Ks(i)} error: ${e.error}`);let n=this.timelinePos;n===-1&&(n=this.hls.startPosition);const s=this.updateItem(i,n);if(this.itemsMatch(i,s)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t)),!this.schedule)return;const o=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(o)}else this.checkStart()}onAssetListLoaded(e,t){var i,n;const s=t.event,o=s.identifier,a=t.assetListResponse.ASSETS;if(!((i=this.schedule)!=null&&i.hasEvent(o)))return;const l=s.timelineStart,c=s.duration;let u=0;a.forEach((A,p)=>{const y=parseFloat(A.DURATION);this.createAsset(s,p,u,l+u,y,A.URI),u+=y}),s.duration=u,this.log(`Loaded asset-list with duration: ${u} (was: ${c}) ${s}`);const h=this.waitingItem,f=(h==null?void 0:h.event.identifier)===o;this.updateSchedule();const d=(n=this.bufferingItem)==null?void 0:n.event;if(f){var m;const A=this.schedule.findEventIndex(o),p=(m=this.schedule.items)==null?void 0:m[A];if(p){if(!this.playingItem&&this.timelinePos>p.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==A){s.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${s}`),this.updateSchedule(!0),this.primaryFallback(s);return}this.setBufferingItem(p)}this.setSchedulePosition(A)}else if((d==null?void 0:d.identifier)===o){const A=s.assetList[0];if(A){const p=this.getAssetPlayer(A.identifier);if(d.appendInPlace){const y=this.primaryMedia;p&&y&&this.bufferAssetPlayer(p,y)}else p&&p.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case ue.ASSET_LIST_PARSING_ERROR:case ue.ASSET_LIST_LOAD_ERROR:case ue.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&(this.updateSchedule(!0),this.primaryFallback(i));break}case ue.BUFFER_STALLED_ERROR:{const i=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&i.event.appendInPlace){this.handleInPlaceStall(i.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const o1=500;class p3 extends oh{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",$e.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(L.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(L.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=be.IDLE,this.setInterval(o1),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(this.fragContextChanged(i)||(bi(i)&&(this.fragPrevious=i),this.state=be.IDLE),!n)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let o;const a=i.start;for(let c=0;c<s.length;c++)if(a>=s[c].start&&a<=s[c].end){o=s[c];break}const l=i.start+i.duration;o?o.end=l:(o={start:a,end:l},s.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const s=n-1;if(s<=0)return;t.endOffsetSubtitles=Math.max(0,s),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=s){o.shift();continue}else if(o[a].start<s)o[a].start=s;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,s,$e.SUBTITLE)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===$e.SUBTITLE&&(t.details===ue.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==be.STOPPED&&(this.state=be.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&WE(this.levels,t)){this.levels=t.map(i=>new fa(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new fa(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,$e.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==be.STOPPED&&this.setInterval(o1)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:s}=this,{details:o,id:a}=t;if(!s){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const l=s[a];if(a>=s.length||!l)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(o.live||(i=l.details)!=null&&i.live){if(o.deltaUpdateFailed)return;const h=this.mainDetails;if(!h){this.startFragRequested=!1;return}const f=h.fragments[0];if(!l.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Qu(o,h),c=o.fragmentStart):f&&(c=f.start,n0(o,c));else{var u;c=this.alignPlaylists(o,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,n0(o,c))}h&&!this.startFragRequested&&this.setStartPosition(h,c)}l.details=o,this.levelLastLoaded=l,a===n&&(this.hls.trigger(L.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===be.IDLE&&(no(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&sa(n.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,nm(n.method)).catch(a=>{throw s.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const l=performance.now();s.trigger(L.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:l}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=be.IDLE})}}doTick(){if(!this.media){this.state=be.IDLE;return}if(this.state===be.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,s=this.getLoadPosition(),o=ft.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,n.maxBufferHole),{end:a,len:l}=o,c=i.details,u=this.hls.maxBufferLength+c.levelTargetDuration;if(l>u)return;const h=c.fragments,f=h.length,d=c.edge;let m=null;const A=this.fragPrevious;if(a<d){const E=n.maxFragLookUpTolerance,v=a>d-E?0:E;m=no(A,h,Math.max(h[0].start,a),v),!m&&A&&A.start<h[0].start&&(m=h[0])}else m=h[f-1];if(m=this.filterReplacedPrimary(m,i.details),!m)return;const p=m.sn-c.startSN,y=h[p-1];if(y&&y.cc===m.cc&&this.fragmentTracker.getState(y)===Fi.NOT_LOADED&&(m=y),this.fragmentTracker.getState(m)===Fi.NOT_LOADED){const E=this.mapToInitFragWhenRequired(m);E&&this.loadFragment(E,i,a)}}}loadFragment(e,t,i){bi(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new JB(this.tracksBuffered[this.currentTrackId]||[])}}class JB{constructor(e){this.buffered=void 0;const t=(i,n,s)=>{if(n=n>>>0,n>s-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${s})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const ZB={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},g3=r=>String.fromCharCode(ZB[r]||r),hs=15,$s=100,e9={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},t9={17:2,18:4,21:6,22:8,23:10,19:13,20:15},i9={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},n9={25:2,26:4,29:6,30:8,31:10,27:13,28:15},s9=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class r9{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;Gt.log(`${this.time} [${e}] ${i}`)}}}const zr=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class y3{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class o9{constructor(){this.uchar=" ",this.penState=new y3}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class a9{constructor(e){this.chars=[],this.pos=0,this.currPenState=new y3,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<$s;t++)this.chars.push(new o9);this.logger=e}equals(e){for(let t=0;t<$s;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<$s;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<$s;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>$s&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=$s)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=g3(e);if(this.pos>=$s){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<$s;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<$s;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Ff{constructor(e){this.rows=[],this.currRow=hs-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<hs;t++)this.rows.push(new a9(e));this.logger=e}reset(){for(let e=0;e<hs;e++)this.rows[e].clear();this.currRow=hs-1}equals(e){let t=!0;for(let i=0;i<hs;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<hs;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<hs;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+ti(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<hs;a++)this.rows[a].clear();const s=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[s].cueStartTime,l=this.logger.time;if(a!==null&&l!==null&&a<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(o.rows[s+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const s=e.indent,o=Math.max(s-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+ti(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let s=0;s<hs;s++){const o=this.rows[s].getTextString();o&&(n=s+1,e?t.push("Row "+n+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class a1{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ff(i),this.nonDisplayedMemory=new Ff(i),this.lastOutputScreen=new Ff(i),this.currRollUpRow=this.displayedMemory.rows[hs-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[hs-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+ti(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class l1{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=c9(),this.logger=void 0;const n=this.logger=new r9;this.channels=[null,new a1(e,t,n),new a1(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,s=t[i+1]&127;let o=!1,a=null;if(n===0&&s===0)continue;this.logger.log(3,()=>"["+zr([t[i],t[i+1]])+"] -> ("+zr([n,s])+")");const l=this.cmdHistory;if(n>=16&&n<=31){if(l9(n,s,l)){Mc(null,null,l),this.logger.log(3,()=>"Repeated command ("+zr([n,s])+") is dropped");continue}Mc(n,s,this.cmdHistory),o=this.parseCmd(n,s),o||(o=this.parseMidrow(n,s)),o||(o=this.parsePAC(n,s)),o||(o=this.parseBackgroundAttributes(n,s))}else Mc(null,null,l);if(!o&&(a=this.parseChars(n,s),a)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+zr([n,s])+" orig: "+zr([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const s=e===20||e===21||e===23?1:2,o=this.channels[s];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=s,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+zr([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,s=(e===16||e===24)&&t>=64&&t<=95;if(!(n||s))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?e9[e]:i9[e]:i=o===1?t9[e]:n9[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,s=null;if(e>=25?(i=2,s=e-8):(i=1,s=e),s>=17&&s<=19){let o;s===17?o=t+80:s===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+g3(o)+"' in channel "+i),n=[o]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+zr(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let s;const o={};e===16||e===24?(s=Math.floor((t-32)/2),o.background=s9[s],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}Mc(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Mc(r,e,t){t.a=r,t.b=e}function l9(r,e,t){return t.a===r&&t.b===e}function c9(){return{a:null,b:null}}var Am=function(){if(Gu!=null&&Gu.VTTCue)return self.VTTCue;const r=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,l){if(typeof l!="string"||!Array.isArray(a))return!1;const c=l.toLowerCase();return~a.indexOf(c)?c:!1}function i(a){return t(r,a)}function n(a){return t(e,a)}function s(a,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const h in u)a[h]=u[h]}return a}function o(a,l,c){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",d=!1,m=a,A=l,p=c,y=null,E="",v=!0,x="auto",C="start",I=50,_="middle",S=50,b="middle";Object.defineProperty(u,"id",s({},h,{get:function(){return f},set:function(T){f=""+T}})),Object.defineProperty(u,"pauseOnExit",s({},h,{get:function(){return d},set:function(T){d=!!T}})),Object.defineProperty(u,"startTime",s({},h,{get:function(){return m},set:function(T){if(typeof T!="number")throw new TypeError("Start time must be set to a number.");m=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",s({},h,{get:function(){return A},set:function(T){if(typeof T!="number")throw new TypeError("End time must be set to a number.");A=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",s({},h,{get:function(){return p},set:function(T){p=""+T,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",s({},h,{get:function(){return y},set:function(T){y=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",s({},h,{get:function(){return E},set:function(T){const R=i(T);if(R===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",s({},h,{get:function(){return v},set:function(T){v=!!T,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",s({},h,{get:function(){return x},set:function(T){if(typeof T!="number"&&T!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");x=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",s({},h,{get:function(){return C},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");C=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",s({},h,{get:function(){return I},set:function(T){if(T<0||T>100)throw new Error("Position must be between 0 and 100.");I=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",s({},h,{get:function(){return _},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");_=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",s({},h,{get:function(){return S},set:function(T){if(T<0||T>100)throw new Error("Size must be between 0 and 100.");S=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",s({},h,{get:function(){return b},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");b=R,this.hasBeenReset=!0}})),u.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o}();class u9{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function v3(r){function e(i,n,s,o){return(i|0)*3600+(n|0)*60+(s|0)+parseFloat(o||0)}const t=r.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class h9{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function E3(r,e,t,i){const n=i?r.split(i):[r];for(const s in n){if(typeof n[s]!="string")continue;const o=n[s].split(t);if(o.length!==2)continue;const a=o[0],l=o[1];e(a,l)}}const h0=new Am(0,0,""),Lc=h0.align==="middle"?"middle":"center";function f9(r,e,t){const i=r;function n(){const a=v3(r);if(a===null)throw new Error("Malformed timestamp: "+i);return r=r.replace(/^[^\sa-zA-Z-]+/,""),a}function s(a,l){const c=new h9;E3(a,function(f,d){let m;switch(f){case"region":for(let A=t.length-1;A>=0;A--)if(t[A].id===d){c.set(f,t[A].region);break}break;case"vertical":c.alt(f,d,["rl","lr"]);break;case"line":m=d.split(","),c.integer(f,m[0]),c.percent(f,m[0])&&c.set("snapToLines",!1),c.alt(f,m[0],["auto"]),m.length===2&&c.alt("lineAlign",m[1],["start",Lc,"end"]);break;case"position":m=d.split(","),c.percent(f,m[0]),m.length===2&&c.alt("positionAlign",m[1],["start",Lc,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,d);break;case"align":c.alt(f,d,["start",Lc,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&h0.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",Lc);let h=c.get("position","auto");h==="auto"&&h0.position===50&&(h=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=h}function o(){r=r.replace(/^\s+/,"")}if(o(),e.startTime=n(),o(),r.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);r=r.slice(3),o(),e.endTime=n(),o(),s(r,e)}function x3(r){return r.replace(/<br(?: \/)?>/gi,`
`)}class d9{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new u9,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let s=t.buffer,o=0;for(s=x3(s);o<s.length&&s[o]!=="\r"&&s[o]!==`
`;)++o;const a=s.slice(0,o);return s[o]==="\r"&&++o,s[o]===`
`&&++o,t.buffer=s.slice(o),a}function n(s){E3(s,function(o,a){},/:/)}try{let s="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;s=i();const a=s.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:s=i(),t.state){case"HEADER":/:/.test(s)?n(s):s||(t.state="ID");continue;case"NOTE":s||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){t.state="NOTE";break}if(!s)continue;if(t.cue=new Am(0,0,""),t.state="CUE",s.indexOf("-->")===-1){t.cue.id=s;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{f9(s,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=s.indexOf("-->")!==-1;if(!s||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=s}continue;case"BADCUE":s||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const m9=/\r\n|\n\r|\n|\r/g,kf=function(e,t,i=0){return e.slice(i,i+t.length)===t},A9=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!ze(t)||!ze(i)||!ze(n)||!ze(s))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=60*60*1e3*s,t};function pm(r,e,t){return Sl(r.toString())+Sl(e.toString())+Sl(t)}const p9=function(e,t,i){let n=e[t],s=e[n.prevCC];if(!s||!s.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(o=s)!=null&&o.new;){var o;e.ccOffset+=n.start-s.start,n.new=!1,n=s,s=e[n.prevCC]}e.presentationOffset=i};function g9(r,e,t,i,n,s,o){const a=new d9,l=Ln(new Uint8Array(r)).trim().replace(m9,`
`).split(`
`),c=[],u=e?M8(e.baseTime,e.timescale):0;let h="00:00.000",f=0,d=0,m,A=!0;a.oncue=function(p){const y=t[i];let E=t.ccOffset;const v=(f-u)/9e4;if(y!=null&&y.new&&(d!==void 0?E=t.ccOffset=y.start:p9(t,i,v)),v){if(!e){m=new Error("Missing initPTS for VTT MPEGTS");return}E=v-t.presentationOffset}const x=p.endTime-p.startTime,C=Vn((p.startTime+E-d)*9e4,n*9e4)/9e4;p.startTime=Math.max(C,0),p.endTime=Math.max(C+x,0);const I=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(I)),p.id||(p.id=pm(p.startTime,p.endTime,I)),p.endTime>0&&c.push(p)},a.onparsingerror=function(p){m=p},a.onflush=function(){if(m){o(m);return}s(c)},l.forEach(p=>{if(A)if(kf(p,"X-TIMESTAMP-MAP=")){A=!1,p.slice(16).split(",").forEach(y=>{kf(y,"LOCAL:")?h=y.slice(6):kf(y,"MPEGTS:")&&(f=parseInt(y.slice(7)))});try{d=A9(h)/1e3}catch(y){m=y}return}else p===""&&(A=!1);a.parse(p+`
`)}),a.flush()}const Of="stpp.ttml.im1t",C3=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,I3=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,y9={left:"start",center:"center",right:"end",start:"start",end:"end"};function c1(r,e,t,i){const n=Et(new Uint8Array(r),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const s=n.map(a=>Ln(a)),o=D8(e.baseTime,1,e.timescale);try{s.forEach(a=>t(v9(a,o)))}catch(a){i(a)}}function v9(r,e){const n=new DOMParser().parseFromString(r,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(s).reduce((h,f)=>(h[f]=n.getAttribute(`ttp:${f}`)||s[f],h),{}),a=n.getAttribute("xml:space")!=="preserve",l=u1(Uf(n,"styling","style")),c=u1(Uf(n,"layout","region")),u=Uf(n,"body","[begin]");return[].map.call(u,h=>{const f=_3(h,a);if(!f||!h.hasAttribute("begin"))return null;const d=Gf(h.getAttribute("begin"),o),m=Gf(h.getAttribute("dur"),o);let A=Gf(h.getAttribute("end"),o);if(d===null)throw h1(h);if(A===null){if(m===null)throw h1(h);A=d+m}const p=new Am(d-e,A-e,f);p.id=pm(p.startTime,p.endTime,p.text);const y=c[h.getAttribute("region")],E=l[h.getAttribute("style")],v=E9(y,E,l),{textAlign:x}=v;if(x){const C=y9[x];C&&(p.lineAlign=C),p.align=x}return Vt(p,v),p}).filter(h=>h!==null)}function Uf(r,e,t){const i=r.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function u1(r){return r.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function _3(r,e){return[].slice.call(r.childNodes).reduce((t,i,n)=>{var s;return i.nodeName==="br"&&n?t+`
`:(s=i.childNodes)!=null&&s.length?_3(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function E9(r,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=r!=null&&r.hasAttribute("style")?r.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(n=t[o]),s.reduce((a,l)=>{const c=Nf(e,i,l)||Nf(r,i,l)||Nf(n,i,l);return c&&(a[l]=c),a},{})}function Nf(r,e,t){return r&&r.hasAttributeNS(e,t)?r.getAttributeNS(e,t):null}function h1(r){return new Error(`Could not parse ttml timestamp ${r}`)}function Gf(r,e){if(!r)return null;let t=v3(r);return t===null&&(C3.test(r)?t=x9(r,e):I3.test(r)&&(t=C9(r,e))),t}function x9(r,e){const t=C3.exec(r),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function C9(r,e){const t=I3.exec(r),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class Pc{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class S3{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=d1(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this),e.on(L.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(L.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(L.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this),e.off(L.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(L.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(L.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Pc(this,"textTrack1"),t=new Pc(this,"textTrack2"),i=new Pc(this,"textTrack3"),n=new Pc(this,"textTrack4");this.cea608Parser1=new l1(1,e,t),this.cea608Parser2=new l1(3,i,n)}addCues(e,t,i,n,s){let o=!1;for(let a=s.length;a--;){const l=s[a],c=I9(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),o=!0,c/(i-t)>.5))return}if(o||s.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,n)}else{const a=this.Cues.newCue(null,t,i,n);this.hls.trigger(L.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s,trackId:o}){const{unparsedVttFrags:a}=this;i===$e.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:s,trackId:o}),a.length&&(this.unparsedVttFrags=[],a.forEach(l=>{this.initPTS[l.frag.cc]?this.onFragLoaded(L.FRAG_LOADED,l):this.hls.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:l.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const s=i.textTracks[n];if(f1(s,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:s,languageCode:o}=t[e],a=this.getExistingTrack(s,o);if(a)i[e]=a,qo(i[e]),f3(i[e],n);else{const l=this.createTextTrack("captions",s,o);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(L.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(s=>{qo(n[s]),delete n[s]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=d1(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)qo(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(s=>s.textCodec===Of);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(WE(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?xu(o.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(a){let h=null;for(let f=0;f<a.length;f++)if(a[f]&&f1(a[f],l)){h=a[f],a[f]=null;break}h&&(u=h)}if(u)qo(u);else{const h=T3(l);u=this.createTextTrack(h,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),a!=null&&a.length){const l=a.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(L.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const s=`textTrack${n[1]}`,o=this.captionsProperties[s];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===$e.MAIN){var i,n;const{cea608Parser1:s,cea608Parser2:o,lastSn:a}=this,{cc:l,sn:c}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;s&&o&&(c!==a+1||c===a&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(s.reset(),o.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===$e.SUBTITLE)if(n.byteLength){const s=i.decryptdata,o="stats"in t;if(s==null||!s.encrypted||o){const a=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Of?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;c1(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:s,unparsedVttFrags:o}=this,a=s.length-1;if(!s[i.cc]&&a===-1){o.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?Jn(i.initSegment.data,new Uint8Array(n)).buffer:n;g9(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,n),l.logger.log(`Failed to parse VTT cue: ${u}`),!(h&&a>i.cc)&&l.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||c1(t,this.initPTS[e.cc],()=>{i.textCodec=Of,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(s=>d3(n,s))}else{const n=this.tracks[t];if(!n)return;const s=n.default?"default":"subtitles"+t;i.trigger(L.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===$e.SUBTITLE&&this.onFragLoaded(L.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===$e.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let s=0;s<n.length;s++){const o=n[s].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(n[s].pts,a[0]),this.cea608Parser2.addData(n[s].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:s}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!s||s==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(l=>u0(a[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(l=>u0(a[l],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let s=0;s<i;s++){const o=e[n++],a=127&e[n++],l=127&e[n++];if(a===0&&l===0)continue;if((4&o)!==0){const u=3&o;(u===0||u===1)&&(t[u].push(a),t[u].push(l))}}return t}}function T3(r){return r.characteristics&&/transcribes-spoken-dialog/gi.test(r.characteristics)&&/describes-music-and-sound/gi.test(r.characteristics)?"captions":"subtitles"}function f1(r,e){return!!r&&r.kind===T3(e)&&o0(e,r)}function I9(r,e,t,i){return Math.min(e,i)-Math.max(r,t)}function d1(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const _9=/\s/,b3={newCue(r,e,t,i){const n=[];let s,o,a,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(s=i.rows[f],a=!0,l=0,c="",!s.isEmpty()){var h;for(let A=0;A<s.chars.length;A++)_9.test(s.chars[A].uchar)&&a?l++:(c+=s.chars[A].uchar,a=!1);s.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const d=x3(c.trim()),m=pm(e,t,d);r!=null&&(h=r.cues)!=null&&h.getCueById(m)||(o=new u(e,t,d),o.id=m,o.line=f+1,o.align="left",o.position=10+Math.min(80,Math.floor(l*8/32)*10),n.push(o))}return r&&n.length&&(n.sort((f,d)=>f.line==="auto"||d.line==="auto"?0:f.line>8&&d.line>8?d.line-f.line:f.line-d.line),n.forEach(f=>d3(r,f))),n}};function w3(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const S9=/(\d+)-(\d+)\/(\d+)/;class f0{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||B9,this.controller=new self.AbortController,this.stats=new nh}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const s=T9(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=l&&ze(l)?l:c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},t.timeout),(Fl(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(h=>{var f;this.response=this.loader=h;const d=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},c-(d-n.loading.start)),!h.ok){const{status:A,statusText:p}=h;throw new R9(p||"fetch, bad network response",A,h)}n.loading.first=d,n.total=w9(h.headers)||n.total;const m=(f=this.callbacks)==null?void 0:f.onProgress;return m&&ze(t.highWaterMark)?this.loadProgressively(h,n,e,t.highWaterMark,m):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{var f,d;const m=this.response;if(!m)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const A=h[a];A&&(n.loaded=n.total=A);const p={url:m.url,data:h,code:m.status},y=(f=this.callbacks)==null?void 0:f.onProgress;y&&!ze(t.highWaterMark)&&y(n,e,h,m),(d=this.callbacks)==null||d.onSuccess(p,n,e,m)}).catch(h=>{var f;if(self.clearTimeout(this.requestTimeout),n.aborted)return;const d=h&&h.code||0,m=h?h.message:null;(f=this.callbacks)==null||f.onError({code:d,text:m},e,h?h.details:null,n)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,n=0,s){const o=new bE,a=e.body.getReader(),l=()=>a.read().then(c=>{if(c.done)return o.dataLength&&s(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const u=c.value,h=u.length;return t.loaded+=h,h<n||o.dataLength?(o.push(u),o.dataLength>=n&&s(t,i,o.flush().buffer,e)):s(t,i,u.buffer,e),l()}).catch(()=>Promise.reject());return l()}}function T9(r,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(Vt({},r.headers))};return r.rangeEnd&&t.headers.set("Range","bytes="+r.rangeStart+"-"+String(r.rangeEnd-1)),t}function b9(r){const e=S9.exec(r);if(e)return parseInt(e[2])-parseInt(e[1])+1}function w9(r){const e=r.get("Content-Range");if(e){const i=b9(e);if(ze(i))return i}const t=r.get("Content-Length");if(t)return parseInt(t)}function B9(r,e){return new self.Request(r.url,e)}class R9 extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const D9=/^age:\s*[\d.]+\s*$/im;class gm{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new nh,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return s(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),s(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:o}=i.loadPolicy;if(n)for(const a in n)e.setRequestHeader(a,n[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&ze(s)?s:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,s=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,u=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const m=u??t.response;if(m!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const A=t.responseType==="arraybuffer"?m.byteLength:m.length;i.loaded=i.total=A,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const p=(o=this.callbacks)==null?void 0:o.onProgress;p&&p(i,e,m,t);const y={url:t.responseURL,data:m,code:c};(a=this.callbacks)==null||a.onSuccess(y,i,e,t);return}}const h=s.loadPolicy.errorRetry,f=i.retry,d={url:e.url,data:void 0,code:c};if(Nu(h,f,!1,d))this.retry(h);else{var l;Gt.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Nu(e,t,!0))this.retry(e);else{var i;Gt.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=em(e,i.retry),i.retry++,Gt.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&D9.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const M9={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},L9=zt(zt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:gm,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:hE,bufferController:qE,capLevelController:ch,errorController:mE,fpsController:h3,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:rm,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:M9},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},P9()),{},{subtitleStreamController:p3,subtitleTrackController:m3,timelineController:S3,audioStreamController:YE,audioTrackController:jE,emeController:io,cmcdController:l3,contentSteeringController:c3,interstitialsController:qB});function P9(){return{cueHandler:b3,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function F9(r,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=d0(r),n=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return n.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,l=e[a]===void 0,c=[];s.forEach(u=>{const h=`${o}Loading${u}`,f=e[h];if(f!==void 0&&l){c.push(h);const d=i[a].default;switch(e[a]={default:d},u){case"TimeOut":d.maxLoadTimeMs=f,d.maxTimeToFirstByteMs=f;break;case"MaxRetry":d.errorRetry.maxNumRetry=f,d.timeoutRetry.maxNumRetry=f;break;case"RetryDelay":d.errorRetry.retryDelayMs=f,d.timeoutRetry.retryDelayMs=f;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=f,d.timeoutRetry.maxRetryDelayMs=f;break}}}),c.length&&t.warn(`hls.js config: "${c.join('", "')}" setting(s) are deprecated, use "${a}": ${ti(e[a])}`)}),zt(zt({},i),e)}function d0(r){return r&&typeof r=="object"?Array.isArray(r)?r.map(d0):Object.keys(r).reduce((e,t)=>(e[t]=d0(r[t]),e),{}):r}function k9(r,e){const t=r.loader;t!==f0&&t!==gm?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),r.progressive=!1):w3()&&(r.loader=f0,r.progressive=!0,r.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const Cu=2,O9=.1,U9=.05,N9=100;class G9 extends AE{constructor(e,t){super("gap-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(N9),this.mediaSource=t.mediaSource;const i=this.media=t.media;Rn(i,"playing",this.onMediaPlaying),Rn(i,"waiting",this.onMediaWaiting),Rn(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(jn(i,"playing",this.onMediaPlaying),jn(i,"waiting",this.onMediaWaiting),jn(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,n;const s=(i=this.hls)==null?void 0:i.config;if(!s)return;const o=this.media;if(!o)return;const{seeking:a}=o,l=this.seeking&&!a,c=!this.seeking&&a,u=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,s.nudgeOnVideoHole&&!u&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(c||l){l&&this.stallResolved(e);return}if(u){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!1}));return}if(!ft.getBuffered(o).length){this.nudgeRetry=0;return}const h=ft.bufferInfo(o,e,0),f=h.nextStart||0,d=this.fragmentTracker;if(a&&d&&this.hls){const I=m1(this.hls.inFlightFragments,e),_=h.len>Cu,S=!f||I||f-e>Cu&&!d.getPartialFragment(e);if(_||S)return;this.moved=!1}const m=(n=this.hls)==null?void 0:n.latestLevelDetails;if(!this.moved&&this.stalled!==null&&d){if(!(h.len>0)&&!f)return;const _=Math.max(f,h.start||0)-e,b=!!(m!=null&&m.live)?m.targetduration*2:Cu,T=Fc(e,d);if(_>0&&(_<=b||T)){o.paused||this._trySkipBufferHole(T);return}}const A=s.detectStallWithCurrentTimeMs,p=self.performance.now(),y=this.waiting;let E=this.stalled;if(E===null)if(y>0&&p-y<A)E=this.stalled=y;else{this.stalled=p;return}const v=p-E;if(!a&&(v>=A||y)&&this.hls){var x;if(((x=this.mediaSource)==null?void 0:x.readyState)==="ended"&&!(m!=null&&m.live)&&Math.abs(e-((m==null?void 0:m.edge)||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(h),!this.media||!this.hls)return}const C=ft.bufferInfo(o,e,s.maxBufferHole);this._tryFixBufferStall(C,v,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(L.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const n=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&n&&n.length>1&&e>n.end(0)){const s=ft.bufferedInfo(ft.timeRangesToArray(this.buffered.audio),e,0);if(s.len>1&&t>=s.start){const o=ft.timeRangesToArray(n),a=ft.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const l=ft.bufferedInfo(o,e,0).bufferedIndex,c=o[a].end,u=o[a+1].start;if((l===-1||l>a)&&u-c<1&&e-c<2){const h=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${c} -> ${u} buffered index: ${l}`);this.warn(h.message),this.media.currentTime+=1e-6;let f=Fc(e,this.fragmentTracker);f&&"fragment"in f?f=f.fragment:f||(f=void 0);const d=ft.bufferInfo(this.media,e,0);this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:f,buffer:d.len,bufferInfo:d})}}}}}_tryFixBufferStall(e,t,i){var n,s;const{fragmentTracker:o,media:a}=this,l=(n=this.hls)==null?void 0:n.config;if(!a||!o||!l)return;const c=(s=this.hls)==null?void 0:s.latestLevelDetails,u=Fc(i,o);if((u||c!=null&&c.live&&i<c.fragmentStart)&&(this._trySkipBufferHole(u)||!this.media))return;const h=e.buffered,f=this.adjacentTraversal(e,i);(h&&h.length>1&&e.len>l.maxBufferHole||e.nextStart&&(e.nextStart-i<l.maxBufferHole||f))&&(t>l.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,n=e.nextStart;if(i&&n){const s=i.getFragAtPos(t,$e.MAIN),o=i.getFragAtPos(n,$e.MAIN);if(s&&o)return o.sn-s.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:n,stalled:s}=this;if(!n&&s!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${ti(e)})`);this.warn(o.message),t.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:s}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:n}=this,s=(t=this.hls)==null?void 0:t.config;if(!n||!i||!s)return 0;const o=n.currentTime,a=ft.bufferInfo(n,o,0),l=o<a.start?a.start:a.nextStart;if(l&&this.hls){const u=a.len<=s.maxBufferHole,h=a.len>0&&a.len<1&&n.readyState<3,f=l-o;if(f>0&&(u||h)){if(f>s.maxBufferHole){let m=!1;if(o===0){const A=i.getAppendedFrag(0,$e.MAIN);A&&l<A.end&&(m=!0)}if(!m&&e){var c;if(!((c=this.hls.loadLevelObj)!=null&&c.details)||m1(this.hls.inFlightFragments,l))return 0;let p=!1,y=e.end;for(;y<l;){const E=Fc(y,i);if(E)y+=E.duration;else{p=!0;break}}if(p)return 0}}const d=Math.max(l+U9,o+O9);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${d}`),this.moved=!0,n.currentTime=d,!(e!=null&&e.gap)){const m=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${d}`),A={type:qe.MEDIA_ERROR,details:ue.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:m,reason:m.message,buffer:a.len,bufferInfo:a};e&&("fragment"in e?A.part=e:A.frag=e),this.hls.trigger(L.ERROR,A)}return d}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:n}=this,s=t==null?void 0:t.config;if(!i||!s)return 0;const o=i.currentTime;if(this.nudgeRetry++,n<s.nudgeMaxRetry){const a=o+(n+1)*s.nudgeOffset,l=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(l.message),i.currentTime=a,t.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_NUDGE_ON_STALL,error:l,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${s.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function m1(r,e){const t=A1(r.main);if(t&&t.start<=e)return t;const i=A1(r.audio);return i&&i.start<=e?i:null}function A1(r){if(!r)return null;switch(r.state){case be.IDLE:case be.STOPPED:case be.ENDED:case be.ERROR:return null}return r.frag}function Fc(r,e){return e.getAppendedFrag(r,$e.MAIN)||e.getPartialFragment(r)}const Q9=.25;function m0(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Qf(r,e,t,i,n){let s=new r(e,t,"");try{s.value=i,n&&(s.type=n)}catch{s=new r(e,t,ti(n?zt({type:n},i):i))}return s}const kc=(()=>{const r=m0();try{r&&new r(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class z9{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(L.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var e;const t=(e=this.hls)==null?void 0:e.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&qo(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return f3(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:i,enableID3MetadataCues:n}=this.hls.config;if(!i&&!n)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=m0();if(o)for(let a=0;a<s.length;a++){const l=s[a].type;if(l===pn.emsg&&!i||!n)continue;const c=PE(s[a].data),u=s[a].pts;let h=u+s[a].duration;h>kc&&(h=kc),h-u<=0&&(h=u+Q9);for(let d=0;d<c.length;d++){const m=c[d];if(!FE(m)){this.updateId3CueEnds(u,l);const A=Qf(o,u,h,m,l);A&&this.id3Track.addCue(A)}}}}updateId3CueEnds(e,t){var i;const n=(i=this.id3Track)==null?void 0:i.cues;if(n)for(let s=n.length;s--;){const o=n[s];o.type===t&&o.startTime<e&&o.endTime===kc&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:n}){const{id3Track:s,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:l}}=o;if(s&&(a||l)){let c;n==="audio"?c=u=>u.type===pn.audioId3&&l:n==="video"?c=u=>u.type===pn.emsg&&a:c=u=>u.type===pn.audioId3&&l||u.type===pn.emsg&&a,u0(s,t,i,c)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;const{assetPlayerId:i,timelineOffset:n,enableDateRangeMetadataCues:s,interstitialsController:o}=this.hls.config;if(!s)return;const a=m0();if(i&&n&&!o){const{fragmentStart:A,fragmentEnd:p}=e;let y=this.assetCue;y?(y.startTime=A,y.endTime=p):a&&(y=this.assetCue=Qf(a,A,p,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),y&&(y.id=i,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(y),y.addEventListener("enter",this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;const{id3Track:l}=this,{dateRanges:c}=e,u=Object.keys(c);let h=this.dateRangeCuesAppended;if(l&&t){var f;if((f=l.cues)!=null&&f.length){const A=Object.keys(h).filter(p=>!u.includes(p));for(let p=A.length;p--;){var d;const y=A[p],E=(d=h[y])==null?void 0:d.cues;delete h[y],E&&Object.keys(E).forEach(v=>{const x=E[v];if(x){x.removeEventListener("enter",this.onEventCueEnter);try{l.removeCue(x)}catch{}}})}}else h=this.dateRangeCuesAppended={}}const m=e.fragments[e.fragments.length-1];if(!(u.length===0||!ze(m==null?void 0:m.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let A=0;A<u.length;A++){const p=u[A],y=c[p],E=y.startTime,v=h[p],x=(v==null?void 0:v.cues)||{};let C=(v==null?void 0:v.durationKnown)||!1,I=kc;const{duration:_,endDate:S}=y;if(S&&_!==null)I=E+_,C=!0;else if(y.endOnNext&&!C){const T=u.reduce((R,w)=>{if(w!==y.id){const B=c[w];if(B.class===y.class&&B.startDate>y.startDate&&(!R||y.startDate<R.startDate))return B}return R},null);T&&(I=T.startTime,C=!0)}const b=Object.keys(y.attr);for(let T=0;T<b.length;T++){const R=b[T];if(!Ew(R))continue;const w=x[R];if(w)C&&!(v!=null&&v.durationKnown)?w.endTime=I:Math.abs(w.startTime-E)>.01&&(w.startTime=E,w.endTime=I);else if(a){let B=y.attr[R];xw(R)&&(B=Xv(B));const k=Qf(a,E,I,{key:R,data:B},pn.dateRange);k&&(k.id=p,this.id3Track.addCue(k),x[R]=k,o&&(R==="X-ASSET-LIST"||R==="X-ASSET-URL")&&k.addEventListener("enter",this.onEventCueEnter))}}h[p]={cues:x,dateRange:y,durationKnown:C}}}}}class H9{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const n=this.computeLatency();if(n===null)return;this._latency=n;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:o}=this.config;if(!s||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const l=n-a,c=Math.min(this.maxLatency,a+i.targetduration);if(l<c&&l>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,o)),f=Math.round(2/(1+Math.exp(-.75*l-this.edgeStalled))*20)/20,d=Math.min(h,Math.max(1,f));this.changeMediaPlaybackRate(t,d)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:n}=e,{liveSyncDuration:s,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,l=this.hls.userConfig;let c=a&&i||t;(this._targetLatencyUpdated||l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=s!==void 0?s:o*n);const u=n;return c+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,u)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const n=i.edge,s=e-t-this.edgeStalled,o=n-i.totalduration,a=n-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,s),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===ue.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,n;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(n=this.targetLatency)==null?void 0:n.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class V9 extends lh{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,n=[],s={},o={};let a=!1,l=!1,c=!1;t.levels.forEach(u=>{const h=u.attrs;let{audioCodec:f,videoCodec:d}=u;f&&(u.audioCodec=f=Fu(f,i)||void 0),d&&(d=u.videoCodec=Qb(d));const{width:m,height:A,unknownCodecs:p}=u;let y=p?p.length:0;if(p)for(let T=y;T--;){const R=p[T];this.isAudioSupported(R)?(u.audioCodec=f=f?`${f},${R}`:R,y--,ha.audio[f.substring(0,4)]=2):this.isVideoSupported(R)&&(u.videoCodec=d=d?`${d},${R}`:R,y--,ha.video[d.substring(0,4)]=2)}if(a||(a=!!(m&&A)),l||(l=!!d),c||(c=!!f),y||f&&!this.isAudioSupported(f)||d&&!this.isVideoSupported(d)){this.log(`Some or all CODECS not supported "${h.CODECS}"`);return}const{CODECS:E,"FRAME-RATE":v,"HDCP-LEVEL":x,"PATHWAY-ID":C,RESOLUTION:I,"VIDEO-RANGE":_}=h,b=`${`${C||"."}-`}${u.bitrate}-${I}-${v}-${E}-${_}-${x}`;if(s[b])if(s[b].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const T=o[b]+=1;u.attrs["PATHWAY-ID"]=new Array(T+1).join(".");const R=this.createLevel(u);s[b]=R,n.push(R)}else s[b].addGroupId("audio",h.AUDIO),s[b].addGroupId("text",h.SUBTITLES);else{const T=this.createLevel(u);s[b]=T,o[b]=1,n.push(T)}}),this.filterAndSortMediaOptions(n,t,a,l,c)}createLevel(e){const t=new fa(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const n=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(n.message),t.supportedResult=aE(n,[])}return t}isAudioSupported(e){return Xd(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Xd(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,n,s){let o=[],a=[],l=e;if((i||n)&&s&&(l=l.filter(({videoCodec:p,videoRange:y,width:E,height:v})=>(!!p||!!(E&&v))&&jb(y))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let p="no level with compatible codecs found in manifest",y=p;t.levels.length&&(y=`one or more CODECS in variant not supported: ${ti(t.levels.map(v=>v.attrs.CODECS).filter((v,x,C)=>C.indexOf(v)===x))}`,this.warn(y),p+=` (${y})`);const E=new Error(p);this.hls.trigger(L.ERROR,{type:qe.MEDIA_ERROR,details:ue.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:E,reason:y})}});return}t.audioTracks&&(o=t.audioTracks.filter(p=>!p.audioCodec||this.isAudioSupported(p.audioCodec)),p1(o)),t.subtitles&&(a=t.subtitles,p1(a));const c=l.slice(0);l.sort((p,y)=>{if(p.attrs["HDCP-LEVEL"]!==y.attrs["HDCP-LEVEL"])return(p.attrs["HDCP-LEVEL"]||"")>(y.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&p.height!==y.height)return p.height-y.height;if(p.frameRate!==y.frameRate)return p.frameRate-y.frameRate;if(p.videoRange!==y.videoRange)return ku.indexOf(p.videoRange)-ku.indexOf(y.videoRange);if(p.videoCodec!==y.videoCodec){const E=dg(p.videoCodec),v=dg(y.videoCodec);if(E!==v)return v-E}if(p.uri===y.uri&&p.codecSet!==y.codecSet){const E=Pu(p.codecSet),v=Pu(y.codecSet);if(E!==v)return v-E}return p.averageBitrate!==y.averageBitrate?p.averageBitrate-y.averageBitrate:0});let u=c[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==c.length)){for(let p=0;p<c.length;p++)if(c[p].pathwayId===l[0].pathwayId){u=c[p];break}}this._levels=l;for(let p=0;p<l.length;p++)if(l[p]===u){var h;this._firstLevel=p;const y=u.bitrate,E=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${y}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){const v=Math.min(y,this.hls.config.abrEwmaDefaultEstimateMax);v>E&&E===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=v)}break}const f=s&&!n,d=this.hls.config,m=!!(d.audioStreamController&&d.audioTrackController),A={levels:l,audioTracks:o,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:s,video:n,altAudio:m&&!f&&o.some(p=>!!p.url)};this.hls.trigger(L.MANIFEST_PARSED,A)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,n=this.currentLevel,s=n?n.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&n&&s===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${s?" with Pathway "+s:""}`);const l={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(L.LEVEL_SWITCHING,l);const c=o.details;if(!c||c.live){const u=this.switchParams(o.uri,n==null?void 0:n.details,c);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(n=>t.indexOf(n)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===xt.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===$e.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(s=>!!i[s]))return;const n=this._levels[t.level];n!=null&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var i;const{level:n,details:s}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${n}`),(a=t.deliveryDirectives)!=null&&a.skip&&(s.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let l=o.details;l===t.details&&l.advanced&&(l=void 0),this.playlistLoaded(n,t,l)}else(i=t.deliveryDirectives)!=null&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),n=this.currentLevelIndex,s=e.attrs["PATHWAY-ID"],o=e.details,a=o==null?void 0:o.age;this.log(`Loading level index ${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${s?" Pathway "+s:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(L.LEVEL_LOADING,{url:i,level:n,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((s,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));_E(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const n=i.length-1;this._firstLevel=Math.min(this._firstLevel,n),this._startLevel&&(this._startLevel=Math.min(this._startLevel,n)),this.hls.trigger(L.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(L.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function p1(r){const e={};r.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function B3(){return self.SourceBuffer||self.WebKitSourceBuffer}function ym(){if(!sr())return!1;const e=B3();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function R3(){if(!ym())return!1;const r=sr();return typeof(r==null?void 0:r.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>r.isTypeSupported(Dl(e,"video")))||["mp4a.40.2","fLaC"].some(e=>r.isTypeSupported(Dl(e,"audio"))))}function K9(){var r;const e=B3();return typeof(e==null||(r=e.prototype)==null?void 0:r.changeType)=="function"}const $9=100;class Y9 extends oh{constructor(e,t,i){super(e,t,i,"stream-controller",$e.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const n=this.media,s=n?n.currentTime:null;if(s===null||!ze(s)||(this.log(`Media seeked to ${s.toFixed(3)}`),!this.getBufferedFrag(s)))return;const o=this.getFwdBufferInfoAtPos(n,s,$e.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${s} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:n}=this;if(this.stopLoad(),this.setInterval($9),this.level=-1,!this.startFragRequested){let s=n.startLevel;s===-1&&(n.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=n.firstAutoLevel),n.nextLoadLevel=s,this.level=n.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=be.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=be.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case be.WAITING_LEVEL:{const{levels:t,level:i}=this,n=t==null?void 0:t[i],s=n==null?void 0:n.details;if(s&&(!s.live||this.levelLastLoaded===n&&!this.waitForLive(n))){if(this.waitForCdnTuneIn(s))break;this.state=be.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=be.IDLE;break}break}case be.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,level:s}=this,o=n==null?void 0:n[s];this.resetStartWhenNotLoaded(o||null),this.state=be.IDLE}}break}this.state===be.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:n}=this;if(t===null||!n&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const s=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[s]))return;const o=i[s],a=this.getMainFwdBufferInfo();if(a===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(a,l)){const A={};this.altAudio===2&&(A.type="video"),this.hls.trigger(L.BUFFER_EOS,A),this.state=be.ENDED;return}if(!this.buffering)return;e.loadLevel!==s&&e.manualLevel===-1&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=e.nextLoadLevel=s;const c=o.details;if(!c||this.state===be.WAITING_LEVEL||this.waitForLive(o)){this.level=s,this.state=be.WAITING_LEVEL,this.startFragRequested=!1;return}const u=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(f,c);if(this.couldBacktrack&&!this.fragPrevious&&d&&bi(d)&&this.fragmentTracker.getState(d)!==Fi.OK){var m;const p=((m=this.backtrackFragment)!=null?m:d).sn-c.startSN,y=c.fragments[p-1];y&&d.cc===y.cc&&(d=y,this.fragmentTracker.removeFragment(y))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,f)){if(!d.gap){const p=this.audioOnly&&!this.altAudio?$t.AUDIO:$t.VIDEO,y=(p===$t.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;y&&this.afterBufferFlushed(y,p,$e.MAIN)}d=this.getNextFragmentLoopLoading(d,c,a,$e.MAIN,h)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,o,f))}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);n===Fi.NOT_LOADED||n===Fi.PARTIAL?bi(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,$e.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);const s=this.getLevelDetails();if(s!=null&&s.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<s.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,l=e[a],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const l=a.maxStartPTS?a.maxStartPTS:a.start,c=a.duration,u=Math.max(o.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case be.KEY_LOADING:case be.FRAG_LOADING:case be.FRAG_LOADING_WAITING_RETRY:case be.PARSING:case be.PARSED:this.state=be.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;Rn(i,"playing",this.onMediaPlaying),Rn(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(jn(i,"playing",this.onMediaPlaying),jn(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(L.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,n=!1;for(let s=0;s<t.levels.length;s++){const o=t.levels[s].audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,n=n||o.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=i&&n&&!K9(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==be.IDLE)return;const n=t.levelInfo;(!n.details||n.details.live&&(this.levelLastLoaded!==n||n.details.expired)||this.waitForCdnTuneIn(n.details))&&(this.state=be.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:n,startFragRequested:s}=this,o=t.level,a=t.details,l=a.totalduration;if(!n){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${l}`);const c=t.levelInfo,u=this.fragCurrent;u&&(this.state===be.FRAG_LOADING||this.state===be.FRAG_LOADING_WAITING_RETRY)&&u.level!==t.level&&u.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=c.details)!=null&&i.live){var f;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,c.details,(f=this.levelLastLoaded)==null?void 0:f.details)}if(c.details=a,this.levelLastLoaded=c,s||this.setStartPosition(a,h),this.hls.trigger(L.LEVEL_UPDATED,{details:a,level:o}),this.state===be.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=be.IDLE}s&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const n=this.hls.liveSyncPosition,s=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,l=s>=o-t.maxFragLookUpTolerance&&s<=a;if(n!==null&&i.duration>n&&(s<n||!l)){const u=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!l&&i.readyState<4||s<a-u)&&(this._hasEnoughToStart||(this.nextLoadPosition=n),i.readyState))if(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${n.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var c;const h=ft.bufferInfo(i,n,0);if(!((c=h.buffered)!=null&&c.length)){i.currentTime=n;return}if(h.start<=s){i.currentTime=n;return}const{nextStart:d}=ft.bufferedInfo(h.buffered,s,0);d&&(i.currentTime=d)}else i.currentTime=n}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const l=a.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=a.videoCodec,u=l.PTSKnown||!l.live,h=(t=i.initSegment)==null?void 0:t.data,f=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new $E(this.hls,$e.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=n?n.index:-1,A=m!==-1,p=new rh(i.level,i.sn,i.stats.chunkCount,s.byteLength,m,A),y=this.initPTS[i.cc];d.push(s,h,f,c,i,n,l.totalduration,u,p,y)}onAudioTrackSwitching(e,t){const i=this.hls,n=this.altAudio===2;if(Ou(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(n){this.fragmentTracker.removeAllFragments(),i.once(L.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(L.AUDIO_TRACK_SWITCHED,t)}),i.trigger(L.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(L.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=Ou(t.url,this.hls);if(i){const n=this.videoBuffer;n&&this.mediaBuffer!==n&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=n)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let n,s,o=!1;for(const a in i){const l=i[a];if(l.id==="main"){if(s=a,n=l,a==="video"){const c=i[a];c&&(this.videoBuffer=c.buffer)}}else o=!0}o&&n?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=n.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:n}=t,s=i.type===$e.MAIN;if(s){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===be.PARSED&&(this.state=be.IDLE);return}const a=n?n.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),bi(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,n)}const o=this.media;o&&(!this._hasEnoughToStart&&ft.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),s&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=be.ERROR;return}switch(t.details){case ue.FRAG_GAP:case ue.FRAG_PARSING_ERROR:case ue.FRAG_DECRYPT_ERROR:case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError($e.MAIN,t);break;case ue.LEVEL_LOAD_ERROR:case ue.LEVEL_LOAD_TIMEOUT:case ue.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===be.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===xt.LEVEL&&(this.state=be.IDLE);break;case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case ue.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case ue.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=be.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==$t.AUDIO||!this.altAudio){const i=(t===$t.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,$e.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const n=this.timelineOffset;n&&i&&(i+=n);const s=this.getLevelDetails(),o=ft.getBuffered(e),a=o.length?o.start(0):0,l=a-i,c=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||l>0&&(l<c||this.loadingParts&&l<2*((s==null?void 0:s.partTarget)||0)))&&(this.log(`adjusting start position by ${l} to match buffer start`),i+=l,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:n}=this,s=i==null?void 0:i.frag;if(!s||this.fragContextChanged(s))return;t.fragmentError=0,this.state=be.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=s.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),n.trigger(L.FRAG_LOADED,i),s.bitrateTest=!1})}_handleTransmuxComplete(e){const t=this.playlistType,{hls:i}=this,{remuxResult:n,chunkMeta:s}=e,o=this.getCurrentContext(s);if(!o){this.resetWhenMissingContext(s);return}const{frag:a,part:l,level:c}=o,{video:u,text:h,id3:f,initSegment:d}=n,{details:m}=c,A=this.altAudio?void 0:n.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=be.PARSING,d){const p=d.tracks;if(p){const x=a.initSegment||a;if(this.unhandledEncryptionError(d,a))return;this._bufferInitSegment(c,p,x,s),i.trigger(L.FRAG_PARSING_INIT_SEGMENT,{frag:x,id:t,tracks:p})}const y=d.initPTS,E=d.timescale,v=this.initPTS[a.cc];if(ze(y)&&(!v||v.baseTime!==y||v.timescale!==E)){const x=d.trackId;this.initPTS[a.cc]={baseTime:y,timescale:E,trackId:x},i.trigger(L.INIT_PTS_FOUND,{frag:a,id:t,initPTS:y,timescale:E,trackId:x})}}if(u&&m){A&&u.type==="audiovideo"&&this.logMuxedErr(a);const p=m.fragments[a.sn-1-m.startSN],y=a.sn===m.startSN,E=!p||a.cc>p.cc;if(n.independent!==!1){const{startPTS:v,endPTS:x,startDTS:C,endDTS:I}=u;if(l)l.elementaryStreams[u.type]={startPTS:v,endPTS:x,startDTS:C,endDTS:I};else if(u.firstKeyFrame&&u.independent&&s.id===1&&!E&&(this.couldBacktrack=!0),u.dropped&&u.independent){const _=this.getMainFwdBufferInfo(),S=(_?_.end:this.getLoadPosition())+this.config.maxBufferHole,b=u.firstKeyFramePTS?u.firstKeyFramePTS:v;if(!y&&S<b-this.config.maxBufferHole&&!E){this.backtrack(a);return}else E&&(a.gap=!0);a.setElementaryStreamInfo(u.type,a.start,x,a.start,I,!0)}else y&&v-(m.appliedTimelineOffset||0)>Cu&&(a.gap=!0);a.setElementaryStreamInfo(u.type,v,x,C,I),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(u,a,l,s,y||E)}else if(y||E)a.gap=!0;else{this.backtrack(a);return}}if(A){const{startPTS:p,endPTS:y,startDTS:E,endDTS:v}=A;l&&(l.elementaryStreams[$t.AUDIO]={startPTS:p,endPTS:y,startDTS:E,endDTS:v}),a.setElementaryStreamInfo($t.AUDIO,p,y,E,v),this.bufferFragmentData(A,a,l,s)}if(m&&f!=null&&f.samples.length){const p={id:t,frag:a,details:m,samples:f.samples};i.trigger(L.FRAG_PARSING_METADATA,p)}if(m&&h){const p={id:t,frag:a,details:m,samples:h.samples};i.trigger(L.FRAG_PARSING_USERDATA,p)}}logMuxedErr(e){this.warn(`${bi(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,n){if(this.state!==be.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:s,video:o,audiovideo:a}=t;if(s){const c=e.audioCodec;let u=pu(s.codec,c);u==="mp4a"&&(u="mp4a.40.5");const h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){u&&(u.indexOf("mp4a.40.5")!==-1?u="mp4a.40.2":u="mp4a.40.5");const f=s.metadata;f&&"channelCount"in f&&(f.channelCount||1)!==1&&h.indexOf("firefox")===-1&&(u="mp4a.40.5")}u&&u.indexOf("mp4a.40.5")!==-1&&h.indexOf("android")!==-1&&s.container!=="audio/mpeg"&&(u="mp4a.40.2",this.log(`Android: force audio codec to ${u}`)),c&&c!==u&&this.log(`Swapping manifest audio codec "${c}" for "${u}"`),s.levelCodec=u,s.id=$e.MAIN,this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${u||""}/${c||""}/${s.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=$e.MAIN;const c=o.codec;if((c==null?void 0:c.length)===4)switch(c){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${c}]${o.codec!==c?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const l=Object.keys(t);if(l.length){if(this.hls.trigger(L.BUFFER_CODECS,t),!this.hls)return;l.forEach(c=>{const h=t[c].initSegment;h!=null&&h.byteLength&&this.hls.trigger(L.BUFFER_APPENDING,{type:c,data:h,frag:i,part:null,chunkMeta:n,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,$e.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e==null?void 0:e[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=be.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(ft.isBuffered(e,i)?t=this.getAppendedFrag(i):ft.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const n=this.fragPlaying,s=t.level;(!n||t.sn!==n.sn||n.level!==s)&&(this.fragPlaying=t,this.hls.trigger(L.FRAG_CHANGED,{frag:t}),(!n||n.level!==s)&&this.hls.trigger(L.LEVEL_SWITCHED,{level:s}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return ze(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(ze(t)){const i=this.getLevelDetails(),n=this.currentFrag||(i?no(null,i.fragments,t):null);if(n){const s=n.programDateTime;if(s!==null){const o=s+(t-n.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class W9{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const n=this.keyUriToKeyInfo[i].loader;if(n){var t;if(e&&e!==((t=n.context)==null?void 0:t.frag.type))return;n.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=ue.KEY_LOAD_ERROR,i,n,s){return new qs({type:qe.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:i,networkDetails:n})}loadClear(e,t,i){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let n=0,s=t.length;n<s;n++){const o=t[n];if(e.cc<=o.cc&&(!bi(e)||!bi(o)||e.sn<o.sn)||!i&&n==s-1)return this.emeController.selectKeySystemFormat(o).then(a=>{if(!this.emeController)return;o.setKeyFormat(a);const l=gu(a);if(l)return this.emeController.getKeySystemAccess([l])})}if(this.config.requireKeySystemAccessOnStart){const n=ml(this.config);if(n.length)return this.emeController.getKeySystemAccess(n)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,n;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const c=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,c))}const o=s.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));let a=this.keyUriToKeyInfo[o];if((i=a)!=null&&i.decryptdata.key)return s.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});if((n=a)!=null&&n.keyLoadPromise){var l;switch((l=a.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(c=>(s.key=c.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}}switch(a=this.keyUriToKeyInfo[o]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return s.keyFormat==="identity"?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const n=this.emeController.loadKey(i);if(n)return(e.keyLoadPromise=n.then(s=>(e.mediaKeySessionContext=s,i))).catch(s=>{throw e.keyLoadPromise=null,s})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,n=i.loader,s=new n(i);return t.keyLoader=e.loader=s,e.keyLoadPromise=new Promise((o,a)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},c=i.keyLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const{frag:p,keyInfo:y,url:E}=m;if(!p.decryptdata||y!==this.keyUriToKeyInfo[E])return a(this.createKeyLoadError(p,ue.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),A));y.decryptdata.key=p.decryptdata.key=new Uint8Array(f.data),p.keyLoader=null,y.loader=null,o({frag:p,keyInfo:y})},onError:(f,d,m,A)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),m,zt({url:l.url,data:void 0},f)))},onTimeout:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),m))},onAbort:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.INTERNAL_ABORTED,new Error("key loading aborted"),m))}};s.load(l,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:n}=e,s=i.loader;t.keyLoader===s&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[n],s&&s.destroy()}}function g1(r){const{type:e}=r;switch(e){case xt.AUDIO_TRACK:return $e.AUDIO;case xt.SUBTITLE_TRACK:return $e.SUBTITLE;default:return $e.MAIN}}function zf(r,e){let t=r.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class j9{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(L.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(L.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,n=t.loader,s=i||n,o=new s(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:xt.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:n,pathwayId:s,url:o,deliveryDirectives:a,levelInfo:l}=t;this.load({id:i,level:n,pathwayId:s,responseType:"text",type:xt.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:l})}onAudioTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:xt.AUDIO_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:xt.SUBTITLE_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[xt.LEVEL];if(i){const n=i.context;n&&!t.levels.some(s=>s===n.levelOrTrack)&&(i.abort(),delete this.loaders[xt.LEVEL])}}load(e){var t;const i=this.hls.config;let n=this.getInternalLoader(e);if(n){const c=this.hls.logger,u=n.context;if(u&&u.levelOrTrack===e.levelOrTrack&&(u.url===e.url||u.deliveryDirectives&&!e.deliveryDirectives)){u.url===e.url?c.log(`[playlist-loader]: ignore ${e.url} ongoing request`):c.log(`[playlist-loader]: ignore ${e.url} in favor of ${u.url}`);return}c.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}let s;if(e.type===xt.MANIFEST?s=i.manifestLoadPolicy.default:s=Vt({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),ze((t=e.deliveryDirectives)==null?void 0:t.part)){let c;if(e.type===xt.LEVEL&&e.level!==null?c=this.hls.levels[e.level].details:e.type===xt.AUDIO_TRACK&&e.id!==null?c=this.hls.audioTracks[e.id].details:e.type===xt.SUBTITLE_TRACK&&e.id!==null&&(c=this.hls.subtitleTracks[e.id].details),c){const u=c.partTarget,h=c.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;s=Vt({},s,{maxTimeToFirstByteMs:Math.min(f,s.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,s.maxTimeToFirstByteMs)})}}}const o=s.errorRetry||s.timeoutRetry||{},a={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},l={onSuccess:(c,u,h,f)=>{const d=this.getInternalLoader(h);this.resetInternalLoader(h.type);const m=c.data;if(m.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(c,h,new Error("no EXTM3U delimiter"),f||null,u);return}u.parsing.start=performance.now(),ms.isMediaPlaylist(m)||h.type!==xt.MANIFEST?this.handleTrackOrLevelPlaylist(c,u,h,f||null,d):this.handleMasterPlaylist(c,u,h,f)},onError:(c,u,h,f)=>{this.handleNetworkError(u,h,!1,c,f)},onTimeout:(c,u,h)=>{this.handleNetworkError(u,h,!0,void 0,c)}};n.load(e,a,l)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,n){const s=this.hls,o=e.data,a=zf(e,i),l=ms.parseMasterPlaylist(o,a);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,n,t);return}const{contentSteering:c,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m}=l;this.variableList=m;const{AUDIO:A=[],SUBTITLES:p,"CLOSED-CAPTIONS":y}=ms.parseMasterPlaylistMedia(o,a,l);A.length&&!A.some(v=>!v.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),A.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ri({}),bitrate:0,url:""})),s.trigger(L.MANIFEST_LOADED,{levels:u,audioTracks:A,subtitles:p,captions:y,contentSteering:c,url:a,stats:t,networkDetails:n,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,n,s){const o=this.hls,{id:a,level:l,type:c}=i,u=zf(e,i),h=ze(l)?l:ze(a)?a:0,f=g1(i),d=ms.parseLevelPlaylist(e.data,u,h,f,0,this.variableList);if(c===xt.MANIFEST){const m={attrs:new ri({}),bitrate:0,details:d,name:"",url:u};d.requestScheduled=t.loading.start+xE(d,0),o.trigger(L.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=d,this.handlePlaylistLoaded(d,e,t,i,n,s)}handleManifestParsingError(e,t,i,n,s){this.hls.trigger(L.ERROR,{type:qe.NETWORK_ERROR,details:ue.MANIFEST_PARSING_ERROR,fatal:t.type===xt.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:n,stats:s})}handleNetworkError(e,t,i=!1,n,s){let o=`A network ${i?"timeout":"error"+(n?" (status "+n.code+")":"")} occurred while loading ${e.type}`;e.type===xt.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===xt.AUDIO_TRACK||e.type===xt.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let l=ue.UNKNOWN,c=!1;const u=this.getInternalLoader(e);switch(e.type){case xt.MANIFEST:l=i?ue.MANIFEST_LOAD_TIMEOUT:ue.MANIFEST_LOAD_ERROR,c=!0;break;case xt.LEVEL:l=i?ue.LEVEL_LOAD_TIMEOUT:ue.LEVEL_LOAD_ERROR,c=!1;break;case xt.AUDIO_TRACK:l=i?ue.AUDIO_TRACK_LOAD_TIMEOUT:ue.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case xt.SUBTITLE_TRACK:l=i?ue.SUBTITLE_TRACK_LOAD_TIMEOUT:ue.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(e.type);const h={type:qe.NETWORK_ERROR,details:l,fatal:c,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:s};if(n){const f=(t==null?void 0:t.url)||e.url;h.response=zt({url:f,data:void 0},n)}this.hls.trigger(L.ERROR,h)}handlePlaylistLoaded(e,t,i,n,s,o){const a=this.hls,{type:l,level:c,id:u,groupId:h,deliveryDirectives:f}=n,d=zf(t,n),m=g1(n),A=typeof n.level=="number"&&m===$e.MAIN?c:void 0;if(!e.fragments.length){const y=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(L.ERROR,{type:qe.NETWORK_ERROR,details:ue.LEVEL_EMPTY_ERROR,fatal:!1,url:d,error:y,reason:y.message,response:t,context:n,level:A,parent:m,networkDetails:s,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const p=e.playlistParsingError;if(p){if(this.hls.logger.warn(`${p} ${e.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(L.ERROR,{type:qe.NETWORK_ERROR,details:ue.LEVEL_PARSING_ERROR,fatal:!1,url:d,error:p,reason:p.message,response:t,context:n,level:A,parent:m,networkDetails:s,stats:i});return}e.playlistParsingError=null}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case xt.MANIFEST:case xt.LEVEL:a.trigger(L.LEVEL_LOADED,{details:e,levelInfo:n.levelOrTrack||a.levels[0],level:A||0,id:u||0,stats:i,networkDetails:s,deliveryDirectives:f,withoutMultiVariant:l===xt.MANIFEST});break;case xt.AUDIO_TRACK:a.trigger(L.AUDIO_TRACK_LOADED,{details:e,track:n.levelOrTrack,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break;case xt.SUBTITLE_TRACK:a.trigger(L.SUBTITLE_TRACK_LOADED,{details:e,track:n.levelOrTrack,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break}}}class er{static get version(){return Ll}static isMSESupported(){return ym()}static isSupported(){return R3()}static getMediaSource(){return sr()}static get Events(){return L}static get MetadataSchema(){return pn}static get ErrorTypes(){return qe}static get ErrorDetails(){return ue}static get DefaultConfig(){return er.defaultConfig?er.defaultConfig:L9}static set DefaultConfig(e){er.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new om,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=xb(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=F9(er.DefaultConfig,e,t);this.userConfig=e,i.progressive&&k9(i,t);const{abrController:n,bufferController:s,capLevelController:o,errorController:a,fpsController:l}=i,c=new a(this),u=this.abrController=new n(this),h=new lw(this),f=i.interstitialsController,d=f?this.interstitialsController=new f(this,er):null,m=this.bufferController=new s(this,h),A=this.capLevelController=new o(this),p=new l(this),y=new j9(this),E=i.contentSteeringController,v=E?new E(this):null,x=this.levelController=new V9(this,v),C=new z9(this),I=new W9(this.config),_=this.streamController=new Y9(this,h,I),S=this.gapController=new G9(this,h);A.setStreamController(_),p.setStreamController(_);const b=[y,x,_];d&&b.splice(1,0,d),v&&b.splice(1,0,v),this.networkControllers=b;const T=[u,m,S,A,p,C,h];this.audioTrackController=this.createController(i.audioTrackController,b);const R=i.audioStreamController;R&&b.push(this.audioStreamController=new R(this,h,I)),this.subtitleTrackController=this.createController(i.subtitleTrackController,b);const w=i.subtitleStreamController;w&&b.push(this.subtititleStreamController=new w(this,h,I)),this.createController(i.timelineController,T),I.emeController=this.emeController=this.createController(i.emeController,T),this.cmcdController=this.createController(i.cmcdController,T),this.latencyController=this.createController(H9,T),this.coreComponents=T,b.push(c);const B=c.onErrorOut;typeof B=="function"&&this.on(L.ERROR,B,c),this.on(L.MANIFEST_LOADED,y.onManifestLoaded,y)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,n){this._emitter.off(e,t,i,n)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const n=e===L.ERROR;this.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,fatal:n,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(L.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const s=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(L.ERROR,{type:qe.OTHER_ERROR,details:ue.ATTACH_MEDIA_ERROR,fatal:!0,error:s});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,n=t?e:{media:i};this._media=i,this.trigger(L.MEDIA_ATTACHING,n)}detachMedia(){this.logger.log("detachMedia"),this.trigger(L.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(L.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,n=this._url=j0.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${n}`),t&&i&&(i!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(L.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[$e.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[$e.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[$e.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e==null?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=VB()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Wb(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let n=0;n<i;n++)if(e[n].maxBitrate>=t)return n;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let n;if(t===-1&&e!=null&&e.length?n=e.length-1:n=t,i)for(let s=n;s--;){const o=e[s].attrs["HDCP-LEVEL"];if(o&&o<=i)return s}return n}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=uE(t);return lE(e,i,navigator.mediaCapabilities)}}er.defaultConfig=void 0;const X9=Object.freeze(Object.defineProperty({__proto__:null,AbrController:hE,AttrList:ri,AudioStreamController:YE,AudioTrackController:jE,BasePlaylistController:lh,BaseSegment:X0,BaseStreamController:oh,BufferController:qE,CMCDController:l3,CapLevelController:ch,ChunkMetadata:rh,ContentSteeringController:c3,Cues:b3,DateRange:im,EMEController:io,ErrorActionFlags:Hn,ErrorController:mE,ErrorDetails:ue,ErrorTypes:qe,Events:L,FPSController:h3,FetchLoader:f0,Fragment:Au,Hls:er,HlsSkip:Cl,HlsUrlParameters:Zd,KeySystemFormats:sn,KeySystems:hi,Level:fa,LevelDetails:gE,LevelKey:Vl,LoadStats:nh,M3U8Parser:ms,MetadataSchema:pn,NetworkErrorAction:zi,Part:qv,PlaylistLevelType:$e,SubtitleStreamController:p3,SubtitleTrackController:m3,TimelineController:S3,XhrLoader:gm,default:er,fetchSupported:w3,getMediaSource:sr,isMSESupported:ym,isSupported:R3,requestMediaKeySystemAccess:rm},Symbol.toStringTag,{value:"Module"})),q9=((r,e)=>typeof window<"u"&&typeof((r=window.document)==null?void 0:r.createElement)=="function"&&typeof((e=window.navigator)==null?void 0:e.userAgent)=="string")();let Hf=null;async function J9(...r){var e;(e=Hf)!==null&&e!==void 0||(Hf=await Gy(()=>Promise.resolve().then(()=>X9),void 0));const t=Hf.default;return t.isSupported()?new t(...r):null}function Z9(r,{unsuspend:e="loadedmetadata",start:t=!0,hls:i={},crossOrigin:n="anonymous",muted:s=!0,loop:o=!0,playsInline:a=!0,onVideoFrame:l,...c}={}){const u=le(m=>m.gl),h=g.useRef(null),f=ar(()=>new Promise(async m=>{let A,p;typeof r=="string"?A=r:p=r;const y=Object.assign(document.createElement("video"),{src:A,srcObject:p,crossOrigin:n,loop:o,muted:s,playsInline:a,...c});if(A&&q9&&A.endsWith(".m3u8")){const v=h.current=await J9(i);v&&(v.on(L.MEDIA_ATTACHED,()=>void v.loadSource(A)),v.attachMedia(y))}const E=new hC(y);E.colorSpace=u.outputColorSpace,y.addEventListener(e,()=>m(E))}),[r]),d=f.source.data;return eR(d,l),g.useEffect(()=>(t&&f.image.play(),()=>{h.current&&(h.current.destroy(),h.current=null)}),[f,t]),f}const vm=g.forwardRef(({children:r,src:e,...t},i)=>{const n=Z9(e,t);return g.useEffect(()=>()=>void n.dispose(),[n]),g.useImperativeHandle(i,()=>n,[n]),g.createElement(g.Fragment,null,r==null?void 0:r(n))}),eR=(r,e)=>{g.useEffect(()=>{if(!e||!r.requestVideoFrameCallback)return;let t;const i=(...n)=>{e(...n),t=r.requestVideoFrameCallback(i)};return r.requestVideoFrameCallback(i),()=>r.cancelVideoFrameCallback(t)},[r,e])},Iu=(r,e)=>{if(Array.isArray(r))return r[0];{const t=e??Object.keys(r)[0];return r[t][0]}},tR=r=>{for(let e=3;e<r.length;e+=4)if(r[e]!==0)return!1;return!0};function Em(r,e,t,i,n,s){const o=g.useRef(le(w=>w.viewport)),a=g.useRef(null),l=g.useRef(0),c=.1,u=g.useRef(r),h=g.useRef(e),f=g.useRef(t),[d,m]=g.useState(null),[A,p]=g.useState(new qi),y=g.useMemo(()=>new nr,[]),[E,v]=g.useState(null),x=g.useCallback((w,B,D)=>{const k=B*(o.current.aspect>w/B?o.current.width/w:o.current.height/B),Y=w*(o.current.aspect>w/B?o.current.width/w:o.current.height/B)*D,W=k*D,P=1;let K=Math.min(P,Y),M=Math.min(P,W);return Y>P&&(K=P,M=W/Y*P),new z(K,M,1)},[]),C=g.useCallback((w,B)=>{if(w.image){const D=document.createElement("canvas"),k=D.getContext("2d",s);if(!k)throw new Error("Failed to get 2d context");D.width=w.image.width,D.height=w.image.height,k.drawImage(w.image,0,0);const Q=w.image.width,Y=w.image.height,W=Math.round(Math.sqrt(B*(Q/Y))),P=Math.round(B/W),K=Q/W,M=Y/P,V=[];for(let $=0;$<P;$++)for(let G=0;G<W;G++){if($*W+G>=B){V.push({row:$,col:G});continue}const F=k.getImageData(G*K,$*M,K,M).data;tR(F)&&V.push({row:$,col:G})}return{rows:P,columns:W,frameWidth:K,frameHeight:M,emptyFrames:V}}else return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}},[s]),I=g.useCallback(w=>{const B=D=>{let k=null;for(const Y of D){const{w:W,h:P}=Y.frame,K=W*P;(!k||K>k.area)&&(k={w:W,h:P,area:K})}return D.map(Y=>{const{w:W,h:P}=Y.frame,K=W*P,M=k?K===k.area?1:Math.sqrt(K/k.area):1;return{...Y,scaleRatio:M}})};if(Array.isArray(w))return B(w);{const D={};for(const k in w)D[k]=B(w[k]);return D}},[]),_=g.useCallback(()=>{const w={},B=a.current,D=f.current;if(B)if(D&&Array.isArray(B.frames)){for(let k=0;k<D.length;k++){w[D[k]]=[];for(const Q of B.frames){const Y=Q.frame,W=Q.sourceSize.w,P=Q.sourceSize.h;typeof Q.filename=="string"&&Q.filename.toLowerCase().indexOf(D[k].toLowerCase())!==-1&&w[D[k]].push({...Q,frame:Y,sourceSize:{w:W,h:P}})}}for(const k in w){const Q=I(w[k]);Array.isArray(Q)&&(w[k]=Q)}return w}else if(D&&typeof B.frames=="object"){for(let k=0;k<D.length;k++){w[D[k]]=[];for(const Q in B.frames){const Y=B.frames[Q],W=Y.frame,P=Y.sourceSize.w,K=Y.sourceSize.h;typeof Q=="string"&&Q.toLowerCase().indexOf(D[k].toLowerCase())!==-1&&w[D[k]].push({...Y,frame:W,sourceSize:{w:P,h:K}})}}for(const k in w){const Q=I(w[k]);Array.isArray(Q)&&(w[k]=Q)}return w}else{let k=[];return B!=null&&B.frames&&(Array.isArray(B.frames)?k=B.frames.map(Q=>({...Q,x:Q.frame.x,y:Q.frame.y,w:Q.frame.w,h:Q.frame.h})):k=Object.values(B.frames).flat().map(Q=>({...Q,x:Q.frame.x,y:Q.frame.y,w:Q.frame.w,h:Q.frame.h}))),I(k)}return[]},[I,a]),S=g.useCallback((w,B)=>{let D=new z(1,1,1);if(w===null){if(B&&i){const k=B.image.width,Q=B.image.height;l.current=i;const{rows:Y,columns:W,frameWidth:P,frameHeight:K,emptyFrames:M}=C(B,i),V={frames:[],meta:{version:"1.0",size:{w:k,h:Q},rows:Y,columns:W,frameWidth:P,frameHeight:K,scale:"1"}};for(let $=0;$<Y;$++)for(let G=0;G<W;G++)(M??[]).some(F=>F.row===$&&F.col===G)||Array.isArray(V.frames)&&V.frames.push({frame:{x:G*P,y:$*K,w:P,h:K},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:P,h:K},sourceSize:{w:P,h:K}});D=x(P,K,c),a.current=V}a.current&&a.current.frames&&(a.current.frames=I(a.current.frames))}else if(B){a.current=w,a.current.frames=_(),l.current=Array.isArray(w.frames)?w.frames.length:Object.keys(w.frames).length;const{w:k,h:Q}=Iu(w.frames).sourceSize;D=x(k,Q,c)}m(a.current),"encoding"in B?B.encoding=3001:"colorSpace"in B&&(B.colorSpace=a2),p(B),v({spriteTexture:B,spriteData:a.current,aspect:D})},[C,i,_,x,I]),b=g.useCallback((w,B,D)=>{const k=fetch(w).then(Y=>Y.json()),Q=new Promise(Y=>{y.load(B,Y)});Promise.all([k,Q]).then(Y=>{D(Y[0],Y[1])})},[y]),T=g.useCallback(w=>{if(!w&&!u.current)throw new Error("Either textureUrl or input must be provided");const B=w??u.current;if(!B)throw new Error("A valid texture URL must be provided");y.load(B,D=>S(null,D))},[y,S]),R=g.useCallback((w,B)=>{B&&w?b(B,w,S):T(w)},[b,T,S]);return g.useLayoutEffect(()=>{h.current&&u.current?b(h.current,u.current,S):u.current&&T();const w=u.current;return()=>{w&&oi.clear(nr,w)}},[b,T,S]),g.useLayoutEffect(()=>{n==null||n(A,d??null)},[A,d,n]),{spriteObj:E,loadJsonAndTexture:R}}Em.preload=r=>oi.preload(nr,r);Em.clear=r=>oi.clear(nr,r);function D3(r,e,...t){const i=g.useRef(null),n=le(s=>s.scene);return g.useLayoutEffect(()=>{let s;if(r&&r!=null&&r.current&&e&&(i.current=s=new e(r.current,...t)),s)return s.traverse(o=>o.raycast=()=>null),n.add(s),()=>{i.current=void 0,n.remove(s),s.dispose==null||s.dispose()}},[n,e,r,...t]),He(()=>{var s;return void((s=i.current)==null||s.update==null?void 0:s.update())}),i}const dP=({type:r,args:e=[]})=>{const t=g.useRef(null),i=g.useRef(null);return g.useLayoutEffect(()=>{i.current=t.current.parent}),D3(i,r,...e),g.createElement("object3D",{ref:t})};var M3={exports:{}};(function(r,e){(function(t,i){r.exports=i()})(Ex,function(){var t=function(){function i(d){return o.appendChild(d.dom),d}function n(d){for(var m=0;m<o.children.length;m++)o.children[m].style.display=m===d?"block":"none";s=d}var s=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(d){d.preventDefault(),n(++s%o.children.length)},!1);var a=(performance||Date).now(),l=a,c=0,u=i(new t.Panel("FPS","#0ff","#002")),h=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:o,addPanel:i,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){c++;var d=(performance||Date).now();if(h.update(d-a,200),d>l+1e3&&(u.update(1e3*c/(d-l),100),l=d,c=0,f)){var m=performance.memory;f.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return d},update:function(){a=this.end()},domElement:o,setMode:n}};return t.Panel=function(i,n,s){var o=1/0,a=0,l=Math.round,c=l(window.devicePixelRatio||1),u=80*c,h=48*c,f=3*c,d=2*c,m=3*c,A=15*c,p=74*c,y=30*c,E=document.createElement("canvas");E.width=u,E.height=h,E.style.cssText="width:80px;height:48px";var v=E.getContext("2d");return v.font="bold "+9*c+"px Helvetica,Arial,sans-serif",v.textBaseline="top",v.fillStyle=s,v.fillRect(0,0,u,h),v.fillStyle=n,v.fillText(i,f,d),v.fillRect(m,A,p,y),v.fillStyle=s,v.globalAlpha=.9,v.fillRect(m,A,p,y),{dom:E,update:function(x,C){o=Math.min(o,x),a=Math.max(a,x),v.fillStyle=s,v.globalAlpha=1,v.fillRect(0,0,u,A),v.fillStyle=n,v.fillText(l(x)+" "+i+" ("+l(o)+"-"+l(a)+")",f,d),v.drawImage(E,m+c,A,p-c,y,m,A,p-c,y),v.fillRect(m+p-c,A,c,y),v.fillStyle=s,v.globalAlpha=.9,v.fillRect(m+p-c,A,c,l((1-x/C)*y))}}},t})})(M3);var iR=M3.exports;const nR=xx(iR);function y1(r,e){typeof r=="function"?r(e):r!=null&&(r.current=e)}function sR(r,e=[],t){const[i,n]=g.useState();return g.useLayoutEffect(()=>{const s=r();return n(s),y1(t,s),()=>y1(t,null)},e),i}function mP({showPanel:r=0,className:e,parent:t}){const i=sR(()=>new nR,[]);return g.useEffect(()=>{if(i){const n=t&&t.current||document.body;i.showPanel(r),n==null||n.appendChild(i.dom);const s=(e??"").split(" ").filter(l=>l);s.length&&i.dom.classList.add(...s);const o=l2(()=>i.begin()),a=M0(()=>i.end());return()=>{s.length&&i.dom.classList.remove(...s),n==null||n.removeChild(i.dom),o(),a()}}},[t,i,e,r]),null}class rR{constructor(e,t,i){this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i,n,s=0){if(!this.context||!this.gradient)return;const o=Math.min(1/0,e),a=Math.max(i,e);n=Math.max(n,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(s)} ${this.name} (${o.toFixed(s)}-${parseFloat(a.toFixed(s))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const l=this.GRAPH_HEIGHT-(1-t/n)*this.GRAPH_HEIGHT;l>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-l,this.PR,l))}}const L3=class Yo{constructor({trackGPU:e=!1,logsPerSecond:t=30,samplesLog:i=60,samplesGraph:n=10,precision:s=2,minimal:o=!1,horizontal:a=!0,mode:l=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=c=>{c.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=l,this.horizontal=a,this.minimal=o,this.trackGPU=e,this.samplesLog=i,this.samplesGraph=n,this.precision=s,this.logsPerSecond=t,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new Yo.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new Yo.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e)}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){return e.isWebGPURenderer?(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0):!1}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new Yo.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new Yo.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new Yo.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,this.totalCpuDuration===0&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((e,t)=>{if(this.gl){const i=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!n){const o=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=o,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}}))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const i=Math.round(this.frames*1e3/t);this.addToAverage(i,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,i){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const n=performance.measure(i,e,t);this.totalCpuDuration+=n.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,i=2){if(t.logs.length>0){let n=0,s=.01;for(let l=0;l<t.logs.length;l++)n+=t.logs[l],t.logs[l]>s&&(s=t.logs[l]);let o=0,a=.01;for(let l=0;l<t.graph.length;l++)o+=t.graph[l],t.graph[l]>a&&(a=t.graph[l]);e&&e.update(n/Math.min(t.logs.length,this.samplesLog),o/Math.min(t.graph.length,this.samplesGraph),s,a,i)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(n,s){i.begin(),t.call(this,n,s),i.end()},this.threeRendererPatched=!0}};L3.Panel=rR;let oR=L3;const AP=g.forwardRef(function({className:e,parent:t,id:i,clearStatsGlStyle:n,...s},o){const a=le(c=>c.gl),l=g.useMemo(()=>{const c=new oR({...s});return c.init(a),c},[a]);return g.useImperativeHandle(o,()=>l.domElement,[l]),g.useEffect(()=>{if(l){const c=t&&t.current||document.body;c==null||c.appendChild(l.domElement),l.domElement.querySelectorAll("canvas").forEach(f=>{f.style.removeProperty("position")}),i&&(l.domElement.id=i),n&&l.domElement.removeAttribute("style"),l.domElement.removeAttribute("style");const u=(e??"").split(" ").filter(f=>f);u.length&&l.domElement.classList.add(...u);const h=M0(()=>l.update());return()=>{u.length&&l.domElement.classList.remove(...u),c==null||c.removeChild(l.domElement),h()}}},[t,l,e,i,n]),null});function pP({size:r=256,frames:e=1/0}={}){const t=le(u=>u.viewport.dpr),{width:i,height:n}=le(u=>u.size),s=r||i*t,o=r||n*t,a=g.useMemo(()=>{const u=new R0(s,o);return u.format=c2,u.type=L0,{depthTexture:u}},[s,o]);let l=0;const c=gn(s,o,a);return He(u=>{(e===1/0||l<e)&&(u.gl.setRenderTarget(c),u.gl.render(u.scene,u.camera),u.gl.setRenderTarget(null),l++)}),c.depthTexture}function gP(r,e,t=1){const i=le(o=>o.viewport),n=e*(i.aspect>r/e?i.width/r:i.height/e);return[r*(i.aspect>r/e?i.width/r:i.height/e)*t,n*t,1]}function yP(r,e){const t=le(n=>n.pointer),[i]=g.useState(()=>{const n=new Ku;return e&&Wn(n,e),function(s,o){n.setFromCamera(t,r instanceof u2?r:r.current);const a=this.constructor.prototype.raycast.bind(this);a&&a(n,o)}});return i}function Vf(r,e,t,i){return new(t||(t=Promise))(function(n,s){function o(c){try{l(i.next(c))}catch(u){s(u)}}function a(c){try{l(i.throw(c))}catch(u){s(u)}}function l(c){var u;c.done?n(c.value):(u=c.value,u instanceof t?u:new t(function(h){h(u)})).then(o,a)}l((i=i.apply(r,e||[])).next())})}const aR=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function v1(r){return r=r.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const P3=typeof window>"u",bs=(()=>{if(P3)return;const{userAgent:r,platform:e,maxTouchPoints:t}=window.navigator,i=/(iphone|ipod|ipad)/i.test(r),n=e==="iPad"||e==="MacIntel"&&t>0&&!window.MSStream;return{isIpad:n,isMobile:/android/i.test(r)||i||n,isSafari12:/Version\/12.+Safari/.test(r),isFirefox:/Firefox/.test(r)}})();function lR(r,e,t){if(!t)return[e];const i=function(c){const u=`
    precision highp float;
    attribute vec3 aPosition;
    varying float vvv;
    void main() {
      vvv = 0.31622776601683794;
      gl_Position = vec4(aPosition, 1.0);
    }
  `,h=`
    precision highp float;
    varying float vvv;
    void main() {
      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;
      enc = fract(enc);
      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
      gl_FragColor = enc;
    }
  `,f=c.createShader(35633),d=c.createShader(35632),m=c.createProgram();if(!(d&&f&&m))return;c.shaderSource(f,u),c.shaderSource(d,h),c.compileShader(f),c.compileShader(d),c.attachShader(m,f),c.attachShader(m,d),c.linkProgram(m),c.detachShader(m,f),c.detachShader(m,d),c.deleteShader(f),c.deleteShader(d),c.useProgram(m);const A=c.createBuffer();c.bindBuffer(34962,A),c.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const p=c.getAttribLocation(m,"aPosition");c.vertexAttribPointer(p,3,5126,!1,0,0),c.enableVertexAttribArray(p),c.clearColor(1,1,1,1),c.clear(16384),c.viewport(0,0,1,1),c.drawArrays(4,0,3);const y=new Uint8Array(4);return c.readPixels(0,0,1,1,6408,5121,y),c.deleteProgram(m),c.deleteBuffer(A),y.join("")}(r),n="801621810",s="8016218135",o="80162181161",a=bs!=null&&bs.isIpad?[["a7",o,12],["a8",s,15],["a8x",s,15],["a9",s,15],["a9x",s,15],["a10",s,15],["a10x",s,15],["a12",n,15],["a12x",n,15],["a12z",n,15],["a14",n,15],["a15",n,15],["m1",n,15],["m2",n,15]]:[["a7",o,12],["a8",s,12],["a9",s,15],["a10",s,15],["a11",n,15],["a12",n,15],["a13",n,15],["a14",n,15],["a15",n,15],["a16",n,15],["a17",n,15]];let l;return i==="80162181255"?l=a.filter(([,,c])=>c>=14):(l=a.filter(([,c])=>c===i),l.length||(l=a)),l.map(([c])=>`apple ${c} gpu`)}let E1=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}};const Kf=[],x1=[];function cR(r,e){if(r===e)return 0;const t=r;r.length>e.length&&(r=e,e=t);let i=r.length,n=e.length;for(;i>0&&r.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let s,o=0;for(;o<i&&r.charCodeAt(o)===e.charCodeAt(o);)o++;if(i-=o,n-=o,i===0)return n;let a,l,c=0,u=0,h=0;for(;u<i;)x1[u]=r.charCodeAt(o+u),Kf[u]=++u;for(;h<n;)for(s=e.charCodeAt(o+h),a=h++,c=h,u=0;u<i;u++)l=s===x1[u]?a:a+1,a=Kf[u],c=Kf[u]=a>c?l>c?c+1:l:l>a?a+1:l;return c}function uR(r){return r!=null}const hR=({mobileTiers:r=[0,15,30,60],desktopTiers:e=[0,15,30,60],override:t={},glContext:i,failIfMajorPerformanceCaveat:n=!1,benchmarksURL:s="https://unpkg.com/detect-gpu@5.0.70/dist/benchmarks"}={})=>Vf(void 0,void 0,void 0,function*(){const o={};if(P3)return{tier:0,type:"SSR"};const{isIpad:a=!!(bs!=null&&bs.isIpad),isMobile:l=!!(bs!=null&&bs.isMobile),screenSize:c=window.screen,loadBenchmarks:u=C=>Vf(void 0,void 0,void 0,function*(){const I=yield fetch(`${s}/${C}`).then(_=>_.json());if(parseInt(I.shift().split(".")[0],10)<4)throw new E1("Detect GPU benchmark data is out of date. Please update to version 4x");return I})}=t;let{renderer:h}=t;const f=(C,I,_,S,b)=>({device:b,fps:S,gpu:_,isMobile:l,tier:C,type:I});let d,m="";if(h)h=v1(h),d=[h];else{const C=i||function(_,S=!1){const b={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:S,powerPreference:"high-performance",stencil:!1};_&&delete b.powerPreference;const T=window.document.createElement("canvas"),R=T.getContext("webgl",b)||T.getContext("experimental-webgl",b);return R??void 0}(bs==null?void 0:bs.isSafari12,n);if(!C)return f(0,"WEBGL_UNSUPPORTED");const I=bs!=null&&bs.isFirefox?null:C.getExtension("WEBGL_debug_renderer_info");if(h=I?C.getParameter(I.UNMASKED_RENDERER_WEBGL):C.getParameter(C.RENDERER),!h)return f(1,"FALLBACK");m=h,h=v1(h),d=function(_,S,b){return S==="apple gpu"?lR(_,S,b):[S]}(C,h,l)}const A=(yield Promise.all(d.map(function(C){var I;return Vf(this,void 0,void 0,function*(){const _=($=>{const G=l?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const O of G)if($.includes(O))return O})(C);if(!_)return;const S=`${l?"m":"d"}-${_}${a?"-ipad":""}.json`,b=o[S]=(I=o[S])!==null&&I!==void 0?I:u(S);let T;try{T=yield b}catch($){if($ instanceof E1)throw $;return}const R=function($){var G;const O=($=$.replace(/\([^)]+\)/,"")).match(/\d+/)||$.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return(G=O==null?void 0:O.join("").replace(/\W|amd/g,""))!==null&&G!==void 0?G:""}(C);let w=T.filter(([,$])=>$===R);w.length||(w=T.filter(([$])=>$.includes(C)));const B=w.length;if(B===0)return;const D=C.split(/[.,()\[\]/\s]/g).sort().filter(($,G,O)=>G===0||$!==O[G-1]).join(" ");let k,[Q,,,,Y]=B>1?w.map($=>[$,cR(D,$[2])]).sort(([,$],[,G])=>$-G)[0][0]:w[0],W=Number.MAX_VALUE;const{devicePixelRatio:P}=window,K=c.width*P*c.height*P;for(const $ of Y){const[G,O]=$,F=G*O,U=Math.abs(K-F);U<W&&(W=U,k=$)}if(!k)return;const[,,M,V]=k;return[W,M,Q,V]})}))).filter(uR).sort(([C=Number.MAX_VALUE,I],[_=Number.MAX_VALUE,S])=>C===_?I-S:C-_);if(!A.length){const C=aR.find(I=>h.includes(I));return C?f(0,"BLOCKLISTED",C):f(1,"FALLBACK",`${h} (${m})`)}const[,p,y,E]=A[0];if(p===-1)return f(0,"BLOCKLISTED",y,p,E);const v=l?r:e;let x=0;for(let C=0;C<v.length;C++)p>=v[C]&&(x=C);return f(x,"BENCHMARK",y,p,E)}),fR=r=>ar(()=>hR(r),["useDetectGPU"]);function EP({children:r,...e}){const t=fR(e);return g.createElement(g.Fragment,null,r==null?void 0:r(t))}const F3=0,dR=1,hh=2,C1=2,$f=1.25,I1=1,Sr=6*4+4+4,fh=65535,mR=Math.pow(2,-24),Yf=Symbol("SKIP_GENERATION");function k3(r){return r.index?r.index.count:r.attributes.position.count}function ya(r){return k3(r)/3}function O3(r,e=ArrayBuffer){return r>65535?new Uint32Array(new e(4*r)):new Uint16Array(new e(2*r))}function AR(r,e){if(!r.index){const t=r.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=O3(t,i);r.setIndex(new Nt(n,1));for(let s=0;s<t;s++)n[s]=s}}function U3(r,e){const t=ya(r),i=e||r.drawRange,n=i.start/3,s=(i.start+i.count)/3,o=Math.max(0,n),a=Math.min(t,s)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function N3(r,e){if(!r.groups||!r.groups.length)return U3(r,e);const t=[],i=new Set,n=e||r.drawRange,s=n.start/3,o=(n.start+n.count)/3;for(const l of r.groups){const c=l.start/3,u=(l.start+l.count)/3;i.add(Math.max(s,c)),i.add(Math.min(o,u))}const a=Array.from(i.values()).sort((l,c)=>l-c);for(let l=0;l<a.length-1;l++){const c=a[l],u=a[l+1];t.push({offset:Math.floor(c),count:Math.floor(u-c)})}return t}function pR(r,e){const t=ya(r),i=N3(r,e).sort((o,a)=>o.offset-a.offset),n=i[i.length-1];n.count=Math.min(t-n.offset,n.count);let s=0;return i.forEach(({count:o})=>s+=o),t!==s}function Wf(r,e,t,i,n){let s=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,u=-1/0,h=1/0,f=1/0,d=1/0,m=-1/0,A=-1/0,p=-1/0;for(let y=e*6,E=(e+t)*6;y<E;y+=6){const v=r[y+0],x=r[y+1],C=v-x,I=v+x;C<s&&(s=C),I>l&&(l=I),v<h&&(h=v),v>m&&(m=v);const _=r[y+2],S=r[y+3],b=_-S,T=_+S;b<o&&(o=b),T>c&&(c=T),_<f&&(f=_),_>A&&(A=_);const R=r[y+4],w=r[y+5],B=R-w,D=R+w;B<a&&(a=B),D>u&&(u=D),R<d&&(d=R),R>p&&(p=R)}i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=c,i[5]=u,n[0]=h,n[1]=f,n[2]=d,n[3]=m,n[4]=A,n[5]=p}function gR(r,e=null,t=null,i=null){const n=r.attributes.position,s=r.index?r.index.array:null,o=ya(r),a=n.normalized;let l;e===null?(l=new Float32Array(o*6),t=0,i=o):(l=e,t=t||0,i=i||o);const c=n.array,u=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const f=["getX","getY","getZ"];for(let d=t;d<t+i;d++){const m=d*3,A=d*6;let p=m+0,y=m+1,E=m+2;s&&(p=s[p],y=s[y],E=s[E]),a||(p=p*h+u,y=y*h+u,E=E*h+u);for(let v=0;v<3;v++){let x,C,I;a?(x=n[f[v]](p),C=n[f[v]](y),I=n[f[v]](E)):(x=c[p+v],C=c[y+v],I=c[E+v]);let _=x;C<_&&(_=C),I<_&&(_=I);let S=x;C>S&&(S=C),I>S&&(S=I);const b=(S-_)/2,T=v*2;l[A+T+0]=_+b,l[A+T+1]=b+(Math.abs(_)+b)*mR}}return l}function pi(r,e,t){return t.min.x=e[r],t.min.y=e[r+1],t.min.z=e[r+2],t.max.x=e[r+3],t.max.y=e[r+4],t.max.z=e[r+5],t}function _1(r){let e=-1,t=-1/0;for(let i=0;i<3;i++){const n=r[i+3]-r[i];n>t&&(t=n,e=i)}return e}function S1(r,e){e.set(r)}function T1(r,e,t){let i,n;for(let s=0;s<3;s++){const o=s+3;i=r[s],n=e[s],t[s]=i<n?i:n,i=r[o],n=e[o],t[o]=i>n?i:n}}function Oc(r,e,t){for(let i=0;i<3;i++){const n=e[r+2*i],s=e[r+2*i+1],o=n-s,a=n+s;o<t[i]&&(t[i]=o),a>t[i+3]&&(t[i+3]=a)}}function qa(r){const e=r[3]-r[0],t=r[4]-r[1],i=r[5]-r[2];return 2*(e*t+t*i+i*e)}const Ws=32,yR=(r,e)=>r.candidate-e.candidate,Ar=new Array(Ws).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Uc=new Float32Array(6);function vR(r,e,t,i,n,s){let o=-1,a=0;if(s===F3)o=_1(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(s===dR)o=_1(r),o!==-1&&(a=ER(t,i,n,o));else if(s===hh){const l=qa(r);let c=$f*n;const u=i*6,h=(i+n)*6;for(let f=0;f<3;f++){const d=e[f],p=(e[f+3]-d)/Ws;if(n<Ws/4){const y=[...Ar];y.length=n;let E=0;for(let x=u;x<h;x+=6,E++){const C=y[E];C.candidate=t[x+2*f],C.count=0;const{bounds:I,leftCacheBounds:_,rightCacheBounds:S}=C;for(let b=0;b<3;b++)S[b]=1/0,S[b+3]=-1/0,_[b]=1/0,_[b+3]=-1/0,I[b]=1/0,I[b+3]=-1/0;Oc(x,t,I)}y.sort(yR);let v=n;for(let x=0;x<v;x++){const C=y[x];for(;x+1<v&&y[x+1].candidate===C.candidate;)y.splice(x+1,1),v--}for(let x=u;x<h;x+=6){const C=t[x+2*f];for(let I=0;I<v;I++){const _=y[I];C>=_.candidate?Oc(x,t,_.rightCacheBounds):(Oc(x,t,_.leftCacheBounds),_.count++)}}for(let x=0;x<v;x++){const C=y[x],I=C.count,_=n-C.count,S=C.leftCacheBounds,b=C.rightCacheBounds;let T=0;I!==0&&(T=qa(S)/l);let R=0;_!==0&&(R=qa(b)/l);const w=I1+$f*(T*I+R*_);w<c&&(o=f,c=w,a=C.candidate)}}else{for(let v=0;v<Ws;v++){const x=Ar[v];x.count=0,x.candidate=d+p+v*p;const C=x.bounds;for(let I=0;I<3;I++)C[I]=1/0,C[I+3]=-1/0}for(let v=u;v<h;v+=6){let I=~~((t[v+2*f]-d)/p);I>=Ws&&(I=Ws-1);const _=Ar[I];_.count++,Oc(v,t,_.bounds)}const y=Ar[Ws-1];S1(y.bounds,y.rightCacheBounds);for(let v=Ws-2;v>=0;v--){const x=Ar[v],C=Ar[v+1];T1(x.bounds,C.rightCacheBounds,x.rightCacheBounds)}let E=0;for(let v=0;v<Ws-1;v++){const x=Ar[v],C=x.count,I=x.bounds,S=Ar[v+1].rightCacheBounds;C!==0&&(E===0?S1(I,Uc):T1(I,Uc,Uc)),E+=C;let b=0,T=0;E!==0&&(b=qa(Uc)/l);const R=n-E;R!==0&&(T=qa(S)/l);const w=I1+$f*(b*E+T*R);w<c&&(o=f,c=w,a=x.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${s} used.`);return{axis:o,pos:a}}function ER(r,e,t,i){let n=0;for(let s=e,o=e+t;s<o;s++)n+=r[s*6+i*2];return n/t}class jf{constructor(){this.boundingData=new Float32Array(6)}}function xR(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){for(let u=0;u<3;u++){let h=e[o*3+u];e[o*3+u]=e[a*3+u],e[a*3+u]=h}for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function CR(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){let u=r[o];r[o]=r[a],r[a]=u;for(let h=0;h<6;h++){let f=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=f}o++,a--}else return o}}function rn(r,e){return e[r+15]===65535}function yn(r,e){return e[r+6]}function Dn(r,e){return e[r+14]}function Xn(r){return r+8}function Mn(r,e){return e[r+6]}function xm(r,e){return e[r+7]}let G3,Al,_u,Q3;const IR=Math.pow(2,32);function A0(r){return"count"in r?1:1+A0(r.left)+A0(r.right)}function _R(r,e,t){return G3=new Float32Array(t),Al=new Uint32Array(t),_u=new Uint16Array(t),Q3=new Uint8Array(t),p0(r,e)}function p0(r,e){const t=r/4,i=r/2,n="count"in e,s=e.boundingData;for(let o=0;o<6;o++)G3[t+o]=s[o];if(n)if(e.buffer){const o=e.buffer;Q3.set(new Uint8Array(o),r);for(let a=r,l=r+o.byteLength;a<l;a+=Sr){const c=a/2;rn(c,_u)||(Al[a/4+6]+=t)}return r+o.byteLength}else{const o=e.offset,a=e.count;return Al[t+6]=o,_u[i+14]=a,_u[i+15]=fh,r+Sr}else{const o=e.left,a=e.right,l=e.splitAxis;let c;if(c=p0(r+Sr,o),c/4>IR)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Al[t+6]=c/4,c=p0(c,a),Al[t+7]=l,c}}function SR(r,e){const t=(r.index?r.index.count:r.attributes.position.count)/3,i=t>2**16,n=i?4:2,s=e?new SharedArrayBuffer(t*n):new ArrayBuffer(t*n),o=i?new Uint32Array(s):new Uint16Array(s);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function TR(r,e,t,i,n){const{maxDepth:s,verbose:o,maxLeafTris:a,strategy:l,onProgress:c,indirect:u}=n,h=r._indirectBuffer,f=r.geometry,d=f.index?f.index.array:null,m=u?CR:xR,A=ya(f),p=new Float32Array(6);let y=!1;const E=new jf;return Wf(e,t,i,E.boundingData,p),x(E,t,i,p),E;function v(C){c&&c(C/A)}function x(C,I,_,S=null,b=0){if(!y&&b>=s&&(y=!0,o&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(f))),_<=a||b>=s)return v(I+_),C.offset=I,C.count=_,C;const T=vR(C.boundingData,S,e,I,_,l);if(T.axis===-1)return v(I+_),C.offset=I,C.count=_,C;const R=m(h,d,e,I,_,T);if(R===I||R===I+_)v(I+_),C.offset=I,C.count=_;else{C.splitAxis=T.axis;const w=new jf,B=I,D=R-I;C.left=w,Wf(e,B,D,w.boundingData,p),x(w,B,D,p,b+1);const k=new jf,Q=R,Y=_-D;C.right=k,Wf(e,Q,Y,k.boundingData,p),x(k,Q,Y,p,b+1)}return C}}function bR(r,e){const t=r.geometry;e.indirect&&(r._indirectBuffer=SR(t,e.useSharedArrayBuffer),pR(t,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),r._indirectBuffer||AR(t,e);const i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=gR(t),s=e.indirect?U3(t,e.range):N3(t,e.range);r._roots=s.map(o=>{const a=TR(r,n,o.offset,o.count,e),l=A0(a),c=new i(Sr*l);return _R(0,a,c),c})}class rr{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,n=-1/0;for(let s=0,o=e.length;s<o;s++){const l=e[s][t];i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}setFromPoints(e,t){let i=1/0,n=-1/0;for(let s=0,o=t.length;s<o;s++){const a=t[s],l=e.dot(a);i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}rr.prototype.setFromBox=function(){const r=new z;return function(t,i){const n=i.min,s=i.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let u=0;u<=1;u++){r.x=n.x*l+s.x*(1-l),r.y=n.y*c+s.y*(1-c),r.z=n.z*u+s.z*(1-u);const h=t.dot(r);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}}();const wR=function(){const r=new z,e=new z,t=new z;return function(n,s,o){const a=n.start,l=r,c=s.start,u=e;t.subVectors(a,c),r.subVectors(n.end,n.start),e.subVectors(s.end,s.start);const h=t.dot(u),f=u.dot(l),d=u.dot(u),m=t.dot(l),p=l.dot(l)*d-f*f;let y,E;p!==0?y=(h*f-m*d)/p:y=0,E=(h+y*f)/d,o.x=y,o.y=E}}(),Cm=function(){const r=new De,e=new z,t=new z;return function(n,s,o,a){wR(n,s,r);let l=r.x,c=r.y;if(l>=0&&l<=1&&c>=0&&c<=1){n.at(l,o),s.at(c,a);return}else if(l>=0&&l<=1){c<0?s.at(0,a):s.at(1,a),n.closestPointToPoint(a,!0,o);return}else if(c>=0&&c<=1){l<0?n.at(0,o):n.at(1,o),s.closestPointToPoint(o,!0,a);return}else{let u;l<0?u=n.start:u=n.end;let h;c<0?h=s.start:h=s.end;const f=e,d=t;if(n.closestPointToPoint(h,!0,e),s.closestPointToPoint(u,!0,t),f.distanceToSquared(h)<=d.distanceToSquared(u)){o.copy(f),a.copy(h);return}else{o.copy(u),a.copy(d);return}}}}(),BR=function(){const r=new z,e=new z,t=new or,i=new Ls;return function(s,o){const{radius:a,center:l}=s,{a:c,b:u,c:h}=o;if(i.start=c,i.end=u,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a||(i.start=c,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a)||(i.start=u,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a))return!0;const A=o.getPlane(t);if(Math.abs(A.distanceToPoint(l))<=a){const y=A.projectPoint(l,e);if(o.containsPoint(y))return!0}return!1}}(),RR=1e-15;function Xf(r){return Math.abs(r)<RR}class As extends Wr{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new z),this.satBounds=new Array(4).fill().map(()=>new rr),this.points=[this.a,this.b,this.c],this.sphere=new on,this.plane=new or,this.needsUpdate=!0}intersectsSphere(e){return BR(e,this)}update(){const e=this.a,t=this.b,i=this.c,n=this.points,s=this.satAxes,o=this.satBounds,a=s[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=s[1],u=o[1];c.subVectors(e,t),u.setFromPoints(c,n);const h=s[2],f=o[2];h.subVectors(t,i),f.setFromPoints(h,n);const d=s[3],m=o[3];d.subVectors(i,e),m.setFromPoints(d,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}As.prototype.closestPointToSegment=function(){const r=new z,e=new z,t=new Ls;return function(n,s=null,o=null){const{start:a,end:l}=n,c=this.points;let u,h=1/0;for(let f=0;f<3;f++){const d=(f+1)%3;t.start.copy(c[f]),t.end.copy(c[d]),Cm(t,n,r,e),u=r.distanceToSquared(e),u<h&&(h=u,s&&s.copy(r),o&&o.copy(e))}return this.closestPointToPoint(a,r),u=a.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(a)),this.closestPointToPoint(l,r),u=l.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(l)),Math.sqrt(h)}}();As.prototype.intersectsTriangle=function(){const r=new As,e=new Array(3),t=new Array(3),i=new rr,n=new rr,s=new z,o=new z,a=new z,l=new z,c=new z,u=new Ls,h=new Ls,f=new Ls,d=new z;function m(A,p,y){const E=A.points;let v=0,x=-1;for(let C=0;C<3;C++){const{start:I,end:_}=u;I.copy(E[C]),_.copy(E[(C+1)%3]),u.delta(o);const S=Xf(p.distanceToPoint(I));if(Xf(p.normal.dot(o))&&S){y.copy(u),v=2;break}const b=p.intersectLine(u,d);if(!b&&S&&d.copy(I),(b||S)&&!Xf(d.distanceTo(_))){if(v<=1)(v===1?y.start:y.end).copy(d),S&&(x=v);else if(v>=2){(x===1?y.start:y.end).copy(d),v=2;break}if(v++,v===2&&x===-1)break}}return v}return function(p,y=null,E=!1){this.needsUpdate&&this.update(),p.isExtendedTriangle?p.needsUpdate&&p.update():(r.copy(p),r.update(),p=r);const v=this.plane,x=p.plane;if(Math.abs(v.normal.dot(x.normal))>1-1e-10){const C=this.satBounds,I=this.satAxes;t[0]=p.a,t[1]=p.b,t[2]=p.c;for(let b=0;b<4;b++){const T=C[b],R=I[b];if(i.setFromPoints(R,t),T.isSeparated(i))return!1}const _=p.satBounds,S=p.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let b=0;b<4;b++){const T=_[b],R=S[b];if(i.setFromPoints(R,e),T.isSeparated(i))return!1}for(let b=0;b<4;b++){const T=I[b];for(let R=0;R<4;R++){const w=S[R];if(s.crossVectors(T,w),i.setFromPoints(s,e),n.setFromPoints(s,t),i.isSeparated(n))return!1}}return y&&(E||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),y.start.set(0,0,0),y.end.set(0,0,0)),!0}else{const C=m(this,x,h);if(C===1&&p.containsPoint(h.end))return y&&(y.start.copy(h.end),y.end.copy(h.end)),!0;if(C!==2)return!1;const I=m(p,v,f);if(I===1&&this.containsPoint(f.end))return y&&(y.start.copy(f.end),y.end.copy(f.end)),!0;if(I!==2)return!1;if(h.delta(a),f.delta(l),a.dot(l)<0){let B=f.start;f.start=f.end,f.end=B}const _=h.start.dot(a),S=h.end.dot(a),b=f.start.dot(a),T=f.end.dot(a),R=S<b,w=_<T;return _!==T&&b!==S&&R===w?!1:(y&&(c.subVectors(h.start,f.start),c.dot(a)>0?y.start.copy(h.start):y.start.copy(f.start),c.subVectors(h.end,f.end),c.dot(a)<0?y.end.copy(h.end):y.end.copy(f.end)),!0)}}}();As.prototype.distanceToPoint=function(){const r=new z;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();As.prototype.distanceToTriangle=function(){const r=new z,e=new z,t=["a","b","c"],i=new Ls,n=new Ls;return function(o,a=null,l=null){const c=a||l?i:null;if(this.intersectsTriangle(o,c))return(a||l)&&(a&&c.getCenter(a),l&&c.getCenter(l)),0;let u=1/0;for(let h=0;h<3;h++){let f;const d=t[h],m=o[d];this.closestPointToPoint(m,r),f=m.distanceToSquared(r),f<u&&(u=f,a&&a.copy(r),l&&l.copy(m));const A=this[d];o.closestPointToPoint(A,r),f=A.distanceToSquared(r),f<u&&(u=f,a&&a.copy(A),l&&l.copy(r))}for(let h=0;h<3;h++){const f=t[h],d=t[(h+1)%3];i.set(this[f],this[d]);for(let m=0;m<3;m++){const A=t[m],p=t[(m+1)%3];n.set(o[A],o[p]),Cm(i,n,r,e);const y=r.distanceToSquared(e);y<u&&(u=y,a&&a.copy(r),l&&l.copy(e))}}return Math.sqrt(u)}}();class an{constructor(e,t,i){this.isOrientedBox=!0,this.min=new z,this.max=new z,this.matrix=new we,this.invMatrix=new we,this.points=new Array(8).fill().map(()=>new z),this.satAxes=new Array(3).fill().map(()=>new z),this.satBounds=new Array(3).fill().map(()=>new rr),this.alignedSatBounds=new Array(3).fill().map(()=>new rr),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}an.prototype.update=function(){return function(){const e=this.matrix,t=this.min,i=this.max,n=this.points;for(let c=0;c<=1;c++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const f=1*c|2*u|4*h,d=n[f];d.x=c?i.x:t.x,d.y=u?i.y:t.y,d.z=h?i.z:t.z,d.applyMatrix4(e)}const s=this.satBounds,o=this.satAxes,a=n[0];for(let c=0;c<3;c++){const u=o[c],h=s[c],f=1<<c,d=n[f];u.subVectors(a,d),h.setFromPoints(u,n)}const l=this.alignedSatBounds;l[0].setFromPointsField(n,"x"),l[1].setFromPointsField(n,"y"),l[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();an.prototype.intersectsBox=function(){const r=new rr;return function(t){this.needsUpdate&&this.update();const i=t.min,n=t.max,s=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(r.min=i.x,r.max=n.x,a[0].isSeparated(r)||(r.min=i.y,r.max=n.y,a[1].isSeparated(r))||(r.min=i.z,r.max=n.z,a[2].isSeparated(r)))return!1;for(let l=0;l<3;l++){const c=o[l],u=s[l];if(r.setFromBox(c,t),u.isSeparated(r))return!1}return!0}}();an.prototype.intersectsTriangle=function(){const r=new As,e=new Array(3),t=new rr,i=new rr,n=new z;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(r.copy(o),r.update(),o=r);const a=this.satBounds,l=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let f=0;f<3;f++){const d=a[f],m=l[f];if(t.setFromPoints(m,e),d.isSeparated(t))return!1}const c=o.satBounds,u=o.satAxes,h=this.points;for(let f=0;f<3;f++){const d=c[f],m=u[f];if(t.setFromPoints(m,h),d.isSeparated(t))return!1}for(let f=0;f<3;f++){const d=l[f];for(let m=0;m<4;m++){const A=u[m];if(n.crossVectors(d,A),t.setFromPoints(n,e),i.setFromPoints(n,h),t.isSeparated(i))return!1}}return!0}}();an.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();an.prototype.distanceToPoint=function(){const r=new z;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();an.prototype.distanceToBox=function(){const r=["x","y","z"],e=new Array(12).fill().map(()=>new Ls),t=new Array(12).fill().map(()=>new Ls),i=new z,n=new z;return function(o,a=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||c)&&(o.getCenter(n),this.closestPointToPoint(n,i),o.closestPointToPoint(i,n),l&&l.copy(i),c&&c.copy(n)),0;const u=a*a,h=o.min,f=o.max,d=this.points;let m=1/0;for(let p=0;p<8;p++){const y=d[p];n.copy(y).clamp(h,f);const E=y.distanceToSquared(n);if(E<m&&(m=E,l&&l.copy(y),c&&c.copy(n),E<u))return Math.sqrt(E)}let A=0;for(let p=0;p<3;p++)for(let y=0;y<=1;y++)for(let E=0;E<=1;E++){const v=(p+1)%3,x=(p+2)%3,C=y<<v|E<<x,I=1<<p|y<<v|E<<x,_=d[C],S=d[I];e[A].set(_,S);const T=r[p],R=r[v],w=r[x],B=t[A],D=B.start,k=B.end;D[T]=h[T],D[R]=y?h[R]:f[R],D[w]=E?h[w]:f[R],k[T]=f[T],k[R]=y?h[R]:f[R],k[w]=E?h[w]:f[R],A++}for(let p=0;p<=1;p++)for(let y=0;y<=1;y++)for(let E=0;E<=1;E++){n.x=p?f.x:h.x,n.y=y?f.y:h.y,n.z=E?f.z:h.z,this.closestPointToPoint(n,i);const v=n.distanceToSquared(i);if(v<m&&(m=v,l&&l.copy(i),c&&c.copy(n),v<u))return Math.sqrt(v)}for(let p=0;p<12;p++){const y=e[p];for(let E=0;E<12;E++){const v=t[E];Cm(y,v,i,n);const x=i.distanceToSquared(n);if(x<m&&(m=x,l&&l.copy(i),c&&c.copy(n),x<u))return Math.sqrt(x)}}return Math.sqrt(m)}}();class Im{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class DR extends Im{constructor(){super(()=>new As)}}const qn=new DR;class MR{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=i=>{t&&e.push(t),t=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const ni=new MR;let _r,Jo;const Ro=[],Nc=new Im(()=>new Yt);function LR(r,e,t,i,n,s){_r=Nc.getPrimitive(),Jo=Nc.getPrimitive(),Ro.push(_r,Jo),ni.setBuffer(r._roots[e]);const o=g0(0,r.geometry,t,i,n,s);ni.clearBuffer(),Nc.releasePrimitive(_r),Nc.releasePrimitive(Jo),Ro.pop(),Ro.pop();const a=Ro.length;return a>0&&(Jo=Ro[a-1],_r=Ro[a-2]),o}function g0(r,e,t,i,n=null,s=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=ni;let u=r*2;if(rn(u,l)){const f=yn(r,c),d=Dn(u,l);return pi(r,a,_r),i(f,d,!1,o,s+r,_r)}else{let T=function(w){const{uint16Array:B,uint32Array:D}=ni;let k=w*2;for(;!rn(k,B);)w=Xn(w),k=w*2;return yn(w,D)},R=function(w){const{uint16Array:B,uint32Array:D}=ni;let k=w*2;for(;!rn(k,B);)w=Mn(w,D),k=w*2;return yn(w,D)+Dn(k,B)};const f=Xn(r),d=Mn(r,c);let m=f,A=d,p,y,E,v;if(n&&(E=_r,v=Jo,pi(m,a,E),pi(A,a,v),p=n(E),y=n(v),y<p)){m=d,A=f;const w=p;p=y,y=w,E=v}E||(E=_r,pi(m,a,E));const x=rn(m*2,l),C=t(E,x,p,o+1,s+m);let I;if(C===C1){const w=T(m),D=R(m)-w;I=i(w,D,!0,o+1,s+m,E)}else I=C&&g0(m,e,t,i,n,s,o+1);if(I)return!0;v=Jo,pi(A,a,v);const _=rn(A*2,l),S=t(v,_,y,o+1,s+A);let b;if(S===C1){const w=T(A),D=R(A)-w;b=i(w,D,!0,o+1,s+A,v)}else b=S&&g0(A,e,t,i,n,s,o+1);return!!b}}const Ja=new z,qf=new z;function PR(r,e,t={},i=0,n=1/0){const s=i*i,o=n*n;let a=1/0,l=null;if(r.shapecast({boundsTraverseOrder:u=>(Ja.copy(e).clamp(u.min,u.max),Ja.distanceToSquared(e)),intersectsBounds:(u,h,f)=>f<a&&f<o,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,Ja);const f=e.distanceToSquared(Ja);return f<a&&(qf.copy(Ja),a=f,l=h),f<s}}),a===1/0)return null;const c=Math.sqrt(a);return t.point?t.point.copy(qf):t.point=qf.clone(),t.distance=c,t.faceIndex=l,t}const FR=parseInt(Ul)>=169,Hr=new z,Vr=new z,Kr=new z,Gc=new De,Qc=new De,zc=new De,b1=new z,w1=new z,B1=new z,Za=new z;function kR(r,e,t,i,n,s,o,a){let l;if(s===ma?l=r.intersectTriangle(i,t,e,!0,n):l=r.intersectTriangle(e,t,i,s!==xi,n),l===null)return null;const c=r.origin.distanceTo(n);return c<o||c>a?null:{distance:c,point:n.clone()}}function OR(r,e,t,i,n,s,o,a,l,c,u){Hr.fromBufferAttribute(e,s),Vr.fromBufferAttribute(e,o),Kr.fromBufferAttribute(e,a);const h=kR(r,Hr,Vr,Kr,Za,l,c,u);if(h){const f=new z;Wr.getBarycoord(Za,Hr,Vr,Kr,f),i&&(Gc.fromBufferAttribute(i,s),Qc.fromBufferAttribute(i,o),zc.fromBufferAttribute(i,a),h.uv=Wr.getInterpolation(Za,Hr,Vr,Kr,Gc,Qc,zc,new De)),n&&(Gc.fromBufferAttribute(n,s),Qc.fromBufferAttribute(n,o),zc.fromBufferAttribute(n,a),h.uv1=Wr.getInterpolation(Za,Hr,Vr,Kr,Gc,Qc,zc,new De)),t&&(b1.fromBufferAttribute(t,s),w1.fromBufferAttribute(t,o),B1.fromBufferAttribute(t,a),h.normal=Wr.getInterpolation(Za,Hr,Vr,Kr,b1,w1,B1,new z),h.normal.dot(r.direction)>0&&h.normal.multiplyScalar(-1));const d={a:s,b:o,c:a,normal:new z,materialIndex:0};Wr.getNormal(Hr,Vr,Kr,d.normal),h.face=d,h.faceIndex=s,FR&&(h.barycoord=f)}return h}function dh(r,e,t,i,n,s,o){const a=i*3;let l=a+0,c=a+1,u=a+2;const h=r.index;r.index&&(l=h.getX(l),c=h.getX(c),u=h.getX(u));const{position:f,normal:d,uv:m,uv1:A}=r.attributes,p=OR(t,f,d,m,A,l,c,u,e,s,o);return p?(p.faceIndex=i,n&&n.push(p),p):null}function Bi(r,e,t,i){const n=r.a,s=r.b,o=r.c;let a=e,l=e+1,c=e+2;t&&(a=t.getX(a),l=t.getX(l),c=t.getX(c)),n.x=i.getX(a),n.y=i.getY(a),n.z=i.getZ(a),s.x=i.getX(l),s.y=i.getY(l),s.z=i.getZ(l),o.x=i.getX(c),o.y=i.getY(c),o.z=i.getZ(c)}function UR(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++)dh(l,e,t,u,s,o,a)}function NR(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=dh(a,e,t,h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function GR(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=u,Bi(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function QR(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===fh){const y=o[f+6],E=a[A+14];let v=1/0,x=1/0,C=1/0,I=-1/0,_=-1/0,S=-1/0;for(let b=3*y,T=3*(y+E);b<T;b++){let R=i[b];const w=n.getX(R),B=n.getY(R),D=n.getZ(R);w<v&&(v=w),w>I&&(I=w),B<x&&(x=B),B>_&&(_=B),D<C&&(C=D),D>S&&(S=D)}return l[f+0]!==v||l[f+1]!==x||l[f+2]!==C||l[f+3]!==I||l[f+4]!==_||l[f+5]!==S?(l[f+0]=v,l[f+1]=x,l[f+2]=C,l[f+3]=I,l[f+4]=_,l[f+5]=S,!0):!1}else{const y=f+8,E=o[f+6],v=y+d,x=E+d;let C=m,I=!1,_=!1;e?C||(I=e.has(v),_=e.has(x),C=!I&&!_):(I=!0,_=!0);const S=C||I,b=C||_;let T=!1;S&&(T=h(y,d,C));let R=!1;b&&(R=h(E,d,C));const w=T||R;if(w)for(let B=0;B<3;B++){const D=y+B,k=E+B,Q=l[D],Y=l[D+3],W=l[k],P=l[k+3];l[f+B]=Q<W?Q:W,l[f+B+3]=Y>P?Y:P}return w}}}function Rr(r,e,t,i,n){let s,o,a,l,c,u;const h=1/t.direction.x,f=1/t.direction.y,d=1/t.direction.z,m=t.origin.x,A=t.origin.y,p=t.origin.z;let y=e[r],E=e[r+3],v=e[r+1],x=e[r+3+1],C=e[r+2],I=e[r+3+2];return h>=0?(s=(y-m)*h,o=(E-m)*h):(s=(E-m)*h,o=(y-m)*h),f>=0?(a=(v-A)*f,l=(x-A)*f):(a=(x-A)*f,l=(v-A)*f),s>l||a>o||((a>s||isNaN(s))&&(s=a),(l<o||isNaN(o))&&(o=l),d>=0?(c=(C-p)*d,u=(I-p)*d):(c=(I-p)*d,u=(C-p)*d),s>u||c>o)?!1:((c>s||s!==s)&&(s=c),(u<o||o!==o)&&(o=u),s<=n&&o>=i)}function zR(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++){let f=c?c[u]:u;dh(l,e,t,f,s,o,a)}}function HR(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=dh(a,e,t,l?l[h]:h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function VR(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=t.resolveTriangleIndex(u),Bi(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function KR(r,e,t,i,n,s,o){ni.setBuffer(r._roots[e]),y0(0,r,t,i,n,s,o),ni.clearBuffer()}function y0(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=ni,u=r*2;if(rn(u,l)){const f=yn(r,c),d=Dn(u,l);UR(e,t,i,f,d,n,s,o)}else{const f=Xn(r);Rr(f,a,i,s,o)&&y0(f,e,t,i,n,s,o);const d=Mn(r,c);Rr(d,a,i,s,o)&&y0(d,e,t,i,n,s,o)}}const $R=["x","y","z"];function YR(r,e,t,i,n,s){ni.setBuffer(r._roots[e]);const o=v0(0,r,t,i,n,s);return ni.clearBuffer(),o}function v0(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=ni;let c=r*2;if(rn(c,a)){const h=yn(r,l),f=Dn(c,a);return NR(e,t,i,h,f,n,s)}else{const h=xm(r,l),f=$R[h],m=i.direction[f]>=0;let A,p;m?(A=Xn(r),p=Mn(r,l)):(A=Mn(r,l),p=Xn(r));const E=Rr(A,o,i,n,s)?v0(A,e,t,i,n,s):null;if(E){const C=E.point[f];if(m?C<=o[p+h]:C>=o[p+h+3])return E}const x=Rr(p,o,i,n,s)?v0(p,e,t,i,n,s):null;return E&&x?E.distance<=x.distance?E:x:E||x||null}}const Hc=new Yt,Do=new As,Mo=new As,el=new we,R1=new an,Vc=new an;function WR(r,e,t,i){ni.setBuffer(r._roots[e]);const n=E0(0,r,t,i);return ni.clearBuffer(),n}function E0(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=ni;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),R1.set(t.boundingBox.min,t.boundingBox.max,i),n=R1),rn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=yn(r,a),p=Dn(l,o);if(el.copy(i).invert(),t.boundsTree)return pi(r,s,Vc),Vc.matrix.copy(el),Vc.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:E=>Vc.intersectsBox(E),intersectsTriangle:E=>{E.a.applyMatrix4(i),E.b.applyMatrix4(i),E.c.applyMatrix4(i),E.needsUpdate=!0;for(let v=A*3,x=(p+A)*3;v<x;v+=3)if(Bi(Mo,v,h,f),Mo.needsUpdate=!0,E.intersectsTriangle(Mo))return!0;return!1}});for(let y=A*3,E=(p+A)*3;y<E;y+=3){Bi(Do,y,h,f),Do.a.applyMatrix4(el),Do.b.applyMatrix4(el),Do.c.applyMatrix4(el),Do.needsUpdate=!0;for(let v=0,x=d.count;v<x;v+=3)if(Bi(Mo,v,d,m),Mo.needsUpdate=!0,Do.intersectsTriangle(Mo))return!0}}else{const u=r+8,h=a[r+6];return pi(u,s,Hc),!!(n.intersectsBox(Hc)&&E0(u,e,t,i,n)||(pi(h,s,Hc),n.intersectsBox(Hc)&&E0(h,e,t,i,n)))}}const Kc=new we,Jf=new an,tl=new an,jR=new z,XR=new z,qR=new z,JR=new z;function ZR(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Jf.set(e.boundingBox.min,e.boundingBox.max,t),Jf.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=qn.getPrimitive(),d=qn.getPrimitive();let m=jR,A=XR,p=null,y=null;n&&(p=qR,y=JR);let E=1/0,v=null,x=null;return Kc.copy(t).invert(),tl.matrix.copy(Kc),r.shapecast({boundsTraverseOrder:C=>Jf.distanceToBox(C),intersectsBounds:(C,I,_)=>_<E&&_<o?(I&&(tl.min.copy(C.min),tl.max.copy(C.max),tl.needsUpdate=!0),!0):!1,intersectsRange:(C,I)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:S=>tl.distanceToBox(S),intersectsBounds:(S,b,T)=>T<E&&T<o,intersectsRange:(S,b)=>{for(let T=S,R=S+b;T<R;T++){Bi(d,3*T,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let w=C,B=C+I;w<B;w++){Bi(f,3*w,c,l),f.needsUpdate=!0;const D=f.distanceToTriangle(d,m,p);if(D<E&&(A.copy(m),y&&y.copy(p),E=D,v=w,x=T),D<s)return!0}}}});{const _=ya(e);for(let S=0,b=_;S<b;S++){Bi(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=C,R=C+I;T<R;T++){Bi(f,3*T,c,l),f.needsUpdate=!0;const w=f.distanceToTriangle(d,m,p);if(w<E&&(A.copy(m),y&&y.copy(p),E=w,v=T,x=S),w<s)return!0}}}}}),qn.releasePrimitive(f),qn.releasePrimitive(d),E===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=E,i.faceIndex=v,n&&(n.point?n.point.copy(y):n.point=y.clone(),n.point.applyMatrix4(Kc),A.applyMatrix4(Kc),n.distance=A.sub(n.point).length(),n.faceIndex=x),i)}function eD(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===fh){const y=o[f+6],E=a[A+14];let v=1/0,x=1/0,C=1/0,I=-1/0,_=-1/0,S=-1/0;for(let b=y,T=y+E;b<T;b++){const R=3*r.resolveTriangleIndex(b);for(let w=0;w<3;w++){let B=R+w;B=i?i[B]:B;const D=n.getX(B),k=n.getY(B),Q=n.getZ(B);D<v&&(v=D),D>I&&(I=D),k<x&&(x=k),k>_&&(_=k),Q<C&&(C=Q),Q>S&&(S=Q)}}return l[f+0]!==v||l[f+1]!==x||l[f+2]!==C||l[f+3]!==I||l[f+4]!==_||l[f+5]!==S?(l[f+0]=v,l[f+1]=x,l[f+2]=C,l[f+3]=I,l[f+4]=_,l[f+5]=S,!0):!1}else{const y=f+8,E=o[f+6],v=y+d,x=E+d;let C=m,I=!1,_=!1;e?C||(I=e.has(v),_=e.has(x),C=!I&&!_):(I=!0,_=!0);const S=C||I,b=C||_;let T=!1;S&&(T=h(y,d,C));let R=!1;b&&(R=h(E,d,C));const w=T||R;if(w)for(let B=0;B<3;B++){const D=y+B,k=E+B,Q=l[D],Y=l[D+3],W=l[k],P=l[k+3];l[f+B]=Q<W?Q:W,l[f+B+3]=Y>P?Y:P}return w}}}function tD(r,e,t,i,n,s,o){ni.setBuffer(r._roots[e]),x0(0,r,t,i,n,s,o),ni.clearBuffer()}function x0(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=ni,u=r*2;if(rn(u,l)){const f=yn(r,c),d=Dn(u,l);zR(e,t,i,f,d,n,s,o)}else{const f=Xn(r);Rr(f,a,i,s,o)&&x0(f,e,t,i,n,s,o);const d=Mn(r,c);Rr(d,a,i,s,o)&&x0(d,e,t,i,n,s,o)}}const iD=["x","y","z"];function nD(r,e,t,i,n,s){ni.setBuffer(r._roots[e]);const o=C0(0,r,t,i,n,s);return ni.clearBuffer(),o}function C0(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=ni;let c=r*2;if(rn(c,a)){const h=yn(r,l),f=Dn(c,a);return HR(e,t,i,h,f,n,s)}else{const h=xm(r,l),f=iD[h],m=i.direction[f]>=0;let A,p;m?(A=Xn(r),p=Mn(r,l)):(A=Mn(r,l),p=Xn(r));const E=Rr(A,o,i,n,s)?C0(A,e,t,i,n,s):null;if(E){const C=E.point[f];if(m?C<=o[p+h]:C>=o[p+h+3])return E}const x=Rr(p,o,i,n,s)?C0(p,e,t,i,n,s):null;return E&&x?E.distance<=x.distance?E:x:E||x||null}}const $c=new Yt,Lo=new As,Po=new As,il=new we,D1=new an,Yc=new an;function sD(r,e,t,i){ni.setBuffer(r._roots[e]);const n=I0(0,r,t,i);return ni.clearBuffer(),n}function I0(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=ni;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),D1.set(t.boundingBox.min,t.boundingBox.max,i),n=D1),rn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=yn(r,a),p=Dn(l,o);if(il.copy(i).invert(),t.boundsTree)return pi(r,s,Yc),Yc.matrix.copy(il),Yc.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:E=>Yc.intersectsBox(E),intersectsTriangle:E=>{E.a.applyMatrix4(i),E.b.applyMatrix4(i),E.c.applyMatrix4(i),E.needsUpdate=!0;for(let v=A,x=p+A;v<x;v++)if(Bi(Po,3*e.resolveTriangleIndex(v),h,f),Po.needsUpdate=!0,E.intersectsTriangle(Po))return!0;return!1}});for(let y=A,E=p+A;y<E;y++){const v=e.resolveTriangleIndex(y);Bi(Lo,3*v,h,f),Lo.a.applyMatrix4(il),Lo.b.applyMatrix4(il),Lo.c.applyMatrix4(il),Lo.needsUpdate=!0;for(let x=0,C=d.count;x<C;x+=3)if(Bi(Po,x,d,m),Po.needsUpdate=!0,Lo.intersectsTriangle(Po))return!0}}else{const u=r+8,h=a[r+6];return pi(u,s,$c),!!(n.intersectsBox($c)&&I0(u,e,t,i,n)||(pi(h,s,$c),n.intersectsBox($c)&&I0(h,e,t,i,n)))}}const Wc=new we,Zf=new an,nl=new an,rD=new z,oD=new z,aD=new z,lD=new z;function cD(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Zf.set(e.boundingBox.min,e.boundingBox.max,t),Zf.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=qn.getPrimitive(),d=qn.getPrimitive();let m=rD,A=oD,p=null,y=null;n&&(p=aD,y=lD);let E=1/0,v=null,x=null;return Wc.copy(t).invert(),nl.matrix.copy(Wc),r.shapecast({boundsTraverseOrder:C=>Zf.distanceToBox(C),intersectsBounds:(C,I,_)=>_<E&&_<o?(I&&(nl.min.copy(C.min),nl.max.copy(C.max),nl.needsUpdate=!0),!0):!1,intersectsRange:(C,I)=>{if(e.boundsTree){const _=e.boundsTree;return _.shapecast({boundsTraverseOrder:S=>nl.distanceToBox(S),intersectsBounds:(S,b,T)=>T<E&&T<o,intersectsRange:(S,b)=>{for(let T=S,R=S+b;T<R;T++){const w=_.resolveTriangleIndex(T);Bi(d,3*w,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let B=C,D=C+I;B<D;B++){const k=r.resolveTriangleIndex(B);Bi(f,3*k,c,l),f.needsUpdate=!0;const Q=f.distanceToTriangle(d,m,p);if(Q<E&&(A.copy(m),y&&y.copy(p),E=Q,v=B,x=T),Q<s)return!0}}}})}else{const _=ya(e);for(let S=0,b=_;S<b;S++){Bi(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=C,R=C+I;T<R;T++){const w=r.resolveTriangleIndex(T);Bi(f,3*w,c,l),f.needsUpdate=!0;const B=f.distanceToTriangle(d,m,p);if(B<E&&(A.copy(m),y&&y.copy(p),E=B,v=T,x=S),B<s)return!0}}}}}),qn.releasePrimitive(f),qn.releasePrimitive(d),E===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=E,i.faceIndex=v,n&&(n.point?n.point.copy(y):n.point=y.clone(),n.point.applyMatrix4(Wc),A.applyMatrix4(Wc),n.distance=A.sub(n.point).length(),n.faceIndex=x),i)}function uD(){return typeof SharedArrayBuffer<"u"}const Tl=new ni.constructor,Vu=new ni.constructor,Cr=new Im(()=>new Yt),Fo=new Yt,ko=new Yt,ed=new Yt,td=new Yt;let id=!1;function hD(r,e,t,i){if(id)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");id=!0;const n=r._roots,s=e._roots;let o,a=0,l=0;const c=new we().copy(t).invert();for(let u=0,h=n.length;u<h;u++){Tl.setBuffer(n[u]),l=0;const f=Cr.getPrimitive();pi(0,Tl.float32Array,f),f.applyMatrix4(c);for(let d=0,m=s.length;d<m&&(Vu.setBuffer(s[d]),o=us(0,0,t,c,i,a,l,0,0,f),Vu.clearBuffer(),l+=s[d].length,!o);d++);if(Cr.releasePrimitive(f),Tl.clearBuffer(),a+=n[u].length,o)break}return id=!1,o}function us(r,e,t,i,n,s=0,o=0,a=0,l=0,c=null,u=!1){let h,f;u?(h=Vu,f=Tl):(h=Tl,f=Vu);const d=h.float32Array,m=h.uint32Array,A=h.uint16Array,p=f.float32Array,y=f.uint32Array,E=f.uint16Array,v=r*2,x=e*2,C=rn(v,A),I=rn(x,E);let _=!1;if(I&&C)u?_=n(yn(e,y),Dn(e*2,E),yn(r,m),Dn(r*2,A),l,o+e,a,s+r):_=n(yn(r,m),Dn(r*2,A),yn(e,y),Dn(e*2,E),a,s+r,l,o+e);else if(I){const S=Cr.getPrimitive();pi(e,p,S),S.applyMatrix4(t);const b=Xn(r),T=Mn(r,m);pi(b,d,Fo),pi(T,d,ko);const R=S.intersectsBox(Fo),w=S.intersectsBox(ko);_=R&&us(e,b,i,t,n,o,s,l,a+1,S,!u)||w&&us(e,T,i,t,n,o,s,l,a+1,S,!u),Cr.releasePrimitive(S)}else{const S=Xn(e),b=Mn(e,y);pi(S,p,ed),pi(b,p,td);const T=c.intersectsBox(ed),R=c.intersectsBox(td);if(T&&R)_=us(r,S,t,i,n,s,o,a,l+1,c,u)||us(r,b,t,i,n,s,o,a,l+1,c,u);else if(T)if(C)_=us(r,S,t,i,n,s,o,a,l+1,c,u);else{const w=Cr.getPrimitive();w.copy(ed).applyMatrix4(t);const B=Xn(r),D=Mn(r,m);pi(B,d,Fo),pi(D,d,ko);const k=w.intersectsBox(Fo),Q=w.intersectsBox(ko);_=k&&us(S,B,i,t,n,o,s,l,a+1,w,!u)||Q&&us(S,D,i,t,n,o,s,l,a+1,w,!u),Cr.releasePrimitive(w)}else if(R)if(C)_=us(r,b,t,i,n,s,o,a,l+1,c,u);else{const w=Cr.getPrimitive();w.copy(td).applyMatrix4(t);const B=Xn(r),D=Mn(r,m);pi(B,d,Fo),pi(D,d,ko);const k=w.intersectsBox(Fo),Q=w.intersectsBox(ko);_=k&&us(b,B,i,t,n,o,s,l,a+1,w,!u)||Q&&us(b,D,i,t,n,o,s,l,a+1,w,!u),Cr.releasePrimitive(w)}}return _}const jc=new an,M1=new Yt,fD={strategy:F3,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class mh{static serialize(e,t={}){t={cloneBuffers:!0,...t};const i=e.geometry,n=e._roots,s=e._indirectBuffer,o=i.getIndex();let a;return t.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o?o.array.slice():null,indirectBuffer:s?s.slice():null}:a={roots:n,index:o?o.array:null,indirectBuffer:s},a}static deserialize(e,t,i={}){i={setIndex:!0,indirect:!!e.indirectBuffer,...i};const{index:n,roots:s,indirectBuffer:o}=e,a=new mh(t,{...i,[Yf]:!0});if(a._roots=s,a._indirectBuffer=o||null,i.setIndex){const l=t.getIndex();if(l===null){const c=new Nt(e.index,1,!1);t.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...fD,[Yf]:!1},t),t.useSharedArrayBuffer&&!uD())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[Yf]||(bR(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Yt))),this.resolveTriangleIndex=t.indirect?i=>this._indirectBuffer[i]:i=>i}refit(e=null){return(this.indirect?eD:QR)(this,e)}traverse(e,t=0){const i=this._roots[t],n=new Uint32Array(i),s=new Uint16Array(i);o(0);function o(a,l=0){const c=a*2,u=s[c+15]===fh;if(u){const h=n[a+6],f=s[c+14];e(l,u,new Float32Array(i,a*4,6),h,f)}else{const h=a+Sr/4,f=n[a+6],d=n[a+7];e(l,u,new Float32Array(i,a*4,6),d)||(o(h,l+1),o(f,l+1))}}}raycast(e,t=Rl,i=0,n=1/0){const s=this._roots,o=this.geometry,a=[],l=t.isMaterial,c=Array.isArray(t),u=o.groups,h=l?t.side:t,f=this.indirect?tD:KR;for(let d=0,m=s.length;d<m;d++){const A=c?t[u[d].materialIndex].side:h,p=a.length;if(f(this,d,A,e,a,i,n),c){const y=u[d].materialIndex;for(let E=p,v=a.length;E<v;E++)a[E].face.materialIndex=y}}return a}raycastFirst(e,t=Rl,i=0,n=1/0){const s=this._roots,o=this.geometry,a=t.isMaterial,l=Array.isArray(t);let c=null;const u=o.groups,h=a?t.side:t,f=this.indirect?nD:YR;for(let d=0,m=s.length;d<m;d++){const A=l?t[u[d].materialIndex].side:h,p=f(this,d,A,e,i,n);p!=null&&(c==null||p.distance<c.distance)&&(c=p,l&&(p.face.materialIndex=u[d].materialIndex))}return c}intersectsGeometry(e,t){let i=!1;const n=this._roots,s=this.indirect?sD:WR;for(let o=0,a=n.length;o<a&&(i=s(this,o,e,t),!i);o++);return i}shapecast(e){const t=qn.getPrimitive(),i=this.indirect?VR:GR;let{boundsTraverseOrder:n,intersectsBounds:s,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(f,d,m,A,p)=>h(f,d,m,A,p)?!0:i(f,d,this,a,m,A,t)}else o||(a?o=(h,f,d,m)=>i(h,f,this,a,d,m,t):o=(h,f,d)=>d);let l=!1,c=0;const u=this._roots;for(let h=0,f=u.length;h<f;h++){const d=u[h];if(l=LR(this,h,s,o,n,c),l)break;c+=d.byteLength}return qn.releasePrimitive(t),l}bvhcast(e,t,i){let{intersectsRanges:n,intersectsTriangles:s}=i;const o=qn.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?m=>{const A=this.resolveTriangleIndex(m);Bi(o,A*3,a,l)}:m=>{Bi(o,m*3,a,l)},u=qn.getPrimitive(),h=e.geometry.index,f=e.geometry.attributes.position,d=e.indirect?m=>{const A=e.resolveTriangleIndex(m);Bi(u,A*3,h,f)}:m=>{Bi(u,m*3,h,f)};if(s){const m=(A,p,y,E,v,x,C,I)=>{for(let _=y,S=y+E;_<S;_++){d(_),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let b=A,T=A+p;b<T;b++)if(c(b),o.needsUpdate=!0,s(o,u,b,_,v,x,C,I))return!0}return!1};if(n){const A=n;n=function(p,y,E,v,x,C,I,_){return A(p,y,E,v,x,C,I,_)?!0:m(p,y,E,v,x,C,I,_)}}else n=m}return hD(this,e,t,n)}intersectsBox(e,t){return jc.set(e.min,e.max,t),jc.needsUpdate=!0,this.shapecast({intersectsBounds:i=>jc.intersectsBox(i),intersectsTriangle:i=>jc.intersectsTriangle(i)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},n={},s=0,o=1/0){return(this.indirect?cD:ZR)(this,e,t,i,n,s,o)}closestPointToPoint(e,t={},i=0,n=1/0){return PR(this,e,t,i,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(i=>{pi(0,new Float32Array(i),M1),e.union(M1)}),e}}function L1(r,e,t){return r===null?null:(r.point.applyMatrix4(e.matrixWorld),r.distance=r.point.distanceTo(t.ray.origin),r.object=e,r)}const Xc=new Aa,P1=new z,F1=new we,dD=Qe.prototype.raycast,mD=fC.prototype.raycast,k1=new z,Wi=new Qe,qc=[];function z3(r,e){this.isBatchedMesh?AD.call(this,r,e):pD.call(this,r,e)}function AD(r,e){if(this.boundsTrees){const t=this.boundsTrees,i=this._drawInfo||this._instanceInfo,n=this._drawRanges||this._geometryInfo,s=this.matrixWorld;Wi.material=this.material,Wi.geometry=this.geometry;const o=Wi.geometry.boundsTree,a=Wi.geometry.drawRange;Wi.geometry.boundingSphere===null&&(Wi.geometry.boundingSphere=new on);for(let l=0,c=i.length;l<c;l++){if(!this.getVisibleAt(l))continue;const u=i[l].geometryIndex;if(Wi.geometry.boundsTree=t[u],this.getMatrixAt(l,Wi.matrixWorld).premultiply(s),!Wi.geometry.boundsTree){this.getBoundingBoxAt(u,Wi.geometry.boundingBox),this.getBoundingSphereAt(u,Wi.geometry.boundingSphere);const h=n[u];Wi.geometry.setDrawRange(h.start,h.count)}Wi.raycast(r,qc);for(let h=0,f=qc.length;h<f;h++){const d=qc[h];d.object=this,d.batchId=l,e.push(d)}qc.length=0}Wi.geometry.boundsTree=o,Wi.geometry.drawRange=a,Wi.material=null,Wi.geometry=null}else mD.call(this,r,e)}function pD(r,e){if(this.geometry.boundsTree){if(this.material===void 0)return;F1.copy(this.matrixWorld).invert(),Xc.copy(r.ray).applyMatrix4(F1),k1.setFromMatrixScale(this.matrixWorld),P1.copy(Xc.direction).multiply(k1);const t=P1.length(),i=r.near/t,n=r.far/t,s=this.geometry.boundsTree;if(r.firstHitOnly===!0){const o=L1(s.raycastFirst(Xc,this.material,i,n),this,r);o&&e.push(o)}else{const o=s.raycast(Xc,this.material,i,n);for(let a=0,l=o.length;a<l;a++){const c=L1(o[a],this,r);c&&e.push(c)}}}else dD.call(this,r,e)}function H3(r={}){return this.boundsTree=new mh(this,r),this.boundsTree}function V3(){this.boundsTree=null}function gD(r){switch(r){case 1:return"R";case 2:return"RG";case 3:return"RGBA";case 4:return"RGBA"}throw new Error}function yD(r){switch(r){case 1:return Ds;case 2:return Wo;case 3:return wi;case 4:return wi}}function O1(r){switch(r){case 1:return dC;case 2:return f2;case 3:return bu;case 4:return bu}}class K3 extends br{constructor(){super(),this.minFilter=Xt,this.magFilter=Xt,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,i=e.itemSize,n=e.count;if(t!==null){if(i*n%t!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=n*i/t}const s=e.itemSize,o=e.count,a=e.normalized,l=e.array.constructor,c=l.BYTES_PER_ELEMENT;let u=this._forcedType,h=s;if(u===null)switch(l){case Float32Array:u=ii;break;case Uint8Array:case Uint16Array:case Uint32Array:u=Jr;break;case Int8Array:case Int16Array:case Int32Array:u=uu;break}let f,d,m,A,p=gD(s);switch(u){case ii:m=1,d=yD(s),a&&c===1?(A=l,p+="8",l===Uint8Array?f=Hi:(f=wd,p+="_SNORM")):(A=Float32Array,p+="32F",f=ii);break;case uu:p+=c*8+"I",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=O1(s),c===1?(A=Int8Array,f=wd):c===2?(A=Int16Array,f=h2):(A=Int32Array,f=uu);break;case Jr:p+=c*8+"UI",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=O1(s),c===1?(A=Uint8Array,f=Hi):c===2?(A=Uint16Array,f=L0):(A=Uint32Array,f=Jr);break}h===3&&(d===wi||d===bu)&&(h=4);const y=Math.ceil(Math.sqrt(o))||1,E=h*y*y,v=new A(E),x=e.normalized;e.normalized=!1;for(let C=0;C<o;C++){const I=h*C;v[I]=e.getX(C)/m,s>=2&&(v[I+1]=e.getY(C)/m),s>=3&&(v[I+2]=e.getZ(C)/m,h===4&&(v[I+3]=1)),s>=4&&(v[I+3]=e.getW(C)/m)}e.normalized=x,this.internalFormat=p,this.format=d,this.type=f,this.image.width=y,this.image.height=y,this.image.data=v,this.needsUpdate=!0,this.dispose(),e.itemSize=i,e.count=n}}class vD extends K3{constructor(){super(),this._forcedType=Jr}}class ED extends K3{constructor(){super(),this._forcedType=ii}}class $3{constructor(){this.index=new vD,this.position=new ED,this.bvhBounds=new br,this.bvhContents=new br,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(CD(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const i=e._indirectBuffer;if(this._cachedIndexAttr===null||this._cachedIndexAttr.count!==i.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const n=O3(k3(t));this._cachedIndexAttr=new Nt(n,1,!1)}xD(t,i,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:i,bvhContents:n}=this;e&&e.dispose(),t&&t.dispose(),i&&i.dispose(),n&&n.dispose()}}function xD(r,e,t){const i=t.array,n=r.index?r.index.array:null;for(let s=0,o=e.length;s<o;s++){const a=3*s,l=3*e[s];for(let c=0;c<3;c++)i[a+c]=n?n[l+c]:l+c}}function CD(r,e,t){const i=r._roots;if(i.length!==1)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const n=i[0],s=new Uint16Array(n),o=new Uint32Array(n),a=new Float32Array(n),l=n.byteLength/Sr,c=2*Math.ceil(Math.sqrt(l/2)),u=new Float32Array(4*c*c),h=Math.ceil(Math.sqrt(l)),f=new Uint32Array(2*h*h);for(let d=0;d<l;d++){const m=d*Sr/4,A=m*2,p=m;for(let y=0;y<3;y++)u[8*d+0+y]=a[p+0+y],u[8*d+4+y]=a[p+3+y];if(rn(A,s)){const y=Dn(A,s),E=yn(m,o),v=4294901760|y;f[d*2+0]=v,f[d*2+1]=E}else{const y=4*Mn(m,o)/Sr,E=xm(m,o);f[d*2+0]=E,f[d*2+1]=y}}e.image.data=u,e.image.width=c,e.image.height=c,e.format=wi,e.type=ii,e.internalFormat="RGBA32F",e.minFilter=Xt,e.magFilter=Xt,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),t.image.data=f,t.image.width=h,t.image.height=h,t.format=f2,t.type=Jr,t.internalFormat="RG32UI",t.minFilter=Xt,t.magFilter=Xt,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose()}const ID=`

// A stack of uint32 indices can can store the indices for
// a perfectly balanced tree with a depth up to 31. Lower stack
// depth gets higher performance.
//
// However not all trees are balanced. Best value to set this to
// is the trees max depth.
#ifndef BVH_STACK_DEPTH
#define BVH_STACK_DEPTH 60
#endif

#ifndef INFINITY
#define INFINITY 1e20
#endif

// Utilities
uvec4 uTexelFetch1D( usampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

ivec4 iTexelFetch1D( isampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 texelFetch1D( sampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {

	return
		barycoord.x * texelFetch1D( tex, faceIndices.x ) +
		barycoord.y * texelFetch1D( tex, faceIndices.y ) +
		barycoord.z * texelFetch1D( tex, faceIndices.z );

}

void ndcToCameraRay(
	vec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,
	out vec3 rayOrigin, out vec3 rayDirection
) {

	// get camera look direction and near plane for camera clipping
	vec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );
	vec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );
	float near = abs( nearVector.z / nearVector.w );

	// get the camera direction and position from camera matrices
	vec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );
	direction /= direction.w;
	direction = cameraWorld * direction - origin;

	// slide the origin along the ray until it sits at the near clip plane position
	origin.xyz += direction.xyz * near / dot( direction, lookDirection );

	rayOrigin = origin.xyz;
	rayDirection = direction.xyz;

}
`,_D=`

#ifndef TRI_INTERSECT_EPSILON
#define TRI_INTERSECT_EPSILON 1e-5
#endif

// Raycasting
bool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {

	// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/
	// https://tavianator.com/2011/ray_box.html
	vec3 invDir = 1.0 / rayDirection;

	// find intersection distances for each plane
	vec3 tMinPlane = invDir * ( boundsMin - rayOrigin );
	vec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );

	// get the min and max distances from each intersection
	vec3 tMinHit = min( tMaxPlane, tMinPlane );
	vec3 tMaxHit = max( tMaxPlane, tMinPlane );

	// get the furthest hit distance
	vec2 t = max( tMinHit.xx, tMinHit.yz );
	float t0 = max( t.x, t.y );

	// get the minimum hit distance
	t = min( tMaxHit.xx, tMaxHit.yz );
	float t1 = min( t.x, t.y );

	// set distance to 0.0 if the ray starts inside the box
	dist = max( t0, 0.0 );

	return t1 >= dist;

}

bool intersectsTriangle(
	vec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,
	out vec3 barycoord, out vec3 norm, out float dist, out float side
) {

	// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d
	vec3 edge1 = b - a;
	vec3 edge2 = c - a;
	norm = cross( edge1, edge2 );

	float det = - dot( rayDirection, norm );
	float invdet = 1.0 / det;

	vec3 AO = rayOrigin - a;
	vec3 DAO = cross( AO, rayDirection );

	vec4 uvt;
	uvt.x = dot( edge2, DAO ) * invdet;
	uvt.y = - dot( edge1, DAO ) * invdet;
	uvt.z = dot( AO, norm ) * invdet;
	uvt.w = 1.0 - uvt.x - uvt.y;

	// set the hit information
	barycoord = uvt.wxy; // arranged in A, B, C order
	dist = uvt.z;
	side = sign( det );
	norm = side * normalize( norm );

	// add an epsilon to avoid misses between triangles
	uvt += vec4( TRI_INTERSECT_EPSILON );

	return all( greaterThanEqual( uvt, vec4( 0.0 ) ) );

}

bool intersectTriangles(
	// geometry info and triangle range
	sampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// outputs
	inout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	bool found = false;
	vec3 localBarycoord, localNormal;
	float localDist, localSide;
	for ( uint i = offset, l = offset + count; i < l; i ++ ) {

		uvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;
		vec3 a = texelFetch1D( positionAttr, indices.x ).rgb;
		vec3 b = texelFetch1D( positionAttr, indices.y ).rgb;
		vec3 c = texelFetch1D( positionAttr, indices.z ).rgb;

		if (
			intersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )
			&& localDist < minDistance
		) {

			found = true;
			minDistance = localDist;

			faceIndices = uvec4( indices.xyz, i );
			faceNormal = localNormal;

			side = localSide;
			barycoord = localBarycoord;
			dist = localDist;

		}

	}

	return found;

}

bool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {

	uint cni2 = currNodeIndex * 2u;
	vec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;
	vec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;
	return intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );

}

// use a macro to hide the fact that we need to expand the struct into separate fields
#define	bvhIntersectFirstHit(		bvh,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)	_bvhIntersectFirstHit(		bvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)

bool _bvhIntersectFirstHit(
	// bvh info
	sampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// output variables split into separate variables due to output precision
	inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	// stack needs to be twice as long as the deepest tree we expect because
	// we push both the left and right child onto the stack every traversal
	int ptr = 0;
	uint stack[ BVH_STACK_DEPTH ];
	stack[ 0 ] = 0u;

	float triangleDistance = INFINITY;
	bool found = false;
	while ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {

		uint currNodeIndex = stack[ ptr ];
		ptr --;

		// check if we intersect the current bounds
		float boundsHitDistance;
		if (
			! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )
			|| boundsHitDistance > triangleDistance
		) {

			continue;

		}

		uvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;
		bool isLeaf = bool( boundsInfo.x & 0xffff0000u );

		if ( isLeaf ) {

			uint count = boundsInfo.x & 0x0000ffffu;
			uint offset = boundsInfo.y;

			found = intersectTriangles(
				bvh_position, bvh_index, offset, count,
				rayOrigin, rayDirection, triangleDistance,
				faceIndices, faceNormal, barycoord, side, dist
			) || found;

		} else {

			uint leftIndex = currNodeIndex + 1u;
			uint splitAxis = boundsInfo.x & 0x0000ffffu;
			uint rightIndex = boundsInfo.y;

			bool leftToRight = rayDirection[ splitAxis ] >= 0.0;
			uint c1 = leftToRight ? leftIndex : rightIndex;
			uint c2 = leftToRight ? rightIndex : leftIndex;

			// set c2 in the stack so we traverse it later. We need to keep track of a pointer in
			// the stack while we traverse. The second pointer added is the one that will be
			// traversed first
			ptr ++;
			stack[ ptr ] = c2;

			ptr ++;
			stack[ ptr ] = c1;

		}

	}

	return found;

}
`,SD=`
struct BVH {

	usampler2D index;
	sampler2D position;

	sampler2D bvhBounds;
	usampler2D bvhContents;

};
`,TD=SD,bD=`
	${ID}
	${_D}
`,U1=r=>r.isMesh;function xP(r,e){e={strategy:hh,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...e},g.useEffect(()=>{if(r.current){r.current.raycast=z3;const t=r.current.geometry;return t.computeBoundsTree=H3,t.disposeBoundsTree=V3,t.computeBoundsTree(e),()=>{t.boundsTree&&t.disposeBoundsTree()}}},[r,JSON.stringify(e)])}const CP=g.forwardRef(({enabled:r=!0,firstHitOnly:e=!1,children:t,strategy:i=hh,verbose:n=!1,setBoundingBox:s=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:l=!1,...c},u)=>{const h=g.useRef(null),f=le(d=>d.raycaster);return g.useImperativeHandle(u,()=>h.current,[]),g.useEffect(()=>{if(r){const d={strategy:i,verbose:n,setBoundingBox:s,maxDepth:o,maxLeafTris:a,indirect:l},m=h.current;return f.firstHitOnly=e,m.traverse(A=>{U1(A)&&!A.geometry.boundsTree&&A.raycast===Qe.prototype.raycast&&(A.raycast=z3,A.geometry.computeBoundsTree=H3,A.geometry.disposeBoundsTree=V3,A.geometry.computeBoundsTree(d))}),()=>{delete f.firstHitOnly,m.traverse(A=>{U1(A)&&A.geometry.boundsTree&&(A.geometry.disposeBoundsTree(),A.raycast=Qe.prototype.raycast)})}}},[]),g.createElement("group",Ae({ref:h},c),t)});function IP(...r){const e=g.useRef([]);return e.current=r.map(t=>g.useContext(t)),g.useMemo(()=>({children:t})=>r.reduceRight((i,n,s)=>g.createElement(n.Provider,{value:e.current[s],children:i}),t),[])}function _P(r,e){const t=g.useRef(null),[i]=g.useState(()=>e?e instanceof mi?{current:e}:e:t),[n]=g.useState(()=>new zy(void 0));g.useLayoutEffect(()=>{e&&(i.current=e instanceof mi?e:e.current),n._root=i.current});const s=g.useRef({}),o=g.useMemo(()=>{const a={};return r.forEach(l=>Object.defineProperty(a,l.name,{enumerable:!0,get(){if(i.current)return s.current[l.name]||(s.current[l.name]=n.clipAction(l,i.current))},configurable:!0})),{ref:i,clips:r,actions:a,names:r.map(l=>l.name),mixer:n}},[r]);return He((a,l)=>n.update(l)),g.useEffect(()=>{const a=i.current;return()=>{s.current={},n.stopAllAction(),Object.values(o.actions).forEach(l=>{a&&n.uncacheAction(l,a)})}},[r]),o}function wD(r){const e=g.useRef(null),t=g.useRef(!1),i=g.useRef(!1),n=g.useRef(r);return g.useLayoutEffect(()=>void(n.current=r),[r]),g.useEffect(()=>{const s=e.current;if(s){const o=l2(()=>(t.current=!1,!0)),a=s.onBeforeRender;s.onBeforeRender=()=>t.current=!0;const l=M0(()=>(t.current!==i.current&&(n.current==null||n.current(i.current=t.current)),!0));return()=>{s.onBeforeRender=a,o(),l()}}},[]),e}const BD=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );
  #ifdef BOX_PROJECTED_ENV_MAP
    vWorldPosition = worldPosition.xyz;
  #endif
#endif
`,RD=`
#ifdef BOX_PROJECTED_ENV_MAP
  uniform vec3 envMapSize;
  uniform vec3 envMapPosition;
  varying vec3 vWorldPosition;
    
  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {
    vec3 nDir = normalize( v );
    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbminmax;
    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;
    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
    vec3 boxIntersection = vWorldPosition + nDir * correction;    
    return boxIntersection - cubePos;
  }
#endif
`,DD=`
#ifdef BOX_PROJECTED_ENV_MAP
  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );
#endif
`,MD=`
#ifdef BOX_PROJECTED_ENV_MAP
  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );
#endif
`;function LD(r,e,t){r.defines.BOX_PROJECTED_ENV_MAP=!0,r.uniforms.envMapPosition={value:e},r.uniforms.envMapSize={value:t},r.vertexShader=`
  varying vec3 vWorldPosition;
  ${r.vertexShader.replace("#include <worldpos_vertex>",BD)}`,r.fragmentShader=`
    ${RD}
    ${r.fragmentShader.replace("#include <envmap_physical_pars_fragment>",Xo.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
         ${DD}
         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
         ${MD}
        `)}`}function SP(r=new z,e=new z){const[t]=g.useState(()=>({position:new z,size:new z}));Wn(t,{position:r,size:e});const i=g.useRef(null),n=g.useMemo(()=>({ref:i,onBeforeCompile:s=>LD(s,t.position,t.size),customProgramCacheKey:()=>JSON.stringify(t.position.toArray())+JSON.stringify(t.size.toArray())}),[...t.position.toArray(),...t.size.toArray()]);return g.useLayoutEffect(()=>void(i.current.needsUpdate=!0),[t]),n}const N1=new Yt,Jc=new z,TP=({anchor:r,...e})=>{const t=g.useRef(null),i=g.useRef(null);return g.useEffect(()=>{var n;(n=t.current)!=null&&(n=n.parent)!=null&&n.parent&&(i.current=t.current.parent,t.current.parent.parent.add(t.current))},[]),He(()=>{i.current&&(N1.setFromObject(i.current),N1.getSize(Jc),t.current.position.set(i.current.position.x+Jc.x*(Array.isArray(r)?r[0]:r.x)/2,i.current.position.y+Jc.y*(Array.isArray(r)?r[1]:r.y)/2,i.current.position.z+Jc.z*(Array.isArray(r)?r[2]:r.z)/2))}),g.createElement("group",Ae({ref:t},e))};function PD(r,e,t=.9){return e*t+r*(1-t)}const FD=r=>Math.sqrt(1-Math.pow(r-1,2));class kD{constructor({size:e=256,maxAge:t=750,radius:i=.3,intensity:n=.2,interpolate:s=0,smoothing:o=0,minForce:a=.3,blend:l="screen",ease:c=FD}={}){this.size=e,this.maxAge=t,this.radius=i,this.intensity=n,this.ease=c,this.interpolate=s,this.smoothing=o,this.minForce=a,this.blend=l,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(e===null)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new qi(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach((t,i)=>{t.age+=e*1e3,t.age>this.maxAge&&this.trail.splice(i,1)}),this.trail.length||(this.force=0),this.trail.forEach(t=>{this.drawTouch(t)}),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const i=t.x-e.x,n=t.y-e.y,s=i*i+n*n,o=Math.max(this.minForce,Math.min(s*1e4,1));if(this.force=PD(o,this.force,this.smoothing),this.interpolate){const a=Math.ceil(s/Math.pow(this.radius*.5/this.interpolate,2));if(a>1)for(let l=1;l<a;l++)this.trail.push({x:t.x-i/a*l,y:t.y-n/a*l,age:0,force:o})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let i=1;e.age<this.maxAge*.3?i=this.ease(e.age/(this.maxAge*.3)):i=this.ease(1-(e.age-this.maxAge*.3)/(this.maxAge*.7)),i*=e.force,this.ctx.globalCompositeOperation=this.blend;const n=this.size*this.radius*i,s=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,n*.25),t.x,t.y,Math.max(0,n));s.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),s.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=s,this.ctx.arc(t.x,t.y,Math.max(0,n),0,Math.PI*2),this.ctx.fill()}}function OD(r={}){const{size:e,maxAge:t,radius:i,intensity:n,interpolate:s,smoothing:o,minForce:a,blend:l,ease:c}=r,u=g.useMemo(()=>new kD(r),[e,t,i,n,s,o,a,l,c]);He((f,d)=>void u.update(d));const h=g.useCallback(f=>u.addTouch(f.uv),[u]);return[u.texture,h]}const bP=({children:r,...e})=>{const t=OD(e);return g.createElement(g.Fragment,null,r==null?void 0:r(t))},Y3=g.forwardRef(function({children:e,object:t,disable:i,disableX:n,disableY:s,disableZ:o,left:a,right:l,top:c,bottom:u,front:h,back:f,onCentered:d,precise:m=!0,cacheKey:A=0,...p},y){const E=g.useRef(null),v=g.useRef(null),x=g.useRef(null),[C]=g.useState(()=>new Yt),[I]=g.useState(()=>new z),[_]=g.useState(()=>new on);return g.useLayoutEffect(()=>{v.current.matrixWorld.identity(),C.setFromObject(t??x.current,m);const S=C.max.x-C.min.x,b=C.max.y-C.min.y,T=C.max.z-C.min.z;C.getCenter(I),C.getBoundingSphere(_);const R=c?b/2:u?-b/2:0,w=a?-S/2:l?S/2:0,B=h?T/2:f?-T/2:0;v.current.position.set(i||n?0:-I.x+w,i||s?0:-I.y+R,i||o?0:-I.z+B),d==null||d({parent:E.current.parent,container:E.current,width:S,height:b,depth:T,boundingBox:C,boundingSphere:_,center:I,verticalAlignment:R,horizontalAlignment:w,depthAlignment:B})},[A,d,c,a,h,i,n,s,o,t,m,l,u,f,C,I,_]),g.useImperativeHandle(y,()=>E.current,[]),g.createElement("group",Ae({ref:E},p),g.createElement("group",{ref:v},g.createElement("group",{ref:x},e)))}),wP=g.forwardRef(({font:r,color:e="#cbcbcb",bevelSize:t=.04,debug:i=!1,children:n,...s},o)=>{const[a,l]=g.useState(0),c=g.useCallback((f=1)=>l(a+f),[a]),u=g.useCallback((f=1)=>l(a-f),[a]),h=g.useMemo(()=>({incr:c,decr:u}),[c,u]);return g.useImperativeHandle(o,()=>h,[h]),g.createElement("group",s,g.createElement(g.Suspense,{fallback:null},g.createElement(Y3,{top:!0,cacheKey:JSON.stringify({counter:a,font:r})},g.createElement(E6,{bevelEnabled:!0,bevelSize:t,font:r},i?g.createElement("meshNormalMaterial",{wireframe:!0}):g.createElement("meshStandardMaterial",{color:e}),a))),n)}),bl=(r,e)=>{r.updateRanges[0]=e};function UD(r){return typeof r=="function"}const G1=new we,Q1=new we,Zc=[],sl=new Qe;class ND extends tr{constructor(){super(),this.color=new Ye("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){const i=this.instance.current;if(!i||!i.geometry||!i.material)return;sl.geometry=i.geometry;const n=i.matrixWorld,s=i.userData.instances.indexOf(this.instanceKey);if(!(s===-1||s>i.count)){i.getMatrixAt(s,G1),Q1.multiplyMatrices(n,G1),sl.matrixWorld=Q1,i.material instanceof cu?sl.material.side=i.material.side:sl.material.side=i.material[0].side,sl.raycast(e,Zc);for(let o=0,a=Zc.length;o<a;o++){const l=Zc[o];l.instanceId=s,l.object=this,t.push(l)}Zc.length=0}}}const W3=g.createContext(null),z1=new we,H1=new we,GD=new we,V1=new z,K1=new nt,$1=new z,QD=r=>r.isInstancedBufferAttribute,_m=g.forwardRef(({context:r,children:e,...t},i)=>{g.useMemo(()=>Ii({PositionMesh:ND}),[]);const n=g.useRef(null);g.useImperativeHandle(i,()=>n.current,[]);const{subscribe:s,getParent:o}=g.useContext(r||W3);return g.useLayoutEffect(()=>s(n),[]),g.createElement("positionMesh",Ae({instance:o(),instanceKey:n,ref:n},t),e)}),Sm=g.forwardRef(({context:r,children:e,range:t,limit:i=1e3,frames:n=1/0,...s},o)=>{const[{localContext:a,instance:l}]=g.useState(()=>{const E=g.createContext(null);return{localContext:E,instance:g.forwardRef((v,x)=>g.createElement(_m,Ae({context:E},v,{ref:x})))}}),c=g.useRef(null);g.useImperativeHandle(o,()=>c.current,[]);const[u,h]=g.useState([]),[[f,d]]=g.useState(()=>{const E=new Float32Array(i*16);for(let v=0;v<i;v++)GD.identity().toArray(E,v*16);return[E,new Float32Array([...new Array(i*3)].map(()=>1))]});g.useEffect(()=>{c.current.instanceMatrix.needsUpdate=!0});let m=0,A=0;const p=g.useRef([]);g.useLayoutEffect(()=>{p.current=Object.entries(c.current.geometry.attributes).filter(([E,v])=>QD(v))}),He(()=>{if(n===1/0||m<n){c.current.updateMatrix(),c.current.updateMatrixWorld(),z1.copy(c.current.matrixWorld).invert(),A=Math.min(i,t!==void 0?t:i,u.length),c.current.count=A,bl(c.current.instanceMatrix,{start:0,count:A*16}),bl(c.current.instanceColor,{start:0,count:A*3});for(let E=0;E<u.length;E++){const v=u[E].current;v.matrixWorld.decompose(V1,K1,$1),H1.compose(V1,K1,$1).premultiply(z1),H1.toArray(f,E*16),c.current.instanceMatrix.needsUpdate=!0,v.color.toArray(d,E*3),c.current.instanceColor.needsUpdate=!0}m++}});const y=g.useMemo(()=>({getParent:()=>c,subscribe:E=>(h(v=>[...v,E]),()=>h(v=>v.filter(x=>x.current!==E.current)))}),[]);return g.createElement("instancedMesh",Ae({userData:{instances:u,limit:i,frames:n},matrixAutoUpdate:!1,ref:c,args:[null,null,0],raycast:()=>null},s),g.createElement("instancedBufferAttribute",{attach:"instanceMatrix",args:[f,16],usage:Ji}),g.createElement("instancedBufferAttribute",{attach:"instanceColor",args:[d,3],usage:Ji}),UD(e)?g.createElement(a.Provider,{value:y},e(l)):r?g.createElement(r.Provider,{value:y},e):g.createElement(W3.Provider,{value:y},e))}),BP=g.forwardRef(function({meshes:e,children:t,...i},n){const s=Array.isArray(e);if(!s)for(const l of Object.keys(e))e[l].isMesh||delete e[l];const o=l=>s?t(...l):t(Object.keys(e).filter(c=>e[c].isMesh).reduce((c,u,h)=>({...c,[u]:l[h]}),{})),a=(s?e:Object.values(e)).map(({geometry:l,material:c})=>g.createElement(Sm,Ae({key:l.uuid,geometry:l,material:c},i)));return g.createElement("group",{ref:n},j3(o,a))});function j3(r,e,t=[]){if(!e[0])return r(t);function i(n){return j3(r,e.slice(1),t.concat([n]))}return typeof e[0]=="function"?e[0]({results:t,render:i}):g.cloneElement(e[0],{children:i})}function RP(){const r=g.createContext(null);return[g.forwardRef((e,t)=>g.createElement(Sm,Ae({ref:t,context:r},e))),g.forwardRef((e,t)=>g.createElement(_m,Ae({ref:t,context:r},e)))]}const DP=g.forwardRef(({name:r,defaultValue:e,normalized:t,usage:i=Ji},n)=>{const s=g.useRef(null);g.useImperativeHandle(n,()=>s.current,[]),g.useLayoutEffect(()=>{const a=s.current.__r3f.parent.object;a.geometry.attributes[r]=s.current;const l=Array.isArray(e)?e:[e],c=Array.from({length:a.userData.limit},()=>l).flat();return s.current.array=new Float32Array(c),s.current.itemSize=l.length,s.current.count=c.length/s.current.itemSize,()=>{delete a.geometry.attributes[r]}},[r]);let o=0;return He(()=>{const a=s.current.__r3f.parent.object;if(a.userData.frames===1/0||o<a.userData.frames){for(let l=0;l<a.userData.instances.length;l++){const u=a.userData.instances[l].current[r];u!==void 0&&(s.current.set(Array.isArray(u)?u:typeof u.toArray=="function"?u.toArray():[u],l*s.current.itemSize),s.current.needsUpdate=!0)}o++}}),g.createElement("instancedBufferAttribute",{ref:s,usage:i,normalized:t})}),X3=g.createContext(null);function MP(){return g.useContext(X3)}function zD(r){return r!==null&&"meta"in r&&"frames"in r}const Y1=new nn(1,1),LP=g.forwardRef(({startFrame:r=0,endFrame:e,fps:t=30,frameName:i="",textureDataURL:n,textureImageURL:s,loop:o=!1,numberOfFrames:a=1,autoPlay:l=!0,animationNames:c,onStart:u,onEnd:h,onLoopEnd:f,onFrame:d,play:m,pause:A=!1,flipX:p=!1,alphaTest:y=0,children:E,asSprite:v=!1,offset:x,playBackwards:C=!1,resetOnEnd:I=!1,maxItems:_=1,instanceItems:S=[[0,0,0]],spriteDataset:b,canvasRenderingContext2DSettings:T,roundFramePosition:R=!1,meshProps:w={},...B},D)=>{const k=g.useRef(new tr),Q=g.useRef(null),Y=g.useRef(null),W=g.useRef(null),P=g.useRef(window.performance.now()),K=g.useRef(r),M=g.useRef(i),V=t>0?1e3/t:0,[$,G]=g.useState(new qi),O=g.useRef(0),[F,U]=g.useState(new z(1,1,1)),N=p?-1:1,Z=g.useRef(A),ie=g.useRef(x),q=g.useRef(!1),{spriteObj:ne,loadJsonAndTexture:ye}=Em(null,null,c,a,void 0,T),ve=g.useRef(i),re=g.useCallback((Ce,_e)=>{if(_e===null)a&&(O.current=a,C&&(K.current=a-1),Q.current=_e);else{var Be,Se;Q.current=_e,Q.current&&Array.isArray(Q.current.frames)?O.current=Q.current.frames.length:Q.current&&typeof Q.current=="object"&&ve.current?O.current=Q.current.frames[ve.current].length:O.current=0,C&&(K.current=O.current-1);const{w:Ve,h:Me}=Iu((Be=(Se=Q.current)==null?void 0:Se.frames)!==null&&Be!==void 0?Be:[],ve.current).sourceSize,Ne=ae(Ve,Me);U(Ne),Y.current&&(Y.current.map=Ce)}G(Ce)},[a,C]),se=g.useCallback(()=>{if(!Q.current)return;const{meta:{size:Ce},frames:_e}=Q.current,{w:Be,h:Se}=Array.isArray(_e)?_e[0].sourceSize:i?_e[i]?_e[i][0].sourceSize:{w:0,h:0}:{w:0,h:0};Y.current&&Y.current.map&&(Y.current.map.wrapS=Y.current.map.wrapT=Pn,Y.current.map.center.set(0,0),Y.current.map.repeat.set(1*N/(Ce.w/Be),1/(Ce.h/Se)));const Me=1/((Ce.h-1)/Se);Y.current&&Y.current.map&&(Y.current.map.offset.x=0,Y.current.map.offset.y=1-Me),u&&u({currentFrameName:i??"",currentFrame:K.current})},[N,i,u]),he=g.useMemo(()=>({current:ie.current,offset:ie.current,imageUrl:s,hasEnded:!1,ref:D}),[s,D]);g.useImperativeHandle(D,()=>k.current,[]),g.useLayoutEffect(()=>{ie.current=x},[x]);const ae=(Ce,_e)=>{var Be;const Se=new z,Ve=_e/Ce;return Se.set(1,Ve,1),(Be=W.current)==null||Be.scale.copy(Se),Se};g.useEffect(()=>{if(b){var Ce;re(b==null||(Ce=b.spriteTexture)==null?void 0:Ce.clone(),b.spriteData)}else s&&n&&ye(s,n)},[ye,b,n,s,re]),g.useEffect(()=>{if(ne){var Ce;re(ne==null||(Ce=ne.spriteTexture)==null?void 0:Ce.clone(),ne==null?void 0:ne.spriteData)}},[ne,re]),g.useEffect(()=>{if(he.hasEnded=!1,Q.current&&C===!0){var Ce;K.current=((Ce=Q.current.frames.length)!==null&&Ce!==void 0?Ce:0)-1}else K.current=0},[C,he]),g.useLayoutEffect(()=>{se()},[$,p,se]),g.useEffect(()=>{l&&(Z.current=!1)},[l]),g.useLayoutEffect(()=>{if(M.current!==i&&i&&(K.current=0,M.current=i,he.hasEnded=!1,V<=0&&(K.current=e||r||0),Q.current)){const{w:Ce,h:_e}=Iu(Q.current.frames,i).sourceSize,Be=ae(Ce,_e);U(Be)}},[i,V,he,e,r]);const J=()=>{if(!zD(Q.current))return;const{meta:{size:Ce},frames:_e}=Q.current,{w:Be,h:Se}=Iu(_e,i).sourceSize,Ve=Array.isArray(_e)?_e:i?_e[i]:[],Me=e||Ve.length-1;var Ne=x===void 0?he.current:x;if(V<=0){K.current=e||r||0,X(Be,Se,Ce,Ve);return}const Ge=window.performance.now(),je=Ge-P.current;if(!(je<=V)){var st=C?K.current<0:K.current>Me,At=C?K.current===Me:K.current===0,it=C?K.current<0:K.current>=Me;if(st){if(K.current=o?r??0:0,C&&(K.current=Me),o?f==null||f({currentFrameName:i??"",currentFrame:K.current}):(h==null||h({currentFrameName:i??"",currentFrame:K.current}),he.hasEnded=!I,I&&(Z.current=!0)),!o)return}else At&&(u==null||u({currentFrameName:i??"",currentFrame:K.current}));Ne!==void 0&&it?q.current===!1&&(h==null||h({currentFrameName:i??"",currentFrame:K.current}),q.current=!0):q.current=!1,!(je<=V)&&(P.current=Ge-je%V,X(Be,Se,Ce,Ve))}},X=(Ce,_e,Be,Se)=>{var Ve=x===void 0?he.current:x;const Me=K.current;let Ne=0,Ge=0;ae(Ce,_e);const je=R?Math.round((Be.w-1)/Ce):(Be.w-1)/Ce,st=R?Math.round((Be.h-1)/_e):(Be.h-1)/_e;if(!Se[Me])return;const{frame:{x:At,y:it},sourceSize:{w:Xe,h:We}}=Se[Me],te=1/je,Te=1/st;if(Y.current&&Y.current.map&&(Ne=N>0?te*(At/Xe):te*(At/Xe)-Y.current.map.repeat.x,Ge=Math.abs(1-Te)-Te*(it/We),Y.current.map.offset.x=Ne,Y.current.map.offset.y=Ge),Ve!=null){let Le=Math.floor(Ve*Se.length);Le=Math.max(0,Math.min(Le,Se.length-1)),isNaN(Le)&&(Le=0),K.current=Le}else C?K.current-=1:K.current+=1};He((Ce,_e)=>{var Be,Se;!((Be=Q.current)!=null&&Be.frames)||!((Se=Y.current)!=null&&Se.map)||Z.current||!he.hasEnded&&(l||m)&&(J(),d==null||d({currentFrameName:M.current,currentFrame:K.current}))});function oe(Ce=new z(1,1,1),_e=1){if(typeof _e=="number")return Ce.multiplyScalar(_e);if(Array.isArray(_e))return Ce.multiply(new z(..._e));if(_e instanceof z)return Ce.multiply(_e)}return g.createElement("group",Ae({},B,{ref:k,scale:oe(F,B.scale)}),g.createElement(X3.Provider,{value:he},v&&g.createElement(m5,null,g.createElement("mesh",Ae({ref:W,scale:1,geometry:Y1},w),g.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:xi,ref:Y,map:$,transparent:!0,alphaTest:y??0}))),!v&&g.createElement(Sm,Ae({geometry:Y1,limit:_??1},w),g.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:xi,ref:Y,map:$,transparent:!0,alphaTest:y??0}),(S??[0]).map((Ce,_e)=>g.createElement(_m,Ae({key:_e,ref:(S==null?void 0:S.length)===1?W:null,position:Ce,scale:1},w)))),E))}),PP=g.forwardRef(({children:r,curve:e},t)=>{const[i]=g.useState(()=>new Mr),[n,s]=g.useState(),o=g.useRef(null);return g.useLayoutEffect(()=>{o.current=new n_(i.children[0]),s(o.current.object3D)},[r]),g.useEffect(()=>{var a;e&&((a=o.current)==null||a.updateCurve(0,e))},[e]),g.useImperativeHandle(t,()=>o.current),g.createElement(g.Fragment,null,so(r,i),n&&g.createElement("primitive",{object:n}))});var HD=`#define GLSLIFY 1
vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;class VD extends Zn{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`
      uniform float time;
      uniform float radius;
      uniform float distort;
      ${HD}
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`
        float updateTime = time / 50.0;
        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));
        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));
        `)}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const FP=g.forwardRef(({speed:r=1,...e},t)=>{const[i]=g.useState(()=>new VD);return He(n=>i&&(i.time=n.clock.elapsedTime*r)),g.createElement("primitive",Ae({object:i,ref:t,attach:"material"},e))});class KD extends $u{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`
      uniform float time;
      uniform float factor;
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`float theta = sin( time + position.y ) / 2.0 * factor;
        float c = cos( theta );
        float s = sin( theta );
        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );
        vec3 transformed = vec3( position ) * m;
        vNormal = vNormal * m;`)}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const kP=g.forwardRef(({speed:r=1,...e},t)=>{const[i]=g.useState(()=>new KD);return He(n=>i&&(i.time=n.clock.elapsedTime*r)),g.createElement("primitive",Ae({object:i,ref:t,attach:"material"},e))});class $D extends gi{constructor(e=new De){super({uniforms:{inputBuffer:new mn(null),depthBuffer:new mn(null),resolution:new mn(new De),texelSize:new mn(new De),halfTexelSize:new mn(new De),kernel:new mn(0),scale:new mn(1),cameraNear:new mn(0),cameraFar:new mn(1),minDepthThreshold:new mn(0),maxDepthThreshold:new mn(1),depthScale:new mn(0),depthToBlurRatioBias:new mn(.25)},fragmentShader:`#include <common>
        #include <dithering_pars_fragment>      
        uniform sampler2D inputBuffer;
        uniform sampler2D depthBuffer;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          float depthFactor = 0.0;
          
          #ifdef USE_DEPTH
            vec4 depth = texture2D(depthBuffer, vUv);
            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
            depthFactor *= depthScale;
            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));
          #endif
          
          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));
          gl_FragColor = sum * 0.25 ;

          #include <dithering_fragment>
          #include <tonemapping_fragment>
          #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
        }`,vertexShader:`uniform vec2 texelSize;
        uniform vec2 halfTexelSize;
        uniform float kernel;
        uniform float scale;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          vec2 uv = position.xy * 0.5 + 0.5;
          vUv = uv;

          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;
          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);
          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);
          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);
          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);

          gl_Position = vec4(position.xy, 1.0, 1.0);
        }`,blending:T0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class YD{constructor({gl:e,resolution:t,width:i=500,height:n=500,minDepthThreshold:s=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:l=.25}){this.renderToScreen=!1,this.renderTargetA=new Ti(t,t,{minFilter:Ht,magFilter:Ht,stencilBuffer:!1,depthBuffer:!1,type:fi}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new $D,this.convolutionMaterial.setTexelSize(1/i,1/n),this.convolutionMaterial.setResolution(new De(i,n)),this.scene=new Mr,this.camera=new u2,this.convolutionMaterial.uniforms.minDepthThreshold.value=s,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=l,this.convolutionMaterial.defines.USE_DEPTH=a>0;const c=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),u=new Float32Array([0,0,2,0,0,2]),h=new ki;h.setAttribute("position",new Nt(c,3)),h.setAttribute("uv",new Nt(u,2)),this.screen=new Qe(h,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,i){const n=this.scene,s=this.camera,o=this.renderTargetA,a=this.renderTargetB;let l=this.convolutionMaterial,c=l.uniforms;c.depthBuffer.value=t.depthTexture;const u=l.kernel;let h=t,f,d,m;for(d=0,m=u.length-1;d<m;++d)f=d&1?a:o,c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(f),e.render(n,s),h=f;c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(n,s)}}let WD=class extends $u{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;(t=e.defines)!=null&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`
        uniform mat4 textureMatrix;
        varying vec4 my_vUv;
      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
        my_vUv = textureMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );`),e.fragmentShader=`
        uniform sampler2D tDiffuse;
        uniform sampler2D tDiffuseBlur;
        uniform sampler2D tDepth;
        uniform sampler2D distortionMap;
        uniform float distortion;
        uniform float cameraNear;
			  uniform float cameraFar;
        uniform bool hasBlur;
        uniform float mixBlur;
        uniform float mirror;
        uniform float mixStrength;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float mixContrast;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec4 my_vUv;
        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>

      float distortionFactor = 0.0;
      #ifdef USE_DISTORTION
        distortionFactor = texture2D(distortionMap, vUv).r * distortion;
      #endif

      vec4 new_vUv = my_vUv;
      new_vUv.x += distortionFactor;
      new_vUv.y += distortionFactor;

      vec4 base = texture2DProj(tDiffuse, new_vUv);
      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);

      vec4 merge = base;

      #ifdef USE_NORMALMAP
        vec2 normal_uv = vec2(0.0);
        vec4 normalColor = texture2D(normalMap, vUv * normalScale);
        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );
        vec3 coord = new_vUv.xyz / new_vUv.w;
        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;
        vec4 base_normal = texture2D(tDiffuse, normal_uv);
        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);
        merge = base_normal;
        blur = blur_normal;
      #endif

      float depthFactor = 0.0001;
      float blurFactor = 0.0;

      #ifdef USE_DEPTH
        vec4 depth = texture2DProj(tDepth, new_vUv);
        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
        depthFactor *= depthScale;
        depthFactor = max(0.0001, min(1.0, depthFactor));

        #ifdef USE_BLUR
          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);
          merge = merge * min(1.0, depthFactor + 0.5);
        #else
          merge = merge * depthFactor;
        #endif

      #endif

      float reflectorRoughnessFactor = roughness;
      #ifdef USE_ROUGHNESSMAP
        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );
        reflectorRoughnessFactor *= reflectorTexelRoughness.g;
      #endif

      #ifdef USE_BLUR
        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);
        merge = mix(merge, blur, blurFactor);
      #endif

      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);
      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;
      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;
      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;

      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);
      `)}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}};const UP=g.forwardRef(({mixBlur:r=0,mixStrength:e=1,resolution:t=256,blur:i=[0,0],minDepthThreshold:n=.9,maxDepthThreshold:s=1,depthScale:o=0,depthToBlurRatioBias:a=.25,mirror:l=0,distortion:c=1,mixContrast:u=1,distortionMap:h,reflectorOffset:f=0,...d},m)=>{Ii({MeshReflectorMaterialImpl:WD});const A=le(({gl:$})=>$),p=le(({camera:$})=>$),y=le(({scene:$})=>$);i=Array.isArray(i)?i:[i,i];const E=i[0]+i[1]>0,v=i[0],x=i[1],C=g.useRef(null);g.useImperativeHandle(m,()=>C.current,[]);const[I]=g.useState(()=>new or),[_]=g.useState(()=>new z),[S]=g.useState(()=>new z),[b]=g.useState(()=>new z),[T]=g.useState(()=>new we),[R]=g.useState(()=>new z(0,0,-1)),[w]=g.useState(()=>new Ci),[B]=g.useState(()=>new z),[D]=g.useState(()=>new z),[k]=g.useState(()=>new Ci),[Q]=g.useState(()=>new we),[Y]=g.useState(()=>new jt),W=g.useCallback(()=>{var $;const G=C.current.parent||(($=C.current)==null||($=$.__r3f.parent)==null?void 0:$.object);if(!G||(S.setFromMatrixPosition(G.matrixWorld),b.setFromMatrixPosition(p.matrixWorld),T.extractRotation(G.matrixWorld),_.set(0,0,1),_.applyMatrix4(T),S.addScaledVector(_,f),B.subVectors(S,b),B.dot(_)>0))return;B.reflect(_).negate(),B.add(S),T.extractRotation(p.matrixWorld),R.set(0,0,-1),R.applyMatrix4(T),R.add(b),D.subVectors(S,R),D.reflect(_).negate(),D.add(S),Y.position.copy(B),Y.up.set(0,1,0),Y.up.applyMatrix4(T),Y.up.reflect(_),Y.lookAt(D),Y.far=p.far,Y.updateMatrixWorld(),Y.projectionMatrix.copy(p.projectionMatrix),Q.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),Q.multiply(Y.projectionMatrix),Q.multiply(Y.matrixWorldInverse),Q.multiply(G.matrixWorld),I.setFromNormalAndCoplanarPoint(_,S),I.applyMatrix4(Y.matrixWorldInverse),w.set(I.normal.x,I.normal.y,I.normal.z,I.constant);const O=Y.projectionMatrix;k.x=(Math.sign(w.x)+O.elements[8])/O.elements[0],k.y=(Math.sign(w.y)+O.elements[9])/O.elements[5],k.z=-1,k.w=(1+O.elements[10])/O.elements[14],w.multiplyScalar(2/w.dot(k)),O.elements[2]=w.x,O.elements[6]=w.y,O.elements[10]=w.z+1,O.elements[14]=w.w},[p,f]),[P,K,M,V]=g.useMemo(()=>{const $={minFilter:Ht,magFilter:Ht,type:fi},G=new Ti(t,t,$);G.depthBuffer=!0,G.depthTexture=new R0(t,t),G.depthTexture.format=c2,G.depthTexture.type=L0;const O=new Ti(t,t,$),F=new YD({gl:A,resolution:t,width:v,height:x,minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a}),U={mirror:l,textureMatrix:Q,mixBlur:r,tDiffuse:G.texture,tDepth:G.depthTexture,tDiffuseBlur:O.texture,hasBlur:E,mixStrength:e,minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a,distortion:c,distortionMap:h,mixContrast:u,"defines-USE_BLUR":E?"":void 0,"defines-USE_DEPTH":o>0?"":void 0,"defines-USE_DISTORTION":h?"":void 0};return[G,O,F,U]},[A,v,x,Q,t,l,E,r,e,n,s,o,a,c,h,u]);return He(()=>{var $;const G=C.current.parent||(($=C.current)==null||($=$.__r3f.parent)==null?void 0:$.object);if(!G)return;G.visible=!1;const O=A.xr.enabled,F=A.shadowMap.autoUpdate;W(),A.xr.enabled=!1,A.shadowMap.autoUpdate=!1,A.setRenderTarget(P),A.state.buffers.depth.setMask(!0),A.autoClear||A.clear(),A.render(y,Y),E&&M.render(A,P,K),A.xr.enabled=O,A.shadowMap.autoUpdate=F,G.visible=!0,A.setRenderTarget(null)}),g.createElement("meshReflectorMaterialImpl",Ae({attach:"material",key:"key"+V["defines-USE_BLUR"]+V["defines-USE_DEPTH"]+V["defines-USE_DISTORTION"],ref:C},V,d))}),jD=ps({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new $3,color:new Ye("white"),opacity:1,resolution:new De,viewMatrixInverse:new we,projectionMatrixInverse:new we},`
  uniform mat4 viewMatrixInverse;

  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_vertex>

  void main() {
    #include <color_vertex>

    vec4 transformedNormal = vec4(normal, 0.0);
    vec4 transformedPosition = vec4(position, 1.0);
    #ifdef USE_INSTANCING
      transformedNormal = instanceMatrix * transformedNormal;
      transformedPosition = instanceMatrix * transformedPosition;
    #endif

    #ifdef USE_INSTANCING
      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);
    #else
      vModelMatrixInverse = inverse(modelMatrix);
    #endif

    vWorldPosition = (modelMatrix * transformedPosition).xyz;
    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;
  }`,`
  #define ENVMAP_TYPE_CUBE_UV
  precision highp isampler2D;
  precision highp usampler2D;
  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    uniform samplerCube envMap;
  #else
    uniform sampler2D envMap;
  #endif

  uniform float bounces;
  ${TD}
  ${bD}
  uniform BVH bvh;
  uniform float ior;
  uniform bool correctMips;
  uniform vec2 resolution;
  uniform float fresnel;
  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrixInverse;
  uniform mat4 viewMatrixInverse;
  uniform float aberrationStrength;
  uniform vec3 color;
  uniform float opacity;

  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {
    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );
  }

  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {
    vec3 rayOrigin = ro;
    vec3 rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = vWorldPosition + rayDirection * 0.001;
    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;
    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);
    for(float i = 0.0; i < bounces; i++) {
      uvec4 faceIndices = uvec4( 0u );
      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );
      vec3 barycoord = vec3( 0.0 );
      float side = 1.0;
      float dist = 0.0;
      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );
      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);
      vec3 tempDir = refract(rayDirection, faceNormal, ior);
      if (length(tempDir) != 0.0) {
        rayDirection = tempDir;
        break;
      }
      rayDirection = reflect(rayDirection, faceNormal);
      rayOrigin = hitPos + rayDirection * 0.01;
    }
    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);
    return rayDirection;
  }

  #include <common>
  #include <cube_uv_reflection_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));
    }
  #else
    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      vec2 uvv = equirectUv( rayDirection );
      vec2 smoothUv = equirectUv( directionCamPerfect );
      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));
    }
  #endif

  void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;
    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;
    directionCamPerfect = normalize(directionCamPerfect);
    vec3 normal = vNormal;
    vec3 rayOrigin = cameraPosition;
    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);

    vec4 diffuseColor = vec4(color, opacity);
    #include <color_fragment>

    #ifdef CHROMATIC_ABERRATIONS
      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      #ifdef FAST_CHROMA
        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));
        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));
      #else
        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);
        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);
      #endif
      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;
      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;
      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;
      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);
    #else
      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;
    #endif

    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);
    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;
    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);

    #include <tonemapping_fragment>
    #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
  }`),XD=r=>r&&r.isCubeTexture;function NP({aberrationStrength:r=0,fastChroma:e=!0,envMap:t,...i}){Ii({MeshRefractionMaterial:jD});const n=g.useRef(null),{size:s}=le(),o=g.useMemo(()=>{var a,l;const c={},u=XD(t),f=((a=u?(l=t.image[0])==null?void 0:l.width:t.image.width)!==null&&a!==void 0?a:1024)/4,d=Math.floor(Math.log2(f)),m=Math.pow(2,d),A=3*Math.max(m,16*7),p=4*m;return u&&(c.ENVMAP_TYPE_CUBEM=""),c.CUBEUV_TEXEL_WIDTH=`${1/A}`,c.CUBEUV_TEXEL_HEIGHT=`${1/p}`,c.CUBEUV_MAX_MIP=`${d}.0`,r>0&&(c.CHROMATIC_ABERRATIONS=""),e&&(c.FAST_CHROMA=""),c},[r,e]);return g.useLayoutEffect(()=>{var a;const l=(a=n.current)==null||(a=a.__r3f)==null||(a=a.parent)==null||(a=a.object)==null?void 0:a.geometry;l&&(n.current.bvh=new $3,n.current.bvh.updateFrom(new mh(l.clone().toNonIndexed(),{strategy:hh})))},[]),He(({camera:a})=>{n.current.viewMatrixInverse=a.matrixWorld,n.current.projectionMatrixInverse=a.projectionMatrixInverse}),g.createElement("meshRefractionMaterial",Ae({key:JSON.stringify(o),defines:o,ref:n,resolution:[s.width,s.height],aberrationStrength:r,envMap:t},i))}const Tm=ps({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }");class qD extends Zn{constructor(e=6,t=!1){super(),this.uniforms={chromaticAberration:{value:.05},transmission:{value:0},_transmission:{value:1},transmissionMap:{value:null},roughness:{value:0},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:1/0},attenuationColor:{value:new Ye("white")},anisotropicBlur:{value:.1},time:{value:0},distortion:{value:0},distortionScale:{value:.5},temporalDistortion:{value:0},buffer:{value:null}},this.onBeforeCompile=i=>{i.uniforms={...i.uniforms,...this.uniforms},this.anisotropy>0&&(i.defines.USE_ANISOTROPY=""),t?i.defines.USE_SAMPLER="":i.defines.USE_TRANSMISSION="",i.fragmentShader=`
      uniform float chromaticAberration;         
      uniform float anisotropicBlur;      
      uniform float time;
      uniform float distortion;
      uniform float distortionScale;
      uniform float temporalDistortion;
      uniform sampler2D buffer;

      vec3 random3(vec3 c) {
        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));
        vec3 r;
        r.z = fract(512.0*j);
        j *= .125;
        r.x = fract(512.0*j);
        j *= .125;
        r.y = fract(512.0*j);
        return r-0.5;
      }

      uint hash( uint x ) {
        x += ( x << 10u );
        x ^= ( x >>  6u );
        x += ( x <<  3u );
        x ^= ( x >> 11u );
        x += ( x << 15u );
        return x;
      }

      // Compound versions of the hashing algorithm I whipped together.
      uint hash( uvec2 v ) { return hash( v.x ^ hash(v.y)                         ); }
      uint hash( uvec3 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z)             ); }
      uint hash( uvec4 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z) ^ hash(v.w) ); }

      // Construct a float with half-open range [0:1] using low 23 bits.
      // All zeroes yields 0.0, all ones yields the next smallest representable value below 1.0.
      float floatConstruct( uint m ) {
        const uint ieeeMantissa = 0x007FFFFFu; // binary32 mantissa bitmask
        const uint ieeeOne      = 0x3F800000u; // 1.0 in IEEE binary32
        m &= ieeeMantissa;                     // Keep only mantissa bits (fractional part)
        m |= ieeeOne;                          // Add fractional part to 1.0
        float  f = uintBitsToFloat( m );       // Range [1:2]
        return f - 1.0;                        // Range [0:1]
      }

      // Pseudo-random value in half-open range [0:1].
      float randomBase( float x ) { return floatConstruct(hash(floatBitsToUint(x))); }
      float randomBase( vec2  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec3  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec4  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float rand(float seed) {
        float result = randomBase(vec3(gl_FragCoord.xy, seed));
        return result;
      }

      const float F3 =  0.3333333;
      const float G3 =  0.1666667;

      float snoise(vec3 p) {
        vec3 s = floor(p + dot(p, vec3(F3)));
        vec3 x = p - s + dot(s, vec3(G3));
        vec3 e = step(vec3(0.0), x - x.yzx);
        vec3 i1 = e*(1.0 - e.zxy);
        vec3 i2 = 1.0 - e.zxy*(1.0 - e);
        vec3 x1 = x - i1 + G3;
        vec3 x2 = x - i2 + 2.0*G3;
        vec3 x3 = x - 1.0 + 3.0*G3;
        vec4 w, d;
        w.x = dot(x, x);
        w.y = dot(x1, x1);
        w.z = dot(x2, x2);
        w.w = dot(x3, x3);
        w = max(0.6 - w, 0.0);
        d.x = dot(random3(s), x);
        d.y = dot(random3(s + i1), x1);
        d.z = dot(random3(s + i2), x2);
        d.w = dot(random3(s + 1.0), x3);
        w *= w;
        w *= w;
        d *= w;
        return dot(d, vec4(52.0));
      }

      float snoiseFractal(vec3 m) {
        return 0.5333333* snoise(m)
              +0.2666667* snoise(2.0*m)
              +0.1333333* snoise(4.0*m)
              +0.0666667* snoise(8.0*m);
      }
`+i.fragmentShader,i.fragmentShader=i.fragmentShader.replace("#include <transmission_pars_fragment>",`
        #ifdef USE_TRANSMISSION
          // Transmission code is based on glTF-Sampler-Viewer
          // https://github.com/KhronosGroup/glTF-Sample-Viewer
          uniform float _transmission;
          uniform float thickness;
          uniform float attenuationDistance;
          uniform vec3 attenuationColor;
          #ifdef USE_TRANSMISSIONMAP
            uniform sampler2D transmissionMap;
          #endif
          #ifdef USE_THICKNESSMAP
            uniform sampler2D thicknessMap;
          #endif
          uniform vec2 transmissionSamplerSize;
          uniform sampler2D transmissionSamplerMap;
          uniform mat4 modelMatrix;
          uniform mat4 projectionMatrix;
          varying vec3 vWorldPosition;
          vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
            // Direction of refracted light.
            vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
            // Compute rotation-independant scaling of the model matrix.
            vec3 modelScale;
            modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
            modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
            modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
            // The thickness is specified in local space.
            return normalize( refractionVector ) * thickness * modelScale;
          }
          float applyIorToRoughness( const in float roughness, const in float ior ) {
            // Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and
            // an IOR of 1.5 results in the default amount of microfacet refraction.
            return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
          }
          vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
            float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );            
            #ifdef USE_SAMPLER
              #ifdef texture2DLodEXT
                return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #else
                return texture2D(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #endif
            #else
              return texture2D(buffer, fragCoord.xy);
            #endif
          }
          vec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
            if ( isinf( attenuationDistance ) ) {
              // Attenuation distance is +∞, i.e. the transmitted color is not attenuated at all.
              return radiance;
            } else {
              // Compute light attenuation using Beer's law.
              vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
              vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law
              return transmittance * radiance;
            }
          }
          vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
            const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
            const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
            const in vec3 attenuationColor, const in float attenuationDistance ) {
            vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
            vec3 refractedRayExit = position + transmissionRay;
            // Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
            vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
            vec2 refractionCoords = ndcPos.xy / ndcPos.w;
            refractionCoords += 1.0;
            refractionCoords /= 2.0;
            // Sample framebuffer to get pixel the refracted ray hits.
            vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
            vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
            // Get the specular component.
            vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
            return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
          }
        #endif
`),i.fragmentShader=i.fragmentShader.replace("#include <transmission_fragment>",`  
        // Improve the refraction to use the world pos
        material.transmission = _transmission;
        material.transmissionAlpha = 1.0;
        material.thickness = thickness;
        material.attenuationDistance = attenuationDistance;
        material.attenuationColor = attenuationColor;
        #ifdef USE_TRANSMISSIONMAP
          material.transmission *= texture2D( transmissionMap, vUv ).r;
        #endif
        #ifdef USE_THICKNESSMAP
          material.thickness *= texture2D( thicknessMap, vUv ).g;
        #endif
        
        vec3 pos = vWorldPosition;
        float runningSeed = 0.0;
        vec3 v = normalize( cameraPosition - pos );
        vec3 n = inverseTransformDirection( normal, viewMatrix );
        vec3 transmission = vec3(0.0);
        float transmissionR, transmissionB, transmissionG;
        float randomCoords = rand(runningSeed++);
        float thickness_smear = thickness * max(pow(roughnessFactor, 0.33), anisotropicBlur);
        vec3 distortionNormal = vec3(0.0);
        vec3 temporalOffset = vec3(time, -time, -time) * temporalDistortion;
        if (distortion > 0.0) {
          distortionNormal = distortion * vec3(snoiseFractal(vec3((pos * distortionScale + temporalOffset))), snoiseFractal(vec3(pos.zxy * distortionScale - temporalOffset)), snoiseFractal(vec3(pos.yxz * distortionScale + temporalOffset)));
        }
        for (float i = 0.0; i < ${e}.0; i ++) {
          vec3 sampleNorm = normalize(n + roughnessFactor * roughnessFactor * 2.0 * normalize(vec3(rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5)) * pow(rand(runningSeed++), 0.33) + distortionNormal);
          transmissionR = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness  + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).r;
          transmissionG = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior  * (1.0 + chromaticAberration * (i + randomCoords) / float(${e})) , material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).g;
          transmissionB = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior * (1.0 + 2.0 * chromaticAberration * (i + randomCoords) / float(${e})), material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).b;
          transmission.r += transmissionR;
          transmission.g += transmissionG;
          transmission.b += transmissionB;
        }
        transmission /= ${e}.0;
        totalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );
`)},Object.keys(this.uniforms).forEach(i=>Object.defineProperty(this,i,{get:()=>this.uniforms[i].value,set:n=>this.uniforms[i].value=n}))}}const GP=g.forwardRef(({buffer:r,transmissionSampler:e=!1,backside:t=!1,side:i=Rl,transmission:n=1,thickness:s=0,backsideThickness:o=0,backsideEnvMapIntensity:a=1,samples:l=10,resolution:c,backsideResolution:u,background:h,anisotropy:f,anisotropicBlur:d,...m},A)=>{Ii({MeshTransmissionMaterial:qD});const p=g.useRef(null),[y]=g.useState(()=>new Tm),E=gn(u||c),v=gn(c);let x,C,I,_;return He(S=>{if(p.current.time=S.clock.elapsedTime,p.current.buffer===v.texture&&!e){var b;_=(b=p.current.__r3f.parent)==null?void 0:b.object,_&&(I=S.gl.toneMapping,x=S.scene.background,C=p.current.envMapIntensity,S.gl.toneMapping=mC,h&&(S.scene.background=h),_.material=y,t&&(S.gl.setRenderTarget(E),S.gl.render(S.scene,S.camera),_.material=p.current,_.material.buffer=E.texture,_.material.thickness=o,_.material.side=ma,_.material.envMapIntensity=a),S.gl.setRenderTarget(v),S.gl.render(S.scene,S.camera),_.material=p.current,_.material.thickness=s,_.material.side=i,_.material.buffer=v.texture,_.material.envMapIntensity=C,S.scene.background=x,S.gl.setRenderTarget(null),S.gl.toneMapping=I)}}),g.useImperativeHandle(A,()=>p.current,[]),g.createElement("meshTransmissionMaterial",Ae({args:[l,e],ref:p},m,{buffer:r||v.texture,_transmission:n,anisotropicBlur:d??f,transmission:e?n:0,thickness:s,side:i}))}),QP=g.forwardRef((r,e)=>(Ii({DiscardMaterialImpl:Tm}),g.createElement("discardMaterialImpl",Ae({ref:e},r))));function zP(r){const e=g.useRef(null);return g.useLayoutEffect(()=>{const t=e.current.parent,i=t==null?void 0:t.geometry;if(i){const n=t.material;t.material=e.current.__r3f.children.map(o=>o.object);const s=[...i.groups];return i.clearGroups(),t.material.forEach((o,a)=>{a<t.material.length-1&&(o.depthWrite=!1),i.addGroup(0,1/0,a)}),()=>{t.material=n,i.groups=s}}}),g.createElement("group",Ae({ref:e},r))}const nd=Zi>=154?"opaque_fragment":"output_fragment";class JD extends $y{constructor(e){super(e),this.onBeforeCompile=(t,i)=>{const{isWebGL2:n}=i.capabilities;t.fragmentShader=t.fragmentShader.replace(`#include <${nd}>`,`
        ${n?`#include <${nd}>`:`#extension GL_OES_standard_derivatives : enable
#include <${nd}>`}
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      float r = dot(cxy, cxy);
      float delta = fwidth(r);     
      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );
      #include <tonemapping_fragment>
      #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
      `)}}}const HP=g.forwardRef((r,e)=>{const[t]=g.useState(()=>new JD(null));return g.createElement("primitive",Ae({},r,{object:t,ref:e,attach:"material"}))}),ZD=({focus:r=0,size:e=25,samples:t=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${e})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${r});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${t}; i ++) {
    offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${t}; i++) {
    vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${e}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${t}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function W1(r,e,t){e.traverse(i=>{i.material&&(r.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),r.info.programs.length=0,r.compile(e,t)}function VP({focus:r=0,samples:e=10,size:t=25}){const i=le(o=>o.gl),n=le(o=>o.scene),s=le(o=>o.camera);return g.useEffect(()=>{const o=Xo.shadowmap_pars_fragment;return Xo.shadowmap_pars_fragment=Xo.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+ZD({size:t,samples:e,focus:r})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),W1(i,n,s),()=>{Xo.shadowmap_pars_fragment=o,W1(i,n,s)}},[r,t,e]),null}function Ui(r,e){const t=r+"Geometry";return g.forwardRef(({args:i,children:n,...s},o)=>{const a=g.useRef(null);return g.useImperativeHandle(o,()=>a.current),g.useLayoutEffect(()=>void(e==null?void 0:e(a.current))),g.createElement("mesh",Ae({ref:a},s),g.createElement(t,{attach:"geometry",args:i}),n)})}const KP=Ui("box"),$P=Ui("circle"),YP=Ui("cone"),WP=Ui("cylinder"),jP=Ui("sphere"),XP=Ui("plane"),qP=Ui("tube"),JP=Ui("torus"),ZP=Ui("torusKnot"),eF=Ui("tetrahedron"),tF=Ui("ring"),iF=Ui("polyhedron"),nF=Ui("icosahedron"),sF=Ui("octahedron"),rF=Ui("dodecahedron"),oF=Ui("extrude"),aF=Ui("lathe"),lF=Ui("capsule"),cF=Ui("shape",({geometry:r})=>{const e=r.attributes.position,t=new Yt().setFromBufferAttribute(e),i=new z;t.getSize(i);const n=[];let s=0,o=0,a=0,l=0;for(let c=0;c<e.count;c++)s=e.getX(c),o=e.getY(c),a=(s-t.min.x)/i.x,l=(o-t.min.y)/i.y,n.push(a,l);r.setAttribute("uv",new Vi(n,2))}),Ss=1e-5;function e7(r,e,t){const i=new Zy,n=t-Ss;return i.absarc(Ss,Ss,Ss,-Math.PI/2,-Math.PI,!0),i.absarc(Ss,e-n*2,Ss,Math.PI,Math.PI/2,!0),i.absarc(r-n*2,e-n*2,Ss,Math.PI/2,0,!0),i.absarc(r-n*2,Ss,Ss,0,-Math.PI/2,!0),i}const uF=g.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:s=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:l=.4,children:c,...u},h){return g.createElement("mesh",Ae({ref:h},u),g.createElement(t7,{args:[e,t,i],radius:n,steps:s,smoothness:o,bevelSegments:a,creaseAngle:l}),c)}),t7=g.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:s=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:l=.4,...c},u){const h=g.useMemo(()=>e7(e,t,n),[e,t,n]),f=g.useMemo(()=>({depth:i-n*2,bevelEnabled:!0,bevelSegments:a*2,steps:s,bevelSize:n-Ss,bevelThickness:n,curveSegments:o}),[i,n,o,a,s]),d=g.useRef(null);return g.useLayoutEffect(()=>{d.current&&(d.current.center(),O2(d.current,l))},[h,f,l]),g.useImperativeHandle(u,()=>d.current),g.createElement("extrudeGeometry",Ae({ref:d,args:[h,f]},c))});function i7(){const r=new ki,e=new Float32Array([-1,-1,3,-1,-1,3]);return r.boundingSphere=new on,r.boundingSphere.set(new z,1/0),r.setAttribute("position",new Nt(e,2)),r}const hF=g.forwardRef(function({children:e,...t},i){const n=g.useMemo(i7,[]);return g.createElement("mesh",Ae({ref:i,geometry:n,frustumCulled:!1},t),e)}),fF=g.forwardRef(({children:r,width:e,height:t,depth:i,box3:n,precise:s=!0,...o},a)=>{const l=g.useRef(null),c=g.useRef(null),u=g.useRef(null);return g.useLayoutEffect(()=>{c.current.matrixWorld.identity();let h=n||new Yt().setFromObject(u.current,s);const f=h.max.x-h.min.x,d=h.max.y-h.min.y,m=h.max.z-h.min.z;let A=Math.max(f,d,m);e&&(A=f),t&&(A=d),i&&(A=m),c.current.scale.setScalar(1/A)},[e,t,i,n,s]),g.useImperativeHandle(a,()=>l.current,[]),g.createElement("group",Ae({ref:l},o),g.createElement("group",{ref:c},g.createElement("group",{ref:u},r)))});var Qn=function(r){return r[r.NONE=0]="NONE",r[r.START=1]="START",r[r.ACTIVE=2]="ACTIVE",r}(Qn||{});const Oo=r=>r&&r.isOrthographicCamera,n7=r=>r&&r.isBox3,s7=r=>1-Math.exp(-5*r)+.007*r,q3=g.createContext(null);function r7({children:r,maxDuration:e=1,margin:t=1.2,observe:i,fit:n,clip:s,interpolateFunc:o=s7,onFit:a}){const l=g.useRef(null),{camera:c,size:u,invalidate:h}=le(),f=le(C=>C.controls),d=g.useRef(a);d.current=a;const m=g.useRef({camPos:new z,camRot:new nt,camZoom:1}),A=g.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),p=g.useRef(Qn.NONE),y=g.useRef(0),[E]=g.useState(()=>new Yt),v=g.useMemo(()=>{function C(){const I=E.getSize(new z),_=E.getCenter(new z),S=Math.max(I.x,I.y,I.z),b=Oo(c)?S*4:S/(2*Math.atan(Math.PI*c.fov/360)),T=Oo(c)?S*4:b/c.aspect,R=t*Math.max(b,T);return{box:E,size:I,center:_,distance:R}}return{getSize:C,refresh(I){if(n7(I))E.copy(I);else{const _=I||l.current;if(!_)return this;_.updateWorldMatrix(!0,!0),E.setFromObject(_)}if(E.isEmpty()){const _=c.position.length()||10;E.setFromCenterAndSize(new z,new z(_,_,_))}return m.current.camPos.copy(c.position),m.current.camRot.copy(c.quaternion),Oo(c)&&(m.current.camZoom=c.zoom),A.current.camPos=void 0,A.current.camRot=void 0,A.current.camZoom=void 0,A.current.camUp=void 0,A.current.target=void 0,this},reset(){const{center:I,distance:_}=C(),S=c.position.clone().sub(I).normalize();A.current.camPos=I.clone().addScaledVector(S,_),A.current.target=I.clone();const b=new we().lookAt(A.current.camPos,A.current.target,c.up);return A.current.camRot=new nt().setFromRotationMatrix(b),p.current=Qn.START,y.current=0,this},moveTo(I){return A.current.camPos=Array.isArray(I)?new z(...I):I.clone(),p.current=Qn.START,y.current=0,this},lookAt({target:I,up:_}){A.current.target=Array.isArray(I)?new z(...I):I.clone(),_?A.current.camUp=Array.isArray(_)?new z(..._):_.clone():A.current.camUp=c.up.clone();const S=new we().lookAt(A.current.camPos||c.position,A.current.target,A.current.camUp);return A.current.camRot=new nt().setFromRotationMatrix(S),p.current=Qn.START,y.current=0,this},to({position:I,target:_}){return this.moveTo(I).lookAt({target:_})},fit(){if(!Oo(c))return this.reset();let I=0,_=0;const S=[new z(E.min.x,E.min.y,E.min.z),new z(E.min.x,E.max.y,E.min.z),new z(E.min.x,E.min.y,E.max.z),new z(E.min.x,E.max.y,E.max.z),new z(E.max.x,E.max.y,E.max.z),new z(E.max.x,E.max.y,E.min.z),new z(E.max.x,E.min.y,E.max.z),new z(E.max.x,E.min.y,E.min.z)],b=A.current.camPos||c.position,T=A.current.target||(f==null?void 0:f.target),R=A.current.camUp||c.up,w=T?new we().lookAt(b,T,R).setPosition(b).invert():c.matrixWorldInverse;for(const k of S)k.applyMatrix4(w),I=Math.max(I,Math.abs(k.y)),_=Math.max(_,Math.abs(k.x));I*=2,_*=2;const B=(c.top-c.bottom)/I,D=(c.right-c.left)/_;return A.current.camZoom=Math.min(B,D)/t,p.current=Qn.START,y.current=0,d.current&&d.current(this.getSize()),this},clip(){const{distance:I}=C();return c.near=I/100,c.far=I*100,c.updateProjectionMatrix(),f&&(f.maxDistance=I*10,f.update()),h(),this}}},[E,c,f,t,h]);g.useLayoutEffect(()=>{if(f){const C=()=>{if(f&&A.current.target&&p.current!==Qn.NONE){const I=new z().setFromMatrixColumn(c.matrix,2),_=m.current.camPos.distanceTo(f.target),S=(A.current.camPos||m.current.camPos).distanceTo(A.current.target),b=(1-y.current)*_+y.current*S;f.target.copy(c.position).addScaledVector(I,-b),f.update()}p.current=Qn.NONE};return f.addEventListener("start",C),()=>f.removeEventListener("start",C)}},[f]);const x=g.useRef(0);return g.useLayoutEffect(()=>{(i||x.current++===0)&&(v.refresh(),n&&v.reset().fit(),s&&v.clip())},[u,s,n,i,c,f]),He((C,I)=>{if(p.current===Qn.START)p.current=Qn.ACTIVE,h();else if(p.current===Qn.ACTIVE){if(y.current+=I/e,y.current>=1)A.current.camPos&&c.position.copy(A.current.camPos),A.current.camRot&&c.quaternion.copy(A.current.camRot),A.current.camUp&&c.up.copy(A.current.camUp),A.current.camZoom&&Oo(c)&&(c.zoom=A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix(),f&&A.current.target&&(f.target.copy(A.current.target),f.update()),p.current=Qn.NONE;else{const _=o(y.current);A.current.camPos&&c.position.lerpVectors(m.current.camPos,A.current.camPos,_),A.current.camRot&&c.quaternion.slerpQuaternions(m.current.camRot,A.current.camRot,_),A.current.camUp&&c.up.set(0,1,0).applyQuaternion(c.quaternion),A.current.camZoom&&Oo(c)&&(c.zoom=(1-_)*m.current.camZoom+_*A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix()}h()}}),g.createElement("group",{ref:l},g.createElement(q3.Provider,{value:v},r))}function o7(){return g.useContext(q3)}const dF=g.forwardRef(({intensity:r=1,decay:e,decayRate:t=.65,maxYaw:i=.1,maxPitch:n=.1,maxRoll:s=.1,yawFrequency:o=.1,pitchFrequency:a=.1,rollFrequency:l=.1},c)=>{const u=le(E=>E.camera),h=le(E=>E.controls),f=g.useRef(r),d=g.useRef(u.rotation.clone()),[m]=g.useState(()=>new kh),[A]=g.useState(()=>new kh),[p]=g.useState(()=>new kh),y=()=>{(f.current<0||f.current>1)&&(f.current=f.current<0?0:1)};return g.useImperativeHandle(c,()=>({getIntensity:()=>f.current,setIntensity:E=>{f.current=E,y()}}),[]),g.useEffect(()=>{if(h){const E=()=>void(d.current=u.rotation.clone());return h.addEventListener("change",E),E(),()=>void h.removeEventListener("change",E)}},[u,h]),He((E,v)=>{const x=Math.pow(f.current,2),C=i*x*m.noise(E.clock.elapsedTime*o,1),I=n*x*A.noise(E.clock.elapsedTime*a,1),_=s*x*p.noise(E.clock.elapsedTime*l,1);u.rotation.set(d.current.x+I,d.current.y+C,d.current.z+_),e&&f.current>0&&(f.current-=t*v,y())}),null}),mF=g.forwardRef(({children:r,enabled:e=!0,speed:t=1,rotationIntensity:i=1,floatIntensity:n=1,floatingRange:s=[-.1,.1],autoInvalidate:o=!1,...a},l)=>{const c=g.useRef(null);g.useImperativeHandle(l,()=>c.current,[]);const u=g.useRef(Math.random()*1e4);return He(h=>{var f,d;if(!e||t===0)return;o&&h.invalidate();const m=u.current+h.clock.elapsedTime;c.current.rotation.x=Math.cos(m/4*t)/8*i,c.current.rotation.y=Math.sin(m/4*t)/8*i,c.current.rotation.z=Math.sin(m/4*t)/20*i;let A=Math.sin(m/4*t)/10;A=et.mapLinear(A,-.1,.1,(f=s==null?void 0:s[0])!==null&&f!==void 0?f:-.1,(d=s==null?void 0:s[1])!==null&&d!==void 0?d:.1),c.current.position.y=A*n,c.current.updateMatrix()}),g.createElement("group",a,g.createElement("group",{ref:c,matrixAutoUpdate:!1},r))}),J3=(r,e,t)=>{let i;switch(r){case Hi:i=new Uint8ClampedArray(e*t*4);break;case fi:i=new Uint16Array(e*t*4);break;case Jr:i=new Uint32Array(e*t*4);break;case wd:i=new Int8Array(e*t*4);break;case h2:i=new Int16Array(e*t*4);break;case uu:i=new Int32Array(e*t*4);break;case ii:i=new Float32Array(e*t*4);break;default:throw new Error("Unsupported data type")}return i};let eu;const a7=(r,e,t,i)=>{if(eu!==void 0)return eu;const n=new Ti(1,1,i);e.setRenderTarget(n);const s=new Qe(new nn,new ds({color:16777215}));e.render(s,t),e.setRenderTarget(null);const o=J3(r,n.width,n.height);return e.readRenderTargetPixels(n,0,0,n.width,n.height,o),n.dispose(),s.geometry.dispose(),s.material.dispose(),eu=o[0]!==0,eu};class bm{constructor(e){var t,i,n,s,o,a,l,c,u,h,f,d,m,A,p,y;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(v){throw this._renderer.setRenderTarget(null),v}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const E={format:wi,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((t=e.renderTargetOptions)===null||t===void 0?void 0:t.anisotropy)!==void 0?(i=e.renderTargetOptions)===null||i===void 0?void 0:i.anisotropy:1,generateMipmaps:((n=e.renderTargetOptions)===null||n===void 0?void 0:n.generateMipmaps)!==void 0?(s=e.renderTargetOptions)===null||s===void 0?void 0:s.generateMipmaps:!1,magFilter:((o=e.renderTargetOptions)===null||o===void 0?void 0:o.magFilter)!==void 0?(a=e.renderTargetOptions)===null||a===void 0?void 0:a.magFilter:Ht,minFilter:((l=e.renderTargetOptions)===null||l===void 0?void 0:l.minFilter)!==void 0?(c=e.renderTargetOptions)===null||c===void 0?void 0:c.minFilter:Ht,samples:((u=e.renderTargetOptions)===null||u===void 0?void 0:u.samples)!==void 0?(h=e.renderTargetOptions)===null||h===void 0?void 0:h.samples:void 0,wrapS:((f=e.renderTargetOptions)===null||f===void 0?void 0:f.wrapS)!==void 0?(d=e.renderTargetOptions)===null||d===void 0?void 0:d.wrapS:Bn,wrapT:((m=e.renderTargetOptions)===null||m===void 0?void 0:m.wrapT)!==void 0?(A=e.renderTargetOptions)===null||A===void 0?void 0:A.wrapT:Bn};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=bm.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Mr,this._camera=new ui,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!a7(this._type,this._renderer,this._camera,E)){let v;switch(this._type){case fi:v=this._renderer.extensions.has("EXT_color_buffer_float")?ii:void 0;break}v!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${ii}`),this._type=v):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new Qe(new nn,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Ti(this.width,this.height,E),this._renderTarget.texture.mapping=((p=e.renderTargetOptions)===null||p===void 0?void 0:p.mapping)!==void 0?(y=e.renderTargetOptions)===null||y===void 0?void 0:y.mapping:wu}static instantiateRenderer(){const e=new AC;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=J3(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new br(this.toArray(),this.width,this.height,wi,this._type,(e==null?void 0:e.mapping)||wu,(e==null?void 0:e.wrapS)||Bn,(e==null?void 0:e.wrapT)||Bn,(e==null?void 0:e.magFilter)||Ht,(e==null?void 0:e.minFilter)||Ht,(e==null?void 0:e.anisotropy)||1,Bd);return t.generateMipmaps=(e==null?void 0:e.generateMipmaps)!==void 0?e==null?void 0:e.generateMipmaps:!1,t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof gi&&Object.values(this.material.uniforms).forEach(t=>{t.value instanceof qi&&t.value.dispose()}),Object.values(this.material).forEach(t=>{t instanceof qi&&t.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}const l7=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,c7=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class u7 extends gi{constructor({gamma:e,offsetHdr:t,offsetSdr:i,gainMapMin:n,gainMapMax:s,maxDisplayBoost:o,hdrCapacityMin:a,hdrCapacityMax:l,sdr:c,gainMap:u}){super({name:"GainMapDecoderMaterial",vertexShader:l7,fragmentShader:c7,uniforms:{sdr:{value:c},gainMap:{value:u},gamma:{value:new z(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:new z().fromArray(t)},offsetSdr:{value:new z().fromArray(i)},gainMapMin:{value:new z().fromArray(n)},gainMapMax:{value:new z().fromArray(s)},weightFactor:{value:(Math.log2(o)-a)/(l-a)}},blending:T0,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=o,this._hdrCapacityMin=a,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class Z3 extends Error{}class ex extends Error{}const rl=(r,e,t)=>{const i=new RegExp(`${e}="([^"]*)"`,"i").exec(r);if(i)return i[1];const n=new RegExp(`<${e}[^>]*>([\\s\\S]*?)</${e}>`,"i").exec(r);if(n){const s=n[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return s&&s.length===3?s.map(o=>o.replace(/<\/?rdf:li>/g,"")):n[1].trim()}if(t!==void 0)return t;throw new Error(`Can't find ${e} in gainmap metadata`)},h7=r=>{let e;typeof TextDecoder<"u"?e=new TextDecoder().decode(r):e=r.toString();let t=e.indexOf("<x:xmpmeta");for(;t!==-1;){const i=e.indexOf("x:xmpmeta>",t),n=e.slice(t,i+10);try{const s=rl(n,"hdrgm:GainMapMin","0"),o=rl(n,"hdrgm:GainMapMax"),a=rl(n,"hdrgm:Gamma","1"),l=rl(n,"hdrgm:OffsetSDR","0.015625"),c=rl(n,"hdrgm:OffsetHDR","0.015625"),u=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(n),h=u?u[1]:"0",f=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(n);if(!f)throw new Error("Incomplete gainmap metadata");const d=f[1];return{gainMapMin:Array.isArray(s)?s.map(m=>parseFloat(m)):[parseFloat(s),parseFloat(s),parseFloat(s)],gainMapMax:Array.isArray(o)?o.map(m=>parseFloat(m)):[parseFloat(o),parseFloat(o),parseFloat(o)],gamma:Array.isArray(a)?a.map(m=>parseFloat(m)):[parseFloat(a),parseFloat(a),parseFloat(a)],offsetSdr:Array.isArray(l)?l.map(m=>parseFloat(m)):[parseFloat(l),parseFloat(l),parseFloat(l)],offsetHdr:Array.isArray(c)?c.map(m=>parseFloat(m)):[parseFloat(c),parseFloat(c),parseFloat(c)],hdrCapacityMin:parseFloat(h),hdrCapacityMax:parseFloat(d)}}catch{}t=e.indexOf("<x:xmpmeta",i)}};class f7{constructor(e){this.options={debug:e&&e.debug!==void 0?e.debug:!1,extractFII:e&&e.extractFII!==void 0?e.extractFII:!0,extractNonFII:e&&e.extractNonFII!==void 0?e.extractNonFII:!0}}extract(e){return new Promise((t,i)=>{const n=this.options.debug,s=new DataView(e.buffer);if(s.getUint16(0)!==65496){i(new Error("Not a valid jpeg"));return}const o=s.byteLength;let a=2,l=0,c;for(;a<o;){if(++l>250){i(new Error(`Found no marker after ${l} loops 😵`));return}if(s.getUint8(a)!==255){i(new Error(`Not a valid marker at offset 0x${a.toString(16)}, found: 0x${s.getUint8(a).toString(16)}`));return}if(c=s.getUint8(a+1),n&&console.log(`Marker: ${c.toString(16)}`),c===226){n&&console.log("Found APP2 marker (0xffe2)");const u=a+4;if(s.getUint32(u)===1297106432){const h=u+4;let f;if(s.getUint16(h)===18761)f=!1;else if(s.getUint16(h)===19789)f=!0;else{i(new Error("No valid endianness marker found in TIFF header"));return}if(s.getUint16(h+2,!f)!==42){i(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const d=s.getUint32(h+4,!f);if(d<8){i(new Error("Not valid TIFF data! (First offset less than 8)"));return}const m=h+d,A=s.getUint16(m,!f),p=m+2;let y=0;for(let C=p;C<p+12*A;C+=12)s.getUint16(C,!f)===45057&&(y=s.getUint32(C+8,!f));const E=4,v=m+2+A*12+E,x=[];for(let C=v;C<v+y*16;C+=16){const I={MPType:s.getUint32(C,!f),size:s.getUint32(C+4,!f),dataOffset:s.getUint32(C+8,!f),dependantImages:s.getUint32(C+12,!f),start:-1,end:-1,isFII:!1};I.dataOffset?(I.start=h+I.dataOffset,I.isFII=!1):(I.start=0,I.isFII=!0),I.end=I.start+I.size,x.push(I)}if(this.options.extractNonFII&&x.length){const C=new Blob([s]),I=[];for(const _ of x){if(_.isFII&&!this.options.extractFII)continue;const S=C.slice(_.start,_.end+1,"image/jpeg");I.push(S)}t(I)}}}a+=2+s.getUint16(a+2)}})}}const d7=async r=>{const e=h7(r);if(!e)throw new ex("Gain map XMP metadata not found");const i=await new f7({extractFII:!0,extractNonFII:!0}).extract(r);if(i.length!==2)throw new Z3("Gain map recovery image not found");return{sdr:new Uint8Array(await i[0].arrayBuffer()),gainMap:new Uint8Array(await i[1].arrayBuffer()),metadata:e}},j1=r=>new Promise((e,t)=>{const i=document.createElement("img");i.onload=()=>{e(i)},i.onerror=n=>{t(n)},i.src=URL.createObjectURL(r)});class tx extends Dr{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new pC}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const e=new u7({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new qi,sdr:new qi});return new bm({width:16,height:16,type:fi,colorSpace:Bd,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,i,n){const s=n?new Blob([n],{type:"image/jpeg"}):void 0,o=new Blob([i],{type:"image/jpeg"});let a,l,c=!1;if(typeof createImageBitmap>"u"){const f=await Promise.all([s?j1(s):Promise.resolve(void 0),j1(o)]);l=f[0],a=f[1],c=!0}else{const f=await Promise.all([s?createImageBitmap(s,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(o,{imageOrientation:"flipY"})]);l=f[0],a=f[1]}const u=new qi(l||new ImageData(2,2),wu,Bn,Bn,Ht,Xm,wi,Hi,1,Bd);u.flipY=c,u.needsUpdate=!0;const h=new qi(a,wu,Bn,Bn,Ht,Xm,wi,Hi,1,a2);h.flipY=c,h.needsUpdate=!0,e.width=a.width,e.height=a.height,e.material.gainMap=u,e.material.sdr=h,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class m7 extends tx{load([e,t,i],n,s,o){const a=this.prepareQuadRenderer();let l,c,u;const h=async()=>{if(l&&c&&u){try{await this.render(a,u,l,c)}catch(b){this.manager.itemError(e),this.manager.itemError(t),this.manager.itemError(i),typeof o=="function"&&o(b),a.disposeOnDemandRenderer();return}typeof n=="function"&&n(a),this.manager.itemEnd(e),this.manager.itemEnd(t),this.manager.itemEnd(i),a.disposeOnDemandRenderer()}};let f=!0,d=0,m=0,A=!0,p=0,y=0,E=!0,v=0,x=0;const C=()=>{if(typeof s=="function"){const b=d+p+v,T=m+y+x,R=f&&A&&E;s(new ProgressEvent("progress",{lengthComputable:R,loaded:T,total:b}))}};this.manager.itemStart(e),this.manager.itemStart(t),this.manager.itemStart(i);const I=new vn(this._internalLoadingManager);I.setResponseType("arraybuffer"),I.setRequestHeader(this.requestHeader),I.setPath(this.path),I.setWithCredentials(this.withCredentials),I.load(e,async b=>{if(typeof b=="string")throw new Error("Invalid sdr buffer");l=b,await h()},b=>{f=b.lengthComputable,m=b.loaded,d=b.total,C()},b=>{this.manager.itemError(e),typeof o=="function"&&o(b)});const _=new vn(this._internalLoadingManager);_.setResponseType("arraybuffer"),_.setRequestHeader(this.requestHeader),_.setPath(this.path),_.setWithCredentials(this.withCredentials),_.load(t,async b=>{if(typeof b=="string")throw new Error("Invalid gainmap buffer");c=b,await h()},b=>{A=b.lengthComputable,y=b.loaded,p=b.total,C()},b=>{this.manager.itemError(t),typeof o=="function"&&o(b)});const S=new vn(this._internalLoadingManager);return S.setRequestHeader(this.requestHeader),S.setPath(this.path),S.setWithCredentials(this.withCredentials),S.load(i,async b=>{if(typeof b!="string")throw new Error("Invalid metadata string");u=JSON.parse(b),await h()},b=>{E=b.lengthComputable,x=b.loaded,v=b.total,C()},b=>{this.manager.itemError(i),typeof o=="function"&&o(b)}),a}}class A7 extends tx{load(e,t,i,n){const s=this.prepareQuadRenderer(),o=new vn(this._internalLoadingManager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(this.withCredentials),this.manager.itemStart(e),o.load(e,async a=>{if(typeof a=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const l=new Uint8Array(a);let c,u,h;try{const f=await d7(l);c=f.sdr,u=f.gainMap,h=f.metadata}catch(f){if(f instanceof ex||f instanceof Z3)console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),h={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},c=l;else throw f}try{await this.render(s,h,c,u)}catch(f){this.manager.itemError(e),typeof n=="function"&&n(f),s.disposeOnDemandRenderer();return}typeof t=="function"&&t(s),this.manager.itemEnd(e),s.disposeOnDemandRenderer()},i,a=>{this.manager.itemError(e),typeof n=="function"&&n(a)}),s}}const Ol={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},ix="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",oa=r=>Array.isArray(r),wm=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function Ah({files:r=wm,path:e="",preset:t=void 0,colorSpace:i=void 0,extensions:n}={}){t&&(Bm(t),r=Ol[t],e=ix);const s=oa(r),{extension:o,isCubemap:a}=Rm(r),l=Dm(o);if(!l)throw new Error("useEnvironment: Unrecognized file extension: "+r);const c=le(d=>d.gl);g.useLayoutEffect(()=>{if(o!=="webp"&&o!=="jpg"&&o!=="jpeg")return;function d(){oi.clear(l,s?[r]:r)}c.domElement.addEventListener("webglcontextlost",d,{once:!0})},[r,c.domElement]);const u=oi(l,s?[r]:r,d=>{(o==="webp"||o==="jpg"||o==="jpeg")&&d.setRenderer(c),d.setPath==null||d.setPath(e),n&&n(d)});let h=s?u[0]:u;if(o==="jpg"||o==="jpeg"||o==="webp"){var f;h=(f=h.renderTarget)==null?void 0:f.texture}return h.mapping=a?qy:Xy,h.colorSpace=i??(a?"srgb":"srgb-linear"),h}const p7={files:wm,path:"",preset:void 0,extensions:void 0};Ah.preload=r=>{const e={...p7,...r};let{files:t,path:i=""}=e;const{preset:n,extensions:s}=e;n&&(Bm(n),t=Ol[n],i=ix);const{extension:o}=Rm(t);if(o==="webp"||o==="jpg"||o==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const a=Dm(o);if(!a)throw new Error("useEnvironment: Unrecognized file extension: "+t);oi.preload(a,oa(t)?[t]:t,l=>{l.setPath==null||l.setPath(i),s&&s(l)})};const g7={files:wm,preset:void 0};Ah.clear=r=>{const e={...g7,...r};let{files:t}=e;const{preset:i}=e;i&&(Bm(i),t=Ol[i]);const{extension:n}=Rm(t),s=Dm(n);if(!s)throw new Error("useEnvironment: Unrecognized file extension: "+t);oi.clear(s,oa(t)?[t]:t)};function Bm(r){if(!(r in Ol))throw new Error("Preset must be one of: "+Object.keys(Ol).join(", "))}function Rm(r){var e;const t=oa(r)&&r.length===6,i=oa(r)&&r.length===3&&r.some(o=>o.endsWith("json")),n=oa(r)?r[0]:r;return{extension:t?"cube":i?"webp":n.startsWith("data:application/exr")?"exr":n.startsWith("data:application/hdr")?"hdr":n.startsWith("data:image/jpeg")?"jpg":(e=n.split(".").pop())==null||(e=e.split("?"))==null||(e=e.shift())==null?void 0:e.toLowerCase(),isCubemap:t,isGainmap:i}}function Dm(r){return r==="cube"?D0:r==="hdr"?r5:r==="exr"?o5:r==="jpg"||r==="jpeg"?A7:r==="webp"?m7:null}const y7=r=>r.current&&r.current.isScene,v7=r=>y7(r)?r.current:r;function Mm(r,e,t,i,n={}){var s,o,a,l;n={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...n};const c=v7(e||t),u=c.background,h=c.environment,f={backgroundBlurriness:c.backgroundBlurriness,backgroundIntensity:c.backgroundIntensity,backgroundRotation:(s=(o=c.backgroundRotation)==null||o.clone==null?void 0:o.clone())!==null&&s!==void 0?s:[0,0,0],environmentIntensity:c.environmentIntensity,environmentRotation:(a=(l=c.environmentRotation)==null||l.clone==null?void 0:l.clone())!==null&&a!==void 0?a:[0,0,0]};return r!=="only"&&(c.environment=i),r&&(c.background=i),Wn(c,n),()=>{r!=="only"&&(c.environment=h),r&&(c.background=u),Wn(c,f)}}function Lm({scene:r,background:e=!1,map:t,...i}){const n=le(s=>s.scene);return g.useLayoutEffect(()=>{if(t)return Mm(e,r,n,t,i)}),null}function nx({background:r=!1,scene:e,blur:t,backgroundBlurriness:i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a,...l}){const c=Ah(l),u=le(h=>h.scene);return g.useLayoutEffect(()=>Mm(r,e,u,c,{backgroundBlurriness:t??i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a})),g.useEffect(()=>()=>{c.dispose()},[c]),null}function E7({children:r,near:e=.1,far:t=1e3,resolution:i=256,frames:n=1,map:s,background:o=!1,blur:a,backgroundBlurriness:l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f,scene:d,files:m,path:A,preset:p=void 0,extensions:y}){const E=le(S=>S.gl),v=le(S=>S.scene),x=g.useRef(null),[C]=g.useState(()=>new Mr),I=g.useMemo(()=>{const S=new ju(i);return S.texture.type=fi,S},[i]);g.useEffect(()=>()=>{I.dispose()},[I]),g.useLayoutEffect(()=>{if(n===1){const S=E.autoClear;E.autoClear=!0,x.current.update(E,C),E.autoClear=S}return Mm(o,d,v,I.texture,{backgroundBlurriness:a??l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f})},[r,C,I.texture,d,v,o,n,E]);let _=1;return He(()=>{if(n===1/0||_<n){const S=E.autoClear;E.autoClear=!0,x.current.update(E,C),E.autoClear=S,_++}}),g.createElement(g.Fragment,null,so(g.createElement(g.Fragment,null,r,g.createElement("cubeCamera",{ref:x,args:[e,t,I]}),m||p?g.createElement(nx,{background:!0,files:m,preset:p,path:A,extensions:y}):s?g.createElement(Lm,{background:!0,map:s,extensions:y}):null),C))}function x7(r){var e,t,i,n;const s=Ah(r),o=r.map||s;g.useMemo(()=>Ii({GroundProjectedEnvImpl:T_}),[]),g.useEffect(()=>()=>{s.dispose()},[s]);const a=g.useMemo(()=>[o],[o]),l=(e=r.ground)==null?void 0:e.height,c=(t=r.ground)==null?void 0:t.radius,u=(i=(n=r.ground)==null?void 0:n.scale)!==null&&i!==void 0?i:1e3;return g.createElement(g.Fragment,null,g.createElement(Lm,Ae({},r,{map:o})),g.createElement("groundProjectedEnvImpl",{args:a,scale:u,height:l,radius:c}))}function C7(r){return r.ground?g.createElement(x7,r):r.map?g.createElement(Lm,r):r.children?g.createElement(E7,r):g.createElement(nx,r)}const I7=g.forwardRef(({scale:r=10,frames:e=1/0,opacity:t=1,width:i=1,height:n=1,blur:s=1,near:o=0,far:a=10,resolution:l=512,smooth:c=!0,color:u="#000000",depthWrite:h=!1,renderOrder:f,...d},m)=>{const A=g.useRef(null),p=le(D=>D.scene),y=le(D=>D.gl),E=g.useRef(null);i=i*(Array.isArray(r)?r[0]:r||1),n=n*(Array.isArray(r)?r[1]:r||1);const[v,x,C,I,_,S,b]=g.useMemo(()=>{const D=new Ti(l,l),k=new Ti(l,l);k.texture.generateMipmaps=D.texture.generateMipmaps=!1;const Q=new nn(i,n).rotateX(Math.PI/2),Y=new Qe(Q),W=new t2;W.depthTest=W.depthWrite=!1,W.onBeforeCompile=M=>{M.uniforms={...M.uniforms,ucolor:{value:new Ye(u)}},M.fragmentShader=M.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),M.fragmentShader=M.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const P=new gi(lT),K=new gi(cT);return K.depthTest=P.depthTest=!1,[D,Q,W,Y,P,K,k]},[l,i,n,r,u]),T=D=>{I.visible=!0,I.material=_,_.uniforms.tDiffuse.value=v.texture,_.uniforms.h.value=D*1/256,y.setRenderTarget(b),y.render(I,E.current),I.material=S,S.uniforms.tDiffuse.value=b.texture,S.uniforms.v.value=D*1/256,y.setRenderTarget(v),y.render(I,E.current),I.visible=!1};let R=0,w,B;return He(()=>{E.current&&(e===1/0||R<e)&&(R++,w=p.background,B=p.overrideMaterial,A.current.visible=!1,p.background=null,p.overrideMaterial=C,y.setRenderTarget(v),y.render(p,E.current),T(s),c&&T(s*.4),y.setRenderTarget(null),A.current.visible=!0,p.overrideMaterial=B,p.background=w)}),g.useImperativeHandle(m,()=>A.current,[]),g.createElement("group",Ae({"rotation-x":Math.PI/2},d,{ref:A}),g.createElement("mesh",{renderOrder:f,geometry:x,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},g.createElement("meshBasicMaterial",{transparent:!0,map:v.texture,opacity:t,depthWrite:h})),g.createElement("orthographicCamera",{ref:E,args:[-i/2,i/2,n/2,-n/2,o,a]}))});function _7(r){return r.isLight}function S7(r){return!!r.geometry}const sx=g.createContext(null),T7=ps({color:new Ye,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),b7=g.forwardRef(({children:r,temporal:e,frames:t=40,limit:i=1/0,blend:n=20,scale:s=10,opacity:o=1,alphaTest:a=.75,color:l="black",colorBlend:c=2,resolution:u=1024,toneMapped:h=!0,...f},d)=>{Ii({SoftShadowMaterial:T7});const m=le(I=>I.gl),A=le(I=>I.scene),p=le(I=>I.camera),y=le(I=>I.invalidate),E=g.useRef(null),v=g.useRef(null),[x]=g.useState(()=>new B7(m,A,u));g.useLayoutEffect(()=>{x.configure(E.current)},[]);const C=g.useMemo(()=>({lights:new Map,temporal:!!e,frames:Math.max(2,t),blend:Math.max(2,t===1/0?n:t),count:0,getMesh:()=>E.current,reset:()=>{x.clear();const I=E.current.material;I.opacity=0,I.alphaTest=0,C.count=0},update:(I=1)=>{const _=E.current.material;C.temporal?(_.opacity=Math.min(o,_.opacity+o/C.blend),_.alphaTest=Math.min(a,_.alphaTest+a/C.blend)):(_.opacity=o,_.alphaTest=a),v.current.visible=!0,x.prepare();for(let S=0;S<I;S++)C.lights.forEach(b=>b.update()),x.update(p,C.blend);v.current.visible=!1,x.finish()}}),[x,p,A,e,t,n,o,a]);return g.useLayoutEffect(()=>{C.reset(),!C.temporal&&C.frames!==1/0&&C.update(C.blend)}),g.useImperativeHandle(d,()=>C,[C]),He(()=>{(C.temporal||C.frames===1/0)&&C.count<C.frames&&C.count<i&&(y(),C.update(),C.count++)}),g.createElement("group",f,g.createElement("group",{traverse:()=>null,ref:v},g.createElement(sx.Provider,{value:C},r)),g.createElement("mesh",{receiveShadow:!0,ref:E,scale:s,rotation:[-Math.PI/2,0,0]},g.createElement("planeGeometry",null),g.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:h,color:l,blend:c,map:x.progressiveLightMap2.texture})))}),w7=g.forwardRef(({castShadow:r=!0,bias:e=.001,mapSize:t=512,size:i=5,near:n=.5,far:s=500,frames:o=1,position:a=[0,0,0],radius:l=1,amount:c=8,intensity:u=Zi>=155?Math.PI:1,ambient:h=.5,...f},d)=>{const m=g.useRef(null),A=new z(...a).length(),p=g.useContext(sx),y=g.useCallback(()=>{let v;if(m.current)for(let x=0;x<m.current.children.length;x++)if(v=m.current.children[x],Math.random()>h)v.position.set(a[0]+et.randFloatSpread(l),a[1]+et.randFloatSpread(l),a[2]+et.randFloatSpread(l));else{let C=Math.acos(2*Math.random()-1)-Math.PI/2,I=2*Math.PI*Math.random();v.position.set(Math.cos(C)*Math.cos(I)*A,Math.abs(Math.cos(C)*Math.sin(I)*A),Math.sin(C)*A)}},[l,h,A,...a]),E=g.useMemo(()=>({update:y}),[y]);return g.useImperativeHandle(d,()=>E,[E]),g.useLayoutEffect(()=>{var v;const x=m.current;return p&&((v=p.lights)==null||v.set(x.uuid,E)),()=>{var C;return void(p==null||(C=p.lights)==null?void 0:C.delete(x.uuid))}},[p,E]),g.createElement("group",Ae({ref:m},f),Array.from({length:c},(v,x)=>g.createElement("directionalLight",{key:x,castShadow:r,"shadow-bias":e,"shadow-mapSize":[t,t],intensity:u/c},g.createElement("orthographicCamera",{attach:"shadow-camera",args:[-i,i,i,-i,n,s]}))))});class B7{constructor(e,t,i=1024){this.renderer=e,this.res=i,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new Ye,this.clearAlpha=0;const n={type:fi,magFilter:Xt,minFilter:Xt};this.progressiveLightMap1=new Ti(this.res,this.res,n),this.progressiveLightMap2=new Ti(this.res,this.res,n),this.discardMat=new Tm,this.targetMat=new w0({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=s=>{s.vertexShader=`varying vec2 vUv;
`+s.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const o=s.fragmentShader.indexOf("void main() {");s.fragmentShader=`varying vec2 vUv;
`+s.fragmentShader.slice(0,o)+`uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+s.fragmentShader.slice(o-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,s.uniforms.previousShadowMap=this.previousShadowMap,s.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{S7(e)?this.meshes.push({object:e,material:e.material}):_7(e)&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,n=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,s=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(i),this.previousShadowMap.value=n.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=s}}const R7={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function D7({radius:r,adjustCamera:e}){const t=o7();return g.useEffect(()=>{e&&t.refresh().clip().fit()},[r,e]),null}function AF({children:r,center:e,adjustCamera:t=!0,intensity:i=.5,shadows:n="contact",environment:s="city",preset:o="rembrandt",...a}){var l,c,u,h,f,d,m,A;const p=typeof o=="string"?R7[o]:o,[{radius:y,height:E},v]=g.useState({radius:0,width:0,height:0,depth:0}),x=(l=n==null?void 0:n.bias)!==null&&l!==void 0?l:-1e-4,C=(c=n==null?void 0:n.normalBias)!==null&&c!==void 0?c:0,I=(u=n==null?void 0:n.size)!==null&&u!==void 0?u:1024,_=(h=n==null?void 0:n.offset)!==null&&h!==void 0?h:0,S=n==="contact"||(n==null?void 0:n.type)==="contact",b=n==="accumulative"||(n==null?void 0:n.type)==="accumulative",T={...typeof n=="object"?n:{}},R=s?typeof s=="string"?{preset:s}:s:null,w=g.useCallback(B=>{const{width:D,height:k,depth:Q,boundingSphere:Y}=B;v({radius:Y.radius,width:D,height:k,depth:Q}),e!=null&&e.onCentered&&e.onCentered(B)},[]);return g.createElement(g.Fragment,null,g.createElement("ambientLight",{intensity:i/3}),g.createElement("spotLight",{penumbra:1,position:[p.main[0]*y,p.main[1]*y,p.main[2]*y],intensity:i*2,castShadow:!!n,"shadow-bias":x,"shadow-normalBias":C,"shadow-mapSize":I}),g.createElement("pointLight",{position:[p.fill[0]*y,p.fill[1]*y,p.fill[2]*y],intensity:i}),g.createElement(r7,Ae({fit:!!t,clip:!!t,margin:Number(t),observe:!0},a),g.createElement(D7,{radius:y,adjustCamera:t}),g.createElement(Y3,Ae({},e,{position:[0,_/2,0],onCentered:w}),r)),g.createElement("group",{position:[0,-E/2-_/2,0]},S&&g.createElement(I7,Ae({scale:y*4,far:y,blur:2},T)),b&&g.createElement(b7,Ae({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:y*4},T),g.createElement(w7,{amount:(f=T.amount)!==null&&f!==void 0?f:8,radius:(d=T.radius)!==null&&d!==void 0?d:y,ambient:(m=T.ambient)!==null&&m!==void 0?m:.5,intensity:(A=T.intensity)!==null&&A!==void 0?A:1,position:[p.main[0]*y,p.main[1]*y,p.main[2]*y],size:y*4,bias:-x,mapSize:I}))),s&&g.createElement(C7,R))}const M7=r=>r===0?0:Math.pow(2,10*r-10);function pF({children:r,floor:e=.25,segments:t=20,receiveShadow:i,...n}){const s=g.useRef(null);return g.useLayoutEffect(()=>{let o=0;const a=t/t/2,l=s.current.attributes.position;for(let c=0;c<t+1;c++)for(let u=0;u<t+1;u++)l.setXYZ(o++,c/t-a+(c===0?-e:0),u/t-a,M7(c/t));l.needsUpdate=!0,s.current.computeVertexNormals()},[t,e]),g.createElement("group",n,g.createElement("mesh",{receiveShadow:i,rotation:[-Math.PI/2,0,Math.PI/2]},g.createElement("planeGeometry",{ref:s,args:[1,1,t,t]}),r))}const gF=g.forwardRef(({fog:r=!1,renderOrder:e,depthWrite:t=!1,colorStop:i=0,color:n="black",opacity:s=.5,...o},a)=>{const l=g.useMemo(()=>{const c=document.createElement("canvas");c.width=128,c.height=128;const u=c.getContext("2d"),h=u.createRadialGradient(c.width/2,c.height/2,0,c.width/2,c.height/2,c.width/2);return h.addColorStop(i,new Ye(n).getStyle()),h.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=h,u.fillRect(0,0,c.width,c.height),c},[n,i]);return g.createElement("mesh",Ae({renderOrder:e,ref:a,"rotation-x":-Math.PI/2},o),g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,opacity:s,fog:r,depthWrite:t,side:xi},g.createElement("canvasTexture",{attach:"map",args:[l]})))});function X1(r=Rl){const e={value:new we};return Object.assign(new vC({side:r}),{viewMatrix:e,onBeforeCompile:t=>{t.uniforms.viewMatrix=e,t.fragmentShader=`vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
           return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
         }
`+t.fragmentShader.replace("#include <normal_fragment_maps>",`#include <normal_fragment_maps>
           normal = inverseTransformDirection( normal, viewMatrix );
`)}})}const L7=ps({causticsTexture:null,causticsTextureB:null,color:new Ye,lightProjMatrix:new we,lightViewMatrix:new we},`varying vec3 vWorldPosition;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vec4 worldPosition = modelMatrix * vec4(position, 1.);
     vWorldPosition = worldPosition.xyz;
   }`,`varying vec3 vWorldPosition;
  uniform vec3 color;
  uniform sampler2D causticsTexture;
  uniform sampler2D causticsTextureB;
  uniform mat4 lightProjMatrix;
  uniform mat4 lightViewMatrix;
   void main() {
    // Apply caustics
    vec4 lightSpacePos = lightProjMatrix * lightViewMatrix * vec4(vWorldPosition, 1.0);
    lightSpacePos.xyz /= lightSpacePos.w;
    lightSpacePos.xyz = lightSpacePos.xyz * 0.5 + 0.5;
    vec3 front = texture2D(causticsTexture, lightSpacePos.xy).rgb;
    vec3 back = texture2D(causticsTextureB, lightSpacePos.xy).rgb;
    gl_FragColor = vec4((front + back) * color, 1.0);
    #include <tonemapping_fragment>
    #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),P7=ps({cameraMatrixWorld:new we,cameraProjectionMatrixInv:new we,normalTexture:null,depthTexture:null,lightDir:new z(0,1,0),lightPlaneNormal:new z(0,1,0),lightPlaneConstant:0,near:.1,far:100,modelMatrix:new we,worldRadius:1/40,ior:1.1,bounces:0,resolution:1024,size:10,intensity:.5},`
  varying vec2 vUv;
  void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }`,`
  uniform mat4 cameraMatrixWorld;
  uniform mat4 cameraProjectionMatrixInv;
  uniform vec3 lightDir;
  uniform vec3 lightPlaneNormal;
  uniform float lightPlaneConstant;
  uniform float near;
  uniform float far;
  uniform float time;
  uniform float worldRadius;
  uniform float resolution;
  uniform float size;
  uniform float intensity;
  uniform float ior;
  precision highp isampler2D;
  precision highp usampler2D;
  uniform sampler2D normalTexture;
  uniform sampler2D depthTexture;
  uniform float bounces;
  varying vec2 vUv;
  vec3 WorldPosFromDepth(float depth, vec2 coord) {
    float z = depth * 2.0 - 1.0;
    vec4 clipSpacePosition = vec4(coord * 2.0 - 1.0, z, 1.0);
    vec4 viewSpacePosition = cameraProjectionMatrixInv * clipSpacePosition;
    // Perspective division
    viewSpacePosition /= viewSpacePosition.w;
    vec4 worldSpacePosition = cameraMatrixWorld * viewSpacePosition;
    return worldSpacePosition.xyz;
  }
  float sdPlane( vec3 p, vec3 n, float h ) {
    // n must be normalized
    return dot(p,n) + h;
  }
  float planeIntersect( vec3 ro, vec3 rd, vec4 p ) {
    return -(dot(ro,p.xyz)+p.w)/dot(rd,p.xyz);
  }
  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 pos, vec3 normal, float ior, out vec3 rayOrigin, out vec3 rayDirection) {
    rayOrigin = ro;
    rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = pos + rayDirection * 0.1;
    return rayDirection;
  }
  void main() {
    // Each sample consists of random offset in the x and y direction
    float caustic = 0.0;
    float causticTexelSize = (1.0 / resolution) * size * 2.0;
    float texelsNeeded = worldRadius / causticTexelSize;
    float sampleRadius = texelsNeeded / resolution;
    float sum = 0.0;
    if (texture2D(depthTexture, vUv).x == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec2 offset1 = vec2(-0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset2 = vec2(-0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset3 = vec2(0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset4 = vec2(0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 uv1 = vUv + offset1 * sampleRadius;
    vec2 uv2 = vUv + offset2 * sampleRadius;
    vec2 uv3 = vUv + offset3 * sampleRadius;
    vec2 uv4 = vUv + offset4 * sampleRadius;
    vec3 normal1 = texture2D(normalTexture, uv1, -10.0).rgb * 2.0 - 1.0;
    vec3 normal2 = texture2D(normalTexture, uv2, -10.0).rgb * 2.0 - 1.0;
    vec3 normal3 = texture2D(normalTexture, uv3, -10.0).rgb * 2.0 - 1.0;
    vec3 normal4 = texture2D(normalTexture, uv4, -10.0).rgb * 2.0 - 1.0;
    float depth1 = texture2D(depthTexture, uv1, -10.0).x;
    float depth2 = texture2D(depthTexture, uv2, -10.0).x;
    float depth3 = texture2D(depthTexture, uv3, -10.0).x;
    float depth4 = texture2D(depthTexture, uv4, -10.0).x;
    // Sanity check the depths
    if (depth1 == 1.0 || depth2 == 1.0 || depth3 == 1.0 || depth4 == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec3 pos1 = WorldPosFromDepth(depth1, uv1);
    vec3 pos2 = WorldPosFromDepth(depth2, uv2);
    vec3 pos3 = WorldPosFromDepth(depth3, uv3);
    vec3 pos4 = WorldPosFromDepth(depth4, uv4);
    vec3 originPos1 = WorldPosFromDepth(0.0, uv1);
    vec3 originPos2 = WorldPosFromDepth(0.0, uv2);
    vec3 originPos3 = WorldPosFromDepth(0.0, uv3);
    vec3 originPos4 = WorldPosFromDepth(0.0, uv4);
    vec3 endPos1, endPos2, endPos3, endPos4;
    vec3 endDir1, endDir2, endDir3, endDir4;
    totalInternalReflection(originPos1, lightDir, pos1, normal1, ior, endPos1, endDir1);
    totalInternalReflection(originPos2, lightDir, pos2, normal2, ior, endPos2, endDir2);
    totalInternalReflection(originPos3, lightDir, pos3, normal3, ior, endPos3, endDir3);
    totalInternalReflection(originPos4, lightDir, pos4, normal4, ior, endPos4, endDir4);
    float lightPosArea = length(cross(originPos2 - originPos1, originPos3 - originPos1)) + length(cross(originPos3 - originPos1, originPos4 - originPos1));
    float t1 = planeIntersect(endPos1, endDir1, vec4(lightPlaneNormal, lightPlaneConstant));
    float t2 = planeIntersect(endPos2, endDir2, vec4(lightPlaneNormal, lightPlaneConstant));
    float t3 = planeIntersect(endPos3, endDir3, vec4(lightPlaneNormal, lightPlaneConstant));
    float t4 = planeIntersect(endPos4, endDir4, vec4(lightPlaneNormal, lightPlaneConstant));
    vec3 finalPos1 = endPos1 + endDir1 * t1;
    vec3 finalPos2 = endPos2 + endDir2 * t2;
    vec3 finalPos3 = endPos3 + endDir3 * t3;
    vec3 finalPos4 = endPos4 + endDir4 * t4;
    float finalArea = length(cross(finalPos2 - finalPos1, finalPos3 - finalPos1)) + length(cross(finalPos3 - finalPos1, finalPos4 - finalPos1));
    caustic += intensity * (lightPosArea / finalArea);
    // Calculate the area of the triangle in light spaces
    gl_FragColor = vec4(vec3(max(caustic, 0.0)), 1.0);
  }`),q1={depth:!0,minFilter:Ht,magFilter:Ht,type:Hi},J1={minFilter:Nl,magFilter:Ht,type:ii,generateMipmaps:!0},yF=g.forwardRef(({debug:r,children:e,frames:t=1,ior:i=1.1,color:n="white",causticsOnly:s=!1,backside:o=!1,backsideIOR:a=1.1,worldRadius:l=.3125,intensity:c=.05,resolution:u=2024,lightSource:h=[5,5,5],...f},d)=>{Ii({CausticsProjectionMaterial:L7});const m=g.useRef(null),A=g.useRef(null),p=g.useRef(null),y=g.useRef(null),E=le(F=>F.gl),v=D3(r&&A,gC),x=gn(u,u,q1),C=gn(u,u,q1),I=gn(u,u,J1),_=gn(u,u,J1),[S]=g.useState(()=>X1()),[b]=g.useState(()=>X1(ma)),[T]=g.useState(()=>new P7),[R]=g.useState(()=>new Zs(T));g.useLayoutEffect(()=>{m.current.updateWorldMatrix(!1,!0)});let w=0;const B=new z,D=new jy,k=new we,Q=new or,Y=new z,W=new z,P=new Yt,K=new z,M=[],V=[],$=[],G=[],O=new z;for(let F=0;F<8;F++)M.push(new z),V.push(new z),$.push(new z),G.push(new z);return He(()=>{if(t===1/0||w++<t){var F,U;Array.isArray(h)?Y.fromArray(h).normalize():Y.copy(m.current.worldToLocal(h.current.getWorldPosition(B)).normalize()),W.copy(Y).multiplyScalar(-1),(F=p.current.parent)==null||F.matrixWorld.identity(),P.setFromObject(p.current,!0),M[0].set(P.min.x,P.min.y,P.min.z),M[1].set(P.min.x,P.min.y,P.max.z),M[2].set(P.min.x,P.max.y,P.min.z),M[3].set(P.min.x,P.max.y,P.max.z),M[4].set(P.max.x,P.min.y,P.min.z),M[5].set(P.max.x,P.min.y,P.max.z),M[6].set(P.max.x,P.max.y,P.min.z),M[7].set(P.max.x,P.max.y,P.max.z);for(let J=0;J<8;J++)V[J].copy(M[J]);P.getCenter(K),M.map(J=>J.sub(K));const N=Q.set(W,0);M.map((J,X)=>N.projectPoint(J,$[X]));const Z=$.reduce((J,X)=>J.add(X),B.set(0,0,0)).divideScalar($.length),ie=$.map(J=>J.distanceTo(Z)).reduce((J,X)=>Math.max(J,X)),q=M.map(J=>J.dot(Y)).reduce((J,X)=>Math.max(J,X));A.current.position.copy(O.copy(Y).multiplyScalar(q).add(K)),A.current.lookAt(p.current.localToWorld(K));const ne=k.lookAt(A.current.position,K,B.set(0,1,0));A.current.left=-ie,A.current.right=ie,A.current.top=ie,A.current.bottom=-ie;const ye=B.set(0,ie,0).applyMatrix4(ne),ve=(A.current.position.y+ye.y)/Y.y;A.current.near=.1,A.current.far=ve,A.current.updateProjectionMatrix(),A.current.updateMatrixWorld();const re=V.map((J,X)=>J.add(G[X].copy(Y).multiplyScalar(-J.y/Y.y))),se=re.reduce((J,X)=>J.add(X),B.set(0,0,0)).divideScalar(re.length),he=2*re.map(J=>Math.hypot(J.x-se.x,J.z-se.z)).reduce((J,X)=>Math.max(J,X));y.current.scale.setScalar(he),y.current.position.copy(se),r&&((U=v.current)==null||U.update()),b.viewMatrix.value=S.viewMatrix.value=A.current.matrixWorldInverse;const ae=D.setFromProjectionMatrix(k.multiplyMatrices(A.current.projectionMatrix,A.current.matrixWorldInverse)).planes[4];T.cameraMatrixWorld=A.current.matrixWorld,T.cameraProjectionMatrixInv=A.current.projectionMatrixInverse,T.lightDir=W,T.lightPlaneNormal=ae.normal,T.lightPlaneConstant=ae.constant,T.near=A.current.near,T.far=A.current.far,T.resolution=u,T.size=ie,T.intensity=c,T.worldRadius=l,p.current.visible=!0,E.setRenderTarget(x),E.clear(),p.current.overrideMaterial=S,E.render(p.current,A.current),E.setRenderTarget(C),E.clear(),o&&(p.current.overrideMaterial=b,E.render(p.current,A.current)),p.current.overrideMaterial=null,T.ior=i,y.current.material.lightProjMatrix=A.current.projectionMatrix,y.current.material.lightViewMatrix=A.current.matrixWorldInverse,T.normalTexture=x.texture,T.depthTexture=x.depthTexture,E.setRenderTarget(I),E.clear(),R.render(E),T.ior=a,T.normalTexture=C.texture,T.depthTexture=C.depthTexture,E.setRenderTarget(_),E.clear(),o&&R.render(E),E.setRenderTarget(null),s&&(p.current.visible=!1)}}),g.useImperativeHandle(d,()=>m.current,[]),g.createElement("group",Ae({ref:m},f),g.createElement("scene",{ref:p},g.createElement("orthographicCamera",{ref:A,up:[0,1,0]}),e),g.createElement("mesh",{renderOrder:2,ref:y,"rotation-x":-Math.PI/2},g.createElement("planeGeometry",null),g.createElement("causticsProjectionMaterial",{transparent:!0,color:n,causticsTexture:I.texture,causticsTextureB:_.texture,blending:n2,blendSrc:s2,blendDst:yC,depthWrite:!1}),r&&g.createElement(_6,null,g.createElement("lineBasicMaterial",{color:"#ffff00",toneMapped:!1}))))});class F7 extends gi{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new z(0,0,0)},lightColor:{value:new Ye("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new De(0,0)}},transparent:!0,depthWrite:!1,vertexShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;
        uniform vec3 spotPosition;
        uniform float attenuation;

        #include <common>
        #include <logdepthbuf_pars_vertex>

        void main() {
          // compute intensity
          vNormal = normalize(normalMatrix * normal);
          vec4 worldPosition = modelMatrix * vec4(position, 1);
          vec4 viewPosition = viewMatrix * worldPosition;
          vViewZ = viewPosition.z;

          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);

          gl_Position = projectionMatrix * viewPosition;

          #include <logdepthbuf_vertex>
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;

        uniform vec3 lightColor;
        uniform float anglePower;
        uniform sampler2D depth;
        uniform vec2 resolution;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float opacity;

        #include <packing>
        #include <logdepthbuf_pars_fragment>

        float readDepth(sampler2D depthSampler, vec2 uv) {
          float fragCoordZ = texture(depthSampler, uv).r;

          // https://github.com/mrdoob/three.js/issues/23072
          #ifdef USE_LOGDEPTHBUF
            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));
          #else
            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
          #endif

          return viewZ;
        }

        void main() {
          #include <logdepthbuf_fragment>

          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);
          float intensity = vIntensity * angleIntensity;

          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry
          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;
          if (isSoft) {
            vec2 uv = gl_FragCoord.xy / resolution;
            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));
          }

          gl_FragColor = vec4(lightColor, intensity * opacity);

          #include <tonemapping_fragment>
          #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}}var k7=`#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}`;const O7=r=>r==null?void 0:r.isSpotLight;function U7({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5}){const c=g.useRef(null),u=le(p=>p.size),h=le(p=>p.camera),f=le(p=>p.viewport.dpr),[d]=g.useState(()=>new F7),[m]=g.useState(()=>new z);e=e===void 0?.1:e,t=t===void 0?o*7:t,He(()=>{d.uniforms.spotPosition.value.copy(c.current.getWorldPosition(m)),c.current.lookAt(c.current.parent.target.getWorldPosition(m))});const A=g.useMemo(()=>{const p=new Gn(e,t,s,128,64,!0);return p.applyMatrix4(new we().makeTranslation(0,-s/2,0)),p.applyMatrix4(new we().makeRotationX(-Math.PI/2)),p},[s,e,t]);return g.createElement(g.Fragment,null,g.createElement("mesh",{ref:c,geometry:A,raycast:()=>null},g.createElement("primitive",{object:d,attach:"material","uniforms-opacity-value":r,"uniforms-lightColor-value":n,"uniforms-attenuation-value":a,"uniforms-anglePower-value":l,"uniforms-depth-value":i,"uniforms-cameraNear-value":h.near,"uniforms-cameraFar-value":h.far,"uniforms-resolution-value":i?[u.width*f,u.height*f]:[0,0]})))}function rx(r,e,t,i,n){const[[s,o]]=g.useState(()=>[new z,new z]);g.useLayoutEffect(()=>{if(O7(r.current))r.current.shadow.mapSize.set(t,i),r.current.shadow.needsUpdate=!0;else throw new Error("SpotlightShadow must be a child of a SpotLight")},[r,t,i]),He(()=>{if(!r.current)return;const a=r.current.position,l=r.current.target.position;o.copy(l).sub(a);var c=o.length();o.normalize().multiplyScalar(c*n),s.copy(a).add(o),e.current.position.copy(s),e.current.lookAt(r.current.target.position)})}function N7({distance:r=.4,alphaTest:e=.5,map:t,shader:i=k7,width:n=512,height:s=512,scale:o=1,children:a,...l}){const c=g.useRef(null),u=l.spotlightRef,h=l.debug;rx(u,c,n,s,r);const f=g.useMemo(()=>new Ti(n,s,{format:wi,stencilBuffer:!1}),[n,s]),d=g.useRef({uShadowMap:{value:t},uTime:{value:0}});g.useEffect(()=>void(d.current.uShadowMap.value=t),[t]);const m=g.useMemo(()=>new Zs(new gi({uniforms:d.current,vertexShader:`
          varying vec2 vUv;

          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
          `,fragmentShader:i})),[i]);return g.useEffect(()=>()=>{m.material.dispose(),m.dispose()},[m]),g.useEffect(()=>()=>f.dispose(),[f]),He(({gl:A},p)=>{d.current.uTime.value+=p,A.setRenderTarget(f),m.render(A),A.setRenderTarget(null)}),g.createElement(g.Fragment,null,g.createElement("mesh",{ref:c,scale:o,castShadow:!0},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,side:xi,alphaTest:e,alphaMap:f.texture,"alphaMap-wrapS":Pn,"alphaMap-wrapT":Pn,opacity:h?1:0},a)))}function G7({distance:r=.4,alphaTest:e=.5,map:t,width:i=512,height:n=512,scale:s,children:o,...a}){const l=g.useRef(null),c=a.spotlightRef,u=a.debug;return rx(c,l,i,n,r),g.createElement(g.Fragment,null,g.createElement("mesh",{ref:l,scale:s,castShadow:!0},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,side:xi,alphaTest:e,alphaMap:t,"alphaMap-wrapS":Pn,"alphaMap-wrapT":Pn,opacity:u?1:0},o)))}function vF(r){return r.shader?g.createElement(N7,r):g.createElement(G7,r)}const EF=g.forwardRef(({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5,volumetric:c=!0,debug:u=!1,children:h,...f},d)=>{const m=g.useRef(null);return g.useImperativeHandle(d,()=>m.current,[]),g.createElement("group",null,u&&m.current&&g.createElement("spotLightHelper",{args:[m.current]}),g.createElement("spotLight",Ae({ref:m,angle:o,color:n,distance:s,castShadow:!0},f),c&&g.createElement(U7,{debug:u,opacity:r,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n,distance:s,angle:o,attenuation:a,anglePower:l})),h&&g.cloneElement(h,{spotlightRef:m,debug:u}))}),xF=g.forwardRef(({light:r,args:e,map:t,toneMapped:i=!1,color:n="white",form:s="rect",intensity:o=1,scale:a=1,target:l=[0,0,0],children:c,...u},h)=>{const f=g.useRef(null);return g.useImperativeHandle(h,()=>f.current,[]),g.useLayoutEffect(()=>{!c&&!u.material&&(Wn(f.current.material,{color:n}),f.current.material.color.multiplyScalar(o))},[n,o,c,u.material]),g.useLayoutEffect(()=>{u.rotation||f.current.quaternion.identity(),l&&!u.rotation&&(typeof l=="boolean"?f.current.lookAt(0,0,0):f.current.lookAt(Array.isArray(l)?new z(...l):l))},[l,u.rotation]),a=Array.isArray(a)&&a.length===2?[a[0],a[1],1]:a,g.createElement("mesh",Ae({ref:f,scale:a},u),s==="circle"?g.createElement("ringGeometry",{args:e||[0,.5,64]}):s==="ring"?g.createElement("ringGeometry",{args:e||[.25,.5,64]}):s==="rect"||s==="plane"?g.createElement("planeGeometry",{args:e||[1,1]}):s==="box"?g.createElement("boxGeometry",{args:e||[1,1,1]}):g.createElement(s,{args:e}),c||g.createElement("meshBasicMaterial",{toneMapped:i,map:t,side:xi}),r&&g.createElement("pointLight",Ae({castShadow:!0},r)))});function Q7(r,e,t=new z){const i=Math.PI*(r-.5),n=2*Math.PI*(e-.5);return t.x=Math.cos(n),t.y=Math.sin(i),t.z=Math.sin(n),t}const CF=g.forwardRef(({inclination:r=.6,azimuth:e=.1,distance:t=1e3,mieCoefficient:i=.005,mieDirectionalG:n=.8,rayleigh:s=.5,turbidity:o=10,sunPosition:a=Q7(r,e),...l},c)=>{const u=g.useMemo(()=>new z().setScalar(t),[t]),[h]=g.useState(()=>new __);return g.createElement("primitive",Ae({object:h,ref:c,"material-uniforms-mieCoefficient-value":i,"material-uniforms-mieDirectionalG-value":n,"material-uniforms-rayleigh-value":s,"material-uniforms-sunPosition-value":a,"material-uniforms-turbidity-value":o,scale:u},l))});class z7 extends gi{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const H7=r=>new z().setFromSpherical(new aa(r,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),IF=g.forwardRef(({radius:r=100,depth:e=50,count:t=5e3,saturation:i=0,factor:n=4,fade:s=!1,speed:o=1},a)=>{const l=g.useRef(null),[c,u,h]=g.useMemo(()=>{const d=[],m=[],A=Array.from({length:t},()=>(.5+.5*Math.random())*n),p=new Ye;let y=r+e;const E=e/t;for(let v=0;v<t;v++)y-=E*Math.random(),d.push(...H7(y).toArray()),p.setHSL(v/t,i,.9),m.push(p.r,p.g,p.b);return[new Float32Array(d),new Float32Array(m),new Float32Array(A)]},[t,e,n,r,i]);He(d=>l.current&&(l.current.uniforms.time.value=d.clock.elapsedTime*o));const[f]=g.useState(()=>new z7);return g.createElement("points",{ref:a},g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[c,3]}),g.createElement("bufferAttribute",{attach:"attributes-color",args:[u,3]}),g.createElement("bufferAttribute",{attach:"attributes-size",args:[h,1]})),g.createElement("primitive",{ref:l,object:f,attach:"material",blending:EC,"uniforms-fade-value":s,depthWrite:!1,transparent:!0,vertexColors:!0}))}),V7="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",Z1=new we,tu=new z,iu=new nt,ey=new z,ty=new nt,ol=new z,Pm=g.createContext(null),K7=g.forwardRef(({children:r,material:e=w0,texture:t=V7,range:i,limit:n=200,frustumCulled:s,...o},a)=>{var l,c;const u=g.useMemo(()=>class extends e{constructor(){super();const S=parseInt(Ul.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=b=>{b.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+b.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),b.fragmentShader=`varying float vOpacity;
              `+b.fragmentShader.replace(`#include <${S}>`,`#include <${S}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}},[e]);Ii({CloudMaterial:u});const h=g.useRef(null),f=g.useRef([]),d=g.useMemo(()=>new Float32Array(Array.from({length:n},()=>1)),[n]),m=g.useMemo(()=>new Float32Array(Array.from({length:n},()=>[1,1,1]).flat()),[n]),A=ao(t);let p=0,y=0,E;const v=new nt,x=new z(0,0,1),C=new z;He((S,b)=>{for(p=S.clock.elapsedTime,Z1.copy(h.current.matrixWorld).invert(),S.camera.matrixWorld.decompose(ey,ty,ol),y=0;y<f.current.length;y++)E=f.current[y],E.ref.current.matrixWorld.decompose(tu,iu,ol),tu.add(C.copy(E.position).applyQuaternion(iu).multiply(ol)),iu.copy(ty).multiply(v.setFromAxisAngle(x,E.rotation+=b*E.rotationFactor)),ol.multiplyScalar(E.volume+(1+Math.sin(p*E.density*E.speed))/2*E.growth),E.matrix.compose(tu,iu,ol).premultiply(Z1),E.dist=tu.distanceTo(ey);for(f.current.sort((T,R)=>R.dist-T.dist),y=0;y<f.current.length;y++)E=f.current[y],d[y]=E.opacity*(E.dist<E.fade-1?E.dist/E.fade:1),h.current.setMatrixAt(y,E.matrix),h.current.setColorAt(y,E.color);h.current.geometry.attributes.cloudOpacity.needsUpdate=!0,h.current.instanceMatrix.needsUpdate=!0,h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}),g.useLayoutEffect(()=>{const S=Math.min(n,i!==void 0?i:n,f.current.length);h.current.count=S,bl(h.current.instanceMatrix,{start:0,count:S*16}),h.current.instanceColor&&bl(h.current.instanceColor,{start:0,count:S*3}),bl(h.current.geometry.attributes.cloudOpacity,{start:0,count:S})});let I=[(l=A.image.width)!==null&&l!==void 0?l:1,(c=A.image.height)!==null&&c!==void 0?c:1];const _=Math.max(I[0],I[1]);return I=[I[0]/_,I[1]/_],g.createElement("group",Ae({ref:a},o),g.createElement(Pm.Provider,{value:f},r,g.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:h,args:[null,null,n],frustumCulled:s},g.createElement("instancedBufferAttribute",{usage:Ji,attach:"instanceColor",args:[m,3]}),g.createElement("planeGeometry",{args:[...I]},g.createElement("instancedBufferAttribute",{usage:Ji,attach:"attributes-cloudOpacity",args:[d,1]})),g.createElement("cloudMaterial",{key:e.name,map:A,transparent:!0,depthWrite:!1}))))}),iy=g.forwardRef(({opacity:r=1,speed:e=0,bounds:t=[5,1,1],segments:i=20,color:n="#ffffff",fade:s=10,volume:o=6,smallestVolume:a=.25,distribute:l=null,growth:c=4,concentrate:u="inside",seed:h=Math.random(),...f},d)=>{function m(){const v=Math.sin(h++)*1e4;return v-Math.floor(v)}const A=g.useContext(Pm),p=g.useRef(null),y=g.useId(),E=g.useMemo(()=>[...new Array(i)].map((v,x)=>({segments:i,bounds:new z(1,1,1),position:new z,uuid:y,index:x,ref:p,dist:0,matrix:new we,color:new Ye,rotation:x*(Math.PI/i)})),[i,y]);return g.useLayoutEffect(()=>{E.forEach((v,x)=>{Wn(v,{volume:o,color:n,speed:e,growth:c,opacity:r,fade:s,bounds:t,density:Math.max(.5,m()),rotationFactor:Math.max(.2,.5*m())*e});const C=l==null?void 0:l(v,x);if(C||i>1){var I;v.position.copy(v.bounds).multiply((I=C==null?void 0:C.point)!==null&&I!==void 0?I:{x:m()*2-1,y:m()*2-1,z:m()*2-1})}const _=Math.abs(v.position.x),S=Math.abs(v.position.y),b=Math.abs(v.position.z),T=Math.max(_,S,b);v.length=1,_===T&&(v.length-=_/v.bounds.x),S===T&&(v.length-=S/v.bounds.y),b===T&&(v.length-=b/v.bounds.z),v.volume=((C==null?void 0:C.volume)!==void 0?C.volume:Math.max(Math.max(0,a),u==="random"?m():u==="inside"?v.length:1-v.length))*o})},[u,t,s,n,r,c,o,h,i,e]),g.useLayoutEffect(()=>{const v=E;return A.current=[...A.current,...v],()=>{A.current=A.current.filter(x=>x.uuid!==y)}},[E]),g.useImperativeHandle(d,()=>p.current,[]),g.createElement("group",Ae({ref:p},f))}),_F=g.forwardRef((r,e)=>g.useContext(Pm)?g.createElement(iy,Ae({ref:e},r)):g.createElement(K7,null,g.createElement(iy,Ae({ref:e},r))));class $7 extends gi{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:`
        uniform float pixelRatio;
        uniform float time;
        attribute float size;  
        attribute float speed;  
        attribute float opacity;
        attribute vec3 noise;
        attribute vec3 color;
        varying vec3 vColor;
        varying float vOpacity;

        void main() {
          vec4 modelPosition = modelMatrix * vec4(position, 1.0);
          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
          vec4 viewPosition = viewMatrix * modelPosition;
          vec4 projectionPostion = projectionMatrix * viewPosition;
          gl_Position = projectionPostion;
          gl_PointSize = size * 25. * pixelRatio;
          gl_PointSize *= (1.0 / - viewPosition.z);
          vColor = color;
          vOpacity = opacity;
        }
      `,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
          float strength = 0.05 / distanceToCenter - 0.1;
          gl_FragColor = vec4(vColor, strength * vOpacity);
          #include <tonemapping_fragment>
          #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(e){this.uniforms.pixelRatio.value=e}}const ox=r=>r&&r.constructor===Float32Array,Y7=r=>[r.r,r.g,r.b],ax=r=>r instanceof De||r instanceof z||r instanceof Ci,lx=r=>Array.isArray(r)?r:ax(r)?r.toArray():[r,r,r];function al(r,e,t){return g.useMemo(()=>{if(e!==void 0){if(ox(e))return e;if(e instanceof Ye){const i=Array.from({length:r*3},()=>Y7(e)).flat();return Float32Array.from(i)}else if(ax(e)||Array.isArray(e)){const i=Array.from({length:r*3},()=>lx(e)).flat();return Float32Array.from(i)}return Float32Array.from({length:r},()=>e)}return Float32Array.from({length:r},t)},[e])}const SF=g.forwardRef(({noise:r=1,count:e=100,speed:t=1,opacity:i=1,scale:n=1,size:s,color:o,children:a,...l},c)=>{g.useMemo(()=>Ii({SparklesImplMaterial:$7}),[]);const u=g.useRef(null),h=le(v=>v.viewport.dpr),f=lx(n),d=g.useMemo(()=>Float32Array.from(Array.from({length:e},()=>f.map(et.randFloatSpread)).flat()),[e,...f]),m=al(e,s,Math.random),A=al(e,i),p=al(e,t),y=al(e*3,r),E=al(o===void 0?e*3:e,ox(o)?o:new Ye(o),()=>1);return He(v=>{u.current&&u.current.material&&(u.current.material.time=v.clock.elapsedTime)}),g.useImperativeHandle(c,()=>u.current,[]),g.createElement("points",Ae({key:`particle-${e}-${JSON.stringify(n)}`},l,{ref:u}),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),g.createElement("bufferAttribute",{attach:"attributes-size",args:[m,1]}),g.createElement("bufferAttribute",{attach:"attributes-opacity",args:[A,1]}),g.createElement("bufferAttribute",{attach:"attributes-speed",args:[p,1]}),g.createElement("bufferAttribute",{attach:"attributes-color",args:[E,3]}),g.createElement("bufferAttribute",{attach:"attributes-noise",args:[y,3]})),a||g.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:h,depthWrite:!1}))});function W7(r){switch(r){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}const j7="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",X7="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function q7(r=0,e=1024,t){const i=ar(()=>fetch(j7).then(u=>u.json()),["matcapList"]),n=i[0],s=g.useMemo(()=>Object.keys(i).length,[]),a=`${g.useMemo(()=>typeof r=="string"?r:typeof r=="number"?i[r]:null,[r])||n}${W7(e)}.png`,l=`${X7}/${e}/${a}`;return[ao(l,t),l,s]}const TF=({children:r,id:e,format:t,onLoad:i})=>{const n=q7(e,t,i);return g.createElement(g.Fragment,null,r==null?void 0:r(n))},J7="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",Z7="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function eM(r=0,e={},t){const{repeat:i=[1,1],anisotropy:n=1,offset:s=[0,0]}=e,o=ar(()=>fetch(Z7).then(f=>f.json()),["normalsList"]),a=g.useMemo(()=>Object.keys(o).length,[]),l=o[0],c=o[r]||l,u=`${J7}/normals/${c}`,h=ao(u,t);return g.useLayoutEffect(()=>{h&&(h.wrapS=h.wrapT=Pn,h.repeat=new De(i[0],i[1]),h.offset=new De(s[0],s[1]),h.anisotropy=n)},[h,n,i,s]),[h,u,a]}const bF=({children:r,id:e,onLoad:t,...i})=>{const n=eM(e,i,t);return g.createElement(g.Fragment,null,r==null?void 0:r(n))},Tr={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new Ye("#ff0000"),backfaceStroke:new Ye("#0000ff"),fill:new Ye("#00ff00")},vertex:`
	  attribute vec3 barycentric;
	
		varying vec3 v_edges_Barycentric;
		varying vec3 v_edges_Position;

		void initWireframe() {
			v_edges_Barycentric = barycentric;
			v_edges_Position = position.xyz;
		}
	  `,fragment:`
		#ifndef PI
	  	#define PI 3.1415926535897932384626433832795
		#endif
  
	  varying vec3 v_edges_Barycentric;
	  varying vec3 v_edges_Position;
  
	  uniform float strokeOpacity;
	  uniform float fillOpacity;
	  uniform float fillMix;
	  uniform float thickness;
	  uniform bool colorBackfaces;
  
	  // Dash
	  uniform bool dashInvert;
	  uniform bool dash;
	  uniform bool dashOnly;
	  uniform float dashRepeats;
	  uniform float dashLength;
  
	  // Squeeze
	  uniform bool squeeze;
	  uniform float squeezeMin;
	  uniform float squeezeMax;
  
	  // Colors
	  uniform vec3 stroke;
	  uniform vec3 backfaceStroke;
	  uniform vec3 fill;
  
	  // This is like
	  float wireframe_aastep(float threshold, float dist) {
		  float afwidth = fwidth(dist) * 0.5;
		  return smoothstep(threshold - afwidth, threshold + afwidth, dist);
	  }
  
	  float wireframe_map(float value, float min1, float max1, float min2, float max2) {
		  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
	  }
  
	  float getWireframe() {
			vec3 barycentric = v_edges_Barycentric;
		
			// Distance from center of each triangle to its edges.
			float d = min(min(barycentric.x, barycentric.y), barycentric.z);

			// for dashed rendering, we can use this to get the 0 .. 1 value of the line length
			float positionAlong = max(barycentric.x, barycentric.y);
			if (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {
				positionAlong = 1.0 - positionAlong;
			}

			// the thickness of the stroke
			float computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);

			// if we want to shrink the thickness toward the center of the line segment
			if (squeeze) {
				computedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));
			}

			// Create dash pattern
			if (dash) {
				// here we offset the stroke position depending on whether it
				// should overlap or not
				float offset = 1.0 / dashRepeats * dashLength / 2.0;
				if (!dashInvert) {
					offset += 1.0 / dashRepeats / 2.0;
				}

				// if we should animate the dash or not
				// if (dashAnimate) {
				// 	offset += time * 0.22;
				// }

				// create the repeating dash pattern
				float pattern = fract((positionAlong + offset) * dashRepeats);
				computedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);
			}

			// compute the anti-aliased stroke edge  
			float edge = 1.0 - wireframe_aastep(computedThickness, d);

			return edge;
	  }
	  `},tM=ps(Tr.uniforms,Tr.vertex+`
  	void main() {
		initWireframe();
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}
  `,Tr.fragment+`
  void main () {
		// Compute color

		float edge = getWireframe();
		vec4 colorStroke = vec4(stroke, edge);

		#ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		#endif
    
		vec4 colorFill = vec4(fill, fillOpacity);
		vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		gl_FragColor = outColor;
	}
  `);function iM(r,e){r.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...e},t.vertexShader=t.vertexShader.replace("void main() {",`
		  ${Tr.vertex}
		  void main() {
			initWireframe();
		`),t.fragmentShader=t.fragmentShader.replace("void main() {",`
		  ${Tr.fragment}
		  void main() {
		`),t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>",`
		  #include <color_fragment>
			  float edge = getWireframe();
		  vec4 colorStroke = vec4(stroke, edge);
		  #ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		  #endif
		  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));
		  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		  diffuseColor.rgb = outColor.rgb;
		  diffuseColor.a *= outColor.a;
		`)},r.side=xi,r.transparent=!0}function nM(r,e){g.useEffect(()=>{var t;return void(r.fillOpacity.value=(t=e.fillOpacity)!==null&&t!==void 0?t:r.fillOpacity.value)},[e.fillOpacity]),g.useEffect(()=>{var t;return void(r.fillMix.value=(t=e.fillMix)!==null&&t!==void 0?t:r.fillMix.value)},[e.fillMix]),g.useEffect(()=>{var t;return void(r.strokeOpacity.value=(t=e.strokeOpacity)!==null&&t!==void 0?t:r.strokeOpacity.value)},[e.strokeOpacity]),g.useEffect(()=>{var t;return void(r.thickness.value=(t=e.thickness)!==null&&t!==void 0?t:r.thickness.value)},[e.thickness]),g.useEffect(()=>void(r.colorBackfaces.value=!!e.colorBackfaces),[e.colorBackfaces]),g.useEffect(()=>void(r.dash.value=!!e.dash),[e.dash]),g.useEffect(()=>void(r.dashInvert.value=!!e.dashInvert),[e.dashInvert]),g.useEffect(()=>{var t;return void(r.dashRepeats.value=(t=e.dashRepeats)!==null&&t!==void 0?t:r.dashRepeats.value)},[e.dashRepeats]),g.useEffect(()=>{var t;return void(r.dashLength.value=(t=e.dashLength)!==null&&t!==void 0?t:r.dashLength.value)},[e.dashLength]),g.useEffect(()=>void(r.squeeze.value=!!e.squeeze),[e.squeeze]),g.useEffect(()=>{var t;return void(r.squeezeMin.value=(t=e.squeezeMin)!==null&&t!==void 0?t:r.squeezeMin.value)},[e.squeezeMin]),g.useEffect(()=>{var t;return void(r.squeezeMax.value=(t=e.squeezeMax)!==null&&t!==void 0?t:r.squeezeMax.value)},[e.squeezeMax]),g.useEffect(()=>void(r.stroke.value=e.stroke?new Ye(e.stroke):r.stroke.value),[e.stroke]),g.useEffect(()=>void(r.fill.value=e.fill?new Ye(e.fill):r.fill.value),[e.fill]),g.useEffect(()=>void(r.backfaceStroke.value=e.backfaceStroke?new Ye(e.backfaceStroke):r.backfaceStroke.value),[e.backfaceStroke])}function sM(r){return!!(r!=null&&r.geometry)}function rM(r){return!!(r!=null&&r.isBufferGeometry)}function oM(r){return!!(r!=null&&r.current)}function ny(r){return(r==null?void 0:r.current)!==void 0}function sy(r){return r.type==="WireframeGeometry"}function aM(){const r={};for(const e in Tr.uniforms)r[e]={value:Tr.uniforms[e]};return r}function lM(r,e){const i=r.getAttribute("position").count,n=[];for(let s=0;s<i;s++){const o=s%2===0,a=e?1:0;o?n.push(0,0,1,0,1,0,1,0,a):n.push(0,1,0,0,0,1,1,0,a)}return new Nt(Float32Array.from(n),3)}function cx(r){const e=oM(r)?r.current:r;if(rM(e))return e;{if(sy(e))throw new Error("Wireframe: WireframeGeometry is not supported.");const t=e.parent;if(sM(t)){if(sy(t.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return t.geometry}}}function ux(r,e){if(r.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const i=r.toNonIndexed();r.copy(i),r.setIndex(null)}const t=lM(r,e);r.setAttribute("barycentric",t)}function cM({geometry:r,simplify:e=!1,...t}){Ii({MeshWireframeMaterial:tM});const[i,n]=g.useState(null);g.useLayoutEffect(()=>{const o=cx(r);if(!o)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");ux(o,e),ny(r)&&n(o)},[e,r]);const s=ny(r)?i:r;return g.createElement(g.Fragment,null,s&&g.createElement("mesh",{geometry:s},g.createElement("meshWireframeMaterial",Ae({attach:"material",transparent:!0,side:xi,polygonOffset:!0,polygonOffsetFactor:-4},t,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function uM({simplify:r=!1,...e}){const t=g.useRef(null),i=g.useMemo(()=>aM(),[Tr.uniforms]);return nM(i,e),g.useLayoutEffect(()=>{const n=cx(t);if(!n)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const s=n.clone();return ux(n,r),()=>{n.copy(s),s.dispose()}},[r]),g.useLayoutEffect(()=>{const n=t.current.parent,s=n.material.clone();return iM(n.material,i),()=>{n.material.dispose(),n.material=s}},[]),g.createElement("object3D",{ref:t})}function wF({geometry:r,...e}){return r?g.createElement(cM,Ae({geometry:r},e)):g.createElement(uM,e)}function BF({opacity:r,alphaMap:e}){const t=g.useRef(null),i=g.useRef(null),n=g.useRef({value:1}),s=g.useRef({value:null}),o=g.useRef({value:!1});return g.useLayoutEffect(()=>{t.current.onBeforeCompile=i.current.onBeforeCompile=a=>{const l=a.fragmentShader.indexOf("void main");let c="",u,h=l;for(;u!==`
`&&h<l+100;)u=a.fragmentShader.charAt(h),c+=u,h++;c=c.trim(),a.vertexShader=a.vertexShader.replace("void main() {",`
        varying vec2 custom_vUv;

        void main() {
          custom_vUv = uv;
          
        `),a.fragmentShader=a.fragmentShader.replace(c,`
          uniform float uShadowOpacity;
          uniform sampler2D uAlphaMap;
          uniform bool uHasAlphaMap;

          varying vec2 custom_vUv;
  
          float bayerDither2x2( vec2 v ) {
            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );
          }
    
          float bayerDither4x4( vec2 v ) {
            vec2 P1 = mod( v, 2.0 );
            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );
            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );
          }
  
          void main() {
            float alpha = 
              uHasAlphaMap ? 
                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x
              : uShadowOpacity;

            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;
            
          `),a.uniforms.uShadowOpacity=n.current,a.uniforms.uAlphaMap=s.current,a.uniforms.uHasAlphaMap=o.current}},[]),He(()=>{var a;const l=(a=t.current.__r3f)==null||(a=a.parent)==null?void 0:a.object;if(l){const c=l.material;c&&(n.current.value=r??c.opacity,e===!1?(s.current.value=null,o.current.value=!1):(s.current.value=e||c.alphaMap,o.current.value=!!s.current.value))}}),g.createElement(g.Fragment,null,g.createElement("meshDepthMaterial",{ref:t,attach:"customDepthMaterial",depthPacking:i2}),g.createElement("meshDistanceMaterial",{ref:i,attach:"customDistanceMaterial"}))}const ry=new we,sd=new Aa,oy=new on,hM=new z;class fM extends tr{constructor(){super(),this.size=0,this.color=new Ye("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){var i,n;const s=this.instance.current;if(!s||!s.geometry)return;const o=s.userData.instances.indexOf(this.instanceKey);if(o===-1||o>s.geometry.drawRange.count)return;const a=(i=(n=e.params.Points)==null?void 0:n.threshold)!==null&&i!==void 0?i:1;if(oy.set(this.getWorldPosition(hM),a),e.ray.intersectsSphere(oy)===!1)return;ry.copy(s.matrixWorld).invert(),sd.copy(e.ray).applyMatrix4(ry);const l=a/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,u=sd.distanceSqToPoint(this.position);if(u<c){const h=new z;sd.closestPointToPoint(this.position,h),h.applyMatrix4(this.matrixWorld);const f=e.ray.origin.distanceTo(h);if(f<e.near||f>e.far)return;t.push({distance:f,distanceToRay:Math.sqrt(u),point:h,index:o,face:null,object:this})}}}let $r,ll;const hx=g.createContext(null),ay=new we,ly=new z,dM=g.forwardRef(({children:r,range:e,limit:t=1e3,...i},n)=>{const s=g.useRef(null);g.useImperativeHandle(n,()=>s.current,[]);const[o,a]=g.useState([]),[[l,c,u]]=g.useState(()=>[new Float32Array(t*3),Float32Array.from({length:t*3},()=>1),Float32Array.from({length:t},()=>1)]);g.useEffect(()=>{s.current.geometry.attributes.position.needsUpdate=!0}),He(()=>{for(s.current.updateMatrix(),s.current.updateMatrixWorld(),ay.copy(s.current.matrixWorld).invert(),s.current.geometry.drawRange.count=Math.min(t,e!==void 0?e:t,o.length),$r=0;$r<o.length;$r++)ll=o[$r].current,ll.getWorldPosition(ly).applyMatrix4(ay),ly.toArray(l,$r*3),s.current.geometry.attributes.position.needsUpdate=!0,ll.matrixWorldNeedsUpdate=!0,ll.color.toArray(c,$r*3),s.current.geometry.attributes.color.needsUpdate=!0,u.set([ll.size],$r),s.current.geometry.attributes.size.needsUpdate=!0});const h=g.useMemo(()=>({getParent:()=>s,subscribe:f=>(a(d=>[...d,f]),()=>a(d=>d.filter(m=>m.current!==f.current)))}),[]);return g.createElement("points",Ae({userData:{instances:o},matrixAutoUpdate:!1,ref:s,raycast:()=>null},i),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[l,3],usage:Ji}),g.createElement("bufferAttribute",{attach:"attributes-color",args:[c,3],usage:Ji}),g.createElement("bufferAttribute",{attach:"attributes-size",args:[u,1],usage:Ji})),g.createElement(hx.Provider,{value:h},r))}),RF=g.forwardRef(({children:r,...e},t)=>{g.useMemo(()=>Ii({PositionPoint:fM}),[]);const i=g.useRef(null);g.useImperativeHandle(t,()=>i.current,[]);const{subscribe:n,getParent:s}=g.useContext(hx);return g.useLayoutEffect(()=>n(i),[]),g.createElement("positionPoint",Ae({instance:s(),instanceKey:i,ref:i},e),r)}),mM=g.forwardRef(({children:r,positions:e,colors:t,sizes:i,stride:n=3,...s},o)=>{const a=g.useRef(null);return g.useImperativeHandle(o,()=>a.current,[]),He(()=>{const l=a.current.geometry.attributes;l.position.needsUpdate=!0,t&&(l.color.needsUpdate=!0),i&&(l.size.needsUpdate=!0)}),g.createElement("points",Ae({ref:a},s),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[e,n],usage:Ji}),t&&g.createElement("bufferAttribute",{attach:"attributes-color",args:[t,n],count:t.length/n,usage:Ji}),i&&g.createElement("bufferAttribute",{attach:"attributes-size",args:[i,1],count:i.length/n,usage:Ji})),r)}),DF=g.forwardRef((r,e)=>r.positions instanceof Float32Array?g.createElement(mM,Ae({},r,{ref:e})):g.createElement(dM,Ae({},r,{ref:e}))),fx=g.createContext(null),MF=g.forwardRef((r,e)=>{g.useMemo(()=>Ii({SegmentObject:AM}),[]);const{limit:t=1e3,lineWidth:i=1,children:n,...s}=r,[o,a]=g.useState([]),[l]=g.useState(()=>new Iv),[c]=g.useState(()=>new eh),[u]=g.useState(()=>new Zu),[h]=g.useState(()=>new De(512,512)),[f]=g.useState(()=>Array(t*6).fill(0)),[d]=g.useState(()=>Array(t*6).fill(0)),m=g.useMemo(()=>({subscribe:A=>(a(p=>[...p,A]),()=>a(p=>p.filter(y=>y.current!==A.current)))}),[]);return He(()=>{for(let p=0;p<t;p++){var A;const y=(A=o[p])==null?void 0:A.current;y&&(f[p*6+0]=y.start.x,f[p*6+1]=y.start.y,f[p*6+2]=y.start.z,f[p*6+3]=y.end.x,f[p*6+4]=y.end.y,f[p*6+5]=y.end.z,d[p*6+0]=y.color.r,d[p*6+1]=y.color.g,d[p*6+2]=y.color.b,d[p*6+3]=y.color.r,d[p*6+4]=y.color.g,d[p*6+5]=y.color.b)}u.setColors(d),u.setPositions(f),l.computeLineDistances()}),g.createElement("primitive",{object:l,ref:e},g.createElement("primitive",{object:u,attach:"geometry"}),g.createElement("primitive",Ae({object:c,attach:"material",vertexColors:!0,resolution:h,linewidth:i},s)),g.createElement(fx.Provider,{value:m},n))});class AM{constructor(){this.color=new Ye("white"),this.start=new z(0,0,0),this.end=new z(0,0,0)}}const cy=r=>r instanceof z?r:new z(...typeof r=="number"?[r,r,r]:r),LF=g.forwardRef(({color:r,start:e,end:t},i)=>{const n=g.useContext(fx);if(!n)throw"Segment must used inside Segments component.";const s=g.useRef(null);return g.useImperativeHandle(i,()=>s.current,[]),g.useLayoutEffect(()=>n.subscribe(s),[]),g.createElement("segmentObject",{ref:s,color:r,start:cy(e),end:cy(t)})}),PF=g.forwardRef(({children:r,hysteresis:e=0,distances:t,...i},n)=>{const s=g.useRef(null);return g.useImperativeHandle(n,()=>s.current,[]),g.useLayoutEffect(()=>{const{current:o}=s;o.levels.length=0,o.children.forEach((a,l)=>o.levels.push({object:a,hysteresis:e,distance:t[l]}))}),He(o=>{var a;return(a=s.current)==null?void 0:a.update(o.camera)}),g.createElement("lOD",Ae({ref:s},i),r)});function FF({all:r,scene:e,camera:t}){const i=le(({gl:o})=>o),n=le(({camera:o})=>o),s=le(({scene:o})=>o);return g.useLayoutEffect(()=>{const o=[];r&&(e||s).traverse(c=>{c.visible===!1&&(o.push(c),c.visible=!0)}),i.compile(e||s,t||n);const a=new ju(128);new r2(.01,1e5,a).update(i,e||s),a.dispose(),o.forEach(c=>c.visible=!1)},[]),null}function kF(){const r=le(e=>e.gl);return g.useEffect(()=>(r.shadowMap.autoUpdate=!1,r.shadowMap.needsUpdate=!0,()=>{r.shadowMap.autoUpdate=r.shadowMap.needsUpdate=!0}),[r.shadowMap]),null}const uy=new we,hy=new Aa,rd=new on,od=new z;function OF(r,e){const t=this.geometry,i=this.material,n=this.matrixWorld;i!==void 0&&(t.boundingSphere===null&&t.computeBoundingSphere(),rd.copy(t.boundingSphere),rd.applyMatrix4(n),r.ray.intersectsSphere(rd)!==!1&&(uy.copy(n).invert(),hy.copy(r.ray).applyMatrix4(uy),!(t.boundingBox!==null&&hy.intersectBox(t.boundingBox,od)===null)&&e.push({distance:od.distanceTo(r.ray.origin),point:od.clone(),object:this})))}function UF({pixelated:r}){const e=le(o=>o.gl),t=le(o=>o.internal.active),i=le(o=>o.performance.current),n=le(o=>o.viewport.initialDpr),s=le(o=>o.setDpr);return g.useEffect(()=>{const o=e.domElement;return()=>{t&&s(n),r&&o&&(o.style.imageRendering="auto")}},[]),g.useEffect(()=>{s(i*n),r&&e.domElement&&(e.domElement.style.imageRendering=i===1?"auto":"pixelated")},[i]),null}function NF(){const r=le(i=>i.get),e=le(i=>i.setEvents),t=le(i=>i.performance.current);return g.useEffect(()=>{const i=r().events.enabled;return()=>e({enabled:i})},[]),g.useEffect(()=>e({enabled:t===1}),[t]),null}const dx=g.createContext(null);function GF({iterations:r=10,ms:e=250,threshold:t=.75,step:i=.1,factor:n=.5,flipflops:s=1/0,bounds:o=f=>f>100?[60,100]:[40,60],onIncline:a,onDecline:l,onChange:c,onFallback:u,children:h}){const f=Math.pow(10,0),[d,m]=g.useState(()=>({fps:0,index:0,factor:n,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:p=>{const y=Symbol();return d.subscriptions.set(y,p.current),()=>void d.subscriptions.delete(y)}}));let A=0;return He(()=>{const{frames:p,averages:y}=d;if(!d.fallback&&y.length<r){p.push(performance.now());const E=p[p.length-1]-p[0];if(E>=e){if(d.fps=Math.round(p.length/E*1e3*f)/f,d.refreshrate=Math.max(d.refreshrate,d.fps),y[d.index++%r]=d.fps,y.length===r){const[v,x]=o(d.refreshrate),C=y.filter(_=>_>=x),I=y.filter(_=>_<v);C.length>r*t&&(d.factor=Math.min(1,d.factor+i),d.flipped++,a&&a(d),d.subscriptions.forEach(_=>_.onIncline&&_.onIncline(d))),I.length>r*t&&(d.factor=Math.max(0,d.factor-i),d.flipped++,l&&l(d),d.subscriptions.forEach(_=>_.onDecline&&_.onDecline(d))),A!==d.factor&&(A=d.factor,c&&c(d),d.subscriptions.forEach(_=>_.onChange&&_.onChange(d))),d.flipped>s&&!d.fallback&&(d.fallback=!0,u&&u(d),d.subscriptions.forEach(_=>_.onFallback&&_.onFallback(d))),d.averages=[]}d.frames=[]}}}),g.createElement(dx.Provider,{value:d},h)}function QF({onIncline:r,onDecline:e,onChange:t,onFallback:i}){const n=g.useContext(dx),s=g.useRef({onIncline:r,onDecline:e,onChange:t,onFallback:i});g.useLayoutEffect(()=>{s.current.onIncline=r,s.current.onDecline=e,s.current.onChange=t,s.current.onFallback=i},[r,e,t,i]),g.useLayoutEffect(()=>n.subscribe(s),[n])}const pM=g.forwardRef(({children:r,compute:e,width:t,height:i,samples:n=8,renderPriority:s=0,eventPriority:o=0,frames:a=1/0,stencilBuffer:l=!1,depthBuffer:c=!0,generateMipmaps:u=!1,...h},f)=>{const{size:d,viewport:m}=le(),A=gn((t||d.width)*m.dpr,(i||d.height)*m.dpr,{samples:n,stencilBuffer:l,depthBuffer:c,generateMipmaps:u}),[p]=g.useState(()=>new Mr),y=g.useCallback((E,v,x)=>{var C,I;let _=(C=A.texture)==null||(C=C.__r3f.parent)==null?void 0:C.object;for(;_&&!(_ instanceof mi);){var S;_=(S=_.__r3f.parent)==null?void 0:S.object}if(!_)return!1;x.raycaster.camera||x.events.compute(E,x,(I=x.previousRoot)==null?void 0:I.getState());const[b]=x.raycaster.intersectObject(_);if(!b)return!1;const T=b.uv;if(!T)return!1;v.raycaster.setFromCamera(v.pointer.set(T.x*2-1,T.y*2-1),v.camera)},[]);return g.useImperativeHandle(f,()=>A.texture,[A]),g.createElement(g.Fragment,null,so(g.createElement(gM,{renderPriority:s,frames:a,fbo:A},r,g.createElement("group",{onPointerOver:()=>null})),p,{events:{compute:e||y,priority:o}}),g.createElement("primitive",Ae({object:A.texture},h)))});function gM({frames:r,renderPriority:e,children:t,fbo:i}){let n=0,s,o,a,l;return He(c=>{(r===1/0||n<r)&&(s=c.gl.autoClear,o=c.gl.xr.enabled,a=c.gl.getRenderTarget(),l=c.gl.xr.isPresenting,c.gl.autoClear=!0,c.gl.xr.enabled=!1,c.gl.xr.isPresenting=!1,c.gl.setRenderTarget(i),c.gl.render(c.scene,c.camera),c.gl.setRenderTarget(a),c.gl.autoClear=s,c.gl.xr.enabled=o,c.gl.xr.isPresenting=l,n++)},e),g.createElement(g.Fragment,null,t)}const yM=g.forwardRef(({children:r,compute:e,renderPriority:t=-1,eventPriority:i=0,frames:n=1/0,stencilBuffer:s=!1,depthBuffer:o=!0,generateMipmaps:a=!1,resolution:l=896,near:c=.1,far:u=1e3,flip:h=!1,position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:y,...E},v)=>{const{size:x,viewport:C}=le(),I=g.useRef(null),_=g.useMemo(()=>{const b=new ju(Math.max((l||x.width)*C.dpr,(l||x.height)*C.dpr),{stencilBuffer:s,depthBuffer:o,generateMipmaps:a});return b.texture.isRenderTargetTexture=!h,b.texture.flipY=!0,b.texture.type=fi,b},[l,h]);g.useEffect(()=>()=>_.dispose(),[_]);const[S]=g.useState(()=>new Mr);return g.useImperativeHandle(v,()=>({scene:S,fbo:_,camera:I.current}),[_]),g.createElement(g.Fragment,null,so(g.createElement(vM,{renderPriority:t,frames:n,camera:I},r,g.createElement("group",{onPointerOver:()=>null})),S,{events:{compute:e,priority:i}}),g.createElement("primitive",Ae({object:_.texture},E)),g.createElement("cubeCamera",{ref:I,args:[c,u,_],position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:y}))});function vM({frames:r,renderPriority:e,children:t,camera:i}){let n=0;return He(s=>{(r===1/0||n<r)&&(i.current.update(s.gl,s.scene),n++)},e),g.createElement(g.Fragment,null,t)}const zF=g.forwardRef(({id:r=1,colorWrite:e=!1,depthWrite:t=!1,...i},n)=>{const s=g.useRef(null),o=g.useMemo(()=>({colorWrite:e,depthWrite:t,stencilWrite:!0,stencilRef:r,stencilFunc:xC,stencilFail:Bh,stencilZFail:Bh,stencilZPass:Bh}),[r,e,t]);return g.useLayoutEffect(()=>{Object.assign(s.current.material,o)}),g.useImperativeHandle(n,()=>s.current,[]),g.createElement("mesh",Ae({ref:s,renderOrder:-r},i))});function HF(r,e=!1){return{stencilWrite:!0,stencilRef:r,stencilFunc:e?CC:IC,stencilFail:Rh,stencilZFail:Rh,stencilZPass:Rh}}function VF({renderPriority:r=1,zoom:e=0,segments:t=64,children:i,resolution:n=896,...s}){const o=g.useRef(null),a=g.useRef(null),{width:l,height:c}=le(p=>p.size),[u]=g.useState(()=>new ui);g.useLayoutEffect(()=>{u.position.set(0,0,100),u.zoom=100,u.left=l/-2,u.right=l/2,u.top=c/2,u.bottom=c/-2,u.updateProjectionMatrix()},[l,c]);const h=Math.sqrt(l*l+c*c)/100*(.5+e/2),f=new z,d=new on(new z,h),m=new bn,A=g.useCallback((p,y,E)=>{if(y.pointer.set(p.offsetX/y.size.width*2-1,-(p.offsetY/y.size.height)*2+1),y.raycaster.setFromCamera(y.pointer,u),y.raycaster.ray.intersectSphere(d,f))f.normalize();else return;m.getNormalMatrix(a.current.camera.matrixWorld),a.current.camera.getWorldPosition(y.raycaster.ray.origin),y.raycaster.ray.direction.set(0,0,1).reflect(f),y.raycaster.ray.direction.x*=-1,y.raycaster.ray.direction.applyNormalMatrix(m).multiplyScalar(-1)},[]);return He(p=>{r&&p.gl.render(o.current,u)},r),g.createElement(g.Fragment,null,g.createElement("mesh",Ae({ref:o},s,{scale:h}),g.createElement("sphereGeometry",{args:[1,t,t]}),g.createElement("meshBasicMaterial",null,g.createElement(yM,{compute:A,attach:"envMap",flip:!0,resolution:n,ref:a},i,g.createElement(EM,{api:a})))))}function EM({api:r}){const e=new z,t=new nt,i=new z,n=new wn(0,Math.PI,0);return He(s=>{s.camera.matrixWorld.decompose(e,t,i),r.current.camera.position.copy(e),r.current.camera.quaternion.setFromEuler(n).premultiply(t)}),null}const xM=ps({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new De},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),KF=g.forwardRef(({children:r,events:e=void 0,blur:t=0,eventPriority:i=0,renderPriority:n=0,worldUnits:s=!1,resolution:o=512,...a},l)=>{Ii({PortalMaterialImpl:xM});const c=g.useRef(null),{scene:u,gl:h,size:f,viewport:d,setEvents:m}=le(),A=gn(o,o),[p,y]=g.useState(0);He(()=>{const I=c.current.blend>0?Math.max(1,n):0;p!==I&&y(I)}),g.useEffect(()=>{e!==void 0&&m({enabled:!e})},[e]);const[E,v]=g.useState(!0),x=wD(v);g.useLayoutEffect(()=>{var I;x.current=(I=c.current)==null||(I=I.__r3f.parent)==null?void 0:I.object},[]),g.useLayoutEffect(()=>{if(x.current&&t&&c.current.sdf===null){const I=new Qe(x.current.geometry,new ds),_=new Yt().setFromBufferAttribute(I.geometry.attributes.position),S=new ui(_.min.x*(1+2/o),_.max.x*(1+2/o),_.max.y*(1+2/o),_.min.y*(1+2/o),.1,1e3);S.position.set(0,0,1),S.lookAt(0,0,0),h.setRenderTarget(A),h.render(I,S);const T=IM(o,o,h)(A.texture),R=new Float32Array(o*o);h.readRenderTargetPixels(T,0,0,o,o,R);let w=1/0;for(let B=0;B<R.length;B++)R[B]<w&&(w=R[B]);w=-w,c.current.size=w,c.current.sdf=T.texture,h.setRenderTarget(null)}},[o,t]),g.useImperativeHandle(l,()=>c.current);const C=g.useCallback((I,_,S)=>{var b;if(!x.current)return!1;if(_.pointer.set(I.offsetX/_.size.width*2-1,-(I.offsetY/_.size.height)*2+1),_.raycaster.setFromCamera(_.pointer,_.camera),((b=c.current)==null?void 0:b.blend)===0){const[T]=_.raycaster.intersectObject(x.current);if(!T)return _.raycaster.camera=void 0,!1}},[]);return g.createElement("portalMaterialImpl",Ae({ref:c,blur:t,blend:0,resolution:[f.width*d.dpr,f.height*d.dpr],attach:"material"},a),g.createElement(pM,{attach:"map",frames:E?1/0:0,eventPriority:i,renderPriority:n,compute:C},r,g.createElement(CM,{events:e,rootScene:u,priority:p,material:c,worldUnits:s})))});function CM({events:r=void 0,rootScene:e,material:t,priority:i,worldUnits:n}){const s=le(h=>h.scene),o=le(h=>h.setEvents),a=gn(),l=gn();g.useLayoutEffect(()=>{s.matrixAutoUpdate=!1},[]),g.useEffect(()=>{r!==void 0&&o({enabled:r})},[r]);const[c,u]=g.useMemo(()=>{const h={value:0};return[new Zs(new gi({uniforms:{a:{value:a.texture},b:{value:l.texture},blend:h},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
          }`,fragmentShader:`
          uniform sampler2D a;
          uniform sampler2D b;
          uniform float blend;
          varying vec2 vUv;
          #include <packing>
          void main() {
            vec4 ta = texture2D(a, vUv);
            vec4 tb = texture2D(b, vUv);
            gl_FragColor = mix(tb, ta, blend);
            #include <tonemapping_fragment>
            #include <${Zi>=154?"colorspace_fragment":"encodings_fragment"}>
          }`})),h]},[]);return He(h=>{var f;let d=t==null||(f=t.current)==null||(f=f.__r3f.parent)==null?void 0:f.object;if(d){if(n)s.matrixWorld.identity();else{var m;i&&((m=t.current)==null?void 0:m.blend)===1&&d.updateWorldMatrix(!0,!1),s.matrixWorld.copy(d.matrixWorld)}if(i){var A,p,y;((A=t.current)==null?void 0:A.blend)>0&&((p=t.current)==null?void 0:p.blend)<1?(u.value=t.current.blend,h.gl.setRenderTarget(a),h.gl.render(s,h.camera),h.gl.setRenderTarget(l),h.gl.render(e,h.camera),h.gl.setRenderTarget(null),c.render(h.gl)):((y=t.current)==null?void 0:y.blend)===1&&h.gl.render(s,h.camera)}}},i),g.createElement(g.Fragment,null)}const IM=(r,e,t)=>{let i=new Ti(r,e,{minFilter:Nl,magFilter:Ht,type:ii,format:Ds,generateMipmaps:!0}),n=new Ti(r,e,{minFilter:Xt,magFilter:Xt}),s=new Ti(r,e,{minFilter:Xt,magFilter:Xt}),o=new Ti(r,e,{minFilter:Xt,magFilter:Xt}),a=new Ti(r,e,{minFilter:Xt,magFilter:Xt}),l=new Ti(r,e,{minFilter:Xt,magFilter:Xt,type:ii,format:Ds}),c=new Ti(r,e,{minFilter:Xt,magFilter:Xt,type:ii,format:Ds});const u=new Zs(new gi({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));
        }`})),h=new Zs(new gi({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));
        }`})),f=new Zs(new gi({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform float offset;
        uniform float level;
        uniform float maxSteps;
        #include <packing>
        void main() {
          float closestDist = 9999999.9;
          vec2 closestPos = vec2(0.0);
          for (float x = -1.0; x <= 1.0; x += 1.0) {
            for (float y = -1.0; y <= 1.0; y += 1.0) {
              vec2 voffset = vUv;
              voffset += vec2(x, y) * vec2(${1/r}, ${1/e}) * offset;
              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));
              float dist = distance(pos.xy, vUv);
              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {
                closestDist = dist;
                closestPos = pos;
              }
            }
          }
          gl_FragColor = pack2HalfToRGBA(closestPos);
        }`})),d=new Zs(new gi({uniforms:{tex:{value:null},size:{value:new De(r,e)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform vec2 size;
        #include <packing>
        void main() {
          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);
        }`})),m=new Zs(new gi({uniforms:{inside:{value:c.texture},outside:{value:l.texture},tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D inside;
        uniform sampler2D outside;
        uniform sampler2D tex;
        #include <packing>
        void main() {
          float i = texture2D(inside, vUv).x;
          float o =texture2D(outside, vUv).x;
          if (texture2D(tex, vUv).x == 0.0) {
            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);
          } else {
            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);
          }
        }`}));return A=>{let p=i;A.minFilter=Xt,A.magFilter=Xt,u.material.uniforms.tex.value=A,t.setRenderTarget(n),u.render(t);const y=Math.ceil(Math.log(Math.max(r,e))/Math.log(2));let E=n,v=null;for(let x=0;x<y;x++){const C=Math.pow(2,y-x-1);v=E===n?o:n,f.material.uniforms.level.value=x,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=C,f.material.uniforms.tex.value=E.texture,t.setRenderTarget(v),f.render(t),E=v}t.setRenderTarget(l),d.material.uniforms.tex.value=v.texture,d.render(t),h.material.uniforms.tex.value=A,t.setRenderTarget(s),h.render(t),E=s;for(let x=0;x<y;x++){const C=Math.pow(2,y-x-1);v=E===s?a:s,f.material.uniforms.level.value=x,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=C,f.material.uniforms.tex.value=E.texture,t.setRenderTarget(v),f.render(t),E=v}return t.setRenderTarget(c),d.material.uniforms.tex.value=v.texture,d.render(t),t.setRenderTarget(p),m.material.uniforms.tex.value=A,m.render(t),t.setRenderTarget(null),p}},fy=r=>{let e;const t=new Set,i=(u,h)=>{const f=typeof u=="function"?u(e):u;if(!Object.is(f,e)){const d=e;e=h??(typeof f!="object"||f===null)?f:Object.assign({},e,f),t.forEach(m=>m(e,d))}},n=()=>e,l={setState:i,getState:n,getInitialState:()=>c,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{t.clear()}},c=e=r(i,n,l);return l},_M=r=>r?fy(r):fy,{useDebugValue:SM}=Yn,{useSyncExternalStoreWithSelector:TM}=_C;const bM=r=>r;function wM(r,e=bM,t){const i=TM(r.subscribe,r.getState,r.getServerState||r.getInitialState,e,t);return SM(i),i}const dy=r=>{const e=typeof r=="function"?_M(r):r,t=(i,n)=>wM(e,i,n);return Object.assign(t,e),t},BM=r=>r?dy(r):dy;var my,Ay;const py=typeof window<"u"&&((my=window.document)!=null&&my.createElement||((Ay=window.navigator)==null?void 0:Ay.product)==="ReactNative")?Yn.useLayoutEffect:Yn.useEffect;function RM(){const r=BM(e=>({current:new Array,version:0,set:e}));return{In:({children:e})=>{const t=r(n=>n.set),i=r(n=>n.version);return py(()=>{t(n=>({version:n.version+1}))},[]),py(()=>(t(({current:n})=>({current:[...n,e]})),()=>t(({current:n})=>({current:n.filter(s=>s!==e)}))),[e,i]),null},Out:()=>{const e=r(t=>t.current);return Yn.createElement(Yn.Fragment,null,e)}}}const DM=r=>r&&r.isOrthographicCamera,gy=new Ye,mx=RM();function ad(r,e){const{right:t,top:i,left:n,bottom:s,width:o,height:a}=e,l=e.bottom<0||i>r.height||t<0||e.left>r.width,u=r.top+r.height-s,h=n-r.left;return{position:{width:o,height:a,left:h,top:i,bottom:u,right:t},isOffscreen:l}}function ld(r,{left:e,bottom:t,width:i,height:n}){let s;const o=i/n;return DM(r.camera)?r.camera.manual?r.camera.updateProjectionMatrix():(r.camera.left!==i/-2||r.camera.right!==i/2||r.camera.top!==n/2||r.camera.bottom!==n/-2)&&(Object.assign(r.camera,{left:i/-2,right:i/2,top:n/2,bottom:n/-2}),r.camera.updateProjectionMatrix()):r.camera.aspect!==o&&(r.camera.aspect=o,r.camera.updateProjectionMatrix()),s=r.gl.autoClear,r.gl.autoClear=!1,r.gl.setViewport(e,t,i,n),r.gl.setScissor(e,t,i,n),r.gl.setScissorTest(!0),s}function cd(r,e){r.gl.setScissorTest(!1),r.gl.autoClear=e}function yy(r){r.gl.getClearColor(gy),r.gl.setClearColor(gy,r.gl.getClearAlpha()),r.gl.clear(!0,!0)}function MM({visible:r=!0,canvasSize:e,scene:t,index:i,children:n,frames:s,rect:o,track:a}){const l=le(),[c,u]=g.useState(!1);let h=0;return He(f=>{if(s===1/0||h<=s){var d;a&&(o.current=(d=a.current)==null?void 0:d.getBoundingClientRect()),h++}if(o.current){const{position:m,isOffscreen:A}=ad(e,o.current);if(c!==A&&u(A),r&&!c&&o.current){const p=ld(f,m);f.gl.render(n?f.scene:t,f.camera),cd(f,p)}}},i),g.useLayoutEffect(()=>{const f=o.current;if(f&&(!r||!c)){const{position:d}=ad(e,f),m=ld(l,d);yy(l),cd(l,m)}},[r,c]),g.useEffect(()=>{if(!a)return;const f=o.current,d=l.get().events.connected;return l.setEvents({connected:a.current}),()=>{if(f){const{position:m}=ad(e,f),A=ld(l,m);yy(l),cd(l,A)}l.setEvents({connected:d})}},[a]),g.createElement(g.Fragment,null,n,g.createElement("group",{onPointerOver:()=>null}))}const Ax=g.forwardRef(({track:r,visible:e=!0,index:t=1,id:i,style:n,className:s,frames:o=1/0,children:a,...l},c)=>{var u,h,f,d;const m=g.useRef(null),{size:A,scene:p}=le(),[y]=g.useState(()=>new Mr),[E,v]=g.useReducer(()=>!0,!1),x=g.useCallback((C,I)=>{if(m.current&&r&&r.current&&C.target===r.current){const{width:_,height:S,left:b,top:T}=m.current,R=C.clientX-b,w=C.clientY-T;I.pointer.set(R/_*2-1,-(w/S)*2+1),I.raycaster.setFromCamera(I.pointer,I.camera)}},[m,r]);return g.useEffect(()=>{var C;r&&(m.current=(C=r.current)==null?void 0:C.getBoundingClientRect()),v()},[r]),g.createElement("group",Ae({ref:c},l),E&&so(g.createElement(MM,{visible:e,canvasSize:A,frames:o,scene:p,track:r,rect:m,index:t},a),y,{events:{compute:x,priority:t},size:{width:(u=m.current)==null?void 0:u.width,height:(h=m.current)==null?void 0:h.height,top:(f=m.current)==null?void 0:f.top,left:(d=m.current)==null?void 0:d.left}}))}),LM=g.forwardRef(({as:r="div",id:e,visible:t,className:i,style:n,index:s=1,track:o,frames:a=1/0,children:l,...c},u)=>{const h=g.useId(),f=g.useRef(null);return g.useImperativeHandle(u,()=>f.current),g.createElement(g.Fragment,null,g.createElement(r,Ae({ref:f,id:e,className:i,style:n},c)),g.createElement(mx.In,null,g.createElement(Ax,{visible:t,key:h,track:f,frames:a,index:s},l)))}),$F=(()=>{const r=g.forwardRef((e,t)=>g.useContext(xd)?g.createElement(Ax,Ae({ref:t},e)):g.createElement(LM,Ae({ref:t},e)));return r.Port=()=>g.createElement(mx.Out,null),r})(),Kl=g.createContext(null),nu=new z,vy=new z,PM=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(nu.copy(i).multiplyScalar(n/o).sub(e),vy.copy(i).multiplyScalar(s/o).add(t).sub(r),-nu.dot(vy)/nu.dot(nu))},FM=new z(0,1,0),Ey=new we,ud=({direction:r,axis:e})=>{const{translation:t,translationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,opacity:f,renderOrder:d,onDragStart:m,onDrag:A,onDragEnd:p,userData:y}=g.useContext(Kl),E=le(W=>W.controls),v=g.useRef(null),x=g.useRef(null),C=g.useRef(null),I=g.useRef(0),[_,S]=g.useState(!1),b=g.useCallback(W=>{n&&(v.current.innerText=`${t.current[e].toFixed(2)}`,v.current.style.display="block"),W.stopPropagation();const P=new we().extractRotation(x.current.matrixWorld),K=W.point.clone(),M=new z().setFromMatrixPosition(x.current.matrixWorld),V=r.clone().applyMatrix4(P).normalize();C.current={clickPoint:K,dir:V},I.current=t.current[e],m({component:"Arrow",axis:e,origin:M,directions:[V]}),E&&(E.enabled=!1),W.target.setPointerCapture(W.pointerId)},[n,r,E,m,t,e]),T=g.useCallback(W=>{if(W.stopPropagation(),_||S(!0),C.current){const{clickPoint:P,dir:K}=C.current,[M,V]=(i==null?void 0:i[e])||[void 0,void 0];let $=PM(P,K,W.ray.origin,W.ray.direction);M!==void 0&&($=Math.max($,M-I.current)),V!==void 0&&($=Math.min($,V-I.current)),t.current[e]=I.current+$,n&&(v.current.innerText=`${t.current[e].toFixed(2)}`),Ey.makeTranslation(K.x*$,K.y*$,K.z*$),A(Ey)}},[n,A,_,t,i,e]),R=g.useCallback(W=>{n&&(v.current.style.display="none"),W.stopPropagation(),C.current=null,p(),E&&(E.enabled=!0),W.target.releasePointerCapture(W.pointerId)},[n,E,p]),w=g.useCallback(W=>{W.stopPropagation(),S(!1)},[]),{cylinderLength:B,coneWidth:D,coneLength:k,matrixL:Q}=g.useMemo(()=>{const W=c?l/a*1.6:a/20,P=c?.2:a/5,K=c?1-P:a-P,M=new nt().setFromUnitVectors(FM,r.clone().normalize()),V=new we().makeRotationFromQuaternion(M);return{cylinderLength:K,coneWidth:W,coneLength:P,matrixL:V}},[r,a,l,c]),Y=_?h:u[e];return g.createElement("group",{ref:x},g.createElement("group",{matrix:Q,matrixAutoUpdate:!1,onPointerDown:b,onPointerMove:T,onPointerUp:R,onPointerOut:w},n&&g.createElement(Xu,{position:[0,-k,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),g.createElement("mesh",{visible:!1,position:[0,(B+k)/2,0],userData:y},g.createElement("cylinderGeometry",{args:[D*1.4,D*1.4,B+k,8,1]})),g.createElement(Fs,{transparent:!0,raycast:()=>null,depthTest:o,points:[0,0,0,0,B,0],lineWidth:l,side:xi,color:Y,opacity:f,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),g.createElement("mesh",{raycast:()=>null,position:[0,B+k/2,0],renderOrder:d},g.createElement("coneGeometry",{args:[D,k,24,1]}),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:o,color:Y,opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},hd=new z,fd=new z,dd=r=>r*180/Math.PI,kM=r=>r*Math.PI/180,OM=(r,e,t,i,n)=>{hd.copy(r).sub(t),fd.copy(e).sub(t);const s=i.dot(i),o=n.dot(n),a=hd.dot(i)/s,l=hd.dot(n)/o,c=fd.dot(i)/s,u=fd.dot(n)/o,h=Math.atan2(l,a);return Math.atan2(u,c)-h},UM=(r,e)=>{let t=Math.floor(r/e);return t=t<0?t+1:t,r-t*e},xy=r=>{let e=UM(r,2*Math.PI);return Math.abs(e)<1e-6?0:(e<0&&(e+=2*Math.PI),e)},su=new we,Cy=new z,ru=new Aa,md=new z,Ad=({dir1:r,dir2:e,axis:t})=>{const{rotationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,renderOrder:f,opacity:d,onDragStart:m,onDrag:A,onDragEnd:p,userData:y}=g.useContext(Kl),E=le(Y=>Y.controls),v=g.useRef(null),x=g.useRef(null),C=g.useRef(0),I=g.useRef(0),_=g.useRef(null),[S,b]=g.useState(!1),T=g.useCallback(Y=>{n&&(v.current.innerText=`${dd(I.current).toFixed(0)}º`,v.current.style.display="block"),Y.stopPropagation();const W=Y.point.clone(),P=new z().setFromMatrixPosition(x.current.matrixWorld),K=new z().setFromMatrixColumn(x.current.matrixWorld,0).normalize(),M=new z().setFromMatrixColumn(x.current.matrixWorld,1).normalize(),V=new z().setFromMatrixColumn(x.current.matrixWorld,2).normalize(),$=new or().setFromNormalAndCoplanarPoint(V,P);_.current={clickPoint:W,origin:P,e1:K,e2:M,normal:V,plane:$},m({component:"Rotator",axis:t,origin:P,directions:[K,M,V]}),E&&(E.enabled=!1),Y.target.setPointerCapture(Y.pointerId)},[n,E,m,t]),R=g.useCallback(Y=>{if(Y.stopPropagation(),S||b(!0),_.current){const{clickPoint:W,origin:P,e1:K,e2:M,normal:V,plane:$}=_.current,[G,O]=(i==null?void 0:i[t])||[void 0,void 0];ru.copy(Y.ray),ru.intersectPlane($,md),ru.direction.negate(),ru.intersectPlane($,md);let F=OM(W,md,P,K,M),U=dd(F);Y.shiftKey&&(U=Math.round(U/10)*10,F=kM(U)),G!==void 0&&O!==void 0&&O-G<2*Math.PI?(F=xy(F),F=F>Math.PI?F-2*Math.PI:F,F=et.clamp(F,G-C.current,O-C.current),I.current=C.current+F):(I.current=xy(C.current+F),I.current=I.current>Math.PI?I.current-2*Math.PI:I.current),n&&(U=dd(I.current),v.current.innerText=`${U.toFixed(0)}º`),su.makeRotationAxis(V,F),Cy.copy(P).applyMatrix4(su).sub(P).negate(),su.setPosition(Cy),A(su)}},[n,A,S,i,t]),w=g.useCallback(Y=>{n&&(v.current.style.display="none"),Y.stopPropagation(),C.current=I.current,_.current=null,p(),E&&(E.enabled=!0),Y.target.releasePointerCapture(Y.pointerId)},[n,E,p]),B=g.useCallback(Y=>{Y.stopPropagation(),b(!1)},[]),D=g.useMemo(()=>{const Y=r.clone().normalize(),W=e.clone().normalize();return new we().makeBasis(Y,W,Y.clone().cross(W))},[r,e]),k=c?.65:a*.65,Q=g.useMemo(()=>{const W=[];for(let P=0;P<=32;P++){const K=P*(Math.PI/2)/32;W.push(new z(Math.cos(K)*k,Math.sin(K)*k,0))}return W},[k]);return g.createElement("group",{ref:x,onPointerDown:T,onPointerMove:R,onPointerUp:w,onPointerOut:B,matrix:D,matrixAutoUpdate:!1},n&&g.createElement(Xu,{position:[k,k,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),g.createElement(Fs,{points:Q,lineWidth:l*4,visible:!1,userData:y}),g.createElement(Fs,{transparent:!0,raycast:()=>null,depthTest:o,points:Q,lineWidth:l,side:xi,color:S?h:u[t],opacity:d,polygonOffset:!0,polygonOffsetFactor:-10,renderOrder:f,fog:!1}))},NM=(r,e,t)=>{const i=Math.abs(r.x)>=Math.abs(r.y)&&Math.abs(r.x)>=Math.abs(r.z)?0:Math.abs(r.y)>=Math.abs(r.x)&&Math.abs(r.y)>=Math.abs(r.z)?1:2,n=[0,1,2].sort((m,A)=>Math.abs(e.getComponent(A))-Math.abs(e.getComponent(m))),s=i===n[0]?n[1]:n[0],o=r.getComponent(i),a=r.getComponent(s),l=e.getComponent(i),c=e.getComponent(s),u=t.getComponent(i),f=(t.getComponent(s)-u*(a/o))/(c-l*(a/o));return[(u-f*l)/o,f]},ou=new Aa,au=new z,Iy=new we,pd=({dir1:r,dir2:e,axis:t})=>{const{translation:i,translationLimits:n,annotations:s,annotationsClass:o,depthTest:a,scale:l,lineWidth:c,fixed:u,axisColors:h,hoveredColor:f,opacity:d,onDragStart:m,onDrag:A,onDragEnd:p,userData:y}=g.useContext(Kl),E=le(P=>P.controls),v=g.useRef(null),x=g.useRef(null),C=g.useRef(null),I=g.useRef(0),_=g.useRef(0),[S,b]=g.useState(!1),T=g.useCallback(P=>{s&&(v.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`,v.current.style.display="block"),P.stopPropagation();const K=P.point.clone(),M=new z().setFromMatrixPosition(x.current.matrixWorld),V=new z().setFromMatrixColumn(x.current.matrixWorld,0).normalize(),$=new z().setFromMatrixColumn(x.current.matrixWorld,1).normalize(),G=new z().setFromMatrixColumn(x.current.matrixWorld,2).normalize(),O=new or().setFromNormalAndCoplanarPoint(G,M);C.current={clickPoint:K,e1:V,e2:$,plane:O},I.current=i.current[(t+1)%3],_.current=i.current[(t+2)%3],m({component:"Slider",axis:t,origin:M,directions:[V,$,G]}),E&&(E.enabled=!1),P.target.setPointerCapture(P.pointerId)},[s,E,m,t]),R=g.useCallback(P=>{if(P.stopPropagation(),S||b(!0),C.current){const{clickPoint:K,e1:M,e2:V,plane:$}=C.current,[G,O]=(n==null?void 0:n[(t+1)%3])||[void 0,void 0],[F,U]=(n==null?void 0:n[(t+2)%3])||[void 0,void 0];ou.copy(P.ray),ou.intersectPlane($,au),ou.direction.negate(),ou.intersectPlane($,au),au.sub(K);let[N,Z]=NM(M,V,au);G!==void 0&&(N=Math.max(N,G-I.current)),O!==void 0&&(N=Math.min(N,O-I.current)),F!==void 0&&(Z=Math.max(Z,F-_.current)),U!==void 0&&(Z=Math.min(Z,U-_.current)),i.current[(t+1)%3]=I.current+N,i.current[(t+2)%3]=_.current+Z,s&&(v.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`),Iy.makeTranslation(N*M.x+Z*V.x,N*M.y+Z*V.y,N*M.z+Z*V.z),A(Iy)}},[s,A,S,i,n,t]),w=g.useCallback(P=>{s&&(v.current.style.display="none"),P.stopPropagation(),C.current=null,p(),E&&(E.enabled=!0),P.target.releasePointerCapture(P.pointerId)},[s,E,p]),B=g.useCallback(P=>{P.stopPropagation(),b(!1)},[]),D=g.useMemo(()=>{const P=r.clone().normalize(),K=e.clone().normalize();return new we().makeBasis(P,K,P.clone().cross(K))},[r,e]),k=u?1/7:l/7,Q=u?.225:l*.225,Y=S?f:h[t],W=g.useMemo(()=>[new z(0,0,0),new z(0,Q,0),new z(Q,Q,0),new z(Q,0,0),new z(0,0,0)],[Q]);return g.createElement("group",{ref:x,matrix:D,matrixAutoUpdate:!1},s&&g.createElement(Xu,{position:[0,0,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:o,ref:v})),g.createElement("group",{position:[k*1.7,k*1.7,0]},g.createElement("mesh",{visible:!0,onPointerDown:T,onPointerMove:R,onPointerUp:w,onPointerOut:B,scale:Q,userData:y},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:Y,polygonOffset:!0,polygonOffsetFactor:-10,side:xi,fog:!1})),g.createElement(Fs,{position:[-Q/2,-Q/2,0],transparent:!0,depthTest:a,points:W,lineWidth:c,color:Y,opacity:d,polygonOffset:!0,polygonOffsetFactor:-10,userData:y,fog:!1})))},pl=new z,_y=new z,GM=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(pl.copy(i).multiplyScalar(n/o).sub(e),_y.copy(i).multiplyScalar(s/o).add(t).sub(r),-pl.dot(_y)/pl.dot(pl))},QM=new z(0,1,0),cl=new z,Sy=new we,gd=({direction:r,axis:e})=>{const{scaleLimits:t,annotations:i,annotationsClass:n,depthTest:s,scale:o,lineWidth:a,fixed:l,axisColors:c,hoveredColor:u,opacity:h,renderOrder:f,onDragStart:d,onDrag:m,onDragEnd:A,userData:p}=g.useContext(Kl),y=le(P=>P.size),E=le(P=>P.controls),v=g.useRef(null),x=g.useRef(null),C=g.useRef(null),I=g.useRef(1),_=g.useRef(1),S=g.useRef(null),[b,T]=g.useState(!1),R=l?1.2:1.2*o,w=g.useCallback(P=>{i&&(v.current.innerText=`${_.current.toFixed(2)}`,v.current.style.display="block"),P.stopPropagation();const K=new we().extractRotation(x.current.matrixWorld),M=P.point.clone(),V=new z().setFromMatrixPosition(x.current.matrixWorld),$=r.clone().applyMatrix4(K).normalize(),G=x.current.matrixWorld.clone(),O=G.clone().invert(),F=l?1/z0(x.current.getWorldPosition(pl),o,P.camera,y):1;S.current={clickPoint:M,dir:$,mPLG:G,mPLGInv:O,offsetMultiplier:F},d({component:"Sphere",axis:e,origin:V,directions:[$]}),E&&(E.enabled=!1),P.target.setPointerCapture(P.pointerId)},[i,E,r,d,e,l,o,y]),B=g.useCallback(P=>{if(P.stopPropagation(),b||T(!0),S.current){const{clickPoint:K,dir:M,mPLG:V,mPLGInv:$,offsetMultiplier:G}=S.current,[O,F]=(t==null?void 0:t[e])||[1e-5,void 0],N=GM(K,M,P.ray.origin,P.ray.direction)*G,Z=l?N:N/o;let ie=Math.pow(2,Z*.2);P.shiftKey&&(ie=Math.round(ie*10)/10),ie=Math.max(ie,O/I.current),F!==void 0&&(ie=Math.min(ie,F/I.current)),_.current=I.current*ie,C.current.position.set(0,R+N,0),i&&(v.current.innerText=`${_.current.toFixed(2)}`),cl.set(1,1,1),cl.setComponent(e,ie),Sy.makeScale(cl.x,cl.y,cl.z).premultiply(V).multiply($),m(Sy)}},[i,R,m,b,t,e]),D=g.useCallback(P=>{i&&(v.current.style.display="none"),P.stopPropagation(),I.current=_.current,S.current=null,C.current.position.set(0,R,0),A(),E&&(E.enabled=!0),P.target.releasePointerCapture(P.pointerId)},[i,E,A,R]),k=g.useCallback(P=>{P.stopPropagation(),T(!1)},[]),{radius:Q,matrixL:Y}=g.useMemo(()=>{const P=l?a/o*1.8:o/22.5,K=new nt().setFromUnitVectors(QM,r.clone().normalize()),M=new we().makeRotationFromQuaternion(K);return{radius:P,matrixL:M}},[r,o,a,l]),W=b?u:c[e];return g.createElement("group",{ref:x},g.createElement("group",{matrix:Y,matrixAutoUpdate:!1,onPointerDown:w,onPointerMove:B,onPointerUp:D,onPointerOut:k},i&&g.createElement(Xu,{position:[0,R/2,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:n,ref:v})),g.createElement("mesh",{ref:C,position:[0,R,0],renderOrder:f,userData:p},g.createElement("sphereGeometry",{args:[Q,12,12]}),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:s,color:W,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},Ty=new we,by=new we,wy=new we,lu=new we,yd=new we,Uo=new we,By=new we,Ry=new we,Dy=new we,No=new Yt,vd=new Yt,My=new z,Ly=new z,Py=new z,Fy=new z,ul=new z,Go=new z(1,0,0),Qo=new z(0,1,0),zo=new z(0,0,1),YF=g.forwardRef(({enabled:r=!0,matrix:e,onDragStart:t,onDrag:i,onDragEnd:n,autoTransform:s=!0,anchor:o,disableAxes:a=!1,disableSliders:l=!1,disableRotations:c=!1,disableScaling:u=!1,activeAxes:h=[!0,!0,!0],offset:f=[0,0,0],rotation:d=[0,0,0],scale:m=1,lineWidth:A=4,fixed:p=!1,translationLimits:y,rotationLimits:E,scaleLimits:v,depthTest:x=!0,renderOrder:C=500,axisColors:I=["#ff2060","#20df80","#2080ff"],hoveredColor:_="#ffff40",annotations:S=!1,annotationsClass:b,opacity:T=1,visible:R=!0,userData:w,children:B,...D},k)=>{const Q=le(F=>F.invalidate),Y=g.useRef(null),W=g.useRef(null),P=g.useRef(null),K=g.useRef(null),M=g.useRef([0,0,0]),V=g.useRef(new z(1,1,1)),$=g.useRef(new z(1,1,1));g.useLayoutEffect(()=>{o&&(K.current.updateWorldMatrix(!0,!0),lu.copy(K.current.matrixWorld).invert(),No.makeEmpty(),K.current.traverse(F=>{F.geometry&&(F.geometry.boundingBox||F.geometry.computeBoundingBox(),Uo.copy(F.matrixWorld).premultiply(lu),vd.copy(F.geometry.boundingBox),vd.applyMatrix4(Uo),No.union(vd))}),My.copy(No.max).add(No.min).multiplyScalar(.5),Ly.copy(No.max).sub(No.min).multiplyScalar(.5),Py.copy(Ly).multiply(new z(...o)).add(My),Fy.set(...f).add(Py),P.current.position.copy(Fy),Q())});const G=g.useMemo(()=>({onDragStart:F=>{Ty.copy(W.current.matrix),by.copy(W.current.matrixWorld),t&&t(F),Q()},onDrag:F=>{wy.copy(Y.current.matrixWorld),lu.copy(wy).invert(),yd.copy(by).premultiply(F),Uo.copy(yd).premultiply(lu),By.copy(Ty).invert(),Ry.copy(Uo).multiply(By),s&&W.current.matrix.copy(Uo),i&&i(Uo,Ry,yd,F),Q()},onDragEnd:()=>{n&&n(),Q()},translation:M,translationLimits:y,rotationLimits:E,axisColors:I,hoveredColor:_,opacity:T,scale:m,lineWidth:A,fixed:p,depthTest:x,renderOrder:C,userData:w,annotations:S,annotationsClass:b}),[t,i,n,M,y,E,v,x,m,A,p,...I,_,T,w,s,S,b]),O=new z;return He(F=>{if(p){const U=z0(P.current.getWorldPosition(O),m,F.camera,F.size);V.current.setScalar(U)}e&&e instanceof we&&(W.current.matrix=e),W.current.updateWorldMatrix(!0,!0),Dy.makeRotationFromEuler(P.current.rotation).setPosition(P.current.position).premultiply(W.current.matrixWorld),$.current.setFromMatrixScale(Dy),ul.copy(V.current).divide($.current),(Math.abs(P.current.scale.x-ul.x)>1e-4||Math.abs(P.current.scale.y-ul.y)>1e-4||Math.abs(P.current.scale.z-ul.z)>1e-4)&&(P.current.scale.copy(ul),F.invalidate())}),g.useImperativeHandle(k,()=>W.current,[]),g.createElement(Kl.Provider,{value:G},g.createElement("group",{ref:Y},g.createElement("group",Ae({ref:W,matrix:e,matrixAutoUpdate:!1},D),g.createElement("group",{visible:R,ref:P,position:f,rotation:d},r&&g.createElement(g.Fragment,null,!a&&h[0]&&g.createElement(ud,{axis:0,direction:Go}),!a&&h[1]&&g.createElement(ud,{axis:1,direction:Qo}),!a&&h[2]&&g.createElement(ud,{axis:2,direction:zo}),!l&&h[0]&&h[1]&&g.createElement(pd,{axis:2,dir1:Go,dir2:Qo}),!l&&h[0]&&h[2]&&g.createElement(pd,{axis:1,dir1:zo,dir2:Go}),!l&&h[2]&&h[1]&&g.createElement(pd,{axis:0,dir1:Qo,dir2:zo}),!c&&h[0]&&h[1]&&g.createElement(Ad,{axis:2,dir1:Go,dir2:Qo}),!c&&h[0]&&h[2]&&g.createElement(Ad,{axis:1,dir1:zo,dir2:Go}),!c&&h[2]&&h[1]&&g.createElement(Ad,{axis:0,dir1:Qo,dir2:zo}),!u&&h[0]&&g.createElement(gd,{axis:0,direction:Go}),!u&&h[1]&&g.createElement(gd,{axis:1,direction:Qo}),!u&&h[2]&&g.createElement(gd,{axis:2,direction:zo}))),g.createElement("group",{ref:K},B))))}),WF=g.forwardRef(({options:r={video:!0},...e},t)=>{const i=ar(()=>navigator.mediaDevices.getDisplayMedia(r),[]);return g.useEffect(()=>()=>{i==null||i.getTracks().forEach(n=>n.stop()),Wu([])},[i]),g.createElement(vm,Ae({ref:t},e,{src:i}))}),zM=g.forwardRef(({constraints:r={audio:!1,video:{facingMode:"user"}},...e},t)=>{const i=ar(()=>navigator.mediaDevices.getUserMedia(r),[]);return g.useEffect(()=>()=>{i==null||i.getTracks().forEach(n=>n.stop()),Wu([])},[i]),g.createElement(vm,Ae({ref:t},e,{src:i}))}),HM=new z(0,0,-1),VM=function(){const r=new z,e=new z,t=new z,i=new z,n=new z;return function(s,o,a,l){return r.copy(s),e.copy(o),t.copy(a),i.copy(e).sub(r),n.copy(t).sub(r),l.crossVectors(n,i).normalize()}}();function KM(r,e){return r.clone().add(e).multiplyScalar(.5)}const $M=g.forwardRef(({points:r=Ed.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:e,facialTransformationMatrix:t,faceBlendshapes:i,offset:n,offsetScalar:s=80,width:o,height:a,depth:l=1,verticalTri:c=[159,386,152],origin:u,eyes:h=!0,eyesAsOrigin:f=!1,debug:d=!1,children:m,...A},p)=>{var y;e&&(r=e.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const E=g.useRef(null),v=g.useRef(null),x=g.useRef(null),C=g.useRef(null),I=g.useRef(null),_=g.useRef(null),S=g.useRef(null),[b]=g.useState(()=>new z),[T]=g.useState(()=>new mi),[R]=g.useState(()=>new nt),[w]=g.useState(()=>new z),{invalidate:B}=le();g.useEffect(()=>{var P;(P=I.current)==null||P.geometry.setIndex(Ed.TRIANGULATION)},[]);const[D]=g.useState(()=>new z);g.useEffect(()=>{var P,K;const M=(P=I.current)==null?void 0:P.geometry;if(!M)return;if(M.setFromPoints(r),M.setDrawRange(0,Ed.TRIANGULATION.length),t)if(T.matrix.fromArray(t.data),T.matrix.decompose(T.position,T.quaternion,T.scale),T.rotation.y*=-1,T.rotation.z*=-1,R.setFromEuler(T.rotation),n){var V;T.position.y*=-1,T.position.z*=-1,(V=E.current)==null||V.position.copy(T.position.divideScalar(s))}else{var $;($=E.current)==null||$.position.set(0,0,0)}else VM(r[c[0]],r[c[1]],r[c[2]],b),R.setFromUnitVectors(HM,b);const G=R.clone().invert();if(M.computeBoundingBox(),d&&B(),M.center(),M.applyQuaternion(G),(K=C.current)==null||K.setRotationFromQuaternion(R),h){if(!i)console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");else if(_.current&&S.current&&x.current)if(f){const O=_.current._computeSphere(M),F=S.current._computeSphere(M);u=KM(O.center,F.center).negate(),_.current._update(M,i,O),S.current._update(M,i,F)}else _.current._update(M,i),S.current._update(M,i)}if(x.current){if(u!==void 0)if(typeof u=="number"){const O=M.getAttribute("position");w.set(-O.getX(u),-O.getY(u),-O.getZ(u))}else u.isVector3&&w.copy(u);else w.setScalar(0);x.current.position.copy(w)}if(v.current){let O=1;(o||a||l)&&(M.boundingBox.getSize(D),o&&(O=o/D.x),a&&(O=a/D.y),l&&(O=l/D.z)),v.current.scale.setScalar(O!==1?O:1)}M.computeVertexNormals(),M.attributes.position.needsUpdate=!0},[r,t,i,T,n,s,o,a,l,c,u,h,d,B,b,R,D,w]);const k=g.useMemo(()=>({outerRef:C,meshRef:I,eyeRightRef:_,eyeLeftRef:S}),[]);g.useImperativeHandle(p,()=>k,[k]);const[Q]=g.useState(()=>new z),Y=(y=I.current)==null?void 0:y.geometry.boundingBox,W=(Y==null?void 0:Y.getSize(Q).z)||1;return g.createElement("group",A,g.createElement("group",{ref:E},g.createElement("group",{ref:C},g.createElement("group",{ref:v},d?g.createElement(g.Fragment,null,g.createElement("axesHelper",{args:[W]}),g.createElement(Fs,{points:[[0,0,0],[0,0,-W]],color:65535})):null,g.createElement("group",{ref:x},h&&i&&g.createElement("group",{name:"eyes"},g.createElement(ky,{side:"left",ref:_,debug:d}),g.createElement(ky,{side:"right",ref:S,debug:d})),g.createElement("mesh",{ref:I,name:"face"},m,d?g.createElement(g.Fragment,null,Y&&g.createElement("box3Helper",{args:[Y]})):null))))))}),hl={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},ky=g.forwardRef(({side:r,debug:e=!0},t)=>{const i=g.useRef(null),n=g.useRef(null),[s]=g.useState(()=>new on),o=g.useCallback(h=>{const f=h.getAttribute("position"),m=hl.contourLandmarks[r].map(A=>new z(f.getX(A),f.getY(A),f.getZ(A)));return s.center.set(0,0,0),m.forEach(A=>s.center.add(A)),s.center.divideScalar(m.length),s.radius=m[0].sub(m[1]).length()/2,s},[s,r]),[a]=g.useState(()=>new wn),l=g.useCallback((h,f,d)=>{if(i.current){var m;(m=d)!==null&&m!==void 0||(d=o(h)),i.current.position.copy(d.center),i.current.scale.setScalar(d.radius)}if(f&&n.current){const A=hl.blendshapes[r],p=f.categories[A[0]].score,y=f.categories[A[1]].score,E=f.categories[A[2]].score,v=f.categories[A[3]].score,x=hl.fov.horizontal*et.DEG2RAD,C=hl.fov.vertical*et.DEG2RAD,I=x*.5*(v-E),_=C*.5*(p-y)*(r==="left"?1:-1);a.set(I,_,0),n.current.setRotationFromEuler(a)}},[o,r,a]),c=g.useMemo(()=>({eyeMeshRef:i,irisDirRef:n,_computeSphere:o,_update:l}),[o,l]);g.useImperativeHandle(t,()=>c,[c]);const u=hl.color[r];return g.createElement("group",null,g.createElement("group",{ref:i},e&&g.createElement("axesHelper",null),g.createElement("group",{ref:n},g.createElement(g.Fragment,null,e&&g.createElement(Fs,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:u})))))}),Ed={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:34500112633395474e-23,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:483789051486383e-21,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:108198406678639e-21,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},px=g.createContext({}),Oy={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}},jF=g.forwardRef(({basePath:r=Oy.basePath,options:e=Oy.options,children:t},i)=>{const n=JSON.stringify(e),s=ar(async()=>{const{FilesetResolver:o,FaceLandmarker:a}=await Gy(()=>import("./vision_bundle-3a00debd.js"),[]),l=await o.forVisionTasks(r);return a.createFromOptions(l,e)},[r,n]);return g.useEffect(()=>()=>{s==null||s.close(),Wu([r,n])},[s,r,n]),g.useImperativeHandle(i,()=>s,[s]),g.createElement(px.Provider,{value:s},t)});function YM(){return g.useContext(px)}function Uy(r,e){return r.clone().add(e).multiplyScalar(.5)}function Ho(r,e,t){const i=r.localToWorld(e);return t.worldToLocal(i)}const gx=g.createContext({}),XF=g.forwardRef(({camera:r,videoTexture:e={start:!0},manualDetect:t=!1,faceLandmarkerResult:i,manualUpdate:n=!1,makeDefault:s,smoothTime:o=.25,offset:a=!0,offsetScalar:l=80,eyes:c=!1,eyesAsOrigin:u=!0,depth:h=.15,debug:f=!1,facemesh:d},m)=>{var A,p;const y=le(F=>F.scene),E=le(F=>F.camera),v=le(F=>F.set),x=le(F=>F.get),C=r||E,I=g.useRef(null),[_]=g.useState(()=>new mi),[S]=g.useState(()=>new z),[b]=g.useState(()=>new z),[T]=g.useState(()=>new z),[R]=g.useState(()=>new z),w=g.useCallback(()=>{_.parent=C.parent;const F=I.current;if(F){const{outerRef:U,eyeRightRef:N,eyeLeftRef:Z}=F;if(N.current&&Z.current){const{irisDirRef:ie}=N.current,{irisDirRef:q}=Z.current;ie.current&&q.current&&U.current&&(S.copy(Ho(ie.current,new z(0,0,0),U.current)),b.copy(Ho(q.current,new z(0,0,0),U.current)),_.position.copy(Ho(U.current,Uy(S,b),C.parent||y)),T.copy(Ho(ie.current,new z(0,0,1),U.current)),R.copy(Ho(q.current,new z(0,0,1),U.current)),_.lookAt(U.current.localToWorld(Uy(T,R))))}else U.current&&(_.position.copy(Ho(U.current,new z(0,0,0),C.parent||y)),_.lookAt(U.current.localToWorld(new z(0,0,1))))}return _},[C,b,R,S,T,y,_]),[B]=g.useState(()=>new mi),D=g.useCallback(function(F,U){if(C){var N;(N=U)!==null&&N!==void 0||(U=w()),o>0?(wr.damp3(B.position,U.position,o,F,void 0,void 0,1e-9),wr.dampE(B.rotation,U.rotation,o,F,void 0,void 0,1e-9)):(B.position.copy(U.position),B.rotation.copy(U.rotation)),C.position.copy(B.position),C.rotation.copy(B.rotation)}},[C,w,o,B.position,B.rotation]);He((F,U)=>{n||D(U)});const k=g.useRef(null),[Q,Y]=g.useState(),W=YM(),P=g.useCallback((F,U)=>{const N=k.current;if(!N)return;const Z=N.source.data,ie=W==null?void 0:W.detectForVideo(Z,F);Y(ie)},[W]),K=g.useMemo(()=>Object.assign(Object.create(SC.prototype),{computeTarget:w,update:D,facemeshApiRef:I}),[w,D]);g.useImperativeHandle(m,()=>K,[K]),g.useEffect(()=>{if(s){const F=x().controls;return v({controls:K}),()=>v({controls:F})}},[s,K,x,v]);const M=i??Q,V=M==null?void 0:M.faceLandmarks[0],$=M==null||(A=M.facialTransformationMatrixes)==null?void 0:A[0],G=M==null||(p=M.faceBlendshapes)==null?void 0:p[0],O={onVideoFrame:P,...e};return g.createElement(gx.Provider,{value:K},!t&&g.createElement(g.Suspense,{fallback:null},"src"in O?g.createElement(vm,Ae({ref:k},O)):g.createElement(zM,Ae({ref:k},O))),g.createElement($M,Ae({ref:I,children:g.createElement("meshNormalMaterial",{side:xi})},d,{points:V,depth:h,facialTransformationMatrix:$,faceBlendshapes:G,eyes:c,eyesAsOrigin:u,offset:a,offsetScalar:l,debug:f,"rotation-z":Math.PI,visible:f})))}),qF=()=>g.useContext(gx);export{b7 as AccumulativeShadows,UF as AdaptiveDpr,NF as AdaptiveEvents,JL as ArcballControls,zL as AsciiRenderer,TP as BBAnchor,pF as Backdrop,kF as BakeShadows,m5 as Billboard,r7 as Bounds,KP as Box,CP as Bvh,iP as CameraControls,J6 as CameraControlsImpl,dF as CameraShake,lF as Capsule,IL as CatmullRomLine,yF as Caustics,Y3 as Center,$P as Circle,Lu as Clone,_F as Cloud,iy as CloudInstance,K7 as Clouds,FL as ComputedAttribute,YP as Cone,I7 as ContactShadows,$L as CubeCamera,lP as CubeTexture,CL as CubicBezierLine,PP as CurveModifier,XM as CycleRaycast,WP as Cylinder,NL as Decal,PF as Detailed,EP as DetectGPU,YL as DeviceOrientationControls,rF as Dodecahedron,eL as DragControls,_6 as Edges,wL as Effects,C7 as Environment,nx as EnvironmentCube,Lm as EnvironmentMap,E7 as EnvironmentPortal,wP as Example,oF as Extrude,XF as FaceControls,jF as FaceLandmarker,Oy as FaceLandmarkerDefaults,$M as Facemesh,Ed as FacemeshDatas,ky as FacemeshEye,hl as FacemeshEyeDefaults,VL as Fbo,cP as Fbx,tP as FirstPersonControls,VF as Fisheye,mF as Float,WL as FlyControls,sP as GizmoHelper,rP as GizmoViewcube,oP as GizmoViewport,QL as Gltf,BL as GradientTexture,Hp as GradientType,aP as Grid,dP as Helper,Xu as Html,nb as Hud,nF as Icosahedron,DL as Image,_m as Instance,DP as InstancedAttribute,Sm as Instances,xl as IsObject,sL as KeyboardControls,uP as Ktx2,aF as Lathe,xF as Lightformer,Fs as Line,ZM as Loader,jL as MapControls,OL as MarchingCube,kL as MarchingCubes,UL as MarchingPlane,zF as Mask,TF as MatcapTexture,BP as Merged,QP as MeshDiscardMaterial,FP as MeshDistortMaterial,KF as MeshPortalMaterial,UP as MeshReflectorMaterial,NP as MeshRefractionMaterial,GP as MeshTransmissionMaterial,kP as MeshWobbleMaterial,nP as MotionPathControls,zP as MultiMaterial,bF as NormalTexture,sF as Octahedron,XL as OrbitControls,$6 as OrthographicCamera,ML as Outlines,GF as PerformanceMonitor,KL as PerspectiveCamera,YF as PivotControls,XP as Plane,RF as Point,HP as PointMaterial,JD as PointMaterialImpl,eP as PointerLockControls,DF as Points,mM as PointsBuffer,iF as Polyhedron,ND as PositionMesh,fM as PositionPoint,_L as PositionalAudio,FF as Preload,nL as PresentationControls,JM as Progress,xL as QuadraticBezierLine,w7 as RandomizedLight,yM as RenderCubeTexture,pM as RenderTexture,fF as Resize,tF as Ring,uF as RoundedBox,t7 as RoundedBoxGeometry,PL as Sampler,hF as ScreenQuad,EL as ScreenSizer,vL as ScreenSpace,WF as ScreenVideoTexture,iL as Scroll,tL as ScrollControls,LF as Segment,AM as SegmentObject,MF as Segments,gL as Select,gF as Shadow,BF as ShadowAlpha,cF as Shape,CF as Sky,VP as SoftShadows,SF as Sparkles,jP as Sphere,HL as Splat,EF as SpotLight,vF as SpotLightShadow,LP as SpriteAnimator,AF as Stage,IF as Stars,mP as Stats,AP as StatsGl,GL as Svg,eF as Tetrahedron,TL as Text,E6 as Text3D,RL as Texture,JP as Torus,ZP as TorusKnot,qL as TrackballControls,LL as Trail,bP as TrailTexture,ZL as TransformControls,qP as Tube,vm as VideoTexture,$F as View,zM as WebcamVideoTexture,wF as Wireframe,sx as accumulativeContext,Q7 as calcPosFromAngles,z0 as calculateScaleFactor,tR as checkIfFrameIsEmpty,RP as createInstances,Iu as getFirstFrame,bL as isWebGL2Available,OF as meshBounds,ps as shaderMaterial,_P as useAnimations,gP as useAspect,xP as useBVH,o7 as useBounds,SP as useBoxProjectedEnv,yP as useCamera,IP as useContextBridge,W6 as useCubeCamera,Yv as useCubeTexture,qM as useCursor,pP as useDepthBuffer,fR as useDetectGPU,Ah as useEnvironment,gn as useFBO,Y0 as useFBX,qF as useFaceControls,YM as useFaceLandmarker,V0 as useFont,ih as useGLTF,$0 as useGizmoContext,D3 as useHelper,wD as useIntersect,W0 as useKTX2,rL as useKeyboardControls,HF as useMask,q7 as useMatcapTexture,eb as useMotion,eM as useNormalTexture,QF as usePerformanceMonitor,A2 as useProgress,F2 as useScroll,yL as useSelect,MP as useSpriteAnimator,Em as useSpriteLoader,k6 as useSurfaceSampler,ao as useTexture,F6 as useTrail,OD as useTrailTexture,Z9 as useVideoTexture};
//# sourceMappingURL=index-3968ac82.js.map
